Jane.module("jane.toolbar.js",function(){"use strict";ns.action.define("toolbar.settings.button.remove",function(e,t){var o=t.button,n=Daria.userToolbar.deactivateButton(o);return _.isArray(n)&&(Daria.userToolbar.set(),ns.events.trigger("daria:vToolbarSettings:buttonToggled")),!1}),function(){Daria.userToolbar={mSettings:function(){return this._mSettings||(this._mSettings=ns.Model.get("settings")),this._mSettings},_KEY:"tb_mail_mailbox",_KEY_ACTIVATED:"tb_mail_mailbox_act",_getSettingsValue:function(){return this.mSettings().getSetting(this._KEY)||[]
},_cache:null,validate:function(e){return _.filter(e,function(e){switch(e.id){case"label":var t=ns.Model.get("labels");return t&&t.getLabelById(e.settings.label);case"infolder":var o=ns.Model.get("folders");return o&&o.getFolderById(e.settings.folder);case"sendon":return e.settings.email&&Jane.FormValidation.checkEmail(e.settings.email)}return!0})},get:function(e){return _.isNull(this._cache)&&(this._cache=this._getSettingsValue()),this._cache=this.validate(this._cache),e?this._getSettingsByButtonId(this._cache,e)||null:this._cache
},set:function(e){e=e||this._cache;var t=new Vow.Promise,o={};return o[this._KEY]=e,this.mSettings().setSettings(o,function(o){o?t.fulfill(e):t.reject()}),t},activate:function(){var e=new Vow.Promise;return this.mSettings().setSettingOn(this._KEY_ACTIVATED,function(){e.fulfill()}),e},isActivated:function(){return Jane.Config.NO_SETTINGS?!1:this.mSettings().isSet(this._KEY_ACTIVATED)},getCustomizableButtonName:function(e){var t=this.get(e);if(!t)return void 0;switch(e){case"label":return ns.Model.get("labels").getLabelById(t.settings.label).name;
case"infolder":return ns.Model.get("folders").getFolderById(t.settings.folder).name;case"sendon":return t.settings.email;default:return void 0}},activateButton:function(e,t){var o={id:e,settings:t},n=_.findIndex(this._cache,{id:e});return-1!==n?this._cache[n]=o:this._cache.push(o),this._cache},deactivateButton:function(e){return this._cache=_.reject(this._cache,{id:e}),this._cache},isButtonActivated:function(e){return _.isNull(this._cache)&&(this._cache=this._getSettingsValue()),Boolean(this._getSettingsByButtonId(this._cache,e))
},invalidateCache:function(){this._cache=null},_getSettingsByButtonId:function(e,t){return _.find(e,{id:t})}}}(),Daria.toolbar={showPromoCheckMessage:function(){Jane.Services.runModules(["jane.promo.css","jane.promo.js","jane.promo.yate"],function(){Daria.promoCheckMessage.show()})}},function(){Daria.minifyMode={},Daria.minifyMode.isEnabled=function(){return ns.Model.get("settings").isCompactMode()},Daria.minifyMode.isDisabled=function(){return!this.isEnabled()}}(),function(){var e=[{id:"main-select-all",action:"select-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:"Выделить все письма"},{id:"main-deselect-all",action:"deselect-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:"Снять выделение"},{id:"compose-go",url:"#compose",action:"compose.go",icon:"Compose",name:"Написать",title:"Написать"+Daria.Shortcuts.getShortcutLabelFor("New_mail","global",!0)},{id:"draft-finish",icon:"Compose",name:"Дописать",title:"Дописать"},{id:"check-mail",action:"mailbox.check",icon:"Refresh",name:"Проверить",title:"Проверить, есть ли новые письма"+Daria.Shortcuts.getShortcutLabelFor("Check_new_mail","global",!0)},{id:"add-template",icon:"AddTemplate",name:"Создать шаблон"},{id:"edit",action:"compose-edit",icon:"Edit",name:"Изменить",disableLoader:!0,_visible:function(){if(!Daria.isMessagePage())return!1;
var e=ns.Model.get("messages-checked");if(1!==e.getCount())return!1;var t=e.getCheckedMessages()[0],o=ns.Model.get("folders");return o.isFolder(t.getFolderId(),["draft","template"])}},{id:"reply",action:"reply",icon:"Reply",disableLoader:!0,name:"Ответить",title:"Ответить"+Daria.Shortcuts.getShortcutLabelFor("Reply","message",!0),_visible:function(){if(Daria.isMessagePage()){var e=ns.Model.get("messages-checked");if(1===e.getCount()){var t=e.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(t.getFolderId(),["draft","template"])
}}return!0}},{id:"reply-all",action:"reply-all",icon:"Replyall",disableLoader:!0,name:"Ответить всем",title:"Ответить всем"+Daria.Shortcuts.getShortcutLabelFor("Reply_all","message",!0),_visible:function(){if(Daria.isMessagePage()){var e=ns.Model.get("messages-checked");if(1===e.getCount()){var t=e.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(t.getFolderId(),["draft","template"])}}return!0}},{id:"forward",action:"forward",icon:"Forward",name:"Переслать",title:"Переслать"+Daria.Shortcuts.getShortcutLabelFor("Forward","messages",!0),_visible:function(){return!ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["template"])
}},{id:"delete",action:"remove",folderAction:"folder.messages-remove",icon:"Delete",actionParams:function(){var e={};return"message"===ns.page.current.page&&(e.ignoreUnsavedDraft=!0),e},name:"Удалить",title:"Удалить"+Daria.Shortcuts.getShortcutLabelFor("Delete_selected","messages",!0)},{id:"spam",action:"tospam",icon:"Spam",name:"Это спам!",title:"Это спам!"+Daria.Shortcuts.getShortcutLabelFor("Label_spam","message",!0)},{id:"not-spam",action:"notspam",icon:"Unspam",name:"Не спам!"},{id:"unsubscribe",action:"unsubscribe",icon:"Unsubscribe",name:"Отписаться"},{id:"mark-as-read",action:"mark",folderAction:"folder.current-mark-read",disableLoader:!0,icon:"Read",name:"Прочитано",title:"Прочитано"+Daria.Shortcuts.getShortcutLabelFor("Label_read","messages",!0)},{id:"mark-as-unread",action:"unmark",disableLoader:!0,icon:"Unread",name:"Не прочитано",title:"Не прочитано"+Daria.Shortcuts.getShortcutLabelFor("Label_unread","messages",!0)},{id:"archive",action:"archive",icon:"Archive",name:"Архивировать",title:"Архивировать"+Daria.Shortcuts.getShortcutLabelFor("Archive","messages",!0),description:"Убирает ненужные письма в Архив",settings:{}},{id:"labels-actions",icon:"Tag",name:"Метка",nameArrow:!0,title:"Метка"+Daria.Shortcuts.getShortcutLabelFor("Labels_dialog","messages",!0),description:"Ставит любую метку на письмо",disableLoader:!0},{id:"folders-actions",icon:"Folder",name:"В папку",nameArrow:!0,title:"В папку"+Daria.Shortcuts.getShortcutLabelFor("Folders_dialog","messages",!0),description:"Перекладывает письма в любую папку",disableLoader:!0},{id:"pin",action:"pin",icon:"Pin",name:"Закрепить",_visible:function(){if(Daria.isMessagePage()){var e=ns.Model.get("messages-checked");
if(1===e.getCount()){var t=e.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(t.getFolderId(),["draft","template"])}}return!0}},{id:"unpin",action:"unpin",icon:"Pin_active",name:"Открепить",_visible:function(){if(Daria.isMessagePage()){var e=ns.Model.get("messages-checked");if(1===e.getCount()){var t=e.getCheckedMessages()[0];return!ns.Model.get("folders").isFolder(t.getFolderId(),["draft","template"])}}return!0}},{id:"sendon",action:"sendon",icon:"SmartForward",name:"Переадресовать",originalName:"Переадресовать",title:"Переадресовать"+Daria.Shortcuts.getShortcutLabelFor("Sendon","messages",!0),description:"Пересылает письма на указанный адрес",settings:{email:null},isCustom:!0,_settingsValidate:function(e){var t=[];
return e.email?Jane.FormValidation.checkEmail(e.email)||t.push("sendon_check_email"):t.push("sendon_empty_email"),t}},{id:"infolder",action:"infolder",icon:"MagicFolder",name:"В папку",originalName:"В папку",title:"В папку"+Daria.Shortcuts.getShortcutLabelFor("Infolder","messages",!0),description:"Перекладывает письма в любую папку",settings:{folder:null},settingsDeps:["folders"],isCustom:!0,_settingsValidate:function(e){var t=[];return e.folder||t.push("folder_empty"),t}},{id:"label",action:"label",icon:"MagicTag",name:"Метка",originalName:"Метка",title:"Метка"+Daria.Shortcuts.getShortcutLabelFor("Defined_label","messages",!0),description:"Ставит любую метку на письмо",disableLoader:!0,settings:{label:null},settingsDeps:["labels"],isCustom:!0,_settingsValidate:function(e){var t=[];
return e.label||t.push("label_empty"),t}},{id:"template",action:"reply-tmpl",icon:"Template",name:"Автоответ",title:"Автоответ"+Daria.Shortcuts.getShortcutLabelFor("Defined_reply","messages",!0),description:"Отвечает на письмо заданным текстом",settings:{tmpl:null},settingsDeps:["messages"],isCustom:!0,_settingsDepsParams:function(){var e=Vow.promise();return ns.Model.get("folders").createTemplateFolder().then(function(t){e.fulfill({current_folder:t.fid,first:0,last:500})},function(){e.reject()}),e
},_settingsValidate:function(e){var t=[];return e.tmpl||t.push("template_empty"),t}},{id:"more",icon:"More",name:"Ещё"},{id:"toolbar-settings",action:"customize",iconId:"mail--Header-Settings",name:"Настройка меню",settings:{},settingsHide:!0},{id:"delete-draft",action:"remove.draft",icon:"Delete",name:"Удалить",_visible:function(){var e=ns.Model.get("messages-checked");if(1!==e.getCount())return!1;var t=e.getCheckedMessages()[0],o=ns.Model.get("folders");return o.isFolder(t.get(".fid"),["draft","template"])
}},{id:"compose-reply",action:"compose.reply",icon:"reply",disableLoader:!0,name:"Ответить",_visible:function(){return!!(ns.page.current.params.ids&&ns.page.current.params.ids.length&&"reply-all"==ns.page.current.params.oper&&Jane.watcher.get("compose.has-multiply-reply-addresses"))}},{id:"compose-reply-all",action:"compose.reply-all",icon:"reply-all",disableLoader:!0,name:"Ответить всем",_visible:function(){return!!(ns.page.current.params.ids&&ns.page.current.params.ids.length&&"reply"==ns.page.current.params.oper&&Jane.watcher.get("compose.has-multiply-reply-addresses"))
}},{id:"compose-abook",url:"#compose",action:"abook.compose-go",iconId:"mail--MainToolbar-Compose",disableLoader:!0,name:"Написать"},{id:"abook-select-all",action:"abook.select-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:"Выделить все контакты"},{id:"abook-deselect-all",action:"abook.deselect-all",iconId:"mail--Inbox-CheckboxCheckMark-Small",title:"Снять выделение"},{id:"abook-add",action:"mail-common.person-popup",iconId:"mail--MainToolbar-AddContact",name:"Добавить контакт",disableLoader:!0},{id:"abook-remove",action:"abook.remove-contacts",iconId:"mail--MainToolbar-Delete",name:"Удалить",disableLoader:!0,droppable:!0},{id:"abook-togroup",action:"abook.groups-dropdown",iconId:"mail--MainToolbar-AddGroup",name:"Добавить в группу",disableLoader:!0,droppable:!0},{id:"abook-outofgroup",action:"abook.remove-contacts-from-group",iconId:"mail--MainToolbar-DeleteGroup",name:"Удалить из группы",disableLoader:!0,droppable:!0},{id:"abook-restore",action:"abook.open-backups-dialog",iconId:"mail--MainToolbar-Restored",name:"Восстановить",disableLoader:!0},{id:"abook-more",action:"abook.toolbar-more-actions",iconId:"mail--MainToolbar-More",name:"Ещё",disableLoader:!0},{id:"translate",action:"translate.show-infoline",name:"Перевести",disableLoader:!0,_visible:ns.False},{id:"print",disableLoader:!0,name:"Распечатать",_visible:ns.False,_getExData:function(){return{href:"/u2709/print.jsx?mid="+ns.page.current.params.ids+"&_uid="+Daria.uid,attrs:{target:"_blank"}}
}},{id:"filters-create",disableLoader:!0,name:"Создать правило",_visible:ns.False,_getExData:function(){return{href:"#setup/filters-create?message="+ns.page.current.params.ids,"class":["ns-action"],attrs:{"data-click-action":"message.counter-filters-create"}}}},{id:"message-source",disableLoader:!0,name:"Свойства письма",_visible:ns.False,_getExData:function(){return{href:"/u2709/message-source/"+Daria.uid+"/"+ns.page.current.params.ids+"/yandex_email.eml","class":["ns-action","js-toolbar-item-message-properties"],attrs:{target:"_blank","data-click-action":"message.counter-properties"}}
}}];ns.Model.define("all-toolbar-buttons",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData(e)},getButtonById:function(e){return _.find(this.getData(),{id:e})},getButtonsByIds:function(e){return _.filterValuesContainingPropValue(this.getData(),"id",e)},getOrExtendButton:function(e){var t;return t=_.isString(e)?this.getButtonById(e):_.extend({},this.getButtonById(e.id),e)},getButtonsByDeclarations:function(e){return _.map(e,this.getOrExtendButton,this)}}})}(),function(){ns.Model.define("toolbar",{split:{items:".item",params:{id:".id"},model_id:"toolbar-button"},params:{layout:null},events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({buttons:[]})
},preprocessData:function(e){return e.buttons&&(e.item=e.buttons),delete e.buttons,e.fixed=!1,e},setFixedSupport:function(e){Jane.watcher.set("toolbar.allowfixed",!!e)},getFixedSupport:function(){return Jane.watcher.get("toolbar.allowfixed")},toggleFixed:function(e){return this.get(".fixed")===e?!1:(this.set(".fixed",e),!0)},isFixed:function(){return Boolean(this.get(".fixed"))},areSettingsEnabled:function(){return Boolean(this.get(".settings"))},getById:function(e){return _.find(this.models,function(t){return t.get(".id")===e
})}}},ns.ModelCollectionStatic)}(),function(){var e=function(){return Vow.fulfill()};ns.Model.define("toolbar-button",{params:{id:null},ctor:function(){this.toShow=no.True,this.toEnable=no.True,this.init=no.nop,this.getSettingsDepsParams=e,this.validateSettings=no.True,this.getExData=_.noop},methods:{hasDataChanged:function(){return Boolean(!this.data)},preprocessData:function(t){var o=t._visible;return this.toShow=o?o:no.True,o=t._enable,this.toEnable=o?o:no.True,o=t._init,this.init=o?o:no.nop,o=t._settingsDepsParams,this.getSettingsDepsParams=o?o:e,o=t._settingsValidate,this.validateSettings=o?o:no.True,this.getExData=t._getExData||_.noop,_.pick(t,function(e,t){return"_"!==t.charAt(0)
})},setName:function(e){_.isUndefined(e)?this.resetName():this.setIfChanged(".name",e)},resetName:function(){var e=this.get(".originalName");e&&this.set(".name",e)},isModelWithSettings:function(){return!!this.get(".settings")},getType:function(){return this.get(".type")},isValid:no.True}},ns.ModelStatic)}(),function(){ns.View.edefine("folders-actions",{models:{folders:!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-action":"onClickAction","click@show .js-folder-new":"createNewFolder","keydown@show .js-search-input":"_onSearchInput"},yateModule:"toolbar",methods:{elContentSelector:".js-folder-name",elSelector:".js-kbd-fldr-nav:visible",skipElSelector:"b-folders__folder_current",selectedClass:"b-folders__folder_kbd-selected",newListSelector:".mail-FilterList-List .js-folder-new",onInit:function(){this._filterRefresh=_.debounce(this._filterRefresh,100),this.resetKdbSelection=_.debounce(this.resetKdbSelection,150)
},onShow:function(){this.$foldersHolder=this.$node.find(".js-folders-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByMessagesChecked()},onHide:function(){this._filterRefresh.cancel(),this.resetKdbSelection.cancel(),this.$foldersHolder=null,this.$searchInput=null},onClickAction:function(e){var t=ns.action.getParams(e.currentTarget),o=$(e.currentTarget).data("click-action");return t.fid===this.disabledFolderFid?!1:("folders.add"===o?this.createNewFolder(t):(this._getCheckedModel().runAction(o,t),this.closePopup()),e.preventDefault(),!1)
},open:function(e,t,o){var n=this;this.__mMessagesChecked=t,this._isOpen=!0;var i=this.getOpenOptions(o);return this.update().then(function(){var t=Jane.tt("toolbar:mail-FilterList-popup");n.nbPopup=nb.block(t),n.nbPopup.setContent(n.node),n.nbPopup.open(_.extend(i,{where:e})),n.bindEvents(),n.bindEvents();var o=_.once(function(){n._isOpen=!1,n.unbindEvents(),n.destroy(),_.defer(function(){n.nbPopup.destroy()})});n.nbPopup.on("nb-closed",o)})},bindEvents:function(){this.nbPopup.$node.on("mousedown",this._preventDefaultAndStopPropagation)
},unbindEvents:function(){this.nbPopup.$node.off("mousedown",this._preventDefaultAndStopPropagation)},getFolderName:function(){return this.$searchInput&&this.$searchInput.length?$.trim(this.$searchInput.val()):""},createNewFolder:function(e){this.closePopup(),e=$.extend(e||{},{name:this.getFolderName(),toolbar:!0,mMessagesChecked:this._getCheckedModel()}),ns.action.run("folders.add",e)},closePopup:function(){nb.trigger("popup-close")},infilteredList:function(e){for(var t=this.filteredList,o=0,n=t.length;n>o;o++)if(t[o].title===e)return!0;
return!1},filterFolders:function(e){return this.filteredList=$.grep(this.activeFolders,function(t){var o=!e||!t.current&&0===t.title.indexOf(e);return t.$node.toggleClass("g-hidden",!o),o}),this.filteredList.length},resetKdbSelection:function(){var e=this;e.visibleList[e.kbdSelected]&&e.visibleList[e.kbdSelected].$node.removeClass(e.selectedClass),$(e.newListSelector).removeClass(e.selectedClass),e.visibleList=[],$(e.elSelector).each(function(t,o){var n=$(o);n.hasClass(e.skipElSelector)||e.visibleList.push({$node:n,title:n.find(e.elContentSelector).text()})
}),e.kbdSelected=null},makeFakeFolder:function(e){var t=Jane.tt("toolbar:new-fake-folder",{name:e,"name-param":encodeURIComponent(e)});this.$fakeFolder?this.$fakeFolder.replaceWith(t):this.$foldersHolder.append(t),this.$fakeFolder=$(t),this.visibleList.push({title:"fake folder",$node:this.$fakeFolder})},removeFakeFolder:function(){var e=this.$fakeFolder;e&&(e.remove(),this.$fakeFolder=null)},filterByMessagesChecked:function(){var e=this,t=this._getCheckedModel().getCount(),o=this._getCheckedModel().getFolders(),n=this.$node,i=$(n),s=this.activeFolders=[];
this.filteredList=[],this.visibleList=[],$.each(o,function(o,n){var a=n==t;a&&(e.disabledFolderFid=o);var r=i.find(".folder-"+o).toggleClass("b-folders__folder_current",a),l=r.find(".js-folder-name").text().toLowerCase(),d={$node:r,title:l,current:a};s.push(d),""===l||a||e.visibleList.push(d)}),this.removeFakeFolder(),this.prevSearch=null,this.$searchInput.val(""),this.filterFolders(""),this.resetKdbSelection()},_getCheckedModel:function(){return this.__mMessagesChecked},_filterRefresh:function(){if(this.$searchInput){var e=this.getFolderName(),t=e.toLowerCase();
null===this.prevSearch&&(this.prevSearch=""),t!==this.prevSearch&&(this.prevSearch=t,this.filterFolders(t),t.length&&!this.infilteredList(t)?this.makeFakeFolder(e):this.removeFakeFolder(),this.resetKdbSelection())}},_onSearchInput:function(e){var t=Jane.Common.keyCode;switch(e.which){case t.ENTER:if(null!==this.kbdSelected&&this.kbdSelected>-1)return e.stopImmediatePropagation(),this.visibleList[this.kbdSelected]?this.visibleList[this.kbdSelected].$node.find("[data-click-action]").trigger("click"):this.createNewFolder(),!1;
if(this._filterRefresh(),this.filteredList.length&&this.$fakeFolder)return!1;this.filteredList.length<=1&&(e.stopImmediatePropagation(),(this.$fakeFolder||this.filteredList[0].$node).find("[data-click-action]").trigger("click"));break;case t.DOWN:this.moveKbdCursor("down"),e.stopPropagation();break;case t.UP:this.moveKbdCursor("up"),e.stopPropagation();break;default:this._filterRefresh()}return!0}}},"kbd-dropdown-actions")}(),ns.View.define("inbox-filter",{events:{"ns-view-htmlinit":"onNsViewHtmlinit",pageinit:"_metrikForChangeUser"},models:["messages-types"],yateModule:"toolbar",methods:{onNsViewHtmlinit:function(){nb.init(this.node);
var e=nb.$block(".js-content-toolbar-toggler",this.node);e&&e.on("nb-open-started",function(){o.setActiveItem(t)});var t=nb.$block(".js-content-toolbar-inbox-filter-popup",this.node),o=this;if(t){var n=function(e,o){o&&t.close()};t.on("nb-opened",function(){ns.events.on("toolbar.fixed",n),t.$node.on("click.toolbar-filter-inbox-popup",o.onClickTypesFilterNbSelect.bind(o))}),t.on("nb-select",function(){ns.events.trigger("daria:vMessages:recalculate")}),t.on("nb-closed",function(){ns.events.off("toolbar.fixed",n),t.$node.off(".toolbar-filter-inbox-popup")
})}},metrika:function(){var e=["Фильтр по типам писем"].concat(Array.prototype.slice.call(arguments,0));Jane.c.apply(Jane,e)},_metrikForChangeUser:function(){Daria.urlParams.addMultiUserFromSelect&&Jane.c(["Фильтр по типам писем","Селект","Клик","Добавить пользователя","Пользователь добавлен"])},setActiveItem:function(e){var t=ns.page.currentUrl,o=e.$node.find(".is-current");if(o.attr("href")!==t){o.removeClass("is-current");var n=e.$node.find('.js-mail-Toolbar-Filter-item[href*="'+t+'"]');n.length?n.addClass("is-current"):e.$node.find(".ui-menu-item:first-child .js-mail-Toolbar-Filter-item").addClass("is-current")
}},onClickTypesFilterNbSelect:function(){this.metrika("Селект","Клик")}}}),ns.View.define("more-services",{models:{"index-data":!0},events:{"ns-page-before-load":"onPageBeforeLoad","ns-view-hide":"onHide","click@show":"onClick"},yateModule:"toolbar",ctor:function(){this.nbPopup=null,this.onPopupClosed=this.onPopupClosed.bind(this),this.onChangeToolbarPosition=this.onChangeToolbarPosition.bind(this)},methods:{onHide:function(){this.popupClose()},onPageBeforeLoad:function(){this.popupClose()},onClick:function(){if(!this.popupClose()){var e=this.getModel("index-data"),t=[].concat(e.get(".tabs.head"),e.get(".tabs.more")).map(function(e){return _.extend(e,{"class":"js-more-services-tab",attrs:{"data-metrika-id":e.id}})
});this.nbPopup=nb.block(ns.renderNode({tabs:t},"head-tabs-popup","mail")),this.nbPopup.on("nb-closed",this.onPopupClosed),this.nbPopup.open({where:this.$node.find(".js-more-services-toggle"),how:{at:"bottom",my:"top+4"}}),this.nbPopup.$node.on("mousedown",".js-more-services-tab",this.onServicesTabClick.bind(this)),ns.events.on("toolbar.fixed",this.onChangeToolbarPosition),this.registerShowTabs("services")}},onServicesTabClick:function(e){if(e&&"mousedown"===e.type&&(0===e.button||1===e.button)){var t=e.currentTarget;
this.registerTabClick(t.getAttribute("data-metrika-id"),"services")}},onPopupClosed:function(){this.nbPopup&&(ns.events.off("toolbar.fixed",this.onChangeToolbarPosition),this.nbPopup.$node.off(),this.nbPopup.destroy(),this.nbPopup=null)},popupClose:function(){return this.nbPopup?(this.nbPopup.close(),!0):!1},onChangeToolbarPosition:function(e,t){t&&this.popupClose()}}},"services-list-mixin"),function(){ns.View.edefine("labels-actions",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-action":"_onLabelClick","click@show .js-fake-label":"_onNewLabelClick","click@show .js-label-new":"_onNewLabelClick","click@show .js-read":"_onClickRead","click@show .js-unread":"_onClickUnread","keydown@show .js-search-input":"_onSearchInput"},models:{labels:!1,settings:!1},yateModule:"toolbar",methods:{newListSelector:".js-label-new",selectedClass:"b-mail-dropdown__item-kbd-selected",elContentSelector:".b-mail-dropdown__item__content__wrapper",elSelector:".js-kbd-lbl-nav:visible",onInit:function(){this._filterRefresh=_.debounce(this._filterRefresh,100),this.resetKdbSelection=_.debounce(this.resetKdbSelection,150),this.nbPopup=null
},onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByMessagesChecked()},onHide:function(){this._filterRefresh.cancel(),this.resetKdbSelection.cancel(),this.$searchInput=null,this.$labelsHolder=null},open:function(e,t,o){var n=this;this.__mMessagesChecked=t,this._isOpen=!0;var i=this.getOpenOptions(o);return this.update(null,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){var t=Jane.tt("toolbar:mail-FilterList-popup");
n.nbPopup=nb.block(t),n.nbPopup.setContent(n.node),n.nbPopup.open(_.extend(i,{where:e})),n.bindEvents();var o=_.once(function(){n._isOpen=!1,n.unbindEvents(),n.destroy(),_.defer(function(){n.nbPopup.destroy()})});n.nbPopup.on("nb-closed",o)})},bindEvents:function(){this.nbPopup.$node.on("mousedown",this._preventDefaultAndStopPropagation)},unbindEvents:function(){this.nbPopup.$node.off("mousedown",this._preventDefaultAndStopPropagation)},_getDataFromClickedLabel:function(e){var t=$(e.currentTarget),o=ns.action.getParams(t[0]),n=t.data("click-action");
return{action:n,lid:o.lid}},_onLabelClick:function(e){var t=this._getDataFromClickedLabel(e);this._getCheckedModel().runAction(t.action,{lid:t.lid}),this.closePopup()},_onNewLabelClick:function(e){var t=ns.action.getParams(e.currentTarget);t["message-id"]=$(e.currentTarget).attr("data-message-id"),this.createNewLabel(t),this.closePopup()},_onClickRead:function(e){e.preventDefault(),e.stopPropagation(),this._getCheckedModel().runAction("mark"),this.closePopup()},_onClickUnread:function(e){e.preventDefault(),e.stopPropagation(),this._getCheckedModel().runAction("unmark"),this.closePopup()
},closePopup:function(){nb.trigger("popup-close")},_onSearchInput:function(e){var t=Jane.Common.keyCode;switch(e.which){case t.ENTER:if(null!==this.kbdSelected&&this.kbdSelected>-1)return e.stopPropagation(),this.visibleList[this.kbdSelected]?this.visibleList[this.kbdSelected].$node.find("a").trigger("click"):(this.createNewLabel(),this.nbPopup.close()),e.preventDefault(),!1;if(this._filterRefresh(),this.filteredList.length&&this.$fakeLabel)return!1;this.filteredList.length<=1&&(e.stopPropagation(),(this.$fakeLabel||this.filteredList[0].$node).find("[data-click-action]").trigger("click"));
break;case t.DOWN:this.moveKbdCursor("down"),e.stopPropagation();break;case t.UP:this.moveKbdCursor("up"),e.stopPropagation();break;default:this._filterRefresh()}return!0},_filterRefresh:function(){if(!_.isEmpty(this.$searchInput)){var e=$.trim(this.$searchInput.val()),t=e.toLowerCase();null===this.prevSearch&&(this.prevSearch=""),t!==this.prevSearch&&(this.prevSearch=t,this._filterLabels(t),t.length&&!this.infilteredList(t)?this.makeFakeLabel(e):this.removeFakeLabel(),this.resetKdbSelection())}},getLabelCreatedCallback:function(){var e=this._getCheckedModel();
return e.runLabelAction.bind(e)},createNewLabel:function(e){if(!_.isEmpty(this.$searchInput)){var t=Daria.capitalize(this.$searchInput.val().trim());ns.action.run("labels.add",_.extend({},e,{name:t,onLabelCreated:this.getLabelCreatedCallback()}))}},infilteredList:function(e){for(var t=this.filteredList,o=0,n=t.length;n>o;o++)if(t[o].title===e)return!0;return!1},_filterLabels:function(e){this.filteredList=_.filter(this.activeLabels,function(t){var o=!e||0===t.title.indexOf(e);return t.$node.toggleClass("g-hidden",!o),o
})},resetKdbSelection:function(){var e=this;this.visibleList&&this.visibleList[this.kbdSelected]&&this.visibleList[this.kbdSelected].$node.removeClass(this.selectedClass),$(this.selectedClass).removeClass(this.selectedClass),this.visibleList=[],$(this.elSelector).each(function(t,o){var n=$(o);e.visibleList.push({$node:n,title:n.find(e.elContentSelector).text()})}),this.kbdSelected=null},makeFakeLabel:function(e){e=Daria.capitalize(e);var t=Jane.tt("toolbar:new-fake-label",{name:e,color:"31c73b"});
_.isEmpty(this.$fakeLabel)?this.$labelsHolder.append(t):this.$fakeLabel.replaceWith(t),this.$fakeLabel=$(t),this.visibleList.push({title:"fake label",$node:this.$fakeLabel})},removeFakeLabel:function(){var e=this.$fakeLabel;e&&(e.remove(),this.$fakeLabel=null)},getUnreadMessagesCount:function(e){var t=0;return e.forEach(function(e){var o=ns.Model.get("message",{ids:e}),n=o.getData();n&&o.isNew()&&t++}),t},filterByMessagesChecked:function(){var e=this._getCheckedModel(),t=e.getData(),o=this.getUnreadMessagesCount(t),n=e.getCount(),i=e.getLabels();
this._filterByLabelsHash(i,{showReadLabel:o>0,showUnreadLabel:o<t.length,messagesCount:n})},_filterByLabelsHash:function(e,t){t=t||{};var o=this.$node,n=o.find(".js-read"),i=o.find(".js-unread");this.activeLabels=[],t.showReadLabel?this._addLabelToActive(n.removeClass("g-hidden")):n.addClass("g-hidden"),t.showUnreadLabel?this._addLabelToActive(i.removeClass("g-hidden")):i.addClass("g-hidden");var s=t.messagesCount||0;_(e).keys().filter(function(e){return!/^FAKE/.test(e)}).each(function(t){var n=e[t],i=o.find(".label-"+t),a=o.find(".unlabel-"+t),r=n===s;
r||this._addLabelToActive(i),i.toggleClass("g-hidden",r),a.toggleClass("g-hidden",0===n)},this).value();var a=_(e).filter(function(e,t){return!/^FAKE/.test(t)}).some(function(e){return e>0});o.find(".unlabel-title, .unlabel-separator").toggleClass("g-hidden",!a),this.removeFakeLabel(),this.prevSearch=null,this.$searchInput.val(""),this._filterLabels(""),this.resetKdbSelection()},_addLabelToActive:function(e){this.activeLabels.push({$node:e,title:e.find(".b-mail-dropdown__item__content__wrapper").text().toLowerCase()})
},_getCheckedModel:function(){return this.__mMessagesChecked}}},"kbd-dropdown-actions")}(),ns.View.define("layout-switch",{events:{click:"openPopup"},yateModule:"toolbar",ctor:function(){this.onChangeToolbarPosition=this.onChangeToolbarPosition.bind(this),this.offChangeToolbarPosition=this.offChangeToolbarPosition.bind(this)},methods:{openPopup:function(){return this.vPopup&&this.vPopup.isValid()?void this.closePopup():(this.vPopup=ns.View.create("layout-switch-popup"),this.vPopup.open({where:this.$node.find(".js-content-toolbar-layout-switch"),how:{at:"bottom",my:"top+4"}}),ns.events.on("toolbar.fixed",this.onChangeToolbarPosition),void this.vPopup.once("closed",this.offChangeToolbarPosition))
},closePopup:function(){this.vPopup&&(this.vPopup.close(),this.vPopup=null)},onChangeToolbarPosition:function(e,t){t&&this.closePopup()},offChangeToolbarPosition:function(){ns.events.off("toolbar.fixed",this.onChangeToolbarPosition)}}}),ns.View.define("layout-switch-popup",{events:{"ns-view-htmlinit":"initializeNanoislands","click .js-content-toolbar-layout-switch-popup-button":"onClickSwitchLayout"},models:{settings:{"ns-model-changed":!1}},yateModule:"toolbar",methods:{nbPopup:null,open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.trigger("closed"),e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},initializeNanoislands:function(){var e=nb.$block(".js-threaded-switch",this.$node);e.on("nb-checked",this._onClickMessagesThreaded.bind(this)),e.on("nb-unchecked",this._onClickMessagesThreaded.bind(this));var t=nb.$block(".js-bigger-text-switch",this.$node);t.on("nb-checked",this.switchBiggerText.bind(this)),t.on("nb-unchecked",this.switchBiggerText.bind(this));
var o=nb.$block(".js-compact-mode-switch",this.$node);o&&(o.on("nb-checked",this.switchCompactModeSettings.bind(this,"compact-mode")),o.on("nb-unchecked",this.switchCompactModeSettings.bind(this,"compact-mode")));var n=nb.$block(".js-compact-header-mode-switch",this.$node);n&&(n.on("nb-checked",this.switchCompactModeSettings.bind(this,"compact-header-mode")),n.on("nb-unchecked",this.switchCompactModeSettings.bind(this,"compact-header-mode")))},onClickSwitchLayout:function(e){var t=$(e.currentTarget),o=t.data("layout");
return this.switchLayout(o),!1},switchLayout:function(e){Daria.Config.layout!==e&&(this.nbPopup.close(),this.getModel("settings").setSettings({layout:Jane.LAYOUTS.indexOf(e)},function(){var e=_.clone(ns.page.current.params);delete e.ids,delete e.thread_id;var t;t=e.current_folder||e.current_label||e.goto||e.search?ns.router.generateUrl("messages",e):ns.page.getDefaultUrl(),ns.page.forceReload(t)}))},_onClickMessagesThreaded:function(){this.nbPopup.close();var e=ns.Model.get("settings");e.isThreaded()?e.threadedOff():e.threadedOn(),_.contains(["message","messages"],ns.page.current.page)&&ns.page.go(ns.router.generateUrl(ns.page.current.page,ns.page.current.params))
},switchCompactModeSettings:function(e){if(e){var t=ns.Model.get("settings");this.nbPopup.close(),t.switchCompactModeSettings(e),$("html").toggleClass("mail-Page_minified",t.isCompactHeaderMode()),ns.page.go(),t.isCompactMode()&&t.isCompactHeaderMode()||setTimeout(function(){ns.events.trigger("head-tabs-recalculate")},300)}},switchBiggerText:function(){this.nbPopup.close();var e=ns.Model.get("settings");e.toggleSetting("with_bigger_text");var t=e.isSet("with_bigger_text");$("html").toggleClass("with-bigger-text",t),ns.events.trigger("daria:vMessagesPager:restruct"),ns.events.trigger("daria:vToolbarButton:restruct"),ns.events.trigger("head-tabs-recalculate")
}}}),function(e){ns.View.define("toolbar",{models:{"scroller-messages":!1,"search-view":{"ns-model-changed":!1,"ns-model-changed.folded":"hideInCompactMode"},toolbar:!1,settings:{"ns-model-changed":!1,"ns-model-changed.liza_minified":"onChangeCompactMode","ns-model-changed.liza_minified_header":"onChangeCompactMode"}},params:function(){return{layout:ns.page.current.page}},events:{"ns-view-init":"_onInit","ns-view-show":"_onShow","ns-view-hide":"_onHide","daria:vScrollerMessages:scroll@show":"_recalculateFixedPosition","daria:vApp:changeLeftColumWidth":"_recalculatePositionX","daria:vApp:changeRightColumSize":"_recalculatePositionX","daria:vToolbarAside:changeCheckedCount@show":"onChangeCheckedCount","toolbar-reset-offset":"_resetOffset","promo.updater-browser":"_resetOffset","daria:layout-changed":"_resetOffset","click@show .js-toolbar-button-top":"onClickScrollToTop","daria:vMessagesItemWrap:message-opened":"onOpenMessage","daria:message-will-close@show":"onMessageWillClose"},yateModule:"toolbar",methods:{controlOffsetTop:null,_onInit:function(){var e=this.getModel("toolbar");
e.setFixedSupport(!0),this.isFixed=!1},_onShow:function(){this.getModel("scroller-messages").init();var e=this.getModel("toolbar"),t=e.get(".scroll");e.get(".show")===!1&&this.$node.addClass("g-hidden"),("undefined"==typeof t||t)&&(this._initScroll(!0),_.delay(this._recalculateFixedPosition.bind(this),50))},_onHide:function(){this._toggleFixed(!1)},_initScroll:function(t){this._hasCheckScroll=t,this.$nodeLabel=this.$node.find(".b-toolbar__item__label"),this.$nodeFixedPosition=this.$node.find(".js-toolbar-content"),e.watcher.watch("toolbar.allowfixed",this._recalculateFixedPosition.bind(this))
},_getControlOffsetTop:function(){return this.$nodeLabel.length&&this.$nodeLabel[0].offsetHeight?this.$nodeLabel.offset().top:this.$node.offset().top},_recalculateFixedPosition:function(){if(!Daria.is3pane()&&this._hasCheckScroll){if(this.getModel("toolbar").getFixedSupport()){null===this.controlOffsetTop&&(this._toggleFixed(!1),this.controlOffsetTop=this._getControlOffsetTop());var e=this.getModel("scroller-messages").getScrollTop();if(this.controlOffsetTop-e<0&&(!this._isMessageOpen()||Daria.isMessagePage()))return void this._toggleFixed(!0)
}this._toggleFixed(!1)}},_isMessageOpen:function(){var e=ns.page.current.params;return e.thread_id||e.ids?(ns.events.trigger("daria:vToolbar:message-opened"),!0):!1},_recalculatePositionX:function(){if(!this.$nodeFixedPosition)return!1;var e={left:"",right:""};this.isFixed&&(e.left=this.$node.offset().left,e.right=$(window).width()-this.$node.outerWidth()-e.left),this.$nodeFixedPosition.css(e)},_toggleFixed:function(e){this.getModel("toolbar").toggleFixed(e)&&(e&&$(document).trigger("b-mail-dropdown-closeall-onscroll"),this.isFixed=e,this._recalculatePositionX(),this.$node.toggleClass("is-fixed",e),ns.events.trigger("toolbar.fixed",e))
},_resetOffset:function(){this._hasCheckScroll&&(this.controlOffsetTop=null,_.defer(this._recalculateFixedPosition.bind(this)))},onClickScrollToTop:function(){this.getModel("scroller-messages").setScrollTop(0,!0)},onChangeCompactMode:function(){this._resetOffset(),this.hideInCompactMode()},hideInCompactMode:function(){var e=this.getModel("settings");if(e.isCompactHeaderMode()){var t=this.getModel("search-view");this.$node.find(".js-toolbar").toggleClass("g-vhidden",!t.isFolded())}},onChangeCheckedCount:_.throttle(function(e,t){this.$node.toggleClass("is-active",Boolean(t))
},50),isNewYear:function(){var e=Date.now(),t=-1!==["ru","uk","be","kk"].indexOf(Daria.locale),o="yandex.com"===Daria.Config["yandex-domain"];return e>=14821812e5&&1483909199e3>=e&&t&&!o},onOpenMessage:function(){this._toggleFixed(!1)},onMessageWillClose:function(){var e=this;_.delay(function(){e._recalculateFixedPosition()},150)}}})}(Jane),function(e){var t=4;ns.View.define("toolbar-button",{events:{"ns-view-htmlinit":"_onHtmlInit","ns-view-show":"_onShow","ns-view-hide":"_onHide","click@show":"_onClick",drop:"_onDrop","daria:vToolbarButton:droppableInit@show":"_onDroppableInit","daria:vToolbarButton:droppableDestroy@show":"_onDroppableDestroy","daria:vToolbarButton:loader:end@show":"_disableLoader"},models:{"toolbar-button":!1,"messages-checked":!1},params:function(e){var t={id:e.id};
return _.extend(ns.View.infoLite("toolbar-buttons").params(e),t)},yateModule:"toolbar",methods:{_onHtmlInit:function(){this.initData()},_onShow:function(){this.droppableInit()},_onHide:function(){this.droppableDestroy()},invalidate:function(){return!1},initData:function(){var e=this.getModel("toolbar-button");this.action=e.get(".action"),this.disabledAction=e.get(".disabledAction"),this.actionParams=e.get(".actionParams"),_.isFunction(this.actionParams)&&(this.actionParams=this.actionParams(this.params))
},_onDroppableInit:function(e,t){this.getId()===t&&this.droppableInit()},_onDroppableDestroy:function(e,t){this.getId()===t&&this.droppableDestroy()},_onDrop:function(e,t){ns.events.trigger("daria:vToolbarButton:onDrop",{id:this.getId(),event:e,dropParams:t})},droppableInit:function(){var e=this.getModel("toolbar-button");if(e.get(".droppable")){var t=e.get(".droppableParams");this.$node.droppable(t)}},droppableDestroy:function(){try{this.$node.droppable("destroy")}catch(e){}},_getActionParams:function(){return this.actionParams
},_enableLoader:function(){var t=!this.getModel("toolbar-button").get(".disableLoader");t&&(this.loader=e.Loader.getActualLoader({action:this.getId()}),this.loader.start())},_disableLoader:function(){this.loader&&this.loader.stop()},_onClick:function(t,o){switch(o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,this.prepareParamsForAction().buttonView.action,this.getCurrentMessageIfSingle()),this._enableLoader(),this.action){case null:case"mailbox.check":break;case"deselect":this.getCheckedModel().resetChecked();
break;case"select-all":this.getCheckedModel().selectList();break;default:this.defaultAction(t)}return"mailbox.check"===this.action},defaultAction:function(){if(!this.enabled())return!1;var e=this.prepareParamsForAction();if(Daria.DEBUG&&console.log("daria.vToolbarButton","runOps",this.action,e),_.contains(["forward","sendon","reply","reply-all","reply-tmpl"],this.action))return e.mMessagesChecked=this.getCheckedModel(),void ns.action.run(this.action,e);var t=this.getCheckedModel(),o=t.runOps(this.action,e),n=this.getModel("toolbar-button"),i=n.get(".callback");
i&&"function"==typeof i&&o.then(i,this),(t.isFolderSelected()||_.contains(["remove.draft","infolder","mark","move","notspam","unmark","remove","tospam","pin","unpin","archive"],this.action))&&"message"!==ns.page.current.page&&("archive"===this.action?o.then(function(){t.resetChecked()}):t.resetChecked())},prepareParamsForAction:function(){return _.extend({buttonView:this,toolbar:1},this._getActionParams())},isVisible:function(){return!this.$node.hasClass("is-hidden")},getWidth:function(){return this.isVisible()?("labels-actions"===this.getId()&&(this._width=Math.floor(this.$node.outerWidth(!0))),this._width||(this._width=this.$node.outerWidth(!0)),this._width):0
},resetButtonWidth:function(){delete this._width},enabled:no.True,getId:function(){return this.getModel("toolbar-button").get(".id")},getFolderIdFromParams:function(){var e=this.params.current_folder;return this.params.mid&&(e=ns.Model.get("message",{ids:this.params.mid}).getFolderId()),e},hide:function(e){e||this.isVisible()||ns.events.trigger("daria:vToolbarButton:restruct",this),this.$node.addClass("is-hidden")},show:function(e){!e&&this.isVisible()&&ns.events.trigger("daria:vToolbarButton:restruct",this),this.$node.removeClass("is-hidden")
},toShow:function(){return this._canBeShown()&&(this._forceShown||this.getModel("toolbar-button").toShow())},getCheckedModel:function(){return this.getModel("messages-checked")},_canBeShown:function(){var e=this.getModel("toolbar-button"),t=this.getCheckedModel(),o=this.getId(),n=Daria.messages.canShowPinControlsByParams();return["compose","delete-draft","check-mail","abook-add","abook-more"].indexOf(o)>-1?!0:t&&(n||"pin"!==o&&"unpin"!==o)?e.toEnable():!1},isPinOrUnpin:function(){var e=this.getId();
return"pin"===e||"unpin"===e},canBeShownSelectOrDeselect:function(){var e=this.getId(),o=this.getCheckedModel(),n=o.shouldSelectAll();if("select-all"===e)return n;if("deselect"===e){var i=o.getCount();return!n||i>t}return!1},select:function(){this.$node.find(".js-toolbar-button").addClass("b-toolbar__item_selected")},deselect:function(){this.$node.find(".js-toolbar-button").removeClass("b-toolbar__item_selected")},forceShow:function(e){this._forceShown=e;var t=this._canBeShown();t?this.show():this.hide()
},triggerClick:function(e,t){return this._onClick(e,t)},_runAction:function(e){ns.action.run(this.action,{},e.currentTarget,e)},isSpecial:function(){return Boolean(this.getModel("toolbar-button").get(".special"))},getCurrentMessageIfSingle:function(){var e=this.getModel("messages-checked");if(!e)return null;var t=e.getIds();if(t&&0===t.tids.length&&1===t.ids.length){var o=ns.Model.get("messages",ns.page.current.params);return o.getMessageByMid(t.ids[0])}return null}}}),ns.View.edefine("toolbar-button-abook",{events:{"daria:vAbookContacts:selectionChanged":"onSelectionChanged","ns-page-after-load":"_toggleSelectAllState"},models:{"toolbar-button":!1,"abook-selected":!1},params:function(e){var t={id:e.id,type:e.type};
return _.extend(ns.View.infoLite("toolbar-buttons").params(e),t)},yateModule:"toolbar",methods:{_toggleSelectAllState:function(){if("abook-select-all"===this.getId()){var e=this.getCheckedModel(),t=e.isEmptyContactsList();this.$node.toggleClass("is-disabled",t)}},getCheckedModel:function(){return this.getModel("abook-selected")},onSelectionChanged:function(e,t){var o=this.getModel("toolbar-button").getData().id;_.has(t,o)&&(this.__toShow=Boolean(t[o]))},toShow:function(){var e=this.getId(),t=["abook-select-all","abook-deselect-all"].indexOf(e)>-1,o=1===this.params.shared,n=this.getCheckedModel().containsShared();
return!o&&!n||t?["abook-add","abook-restore","abook-more"].indexOf(e)>-1?!0:"abook-select-all"===e&&void 0===this.__toShow?!0:this.__toShow:!1}}},"toolbar-button"),ns.View.edefine("toolbar-button-check-mail",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{_onClick:function(t){return e.ToolbarMetric.tb(this.prepareParamsForAction()),this._runAction(t),!1}}},"toolbar-button"),function(){var t="toolbar-button",o=ns.View.infoLite(t).methods;ns.View.edefine("toolbar-button-hybrid-abstract",{yateModule:"toolbar",methods:{_onHtmlInit:function(){o._onHtmlInit.call(this),this.folderAction=this.getModel("toolbar-button").get(".folderAction")
},_onClick:function(t,o){o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,this.prepareParamsForAction().buttonView.action,this.getCurrentMessageIfSingle()),this._enableLoader(),this.defaultAction()},toShow:function(){return this.folderAction&&this.getModel("messages-checked").isFolderSelected()?!0:o.toShow.call(this)}}},t)}(),function(){var e=null,t=!1,o=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-disable-in",{events:{"daria:vMessage:message-body-loaded":"_onMessagesBodyLoaded"},models:o.models,params:o.params,yateModule:"toolbar",methods:{_onMessagesBodyLoaded:function(){},toShow:function(){if(this.params.mid){var e=ns.Model.get("message-body",{ids:this.params.mid});
if(e.isLoaded()&&!this.toEnableExtended())return!1}return o.methods.toShow.call(this)},toEnableExtended:no["true"],toEnableInCollectMessage:function(){if(this.params.mid){var e=ns.Model.get("message-body",{ids:this.params.mid});return!e.isCollectorMessage()}return!0},toEnableInNotificationMessage:function(){if(this.params.mid){if(!t){t=!0;var o=ns.Model.get("labels").getLabelByName("SystMetkaWJDT:NOTIFY");o&&(e=o.id)}if(e){var n=ns.Model.get("message",{ids:this.params.mid});if(n.hasLabel(e))return!1
}}return!0}}},"toolbar-button")}(),ns.View.define("toolbar-button-disabled",{yateModule:"toolbar",methods:{enabled:function(){var e=this.getCheckedModel();return e.getCount()||e.isFolderSelected()},toggleEnabled:function(e,t){var o="undefined"==typeof t?this.enabled():t;this.$node.toggleClass("is-disabled",!o)}}}),function(){var e="toolbar-button-hybrid-abstract",t="toolbar-button-disable-in";ns.View.edefine("toolbar-button-main-select-all",{events:{"ns-view-show":"toggleDisablement"},models:{"toolbar-button":!1,"messages-checked":{"ns-model-touched":"onMessagesCheckedTouched"},settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"onSettingChange"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{invalidate:ns.View.prototype.invalidate,onMessagesCheckedTouched:function(){this.toggleDisablement()
},onSettingChange:function(){this.invalidate()},toggleDisablement:function(){var e=this.getCheckedModel(),t=e.isEmptyMessagesList(),o=!t&&e.isPinnedMessagesList(),n=t||o;this.isDisabled=n,this.$node.toggleClass("is-disabled",n)},toShow:function(){var e=this.getCheckedModel();return e.shouldSelectAll()},_onClick:function(){if(this.isDisabled)return!1;var e=this.getCheckedModel();e.resetChecked(),e.selectList(!0),e.trigger("ns-model-reset-checked")}}},t,e)}(),function(){var e="toolbar-button-hybrid-abstract",t="toolbar-button-disable-in";
ns.View.edefine("toolbar-button-main-deselect-all",{models:{"toolbar-button":!1,"messages-checked":!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"onSettingChange"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{invalidate:ns.View.prototype.invalidate,onSettingChange:function(){this.invalidate()},toShow:function(){return!this.getCheckedModel().shouldSelectAll()},_onClick:function(){this.getCheckedModel().resetChecked()}}},t,e)}(),function(){var e=ns.View.infoLite("toolbar-button");
ns.View.edefine("toolbar-button-reply",{models:e.models,params:e.params,yateModule:"toolbar",methods:{toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},"toolbar-button-disable-in")}(),function(){var e=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-edit",{models:e.models,params:e.params,yateModule:"toolbar"},"toolbar-button-disable-in")}(),function(){var e=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-forward",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:e.params,yateModule:"toolbar",methods:{toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()
}}},"toolbar-button-disabled","toolbar-button-disable-in")}(),function(){var e=ns.View.infoLite("toolbar-button"),t="toolbar-button-disable-in",o=ns.View.infoLite(t);ns.View.edefine("toolbar-button-spam",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:e.params,yateModule:"toolbar",methods:{toShow:function(){var e=!1,t=this.getFolderIdFromParams();if(t){var n=ns.Model.get("folders");if(n.isFolder(t,["sent","draft","template"]))return!1;
e=n.isFolder(t,["spam"])}return!e&&o.methods.toShow.apply(this,arguments)},toEnableExtended:function(){return this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},"toolbar-button-disabled",t)}(),function(){var e="toolbar-button-spam",t=ns.View.infoLite(e),o="toolbar-button-disable-in",n=ns.View.infoLite(o);ns.View.edefine("toolbar-button-not-spam",{models:t.models,params:t.params,yateModule:"toolbar",methods:{toShow:function(){var e=!1,t=this.getFolderIdFromParams();return t&&(e=ns.Model.get("folders").isFolder(t,["spam"])),e&&n.methods.toShow.apply(this,arguments)
}}},e)}(),function(){var e="toolbar-button-hybrid-abstract",t="toolbar-button-disable-in",o=ns.View.infoLite(e).methods;ns.View.edefine("toolbar-button-pin",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var e=this.getFolderIdFromParams();if(e&&ns.Model.get("folders").isFolder(e,["spam"]))return!1;if(!o.toShow.call(this))return!1;
var t=this.getCheckedModel();return!t.hasPinnedCheckedMessage()}}},"toolbar-button-disabled",t,e)}(),function(){var e="toolbar-button-hybrid-abstract",t="toolbar-button-disable-in",o=ns.View.infoLite(e).methods;ns.View.edefine("toolbar-button-unpin",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var e=this.getFolderIdFromParams();if(e&&ns.Model.get("folders").isFolder(e,["spam"]))return!1;if(!o.toShow.call(this))return!1;
var t=this.getCheckedModel();return t.hasPinnedCheckedMessage()}}},t,e)}();var o="toolbar-button-hybrid-abstract",n="toolbar-button-disable-in",i=ns.View.infoLite(o).methods,s=ns.View.infoLite(n).methods;ns.View.edefine("toolbar-button-mark-as-read",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){if(this._forceShown)return!0;
var e=this.getCheckedModel();if(e.isFolderSelected()){var t=e.getFolders(),o=ns.Model.get("folders"),n=!1;for(var a in t)if(t[a]>0&&o.getUnreadCount(a)>0){n=!0;break}if(!n)return!1}else{if(!s.toShow.call(this))return!1;if(!i.toShow.call(this))return!1}return ns.Model.get("folders").isCurrentFolder("template")?!1:e.isFolderSelected()?!0:!e.areAllCheckedRead()},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disabled",n,o),function(){var e="toolbar-button-hybrid-abstract",t="toolbar-button-disable-in",o=ns.View.infoLite(e).methods;
ns.View.edefine("toolbar-button-mark-as-unread",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){if(this._forceShown)return!0;if(ns.Model.get("folders").isCurrentFolder("template"))return!1;var e=this.getCheckedModel();return e.isFolderSelected()||!e.getCount()?!1:o.toShow.call(this)?e.areAllCheckedRead():!1},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},t,e)}(),function(){var e=ns.View.infoLite("toolbar-button");
ns.View.edefine("toolbar-button-delete",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:e.params,yateModule:"toolbar"},"toolbar-button-disabled","toolbar-button-hybrid-abstract")}(),ns.View.edefine("toolbar-button-more",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:{id:null},yateModule:"toolbar",methods:{_onHtmlInit:function(){this.initData()
},_onShow:function(){this.initNb()},_onHide:function(){this.nbPopup.destroy()},initNb:function(){this.nbPopupToggler=nb.block(this.node),this.nbPopup=nb.$block(".js-main-toolbar-more-menu"),this.nbPopup.on("nb-select",this.onMenuItemClick.bind(this))},closeExtendButtons:function(){this.$extend&&(this.$extend.remove(),this.$extend=null,Daria.Dropdown.closeCurrent())},toShow:function(){return _.any(this._extendButtonViews,function(e){return e.toShow()})},setExtendButtons:function(t){var o=t.map(function(e){return e.getId()
});this._extendButtons=t.map(function(e){return e.getModel("toolbar-button")}),this._extendButtonViews=t,e.watcher.set("toolbar.buttons.extend",o.join(","))},_onClick:function(t){return this.enabled()?(_.delay(function(){var t=this._extendButtons.map(function(e){return _.assign({},e.getData(),e.getExData())}),o=e.tt("toolbar:toolbar-button-more-menu-content",{popupMenu:{menu:t}});this.nbPopup.setContent(o),this.nbPopupToggler.open()}.bind(this)),!1):(t.stopPropagation(),!1)},onMenuItemClick:function(e,t){var o=t.ui.item,n=o.children("a").data("id");
if(n){var i=_.find(this._extendButtonViews,function(e){return e.getId()===n});if(i){"labels-actions"!==n&&"folders-actions"!==n&&this.nbPopupToggler.close();var s={isInMore:!0},a=ns.action.getParams(o.children("a")[0]);a&&a.source&&(s.source=a.source),i.triggerClick(t.event,s)}}}}},"toolbar-button-disabled","toolbar-button"),function(){var e="toolbar-button-disable-in",t=ns.View.infoLite(e);ns.View.edefine("toolbar-button-reply-all",{events:{"daria:vMessage:message-body-loaded":"_onMessagesBodyLoaded"},models:t.models,params:t.params,yateModule:"toolbar",methods:{_onMessagesBodyLoaded:function(){t.methods._onMessagesBodyLoaded.call(this)
},toEnableExtended:function(){var e=ns.Model.get("message-body",{ids:this.params.mid});return e.isLoaded()&&e.allowedReplyAll()&&this.toEnableInCollectMessage()&&this.toEnableInNotificationMessage()}}},e)}(),function(){var e="toolbar-button-reply-all";ns.View.edefine("toolbar-button-unsubscribe",{models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShow:function(){var e=this.getCheckedModel();if("messages"==ns.page.current.page&&1!==e.getCount())return!1;
var t=e.getIds();if(!t.ids.length)return!1;var o=t.ids[0],n=ns.Model.get("message",{ids:o});if(n.inFolderBySymbol(["sent","draft","spam"]))return!1;var i=ns.Model.get("message-body",{ids:o});return i.hasListUnsubscribe()||i.hasFactUnsubscribe()||n.isNews()}}},e)}(),function(){var e="toolbar-button",t=ns.View.infoLite(e).methods;ns.View.edefine("toolbar-button-customizable-abstract",{yateModule:"toolbar",methods:{runButtonAction:function(){if(this.toShowWithSettings()){var e=$.Event("click",{target:this.node});
this.triggerClick(e)}},toShow:function(){var e=this.getSettingsKey();if(this._forceShown)return!0;if(this._lazyInitToolbarSettingsModel(),!this.mToolbarSettings||!this.mToolbarSettings.get(e))return!1;var t=this.getModel("messages-checked").isFolderSelected();return"template"!==this.getId()||!t&&this.toShowWithSettings()},toShowWithSettings:function(){ns.assert(null,"vToolbarButtonCustomizableAbstract","%s coundn't be called directly. It's abstract")},show:function(){t.show.apply(this,arguments)},_lazyInitToolbarSettingsModel:function(){this._toolbarSettingsModelInitDone||(this._toolbarSettingsModelInitDone=!0,this.mToolbar=ns.Model.get("toolbar",{layout:ns.page.current.page}),this.mToolbar&&this.mToolbar.areSettingsEnabled()&&this.getModel("toolbar-button").isModelWithSettings()&&(this.mToolbarSettings=Daria.userToolbar))
},_getActionParams:function(){return this._lazyInitToolbarSettingsModel(),_.clone(this.mToolbarSettings.get(this.getSettingsKey()).settings)},getSettingsKey:function(){return this.getId()},updateName:_.noop}},e)}(),function(){var e="toolbar-button-customizable-abstract",t=ns.View.infoLite(e).methods;ns.View.edefine("toolbar-button-with-customizable-name",{events:{"daria:vToolbarButton:updateName":"updateName"},yateModule:"toolbar",methods:{toShow:function(){return t.toShow.apply(this,arguments)},show:function(){this.updateName(),t.show.apply(this,arguments)
},updateName:function(){var e=this.mToolbarSettings.getCustomizableButtonName(this.getId());e&&this.getModel("toolbar-button").setName(e)},redrawName:function(){var e=this.getModel("toolbar-button").get(".name");this.$node.find(".js-toolbar-item-title").text(e)}}},e)}(),ns.View.edefine("toolbar-button-archive",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){var e=ns.Model.get("folders"),t=this.getFolderIdFromParams();
return t?!e.isArchive(t):!0}}},"toolbar-button-disabled","toolbar-button-customizable-abstract"),function(){var e="toolbar-button-disable-in",t=ns.View.infoLite(e),o="toolbar-button-with-customizable-name",n=ns.View.infoLite(o);ns.View.edefine("toolbar-button-sendon",{events:{"daria:vToolbarButtonSendOn:doForward@show":"runButtonAction"},models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){return this.getCheckedModel().getCount()>0
},toShow:function(){return n.methods.toShow.call(this)?t.methods.toShow.call(this):void 0},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},"toolbar-button-disabled",e,o)}(),ns.View.edefine("toolbar-button-infolder",{models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){var e=this.getFolderIdFromParams();
if(Daria.IS_CORP&&ns.Model.get("folders").isShared(e))return!1;if(e&&e==jpath(this.mToolbarSettings.get(this.getId()),".settings.folder")[0])return!1;var t=this.getCheckedModel();return t.getCount()>0&&!t.isFolderSelected()}}},"toolbar-button-disabled","toolbar-button-with-customizable-name"),ns.View.edefine("toolbar-button-label",{models:{"toolbar-button":{"ns-model-changed":"keepValid","ns-model-changed.name":"redrawName"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(e){e=e||this.getId();
var t=this.mToolbarSettings.get(e),o=this.getCheckedModel(),n=t.settings.label,i=o.getIds("label",{lid:n});return i.ids.length+i.tids.length>0}}},"toolbar-button-disabled","toolbar-button-with-customizable-name"),ns.events.on("pageinit",function(){ns.events.on("daria:mComposeMessage:template-saved",function(e,t){var o="template";if(t.oldMid&&t.mid){var n=Daria.userToolbar.get(o);n&&n.settings.tmpl===t.oldMid&&(n.settings.tmpl=t.mid,Daria.userToolbar.set())}})});var n="toolbar-button-disable-in",a=ns.View.infoLite(n),r="toolbar-button-customizable-abstract",l=ns.View.infoLite(r);
ns.View.edefine("toolbar-button-template",{events:{"daria:vToolbarButtonTemplate:doSendAutoReplay@show":"runButtonAction"},models:{"toolbar-button":!1,"messages-checked":!1},params:ns.View.infoLite("toolbar-button").params,yateModule:"toolbar",methods:{toShowWithSettings:function(){var e=this.mToolbarSettings.get(this.getId());if(!e)return!1;var t=this.getCheckedModel();if("messages"==ns.page.current.page&&1!==t.getCount())return!1;var o=t.getIds("template");return o.ids.length||o.tids.length?!0:!1
},toShow:function(){return l.methods.toShow.call(this)?a.methods.toShow.call(this):void 0},toEnableExtended:function(){return this.toEnableInNotificationMessage()}}},n,r),ns.View.edefine("toolbar-button-add-template",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["draft","template"])},_onClick:function(){return ns.Model.get("compose-predefined-data").setData({save_symbol:"template"}),ns.page.go(ns.router.generateUrl("compose2")),!1
}}},"toolbar-button"),ns.View.edefine("toolbar-button-toolbar-settings",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return!0},_onClick:function(t){ns.events.trigger("daria:vToolbar:customize"),ns.events.trigger("daria:vToolbar:action",{action:"customize"}),e.Services.load("#setup",function(){ns.events.trigger("daria:vToolbarButton:updateName");var o=ns.View.create("toolbar-settings");o.update().then(function(){o.showPopup(t?$(t.target):this.$node.find(".js-toolbar-item"))
}.bind(this)),"toolbar-settings"===this.getId()&&e.ToolbarMetric.ub("клик на шестеренку")}.bind(this))}}},"toolbar-button-customizable-abstract"),ns.View.edefine("toolbar-button-add-button",{models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShowWithSettings:function(){return e.Config.NO_SETTINGS?!1:!this.mToolbarSettings.isActivated()},_onClick:function(){this.super_._onClick.apply(this,arguments),e.ToolbarMetric.ub('клик на предложение "Добавить"')}}},"toolbar-button-toolbar-settings"),ns.View.edefine("toolbar-button-compose",{events:{"compose.open.change":"_onComposeOpenChange"},models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{toShow:function(){return!!e.watcher.get("compose.open")&&this.getModel("toolbar-button").toEnable()
},_onComposeOpenChange:function(){},_onClick:function(e){return"compose.remove"===this.action?ns.events.trigger("daria:vToolbarButton:"+this.action):this._runAction(e),!1}}},"toolbar-button"),ns.View.edefine("toolbar-button-compose-go",{models:{"toolbar-button":!1,settings:!1,"compose-sidebar-fsm":!1},params:{id:null},yateModule:"toolbar",methods:{_onClick:function(t){e.ToolbarMetric.tb(this.prepareParamsForAction());var o=this.getModel("settings").isSet("compose-in-window");return!o||t.metaKey||t.ctrlKey?void 0:(this.getModel("compose-sidebar-fsm").setState("edit"),!1)
},toShow:function(){return"compose2"!==ns.page.current.page}}},"toolbar-button"),ns.View.edefine("toolbar-button-compose-special",{events:{"daria:vToolbarButton:switchType":"_onSwitchType"},models:{"toolbar-button":!1},params:{id:null},yateModule:"toolbar",methods:{_onSwitchType:function(e,t){var o=t.type&&t.type===this.getModel("toolbar-button").getType();this[o?"select":"deselect"]()},_onClick:function(){var e=this.getModel("toolbar-button"),t=e.getType();return ns.events.trigger("daria:vToolbarButton:"+t,{buttonView:this}),ns.events.trigger("daria:vToolbarButton:switchType",{buttonView:this,type:t}),!1
}}},"toolbar-button-compose"),ns.View.edefine("toolbar-button-compose-abook",{models:{"toolbar-button":!1,"abook-selected":!1},params:function(e){var t={id:e.id,type:e.type};return _.extend(ns.View.infoLite("toolbar-buttons").params(e),t)},yateModule:"toolbar",methods:{toShow:function(){var e=this.getModel("toolbar-button");return _.isFunction(e.toEnable)?e.toEnable():!0}}},"toolbar-button-abook"),function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-translate",{models:t.models,params:t.params,yateModule:"toolbar",methods:{isMore:no.True,_onClick:function(t,o){o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,"translate",this.getCurrentMessageIfSingle()),ns.Model.get("message-widget-state",{ids:ns.page.current.params.ids}).show("message-widget-translate")
}}},"toolbar-button-disable-in")}(),function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-print",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,o){o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,"print",this.getCurrentMessageIfSingle())},isMore:no.True}},"toolbar-button-disable-in")}(),function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-filters-create",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,o){o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,"filters-create")
},isMore:no.True}},"toolbar-button-disable-in")}(),function(){var t=ns.View.infoLite("toolbar-button");ns.View.edefine("toolbar-button-message-source",{models:t.models,params:t.params,yateModule:"toolbar",methods:{_onClick:function(t,o){o=o||ns.action.getParams(t.currentTarget),e.ToolbarMetric.setToolbarMetrics(t,o,"message-source",this.getCurrentMessageIfSingle())},isMore:no.True}},"toolbar-button-disable-in")}(),function(e){var t,o={},n=2;t=Modernizr.mozilla?["click","keyup"]:["change"],_.each(t,function(e){o[e+"@show .js-toolbar-settings-button-options-select"]="_onButtonOptionsSelectChange"
}),ns.View.define("toolbar-settings",{events:_.extend(o,{"ns-view-init":"_onInit","label.filter.toggle":"resizeDialog","scroll@show window":"_onScrollWindow","resize@show window":"_onResizeWindow","click@show .js-clickable":"_onClick",'keyup@show .js-toolbar-settings-button-options-select,input[type="text"]':"_onButtonOptionsSelectEnter","focus@show .js-toolbar-settings-button-options-email":"_onButtonOptionsEmailFocus"}),models:{settings:!1,toolbar:!1},params:function(){return{layout:ns.page.current.page}
},yateModule:"toolbar",methods:{_onInit:function(){this.mToolbarSettings=Daria.userToolbar,this.POPUP_WIDTH=750,this._locked=!1,this._$handle=null,this._handleOffset=null,this._dialog=null,this._dialogOffset=null,this._currentButtonIdEditing=null,this._$buttonOptionsForm=null},getSettings:function(){return this.mToolbarSettings.get()},showPopup:function(e){this._$window&&this._$window.length||(this._$window=$(window)),this._$handle=e,this._handleOffset=e.offset(),this._dialog=Daria.Dialog.open({body:this.$node,width:this.POPUP_WIDTH,easyclose:!1,hideCrossClose:!0,additionalClass:"b-toolbar-settings",onTarget:{side:"top",pos:"bottom",x:this.getPopupLeftPosition(),y:this.getPopupTopPosition()-this._$window.scrollTop(),needTail:!1},onopen:this.onPopupOpen.bind(this),oncancel:this.onPopupCancel.bind(this),onclose:this.onPopupClose.bind(this)}),this._dialog.resize=function(e){var t=this.$body.find(e?".js-toolbar-settings-form":".js-toolbar-settings");
this.$body.height(t.height())},this.isActivated()||this.mToolbarSettings.activate().done(function(){ns.events.trigger("daria:vToolbarButtons:settingsActivated"),ns.events.trigger("daria:vToolbarButton:restruct")}.bind(this))},isActivated:function(){return this.mToolbarSettings.isActivated()},onPopupOpen:function(e){this._dialog=e,e.$paranja.removeClass("g-hidden"),e.$dialog.removeClass("b-popup_contextual"),e.$dialog.find("input").filter(":visible").eq(0).focus(),this._dialogOffset=e.$dialog.offset(),this._dialogOffset.top=this._dialogOffset.top-this._$window.scrollTop()
},onPopupCancel:function(){this.mToolbarSettings.invalidateCache(),ns.events.trigger("daria:vToolbarSettings:canceled"),e.ToolbarMetric.ub(["настройки",'клик на "Отменить"'])},onPopupClose:function(e){this._dialog.autocompleter&&(this._dialog.autocompleter.hide(),this._dialog.autocompleter.destroy()),this._$handle=null,this._handleOffset=null,this._dialog=null,this._dialogOffset=null,this._currentButtonIdEditing=null,this._$buttonOptionsForm=null,e.$paranja.addClass("g-hidden"),ns.events.trigger("daria:vToolbarSettings:popupClosed"),this.destroy()
},getPopupLeftPosition:function(){var e=this._$handle.outerWidth(),t=this._handleOffset.left+e/2,o=this.POPUP_WIDTH/2,i=$(".js-mail-layout"),s=i.width(),a=i.offset().left,r=a+s,l=t;return a>t-o?l=o+a+n:t+o>r&&(l=r-o+n),l},getPopupTopPosition:function(){return this._handleOffset.top+this._$handle.outerHeight()},_onClick:function(e){var t=$(e.currentTarget),o=ns.action.getParams(t[0]);switch(t.data("clickAction")){case"toolbar.settings.button.toggle":this._onButtonToggle(t,o);break;case"toolbar.settings.button.options":this._onButtonEditOptions(o);
break;case"toolbar.settings.submitButtonOptions":this._onSubmitButtonOptions(o);break;case"toolbar.settings.submit":this._onSubmit();break;case"toolbar.settings.back":this._onBack(o)}return!1},deactivateButton:function(t,o){var n=this.getModel("toolbar").getById(t);return this._markButtonDeactivated(o),n.resetName(),e.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"снять выбор"]),this.mToolbarSettings.deactivateButton(t)},_markButtonDeactivated:function(e){e.removeClass("b-mail-button_filter-selected").find(".js-toolbar-item-title").text(e.data("title"))
},activateButton:function(t,o){var n=this.getModel("toolbar").getById(t);return e.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"выбор"]),_.isEmpty(n.get(".settings"))?(this._markButtonActivated(o),this.mToolbarSettings.activateButton(t,n.get(".settings"))):void this.startButtonOptionsEditing(t,n)},_markButtonActivated:function(e,t){e.addClass("b-mail-button_filter-selected").find(".js-toolbar-item-title").text(t)},_onButtonToggle:function(e,t){if(!this.isLocked()){var o=t.button,n=this.mToolbarSettings.isButtonActivated(o),i=null;
i=n?this.deactivateButton(o,e):this.activateButton(o,e),this.unlock(),_.isArray(i)&&ns.events.trigger("daria:vToolbarSettings:buttonToggled")}},startButtonOptionsEditing:function(e,t){_.isUndefined(t)&&(t=this.getModel("toolbar").getById(e)),this._currentButtonIdEditing=e,t.getSettingsDepsParams().then(function(o){var n=Vow.fulfill({}),i=t.get(".settingsDeps");_.isEmpty(i)||(n=ns.request(i,o)),n.then(function(){this.showButtonOptionsForm(e,t,o)}.bind(this))}.bind(this),this.showButtonOptionsForm.bind(this,e,t))
},_onButtonEditOptions:function(e){this.startButtonOptionsEditing(e.button)},showButtonOptionsForm:function(t,o,n){n=n||{},n.isLocked=this.isLocked();var i=this._dialog.$body,s=i.outerWidth(),a=this.mToolbarSettings.get(t)||{},r=_.extend({},{params:n,button:_.extend({},a,{id:t})});this._$buttonOptionsForm=$(e.tt("toolbar:js-toolbar-settings-button-options-form",r,o.get(".settingsDeps"),n)),this.$node.remove(".js-toolbar-settings-form").append(this._$buttonOptionsForm.addClass("g-vhidden")),i.width(s),Daria.setZeroTimeout(function(){this._$buttonOptionsForm.removeClass("g-vhidden")
}.bind(this)),this.$node.find(".js-toolbar-settings").animate({marginLeft:0-s},{complete:function(){this._dialog.resize(!0),this._getButtonOptionsFormControls().filter(":visible").eq(0).focus()}.bind(this)}),e.ToolbarMetric.ub(["настройки","клик на "+o.get(".action"),"настройки","показ"])},_getButtonOptionsFormControls:function(){return this._$buttonOptionsForm.find('input[type="text"], select, textarea')},_onButtonOptionsSelectChange:function(e){this._$buttonOptionsForm.find(".js-toolbar-settings-error").addClass("g-hidden");
var t=$(e.currentTarget),o=t.attr("name"),n=t.val(),i=this._$buttonOptionsForm.find(".js-toolbar-settings-"+o+"-edit");if("new"===n&&i.hasClass("g-hidden")){switch(i.removeClass("g-hidden"),o){case"label":this._dialog.labelCreate=Daria.LabelCreateContext({parent:i,hotkey:!1}),this._dialog.labelCreate.init();break;case"folder":this._dialog.folderCreate=Daria.FolderCreateContext({parent:i,hotkey:!1}),this._dialog.folderCreate.init()}this._focusNextFormControl(t)}else"new"!==n&&i.addClass("g-hidden");
this._dialog.resize(!0)},_onButtonOptionsSelectEnter:function(t){if(t.keyCode!==e.Common.keyCode.ENTER)return!0;var o=$(t.currentTarget);return this._focusNextFormControl(o).fail(function(){this._onSubmitButtonOptions({button:this._currentButtonIdEditing})}.bind(this)),!1},_focusNextFormControl:function(e){var t=new Vow.Promise,o=this._getButtonOptionsFormControls(),n=o.filter(":visible").slice(o.index(e)+1).eq(0);return n.length?(n.focus(),t.fulfill()):t.reject(),t},_onButtonOptionsEmailFocus:function(e){var t=e.currentTarget;
this._dialog.autocompleter=Daria.Autocompleter.getContactEmail(),this._dialog.autocompleter.bindField({field:t,focus:1,currentValue:$(t).val()})},_onSubmitButtonOptions:function(t){if(!this.isLocked()){this.lock();var o=t.button,n=this.getModel("toolbar").getById(o),i={};_.each(n.get(".settings"),function(e,t){i[t]=this._$buttonOptionsForm.find('[name="'+t+'"]').val()}.bind(this));var s=new Vow.Promise,a=n.validateSettings(i),r=this._$buttonOptionsForm.find(".js-toolbar-settings-loader"),l=this._$buttonOptionsForm.find(".js-toolbar-settings-error");
l.addClass("g-hidden"),r.removeClass("g-hidden"),_.isEmpty(a)?s.sync(this._createContainerIfNeeded(o,i)):s.reject(),s.always(function(e){return r.addClass("g-hidden"),this.unlock(),e}.bind(this)).then(function(){this.mToolbarSettings.activateButton(o,i);var t=this.$node.find(".js-toolbar-settings-button-"+o),s=this.mToolbarSettings.getCustomizableButtonName(o);this._markButtonActivated(t,s),ns.events.trigger("daria:vToolbarSettings:buttonOptionsChanged"),this._onBack(),e.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","применить"])
}.bind(this),function(t){_.isString(t)&&a.push(t),l.each(function(){var e=$(this),t=e.data("errors");t&&_.intersection(a,t.split(" ")).length&&e.removeClass("g-hidden")}),this._dialog.resize(!0),e.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","ошибка"])}.bind(this))}},_createContainerIfNeeded:function(e,t){var o=new Vow.Promise;if("template"===e)if("new"===t.tmpl){t.tmpl=null;var n=(this._$buttonOptionsForm.find('[name="body"]').val()||"").trim();n?this._createNewTemplate(n).then(function(e){t.tmpl=e,ns.page.go().always(function(){o.fulfill()
})},function(){o.reject("template_body_save")}):o.reject("template_body_empty")}else o.fulfill();else"label"===e?"new"===t.label?(t.label=null,this._dialog.labelCreate.onCreate().then(function(e){t.label=e,ns.page.go().always(function(){o.fulfill()})},function(){o.reject("label_edit"),ns.events.once("label.error.hide",function(){this._dialog.resize(!0)}.bind(this))})):o.fulfill():"infolder"===e&&"new"===t.folder?(t.folder=null,this._dialog.folderCreate.onCreate().then(function(e){t.folder=e,o.fulfill()
},function(){o.reject("folder_edit"),ns.events.once("folder.error.hide",function(){this._dialog.resize(!0)}.bind(this))})):o.fulfill();return o},_onSubmit:function(){if(!this.isLocked()){this.lock();var t=this.$node.find(".js-toolbar-settings-main-loader");t.removeClass("g-hidden"),this.save().then(function(){e.ToolbarMetric.ub(["настройки",'клик на "Готово"'])}.bind(this)).always(function(){this.unlock(),t.addClass("g-hidden")}.bind(this)).then(function(){this._dialog.close()}.bind(this))}},_onBack:function(t){if(!this.isLocked()){var o=function(){this._$buttonOptionsForm.remove(),this._dialog.resize(!1),this.$node.find("input").filter(":visible").eq(0).focus()
}.bind(this);if(this.$node.find(".js-toolbar-settings").animate({marginLeft:0},{always:o}),t&&t.button){var n=this.getModel("toolbar").getById(t.button);e.ToolbarMetric.ub(["настройки","клик на "+n.get(".action"),"настройки","назад"])}this._currentButtonIdEditing=null}},resizeDialog:function(){this._dialog&&this._dialog.resize(!0)},_onResizeWindow:_.debounce(function(){this._dialog&&(this._dialog.$dialog.offset({left:this.getPopupLeftPosition()-this.POPUP_WIDTH/2}),this._animateDialogPosition(),this._dialog.autocompleter&&this._dialog.autocompleter.hide())
},200,{trailing:!0}),_onScrollWindow:_.throttle(function(){this._dialog&&(this._animateDialogPosition(),this._dialog.autocompleter&&this._dialog.autocompleter.hide())},50,{trailing:!0}),_animateDialogPosition:function(){this._dialog.$dialog.animate({top:this._dialogOffset.top+this._$window.scrollTop()},{queue:!1})},lock:function(){return e.disableButton(this.$node.find(".js-toolbar-settings-control")),this._locked=!0,!0},unlock:function(){return e.enableButton(this.$node.find(".js-toolbar-settings-control")),this._locked=!1,!0
},isLocked:function(){return this._locked},save:function(){var e=this.mToolbarSettings.set();return e.done(function(e){ns.events.trigger("daria:vToolbarSettings:saved",_.pluck(e,"id"))}.bind(this)),e},_createNewTemplate:function(e){var t=new Vow.Promise,o=new Vow.Promise,n=ns.Model.get("folders").getFidBySymbol("template");return n?o.fulfill():ns.Model.get("folders").createTemplateFolder().then(function(e){n=e.fid,o.fulfill()}),o.then(function(){var o=ns.Model.get("settings"),i=e.match(/^.{1,15}/)||"";
i&&(i=i[0],e.length>i.length&&(i+="...")),Daria.SendMail.sendFormJson({$form:$("<form></form>"),params:{to:"",bcc:"",cc:"",from_mailbox:o.getSetting("default_email"),from_name:o.getSetting("from_name"),go:1,ign_overwrite:"no",nosend:"yes",save_symbol:"template",send:e,subj:i,ttype:"plain",templates_fid:n},success:function(e){if(e.storedmid){var o=["messages","message-nearest","message-thread-nearest","abook-contacts","abook-contact","folders"];o.forEach(function(e){ns.Model.invalidate(e)}),ns.Model.get("messages-pager",ns.page.current.params).invalidate(),ns.Model.get("messages-pager",{current_folder:n}).invalidate(),ns.page.go(),t.fulfill(e.storedmid)
}else t.reject()},error:function(){t.reject()}})}),t}}})}(e)}(Jane),function(){ns.ViewCollection.define("toolbar-buttons",{events:{"ns-view-show":"_onShow","scroll window":"_onScrollWindow","resize window":"_onResizeWindow","daria:vToolbarButton:restruct":"_onRestructToolbarButton","daria:vToolbarSettings:settingsActivated":"_onSettingsActivated","daria:vToolbarSettings:buttonToggled":"_restruct","daria:vToolbarSettings:popupClosed":"_restruct","daria:vToolbarSettings:buttonOptionsChanged":"_restruct","daria:vAbookContacts:selectionChanged":"onAbookSelectionChanged"},models:{settings:{"ns-model-changed":"keepValid","ns-model-changed.hide_daria_left":"onToggleCompactMode"},toolbar:{"ns-model-changed":"keepValid","ns-model-changed.fixed":"onChangeToolbarFixed"},"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"onMessagesCheckedTouched"}},params:Daria.params.toolbarButtons,split:{byModel:"toolbar",intoViews:function(e){var t="toolbar-button-"+e.get(".id");
return ns.View.isDefined(t)||(t=_.contains(t,"abook")?"toolbar-button-abook":"toolbar-button"),t}},ctor:function(){this._lazyRestructToolbar=_.debounce(function(e){this.triggerCheckedCountEvent(),this._restruct(e)},100)},yateModule:"toolbar",methods:{forceRestruct:!1,_onShow:function(){this._lazyRestructToolbar()},onMessagesCheckedTouched:function(){this._lazyRestructToolbar()},_getViews:function(){return _.values(this.views)},getViewsIds:function(e){return _.isUndefined(e)&&(e=this._getViews()),_.map(e,function(e){return e.getId()
})},_getViewsToShow:function(){return this._getSpecificViewsHelper("toShow")},_getVisibleViews:function(){return this._getSpecificViewsHelper("isVisible")},_getSpecificViewsHelper:function(e){return _.filter(this._getViews(),function(t){var o=t.getId(),n=_.contains(["more"],o);if(!n){var i=t[e];if(i)return i.call(t)}})},onToggleCompactMode:function(){this.keepValid(),_.forEach(this._getViews(),function(e){e.resetButtonWidth()}),this._lazyRestructToolbar()},_restruct:function(e){if(this.isVisible()){var t=$.isPlainObject(e)?e.force:!1,o=this.getModel("toolbar"),n=this.getButtonView("more"),i=this.getButtonView("toolbar-settings");
if(n&&(n.show(!0),n.closeExtendButtons()),!(t||this.forceRestruct||o.get(".settings")&&n))return!1;this.forceRestruct=!1;var s=n?n.getWidth():0,a=i?i.toShow():!1,r=a?i.getWidth():0,l=this.$node.find(".js-toolbar-button-top"),d=l.is(":visible")?l.width():0,c=this.getWidth()-s-r-d,u=0,h=[],b=this._getVisibleViews(),g=this._getViewsToShow();Daria.DEBUG&&console.log("vToolbarButtons",this.key,"._restruct","viewsToShow",g.map(function(e){return e.getId()}));var f=_.reject(b,function(e){return _.contains(g,e)
});f.forEach(function(e){e.hide(!0)});var m=!1,p=_.filter(g,function(e){if(e.show(!0),a&&"toolbar-settings"===e.getId())return!0;var t=e.getWidth();return n?m||u+t>=c?(m=!0,h.push(e),!1):(u+=t,!0):m||u+t>c?(m=!0,!1):(u+=t,!0)});Daria.DEBUG&&console.log("vToolbarButtons",this.key,"._restruct","moreButtons",h.map(function(e){return e.getId()}));var v=_.xor(g,p);v=_.uniq(v.concat(this._getSpecificViewsHelper("isMore"))),1===v.length&&u-s+v[0].getWidth()<=c&&(v.shift(),n.hide(!0)),v.forEach(function(e){e.hide(!0)
}),n&&(v.length?n.show(!0):n.hide(!0),n.setExtendButtons(v))}},_onSettingsActivated:function(){this.getButton("add-button").hide(),this.getButton("toolbar-settings").show()},getButtonView:function(e){var t="toolbar-button-"+e;return ns.View.isDefined(t)||(t="toolbar-button"),this.views[ns.View.getKey(t,{id:e})]},getWidth:function(){if(this.getModel("toolbar").isFixed()){var e=this.$node.closest(".js-toolbar-wrap");return e.width()-e.find(".js-toolbar-aside").width()}return this.$node.closest(".js-toolbar-chevron").width()
},getButton:function(e){return _.find(this.views,function(t){return t.getId()===e})},_onScrollWindow:_.throttle(function(){var e=this.getButtonView("more");e&&e.closeExtendButtons()},50),_onResizeWindow:function(){this._lazyRestructToolbar()},_onRestructToolbarButton:function(e,t){t&&t.force&&(this.forceRestruct=!0),this._lazyRestructToolbar(t)},onAbookSelectionChanged:function(){this._lazyRestructToolbar({force:!0})},onChangeToolbarFixed:function(){this.getModel("toolbar").isFixed()||this._lazyRestructToolbar()
},triggerCheckedCountEvent:function(){if(this.isVisible()){var e=this.getModel("messages-checked");ns.events.trigger("daria:vToolbarAside:changeCheckedCount",e.getCount())}}}}),function(){var e={};e._restruct=function(){_.forEach(this.views,function(e){e.isSpecial()||e[e.toShow()?"show":"hide"](!0)})}.lazy(200),ns.ViewCollection.edefine("toolbar-buttons-compose",{models:{settings:!1,toolbar:!1},split:{byModel:"toolbar",intoViews:function(e){var t="toolbar-button-"+e.get(".id");return Daria.is3pane()&&ns.View.isDefined(t+"-3pane")?t+"-3pane":ns.View.isDefined(t)?t:e.get(".special")?"toolbar-button-compose-special":"toolbar-button-compose"
}},events:{"ns-page-after-load":"_restruct","compose.mid.change@show":"_restruct"},yateModule:"toolbar",methods:_.extend(e,{_onShow:function(){this.super_._onShow.call(this),this._restruct();var e=Daria.vCompose.type;this.getButton(e).select()},getSpecialButtonIds:function(){return _(this.views).values().map(function(e){return e.isSpecial()?e.getId():null}).compact().value()}}),params:function(){return{layout:ns.page.current.page}}},"toolbar-buttons")}()}(Jane),function(){var e="toolbar-button",t=ns.View.infoLite(e).methods;
ns.View.edefine("toolbar-button-folders-actions",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:function(e){return ns.View.infoLite("toolbar-button").params(e)},events:{"daria:vFoldersActions:open":"onFoldersActionsOpen"},yateModule:"toolbar",methods:{onFoldersActionsOpen:function(){if(this.toShow()){var e=this.$node.parents(".js-toolbar").find(".js-toolbar-item-more"),t=this.isVisible()?this.$node:e;
t.length||(t=this.$node.parent()),this.vFoldersActions=ns.View.create("folders-actions"),this.vFoldersActions.open(t,this.getModel("messages-checked"))}},_onClick:function(e,t){this.enabled()&&(t=t||ns.action.getParams(e.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(e,t,"move",this.getCurrentMessageIfSingle()),this.vFoldersActions&&this.vFoldersActions._isOpen||(this.vFoldersActions=ns.View.create("folders-actions"),this.vFoldersActions.open(e.currentTarget,this.getModel("messages-checked"),t)))
},toShow:function(){return t.toShow.call(this)?_.contains(["message","messages"],ns.page.current.page):!1}}},"toolbar-button-disabled",e)}(),function(){var e="toolbar-button";ns.View.edefine("toolbar-button-labels-actions",{models:{"toolbar-button":!1,"messages-checked":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model-touched":"toggleEnabled"}},params:ns.View.infoLite("toolbar-button").params,events:{"ns-view-show":"onShow","daria:vLabelsActions:open":"onLabelsActionsOpen"},yateModule:"toolbar",methods:{onShow:function(){"compose2"===ns.page.current.page&&this.enabled()&&this.toggleEnabled(null,!0)
},onLabelsActionsOpen:function(){if(this.toShow()){var e=this.$node.parents(".js-toolbar").find(".js-toolbar-item-more"),t=this.isVisible()?this.$node:e;t.length||(t=this.$node.parent()),this.vLabelsActions=ns.View.create("labels-actions"),this.vLabelsActions.open(t,this.getModel("messages-checked"))}},_onClick:function(e,t){if(this.enabled()&&(t=t||ns.action.getParams(e.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(e,t,"label",this.getCurrentMessageIfSingle()),!this.vLabelsActions||!this.vLabelsActions._isOpen)){var o="compose2"===this.params.layout?["labels-actions-compose",ns.page.current.params]:["labels-actions",this.params];
this.vLabelsActions=ns.View.create.apply(null,o),this.vLabelsActions.open(e.currentTarget,this.getModel("messages-checked"),t)}},toShow:function(){var e=_.contains(["message","messages","compose2"],ns.page.current.page);return"messages"===ns.page.current.page?e=!ns.Model.get("folders").spamOrTrash(ns.page.current.params.current_folder):"message"===ns.page.current.page&&(e=!ns.Model.get("message",{ids:ns.page.current.params.ids}).inFolderBySymbol(["trash","spam"])),!!e},enabled:function(){var e=this.getCheckedModel();
return e.getCount()||e.isFolderSelected()||"compose2"===ns.page.current.page}}},"toolbar-button-disabled",e)}(),function(){var e=ns.Model.get("all-toolbar-buttons"),t={scroll:!0,settings:!0},o={messages:["main-select-all","main-deselect-all","compose-go","check-mail","forward","delete","add-template","spam","not-spam","mark-as-read","pin","unpin","mark-as-unread","archive","sendon","infolder","label","template","add-button","labels-actions","folders-actions","more","toolbar-settings"],message:["compose-go","check-mail","edit","reply","reply-all","forward","delete","spam","not-spam","unsubscribe","mark-as-unread","pin","unpin","archive","sendon","infolder","label","template","add-button","labels-actions","folders-actions","translate","print","filters-create","message-source","more","toolbar-settings"],"no-message":["compose-go","check-mail","forward","delete","spam","not-spam","mark-as-unread"]};
_.each(o,function(o,n){var i=e.getButtonsByIds(o);ns.Model.get("toolbar",{layout:n}).setData(_.extend({},t,{buttons:i}))})}()});