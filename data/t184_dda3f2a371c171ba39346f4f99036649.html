Jane.module("jane.messages.js",function(){"use strict";function e(e,s){this.$headline=e,this.$headlineClone=e.clone(),this.$scrollArea=s,this.fixedState=!1,this.allowFixedState=!0,this._bindEvents()}Daria.Alerts={messages:{},callback:function(e){var s=this;e.messages&&$.each(e.messages,function(){var e=s.messages[this.id];"function"==typeof s[e]&&s[e](this)})}},function(){ns.action.define("abook.person-add",function(e,s,t,a){var i={event:a,params:s},o=i.event&&$(i.event.currentTarget).serializeObject()||{},n=i.params.email,r=i.params.name||"",d=i.params.owner,l=i.params.cid,h=l?"do-abook-person-update":"do-abook-person-add",c=l?o:{mail_addr:n,first_name:r};
!l&&("first_name"in o||"last_name"in o)&&(c.first_name=o.first_name||"",c.last_name=o.last_name||""),ns.forcedRequest([h],c).then(function(e){var s=e[0],t=s.get(".cid"),a=t||l;if(a){if(ns.Model.invalidate("abook-contacts"),Daria.Autocompleter.getContact().flushCache(),$.isFunction(i.params.callback)&&i.params.callback(a),"done"==d){var o=ns.Model.get("settings");o.setSettings({"promo-fb_hold-period":Daria.timify({months:1})}),Jane.c("Done","Facebook",l?"Контакт изменён":"Контакт добавлен"),ns.page.go("#inbox")
}Daria.Statusline.showMsg({name:"abook.person-add",body:n+" добавлен в контакты."})}else Daria.Statusline.showMsg({name:"abook.person-add",body:n+" уже есть в контактах."})}),$(document).trigger("b-mail-dropdown-closeall")}),ns.action.define("shortcuts.switch-tab",function(e,s,t,a){var i={event:a,params:s};Daria.Shortcuts.switchTab(i)}),ns.action.define("mail-common.go-to-inbox",function(){ns.page.go("#inbox")})}(),ns.action.define("message.go-to-ticket",function(e,s,t,a){if($(a.target).closest("a")[0]&&!a.doGoToTicketAction)return!0;
var i=ns.router.generateUrl("message",{ids:s.ids});a.ctrlKey||a.metaKey&&Modernizr.mac?window.open(i,"_blank"):ns.page.go(i)}),ns.action.define("messages.deselect",function(){$(document).trigger("b-mail-dropdown-closeall"),ns.events.trigger("daria:vMessages:deselect")}),function(){function e(e){var s=e.find(".b-messages__attachments"),t=s.data("attachmentscount"),a={isShowAll:!1,showCount:0};if(s.is(":visible")){var i=s.find(".b-file");if(i.length){var o=i.first().position().top;i.each(function(){return $(this).position().top!==o?!1:void a.showCount++
})}a.isShowAll=a.showCount===t}return a}function s(){this.$dialogRoot=$(this.body).closest(".b-messages__attachments__popup"),this.checkPositionCollision(),this.delayedIndicatorTimer=setTimeout(function(){$(this.body).addClass("b-messages__attachments__popup__inner_empty")},200);var e={ids:this.mid};ns.request("message-body",e).then(function(){var s=ns.Model.get("message",e),t={mid:this.mid,ids:this.mid,sumSize:s.get(".size")||0,smallMode:this.inboxMessageState.isShowAll,swapFirst:this.inboxMessageState.showCount},a=Jane.tt("mail:messages-attachments-popup",t,["message-body"],e);
this.$body=$(a),this.$body.hasClass("js-no-attachments")&&Jane.ErrorLog.send({attach:"no-attach",mid:this.mid}),this.createNavigationState(),clearTimeout(this.delayedIndicatorTimer),this.previousDocumentSize={width:$(document).width(),height:$(document).height()},$(this.body).replaceWith(a),this.bindImageLoading(),this.checkPositionCollision(!0),this.shrinkFilenames(),this.bindEvents(),this.updateSlider();var i=this;Daria.setZeroTimeout(function(){i.$dialogRoot.css("background-color","white")})}.bind(this))
}function t(){var e=this.$body;this.navigation={common:{index:0,count:e.data("attachments-native-count"),$sliderBag:e.find(".js-attachments-native .b-messages__attachments__popup__inner__slider__bag"),$buttonLeft:e.find(".js-attachments-native .js-attachments-popup-left"),$buttonRight:e.find(".js-attachments-native .js-attachments-popup-right")},disk:{index:0,count:e.data("attachments-disk-count"),$sliderBag:e.find(".js-attachments-disk .b-messages__attachments__popup__inner__slider__bag"),$buttonLeft:e.find(".js-attachments-disk .js-attachments-popup-left"),$buttonRight:e.find(".js-attachments-disk .js-attachments-popup-right")}}
}function a(e){e&&(this.width=this.$dialogRoot.children(".b-popup__box").width(),Daria.Dialog.position());var s=$(document);null!=this.previousDocumentSize.height&&("bottom"!==this.onTarget.side&&(s.height()>this.previousDocumentSize.height&&"right"!==this.onTarget.side&&(this.onTarget.side="right",Daria.Dialog.position()),s.height()>this.previousDocumentSize.height&&(this.onTarget.side="bottom",Daria.Dialog.position())),this.previousDocumentSize.height=null),null!=this.previousDocumentSize.width&&(s.width()>this.previousDocumentSize.width&&(this.onTarget.pos="center",Daria.Dialog.position()),this.previousDocumentSize.width=null)
}function i(){var e=this;e.$body.on("click.attachments",".js-attachments-popup-left",function(){var s=e.navigation[$(this).closest(".js-attachments-native").length?"common":"disk"];s.index>0&&(e.logArrowClick("Назад"),s.index--,e.updateSlider())}).on("click.attachments",".js-attachments-popup-right",function(){var s=e.navigation[$(this).closest(".js-attachments-native").length?"common":"disk"];s.index<s.count-5&&(e.logArrowClick("Вперёд"),s.index++,e.updateSlider())}).on("click.attachments",".js-attachments-native .b-file",function(){Jane.c("Аттачи в списке писем","Баббл","Клик по превьюшке")
}).on("click.attachments",".js-attachments-disk .b-file",function(){Jane.c("Аттачи в списке писем","Баббл","Клик по превьюшке (Диск)")})}function o(){var e=this;$.each(["common","disk"],function(){var s=e.navigation[this];s.$sliderBag.css("left",-s.index*h),s.$buttonLeft.add(s.$buttonRight).removeClass("b-messages__attachments__popup__inner__button_disabled"),s.count<=5?s.$buttonRight.add(s.$buttonLeft).addClass("b-messages__attachments__popup__inner__button_disabled"):0===s.index?s.$buttonLeft.addClass("b-messages__attachments__popup__inner__button_disabled"):s.index===s.count-5&&s.$buttonRight.addClass("b-messages__attachments__popup__inner__button_disabled")
})}function n(){this.$body.find(".b-shrinker").each(function(){var e=$(this),s=e.find(".b-file__extension").width();e.css("margin-right",s)})}function r(){this.$body.find(".b-file__pic__image").not(".b-file__pic_player .b-file__pic__image").on("load.imgloader error.imgloader",function(e){$(this).off(".imgloader"),"load"===e.type&&d.call(this)})}function d(){var e;3*this.width>4*this.height?(this.height=54,e=54):(e=this.height*(72/(this.width||1)),this.width=72);var s=Math.round((e-54)/2);$(this).css("margin-top",-s).addClass("b-loaded")
}function l(){clearTimeout(this.delayedIndicatorTimer),$(this.body).off(".attachments")}var h=102;ns.action.define("messages.show-attachments",function(d,h,c,g){var m=h.mid;if(Daria.Dialog.isOpen()&&"inbox-attachments-popup"===Daria.Dialog.params.name&&Daria.Dialog.params.mid===m)return void Daria.Dialog.close();Jane.c("Аттачи в списке писем","Ссылка с количеством файлов","Клик");var u=$(g.currentTarget),p=u.closest(".b-messages__message");Daria.is2pane()?"Opera"===Jane.UA.BrowserName&&Jane.UA.BrowserVersion<=12.16||(u=u.add(u.find("span:visible, i:visible, a:visible")).last()):u=u.closest(".b-mail-dropdown");
var f=e(p);Daria.Dialog.open({name:"inbox-attachments-popup",body:$('<div class="b-messages__attachments__popup__inner_init">')[0],width:242,mid:m,onTarget:{target:u[0],side:"top",pos:Daria.is3pv()?"left":"right"},additionalClass:"b-messages__attachments__popup",inboxMessageState:f,previousDocumentSize:{width:$(document).width(),height:$(document).height()},logArrowClick:Jane.c.bind(Jane,"Аттачи в списке писем","Баббл","Клик по стрелочкам"),delayedIndicatorTimer:0,onopen:s,onclose:l,bindEvents:i,updateSlider:o,shrinkFilenames:n,checkPositionCollision:a,createNavigationState:t,bindImageLoading:r})
}),ns.action.define("messages.close-attachments",function(){Daria.Dialog.isOpen()&&Daria.Dialog.params&&"inbox-attachments-popup"===Daria.Dialog.params.name&&Daria.Dialog.close()}),ns.events.on("daria:vMessagesWrap:messages-scroll",_.throttle(function(){ns.action.run("messages.close-attachments")},50))}(),ns.action.define("table.check",function(e){var s=e.event,t=s.currentTarget,a=t.getElementsByClassName("b-messages__message__checkbox__input")[0];if(a){var i=e.params||{checked:!a.checked};return a.checked=i.checked,Daria.Table.active.check(s,a),!1
}}),function(){function e(){return{"messages-item-userpic-and-checkbox":{"messages-item-userpic":{},"messages-item-checkbox-wrap":{"messages-item-checkbox-box@":{}}}}}var s={messages:{},"messages-notification-box@":function(e){return e.search?"messages-notification-search":"messages-notification"},"messages-empty-wrap":{}},t={"messages-list":{"messages-list-box@":{"messages-wrap":s}}};Daria.is3pane()&&(t["messages-box@"]=function(e){var s={};return e.thread_id?s["message-thread&"]=function(){var e={"important-toggleable":{},"read-toggleable-thread":{},"message-thread-head-subject":{"message-thread-messages-count":{}},"message-thread-list":{},"message-fake-list":{},"thread-quick-reply":{}};
return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),e}:e.ids?(s.message={"message-head":function(){var e={"message-head-subject":{"message-head-date":{},"message-head-labels":{}},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"important-toggleable-head":{},"read-toggleable-head":{},"message-head-sender-wrap":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={}),e},"message-widget&":{},"message-toolbar&":{},"message-body&":{},"attachments-widget-body&":{},"3pane-scroller":{}},s["message-fake-list"]={}):s["message-empty"]={},s
}),Daria.is2pane()&&(t["messages-date-pager-float-box@"]=function(e){return e.showDatePager&&e.datePager&&"messages"===ns.page.current.page?{"messages-date-pager-float":!0}:void 0},t["inline-wizard-container"]={},t.footer={"footer-journal-link&":{},"footer-help-link":{}},s["messages-pager-box@"]=function(e){var s={"messages-pager-load-more":{}};return e.showDatePager&&(s["messages-pager-date&"]={},s["messages-pager-nav&"]={},s["messages-pager-search&"]={}),s["themes-messages-list-control@"]=function(){return"tanks"===ns.Model.get("settings").getSetting("color_scheme")?{"tanks-button-to-news-widget":{}}:{}
},{"messages-pager":s}}),ns.layout.define("search",{"app right-box@":{"messages-search-session":{},"search-suggest-box@":{"search-suggest":{"search-suggest-items-box@":function(){var e={"history-suggest&":{},"abook-suggest&":{},"search-filters":{}},s=ns.Model.get("settings").isSet("dont_save_history");return s&&delete e["history-suggest&"],e}}}},"app toolbar-box@":{},"app messages-direct-box@":{}},"common+left+toolbar"),ns.layout.define("messages",{"app right-box@":function(e){if(e.search){var s=_.cloneDeep(t);
return s["messages-search-session"]={},s}return t}},"common+left+toolbar"),ns.layout.define("layout-messages-item-thread",{"messages-item-inner-box@":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}}),ns.layout.define("layout-messages-item-thread-empty",{"messages-item-inner-box@":{}}),ns.layout.define("layout-message-thread-item",{"message-thread-item-box@":{"message-thread-item":function(){var e={"important-toggleable":{},"read-toggleable":{},"message-thread-item-userpic":{},"messages-item-labels":{}};
return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),e}}}),ns.layout.define("layout-message-thread-message",{"message-thread-item-box@":{message:{"message-head":function(){var e={"message-head-date":{},"message-head-labels":{},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"important-toggleable-head":{},"read-toggleable-head":{},"message-head-sender-wrap":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={}),e
},"message-toolbar":{},"message-widget&":{},"message-body&":{},"attachments-widget-body&":{}}}}),ns.layout.define("layout-messages-empty",{"messages-empty-box@":{}}),ns.layout.define("layout-messages-empty-view",{"messages-empty-box@":{"messages-empty":{}}}),ns.layout.define("layout-messages-item-checkbox",{"messages-item-checkbox-box@":{"messages-item-checkbox":{}}}),ns.layout.define("layout-messages-item-thread-checkbox",{"messages-item-checkbox-box@":{"messages-item-thread-checkbox":{}}}),ns.layout.define("layout-messages-item-checkbox-nb",{"messages-item-checkbox-box@":{"messages-item-checkbox-nb":{}}}),ns.layout.define("layout-messages-item-thread-checkbox-nb",{"messages-item-checkbox-box@":{"messages-item-thread-checkbox-nb":{}}}),ns.layout.define("layout-message-opened",{"messages-item-box@":{message:{"message-head":{"message-head-subject":function(){var e={"message-head-date":{},"message-head-labels":{},"message-thread-prev-next":{},"message-close-button":{}};
Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={});var s=ns.Model.get("message",ns.page.current.params);return"yes"!==ns.page.current.params.threaded||Daria.Widgets.shouldShowEvents(s)||delete e["message-thread-prev-next"],e},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"important-toggleable-head":{},"read-toggleable-head":{},"message-head-sender-wrap":{}},"message-widget&":{},"message-toolbar&":{},"message-body&":{},"attachments-widget-body&":{}},"message-fake-list":{}}}),function(){var s={};
Daria.Experiments.useMessagesItemMixins()||(s={"important-toggleable":{},"read-toggleable":{},"messages-item-userpic-and-checkbox-box@":e,"messages-item-labels":{},"messages-item-thread-expand":{}},Daria.showPriorityLabel()&&(s["priority-toggleable"]={})),ns.layout.define(Daria.messages.createMessagesItemLayout(),{"messages-item-box@":{"messages-item":s}}),ns.layout.define(Daria.messages.createMessagesItemLayout({threadInner:!0}),{"messages-item-box@":{"messages-item":s,"messages-item-inner":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}}})
}(),ns.layout.define(Daria.messages.createMessagesItemLayout({threadFull:!0}),{"messages-item-box@":{"message-thread&":function(){var e={"important-toggleable":{},"read-toggleable-thread":{},"message-thread-head-subject":{"message-thread-messages-count":{}},"message-thread-prev-next":{},"message-thread-pager":{},"message-thread-more-button":{},"message-close-button":{},"message-thread-list":{},"message-fake-list":{},"thread-quick-reply":{}};return Daria.showPriorityLabel()&&(e["priority-toggleable"]={}),e
}}}),function(){var s=["attachments","events","widget"];s.forEach(function(s){var t={},a={};Daria.Experiments.useMessagesItemMixins()||(a={"important-toggleable":{},"read-toggleable":{},"messages-item-userpic-and-checkbox-box@":e,"messages-item-labels":{}},Daria.showPriorityLabel()&&(a["priority-toggleable"]={})),"attachments"===s&&(a["attachments-widget-box@"]={"attachments-widget&":{}},Daria.Experiments.useMessagesItemMixins()||(a["messages-item-thread-expand"]={})),"events"!==s&&(Daria.Experiments.useMessagesItemMixins()||(a["messages-item-date"]={})),t["messages-item-"+s]=a;
var i=_.extend({},t,{"messages-item-inner":{"messages-item-thread&":{},"messages-item-thread-pager&":{}}});ns.layout.define(Daria.messages.createMessagesItemLayout({widget:s}),{"messages-item-box@":t}),ns.layout.define(Daria.messages.createMessagesItemLayout({widget:s,threadInner:!0}),{"messages-item-box@":i})})}()}(),ns.Model.define("save-event-by-ics",{params:{ids:null,hid:null,stid:null,decision:null}},"base-calendar-event"),ns.Model.define("message-type-labels",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){for(var e=[{type:2,label:"Регистрации"},{type:4,label:"Люди"},{type:5,label:"Билеты"},{type:6,label:"Интернет-покупки"},{type:7,label:"Сообщения"},{type:8,label:"Статус доставки писем"},{type:12,label:"Письма от Яндекса"},{type:13,label:"Новости"},{type:14,label:"Скидки"},{type:15,label:"Сайты знакомств"},{type:16,label:"Авиа"},{type:17,label:"Письма от банков"},{type:18,label:"Социальные сети"},{type:19,label:"Путешествия"},{type:20,label:"Ж/Д"},{type:21,label:"Недвижимость"},{type:22,label:"Уведомления"},{type:23,label:"Интернет-магазины"},{type:25,label:"Рекрутинговые сайты"},{type:26,label:"Игры"},{type:30,label:"Билеты в кино"},{type:35,label:"Гостиницы"}],s=[],t=0,a=e.length;a>t;t++)s.push(e[t].type);
this.setData({labels:e,knownTypes:s})}}},ns.ModelStatic),ns.Model.define("messages-sort",{events:{"ns-model-init":function(){this.setData({sort:[{type:"from",title:"по отправителю",order:[{type:"desc",title:"A → Z, А → Я"},{type:"asc",title:"Я → А, Z → A"}]},{type:"subject",title:"по теме",order:[{type:"desc",title:"A → Z, А → Я"},{type:"asc",title:"Я → А, Z → A"}]},{type:"date",title:"по дате",order:[{type:"desc",title:"сначала новые"},{type:"asc",title:"сначала старые"}]},{type:"size",title:"по размеру",order:[{type:"desc",title:"∞ → 1 КБ"},{type:"asc",title:"1 КБ → ∞"}]}]})
}}},ns.ModelStatic),ns.Model.define("get-link-app",{params:{app:"mail-wpv",lang:null,phone_full:null,remote_ip:null,personal_data:null}}),function(e){var s={};no.extend(s,e.PromiseHandlerMixin),s.getInfo=function(){return this._exec()},ns.Model.define("phone-debug")}(Jane),ns.Model.define("phone-delete",{params:{phoneid:null,number:null},methods:nb.extend({remove:function(e){if(!e)throw new ReferenceError("Required parameter phoneNumber is missing");return this._exec({number:e})},_checkSuccessResult:function(e){return/^(OK|STARTED)$/.test(e.status)?!0:void 0
}},Jane.PromiseHandlerMixin)}),ns.Model.define("phone-prolong",{params:{number:null},methods:no.extend({prolong:function(e){if(!e)throw new ReferenceError("Required parameter phoneNumber is undefined");var s=function(){return ns.Model.get("userphones").getPhone(e)};return this._exec({number:e}).then(s)},_checkSuccessResult:function(e){return"OK"===e.status?!0:void 0}},Jane.PromiseHandlerMixin)}),ns.Model.define("abook-suggest-proxy",{split:{items:".",params:{suggestId:".ref"},model_id:"abook-suggest-item"},methods:{request:function(e){return ns.request("abook-suggest",e).then(this._saveSuggest,null,this)
},_saveSuggest:function(e){var s=e[0];this.setData(s.get(".contacts"))},getData:function(){return this.data||[]}}},ns.ModelCollection),ns.Model.define("abook-suggest-item",{params:{suggestId:null}}),ns.Model.define("history-suggest-proxy",{split:{items:".",params:{suggestId:".text"},model_id:"history-suggest-item"},methods:{request:function(e){return ns.request("history-suggest",e).then(this._saveSuggest,null,this)},_saveSuggest:function(e){var s=e[0];this.setData(s.getData())},getData:function(){return this.data||[]
}}},ns.ModelCollection),ns.Model.define("history-suggest-item",{params:{suggestId:null}}),ns.Model.define("search-filters",{split:{items:".items",params:{type:".type"},model_id:"search-filters-item"},events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({items:[{type:"4",icon:"mail--Search-MailTypes-People",title:"Люди",desc:"Письма от людей"},{type:"18",icon:"mail--Search-MailTypes-Social",title:"Соцсети",desc:"Сообщения от ваших друзей"},{type:"5",icon:"mail--Search-MailTypes-Ticket",title:"Билеты",desc:"Ваши электронные билеты"},{type:"14",icon:"mail--Search-MailTypes-Sale",title:"Скидки",desc:"Письма от скидочных сервисов"},{type:"35",icon:"mail--Search-MailTypes-Hotel",title:"Гостиницы",desc:"Ваши брони гостиниц"}]})
}}},ns.ModelCollectionStatic),ns.Model.define("search-filters-item",{params:{type:null}},ns.ModelStatic),ns.Model.define("message-in-reply-to",{params:{mid:null}}),ns.Model.define("message-thread-toolbar",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null},ctor:function(){this.recalculateButtons=this.recalculateButtons.bind(this)},methods:{onBeforeDestroyed:function(){this._unbindModelEvents()},request:function(){return ns.request(["message"],{ids:this.params.ids}).then(this._bindModelEvents,this)
},_bindModelEvents:function(e){this.mMessage=_.find(e,"id","message"),this.mMessage.on("ns-model-changed",this.recalculateButtons),this.recalculateButtons()},_unbindModelEvents:function(){this.mMessage.off("ns-model-changed",this.recalculateButtons)},recalculateButtons:function(){var e=this.mMessage,s=ns.Model.get("all-toolbar-buttons"),t=s.getData(),a=[],i=e.inFolderBySymbol("archive"),o=e.isSpam(),n=e.isPinned(),r=e.getSOLabels(),d=_.contains(r,"12"),l=e.isNew();if(a.push(l?"mark-as-read":"mark-as-unread"),a.push("delete"),a.push(o||d?"not-spam":"spam"),d||a.push("forward"),i||a.push("archive"),a.push("folders-actions"),a.push("labels-actions"),e.isValidForPin()){var h=n?"unpin":"pin";
a.push(h)}var c=_.filterValuesContainingPropValue(t,"id",a);c.sort(function(e,s){return a.indexOf(e.id)>a.indexOf(s.id)?1:-1}),this.setData({buttons:c})}}}),ns.Model.define("messages-item-state",{events:{"ns-model-init":"_onInit"},params:function(e){var s=_.extend({},ns.page.current.params,e),t=ns.Model.getKeyAndParams("messages",s).params;return t.ids=e.ids,t},methods:{STATE:{CLOSE:"close",MESSAGE:"message",THREAD_SHORT:"thread_short",THREAD_FULL:"thread_list"},_onInit:function(){this.setData({state:this.STATE.CLOSE})
},destroy:function(){this.close()},setState:function(e){this.setIfChanged(".state",e)},getState:function(){return this.get(".state")},isClosed:function(){return this.get(".state")===this.STATE.CLOSE},close:function(){this.setState(this.STATE.CLOSE)}}},ns.ModelStatic),ns.Model.define("state-message-thread-list",{events:{"ns-model-init":"_onInit"},params:{thread_id:null},methods:{_onInit:function(){this.setData({HEIGHT_COMPACT_MESSAGE:29,countHiddenMessages:0,unloadedMessages:0,hiddenMessages:[],skipVisibilityCheck:!0,blockAutoMarkAsReadOnOpen:!0})
},getHiddenMessages:function(){return this.get(".hiddenMessages")},getCountHiddenMessages:function(){return this.get(".countHiddenMessages")},setHiddenMessages:function(e){this.set(".hiddenMessages",e),this.set(".countHiddenMessages",e.length)},resetHiddenMessages:function(){this.setHiddenMessages([])}}},ns.ModelStatic),ns.View.define("messages-item-labels",{models:{message:{"ns-model-changed":"keepValid","ns-model-changed.lid":"updateSelf"},labels:{"ns-model-changed":!1,"daria:mLabels:rename":"forceUpdate"}},yateModule:"messages",methods:{updateSelf:function(){this.forceUpdate()
}}}),ns.View.define("messages-item-labels-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed.lid":"forceUpdate"}),labels:ns.View.defineModelEvents({"daria:mLabels:rename":"forceUpdate"})}}),ns.View.edefine("messages-item-userpic",{events:{"click .js-message-snippet-userpic":"onUserpicClick"},models:{message:!1},yateModule:"messages",methods:{onUserpicClick:function(e){e.preventDefault(),e.stopPropagation(),this.logClickMessageFromSearch("avatar");var s=e.target.href;s&&ns.page.go(s)
}}},"messages-search-logger-mixin",ns.View),ns.View.define("messages-item-userpic-mixin",{events:{"click .js-message-snippet-userpic":"_messagesItemUserpicOnClick"},methods:{_messagesItemUserpicOnClick:function(e){e.preventDefault(),e.stopPropagation(),this.logClickMessageFromSearch("avatar");var s=e.target.href;s&&ns.page.go(s)}}}),ns.View.define("messages-item-checkbox",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","debug-last-checked-message":"debugLastCheckedMessage"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"}},events:{"ns-view-htmlinit":"onInit",click:"onClickCheckbox"},yateModule:"messages",methods:{onInit:function(){this.checkIfInCheckedThread()
},checkIfInCheckedThread:function(){var e=this.getModel("messages-checked"),s=this.getModel("message"),t=e.isCheckedByMid(s.getThreadId());t&&e.check(s,!0,{sendNotification:!1})},_getNodesToMarkChecked:function(){return this.$node.add(".js-messages-item-checkbox-visual",this.$node)},onClickCheckbox:function(){this.toggleChecked(),this.afterClickCheckbox()},afterClickCheckbox:_.noop,toggleChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.toggleCheck(e);var t=s.isChecked(e);
ns.events.trigger("daria:vMessagesItem:checked",this.$node,t,e)},onMessageCheckedToggle:function(e,s,t){if(!this.isVisible())return void this.invalidate();var a=this.getModel("message"),i=this.getModel("messages-checked"),o=i.isChecked(a);t===i.key&&(ns.events.trigger("daria:vMessagesItem:checked",this.$node,o,this.getModel("message")),this._setChecked({checked:o,force:!0}),this.afterMessageCheckedToggle(o,s))},afterMessageCheckedToggle:function(e,s){s=_.extend({sendNotification:!0},s),s.sendNotification&&this.sendThreadNotification(e)
},sendThreadNotification:function(e){var s=this.getModel("message"),t=ns.Model.get("message",{ids:s.get(".tid")});t.trigger("ns-model-child-check-toggle",e)},_setChecked:function(e){var s=this._getNodesToMarkChecked(),t={force:!1,checked:!1};e=_.extend(t,e),s.toggleClass("is-checked",e.checked)},onCheckedReset:function(){return this.isVisible()?void this._setChecked({checked:this.isChecked(),force:!0}):void this.invalidate()},debugLastCheckedMessage:function(e,s){return this.isVisible()?void(s?this.$node.closest(".mail-MessageSnippet-Wrap").css("boxShadow","inset 0 0 0 1px #F00"):this.$node.closest(".mail-MessageSnippet-Wrap").css("boxShadow","")):void this.invalidate()
},isChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");return s.isChecked(e)}}}),ns.View.define("messages-item-checkbox-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-checked-toggle":"_messagesItemCheckboxMessageCheckedToggle","debug-last-checked-message":"_messagesItemCheckboxDebugLastCheckedMessage"}),"messages-checked":ns.View.defineModelEvents({"ns-model-reset-checked":"_messagesItemCheckboxCheckedReset"})},events:{"ns-view-htmlinit":"_messagesItemCheckboxHtmlInit","click .js-messages-item-checkbox":"_messagesItemCheckboxClickCheckbox"},methods:{_messagesItemCheckboxHtmlInit:function(){var e=this.getModel("message"),s=this.getModel("messages-checked"),t=s.isCheckedByMid(e.getThreadId());
t&&s.check(e,!0,{sendNotification:!1})},_messagesItemCheckboxClickCheckbox:function(e){e.preventDefault(),Jane.c("клик на чекбокс в списке писем"),e.shiftKey||(this._messagesItemCheckboxToggleChecked(),this.afterClickMessagesItemCheckbox())},_messagesItemCheckboxCheckedReset:function(){return this.isVisible()?void this._messagesItemCheckboxSetChecked({checked:this.isChecked(),force:!0}):void this.invalidate()},_messagesItemCheckboxDebugLastCheckedMessage:function(e,s){return this.isVisible()?void(s?this.$node.closest(".mail-MessageSnippet-Wrap").css("boxShadow","inset 0 0 0 1px #F00"):this.$node.closest(".mail-MessageSnippet-Wrap").css("boxShadow","")):void this.invalidate()
},_messagesItemCheckboxMessageCheckedToggle:function(e,s,t){if(!this.isVisible())return void this.invalidate();var a=this.getModel("message"),i=this.getModel("messages-checked"),o=i.isChecked(a);t===i.key&&(ns.events.trigger("daria:vMessagesItem:checked",this.$node,o,this.getModel("message")),this._messagesItemCheckboxSetChecked({checked:o,force:!0}),this.afterCheckedToggleMessagesItemCheckbox(o,s))},_messagesItemCheckboxToggleChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");
s.toggleCheck(e);var t=s.isChecked(e);ns.events.trigger("daria:vMessagesItem:checked",this.$node,t,e)},_messagesItemCheckboxSetCheckedNative:function(e){var s=this.$node.find(".js-messages-item-checkbox-visual");e=_.extend({force:!1,checked:!1},e),s.toggleClass("is-checked",e.checked)},_messagesItemCheckboxSetCheckedNb:function(e){var s=nb.$block(".js-messages-item-checkbox-visual",this.node);s&&(e.checked?s.check():s.uncheck())},_messagesItemCheckboxSetChecked:function(e){var s=Daria.UISettings.shouldShowCheckboxInsideUserpic();
s?this._messagesItemCheckboxSetCheckedNative(e):this._messagesItemCheckboxSetCheckedNb(e)},messagesItemCheckboxAfterMessageCheckedToggle:function(e,s){if(s=_.extend({sendNotification:!0},s),s.sendNotification){var t=this.getModel("message"),a=ns.Model.get("message",{ids:t.get(".tid")});a.atrigger("ns-model-child-check-toggle",e)}}}}),ns.View.edefine("messages-item-checkbox-nb",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","debug-last-checked-message":"debugLastCheckedMessage"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"}},yateModule:"messages",methods:{_setChecked:function(e){var s=nb.$block(".nb-checkbox",this.node);
s&&(e.checked?s.check():s.uncheck())}}},"messages-item-checkbox"),ns.View.define("messages-item-thread-checkbox",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","ns-model-child-check-toggle":"onChildCheckToggle","debug-last-checked-message":"debugLastCheckedMessage"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"},"messages-item-state":!1,settings:!1},events:{click:"onClickCheckbox"},yateModule:"messages",methods:{afterClickCheckbox:function(){this.toggleManuallyCheckedState()
},toggleManuallyCheckedState:function(){var e=this.getModel("messages-checked").isChecked(this.getModel("message"));this.getModel("messages-item-state").set(".manuallyChecked",e)},afterMessageCheckedToggle:function(e,s){s=_.extend({affectChildren:!0},s),s.affectChildren&&this.affectChildren(e)},affectChildren:function(e){var s=this.getModel("message").getThreadMessages();this.changeChildrenCheckedState(e,s)},getActualMessagesCount:function(e,s,t){return 0!==e?e:t>s?s:t},changeChildrenCheckedState:function(e,s){var t=this.getModel("messages-checked"),a={sendNotification:!1};
s.models.forEach(function(s){t.check(s,e,a)})},onChildCheckToggle:function(){if(this.isVisible()){var e=this.getModel("message"),s=e.getThreadMessages(),t=this.getModel("messages-checked"),a={sendNotification:!1,affectChildren:!1},i=_.all(s.models,t.isChecked.bind(t));t.check(e,i,a)}}}},"messages-item-checkbox"),ns.View.define("messages-item-thread-checkbox-mixin",{models:{"messages-item-state":!1,message:ns.View.defineModelEvents({"ns-model-child-check-toggle":"_messagesItemThreadCheckboxChildCheckToggle"})},methods:{messagesItemThreadCheckboxAfterClick:function(){var e=this.getModel("messages-checked").isChecked(this.getModel("message"));
this.getModel("messages-item-state").set(".manuallyChecked",e)},messagesItemThreadCheckboxAfterMessageCheckedToggle:function(e,s){if(s=_.extend({affectChildren:!0},s),s.affectChildren){var t=this.getModel("message").getThreadMessages();this._messagesItemThreadCheckboxChangeChildrenCheckedState(e,t)}},_messagesItemThreadCheckboxChangeChildrenCheckedState:function(e,s){var t=this.getModel("messages-checked"),a={sendNotification:!1};s.models.forEach(function(s){t.check(s,e,a)})},_messagesItemThreadCheckboxChildCheckToggle:function(){if(this.isVisible()){var e=this.getModel("message");
if(e.isThreadModel()){var s=e.getThreadMessages(),t=this.getModel("messages-checked"),a={sendNotification:!1,affectChildren:!1},i=_.all(s.models,t.isChecked.bind(t));t.check(e,i,a)}}}}}),ns.View.edefine("messages-item-thread-checkbox-nb",{models:{message:{"ns-model-changed":!1,"ns-model-checked-toggle":"onMessageCheckedToggle","ns-model-child-check-toggle":"onChildCheckToggle","debug-last-checked-message":"debugLastCheckedMessage"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onCheckedReset"},"messages-item-state":!1,settings:!1},yateModule:"messages",methods:{_setChecked:function(e){var s=nb.$block(".nb-checkbox",this.node);
s&&(e.checked?s.check():s.uncheck())}}},"messages-item-thread-checkbox"),ns.View.edefine("messages-item-checkbox-wrap",{models:{message:!1,"messages-checked":!1},events:{"click .js-messages-item-checkbox-visual":"onCheckboxClick"},yateModule:"messages",methods:{patchLayout:function(){var e=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"":"-nb";return this.getModel("message").isThreadModel()?"layout-messages-item-thread-checkbox"+e:"layout-messages-item-checkbox"+e},isMessageChecked:function(){var e=this.getModel("messages-checked");
return e.isCheckedByMid(this.params.ids)},onCheckboxClick:function(e){e.preventDefault(),e.stopPropagation();var s=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"cbxavatar":"checkbox";this.isMessageChecked()&&this.logClickMessageFromSearch(s)}}},"messages-search-logger-mixin",ns.View),ns.View.defineNg("messages-item-checkbox-wrap-mixin",{models:{message:!1,"messages-checked":!1},events:{"click .js-messages-item-checkbox-visual":"_messagesItemCheckboxWrapCheckboxClick"},mixins:["messages-item-checkbox-mixin","messages-item-thread-checkbox-mixin"],methods:{_messagesItemCheckboxWrapCheckboxClick:function(){var e=this.getModel("messages-checked");
if(e.isCheckedByMid(this.params.ids)){var s=Daria.UISettings.shouldShowCheckboxInsideUserpic()?"cbxavatar":"checkbox";this.logClickMessageFromSearch(s)}},isChecked:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");return s.isChecked(e)},afterClickMessagesItemCheckbox:function(){this.getModel("message").isThreadModel()&&this.messagesItemThreadCheckboxAfterClick()},afterCheckedToggleMessagesItemCheckbox:function(e,s){this.getModel("message").isThreadModel()?this.messagesItemThreadCheckboxAfterMessageCheckedToggle(e,s):this.messagesItemCheckboxAfterMessageCheckedToggle(e,s)
}}}),ns.View.define("messages-item-userpic-and-checkbox",{models:{message:!1,"messages-checked":!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_checkbox_inside_userpic":"invalidate"}},yateModule:"messages"}),ns.View.defineNg("messages-item-userpic-and-checkbox-mixin",{models:{settings:ns.View.defineModelEvents({"ns-model-changed.show_checkbox_inside_userpic":"forceUpdate","ns-model-changed.messages_avatars":"invalidate"})},mixins:["messages-item-userpic-mixin","messages-item-checkbox-wrap-mixin"]}),ns.View.define("important-toggleable",{models:{labels:!1,message:{"ns-model-changed":!1,"ns-model-changed.lid":"_onMessageLidChange"}},params:function(e){return{ids:e.ids||e.thread_id}
},events:{click:"_onClick"},yateModule:"messages",methods:{_importantToggleableIsImportant:function(){return this.getModel("message").isImportant()},_onClick:function(e){e.stopPropagation(),e.preventDefault();var s=this._importantToggleableIsImportant()?"unlabel":"label",t=this.getModel("labels").getImportantLID(),a=this.getModel("message"),i=a.getMessagesCheckedModel(!0),o="label"===s?"отметить как важное":"снять отметку важное",n=$(e.currentTarget).hasClass("ns-view-important-toggleable-head");
Jane.c("Toolbar письма",n?"Письмо":Daria.Metric.getPath(a),o,"клик"),Daria.MOPS.updateHelper(s,i,t)},_onMessageLidChange:function(){this.$node.toggleClass("is-active",this._importantToggleableIsImportant())}}}),ns.View.define("important-toggleable-head",{models:{labels:!1,message:{"ns-model-changed":!1,"ns-model-changed.lid":"_onMessageLidChange"}},events:{click:"_onClick"},yateModule:"messages"},"important-toggleable"),ns.View.define("important-toggleable-mixin",{models:{labels:!1,message:!1},events:{"click .js-message-snippet-importance":"_onImportantToggleableClick"},yateModule:"messages",methods:{_importantToggleableIsImportant:function(){return this.getModel("message").isImportant()
},_onImportantToggleableClick:function(e){e.stopPropagation(),e.preventDefault();var s=this._importantToggleableIsImportant()?"unlabel":"label",t=this.getModel("labels").getImportantLID(),a=this.getModel("message"),i=a.getMessagesCheckedModel(!0),o="label"===s?"отметить как важное":"снять отметку важное";Jane.c("Toolbar письма","Письмо",o,"клик"),Daria.MOPS.updateHelper(s,i,t)}}}),function(){var e=null,s=_.debounce(function(){e&&e.close()},500);ns.View.define("priority-toggleable-mixin",{models:{labels:!1,message:ns.View.defineModelEvents({"ns-model-changed.lid":"onMessageLidChange"}),settings:!1},params:function(e){return{ids:e.ids||e.thread_id}
},ctor:function(){this.onDestroyedPopup=this.onDestroyedPopup.bind(this),this.onClosedPopup=this.onClosedPopup.bind(this),this.onPriorityToggleableUnlabel=this.onPriorityToggleableUnlabel.bind(this)},events:{"click .js-priority-toggleable":"onPriorityToggleableClick","mouseenter .js-priority-toggleable":"showPopup","mouseleave .js-priority-toggleable":"hidePopup"},yateModule:"messages",methods:{shouldShowPopup:function(){return Boolean(this.getModel("settings").getSign("show_priority_popup"))},setPriorityPopupSetting:function(e){this.getModel("settings").setSettings({show_priority_popup:e})
},showPopup:function(t){this.shouldShowPopup()&&(t.stopPropagation(),t.preventDefault(),s.cancel(),e&&(e.destroy(),e=null),e=nb.block(ns.renderNode({isPriorityLabel:this._priorityToggleableIsPriority()},"js-priority-popup","messages")),e.on("nb-destroyed",this.onDestroyedPopup),e.on("nb-closed",this.onClosedPopup),e.$node.on("mouseenter",s.cancel).on("mouseleave",s),e.open({withoutTail:!1,autofocus:!1,how:{my:"top",at:"bottom",collision:"fit flip"},animation:!0,where:$(".js-priority-toggleable-icon",this.$node)}))
},onPriorityToggleableUnlabel:function(e){e.stopPropagation(),e.preventDefault(),this._priorityToggleableIsPriority()&&this._onPriorityToggleableClick(e,"unlabel")},onPriorityToggleableClick:function(e){e.stopPropagation(),e.preventDefault();var s=this,t=this.getModel("labels").getPriorityLID();t?this._onPriorityToggleableClick(e):this.createPriorityLabel("hamon_label").then(function(t){t&&s._onPriorityToggleableClick(e)})},_onPriorityToggleableClick:function(e,s){this.shouldShowPopup()&&this.setPriorityPopupSetting(!1);
var t=s?s:this._priorityToggleableIsPriority()?"unlabel":"label",a=this.getModel("labels").getPriorityLID(),i=this.getModel("message"),o=i.getMessagesCheckedModel(!0),n=$(e.currentTarget).hasClass("js-priority-toggleable-head");Jane.c("Toolbar письма",n?"Письмо":Daria.Metric.getPath(i),("label"===t?"поставить":"снять")+" отметку приоритетное","клик"),Daria.MOPS.updateHelper(t,o,a)},createPriorityLabel:function(e){return ns.forcedRequest([{id:"do-labels-add-by-symbol",params:{symbol:e}},{id:"labels"}]).then(function(e){var s=e[0].get(".body.updated");
return s?s:null}).fail(function(e){return Jane.ErrorLog.send({type:"create-label-error",msg:e}),null})},hidePopup:function(){s()},onDestroyedPopup:function(){e=null},onClosedPopup:function(e,s){s.destroy()},_priorityToggleableIsPriority:function(){return this.getModel("message").isPriority()},onMessageLidChange:function(){this.$node.toggleClass("is-active",this._priorityToggleableIsPriority())}}})}(),ns.View.defineNg("priority-toggleable",{mixins:["priority-toggleable-mixin"],params:ns.View.info("priority-toggleable-mixin").params,yateModule:"messages"}),ns.View.defineNg("priority-toggleable-head",{mixins:["priority-toggleable-mixin"],params:ns.View.info("priority-toggleable-mixin").params,yateModule:"messages"}),ns.View.define("read-toggleable",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread","# toMute":"onStateToMute","# toUnmute":"onStateToUnmute"}},params:function(e){return{ids:e.ids||e.thread_id,type:"messages"}
},events:{"ns-view-init":"onInit",click:"onClick"},yateModule:"messages",methods:{TO_MUTE_TIMEOUT:2e3,onInit:function(){this.mReadMuteFsm=this.getModel("message-read-mute-fsm"),this.mMessage=this.getModel("message"),this.setStartState(),this.muteLabelLid=no.jpath(".lid",ns.Model.get("labels").getMuteThreadLabel()),this.canMute=Daria.IS_CORP||Daria.Config.pddDomain||Daria.Config.workspace},setStartState:function(){this.mReadMuteFsm.setInitialState(this.computeFsmModelState())},_readToggleableGetReadMuteFsmState:function(){return this.mReadMuteFsm.getState()
},computeFsmModelState:function(){var e="";return e=this.mMessage.isNew()?"toRead":this.mMessage.isMuted()?"toUnmute":"toUnread"},onClick:function(e){e.stopPropagation(),e.preventDefault();var s=this.mReadMuteFsm.getState(),t="toRead"===s?"отметить как прочитанное":"отметить как непрочитанное",a=$(e.currentTarget).hasClass("ns-view-read-toggleable-head");Jane.c("Toolbar письма",a?"Письмо":Daria.Metric.getPath(this.mMessage),t,"клик"),"toUnread"===s||"toRead"===s?this.mMessage.toggleMark():this.mMessage.toggleMute()
},toggleState:function(){var e,s=this.mReadMuteFsm.getState(),t=this.mMessage.isNew();switch(s){case"toRead":e=this.canMute&&this.mMessage.isMutable()?"toMute":"toUnread";break;case"toUnread":e=this.mMessage.isMuted()?"toUnmute":"toRead";break;case"toMute":e=t?"toRead":"toUnmute";break;case"toUnmute":e=t?"toRead":"toUnread"}this.mReadMuteFsm.setState(e)},onMessageChange:function(e,s){s||this.setStartState()},onMessageNewChange:function(){if(this.mMessage.isMuted())return void this.mMessage.toggleMute();
var e=this.mMessage.isThread(),s=this.mReadMuteFsm.getState();e&&"toRead"===s&&this.mMessage.isNew()||this.toggleState()},onMessageLidChange:function(e,s,t,a,i){var o=this.mMessage.isThread();if(o){var n=this.mMessage.hasLabelInDiff(this.muteLabelLid,i);n&&this.toggleState()}},onStateToRead:function(){this.unbindMuteShowTimeout(),this.forceUpdate()},onStateToUnread:function(){this.unbindMuteShowTimeout(),this.forceUpdate()},onStateToMute:function(){this.forceUpdate(),this.bindMuteShowTimeout()},onStateToUnmute:function(){this.unbindMuteShowTimeout(),this.forceUpdate()
},bindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId=_.delay(function(){this.unbindMuteShowTimeout(),this.$node&&(this.$node.is(":hover")?this.bindMuteShowTimeout():this.mReadMuteFsm.setState("toUnread"))}.bind(this),this.TO_MUTE_TIMEOUT)},unbindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId&&(window.clearTimeout(this.from_ToMute_to_Unread_timerId),this.from_ToMute_to_Unread_timerId=0)}}}),ns.View.edefine("read-toggleable-thread",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread","# toMute":"onStateToMute","# toUnmute":"onStateToUnmute"}},params:function(e){return{ids:e.ids||e.thread_id,type:"thread"}
},yateModule:"messages"},"read-toggleable"),ns.View.edefine("read-toggleable-head",{models:{message:{"ns-model-changed":"onMessageChange","ns-model-changed.new":"onMessageNewChange","ns-model-changed.lid":"onMessageLidChange"},"state-message-thread-item":!1,"message-read-mute-fsm":{"ns-model-changed":!1,"# toRead":"onStateToRead","# toUnread":"onStateToUnread"}},params:function(e){return{ids:e.ids,type:"message"}},yateModule:"messages"},"read-toggleable"),ns.View.define("read-toggleable-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed":"_readToggleableOnMessageChange","ns-model-changed.new":"_readToggleableOnMessageNewChange","ns-model-changed.lid":"_readToggleableOnMessageLidChange"}),"state-message-thread-item":!1},events:{"ns-view-init":"_readToggleableOnInit","ns-view-htmlinit":"_readToggleableOnHtmlInit","ns-view-htmldestroy":"_readToggleableOnHtmlDestroy","click .js-read-toggleable":"_readToggleableOnClick"},ctor:function(){this._readToggleableOnStateToRead=this._readToggleableOnStateToRead.bind(this),this._readToggleableOnStateToUnread=this._readToggleableOnStateToUnread.bind(this),this._readToggleableOnStateToMute=this._readToggleableOnStateToMute.bind(this),this._readToggleableOnStateToUnmute=this._readToggleableOnStateToUnmute.bind(this)
},methods:{_readToggleableGetReadMuteFsm:function(){return this._mReadMuteFsm||(this._mReadMuteFsm=this._readToggleableInitReadMuteFsm()),this._mReadMuteFsm},_readToggleableInitReadMuteFsm:function(){var e=ns.Model.get("message-read-mute-fsm",{ids:this.params.ids,type:"messages"});return e.on("# toRead",this._readToggleableOnStateToRead).on("# toUnread",this._readToggleableOnStateToUnread).on("# toMute",this._readToggleableOnStateToMute).on("# toUnmute",this._readToggleableOnStateToUnmute),e},_readToggleableDeinitReadMuteFsm:function(){this._mReadMuteFsm&&(this._mReadMuteFsm.off("# toRead",this._readToggleableOnStateToRead).off("# toUnread",this._readToggleableOnStateToUnread).off("# toMute",this._readToggleableOnStateToMute).off("# toUnmute",this._readToggleableOnStateToUnmute),this._mReadMuteFsm=null)
},TO_MUTE_TIMEOUT:2e3,_readToggleableOnInit:function(){this.setStartState()},_readToggleableOnHtmlInit:function(){this.$readToggleableNode=this.$node.find(".js-read-toggleable"),this.muteLabelLid=no.jpath(".lid",ns.Model.get("labels").getMuteThreadLabel()),this.canMute=Daria.IS_CORP||Daria.Config.pddDomain||Daria.Config.workspace,this._readToggleableGetReadMuteFsm()},_readToggleableOnHtmlDestroy:function(){this._readToggleableDeinitReadMuteFsm()},_readToggleableGetReadMuteFsmState:function(){return this._readToggleableGetReadMuteFsm().getState()
},setStartState:function(){this._readToggleableGetReadMuteFsm().setInitialState(this.computeFsmModelState())},computeFsmModelState:function(){var e="",s=this.getModel("message");return e=s.isNew()?"toRead":s.isMuted()?"toUnmute":"toUnread"},_readToggleableOnClick:function(e){e.stopPropagation(),e.preventDefault();var s=this._readToggleableGetReadMuteFsm().getState(),t="toRead"===s?"отметить как прочитанное":"отметить как непрочитанное";Jane.c("Toolbar письма","Письмо",t,"клик"),"toUnread"===s||"toRead"===s?this.getModel("message").toggleMark():this.getModel("message").toggleMute()
},toggleState:function(){var e,s=this._readToggleableGetReadMuteFsm().getState(),t=this.getModel("message"),a=t.isNew();switch(s){case"toRead":e=this.canMute&&t.isMutable()?"toMute":"toUnread";break;case"toUnread":e=t.isMuted()?"toUnmute":"toRead";break;case"toMute":e=a?"toRead":"toUnmute";break;case"toUnmute":e=a?"toRead":"toUnread"}this._readToggleableGetReadMuteFsm().setState(e)},_readToggleableOnMessageChange:function(e,s){s||this.setStartState()},_readToggleableOnMessageNewChange:function(){var e=this.getModel("message");
if(e.isMuted())return void e.toggleMute();var s=e.isThread(),t=this._readToggleableGetReadMuteFsm().getState();s&&"toRead"===t&&e.isNew()||this.toggleState()},_readToggleableOnMessageLidChange:function(e,s,t,a,i){var o=this.getModel("message"),n=o.isThread();if(n){var r=o.hasLabelInDiff(this.muteLabelLid,i);r&&this.toggleState()}},_readToggleableOnStateToRead:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()},_readToggleableOnStateToUnread:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()
},_readToggleableOnStateToMute:function(){this.invalidate(),this.forceUpdate(),this.bindMuteShowTimeout()},_readToggleableOnStateToUnmute:function(){this.unbindMuteShowTimeout(),this.invalidate(),this.forceUpdate()},bindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId=_.delay(function(){this.unbindMuteShowTimeout(),this.$readToggleableNode&&(this.$readToggleableNode.is(":hover")?this.bindMuteShowTimeout():this._readToggleableGetReadMuteFsm().setState("toUnread"))}.bind(this),this.TO_MUTE_TIMEOUT)
},unbindMuteShowTimeout:function(){this.from_ToMute_to_Unread_timerId&&(window.clearTimeout(this.from_ToMute_to_Unread_timerId),this.from_ToMute_to_Unread_timerId=0)}}}),function(){ns.View.define("message-empty",{events:{"ns-view-show":"onshow"},models:["settings"],yateModule:"messages",methods:{onshow:function(){var e=this.getModel("settings");e.getSetting("first_show_3pane")&&e.setSettings({first_show_3pane:""})}}})}(),ns.View.edefine("message-thread",{params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids,mid:e.thread_id||e.ids}
},models:{messages:{"ns-model-changed":"keepValid","ns-model-insert":"keepValid","ns-model-remove":"checkEmptyThread","ns-model-destroyed":"invalidate"},message:{"ns-model-changed":"_onMessageModelChange"},"messages-checked":{"run-action":"_runAction","ns-model-destroyed":"keepValid","ns-model-changed":"keepValid"},"module-message":!1,settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"lazyFixedRecalc","ns-model-changed.liza_minified_header":"lazyFixedRecalc"},"scroller-message":"keepValid","state-message-thread-list":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid","ns-model:expand-list":"onMessageThreadListExpand"}},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","hotkeys.alignOpenMessage":"onAlignOpenMessage","resize@show window":"_toggleTitleTogglerLazy","daria:MOPS:action-complete":"toggleMarkSubject","mouseenter .js-toolbar-subject":"onHoverSubjectOn","mouseleave .js-toolbar-subject":"onHoverSubjectOff"},ctor:function(){this._toggleTitleTogglerLazy=_.throttle(this._toggleTitleToggler.bind(this),20),this.recalculateHeaderFixedState=_.throttle(this.recalculateHeaderFixedState.bind(this),20,{trailing:!0,leading:!0})
},yateModule:"messages",methods:{LOAD_NEXT_PAGE_PADDING:100,CLASS_LONG_TITLE:"mail-Message-Toolbar_longTitle",fixedHeader:!1,onHtmlInit:function(){this._$toolbar=this.$node.find(".js-thread-toolbar"),this._$toolbarSubject=this.$node.find(".js-toolbar-subject"),this._toggleTitleToggler()},onShow:function(){this.checkEmptyThread()||(Daria.lom.save({current_folder:ns.page.current.params.current_folder,thread_id:this.params.thread_id}),this.fixedElementStart())},onHide:function(){this.fixedElementStop(),this.recalculateHeaderFixedState.cancel();
var e=this.getModel("messages-checked"),s=this.getModel("message");e.isChecked(s)||s.uncheckThreadMessages(e)},shouldHideThreadControls:function(){return 1===this.getModel("message").getThreadCount()},_onMessageModelChange:function(e,s){".new"===s&&this.toggleMarkSubject(),this.$node.find(" > .mail-Message-Toolbar_thread").toggleClass("mail-MessageThread_asMessage",this.shouldHideThreadControls())},_runAction:function(e,s){var t=s.params||{},a=t.mMessagesChecked||this.getModel("messages-checked");
return Daria.MOPS[s.action](a,t)},_toggleTitleToggler:function(){var e=this.initialHeight||this._$toolbarSubject[0].offsetHeight,s=this._$toolbarSubject[0].scrollHeight<=e;s||this.initialHeight||(this.initialHeight=this._$toolbarSubject[0].offsetHeight),this._$toolbarSubject.css("max-height",s?"":this._$toolbarSubject[0].scrollHeight),this._$toolbar.toggleClass(this.CLASS_LONG_TITLE,!s)},checkEmptyThread:function(){if(Daria.is2pane())return!1;var e=this.getModel("messages");if(e.isEmptyList()){var s=ns.page.current,t=s.params;
Daria.lom.deleteFid(t.current_folder);var a=_.clone(t);return delete a.thread_id,window.setTimeout(function(){ns.page.go(ns.router.generateUrl(s.page,a))},50),!0}return!1},onAlignOpenMessage:function(e,s){var t,a=ns.Model.get("focus"),i=a.getFocus();t=i&&"message-thread-item-wrap"===i.id&&i.isOpen()?i.node:this.node,s.scroller.scrollIntoView(t,s.alignOptions)},onMessageThreadListExpand:function(e,s){this.scrollAfterExpand(s.messageIndex,s.offset)},scrollAfterExpand:function(e,s){s=s||0;var t=this.getModel("scroller-message"),a=t.getScrollTop(),i=t.getNodeTop(this.node),o=this.getModel("state-message-thread-list"),n=o.get(".HEIGHT_COMPACT_MESSAGE")*e,r=a+n-s;
r=Math.max(r,i),t.setScrollTop(r)},toggleMarkSubject:function(){var e=this.getModel("message");this.$node.find(".js-toolbar-subject").toggleClass("is-unread",e.isNew())},onHoverSubjectOn:function(){this.$node.find(".js-mail-Message-Toolbar").addClass("with-subject-hovered")},onHoverSubjectOff:function(){this.$node.find(".js-mail-Message-Toolbar").removeClass("with-subject-hovered")},getFocusableChildren:function(){var e=this.getModel("messages"),s=[this];if(e.getCount()>1){var t=Daria.nsTreeWalker.findView(this,["message-thread-pager"]);
t&&t.shouldBeVisible()&&s.push(t);var a=Daria.nsTreeWalker.findView(this,["message-thread-list"]);s=s.concat(a.getFocusableChildren())}return s},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"space":this.toggleCheck();break;case"enter":ns.page.go(Jane.Page.generateUrl.closeMessage());break;case"print":this.print()}},print:function(){Daria.Printer.printThread(this.params.ids)},toggleCheck:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");
s.toggleCheck(e)},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}},"fixed-element-in-message-mixin"),ns.View.define("message-thread-head-subject",{models:{message:{"ns-model-changed":"keepValid","ns-model-changed.subject":"invalidate","ns-model-changed.subject_prefix":"invalidate"}},params:function(e){return{ids:e.ids||e.thread_id}},yateModule:"messages"}),ns.View.define("message-thread-expand",{events:{"click .js-expend-control":"onControlClick"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"updateCount"},"state-message-thread-list":{"ns-model-changed":"keepValid","ns-model-changed.countHiddenMessages":"updateControl","ns-model-destroyed":"keepValid"}},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}
},yateModule:"messages",methods:{SELECTOR_FOR_COUNT_MESSAGES:".js-expend-control-count",onControlClick:function(e){e.stopPropagation(),this.toggleExpand()},toggleExpand:function(){this.getModel("state-message-thread-list").toggleExpand()},updateControl:function(){var e=this.getModel("state-message-thread-list"),s=e.getCountHiddenMessages();this.$node.toggleClass("is-disabled",!e.mayExpand()).toggleClass("is-folded",0===s)},updateCount:function(){var e=this.getModel("message").getThreadCount();this.$node.find(this.SELECTOR_FOR_COUNT_MESSAGES).text(Jane.i18n.convert(["одно письмо",e+" письмо",e+" письма",e+" писем"],e))
},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":this.toggleExpand();break;case"space":this.toggleExpand()}},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}}),ns.View.define("message-thread-prev-next",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide",click:"onClick","click .js-open-prev-thread":"onOpenPrevThreadClick","click .js-open-next-thread":"onOpenNextThreadClick"},models:{message:!1},params:function(e){return{ids:e.ids||e.thread_id}
},yateModule:"messages",ctor:function(){this.updateArrowBlocksBound=this.updateArrowBlocks.bind(this)},methods:{onHtmlInit:function(){this.$prevArrow=this.$node.find(".js-open-prev-thread"),this.$nextArrow=this.$node.find(".js-open-next-thread")},onShow:function(){this.updateArrowBlocks();var e=this.getMessagesModel();e.on("ns-model-insert",this.updateArrowBlocksBound),e.on("ns-model-remove",this.updateArrowBlocksBound)},onHide:function(){var e=this.getMessagesModel();e.off("ns-model-insert",this.updateArrowBlocksBound),e.off("ns-model-remove",this.updateArrowBlocksBound)
},updateArrowBlocks:function(){this.$prevArrow.toggleClass("is-disabled",!this.canOpenThread("prev")),this.$nextArrow.toggleClass("is-disabled",!this.canOpenThread("next"))},onClick:function(e){e.stopPropagation()},onOpenPrevThreadClick:function(){this.openThreadForPosition("prev")},onOpenNextThreadClick:function(){this.openThreadForPosition("next")},getMessagesModel:function(){return this._mMessages||(this._mMessages=ns.Model.get("messages",ns.page.current.params)),this._mMessages},canOpenThread:function(e){var s=this.getModel("message").isPinned(),t=this.getMessagesModel(),a=t.getNearestMessageByMid(this.params.ids,e),i=a&&a.isPinned()===s;
return"next"===e?i||!a&&t.canLoadMore():i},openThreadForPosition:function(e){var s=this.getMessagesModel(),t=s.getNearestMessageByMid(this.params.ids,e);if("next"===e&&!t&&s.canLoadMore())return void s.loadMore().then(function(){if(this.canOpenThread("next")){t=s.getNearestMessageByMid(this.params.ids,e);var a=Jane.Page.generateUrl.contentMessage3pane(t.getData());ns.page.go(a)}else this.$nextArrow.toggleClass("is-disabled",!0)},this);if(t){var a=Jane.Page.generateUrl.contentMessage3pane(t.getData());
ns.page.go(a)}}}}),ns.View.define("message-thread-item",{params:function(e){return{ids:e.ids,mid:e.ids}},models:{message:{"ns-model-changed":!1,"ns-model-changed.new":"_onMessageNsModelChangedNew","ns-model-changed.lid":"_redraw"},"messages-checked":!1,"account-information":!1,folders:!1,labels:!0,settings:!1,"state-message-thread-item":{"ns-model-changed":!1,"ns-model-changed.isOpened":"invalidate","ns-model-changed.isFocused":"_onStateChangeFocus"}},events:{"ns-view-htmlinit":"_onNsViewHtmlinit","daria:vMessageThread:readUnreadToggle@show":"_onDariaToggleReadUnread","click .js-message-toggle":"_onClickMessageToggle","click .js-message-toggle .js-toggle-important":"_onClickToggleImportant"},yateModule:"messages",methods:{_onNsViewHtmlinit:function(){this.getModel("messages-checked").checkByMidInParams()
},openMessage:function(){var e=this.getModel("state-message-thread-item");e.setOpen(!0)},_redraw:function(){return this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},_onClickMessageToggle:function(e){var s=$(e.target),t=0!==s.closest(".js-skip-click-message-item").length;if(!t){e.stopPropagation();var a=this.getModel("state-message-thread-item");a.setOpen(!0);var i=this.getModel("message").isNew();i?Jane.c("Треды","клик по свернутому непрочитанному письму треда"):Jane.c("Треды","клик по свернутому прочитанному письму треда")
}},_onDariaToggleReadUnread:function(){this._toggleMark()},_onClickToggleImportant:function(e){e.stopPropagation(),this._toggleImportantLabel()},_toggleImportantLabel:function(){var e=this.getModel("message"),s=this.getModel("messages-checked"),t=ns.Model.get("labels").getImportantLID(),a=e.hasLabel(t)?"unlabel":"label";Daria.MOPS.updateHelper(a,s,{lid:t}).then(this._onSuccessToggleImportantLabel.bind(this,a))},_onSuccessToggleImportantLabel:function(e){var s=this.$node.find(".js-toggle-important");
s.toggleClass("b-ico_unimportant b-ico_important","label"!==e)},_onStateChangeFocus:function(){var e=this.getModel("state-message-thread-item"),s=e.get(".isFocused");this.$node.toggleClass("b-message_focus",s)},_onMessageNsModelChangedNew:function(){var e=this.$node.find(".js-message-toggle");e.length&&(this.getModel("message").isNew()?e.addClass("b-message_unread is-unread").removeClass("b-message_read"):e.removeClass("b-message_unread is-unread").addClass("b-message_read")),ns.events.trigger("daria:vMessageThreadItem:toggleMark")
},_toggleMark:function(){return this.getModel("message").toggleMark()}}}),ns.View.edefine("message-thread-item-wrap",{events:{"ns-view-hide":"_onNsViewHide","ns-view-touch":"onTouch","click .js-close-message":"close","ns-view-show":"_onNsViewShow"},models:{message:!1,"messages-checked":"keepValid","state-message-thread-item":{"ns-model-changed":"keepValid","ns-model-changed.isOpened":"_onItemOpenToggle","ns-model-changed.isVisible":"_onStateChangeVisible","ns-model-destroyed":"keepValid"}},yateModule:"messages",methods:{SEEN_TIMEOUT:500,LOADER_TIMEOUT:200,_timerMarkRead:null,_timerBeforeLoader:null,patchLayout:function(){var e=this.getModel("state-message-thread-item");
return e.isOpen()?"layout-message-thread-message":"layout-message-thread-item"},onTouch:function(){this.removeStateLoading()},_onNsViewShow:function(){this._onItemOpenToggle();var e=this.getModel("state-message-thread-item");e.set(".didRendered",!0)},_onNsViewHide:function(){this._clearReadTimer(),this._clearLoaderTimer(),this.closeSilently()},removeStateLoading:function(){this.$node.removeClass("is-loading")},closeSilently:function(){this.getModel("state-message-thread-item").destroy()},lazyMarkAsRead:function(){var e=this.getModel("state-message-thread-item");
e.get(".forceMark")&&this._setReadTimerCallback(),e.set(".forceMark",!1)},_onItemOpenToggle:function(){var e=this.getModel("state-message-thread-item");e.isOpen()&&(this._timerBeforeLoader=setTimeout(function(){this.$node.addClass("is-loading")}.bind(this),this.LOADER_TIMEOUT)),this.$node.toggleClass("is-opened",e.isOpen()),this.update()},_onStateChangeVisible:function(){this._clearReadTimer();var e=ns.Model.get("state-message-thread-list",{thread_id:this.getModel("message").get(".tid")}).get(".blockAutoMarkAsReadOnOpen"),s=this.getModel("state-message-thread-item");
Daria.is3pane()&&e?s.get(".isVisible")&&s.set(".forceMark",!0):this._setReadTimer()},_setReadTimer:function(){var e=this.getModel("message").get(".mid");if(!Daria.lom.isLastOpen(e)){var s=this.getModel("state-message-thread-item"),t=s.get(".isVisible"),a=s.get(".isIgnoreMarkRead");t&&!a&&(this._timerMarkRead=window.setTimeout(this._setReadTimerCallback.bind(this),this.SEEN_TIMEOUT))}},_setReadTimerCallback:function(){var e=this.getModel("state-message-thread-item").get(".isIgnoreMarkRead"),s=this.getModel("message").isNew();
!e&&s&&(this.getModel("message").toggleMark(),ns.events.trigger("daria:vMessageThreadList:checkVisible"))},_clearReadTimer:function(){window.clearTimeout(this._timerMarkRead)},_clearLoaderTimer:function(){clearTimeout(this._timerBeforeLoader)},isOpen:function(){return this.getModel("state-message-thread-item").isOpen()},open:function(){var e=this.getModel("message").isNew();e?Jane.c("Треды","клик по свернутому непрочитанному письму треда"):Jane.c("Треды","клик по свернутому прочитанному письму треда"),this.getModel("state-message-thread-item").setOpen(!0)
},close:function(){this.getModel("state-message-thread-item").setOpen(!1)},toggleCheck:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.toggleCheck(e)},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":this.open();break;case"print":this.print()}},print:function(){this.isOpen()&&Daria.Printer.printMessage(this.params.ids)},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")
}}},"message-dimensions-mixin",ns.View),ns.View.define("message-thread-item-userpic",{models:{message:!1},yateModule:"messages"}),ns.View.define("first-user-scroll-mixin",{methods:{_subscribeFirstUserScroll:function(){this._subscribeFirstUserScrollTimeout=null,ns.events.on("daria:vScrollerMessage:scroll",this._onFirstUserScroll)},_unsubscribeFirstUserScroll:function(){clearTimeout(this._subscribeFirstUserScrollTimeout),ns.events.off("daria:vScrollerMessage:scroll",this._onFirstUserScroll)},_onFirstUserScroll:function(){this.getModel("state-message-thread-list").set(".blockAutoMarkAsReadOnOpen",!1),this.forEachItem(function(e){e.lazyMarkAsRead()
}),this._unsubscribeFirstUserScroll()}}}),ns.ViewCollection.edefine("message-thread-list",{events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-show":"_onNsViewShow","ns-view-hide":"_onNsViewHide","daria:vMessageThreadList:showMore@show":"_onMessagesLoad","daria:vMessageThreadList:expandUnread@show":"onExpandUnreadClick","daria:vMessageThreadList:checkVisible@show":"_checkVisibleMessages","daria:vMessageThreadList:scrollToNextUnread":"onScrollToNextUnread","daria:vScrollerMessage:scroll":"onScrollChanged","daria:layout-changed":"onScrollChanged","layout-ratio-change@show":"toLoadMore"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"_onMessageCountChanged"},messages:{"ns-model-changed":"_onMessagesChanged","ns-model-remove":"_onMessagesNsModelRemove","ns-model-insert":"_onMessagesNsModelInsert"},"scroller-message":"keepValid","state-message-thread-list":{"ns-model-changed":"keepValid","ns-model-destroyed":"keepValid"}},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}
},split:{byModel:"messages",intoViews:function(){return this._openMessages(),"message-thread-item-wrap"}},ctor:function(){this._promiseMessagesLoad=null,this._checkVisibleMessages=_.throttle(this._checkVisibleMessages.bind(this),50),this._checkMessageOpenState=this._checkMessageOpenState.bind(this),this._onFirstUserScroll=this._onFirstUserScroll.bind(this),this._subscribeFirstUserScroll=this._subscribeFirstUserScroll.bind(this),this._afterLoadMoreOnShow=this._afterLoadMoreOnShow.bind(this),this.MESSAGE_TOP_BORDER_VISIBLE=70
},yateModule:"messages",methods:{HEIGHT_LOADER_BLOCK:37,LOAD_NEXT_PAGE_PADDING:100,COUNT_MESSAGES_BEFORE_OPEN_MESSAGE:3,_promiseMessagesLoad:null,_blockMessageAutoOpen:!1,_subscribeFirstUserScrollTimeout:null,_openMessages:function(){if(!this._blockMessageAutoOpen){var e=this._getOpenedMessages(),s=this.params.thread_id;this.getModel("state-message-thread-list").set(".blockAutoMarkAsReadOnOpen",Daria.lom.isLastOpen(s)),e.forEach(function(e){this._setMessageOpenState(e,!0)},this),this._blockMessageAutoOpen=!0
}},_getOpenedMessages:function(){var e=this.getModel("messages");if(Daria.is3pane()){var s=e.getUnreads();if(s.length>0)return s}var t,a=ns.Model.get("folders"),i=ns.page.current.params.current_folder,o=a.isFolder(i,["sent","outbox"]);return t=o?_.find(e.models,function(e){return e.isOutcomeMessage()}):_.find(e.models,function(e){return!e.isDraftLike()}),t||(t=e.models[0]),[t]},_setMessageOpenState:function(e,s,t){var a=_.extend({},this.params,{ids:e.get(".mid")});"undefined"==typeof t&&(t=!0);var i=ns.Model.get("state-message-thread-item",a);
i.setOpen(s,t)},_checkMessageOpenState:function(e){var s=_.extend({},this.params,{ids:e.get(".mid")}),t=ns.Model.get("state-message-thread-item",s);return t.isOpen()},_onNsViewHtmlinit:function(){this._$document=$(document),this.mStateMessageThreadList=this.getModel("state-message-thread-list")},_afterLoadMoreOnShow:function(e){"prevent-init"!==e&&(this.getModel("state-message-thread-list").set(".skipVisibilityCheck","cache-invalidation"===e),ns.events.atrigger("daria:vMessageThreadList:checkVisible"),this._unsubscribeFirstUserScroll(),this._subscribeFirstUserScrollTimeout=_.defer(this._subscribeFirstUserScroll))
},_onNsViewShow:function(){this.getModel("scroller-message").init(),Daria.is3pane()?this.scrollToFirstOpenMessage():this._hideFirstPartMessages(),ns.events.trigger("daria:mFocus:buildTree"),this._loadMorePromise=this.toLoadMore().then(this._detectCacheInvalidation).then(this._afterLoadMoreOnShow,this._afterLoadMoreOnShow)},_onNsViewHide:function(){this.mStateMessageThreadList.destroy(),this._blockMessageAutoOpen=!1,this.__keepScroll=null,this.getModel("state-message-thread-list").set(".blockAutoMarkAsReadOnOpen",!0),this.getModel("state-message-thread-list").set(".skipVisibilityCheck",!0),this._loadMorePromise.isResolved()||(this._loadMorePromise.reject("prevent-init"),this._loadMorePromise=null),this._unsubscribeFirstUserScroll(),ns.events.trigger("daria:mFocus:buildTree")
},scrollToFirstOpenMessage:function(){var e=_.last(this._getOpenedMessages());if(e){var s=this.getModel("scroller-message"),t=this.getModel("state-message-thread-list"),a=this.getItemByModel(e),i=2*t.get(".HEIGHT_COMPACT_MESSAGE"),o=a.getDimensions(!1).top-s.getScrollOffset()-i;s.setScrollTop(o)}},_hideFirstPartMessages:function(){var e=this.getModel("messages"),s=e.models,t=this._getOpenedMessages(),a=s.indexOf(t[0]),i=0,o=[],n=s.length-1;return 2>=n-a?void this.mStateMessageThreadList.setHiddenMessages(o):(s.forEach(function(e,s){if(!(a+1>=s)){var t=this.getItemByModel(e);
t&&(i++,t.$node&&(t.$node.addClass("is-hidden"),o.push(t)))}},this),void this.mStateMessageThreadList.setHiddenMessages(o))},showMessages:function(){this.forEachValidItem(function(e){e.$node.removeClass("is-hidden")}),this.mStateMessageThreadList.resetHiddenMessages(),ns.events.trigger("daria:mFocus:buildTree")},_onMessagesLoad:function(){var e=this.getModel("messages"),s=e.canLoadMore(),t=this.mStateMessageThreadList.getCountHiddenMessages();if(t){this.showMessages();var a=s?0:this.HEIGHT_LOADER_BLOCK;
return this.mStateMessageThreadList.trigger("ns-model:expand-list",{messageIndex:t,offset:a}),vow.resolve()}return this._promiseMessagesLoad&&!this._promiseMessagesLoad.isResolved()?this._promiseMessagesLoad:s?(this._promiseMessagesLoad=e.loadMore(!0),this._promiseMessagesLoad.then(function(){this.mStateMessageThreadList.resetHiddenMessages()}.bind(this)),this._promiseMessagesLoad):vow.reject()},_checkVisibleMessages:function(){var e=this.$node.find(".js-body-loading").length>0;if(!e&&!this.getModel("state-message-thread-list").get(".skipVisibilityCheck")){var s=this.getModel("scroller-message"),t=s.getVDimensions();
t.bottom-=this.MESSAGE_TOP_BORDER_VISIBLE;var a=0;this.forEachValidItem(function(e){var s=e.getModel("state-message-thread-item"),i=e.getModel("message");if(i.isNew()&&s.get(".isOpened")){var o=e.isVisibleInScroller(t,!0);s.setVisible(o),o&&a++}}),ns.events.trigger("daria:vMessageThreadGo2unread:visibleUnreadMessages",a)}},onScrollChanged:function(){this.isVisible()&&this.isValid()&&(this._checkVisibleMessages(),this.toLoadMore())},onExpandUnreadClick:function(){this.expandUnreadMessages(),this._scrollToNearestUnread(!0)
},expandUnreadMessages:function(){var e=this.getModel("messages").getUnreads();e.forEach(function(e){this._setMessageOpenState(e,!0,!1)},this),this.showMessages()},onScrollToNextUnread:function(){this._scrollToNearestUnread()},_scrollToNearestUnread:function(e){var s,t,a,i=this.getModel("messages"),o=i.models,n=o.length,r=this.getModel("scroller-message"),d=r.getScrollTop(),l=r.getScrollOffset();if(2>n)return void r.setScrollTop(0);for(;n--;)if(s=o[n],s.isNew()){var h=this.getItemByModel(s);if(!h)continue;
if(!a&&(a=h,e))break;var c=h.getDimensions(!1);if(c.top-l>d){t=h;break}}if(t||(t=a||this.getItemByModel(o[0])),t){var g=t.getDimensions(!1),m=i.canLoadMore(),u=m?0:this.HEIGHT_LOADER_BLOCK;r.setScrollTop(g.top-l-u,!0)}else 0===d&&r.setScrollTop(1e5)},_onMessageCountChanged:function(){this.keepValid(),this.toLoadMore()},_onMessagesChanged:function(){this.keepValid(),this.toLoadMore()},_onMessagesNsModelRemove:function(){this.updateIfVisible()},_onMessagesNsModelInsert:function(e,s){var t=s[0],a=_.extend({},this.params,{ids:t.get(".mid")}),i={qrIds:this.params.ids},o=ns.Model.get("state-message-thread-item",a),n=ns.Model.get("quick-reply-state",i),r=this,d=t.get(".mid")===this.getModel("messages").models[0].get(".mid");
d?(this._unsubscribeFirstUserScroll(),this.getModel("state-message-thread-list").set(".blockAutoMarkAsReadOnOpen",!0),this._subscribeFirstUserScrollTimeout=_.defer(r._subscribeFirstUserScroll)):o.once("ns-model-changed.didRendered",function(){r._unsubscribeFirstUserScroll(),r.mStateMessageThreadList.trigger("ns-model:expand-list",{messageIndex:s.length}),_.defer(function(){r.getModel("state-message-thread-list").set(".skipVisibilityCheck",!1),r._checkVisibleMessages()}),r._subscribeFirstUserScrollTimeout=_.defer(r._subscribeFirstUserScroll)
}),Daria.is3pane()&&!n.isVisible()&&this.expandUnreadMessages(),this.updateIfVisible()},_detectCacheInvalidation:function(){return vow.resolve("cache-invalidation")},updateIfVisible:function(){this.forceUpdate()},toLoadMore:function(){if(Daria.is2pane())return vow.reject();var e=this.getModel("scroller-message"),s=e.getScrollTop();return s>=this.LOAD_NEXT_PAGE_PADDING?vow.reject():this._onMessagesLoad()},getFocusableChildren:function(){var e=this.getModel("state-message-thread-list"),s=e.get(".hiddenMessages"),t=[];
return this.forEachValidItem(function(e){_.includes(s,e)||t.push(e)}),t.reverse()}}},"first-user-scroll-mixin",ns.ViewCollection),ns.View.define("message-thread-pager",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-message-thread-pager-loadMore":"onLoadMoreClick","click .js-message-thread-pager-expandUnread":"onExpandUnreadClick"},models:{message:!1,messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"updateCountersDebounce","ns-model-remove":"updateCountersDebounce"},"state-message-thread-list":{"ns-model-changed":!1,"ns-model-changed.countHiddenMessages":"updateCountersDebounce","ns-model-destroyed":"keepValid"}},params:function(e){return{ids:e.thread_id||e.ids,thread_id:e.thread_id||e.ids}
},ctor:function(){this.updateCountersDebounce=_.debounce(this.updateCounters.bind(this),50)},yateModule:"messages",methods:{NODE_CLASS:"mail-MessageThread-Pager",LOAD_MESSAGES_QUANTITY:30,onMessagesChanged:function(e,s){".new"===s.jpath&&this.updateCountersDebounce()},onHtmlInit:function(){this.$pagerLoadMore=this.$node.find(".js-message-thread-pager-loadMore"),this.$pagerExpandUnread=this.$node.find(".js-message-thread-pager-expandUnread");var e=Daria.uidEnds([5,6,7,8,9]);e&&this.$node.addClass(this.NODE_CLASS+"_inverted-controls")
},onShow:function(){this.updateCountersDebounce()},onHide:function(){this.updateCountersDebounce.cancel()},updateCounters:function(){this.toggleVisible();var e=this.getModel("message"),s=this.getModel("messages"),t=this.getModel("state-message-thread-list"),a=e.getThreadCount()-s.getCount(),i=t.getCountHiddenMessages(),o=s.getUnreads().length,n=i||Math.min(a,this.LOAD_MESSAGES_QUANTITY),r=o>0;this.$node.toggleClass(this.NODE_CLASS+"_withUnread",r),this.shouldBeVisible()&&(Jane.c("Треды",'показ кнопки "показать N писем"'),r&&Jane.c("Треды",'показ кнопки "перейти к непрочитанным"')),this.setTextInCounters(n,o)
},setTextInCounters:function(e,s){this.$pagerLoadMore.html("открыть список писем"),this.$pagerExpandUnread.html("развернуть "+Jane.i18n.convert([s+" непрочитанное",s+" непрочитанных",s+" непрочитанных"],s))},onLoadMoreClick:function(){Jane.c("Треды",'клик по кнопке "показать N писем"'),ns.events.trigger("daria:vMessageThreadList:showMore")},onExpandUnreadClick:function(){Jane.c("Треды",'клик по кнопке "перейти к непрочитанным"'),ns.events.trigger("daria:vMessageThreadList:expandUnread")},shouldBeVisible:function(){var e=this.getModel("state-message-thread-list"),s=this.getModel("messages").canLoadMore(),t=e.getCountHiddenMessages();
return!(!t&&!s)},toggleVisible:function(){this.$node.toggleClass("is-hidden",!this.shouldBeVisible())},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":this.onLoadMoreClick()}},focusOn:function(){this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")}}}),ns.View.define("message-thread-more-button",{events:{"click .js-toolbar-item-more":"onMoreButtonClick"},models:{"message-thread-toolbar":!0},yateModule:"messages",methods:{onMoreButtonClick:function(e){return e.stopPropagation(),this.vPopup&&this.vPopup.isValid()?(this.vPopup.closePopup(),void(this.vPopup=null)):(this.vPopup=ns.View.create("message-thread-toolbar-popup",this.params),void this.vPopup.open({where:e.currentTarget}))
},closePopup:function(){this.vPopup&&this.vPopup.closePopup()}}}),ns.View.define("message-thread-messages-count",{models:{message:!0,"messages-checked":!0},params:function(e){return{ids:e.thread_id||e.ids}},yateModule:"messages",methods:{showMessagesCount:function(){return this.getModel("message").getThreadCount()}}}),ns.View.define("message-thread-reply-all",{events:{click:"onReplyAllThreadButton","ns-view-show":"onRefresh","daria:vMessageThreadReplyAll:replyAll":"onReplyAllHotkey"},models:{messages:{"ns-model-changed":!1,"ns-mode-insert":"onRefresh","ns-model-remove":"onRefresh"}},params:function(e){return{thread_id:e.thread_id||e.ids}
},yateModule:"messages",ctor:function(){this.onQuickReplyFormVisibilityChanged=this.onQuickReplyFormVisibilityChanged.bind(this),this.onRefresh=_.debounce(this.onRefresh.bind(this),20)},methods:{onRefresh:function(){this.reinitLastMessage()},showView:function(){Jane.c("Просмотр письма","Ответить всем внизу","показ"),this.$node.removeClass("is-hidden")},hideView:function(){this.$node.addClass("is-hidden")},reinitLastMessage:function(){var e,s=this.getModel("messages").getLastReplyMessage();s&&s.get(".mid")&&!$(".thread-item-"+s.get(".mid")).hasClass("is-hidden")&&(e=s.get(".mid"));
var t=this.lastMid;if(t===e)return void(e||this.hideView());if(t){var a=this.getQuickReplyState(t);a&&a.off("ns-model-changed.formIsShown",this.onQuickReplyFormVisibilityChanged)}if(e){var i=this.getQuickReplyState(e);i.on("ns-model-changed.formIsShown",this.onQuickReplyFormVisibilityChanged)}this.lastMid=e,this.onQuickReplyFormVisibilityChanged()},onQuickReplyFormVisibilityChanged:function(){if(!this.lastMid)return void this.hideView();var e=this.getQuickReplyState(this.lastMid);e.isVisible()?this.hideView():this.showView()
},getQuickReplyState:function(e){return ns.Model.get("quick-reply-state",{qrIds:e})},getStateMessageThreadItem:function(e){return ns.Model.get("state-message-thread-item",{ids:e})},onReplyAllThreadButton:function(){this.openQuickReply(),Jane.c("Просмотр письма","Ответить всем внизу","клик")},onReplyAllHotkey:function(){this.openQuickReply()},openQuickReply:function(){var e=this.lastMid;if(e){var s=this.getQuickReplyState(e),t=this.getStateMessageThreadItem(e);s.isVisible()?(ns.Model.get("compose-state",{ids:e,oper:"reply-all"}).setFocusField("send"),s.placeInViewport()):t.isOpen()?s.showForm():(s.set(".forceShow",!0),t.setOpen(!0))
}}}},"message-actions"),ns.View.define("message-thread-toolbar-popup",{events:{"click .js-toolbar-item-forward":"_onForwardToolbarButton","click .js-toolbar-item-delete":"_onRemoveToolbarButton","click .js-toolbar-item-spam":"_onTospamToolbarButton","click .js-toolbar-item-not-spam":"_onNotspamToolbarButton","click .js-toolbar-item-archive":"_onArchiveToolbarButton","click .js-toolbar-item-labels-actions":"_openLabelsDropdown","click .js-toolbar-item-folders-actions":"_openFoldersDropdown","click .js-toolbar-item-pin":"_onPinToolbarButton","click .js-toolbar-item-unpin":"_onUnpinToolbarButton","click .js-toolbar-item-mark-as-read":"_onReadToolbarButton","click .js-toolbar-item-mark-as-unread":"_onUnreadToolbarButton","click .js-kbd-print":"_onPrintToolbarButton"},models:{"message-thread-toolbar":!0,message:!0,"messages-checked":!1},params:function(e){return{mid:e.ids,ids:e.ids}
},yateModule:"messages",methods:{open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))},this)},closePopup:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},_onForwardToolbarButton:function(){Jane.ToolbarMetric.messageThreadToolbar("переслать"),this.closePopup();
var e={mMessagesChecked:this.getMessagesCheckedInstance()};ns.action.run("forward",e)},_onRemoveToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("удалить"),this._onToolbarButton("remove")},_onTospamToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("спам"),this._onToolbarButton("tospam")},_onNotspamToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("не спам"),this._onToolbarButton("notspam")},_onArchiveToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("архивировать"),this._onToolbarButton("archive")
},_onPinToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("закрепить"),this._onToolbarButton("pin")},_onUnpinToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("открепить"),this._onToolbarButton("unpin")},_onReadToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("прочитано"),this._onToolbarButton("mark")},_onUnreadToolbarButton:function(){return Jane.ToolbarMetric.messageThreadToolbar("не прочитано"),this._onToolbarButton("unmark")},_openLabelsDropdown:function(e){var s=ns.action.getParams(e.currentTarget);
Jane.ToolbarMetric.setToolbarMetrics(e,s,"label"),this._openDropdown("labels",e)},_openFoldersDropdown:function(e){var s=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,s,"move"),this._openDropdown("folders",e)},_onToolbarButton:function(e,s){s=s||{},this.closePopup();var t=s.mMessagesChecked||this.getMessagesCheckedInstance();return Daria.MOPS[e](t,s)},getMessagesCheckedInstance:function(){return this._mMessagesChecked=ns.Model.get("messages-checked",{mid:this.params.ids}).checkByMidInParams(),this._mMessagesChecked
},_openDropdown:function(e,s){var t=$(s.currentTarget);if(!t.hasClass("js-open-dropdown")){var a=ns.View.create(e+"-actions"),i=this.getMessagesCheckedInstance();a.open(s.currentTarget,i,{isInDropdown:!0,isInMore:!0}).then(function(){t.addClass("js-open-dropdown"),a.nbPopup.on("nb-closed",function(){t.removeClass("js-open-dropdown")})})}},_onPrintToolbarButton:function(e){var s=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,s,"print")}}}),ns.View.define("messages-date-pager-float",{models:{"messages-pager":!1,folders:!1,settings:!1,messages:!1,"scroller-messages":!1},"params-":["datePager"],events:{"ns-view-htmlinit":function(){Daria.setZeroTimeout(function(){this.pager=new Daria.MessagesPager(this.node,!0)
}.bind(this))},"ns-view-htmldestroy":function(){this.pager&&this.pager.unbindEvents(),delete this.pager},"ns-view-show":function(){this.pager&&this.pager.updateScroll(this.params),this.getModel("scroller-messages").init(),this.isHidden=!0,this.$node.addClass("block-messages-date-pager-float-box_hidden"),this._updateVisibility()},"ns-view-hide":function(){this.isHidden=!0,this.$node.addClass("block-messages-date-pager-float-box_hidden")},"daria:vScrollerMessages:scroll":"_updateVisibility","daria:layout-changed":"_updateVisibility","messages-date-pager.updateVisibility@show":"_updateVisibility"},yateModule:"messages",methods:{patchTree:function(){var e=this.super_.patchTree.call(this),s=this.getModel("messages-pager").getCountMonth();
return e.isEmptyMessages=this.getModel("messages").isEmptyList(),e.hasSlider=s>5&&!this.params.pager_top||s>13&&this.params.pager_top,e},_updateVisibility:function(){var e=!1,s=ns.page.current.params,t=this.getModel("scroller-messages");this.$node.rect().top<t.getHeight()+150&&(e=!0,s.datePager&&!s.search&&ns.events.trigger("daria:vMessagesWrap:messages-scroll-load")),e!==this.isHidden&&(this.isHidden=e,this.$node.toggleClass("block-messages-date-pager-float-box_hidden",e))}}}),ns.View.define("messages-empty",{events:{"click .js-open-search-options SPAN":"openSearchOptions","click .js-label-filter-empty-list":"onClickLabelFilterEmptyList"},models:{filters:!0,messages:!1},yateModule:"messages",methods:{openSearchOptions:function(){ns.events.trigger("search.toggle-search-options",!0)
},onClickLabelFilterEmptyList:function(){var e=this,s=this.params.current_label;s&&(Jane.c(["Промо меток","Писем с такой меткой нет","клик по ставить метку автоматически"]),Jane.Services.load("#setup",function(){Daria.Label.createFilter(s).then(function(){e.forceUpdate()})}))}}}),ns.View.define("messages-empty-wrap",{events:{"ns-view-htmlinit":"onHtmlInit"},models:{messages:"onMessagesChange"},yateModule:"messages",methods:{patchLayout:function(){var e=this.getModel("messages");return e.isEmptyList()?"layout-messages-empty-view":"layout-messages-empty"
},onHtmlInit:function(){var e=this.getModel("messages");this._isEmptyList=e.isEmptyList()},onMessagesChange:function(){var e=this.getModel("messages"),s=e.isEmptyList();s!==this._isEmptyList&&(this._isEmptyList=s,this.forceUpdate())}}}),ns.View.define("messages-item-thread-toggle-mixin",{methods:{toggleThread:function(){var e=this.getModel("messages-item-state"),s=e.STATE,t=e.getState();e.setState(t===s.THREAD_SHORT?s.CLOSE:s.THREAD_SHORT)}}}),ns.View.edefine("messages-item-thread-expand",{events:{click:"onClickThreadToggle"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-remove":"keepValid"},"messages-item-state":{"ns-model-changed":"onChangeState"}},yateModule:"messages",methods:{onChangeState:function(){var e=this.getModel("messages-item-state");
this.$node.toggleClass("is-folded",e.getState()===e.STATE.CLOSE)},onClickThreadToggle:function(e){e.preventDefault(),e.stopPropagation(),this.toggleThread()}}},"messages-item-thread-toggle-mixin",ns.View),ns.View.define("messages-item-thread-expand-mixin",{models:{message:ns.View.defineModelEvents({"ns-model-changed.count":"forceUpdate","ns-model-changed.firstline":"forceUpdate"}),"messages-item-state":ns.View.defineModelEvents({"ns-model-changed":"_messagesItemThreadExpandMixinChangeState"})},events:{"click .js-thread-toggle":"_messagesItemThreadExpandMixinOnClickThreadToggle"},yateModule:"messages",methods:{_messagesItemThreadExpandMixinOnClickThreadToggle:function(e){e.preventDefault(),e.stopPropagation(),this.toggleThread()
},_messagesItemThreadExpandMixinChangeState:function(){var e=this.getModel("messages-item-state");this.$node.find(".js-thread-toggle").toggleClass("is-folded",e.getState()===e.STATE.CLOSE)}}},"messages-item-thread-toggle-mixin",ns.View),function(){var e=["messages-search-logger-mixin","messages-item-thread-toggle-mixin"];Daria.Experiments.useMessagesItemMixins()&&(e=["messages-search-logger-mixin","messages-item-thread-toggle-mixin","messages-item-labels-mixin","messages-item-thread-expand-mixin","important-toggleable-mixin","priority-toggleable-mixin","messages-item-userpic-and-checkbox-mixin","read-toggleable-mixin"]),ns.View.defineNg("messages-item",{models:{message:ns.View.defineModelEvents({"ns-model-changed.count":"forceUpdate","ns-model-changed.field":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-changed.flags":"forceUpdate","ns-model-changed.lid":"forceUpdate","ns-model-changed.new":"_onToggleMark","ns-model-changed.subject":"forceUpdate"}),"messages-checked":!1,"messages-item-state":!1,settings:ns.View.defineModelEvents({"ns-model-changed.enable_firstline":"forceUpdate","ns-model-changed.show_priority_label":"forceUpdate"})},params:{ids:null},events:{"ns-view-init":"onInit","daria:vMessagesItem:removeFocus":"removeFocus","click .js-go-to-replied-message":"_goToRepliedMessage",click:"onClick","click .js-show-attachments":"_showAttachments","ns-page-before-load@show":"onPageBeforeLoad"},mixins:e,yateModule:"messages",methods:{timerID:null,delayBeforeOpen:500,onInit:function(){this._messageId=this.params.ids
},onPageBeforeLoad:function(e,s,t){t!==ns.page.currentUrl&&this.clearTimer()},_onToggleMark:function(){this.getSnippetNode().toggleClass("is-unread",this.getModel("message").isNew())},getSnippetNode:function(){return this.$node.find(".mail-MessageSnippet").eq(0)},onClick:function(e){if(e.shiftKey)return(new Daria.CBS).selectWithShift(this.params.ids),!1;if(Daria.isLeftClickWithCtrl(e)||Daria.isMiddleButton(e))return!0;var s=$(e.target),t=0!==s.closest(".js-skip-click-message-item").length;return t?!0:(Daria.is2pane()&&e.preventDefault(),void this.openMessage())
},openMessage:function(){if(this.logClickMessageFromSearch("mail"),!Daria.is3pane()){var e,s=this.getModel("message"),t=ns.Model.get("settings").isSet("open-message-list");if(e=t?Jane.Page.generateUrl.contentMessage3pane(s.getData()):Jane.Page.generateUrl.contentMessage2pane(s.getData()),t){var a=this.getModel("messages-item-state");a.close()}s.getThreadCount()>1&&Jane.c("Треды","открытие треда из списка писем"),s.getThreadCount()>1&&!t?this.toggleThread():ns.page.go(e),this.logOpenMessage&&this.logOpenMessage()
}},switchOpen:function(){if(Daria.is2pane())return void this.openMessage();var e=this.getModel("message");if(e.getThreadCount()<=1)return void this.openMessage();var s=this.getModel("messages-item-state"),t=s.isClosed();t?s.setState(s.STATE.THREAD_SHORT):s.close()},_goToRepliedMessage:function(){return ns.request(["message-in-reply-to"],{mid:this.params.ids}).then(function(e){var s=e[0].get(".mid");if(s){var t=ns.router.generateUrl("message",{ids:s});ns.page.go(t)}}),!1},_showAttachments:function(e){e.preventDefault(),e.stopPropagation(),ns.View.create("attachments-widget-popup",this.params).showAt(e.currentTarget)
},_widgetUpdate:function(){var e=new Vow.Promise;if(this.isValid())e.reject("VALID_VIEW");else{var s=this;_.defer(function(){e.sync(s.update(null,{execFlag:ns.U.EXEC.PARALLEL}))})}return e},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn(e.preventOpenOnFocus);break;case"blur":this.focusOff();break;case"space":this.toggleCheck();break;case"enter":this.switchOpen()}},focusOn:function(e){this.$node.addClass("is-focused");var s=this.getModel("message").get(".mid");if(e&&!Daria.lom.isLastOpen(s)){var t=_.clone(ns.page.current.params);
delete t.ids,delete t.thread_id,Daria.lom.deleteFid(t.current_folder),ns.page.go(ns.router.generateUrl("messages",t))}else this.startOpenMessage()},focusOff:function(){return this.clearTimer(),Daria.is3pane()&&1!==ns.Model.get("focus").getIndexCurrentColumn()?void this.startOpenMessage(!0):void this.removeFocus()},removeFocus:function(){this.$node.removeClass("is-focused")},getParentReferenceParams:function(){var e=ns.Model.get("message",{ids:this._messageId}).getThreadMessage();return e&&ns.Model.get("messages-item-state",{ids:e.getThreadId()}).isClosed()?{params:{ids:e.getThreadId()}}:void 0
},toggleCheck:function(){var e=this.getModel("message"),s=this.getModel("messages-checked");s.toggleCheck(e)},startOpenMessage:function(e){var s=ns.page.current.params;Daria.is2pane()||ns.Model.get("folders").isFolder(s.current_folder,["draft","template"])||this.params.ids!==s.thread_id&&this.params.ids!==s.ids&&(this.clearTimer(),e?this.openMessage3pane():this.timerID=setTimeout(this.openMessage3pane.bind(this),this.delayBeforeOpen))},openMessage3pane:function(){var e=_.clone(ns.page.current.params),s=this.getModel("message").isThread();
s?(e.thread_id=this.params.ids,delete e.ids):(e.ids=this.params.ids,delete e.thread_id),this.params.ids!==ns.page.current.params.thread_id&&this.params.ids!==ns.page.current.params.ids&&ns.page.go(ns.router.generateUrl("messages",e))},clearTimer:function(){clearTimeout(this.timerID),this.timerID=null},hasFocus:function(){return ns.Model.get("focus").getFocus()===this}}})}(),ns.View.define("messages-item-date",{yateModule:"messages",models:{message:{"ns-model-changed":"keepValid","ns-model-changed.date":"forceUpdate","ns-model-changed.fid":"forceUpdate"},folders:{"ns-model-changed":!1,"daria:mFolders:rename":"forceUpdate"}}}),ns.View.defineNg("messages-item-attachments",{yateModule:"messages"},"messages-item"),ns.View.defineNg("messages-item-events",{models:{labels:!1,message:ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"}),"messages-item-state":ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"}),"message-widget-events":ns.View.defineModelEvents({"ns-model-changed":"forceUpdate"})},events:{"ns-view-show":"onWidgetEventsShow","click .js-widget-events-accept":"acceptEvent","click .js-widget-events-decline":"declineEvent","click .js-widget-events-edit":"editEvent","click .js-toggles-WidgetEventsPopup_more":"closeAllPopups","click .js-widget-events-user":"onWidgetEventsUserClick"},yateModule:"messages",ctor:function(){this.sendShowLog=_.once(this.sendLogs.bind(this,"show"))
},methods:{_LOG_OPTIONS:{show:{metrik:"show"},accepted:{metrik:["click","bth-go"],actionLogButton:!0},declined:{metrik:["click","btn-reject"],actionLogButton:!0},"see-calendar-link":{metrik:["click","btn-see-calendar-link"],actionLogButton:!0},clickMore:{metrik:["click","more"],actionLogButton:!0},mail:{metrik:["click","mail"],actionLogButton:!0}},_NAME_POPUP_USER_LIST:"widget-event-dropdown-",onWidgetEventsShow:function(){this.nbPopup=nb.find(this._NAME_POPUP_USER_LIST+this.params.ids),this.sendShowLog()
},changeEvent:function(e){nb.trigger("popup-close");var s=ns.Model.get("message-body",{ids:this.params.ids}),t=s.getCalendarICS(),a=s.get(".info.stid"),i={decision:e,hid:t,stid:a,ids:this.params.ids};ns.request(["save-event-by-ics"],i).then(this._changeEventRequest,this)},_changeEventRequest:function(e){if("ok"===e[0].status){var s=e[0]&&e[0].getEventInfo();if(!s)return;this.updateEventInfo(s);var t=this.getModel("message");t.isNew()&&t.toggleMark()}},updateEventInfo:function(e){this.getModel("message-widget-events").setEventInfo(e)
},acceptEvent:function(e){e.preventDefault(),e.stopPropagation(),this.changeEvent("accepted"),this.sendLogs("accepted")},declineEvent:function(e){e.preventDefault(),e.stopPropagation(),this.changeEvent("declined"),this.sendLogs("declined")},editEvent:function(){this.sendLogs("see-calendar-link")},closeAllPopups:function(){this.nbPopup.isOpen()||this.sendLogs("clickMore"),nb.trigger("popup-close")},sendLogs:function(e){var s=this.getModel("message-widget-events");s.get(".eventInfo")&&(this.sendMetrik(e),this.sendActionLog(e))
},sendMetrik:function(e){var s=this.getMetrikName(),t=this._LOG_OPTIONS[e].metrik;Jane.c(["Widgets","ICS",s].concat(t))},getMetrikName:function(){var e=this.getModel("message-widget-events");return e.get(".isOutdated")||!e.get(".isNotPast")?"ICS Outdated Inbox Widget":e.get(".eventInfo.isCancelled")?"ICS Cancel Inbox Widget":"event_update"===e.get(".eventInfo.calendarMailType")?"ICS Update Inbox Widget":"ICS Full Inbox Widget"},sendActionLog:function(e){var s=this.getModel("message-widget-events"),t="show"===e,a=t?"widget-show":"click-widget-btn",i=this._LOG_OPTIONS[e].actionLogButton,o={action:a,widget:"ics","widget-type":this.getActionType(),ids:{ids:[this.params.ids]}};
t&&!s.get(".eventInfo.isCancelled")&&(o["widget-controls"]=this.getWidgetControlsList()),i&&(o.btn=e),Daria.actionLog(a,o)},getWidgetControlsList:function(){var e=this.getModel("message-widget-events"),s=e.get(".eventInfo.actions")||[],t=[];return-1!==s.indexOf("accept")&&t.push("btn-accept"),-1!==s.indexOf("decline")&&t.push("btn-decline"),e.get(".isNotOperate")||t.push("btn-see-calendar-link"),e.get(".isOutdated")||!e.get(".isNotPast")||e.get(".eventInfo.isCancelled")||t.push("btn-clickMore"),t
},getActionType:function(){var e=this.getModel("message-widget-events");return e.get(".isOutdated")||!e.get(".isNotPast")?"ics-outdated":e.get(".eventInfo.isCancelled")?"ics-cancel":"event_update"===e.get(".eventInfo.calendarMailType")?"ics-update":"ics-full"},logOpenMessage:function(){this.sendLogs("mail")},onWidgetEventsUserClick:function(e){e.stopPropagation()}}},"messages-item"),ns.View.define("messages-item-inner",{params:{ids:null},yateModule:"messages",methods:{}}),ns.ViewCollection.define("messages-item-thread",{params:function(e){return{thread_id:e.ids}
},split:{byModel:"messages",intoViews:"messages-item-wrap"},models:{messages:{"ns-model-changed":"keepValid","ns-model-remove":"checkCountAndUpdate","ns-model-insert":"forceUpdate"},"messages-checked":{"ns-model-changed":!1,"daria:mMessagesChecked:load-more-messages":"loadMoreMessages"}},events:{"ns-view-show":"_onShow","ns-view-hide":"_onHide","daria:vMessagesItemThread:loadMoreMessages@show":"_loadMoreMessages"},yateModule:"messages",methods:{_onShow:function(){ns.events.trigger("daria:mFocus:buildTree")
},_onHide:function(){ns.events.trigger("daria:mFocus:buildTree")},loadMoreMessages:function(){var e=this.getModel("messages");e.canLoadMore()&&e.loadMore()},_loadMoreMessages:function(){if(this.__lockMessagesLoad)return!1;this.__lockMessagesLoad=!0;var e=this.getModel("messages").canLoadMore(),s=function(e){this.update().then(function(){this.isChecked()&&this.changeChildrenCheckedState(!0,e)},this).always(function(){this.__lockMessagesLoad=!1},this)}.bind(this);return e?this.getModel("messages").loadMore().then(s,function(){this.__lockMessagesLoad=!1
},this):this.node.querySelector(".ns-view-container-desc").childNodes.length!==this.getModel("messages").models.length&&(this.invalidate(),s()),!1},isChecked:function(){return this.getModel("messages-checked").isChecked(this.getModel("message"))},checkCountAndUpdate:function(){if(!this.isVisible())return void this.forceUpdate();var e=this.getModel("messages");1===e.getCount()?ns.page.go(Jane.Page.generateUrl.closeMessage()):this.forceUpdate()},getFocusableChildren:function(){var e=[];return this.forEachValidItem(function(s){e=e.concat(s.getFocusableChildren())
}),e}}}),ns.View.define("messages-item-thread-pager",{params:function(e){return{ids:e.ids,thread_id:e.ids}},models:{message:!1,messages:{"ns-model-changed":"updateIfVisible","ns-model-remove":"updateIfVisible","ns-model-insert":"updateIfVisible"}},events:{"ns-view-htmlinit":"onHtmlInit","click .js-messages-load-more":"loadMoreMessages"},yateModule:"messages",methods:{_canLoadMore:!1,onHtmlInit:function(){this._canLoadMore=this.canLoadMore()},canLoadMore:function(){return this.getModel("messages").canLoadMore()
},loadMoreMessages:function(){ns.events.trigger("daria:vMessagesItemThread:loadMoreMessages")},updateIfVisible:function(){var e=this.canLoadMore();e!==this._canLoadMore&&(this._canLoadMore=e,this.forceUpdate())}}}),ns.View.defineNg("messages-item-widget",{models:{message:ns.View.defineModelEvents({"ns-model-changed.field":"forceUpdate","ns-model-changed.firstline":"forceUpdate","ns-model-changed.flags":"forceUpdate","ns-model-changed.lid":"toggleImportantClass","ns-model-changed.new":"_onToggleMark","ns-model-changed.subject":"forceUpdate"}),"messages-checked":!1,"messages-item-state":!1,settings:!1},events:{"daria:vMessagesItem:removeFocus":"removeFocus",click:"onClick","click .js-print-widget-button":"onClickPrint","click .js-delete-widget-button":"onClickDelete","click .js-compose-widget-button":"onClickCompose"},yateModule:"messages",methods:{onClickPrint:function(e){this.onClickControl(e),Daria.Printer.printMessage(this.params.ids)
},onClickDelete:function(e){this.onClickControl(e),Daria.MOPS.remove(this.getModel("message").getMessagesCheckedModel())},onClickCompose:function(e){this.onClickControl(e);var s=this.getModel("message").get('.widget.controls[.type == "compose"].attributes.mid')[0];if(s){var t={ids:s,oper:"template"};ns.request("message",{ids:s}).then(function(){this.createCustomTemplate(t)},this).fail(function(){Jane.ErrorLog.send({type:"widget-bounce-compose-no-message",mid:s}),this.openMessage()},this)}},createCustomTemplate:function(e){ns.request("compose-message",e).then(function(s){var t=s[0];
this._createCustomTemplate(t,e)},this).fail(function(){Jane.ErrorLog.send({type:"widget-bounce-compose-no-compose-message",mid:e.ids})})},_createCustomTemplate:function(e,s){ns.page.go(ns.router.generateUrl("compose2",s)).then(function(){var t,a=e.mMessage,i=e.mMessageBody,o=e.mComposeState,n=a.getSubject(),r=e._getMessageType(),d=i.getSubtype();t="plain"===d?Daria.Html2Text.html2text(i.getDraftBody(r)):i.getDraftBody(r);var l=i.getAddressField("to"),h=i.getAddressField("cc"),c=i.getAddressField("bcc"),g=i.getAddressField("phone"),m=_.clone(a.get(".lid")),u=a.getDelayedTime();
if(!u){var p=ns.Model.get("labels").getDelayedMessageLabel();p&&(m=_.pull(m,p.lid))}var f=[{jpath:".overwrite",value:s.ids},{jpath:".ign_overwrite",value:"yes"},{jpath:".save_symbol",value:"draft"},{jpath:".ttype",value:r},{jpath:".lids",value:m},{jpath:".from_name",value:a.getFromName()},{jpath:".from_mailbox",value:a.getFromEmail()},{jpath:".inreplyto",value:i.getInReplyTo()},{jpath:".references",value:i.getReferences()},{jpath:".current_folder",value:a.getFolderId()},{jpath:".send_time",value:u}];
n&&f.push({jpath:".subj",value:n}),l&&f.push({jpath:".to",value:l},{jpath:".initial_to",value:l}),h&&(f.push({jpath:".cc",value:h},{jpath:".initial_cc",value:h}),o.setIfChanged(".isCcVisible",!0)),c&&(f.push({jpath:".bcc",value:c}),o.setIfChanged(".isBccVisible",!0)),g&&(f.push({jpath:".phone",value:g}),o.setIfChanged(".isPhoneVisible",!0)),t&&f.push({jpath:".send",value:t}),_.forEach(f,function(s){e.set(s.jpath,s.value)}),o.setFocusField("send")})},onClickControl:function(e){e.preventDefault()},metrikaWidgets:function(e){e=yr.nodeset2data(e)||{};
var s=this.getModel("message",{ids:this.params.ids}).get(".widget"),t=s.info,a=t.type;t.valid||(a="Протухший "+t.type);var i=["Виджеты",a,t.subtype];return e.label&&i.push(e.label),i.push(e.isClick?"клик":"показ"),e.metrikaParam?i=i.join(":"):void Jane.c(i)}}},"messages-item"),ns.View.edefine("messages-item-wrap",{events:{"click .js-messagesItem-toggle-opened":"onClickCloseMessage","click .js-mail-Message-Body_close_letter":"onClickCloseMessage"},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.count":"onMessageCountChanged","ns-model-changed.lid":"onMessageLidChanged","ns-model-checked-toggle":"onToggleCheck"},"messages-item-state":{"ns-model-changed":"keepValid","ns-model-changed.state":"onItemStateChanged"},"messages-checked":{"ns-model-changed":!1,"ns-model-reset-checked":"onToggleCheck"}},yateModule:"messages","params+":{current_folder:null,search:null,scope:null,extra_cond:null},methods:{REG_EXP_FOR_TREE_WALKER:/^messages-item(-attachments|-events|-widget)?$/,patchLayout:function(){var e=this.getModel("message"),s=e.get(".widget");
s&&this.writeLogForWidgets("exists",{mid:this.params.ids,widgetType:s.info.type,widgetSubType:s.info.subtype,origin:"list-widget"});var t=Daria.Widgets.getWidgetName(e);"widget"===t&&s&&this.writeLogForWidgets("view",{mid:this.params.ids,widgetType:s.info.type,widgetSubType:s.info.subtype,origin:"list-widget"});var a={};if(Daria.is3pane())return a.threadInner=this.isThreadListOpen(),Daria.messages.createMessagesItemLayout(a);var i=ns.page.current.params;return this.params.ids===i.thread_id?(ns.events.trigger("daria:vMessagesItemWrap:message-opened"),Daria.messages.createMessagesItemLayout({threadFull:!0})):this.params.ids===i.ids?(ns.events.trigger("daria:vMessagesItemWrap:message-opened"),"layout-message-opened"):Daria.messages.createMessagesItemLayout(t?{widget:t}:Daria.Widgets.shouldShowAttachments(e,ns.page.current.params)?{threadInner:this.isThreadListOpen(),widget:"attachments"}:e.isThread()?{threadInner:this.isThreadListOpen()}:{})
},onMessageCountChanged:function(){this.getModel("messages-checked").trigger("daria:mMessagesChecked:load-more-messages")},isThreadListOpen:function(){var e=this.getModel("messages-item-state"),s=e.STATE;return e.getState()===s.THREAD_SHORT},isSearchTopResult:function(){return this.getModel("messages-checked").isSearchTopResultByMid(this.getModel("message").get(".mid"))},onToggleCheck:function(){var e=this.getModel("message"),s=this.getModel("messages-checked"),t=s.isChecked(e);this.$node.toggleClass("is-checked",t)
},onMessageLidChanged:function(){var e=this.getModel("message"),s=e.isPinned()&&Daria.messages.checkUsePinsByParams(this.params);this.$node.toggleClass("is-pinned",s)},onItemStateChanged:function(){this.lazyUpdate(),this.getModel("messages-item-state").isClosed()&&this.uncheckMessagesInThread()},onClickCloseMessage:function(e){if(!this.isSubjectSelected()){var s=$(e.target);if(!s.closest(".js-skip-click-messages-item-wrap").length&&!s.closest(".js-skip-click-message-item").length){e.preventDefault(),e.stopPropagation();
var t=this.getModel("message").getThreadCount();s.closest(".js-message-close-button").length?(Jane.c("Закрытие письма кликом в шапку в 2pane","Закрытие по крестику"),t>1&&Jane.c("Треды","Закрытие треда","Закрытие по крестику")):(Jane.c("Закрытие письма кликом в шапку в 2pane","Закрытие по шапке"),t>1&&Jane.c("Треды","Закрытие треда","Закрытие по шапке")),ns.page.go(Jane.Page.generateUrl.closeMessage()),ns.events.trigger("daria:vMessagesItemWrap:message-closed"),this.uncheckMessagesInThread()}}},uncheckMessagesInThread:function(){var e=this.getModel("messages-checked"),s=this.getModel("message");
e.isChecked(s)||s.uncheckThreadMessages(e)},isSubjectSelected:function(){var e=this.$node.find(".js-toolbar-subject")[0];if(!e)return!1;var s=window.getSelection();return!s||s.isCollapsed?!1:"function"!=typeof s.containsNode?!1:s.containsNode(e,!0)},getFocusableChildren:function(){var e=this.getModel("messages-item-state"),s=e.getState(),t=e.STATE;switch(s){case t.THREAD_SHORT:var a=Daria.nsTreeWalker.findView(this,["messages-item-box",this.REG_EXP_FOR_TREE_WALKER]),i=Daria.nsTreeWalker.findView(this,["messages-item-box","messages-item-inner","messages-item-thread"]);
return i?[a].concat(i.getFocusableChildren()):[a];default:var o=Daria.nsTreeWalker.findView(this,["messages-item-box"]),n=Daria.nsTreeWalker.findView(o,[this.REG_EXP_FOR_TREE_WALKER]);if(n)return[n];var r=Daria.nsTreeWalker.findView(o,["message-thread"]);if(r)return r.getFocusableChildren();var d=Daria.nsTreeWalker.findView(o,["message"]);if(d)return[d];Daria.DEBUG&&console.warn("[vMessagesItemWrap]","Can't find any focusable children inside!",this)}}}},"journal-log-mixin",ns.View),ns.View.define("messages-notification",{events:{"ns-view-htmlinit":"_onHtmlInit","click .js-create-template":"onCreateTemplateClick"},models:{folders:"doForceUpdate"},"params+":_.clone(ns.Model.infoLite("messages").params),yateModule:"messages",methods:{_toUpdate:null,_onHtmlInit:function(){var e=this.$node.find(".js-infoline A");
e.length&&e.attr("href",ns.router.generateUrl("messages",{search:"search",request:e.text(),force:1}))},onCreateTemplateClick:function(){ns.Model.get("compose-predefined-data").setData({save_symbol:"template"}),ns.page.go(ns.router.generateUrl("compose2"))},toUpdate:function(){if(null===this._toUpdate)if(this.params.current_folder){var e=ns.Model.get("folders");this._toUpdate=e.isFolder(this.params.current_folder,["spam","trash","template"])}else this._toUpdate=!1;return this._toUpdate},doForceUpdate:function(){this.toUpdate()&&this.forceUpdate()
}}}),ns.View.define("messages-notification-search",{models:["collectors","messages","message-type-labels","search-view"],events:{"click .js-search-reset-folder-filter":"onResetFolderFilterClick","click .js-search-request":"onSearchRequestClick"},yateModule:"messages",methods:{onResetFolderFilterClick:function(){Daria.MessagesSearch.search({request:this.params.request})},onSearchRequestClick:function(e){var s=$(e.currentTarget).data("request"),t={request:s,force:!0};ns.events.trigger("daria:search:autocomplete-search-started",t),Daria.MessagesSearch.search(t)
}}}),ns.View.define("messages-pager",{models:{messages:!0},events:{"folder.cleared@show":"onUpdate","daria:vMessagesPager:restruct":"onUpdate"},yateModule:"messages",methods:{onUpdate:function(){this.invalidate(),this.update()}}}),ns.View.define("messages-pager-date",{models:{"messages-pager":!0},events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","ns-view-htmldestroy":"onhtmldestroy"},yateModule:"messages",ctor:function(){this.pagerInitDebounce=_.debounce(this.pagerInit.bind(this),0)
},methods:{patchTree:function(){var e=this.super_.patchTree.call(this),s=this.getModel("messages-pager").getCountMonth();return e.isShowDatePager=Boolean(ns.page.current.params.showDatePager),e.hasSlider=Boolean(s>5&&!this.params.pager_top||s>13&&this.params.pager_top),e},onshow:function(){this.pagerPromise.done(this.pagerUpdateScroll,this)},onhtmlinit:function(){this.pagerPromise=new vow.Promise(this.pagerInitDebounce)},onhtmldestroy:function(){this.pagerInitDebounce.cancel(),this.pagerPromise&&(this.pagerPromise.done(this.pagerUnbindEvents),delete this.pagerPromise)
},pagerUpdateScroll:function(e){e.updateScroll(this.params)},pagerUnbindEvents:function(e){e.unbindEvents()},pagerInit:function(e,s){this.node?e(new Daria.MessagesPager(this.node)):s()}}}),ns.View.define("messages-pager-load-more",{events:{"ns-view-htmlinit":"onHtmlinit","click .js-message-load-more":"_onClickMessageLoadMore","daria:vMessages:messages-load-start@show":"_onMessagesLoadStart","daria:vMessages:messages-load-stop@show":"_onMessagesLoadStop"},models:{messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"onMessagesChanged","ns-model-remove":"onMessagesChanged"}},yateModule:"messages",methods:{_canLoadMore:!1,onHtmlinit:function(){this._canLoadMore=this.canLoadMore()
},canLoadMore:function(){return this.getModel("messages").canLoadMore()},_onMessagesLoadStart:function(){this.$node.addClass("is-loading")},_onMessagesLoadStop:function(){this.$node.removeClass("is-loading")},_onClickMessageLoadMore:function(){return this.loadMore(),!1},onMessagesChanged:function(){var e=this.canLoadMore();e!==this._canLoadMore&&this.forceUpdate()},loadMore:function(){ns.events.trigger("daria:vMessagesPager:messages-load")}}}),ns.View.define("messages-pager-nav",{events:{"ns-view-htmlinit":"onHtmlinit"},models:{messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"onMessagesChanged","ns-model-remove":"onMessagesChanged"},"messages-pager":!0},yateModule:"messages",methods:{_toShow:!1,patchTree:function(){var e=this.super_.patchTree.call(this),s=/^((\d{2})\.)?(\d{4})$/;
if(e.isShowPagerNav=this.toShow(),e.isShowPagerNav){var t,a,i,o=this.params.datePager.match(s),n=o[3],r=o[2];if(r){var d=Daria.MessagesPager.decDate(n,r),l=Daria.MessagesPager.incDate(n,r);t=d[1]+d[0],a=l[1]+l[0],i=r+n}else t=parseInt(n,10)-1,a=parseInt(n,10)+1,i=n;e.navigator={currentDateId:i,prevDateId:t,nextDateId:a}}return e},onHtmlinit:function(){this._toShow=this.toShow()},onMessagesChanged:function(){var e=this.toShow();e!==this._toShow&&this.forceUpdate()},toShow:function(){var e=this.getModel("messages"),s=e.isEmptyList(),t=e.canLoadMore();
return Boolean(!t&&!s&&this.params.datePager)}}}),ns.View.define("messages-pager-search",{events:{"ns-view-htmlinit":"onHtmlinit","focus@show .js-search-input":"_onFocusSearchInput","result@show .js-search-input":"_onResultSearchInput","click .js-search-input-button":"_onClickSearchInputButton","submit@show .js-messages-date-pager-search-form":"_onSubmitSearchForm"},models:{"messages-types":!1,messages:{"ns-model-changed":"onMessagesChanged","ns-model-insert":"onMessagesChanged","ns-model-remove":"onMessagesChanged"}},yateModule:"messages",methods:{_toShow:!1,onHtmlinit:function(){this._toShow=this.toShow()
},onMessagesChanged:function(){var e=this.toShow();e!==this._toShow&&this.forceUpdate()},toShow:function(){var e=this.getModel("messages"),s=Boolean(ns.page.current.params.showDatePager),t=e.isEmptyList();return Boolean(!t&&s&&this.params.datePager)},_onFocusSearchInput:function(e){var s=e.currentTarget,t=Daria.Autocompleter.getSearch();t.setOptions({position:{my:"left bottom",at:"left top",of:$(s),collision:"none none"},width:null,additionalClass:"b-mail-suggest_pager-search",doubleOrient:!0,dontProcessEscape:!1,topOffset:0,onresult:null,onshow:null}),t.bindField({field:s,focus:1})
},_onResultSearchInput:function(e){$(e.currentTarget).closest("form").submit()},_onClickSearchInputButton:function(){Jane.c("Поиск","'Клик по 'найти'")},_onSubmitSearchForm:function(e){e.preventDefault(),e.stopPropagation();var s=$(e.currentTarget).find(".js-search-input");Daria.MessagesSearch.search({request:s.val()},{onSuccess:function(){s.val("")}})}}}),ns.View.define("messages-search-session",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},yateModule:"messages",methods:{onShow:function(){Daria.Config.ensureSearchSessionId()
},onHide:function(){Daria.Config.unsetSearchSessionId()}}}),ns.View.define("messages-list",{yateModule:"messages"}),function(){var e=$.extend({},ns.Model.infoLite("messages").params);delete e.thread_id,ns.View.define("messages-wrap",{"params+":e,events:{"ns-view-show":"onShow","ns-view-touch":"repaintWaitforreply","daria:vScrollerMessages:scroll":"_messagesLoad"},models:{"scroller-messages":!1},yateModule:"messages",methods:{LOAD_NEXT_PAGE_PADDING:300,onShow:function(){this.getModel("scroller-messages").init()
},_messagesLoad:function(){if(!Daria.is2pane()){var e=this.getModel("scroller-messages"),s=e.getScrollBottom();s>=this.LOAD_NEXT_PAGE_PADDING||ns.events.trigger("daria:vMessagesWrap:messages-scroll-load")}},repaintWaitforreply:function(){var e=this.params,s=ns.Model.get("labels").getWaitingForReplyLabel(),t=jpath(s,".count")[0],a=jpath(s,".lid")[0],i=ns.Model.get("folders").isFolder(e.current_folder,["sent"]);if(t&&i&&this.waitForReplyCountLast!==t){var o=Jane.tt("mail:js-letters-without-answer",{count:t,lid:a}),n=$(".js-intruder-without-answer",this.node);
n.length?n.replaceWith(o):$(".js-toolbar-hr",this.node).after(o),this.waitForReplyCountLast=t}else t||($(".js-intruder-without-answer",this.node).remove(),this.waitForReplyCountLast=0)}}})}(),ns.View.define("messages-headers-mixin",{methods:{_redrawHeaderTopResults:function(){this.$headerTopResults&&this.$headerTopResults.off().html(Jane.tt("messages:vMessages-header-top-results"))},_getHeaderOtherResultsRenderData:function(){var e=this.getModel("messages"),s=e.get(".details.total-found")||0,t=e.get(".details.top-relevant")||0,a=s-t;
return a>0?e.isSearchNotFilter()?{headerText:t>0?"Остальные результаты":"Все результаты",messagesCount:a}:{messagesCount:a}:null},_redrawHeaderOtherResults:function(){if(this.$headerOtherResults){var e=this._getHeaderOtherResultsRenderData(),s=e?Jane.tt("messages:vMessages-header-other-results",e):"";this.$headerOtherResults.off().html(s)}},_initHeaders:function(){Daria.hasFeature("search-top-results")&&this.isSearchResults()&&(this.$headerTopResults=$("<div/>"),this.$headerOtherResults=$("<div/>"),this._updateHeaders())
},_destroyHeaders:function(){this.$headerTopResults&&(this.$headerTopResults.off().remove(),this.$headerTopResults=null),this.$headerOtherResults&&(this.$headerOtherResults.off().remove(),this.$headerOtherResults=null)},_updateHeaders:function(){this._positionHeaderBefore(this.$headerTopResults,".js-is-search-top-result:first"),this._positionHeaderBefore(this.$headerOtherResults,".js-messages-item:first"),this._redrawHeaderTopResults(),this._redrawHeaderOtherResults()},_positionHeaderBefore:function(e,s){if(e){var t=this.$node.find(".js-messages-list").find(s);
t.length?e.next()[0]!==t[0]&&e.insertBefore(t):e.off().remove()}}}}),function(){ns.ViewCollection.define("messages",{models:{settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"onToggleCompactMode"},messages:{"ns-model-changed":"keepValid","ns-model-insert":function(e,s){var t=this.getMessagesCheckedInstance();(t.isFolderSelected()||t.isListSelected())&&s.forEach(function(e){t.check(e,!0)}),this.forceUpdate(),this._updateHeaders()},"ns-model-remove":"onRemoveMessages"},"messages-checked":{"run-action":"_runAction","ns-model-destroyed":!1,"ns-model-changed":!1}},split:{byModel:"messages",intoViews:function(){return"messages-item-wrap"
}},paramsRewrite:function(e){return Daria.is3pane()&&delete e.thread_id,e},events:{"ns-view-htmlinit":"_onHtmlInit","ns-view-hide":"_onHide","ns-view-show":"_onShow","ns-view-touch":"_onTouch","ns-view-htmldestroy":"_onHtmlDestroy","ns-page-after-load@init":"invalidateUnreadMessages","ns-page-after-load@show":"scrollToMessageDebounce","daria:vMessages:invalidate@init":"invalidate","daria:vMessages:recalculate@show":"_recalculateMessages","daria:vMessages:deselect@show":"deselect","daria:vMessages:closeWithShortcut@show":"onCloseWithShortcut","daria:vMessages:selectAll@show":"selectAll","daria:vMessages:selectAllInFolder":"selectAllInFolder","daria:vToolbarButton:label@show":"_onLabelToolbarButton","daria:vToolbarButton:unlabel@show":"_onUnlabelToolbarButton","daria:vToolbarButton:move@show":"_onMoveToolbarButton","daria:vToolbarButton:archive@show":"_onArchiveToolbarButton","daria:vToolbarButton:infolder@show":"_onInfolderToolbarButton","daria:vToolbarButton:tospam@show":"_onTospamToolbarButton","daria:vToolbarButton:notspam@show":"_onNotspamToolbarButton","daria:vToolbarButton:sendon@show":"_onSendonToolbarButton","daria:vToolbarButton:reply-tmpl@show":"_onReplyTmplToolbarButton","daria:vToolbarButton:deselect@show":"deselect","daria:vToolbarButton:select-all@show":"selectAll","daria:vMessagesWrap:messages-scroll-load@show":"_onMessagesScrollLoad","daria:vMessagesPager:messages-load@show":"_onMessagesLoad","dragndrop.drop@show":"_onDrop","message.action.complete@show":"_onMessageActionComplete","resize@show window":"_onResizeWindow","layout-ratio-changed":"fillMessagesList","daria:folder-remove-done@show":"_onFolderRemove","daria:label-remove-done@show":"_onLabelRemove","daria:MOPS:action-complete@show":"_onActionComplete"},ctor:function(){this._onMessagesScrollLoad=_.debounce(this._onMessagesLoad.bind(this),50),this._doLoadMoreAfterRemove=_.debounce(this.loadMoreAfterRemove.bind(this),10),this.scrollToMessageDebounce=_.debounce(this.scrollToMessage.bind(this),10),this.initAds()
},yateModule:"messages",methods:[ns.View.infoLite("context-menu-mixin-messages").methods,ns.View.infoLite("ads-mixin").methods,ns.View.infoLite("message-actions").methods,ns.View.infoLite("messages-headers-mixin").methods,{HEIGHT_MESSAGE_SNIPPET:39,_openMessageState:null,OPEN_MESSAGE_OFFSET_TOP:8,_recalculateMessages:function(){this.isUnreadList()&&ns.forcedRequest([this.getModel("messages")])},onRemoveMessages:function(e,s){var t=ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,"trash"),a=ns.page.current.params.thread_id||ns.page.current.params.ids,i=t&&a&&s.some(function(e){return a===e.params.ids
});i?(this._updateHeaders(),ns.page.go(Jane.Page.generateUrl.closeMessage()).then(function(){this._doLoadMoreAfterRemove()},this)):(this._doLoadMoreAfterRemove(),this.forceUpdate(),this._updateHeaders())},loadMoreAfterRemove:function(){var e=this.getModel("messages"),s=e.models.length,t=this.getModel("settings").getSetting("messages_per_page");e.canLoadMore()&&s<Math.round(t/2)&&(this.needLoadMore=!0)},_onActionComplete:function(e,s){if(this.needLoadMore&&(this.getModel("messages").loadMore(),delete this.needLoadMore),"delete"===s.action&&Daria.is3pane()){var t=_.omit(ns.page.current.params,["thread_id","ids"]);
this.openLastOpenedMessage(t)||ns.page.go(ns.router.generateUrl("messages",t))}},_getDiagnosticsObject:function(){return{viewKey:this.key,viewShown:this._shown,viewVisible:this.isVisible(),htmlInited:this._htmlInited,nodeExists:this.$node.length}},onCloseWithShortcut:function(){var e=this.getOpenMessageState();if(e){var s=ns.Model.get("message",{ids:e});s&&s.getThreadCount()>1&&Jane.c("Треды","Закрытие треда","Закрытие по хоткею")}},_onHtmlInit:function(){this._initHeaders(),this._htmlInited=!0;var e=this.params;
$(".b-search-not-found").length?Jane.c(["Пейджер по датам","Ничего не нашлось"]):e.datePager&&Jane.c(["Пейджер по датам","Страница с результатами поиска"])},_onShow:function(e,s,t){this._shown=!0,this.logTimings(t),this._cbt=new Daria.CBT(this.$node,{targetSelector:".js-cbt-item-target"});var a={$node:this.$node,selector:".js-message",mMessagesChecked:this.getModel("messages-checked")};this._cmBaseBindMenuableElements(a),Daria.is3ph()&&(Daria.resize.reinitResizer(),ns.events.trigger("daria:vApp:changeAppWidth")),Daria.is2pane()&&this.startAds(),this.isSearchResults()&&ns.Model.get("search-session-state").onSearchResultsReceived()
},_onTouch:function(){var e=this.getModel("messages"),s=e.isEmptyList();Daria.is2pane()?this.params.current_label&&s&&Jane.c(["Промо меток","Писем с такой меткой нет","показ блока"]):(s||this.fillMessagesList(),ns.events.trigger("mail:splitter:toggleOnePaneMode",s),this.openLastOpenedMessage()),this._moveDynamicNodes()},_moveDynamicNodes:function(){this.adNodes&&this.attachAdNodes(this.adNodes),this._updateHeaders()},_onHtmlDestroy:function(){this._destroyHeaders()},openLastOpenedMessage:function(e){var s=Daria.router.goToLOM(e||ns.page.current.params,this.getModel("messages"));
return s?(ns.page.go(s),!0):!1},_onHide:function(){this.scrollToMessageDebounce.cancel(),this._shown=!1,this._cbt&&this._cbt.destroy(),this.resetOpenMessageState(),this._cmBaseUnbindMenuableElements(),Daria.is2pane()&&this.stopAds()},getAds:function(){var e=this.getAdsModel();return e.getMessageListAds()},getAdNodes:function(e){var s=ns.tmpl(e[0],"message-direct-ad","messages");return this.setAdNodeClickHandlers(s,e[0]),[s]},getAdStyleNode:function(e){var s=e[0];return ns.tmpl(s,"message-direct-ad-style","messages")
},attachAdNodes:function(e){this.$node.find(".js-messages-list").prepend(e)},_getAdUrlMapping:function(e){var s={".js-message-snippet":e.url,".js-message-snippet-importance":"https://direct.yandex.ru/?partner"};return s},setAdNodeClickHandlers:function(e,s){var t,a,i,o=this._getAdUrlMapping(s);for(i in o)t=o[i],a=e.querySelector(i),a&&t&&Jane.DOM.setUrlClickHandler(a,t);return Jane.DOM.preventClicks(e),e},deselect:function(){this.getMessagesCheckedInstance().resetChecked()},selectAll:function(){this.getMessagesCheckedInstance().selectList()
},selectAllInFolder:function(){if(this.params.current_folder){var e=this.getMessagesCheckedInstance();e.selectFolder(this.params.current_folder)}},_onMessagesLoad:function(){if(!this.__lockMessagesLoad&&this.getModel("messages").canLoadMore()){this.__lockMessagesLoad=!0,ns.events.trigger("daria:vMessages:messages-load-start");var e=new Jane.Loader(0);e.start(),this.getModel("messages").loadMore().then(function(){ns.Model.get("messages-pager",ns.page.current.params).invalidate(),this.__lockMessagesLoad=!1,e.stop(),ns.events.trigger("daria:vMessages:messages-load-stop")
},this)}},getMessagesCheckedInstance:function(){return this.getModel("messages-checked")},_onToolbarButton:function(e,s,t){var a=this;if(s=s||{},t=t||{},"move"===e&&ns.Model.get("folders").isArchive(s.fid)&&(e="archive"),!s._viewKey||s._viewKey==this.key){var i;t.refreshImmediately&&(i=null||this);var o=s.mMessagesChecked||this.getMessagesCheckedInstance(!0),n=o.getIds(e,s),r=Daria.MOPS.updateHelper(e,o,s,i).then(function(){if("archive"===e&&a.deselect(),!t.refreshImmediately&&!t.preventUpdate&&"label"!==e&&"unlabel"!==e)if(Daria.is3pane()&&"remove"===e){var i=$.extend({},ns.page.current.params);
delete i.ids,delete i.thread_id,ns.page.go(ns.router.generateUrl("messages",i))}else if(Daria.is3pane()){var r=Daria.messages.whereToGoAfterMove(e,o,_.extend({ids:n},s));ns.page.go(r.where)}else ns.page.go();ns.events.trigger("daria:vToolbarButton:loader:end"),$(document).trigger("b-mail-dropdown-closeall")});return"archive"!==e&&(o.isFolderSelected()||["remove","move","tospam","notspam","infolder"].indexOf(e)>-1||["mark","unmark"].indexOf(e)>-1&&!Daria.is3pane()?a.deselect():o.touch()),r}},_scrollUpOnActionComplete:function(){ns.events.once("daria:MOPS:action-complete",function(){$(window).scrollTop(0)
})},_onReplyTmplToolbarButton:function(e,s){this._replyHelper("reply-tmpl",s),this._scrollUpOnActionComplete()},_onSendonToolbarButton:function(e,s){this._replyHelper("sendon",s),this._scrollUpOnActionComplete()},_onDeselect:function(){$(document).trigger("b-mail-dropdown-closeall"),ns.events.trigger("daria:vMessages:deselect")},_onLabelToolbarButton:function(e,s){this._onToolbarButton("label",s,{preventUpdate:!0,_viewKey:s._viewKey})},_onUnlabelToolbarButton:function(e,s){this._onToolbarButton("unlabel",s,{preventUpdate:!0,_viewKey:s._viewKey})
},_onTospamToolbarButton:function(e,s){this._onToolbarButton("tospam",s)},_onNotspamToolbarButton:function(e,s){this._onToolbarButton("notspam",s)},_onArchiveToolbarButton:function(e,s){this._onToolbarButton("archive",s)},_onInfolderToolbarButton:function(e,s){this._onToolbarButton("infolder",s)},_onMoveToolbarButton:function(e,s){this._onToolbarButton("move",s,{refreshImmediately:!0})},_onRemoveToolbarButton:function(e,s){this._onToolbarButton("remove",s)},_onMarkToolbarButton:function(e,s){this._onToolbarButton("mark",s,{preventUpdate:!0})
},_onUnmarkToolbarButton:function(e,s){this._onToolbarButton("unmark",s,{preventUpdate:!0})},fillMessagesList:function(){var e=this.hasVerticalScroll();this._visible&&e===!1&&this._onMessagesLoad()},hasVerticalScroll:function(){var e=this.getScrollArea()[0];return e?e.scrollHeight>e.offsetHeight:void 0},getScrollArea:function(){return this._$scrollArea&&this._$scrollArea.length||(this._$scrollArea=this.$node.closest(".js-messages-scroll-area")),this._$scrollArea},_onMessageActionComplete:function(){ns.action.run("messages.close-attachments")
},_onResizeWindow:function(){ns.action.run("messages.close-attachments"),Daria.is3pane()&&(this._lazyOnResize||(this._lazyOnResize=_.debounce(function(){this.fillMessagesList(),Daria.is3pv()&&ns.events.trigger("mail:splitter:update")},100)),this._lazyOnResize())},_runAction:function(e,s){this._onToolbarButton(s.action,s.params)},_onFolderRemove:function(e,s){this.params.current_folder===s&&ns.page.go(ns.router.generateUrl("messages",{current_folder:ns.Model.get("folders").getFidBySymbol("inbox")}))
},_onLabelRemove:function(e,s){this.params.current_label===s&&ns.page.go(ns.router.generateUrl("inbox"))},isUnreadList:function(){return"only_new"===this.params.extra_cond},isSearchResults:function(){return this.getModel("messages").isSearch()},invalidateUnreadMessages:function(){this.isUnreadList()&&!this.isVisible()&&this.getModel("messages").invalidate()},getOpenMessageState:function(){var e=ns.page.current.params;return Daria.Page.isParamsForSingleThread(e)?e.ids||"":e.ids||e.thread_id||""},resetOpenMessageState:function(){this._openMessageState=null
},scrollToMessage:function(){if(Daria.is2pane()){var e=this.getOpenMessageState();if(e!==this._openMessageState){var s;e?(s=this.$node.find(".js-message-wrap-"+e),this.scrollMessageIntoViewport(s,!0)):!e&&this._openMessageState&&(s=this.$node.find(".js-message-wrap-"+this._openMessageState),this.scrollMessageIntoViewport(s,!1),this.highlightClosedMessage(s)),ns.events.trigger("daria:vMessages:scroll"),this._openMessageState=e}}},scrollMessageIntoViewport:function(e,s){var t=e.offset();if(t){var a=ns.Model.get("scroller-messages"),i=a.getScrollTop(),o=a.getHeight(),n=i+o,r=t.top,d=!1;
if(s){var l=r-i;d=!(l>2*this.HEIGHT_MESSAGE_SNIPPET&&o/3>l)}else d=!(r>i&&n>r);if(d){var h=2*this.HEIGHT_MESSAGE_SNIPPET,c=r-h;a.setScrollTop(c,!0)}}},highlightClosedMessage:function(e){e.addClass("is-highlight"),$.Transitions.animFrame(function(){$.Transitions.animFrame(function(){e.removeClass("is-highlight")})})},onToggleCompactMode:function(){if(Daria.is2pane()){var e=this.getModel("settings");this.$node.find(".js-messages-list").toggleClass("mail-MessagesList_height_small",e.isCompactMode())
}},getFocusableChildren:function(){var e=[];return this.forEachValidItem(function(s){e=e.concat(s.getFocusableChildren())}),e}}]})}(),ns.View.define("suggest-item-mixin",{events:{click:"onNodeClick"},methods:{getSearchParams:function(){var e=this.$node.data("params"),s={};return e.type?s.type=e.type:(s=_.clone(ns.page.current.params),delete s.request,delete s.search,e.request&&(s.request=e.request)),s},onNodeClick:function(e){e.preventDefault(),this.startSearch()},startSearch:function(){var e=this.getSearchParams();
ns.events.trigger("daria:search:autocomplete-search-started",e),Daria.MessagesSearch.search(e)},sendMetric:function(e){Jane.ErrorLog.send({event:"suggest_click",user_input:ns.page.current.params.request||"",suggest_group:this.params.group,user_select_idx:ns.Model.get("focus").findIndex(this)+1,suggest_text:e.request||e.type,reqid:Daria.Config.searchSessionId,exp:Daria.Config["exp-test-ids"].join(",")})},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();
break;case"enter":this.startSearch()}},focusOn:function(){this.$node.addClass("is-active")},focusOff:function(){this.$node.removeClass("is-active")}}}),ns.View.define("search-suggest",{events:{"ns-page-before-load@show":"onPageBeforeLoad","ns-page-after-load@show":"onPageAfterLoad","ns-view-show":"onShow","ns-view-hide":"onHide"},yateModule:"messages",methods:{onPageBeforeLoad:function(e,s){"search"!==s[1].page&&this.$node.addClass("is-loading")},onPageAfterLoad:function(){this.requestModels(ns.page.current.params),this.$node.removeClass("is-loading")
},onShow:function(){$(".js-mail-Layout-Panes").addClass("mail-Layout-Panes_with_search_suggest")},onHide:function(){$(".js-mail-Layout-Panes").removeClass("mail-Layout-Panes_with_search_suggest"),ns.Model.get("abook-suggest-proxy").clear(),ns.Model.get("history-suggest-proxy").clear()},requestModels:function(e){var s=ns.Model.get("settings").isSet("dont_save_history");s||ns.Model.get("history-suggest-proxy").request(e),ns.Model.get("abook-suggest-proxy").request(e)}}}),ns.ViewCollection.define("abook-suggest",{models:{"abook-suggest-proxy":{"ns-model-changed":"updateFocusableView"}},split:{byModel:"abook-suggest-proxy",intoViews:"abook-suggest-item"},events:{"ns-view-show":"onShow"},yateModule:"messages",methods:{getFocusableChildren:function(){return Daria.nsTreeWalker.getViewsChildren(this)
},updateFocusableView:function(){this.update().then(function(){ns.events.trigger("daria:mFocus:buildTree")})},onShow:function(){ns.events.trigger("daria:mFocus:buildTree")}}}),ns.View.edefine("abook-suggest-item",{models:{"abook-suggest-item":"keepValid"},"params+":{group:"address"},yateModule:"messages"},"suggest-item-mixin"),ns.ViewCollection.define("history-suggest",{models:{"history-suggest-proxy":{"ns-model-changed":"updateFocusableView"}},split:{byModel:"history-suggest-proxy",intoViews:"history-suggest-item"},events:{"ns-view-show":"onShow"},yateModule:"messages",methods:{getFocusableChildren:function(){return Daria.nsTreeWalker.getViewsChildren(this)
},updateFocusableView:function(){this.update().then(function(){ns.events.trigger("daria:mFocus:buildTree")})},onShow:function(){ns.events.trigger("daria:mFocus:buildTree")}}}),ns.View.edefine("history-suggest-item",{models:{"history-suggest-item":"keepValid"},"params+":{group:"history"},yateModule:"messages"},"suggest-item-mixin"),ns.ViewCollection.define("search-filters",{models:["search-filters"],split:{byModel:"search-filters",intoViews:"search-filters-item"},yateModule:"messages",methods:{getFocusableChildren:function(){return Daria.nsTreeWalker.getViewsChildren(this)
}}}),ns.View.edefine("search-filters-item",{models:{"search-filters-item":"keepValid"},"params+":{group:"filters"},yateModule:"messages"},"suggest-item-mixin"),function(){ns.View.define("inline-wizard-container",{models:{settings:{"ns-model-changed":!1,"ns-model-changed.disable_promo":"onDisablePromoChanged"}},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","modules:promo:loaded@show":"onModulePromoLoaded"},yateModule:"messages",methods:{_inlineWizardOpenInView:!1,onShow:function(){Daria.InlineWizard&&!this._inlineWizardOpenInView&&this.showWizard()
},onHide:function(){this._inlineWizardOpenInView=!1},onModulePromoLoaded:function(){this._inlineWizardOpenInView||this.showWizard()},showWizard:function(){Daria.InlineWizard.show(this.params),this._inlineWizardOpenInView=!0},onDisablePromoChanged:function(){this._inlineWizardOpenInView=!1,this.invalidate()}}})}(),yr.externals["date-pager-url"]=function(e){var s;return s=e?no.extend({},ns.page.current.params,e):ns.page.current.params,ns.router.generateUrl("messages",s)},yr.externals.json=function(e){return JSON.stringify(e[0].data)
},yr.externals["messages-item-format-date"]=function(e){var s=yr.nodeset2data(e),t=new Date,a=new Date(s.ts);return Jane.Date.isSameDay(t,a)?Jane.Date.format("%R",s.ts):t.getFullYear()!==a.getFullYear()?s["short"]:Jane.Date.format("%Date_df",s.ts)},yr.externals["widget-entity"]=function(e){var s={man:"Widgets-Person",plane:"Widgets-PlaneOneWay",planes:"Widgets-PlaneBothWays"};return e.replace(/&([a-z]+);/g,function(e,t){var a=s[t];return a?'<svg xmlns="http://www.w3.org/2000/svg" class="svgicon svgicon-mail--'+a+'"><use xlink:href="#svgicon-mail--'+a+'"></use><rect height="100%" width="100%" style="fill: transparent;"></rect></svg>':"&"+t+";"
})},yr.externals["is-corp-email"]=function(e){return Daria.email.isCorp(e)},yr.externals["show-taksa-widgets"]=function(e){return Daria.Widgets.shouldShowTaksaWidgets(ns.Model.get("message",{ids:e}))},Daria.Autocompleter.phoneAutocompleterOpts={tpl:'<div class="b-mail-suggest b-mail-suggest_phones"><div class="b-grid js-sections"></div></div>',activeClass:"b-grid-item_selected",width:"20em",multiple:!1,excludeSelected:!0,filterItem:function(e){var s,t=this.currentValue||this.prevVal;return e.data.title?(s=[].concat(e.data.contacts),s=$.grep(s,function(e){return-1==t.indexOf(e.email)
}),s.length):e.data.email?-1==t.indexOf(e.data.email):void 0},scroll:!0,scrollElem:".b-grid",item:".b-grid-item",sections:[{url:Daria.modelsApiURl+"?_model.0=abook-suggest",dataType:"json",param:"q",withCkey:!0,extraParams:{glimit:5,climit:35,phone:"must"},parse:function(e,s){function t(e,t,a,o){for(var n=0,r=e.length;r>n&&n!==o;n++){var d=e[n];d&&(a[a.length]={data:d,$item:$(t.call(i,d,s))})}}e=jpath(e,".models[0].data")[0]||{};var a=[],i=this;return e.contacts&&e.contacts.length&&t(e.contacts,i.formatContact,a,i.extraParams.climit),e.groups&&e.groups.length&&t(e.groups,i.formatGroup,a,i.extraParams.glimit),a
},groupTpl:'<div class="b-grid-item"><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__content__group">группа</span>&#160;{title}</span></span><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__misc">{emails}</span></span></span></div>',formatContact:function(e,s){var t="";e&&e.phones&&e.phones.length&&(t='<span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__misc">'+_.escape(e.phones[0])+"</span></span></span>");
var a='<div class="b-grid-item"><span class="b-grid-item__content"><span class="b-grid-item__content__i">'+_.escape(e.name||e.email)+'</span></span><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__misc">'+(e.name&&e.email?_.escape(e.email):" ")+"</span></span></span>"+t+'<span class="b-grid-item__right"><span class="b-userpic b-userpic_small'+(e.cid?" cid-"+e.cid:"")+'"></span></span>';return a+="</div>",Daria.Autocompleter.utils.highlight(a,s)},formatGroup:function(e,s){for(var t=[],a=0,i=e.contacts.length;i>a;a++)t.push(e.contacts[a].email);
return Daria.Autocompleter.utils.highlight(Daria.supplant(this.groupTpl,{title:e.title,emails:t.join(", ")}),s)},formatResult:function(e){return e&&$.isArray(e.phones)&&e.phones.length>0?e.phones[0]:""}}]},Daria.Autocompleter.getPhoneAutocompleter=function(){return new Daria.Autocompleter(Daria.Autocompleter.phoneAutocompleterOpts)},Daria.Autocompleter.getPhone=function(){return Daria.Autocompleter.__phoneInstance||(Daria.Autocompleter.__phoneInstance=Daria.Autocompleter.getPhoneAutocompleter()),Daria.Autocompleter.__phoneInstance
},function(e){e.userphoneAutocompleterOpts={tpl:'<div class="b-mail-suggest b-mail-suggest_contacts"><div class="b-grid js-sections"></div></div>',activeClass:"b-grid-item_selected",item:".b-grid-item",sections:[{isStatic:!0,formatResult:function(e){return e},parse:function(e,s){var t=Jane.Promo.findPromo("alias-promo").promoBar.autocompleteData;return t=t.filter(function(e){return e.indexOf(s)>=0}),t.map(function(e){return{data:e,$item:$("<div>",{"class":"b-grid-item",text:e})}})}}]},Daria.Autocompleter.getUserPhoneAutocompleter=function(){return new Daria.Autocompleter(Daria.Autocompleter.userphoneAutocompleterOpts)
}}(Daria.Autocompleter),Daria.CBS=function(){this._mMessagesChecked=ns.Model.get("messages-checked",ns.page.current.params),this._mFocus=ns.Model.get("focus")},Daria.CBS.prototype.start=function(e){this._start=e,this._action=!this._mMessagesChecked.isCheckedByMid(this._start),this._previous=[]},Daria.CBS.prototype.getStart=function(){return this._start},Daria.CBS.prototype.select=function(e){var s=this._mFocus.getRange(this._start,e),t=this._action;if(this._checkByRange(s,t),this._previous.length){var a=_.difference(this._previous,s);
this._checkByRange(a,!t)}this._previous=s},Daria.CBS.prototype.selectWithShift=function(e){for(var s=this._mMessagesChecked,t=s.getLastChecked(),a=t.params.ids,i=this._mFocus.getRange(a,e),o=!1,n=0,r=i.length;r>n;n++){var d=i[n].getModel("message");if(!s.isChecked(d)){o=!0;break}}this._checkByRange(i,o)},Daria.CBS.prototype._checkByRange=function(e,s){var t=this._mMessagesChecked;if(e.forEach(function(e){t.check(e.getModel("message"),s)}),e.length>0){var a=_.last(e);t.setLastChecked(a.getModel("message"))
}},function(){var e={itemSelector:".js-cbt-item",checkboxSelector:".js-cbt-item-checkbox",targetSelector:"",level2Selector:".js-cbt-group",onPotentialDragNDrop:no.nop},s={mouseDown:"mousedown.cbt",mouseUp:"mouseup.cbt",mouseMove:"mousemove.cbt","daria:cbt:mousedown":"daria:cbt:mousedown"};Daria.CBT=function(s,t){this.options=_.extend({},e,t),this._$node=$(s),this._init()},Daria.CBT.prototype.destroy=function(){this._$node.off(".cbt"),this.$document.off(".cbt")},Daria.CBT.prototype.$document=$(document),Daria.CBT.prototype._init=function(){this._$node.on(s.mouseDown,this.options.targetSelector,this._onItemMouseDown.bind(this))
},Daria.CBT.prototype.startSelection=function(e){var s=this._getCBTItem(e);return s?(this._cbs=new Daria.CBS,this._cbs.start(s.dataset.id),!0):!1},Daria.CBT.prototype.selectByRange=function(e){var s=e.dataset.id;this._cbs.getStart()!==s&&this._cbs.select(s)},Daria.CBT.prototype._onItemMouseDown=function(e){if(1!=e.which||2==e.buttons)return!1;ns.events.trigger(s["daria:cbt:mousedown"]);var t=e.target.className;return"string"==typeof t&&t.indexOf("b-label")>-1?!0:void this._onMouseDown(e)},Daria.CBT.prototype._onMouseDown=function(e){var t=this.startSelection(e.target);
t&&(e.preventDefault(),this.$document.on(s.mouseMove,this._doMouseSelection.bind(this)).on(s.mouseUp,this._stopMouseSelection.bind(this)))},Daria.CBT.prototype._doMouseSelection=function(e){e.stopPropagation(),e.preventDefault();var s=this._getCBTItem(e.target);s&&this.selectByRange(s)},Daria.CBT.prototype._stopMouseSelection=function(e){e.stopPropagation(),e.preventDefault(),this._cbs=null,this.$document.off(".cbt")},Daria.CBT.prototype._getCBTItem=function(e){var s=$(e).closest(this.options.itemSelector)[0];
return s?s:null}}(),Daria.messages.params4SimplePath=function(e){var s={current_folder:null,"hide-firstline":null,showDatePager:null,threaded:null};Daria.is3pane()&&(s.ids=null,s.thread_id=null);for(var t in e)if("_"!=t.charAt(0)&&!(t in s))return!1;return"current_folder"in e},Daria.messages.params4SimpleLabel=function(e){var s={current_label:null,important:null};Daria.is3pane()&&(s.ids=null,s.thread_id=null);for(var t in e)if("_"!=t.charAt(0)&&!(t in s))return!1;return"current_label"in e};var s=function(e){e&&(this.node=e,this.content=e.innerHTML)
};s.prototype.showMsg=function(e){this.node&&(this.node.innerHTML=e)},s.prototype.changeContent=function(e){this.content=e},s.prototype.clear=function(){this.node&&(this.node.innerHTML=this.content)},Daria.Infoline=s;var t=function(e){var s=this.checkbox=e.checkbox;this.id=e.id,this.tr=e.tr,this.root=e.root,this.total=e.total||0,this.checked=s.checked,this.count=this.checked?this.total:0};Daria.CheckboxTree=t,t.addTRs=function(e,s){var a=$.isArray(e)?e:e.getElementsByClassName("b-messages__message"),i=0;
s.items||(s.items={}),$.each(a,function(){var e=this.getElementsByClassName("b-messages__message__checkbox__input")[0];if(e){var a=e.value,o=Number(this.getAttribute("count"))||1,n=new t({checkbox:e,tr:this,id:a,total:o,root:s});if(o>1){n.items={};var r=$(this),d=r.next(".js-thread-box");d.length||(d=r.parent().next(".js-thread-box"));var l=d[0];l&&t.addTRs(l,n)}i+=n.total,s.items[a]=n}}),s.total=s.total||i,s.root||(s.checkbox.disabled=!i,i||(s.checkbox.checked=!1))},t.delTRs=function(e,s){var t=$.isArray(e)?e:e.getElementsByClassName("b-messages__message"),a=0;
s.items&&($.each(t,function(){var e=this.getElementsByClassName("b-messages__message__checkbox__input")[0];if(e){var t=e.value,i=s.items[t];i&&(a+=i.total,delete s.items[t])}}),s.total-=a)},t.prototype.updateTRs=function(e,s){delete s.items,s.total=0,s.count=0,t.addTRs(e,s);for(var a in s.items)s.items[a].checked&&(s.count+=s.items[a].count)},t.prototype.on=function(e){this.items&&$.each(this.items,function(){this.on(!1)}),this.shift(this.total-this.count,e)},t.prototype.off=function(e,s){if(s=s||null,this.id!==s){var t=this.count;
this.items&&$.each(this.items,function(e){t-=e===s?1:this.off(!1,s)}),this.shift(-t,e)}return this.count},t.prototype.shift=function(e,s){if(e){var t=this.count;this.count+=e,this.count===this.total?this.check():this.count<this.total&&(this.uncheck(),this.root||(this.count=this.sum())),s&&this.root&&this.root.shift(this.count-t,s)}},t.prototype.toggle=function(e){if(this.checked!==e){this.checked=e,this.checkbox.checked=e;var s=$(this.tr);if(Daria.is3pane())if(e){var t=s.hasClass("b-messages__message_checked")||s.hasClass("b-messages__message_focus");
Jane.watcher.get("messages-context-menu:opened")&&!t?s.addClass("b-messages__message_hover"):(s.removeClass("b-messages__message_hover"),s.addClass("b-messages__message_checked"))}else s.removeClass("b-messages__message_checked b-messages__message_hover");else s.toggleClass("b-messages__message_checked",e)}},t.prototype.check=function(){this.toggle(!0)},t.prototype.uncheck=function(){this.toggle(!1)},t.prototype.sync=function(e){var s=this.checkbox.checked;s?this.on(!0):this.off(!0,e)},t.prototype.sum=function(){if(this.items){var e=0;
return $.each(this.items,function(){e+=this.count}),e}return this.count},t.prototype.getCheckedIds=function(){var e=[];return this.items&&$.each(this.items,function(s){this.checked&&e.push(s)}),e};var a=function(s,a){var i=s.node;i&&(this.messagesBlock=s,this.node=i,this.paddingTop=30,this.paddingBottom=2*this.paddingTop,this.$scrollArea=a,this.$headline=$(".b-messages-head",i),this.headline=this.is3pane?new e(this.$headline,a):null,this.updateHeader(),this.messages=i.getElementsByClassName("b-messages")[0],this.curRowIsFocused=!1,this.checkboxTree=new t({checkbox:this.checkbox,total:0}),t.addTRs(i,this.checkboxTree),this.folderActionsMode=!1,this.updateRows())
};$.extend(a,{DENY:1,ALLOW:2,WITH_DELAY:3}),Daria.Table=a,a.prototype.is3pane=Daria.is3pane(),a.prototype.updateFolderActionsMode=function(e){if(e="boolean"==typeof e?e:this.folderActionsMode,this.folderActionsMode=e,e){var s=this.messagesBlock.params.current_folder,t=ns.Model.get("folders"),a=t.getCount(s),i=t.getUnreadCount(s),o=["folder-delete","folder-mark-as-read"],n=["folder-delete"];i&&n.push("folder-mark-as-read"),this.infoline.showMsg("Выбраны все письма в папке ("+a+'). <a class="b-messages-head__infoline__link daria-action" action="messages.deselect">Снять выделение</a>.'),Jane.watcher.set("folder-visible-actions",o.join(",")),Jane.watcher.set("folder-enable-actions",n.join(","))
}else Jane.watcher.set("folder-visible-actions",""),Jane.watcher.set("folder-enable-actions",""),this.refreshInfoline();Jane.watcher.set("folder-actions-mode",e)},a.prototype.updateHeader=function(){var e=this.checkbox=this.$headline.find(".b-messages-head__checkbox")[0];if(this.updateInfoline(),e&&this.checkboxTree){var s=this.checkboxTree.checkbox;e.checked=s.checked,e.disabled=s.disabled,this.checkboxTree.checkbox=e,this.refreshInfoline()}},a.prototype.updateInfoline=function(){this.infoline=new Daria.Infoline(this.node.getElementsByClassName("js-infoline")[0])
},a.prototype.refreshInfoline=function(){var e=this.getCount(),s=0===e,t=!s;if(!(t&&Jane.watcher.get("Daria:vMessagesSelection.dontChangeViewToBatchOperation")||(Jane.watcher.set("daria:selection-mode",t),Daria.is3pane())))if(this.toggleHeadline(!s),s)this.infoline.clear();else{var a=this.getTotal(),i=this.messagesBlock.params.current_folder,o="Выбрано "+Jane.i18n.convert(["одно письмо",e+" письмо",e+" письма",e+" писем"],e);this.is3pane||(1===e&&(o+=' · <a class="b-messages-head__infoline__link ns-action" data-click-action="reply">Ответить</a>'),o+=' · <a class="b-messages-head__infoline__link ns-action" data-click-action="messages.deselect">Снять выделение</a>',i&&e===a&&e>1&&(o+=' · <a class="b-messages-head__infoline__link ns-action" data-click-action="messages.select-all" data-params="fid='+i+'">Выбрать все письма в этой папке</a>')),this.infoline.showMsg(o)
}},a.prototype.toggleHeadline=function(e){this.headline&&this.headline.toggleAllowFixedState(e)},a.prototype.hasVerticalScroll=function(){var e=this.getScrollArea()[0];return e.scrollHeight>e.offsetHeight},a.prototype.getScrollArea=function(){return this.$scrollArea},a.prototype.onCountChange=function(){var e=this.getCount(),s=this.getTotal(),t=!s||s>e?!1:null;this.updateFolderActionsMode(t),Jane.watcher.set("selectedCount",e)},a.prototype.getCount=function(){return this.checkboxTree.count},a.prototype.getTotal=function(){return this.checkboxTree.total
},a.prototype.update=function(){this.updateRows(),this.checkboxTree.updateTRs(this.node,this.checkboxTree),this.checkboxTree.checked&&this.checkboxTree.sync(),this.onCountChange()},a.prototype.updateWithFocus=function(){var e=!1;this.curRowId&&this.isCurrentFocused()&&(e=!0),this.update(),e&&this.setCurrent(this.curRowId)},a.prototype.updateRows=function(){var e=[],s={},t=this.node.getElementsByClassName("b-messages__message");$.each(t,function(t,a){var i=a.getElementsByClassName("b-messages__message__checkbox__input")[0];
if(i){var o=i.value;e.push({id:o,tr:a}),s[o]=t}}),this.rows=e,this.rowsHash=s,ns.events.trigger("table.updaterows",this)},a.prototype.getRow=function(e){return this.rows[this.rowsHash[e]]||null},a.prototype.getPrevRow=function(e){var s=Jane.$B("messages-list-box").active,t=this.rows[this.rowsHash[e]-1];if(t&&s){var a=this.getCheckboxTree(t.id),i=a&&a.root;i&&i.tr&&!s.isThreadOpen(i.id)&&(t=this.getRow(i.id))}return t||null},a.prototype._getNextRow=function(e){var s=null;if(e){var t=/(tid|mid)-(\d+)/.exec(e.className);
t&&(s=this.getRow(("tid"==t[1]?"t":"")+t[2]))}return s},a.prototype.getNextRow=function(e){for(var s,t=Jane.$B("messages-list-box").active,a=0,i=this.rows.length;i>a;a+=1)if(this.rows[a].id===e){if(s=this.rows[a+1],s&&t){var o=this.getCheckboxTree(s.id);if(o&&o.root&&o.root.tr&&!t.isThreadOpen(o.root.id)){var n=$(o.root.tr).nextAll(".b-messages__message:first")[0];if(n)s=this._getNextRow(n);else{var r=$(o.root.tr).closest(".block-messages-item");n=r.nextAll(".b-messages__message,.block-messages-item")[0],n?(n.className.indexOf("block-messages-item")>-1&&(n=n.childNodes[0]),s=this._getNextRow(n)):s=null
}}}return s}return s||null},a.prototype.getCheckboxTree=function(e){return this.checkboxTree.items[e]},a.prototype.getIDsRange=function(e,s){var t={},a=!1;return $.each(this.rows,function(i,o){var n=o.id;if(n===e||n===s){if(n===e&&(a=!a),n===s&&(a=!a),t[n]=1,!a)return t}else a&&(t[n]=1)}),t},a.prototype.syncRows=function(e,s){var t=this,a=$.isArray(e);$.each(e,function(e,i){t.syncRow(a?i:e,s)})},a.prototype.syncRow=function(e,s){var t=this.getCheckboxTree(e);t&&t.checked!==s&&(s?t.on(!0):t.off(!0))
},a.prototype.selectRow=function(e,s){var t=this.getCheckboxTree(e);"undefined"==typeof s&&(s=!t.checked),t&&(this.syncRow(e,s),this.onCountChange())},a.prototype.check=function(e,s){var t=s.value;if(t&&"0"!=t){var a=this.getCheckboxTree(t);if(e.shiftKey&&this.startRowId!==t){this.startRowId=this.startRowId||this.curRowId||this.rows[0].id;var i=this.getIDsRange(this.startRowId,t);this.syncRows(i,s.checked)}else a&&a.sync();this.curRowId||(this.curRowId=t,this.curRowIsFocused=!1),this.startRowId=t,this.getCount()>=3&&(this.promoHotkeysTimeout&&clearTimeout(this.promoHotkeysTimeout),this.promoHotkeysTimeout=setTimeout(function(){ns.action.run("trigger-hotkeys-promo-bubble",{eventName:"messages-check"}),this.promoHotkeysTimeout=null
},10))}else this.checkboxTree.sync(),this.startRowId=null;this.onCountChange()},a.prototype.toggleSelectAll=function(){this.checkbox.checked=!this.checkbox.checked,this.checkboxTree.sync(),this.startRowId=null,this.onCountChange()},a.prototype.deselect=function(){this.checkboxTree.off(!1),this.startRowId=null,this.onCountChange()},a.prototype._getId=function(e){return $(e.target).closest(".js-message").attr("data-id")},a.prototype.startMouseSelection=function(e,s){var t=this,a=this._getId(e);a&&(this.mouseMoveStartY=e.pageY,this.mouseMoveStartX=e.pageX,this.mouseMoveStartEvent=e,this.mouseMoveStartRowId=a,this.mouseMoveFlag=!this.getCheckboxTree(a).checked,this.mouseMoveIDs=null,this.$document.on("mousemove.table",function(e){t._onMousemove(e,s)
}).on("mouseup.table",this.stopMouseSelection.bind(this)))},a.prototype._onMousemove=function(e,s){var t=Math.abs(e.pageY-this.mouseMoveStartY),a=Math.abs(e.pageX-this.mouseMoveStartX),i=Math.sqrt(Math.pow(t,2)+Math.pow(a,2)),o=14;if(i>o){this.stopMouseSelection();var n=a/t;n>1&&s?(Jane.DragNDrop.setDragData((new Daria.DragMessage).init(this.mouseMoveStartEvent,$(e.target).closest(".js-message"))),Jane.DragNDrop.bindDragEvents()):this.$document.on("mousemove.table",this.doMouseSelection.bind(this)).on("mouseup.table",this.stopMouseSelection.bind(this))
}return!1},a.prototype.doMouseSelection=function(e){var s=this._getId(e);if(s){var t=this.getIDsRange(this.mouseMoveStartRowId,s);if(this.mouseMoveIDs){var a={};$.each(this.mouseMoveIDs,function(e){t[e]||(a[e]=1)}),this.syncRows(a,!this.mouseMoveFlag)}this.syncRows(t,this.mouseMoveFlag),this.mouseMoveIDs=t,this.startRowId=s,this.onCountChange()}return!1},a.prototype.stopMouseSelection=function(){return this.$document.off(".table"),!1},a.prototype.addToSelection=function(e){var s=this._getId(e);if(s)if(e.shiftKey){if(this.startRowId!==s){this.startRowId=this.startRowId||this.curRowId||this.rows[0].id;
var t=this.getIDsRange(this.startRowId,s),a=this.getCheckboxTree(s);this.syncRows(t,!a.checked),this.onCountChange()}}else this.selectRow(s)},a.prototype.startKeyboardSelect=function(){if(this.rows.length){this.keyboardStartRowId=this.curRowId||this.rows[0].id;var e=this.getCheckboxTree(this.keyboardStartRowId);this.keyboardFlag=!(!e||e.checked),this.keyboardIDs=null}},a.prototype.moveCurrentUp=function(e){if(this.curRowId){var s=this.getPrevRow(this.curRowId);if(s)return void this.moveCurrentTo(s.id,e,a.WITH_DELAY)
}this.rows.length&&this.moveCurrentTo(this.rows[0].id,e,a.WITH_DELAY)},a.prototype.moveCurrentDown=function(e){if(this.curRowId){var s=this.getNextRow(this.curRowId);if(s)return void this.moveCurrentTo(s.id,e,a.WITH_DELAY)}this.rows.length&&Daria.is2pane()&&ns.events.trigger("last-email-focused")},a.prototype.moveCurrentHome=function(e){this.rows.length&&this.moveCurrentTo(this.rows[0].id,e)},a.prototype.moveCurrentEnd=function(e){this.rows.length&&this.moveCurrentTo(this.rows[this.rows.length-1].id,e)
},a.prototype.moveCurrentTo=function(e,s,t){t=this.is3pane&&!s?t||a.ALLOW:a.DENY;var i=Jane.watcher.get("daria:selection-mode");if(i&&(t=a.DENY),e&&e!==this.curRowId){if(!this.is3pane||s||i||this.deselect(!0),this.curRowId&&this.unsetCurrent(this.curRowId),this.setCurrent(e),this.curRowId=e,s){var o=this.getIDsRange(this.keyboardStartRowId,e);if(this.keyboardIDs){var n={};$.each(this.keyboardIDs,function(e){o[e]||(n[e]=1)}),this.syncRows(n,!this.keyboardFlag)}this.syncRows(o,this.keyboardFlag),this.keyboardIDs=o,this.onCountChange()
}t!==a.DENY&&(t===a.ALLOW?this.openCurrent():this.openCurrentLazy())}},a.prototype.setCurrent=function(e,s){function t(e){return"undefined"==typeof e?a.$scrollArea.scrollTop():void($.isWindow(a.$scrollArea[0])?(a.$scrollArea.stop(!0),Jane.watcher.get("messages-context-menu:opened")||a.$scrollArea.animate({scrollTop:e},{duration:300,easing:"linear"})):a.$scrollArea.stop(!0).animate({scrollTop:e},{duration:300,easing:"linear"}))}var a=this;this.curRowIsFocused=!1;var i=this.getRow(e);if(i){var o=$(i.tr);
if(s||this.addVisualFocusTo(o),e===this.rows[0].id)return void t(0);var n=t(),r=o.offset().top;this.is3pane&&(r-=this.$scrollArea.offset().top,r+=n);var d=this.$scrollArea.height();r>n+d-this.paddingBottom?t(r-d+this.paddingBottom):r<n+this.paddingTop&&t(r-this.paddingTop)}},a.prototype.unsetCurrent=function(e){var s=this.getRow(e);s&&this.removeVisualFocusFrom(s.tr)},a.prototype.selectCurrent=function(e){if(this.curRowId){if(e){var s=$(e.target);s.hasClass("b-messages__message__checkbox__input")&&s.blur()
}this.selectRow(this.curRowId)}},a.prototype.isCurrentFocused=function(){return ns.Model.get("settings").getSetting("enable_hotkeys")&&this.curRowIsFocused},a.prototype.openCurrentLazy=function(){if(this.curRowId){Jane.watcher.get("daria:selection-mode")&&this.deselect();var e=this.getRow(this.curRowId);null!==e&&$(e.tr).trigger($.Event("click",{tableOpenCurrent:!0}))}}.lazy(250),a.prototype.openCurrent=a.prototype.openCurrentLazy.exec,a.prototype.moveCurrentToRoot=function(){if(this.curRowId){var e=this.getCheckboxTree(this.curRowId);
if(e){var s=e.root;s&&this.moveCurrentTo(s.id)}else this.curRowId=null}},a.prototype.addVisualFocusTo=function(e){this.curRowIsFocused=!0,$(e).addClass("b-messages__message_focus")},a.prototype.removeVisualFocusFrom=function(e){this.curRowIsFocused=!1,$(e).removeClass("b-messages__message_focus")},a.prototype.removeVisualFocusFromCurrent=function(){var e=this.getRow(this.curRowId);e&&this.removeVisualFocusFrom(e.tr)},a.initEvents=function(){a.prototype.$document=$(document),$("body").on("click",".b-messages-head__checkbox, .b-messages__message__checkbox__input",function(e){var s=a&&a.active;
s&&$(this).is(":visible")&&s.check(e,this),e.stopPropagation()}).on("mousedown",".js-message",function(e){return 1!=e.which||2==e.buttons?!1:"string"==typeof e.target.className&&e.target.className.indexOf("b-label")>-1?!0:(a.active.startMouseSelection(e,ns.Model.get("settings").isSet("dnd_enabled")),!1)})},$.extend(e.prototype,{toggleAllowFixedState:function(e){this.allowFixedState=!!e,this.updatePosition()},updatePosition:function(){var e=this.fixedState?this.$headlineClone:this.$headline,s=this.allowFixedState&&e.position().top<0;
this._toggleFixedState(s)},updateWidth:function(){this.fixedState&&this.$headline.css("width",this.$headlineClone.width())},_modifiedCssProps:Daria.array2obj(["left","top","width"],""),_toggleFixedState:function(e){if(e!==this.fixedState){var s=this.$headline,t=this.$scrollArea,a=this.$headlineClone;if(e){var i=t.position();s.replaceWith(a).css({left:i.left,top:0,width:a.width()}).addClass("b-messages-head_fixed").insertBefore(t)}else{var o=t[0].scrollTop;s.css(this._modifiedCssProps).removeClass("b-messages-head_fixed").replaceAll(a),t[0].scrollTop=o
}this.fixedState=e}},_bindEvents:function(){this.$scrollArea.scroll(this.updatePosition.bind(this))}}),ns.events.on("daria:vSetupOther:inboxattachs-changed",function(){ns.Model.invalidate("messages")})});