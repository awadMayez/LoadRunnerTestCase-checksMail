Jane.module("jane.setup.js",function(){"use strict";Daria.setup={},function(){var e=["forward","forwardwithstore","notify","reply"];ns.action.define("filters.edit",function(t,n){var i=n.$form.serializeObject();if(Daria.SetupFiltersCreate.processParams(i),n.isValid||Daria.SetupFiltersCreate.validate(n.$form,i)){if("on"==i.forward_with_store)for(var s=0,o=i.clicker.length;o>s;s++)i.clicker[s]="forward"==i.clicker[s]?"forwardwithstore":i.clicker[s];var a=function(e){return ns.forcedRequest([{id:"do-filters-edit",params:_.assign({},i,e)},{id:"filters"}])
},r=function(e){var t=_.find(e,"id","do-filters-edit");if(t){var i=t.get(".id");i?n.callback?n.callback(i):ns.page.go("#setup/filters"):Daria.Statusline.showMsg({body:"Произошла ошибка"})}},l=function(){Daria.Statusline.showMsg({body:"Произошла ошибка"})},d=!1,c=ns.Model.get("filters").getById(i.id);c&&(d=c.actions.some(function(t){return _.contains(e,t.type)})),d||(d=!_.isEmpty(_.intersection($.makeArray(i.clicker),e))),d?_.defer(function(){ns.events.trigger("vSetupFiltersCreate:needEnterPassword",{action:a,onSuccess:r,onError:l})
}):a().then(r,l)}}),ns.action.define("filters.apply",function(e,t){var n=t.filterId;(Daria.IS_CORP||ns.Model.get("filters").isApplyAvailable())&&ns.request(["filters-apply"],{id:n}).then(function(e){e[0].error?t.$form.find(".js-preview-list-box").text("Произошла ошибка"):(ns.Model.invalidate("folders"),ns.Model.invalidate("messages"),ns.Model.invalidate("message-nearest"),ns.Model.invalidate("message-thread-nearest"),ns.page.go("#setup/filters").then(function(){Daria.Statusline.showMsg({name:"filters-apply",speed:"fast",body:"Фильтр применён"})
}))})}),ns.action.define("filters.show-filter-name",function(e,t,n,i){var s={event:i,params:t};$(s.event.target).closest(".b-form-layout__block").addClass("g-hidden").next(".b-form-layout__block").removeClass("g-hidden").find(".b-form-element__input-text").focus()}),ns.action.define("filters.accept-email",function(e,t,n,i){var s={event:i,params:t},o=$(s.event.currentTarget).find(".b-settings-field__confirm-filter");ns.forcedRequest(["do-filters-accept-email"],{e:ns.page.current.params.e}).then(function(e){var t=jpath(e,'/.handlers[.name == "do-filters-accept-email"].error.data[.status == "error"]')[0];
o.addClass(t?"b-settings-field__confirm-filter_error":"b-settings-field__confirm-filter_on"),o.removeClass("b-settings-field__confirm-filter_off")})})}(),function(){ns.action.define("filters.lists-add-from-message",function(e,t){t||(t=e.params);var n=t.email;if(n){var i=["do-filters-"+t.listtype+"list-add","filters-blacklist","filters-whitelist"],s=t.listtype,o="filters-"+("black"===s?"blacklist":"whitelist"),a="filters-"+("black"===s?"whitelist":"blacklist"),r=ns.Model.get("account-information").getEmails();
return $(document).trigger("b-mail-dropdown-closeall"),-1!==$.inArray(n,r)?void Daria.Statusline.showMsg("black"===s?{name:"setup.filters-blist-add-self-forbidden",body:"Произошла ошибка. Нельзя добавить свой адрес в чёрный список."}:{name:"setup.filters-wlist-add-self-forbidden",body:"Произошла ошибка. Нельзя добавить свой адрес в белый список."}):void ns.forcedRequest(["filters-blacklist","filters-whitelist"],{}).then(function(){ns.Model.get(o).hasEmail(n)?Daria.Statusline.showMsg({name:"setup.filters-lists-add-from-message",body:"black"===s?"Этот адрес уже есть в чёрном списке. Если вы продолжаете получать письма с него, сообщите об этом в службу поддержки.":"Этот адрес уже есть в белом списке. Если письма с него продолжают приходить в папку «Спам», пожалуйста, сообщите об этом в службу поддержки."}):ns.Model.get(a).hasEmail(n)?Daria.Dialog.confirm({body:"black"===s?"<p>Вы хотите добавить в чёрный список адрес из белого списка. После добавления адрес "+n+" будет заблокирован, и вы перестанете получать с него письма. Продолжить?</p>":"<p>Вы хотите добавить в белый список адрес из чёрного списка. После добавления адрес "+n+" будет разблокирован, и вы начнёте получать с него письма. Продолжить?</p>",width:350,okValue:"Да",cancelValue:"Нет",okHandler:function(){i.push("do-filters-"+("black"===s?"white":"black")+"list-remove"),"black"===t.listtype?Daria.Filter.appendEmailBlackList(n):Daria.Filter.appendEmailWhiteList(n)
}}):"black"===t.listtype?Daria.Filter.appendEmailBlackList(n):Daria.Filter.appendEmailWhiteList(n)})}})}(),ns.action.define("folders.add.filters",function(e,t){var n=Vow.promise(),i=Daria.FolderCreatePopup(t);return $.extend(i,{success:function(e){n.fulfill({id:e,name:i.folderName})},context:$(Jane.tt("setup:js-setup-folders-dialog-folder-create")),filter:!1}),i.init(),n}),ns.action.define("header.update-default-email",function(e,t){var n=t.email||ns.Model.get("settings").getSetting("default_email");
n&&($(".js-header-user-name").text(n),$(".js-messages-title-dropdown-name").text(n))}),ns.action.define("labels.add.filters",function(e,t){var n=Daria.LabelCreatePopup(t),i=Vow.promise();return no.extend(n,{context:$(Jane.tt("setup:js-setup-folders-dialog-label-create",{},["labels-colors"])),filter:!1,success:function(e){i.fulfill({id:e,name:n.labelName})}}),n.init(),i}),ns.action.define("folders.move-in-folder",function(e,t,n){var i=$(n||t.$target);i.closest(".b-folders_dropdown").find(".b-folders__folder_current").removeClass("b-folders__folder_current"),i.closest(".b-folders__folder").addClass("b-folders__folder_current"),t.fid?$(".js-selink__folder").attr("data-fid",t.fid).text('внутри папки "'+t.name+'"'):$(".js-selink__folder").removeAttr("data-fid").text("Не вкладывать"),ns.action.run("dropdown.close-current")
}),borschik.addLinks({"3pane-example-horizontal-en.png":"//yastatic.net/mail/_/xmRjxWyYvYzX5aRtoLK7Fkt_P0s.png","3pane-example-horizontal-ru.png":"//yastatic.net/mail/_/NiDC7R2S0TwH38mCwk7scakJMTk.png","3pane-example-vertical-en.png":"//yastatic.net/mail/_/7v2NZySZQr5wRrfR0_WinWnGuNw.png","3pane-example-vertical-ru.png":"//yastatic.net/mail/_/y8lzvINuXDFnwTCGmEuSYqHxBCY.png"}),function(){ns.layout.define("setup",{"app messages-direct-box@":{},"app left-box@":{"setup-left":{}},"app right-box@":function(e){var t={},n=e.tab||"index";
return t["setup-"+n]={},"filters-create"===n&&(t["setup-"+n]["messages-preview-box@"]={"messages-preview":{}}),Daria.DEBUG&&console.warn("Эту бизнес-логику нужно вынести отсюда!!!"),Daria.indexer.reindexUser(-1!==n.indexOf("filters")),t},"app toolbar-box@":{}},"common"),ns.layout.define("setup-collector",{"app right-box@":{"setup-collector":{}}},"setup"),ns.layout.define("setup-sender",{"app right-box@":{"setup-sender":function(e){var t={};Daria.Config["pdd-domain"]||Daria.IS_CORP||(t["setup-avatar-setup"]={});
var n=Daria.signs.count()<2;return e["signature-sample"]=Daria.signs.sample(),n&&(e["signature-sample"]?Jane.c("Настройки","Отправитель","Промо подписей","Показ"):Jane.c("Настройки","Отправитель","Промо подписей","Показ с примером"),t["signature-promo"]={}),t}}},"setup")}(),function(){function e(e,t){var n=e.getSource().length;e.addToSource(t,n-1)}Daria.FolderEditPopup=function(e){var t=Daria.Folder(e),n=e.id,i=ns.Model.get("folders").getFolderById(n),s=i.parent_id;return $.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-folder-edit",{fid:n,filter:null,withoutSubfolderDialog:!0},["folders"])),create:function(e){var t=this;
ns.forcedRequest([{id:"do-folder-rename",params:{fname:this.folderName,fid:n,parent_id:s}},{id:"folders"}]).then(function(){$.isFunction(e)&&e(n),$.isFunction(t.success)&&(t.success(n,t.folderName),ns.Model.get("folders").trigger("daria:mFolders:rename"))})},open:function(){var e=this;Daria.Dialog.open({title:"Переименовать папку",body:this.context,buttons:[{name:"submit",value:"Сохранить",onclick:this.onCreate.bind(this)},{name:"cancel"}],width:432,onopen:function(){e.input.focus(),e.input.keyup()
}}),$(document).trigger("b-mail-dropdown-closeall")}}),t},function(){var e=function(e){var t=$.Deferred();["folders","labels","messages","message-nearest","message-thread-nearest"].forEach(function(e){ns.Model.invalidate(e)});var n=[{id:"do-folder-clear",params:e},{id:"folders"},{id:"labels"}];return"messages"===ns.page.current.page&&n.push({id:"messages",params:ns.page.current.params}),ns.forcedRequest(n).then(function(){t.resolve(e.fid)},function(){t.reject(e.fid)}),t.promise()};Daria.FolderClearPopup=function(t){var n=Daria.Folder(t);
return $.extend(n,{context:t.template,init:function(){var n=this,i=null;if(t.targetOffset){var s=$(".js-layout-left");i={x:s.offset().left+s.width(),y:t.targetOffset,side:"left",pos:"top"}}Daria.Dialog.confirm({title:"Очистка папки",body:t.template,nbInit:!0,onTarget:i,width:455,okValue:"Очистить",onopen:function(e){e.$body.on("click",".js-filter-open,.js-filter-close",function(e){$(e.target).closest(".js-popup").find(".js-teaser-toggle,.js-extra-toggle").toggleClass("g-hidden")})},onclose:function(e){e.$body.off("click",".js-filter-open,.js-filter-close")
},okHandler:function(){var i,s,o=$(this.body),a=o.find(".nb-checkbox");a.each(function(e){var t=nb.block(a[e]);return t&&t.isChecked()?void(s=t):void 0}),i="extended"!==t.type||ns.Model.get("folders").isFolder(t.fid,["trash"])?{method:"purge",fid:t.fid}:{method:s?s.getValue():"",fid:t.fid,old_f:nb.$block(".js-old_f",o).getState().value,from_f:nb.$block("#from_f",o).getValue(),subj_f:nb.$block("#subj_f",o).getValue()};var r=e(i);$.isFunction(n.onsuccess)&&r.done(n.onsuccess),$.isFunction(n.onerror)&&r.fail(n.onerror)
}})}}),n},Daria.setup.doFolderClear=e}(),Daria.FolderCreatePopup=function(e){e=e||{};var t=Daria.Folder(e);return $.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-folder-create",{filter:null,folders:ns.Model.get("folders").getData(),isFolderPopup:!0,withoutSubfolderDialog:e.withoutSubfolderDialog})),create:function(t,n,i){var s=this,o=this.folderName,a=null===i||i?i:e.parent_id;ns.forcedRequest([{id:"do-folders-add",params:{folder_name:o,parent_id:a}},{id:"folders"}]).then(function(){var e,n=ns.Model.get("folders");
e=a!==n.getFolderBySymbol("inbox").fid?n.getFolderByName(o,a):n.getFolderByName(o),$.isFunction(t)&&t(e.fid),$.isFunction(s.success)&&s.success(e.fid)},function(){$.isFunction(n)&&n.call(s)})},open:function(){var t=this;Daria.Dialog.open({title:"Создаём папку",body:this.context,buttons:[{name:"submit",value:"Создать папку",onclick:function(){Jane.c(["Поп-ап создания папки","клик по создать"]),t.onCreate()}},{name:"cancel"}],width:432,oncancel:function(){Jane.c(["Поп-ап создания папки","клик по отменить"])
},onopen:function(){if(Jane.c(["Поп-ап создания папки","показ поп-апа"]),t.input.keyup(),t.input.focus(),!e.withoutSubfolderDialog&&e.parent_id){var n=$(".js-popup:visible .js-folders-list .folder-"+e.parent_id);n.length&&ns.action.run("folders.move-in-folder",{$target:n,fid:e.parent_id,name:n.find(".js-folder-name").text()})}e["no-dialog"]&&(e.name&&!t.folderName&&t.setName(e.name),t.onCreate())}}),$(document).trigger("b-mail-dropdown-closeall")}}),t},Daria.FolderCreateContext=function(e){var t=Daria.FolderCreatePopup(e),n=e.filter?{filter:null}:{};
return n.folders=ns.Model.get("folders").getData(),n.isFolderPopup=!0,$.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-folder-create",n)),onCreate:function(){var e=this,t=$.Deferred(),n=function(e,n){t.reject(n)};return ns.events.on("folder.error",n),t.always(function(){ns.events.off("folder.error",n)}),this.validate()&&this.create(function(n){e.filter&&(e.filter.params.move_folder=n,e.filter.create()),t.resolve(n)},function(e){var t=jpath(e,".error.code")[0],n=1e3==t?"Невозможно создать папку «"+this.folderName+"», так как это имя является системным. Придумайте другое.":"При создании папки произошла ошибка.";
ns.events.trigger("folder.error",n)},e.parent_folder.data("fid")),t},open:function(){e.parent.html(this.context),this.input.keyup(),this.input.focus()},success:function(){ns.page.refresh()}}),t},function(){var e=function(){this.type=""};e.prototype.bindEvents=function(){var e=this,t=function(t){e.onClick(t)};this.container.click(t),this.unbindEvents=function(){this.container.unbind("click",t)}},e.prototype.unbindEvents=function(){},e.prototype.onClick=function(e){var t=this.getTarget(e);e.target.getAttribute("disabled")||t in this&&this[t](e)
},e.prototype.default_tests=[["selectItem",".b-folder-list-item *, .b-folders__folder *"],["deleteItem",".nb-button[data-click-action=delete]"],["emptyItem",".nb-button[data-click-action=empty]"],["createSubfolder",".nb-button[data-click-action=subfolder]"],["editItem",".nb-button[data-click-action=edit]"],["addFilter",".nb-button[data-click-action=filter]"]],e.prototype.tests=[],e.prototype.getTarget=function(e){for(var t in this.tests)if($(e.target).is(this.tests[t][1]))return this.tests[t][0]},e.prototype.selectItem=function(e){e.preventDefault(),e.stopPropagation();
var t=$(e.target).closest(".b-folder-list-item, .b-folders__folder"),n=ns.action.getParams(t[0]);this.selectedItem&&$(".item-"+this.selectedItem,this.container).removeClass("b-folders__folder_current b-folder-list-item_selected"),this.selectedItem=n.id,t.addClass("b-folders__folder_current b-folder-list-item_selected"),this.updateButtons(n)},e.prototype.deselectAll=function(){this.selectedItem&&$(".item-"+this.selectedItem,this.container).removeClass("b-folders__folder_current b-folder-list-item_selected"),delete this.selectedItem,this.updateButtons({})
},e.prototype.init=function(){this.bindEvents(),this.tests=this.tests.concat(this.default_tests)},e.prototype.deleteItem=function(e){e.preventDefault(),e.stopPropagation(),ns.action.run(this.type+".remove",{id:this.selectedItem})},e.prototype.editItem=function(e){e.preventDefault(),e.stopPropagation(),ns.action.run(this.type+"s.edit",{id:this.selectedItem})},e.prototype.addFilter=function(e){e.preventDefault(),e.stopPropagation(),ns.action.run(this.type+".filter",{id:this.selectedItem})},e.prototype.updateButtons=function(e){var t=Number(e.editable)&&!e.shared;
$("[data-click-action=edit], [data-click-action=subfolder]",this.container).each(function(){var e=nb.block(this);t?e.enable():e.disable()});var n=Number(e.editable)&&!e.shared;$("[data-click-action=delete]",this.container).each(function(){var e=nb.block(this);n?e.enable():e.disable()});var i=Number(e.count)>0&&!e.shared;$("[data-click-action=empty]",this.container).each(function(){var e=nb.block(this);i?e.enable():e.disable()});var s=Number(e.filterable)&&!e.shared;$("input[data-click-action=filter]",this.container).each(function(){var e=nb.block(this);
s?e.enable():e.disable()})},Daria.ItemsListManager=e}(),Daria.FoldersListManager=function(e){this.type="folder",this.container=e,this.init()},no.inherit(Daria.FoldersListManager,Daria.ItemsListManager),Daria.FoldersListManager.prototype.tests=[],Daria.FoldersListManager.prototype.emptyItem=function(){var e=$(".fid-"+this.selectedItem,this.container),t=Daria.parseQuery($(e[0]).data("params")),n=this.container.find(".js-clear-button"),i=Daria.parseQuery($(n[0]).data("params"));$.extend(t,i),ns.action.run("folder.clear",{fid:t.id,type:t.type})
},Daria.FoldersListManager.prototype.createSubfolder=function(){ns.action.run("folders.add",{parent_id:this.selectedItem,withoutSubfolderDialog:!0})},Daria.FoldersListManager.prototype.updateButtons=function(e){var t=Number(e.editable)&&!e.shared;$.each(["setup-folders-edit","setup-folders-subfolder"],function(e,n){var i=nb.find(n);i&&(t?i.enable():i.disable())});var n=(Number(e.editable)||Number(e.removable))&&!e.shared,i=nb.find("setup-folders-delete");i&&(n?i.enable():i.disable());var s=Number(e.count)>0&&!e.shared,o=nb.find("setup-folders-empty");
o&&(s?o.enable():o.disable());var a=Number(e.filterable)&&!e.shared,r=nb.find("setup-folders-filter");r&&(a?r.enable():r.disable())},Daria.LabelsListManager=function(e){this.type="label",this.container=e,this.init()},no.inherit(Daria.LabelsListManager,Daria.ItemsListManager),Daria.LabelsListManager.prototype.sort=function(e){ns.Model.get("settings").setSettings({label_sort:"by_"+("name"==e?"abc":"count")},function(){ns.forcedRequest(["labels"],{})});var t,n=$(".b-folder-list_labels .b-folder-list-item",this.container),i=$(".b-folder-list_labels",this.container);
t="count"===e?function(e,t){return ns.action.getParams(t).count-ns.action.getParams(e).count}:function(e,t){return $(".b-label",e).text().toLowerCase()<$(".b-label",t).text().toLowerCase()?-1:1},n=n.sort(t),n.each(function(){i.append(this)})},Daria.LabelsListManager.prototype.updateButtons=function(e){var t=Number(e.editable)&&!e.shared,n=nb.find("setup-labels-edit");n&&(t?n.enable():n.disable());var i=Number(e.editable)&&!e.shared,s=nb.find("setup-labels-delete");s&&(i?s.enable():s.disable());var o=Number(e.filterable)&&!e.shared,a=nb.find("setup-labels-filter");
a&&(o?a.enable():a.disable())},Daria.Label=function(e){function t(e){return parseInt(e,16)}e=e||{};var n="boolean"==typeof e.hotkey?e.hotkey:!0;return{validate:function(){if(!this.labelName)return ns.events.trigger("label.error","Поле не заполнено."),!1;var t=ns.Model.get("labels"),n=t.getLabelBySymbolicName("important_label")||{};if(n.name===this.labelName)return ns.events.trigger("label.error","Невозможно создать метку «"+this.labelName+"», так как это имя является системным. Введите другое имя."),!1;
var i=t.getUserLabelByName(this.labelName);if(i&&i.lid!=e.id){var s=i.symbol||i.social?"Невозможно создать метку «"+this.labelName+"», так как это имя является системным. Введите другое имя.":"Метка с таким именем уже существует. Введите другое имя.";return ns.events.trigger("label.error",s),!1}return!0},setName:function(e){this.labelName=e,ns.events.trigger("label.name-changed",e)},setColor:function(e){this.color=e,this.colorId=t(e),ns.events.trigger("label.color-changed",e)},bindEvents:function(){var e=this,t=this.context.find(".b-teaser"),i=this.context.find(".b-form-layout_filters-simple");
this.colors=this.context.find(".b-label"),this.filter&&(this.filter.form=i.find("form"));var s={cls:"b-popup__field_error",active:!1,show:function(t){this.notification=e.context.find(".b-notification__text"),this.row=this.notification.closest(".b-table"),t&&(this.notification.text(t),this.row.addClass(this.cls),this.active=!0)},hide:function(){this.row.removeClass(this.cls),this.active=!1,ns.events.trigger("label.error.hide")}};ns.events.on("label.error",function(t,n){s.show(n),e.input.focus()}),ns.events.on("label.name-changed",function(t,n){e.example.toggle(!!n).html(_.escape(n))
}),ns.events.on("label.color-changed",function(t,n){e.example||(e.example=$(Jane.tt("setup:label-sample")),e.context.closest(".b-popup").find(".b-popup__header").append(e.example)),e.example.css({background:"#"+n})}),this.context.on("click",".js-filter-open",function(){Jane.c(["Промо меток","Новый поп-ап меток","клик на фильтры"]),t.fadeOut(150,function(){i.fadeIn(200,function(){var e=i.find("input:visible").eq(0).focus(),t=Daria.Autocompleter.getContact();t.setOptions({multiple:!1,formatResult:function(e){if(e.contacts){for(var t=[],n=0,i=e.contacts.length;i>n;n++)t.push(e.contacts[n].email);
return t.join(", ")}return e.email}}),t.bindField({field:e,focus:1}),ns.events.trigger("label.filter.toggle",!0)})})}),this.context.on("click",".js-filter-close",function(){Jane.c(["Промо меток","Новый поп-ап меток",'клик по "свернуть"']),i.fadeOut(150,function(){t.fadeIn(200,function(){e.input.focus(),ns.events.trigger("label.filter.toggle",!1)})})}),this.context.on("click",".js-filter-link",function(){return Jane.c(["Промо меток","Новый поп-ап меток",'клик по "сложным условиям"']),e.onCreate(function(){e.filter=!1,e.success=function(){ns.page.go("#setup/filters-create/label="+e.labelName)
}}),!1}),this.context.on("keyup",".js-input-name",function(t){var i=$.trim(this.value).replace(/\u0020/g," ");i!=e.labelName&&s.active&&s.hide(),e.setName(i),13===t.which&&n&&e.onCreate()}),this.context.on("click",".js-label-sample",function(){var t=$(this),n=Daria.parseQuery(t.attr("data-params"));e.colors.removeClass("b-label_current"),t.addClass("b-label_current"),e.setColor(n.color)})},filter:Daria.FilterSimpleCreatePopup(),onCreate:function(e){var t=this;this.validate()&&(Daria.Dialog.close(),$.isFunction(e)&&e(),this.create(function(){t.filter&&(Jane.c(["Промо меток","Новый поп-ап меток","создание метки с настроенным фильтром"]),t.filter.params.move_label=ns.Model.get("labels").getLIDByName(t.labelName),t.filter.label_name=t.labelName,t.filter.create())
},function(e){var t,n=jpath(e,".error.code")[0];t=1e3==n?"Невозможно создать метку «"+this.labelName+"», так как это имя является системным. Введите другое имя.":"При создании метки произошла ошибка.",ns.events.trigger("label.error",t)}))},init:function(){this.input=$("input[name=label_name]",this.context),e.name&&this.input.val(e.name),this.bindEvents(),this.open()}}},Daria.Label.remove=function(e){var t=ns.Model.get("labels").getLabelById(e),n=_.escape(t.name),i=Number(t.count),s=[],o=[],a=[],r=ns.Model.get("filters").getForLabel(e);
$.map(r,function(e){jpath(e,'.condition[.div == "X-yandex-rpop-id"]').length?a.push(e):o.push(e)});var l=o.length,d=a.length,c=function(t){ns.forcedRequest([{id:"do-labels-delete",params:{lids:e,force:t?"yes":""}},{id:"labels"}]).then(function(){ns.page.current.params.current_label===e&&ns.page.go(ns.router.generateUrl("messages",{current_folder:ns.Model.get("folders").getFidBySymbol("inbox")})),ns.events.trigger("daria:label-remove-done",e)},function(){ns.events.trigger("daria:label-remove-fail",e)
})},u=function(){for(var e=[],t=0;l>t;t++){var n=o[t],i=n.filid,a=_.escape(n.name);e.push('— «<a href="#setup/filters-create/id='+i+'">'+a+"</a>»<br/>"),s.push(i)}return e.join("")},f=[],h="Удалить метку";i&&l?(f.push("<p>Метка «"+n+"» присвоена "+Jane.i18n.convert([i+" письму",i+" письмам",i+" письмам"],i)+" и&#160;используется "+Jane.i18n.convert(["правилом","правилами","правилами"],l)+":</p>"),f.push(u()),f.push("<p>Удаление метки вызовет и&#160;удаление "+Jane.i18n.convert(["правила","правил","правил"],l)+". Отредактировать "+Jane.i18n.convert(["правило","правила","правил"],l)+' можно <a href="#setup/filters">в&#160;настройках</a>.</p>'),h="Удалить метку и "+Jane.i18n.convert(["правило","правила","правил"],l)):i?f.push("<p>Вы действительно хотите удалить метку «"+n+"» (содержит "+Jane.i18n.convert(["одно письмо",i+" письмо",i+" письма",i+" писем"],i)+")?</p>"):l&&(f.push("<p>Метка используется "+Jane.i18n.convert(["правилом","правилами","правилами"],l)+":</p>"),f.push(u()),f.push("<p>Отредактировать "+Jane.i18n.convert(["правило","правила","правил"],l)+' можно <a href="#setup/filters">в&#160;настройках</a>.</p>'),h="Удалить метку и "+Jane.i18n.convert(["правило","правила","правил"],l)),d&&f.push("<p>"+Jane.i18n["if"](i||l,"Также метка","Метка")+" используется "+Jane.i18n.convert(["сборщиком","сборщиками","сборщиками"],d)+'. Отредактировать сборщик можно <a href="#setup/collectors">в&#160;настройках</a>.</p>'),i||l||d?Daria.Dialog.confirm({title:"Удаление метки",width:400,body:f.join(""),okValue:h,okHandler:function(){if(c(!0),l||d){var t=ns.Model.get("filters").getForLabel(e);
$.map(t,function(e){Daria.Filter.removeById(e.filid)})}}}):c()},Daria.Label.createFilter=function(e){var t=ns.Model.get("labels").getLabelById(e),n="important_label"==t.symbolicName?e:t.name,i=$(Jane.tt("setup:js-setup-folders-dialog-label-filter",{name:n,id:e,single:null}));i.on("click",".js-filter-link",function(){Jane.c(["Новый поп-ап фильтров","метка","клик на подробные условия"])});var s=Daria.FilterSimpleCreatePopupSingle({form:i.find("form")}),o=Vow.promise();return Daria.Dialog.open({title:"На какие письма ставить эту метку?",body:i,buttons:[{name:"submit",value:"Создать правило",onclick:function(){Jane.c(["Новый поп-ап фильтров","метка","клик по создать"]),s.create().then(function(){o.fulfill()
})}},{name:"cancel"}],oncancel:function(){Jane.c(["Новый поп-ап фильтров","метка","клик по отменить"])},width:432,onopen:function(){Jane.c(["Новый поп-ап фильтров","метка","показ поп-апа для создания фильтра на метку"]),i.find("input[name=field3]:eq(0)").focus(),s.bindAutocompleter()}}),o},Daria.LabelEditPopup=function(e){e=e||{};var t=Daria.Label(e),n=e.id,i=ns.Model.get("labels").getLabelById(n).color;return $.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-label-edit",{lid:n,filter:null},["labels-colors","labels"])),create:function(e){var t=this;
ns.forcedRequest([{id:"do-label-edit",params:{lid:n,label_name:this.labelName,label_color:this.colorId}},{id:"labels"}]).then(function(){$.isFunction(e)&&e(n),$.isFunction(t.success)&&(t.success(n),ns.Model.get("labels").trigger("daria:mLabels:rename"))})},open:function(){var e=this;Daria.Dialog.open({title:"Изменить метку ",body:this.context,buttons:[{name:"submit",value:"Сохранить",onclick:this.onCreate.bind(this)},{name:"cancel"}],width:432,onopen:function(){e.colors.filter("[data-params*="+i+"]").click(),e.input.keyup(),e.input.focus()
}}),$(document).trigger("b-mail-dropdown-closeall")}}),t},Daria.LabelCreatePopup=function(e){e=e||{};var t=Daria.Label(e);return no.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-label-create",{filter:null},["labels-colors"])),create:function(e,t){var n=this,i=this.labelName;ns.forcedRequest([{id:"do-labels-add",params:{label_name:i,label_color:this.colorId}},{id:"labels"}]).then(function(t){var i=t[0].data.body.updated,s=ns.Model.get("labels").getLabelById(i);$.isFunction(e)&&e(s.lid),$.isFunction(n.success)&&n.success(s.lid)
},function(e){$.isFunction(t)&&t.call(n,e.invalid[0].getError())})},open:function(){var t=this;Daria.Dialog.open({title:"Создаём метку ",body:this.context,buttons:[{name:"submit",value:"Создать метку",onclick:function(){Jane.c(["Промо меток","Новый поп-ап меток","клик по создать"]),t.onCreate()}},{name:"cancel"}],width:432,oncancel:function(){Jane.c(["Промо меток","Новый поп-ап меток","клик по отменить"])},onopen:function(){t.colors.eq(0).click(),t.input.keyup(),t.input.focus(),e.name&&e.color&&t.onCreate(),$.isFunction(t.onopen)&&t.onopen(),Jane.c(["Промо меток","Новый поп-ап меток","показ поп-апа"])
},close:function(){$.isFunction(t.onclose)&&t.onclose()}}),$(document).trigger("b-mail-dropdown-closeall")}}),t},Daria.LabelCreateContext=function(e){var t=Daria.LabelCreatePopup(e),n=e.filter?{filter:null}:{};return $.extend(t,{context:$(Jane.tt("setup:js-setup-folders-dialog-label-create",n,["labels-colors"],{})),onCreate:function(){var e=this,t=$.Deferred(),n=function(e,n){t.reject(n)};return ns.events.on("label.error",n),t.always(function(){ns.events.off("label.error",n)}),this.validate()&&this.create(function(n){e.filter&&(e.filter.params.move_label=n,e.filter.create()),t.resolve(n)
},function(e){var t=jpath(e,".error.code")[0],n=1e3==t?"Невозможно создать метку «"+this.labelName+"», так как это имя является системным. Введите другое имя.":"При создании метки произошла ошибка.";ns.events.trigger("label.error",n)}),t},open:function(){e.parent.html(this.context),this.colors.eq(0).click(),this.input.keyup(),this.input.focus(),$.isFunction(this.onopen)&&this.onopen()},success:function(){ns.page.refresh()}}),t},Daria.Filter={},Daria.Filter._listOfYandexEmails={"partner@market\\.(yandex|ya)\\.":{name:"Маркет",unsubscribeLink:"http://market.yandex.ru/mail-settings.xml"},"hello@money\\.(yandex|ya)\\.":{name:"Деньги",unsubscribeLink:"https://sp-money.yandex.ru/tunes.xml?from=bal"},"([\\s\\S])@yandex-team\\.":{},"devnull@(yandex|ya)\\.":{},"support@(yandex|ya)\\.":{},"abo-dev@(yandex|ya)\\.":{},"hello@(yandex|ya)\\.":{},"subscriptions-no-reply@(yandex|ya)\\.":{}},Daria.Filter.checkYandexEmail=function(e){for(var t in Daria.Filter._listOfYandexEmails)if(Daria.Filter._listOfYandexEmails.hasOwnProperty(t)){var n=Daria.Filter._listOfYandexEmails[t],i=new RegExp(t+"(ru|by|com|kz|ua|com\\.tr|com\\.ua)","i");
if(i.test(e)){if(n.unsubscribeLink){var s=ns.Model.get("account-information").getData().login;n.unsubscribeLink=n.unsubscribeLink.replace("{LOGIN}",s)}return n}}return!1},Daria.Filter.appendEmailWhiteList=function(e){return Daria.Filter.appendEmailToList({baseHandler:"filters-whitelist",antiHandler:"filters-blacklist"},e)},Daria.Filter.appendEmailBlackList=function(e){return Daria.Filter.appendEmailToList({baseHandler:"filters-blacklist",antiHandler:"filters-whitelist",needYandexEmailsCheck:!0},e)
},Daria.Filter.appendEmailToList=function(e,t){var n=$.Deferred();if(!t)return n.reject("required");if(!Jane.FormValidation.checkEmail(t))return n.reject("pattern");var i=[],s=ns.Model.get(e.baseHandler).get(".addresses"),o=ns.Model.get(e.antiHandler).get(".addresses");i.push({id:"do-"+e.baseHandler+"-add",params:{email:t}}),i.push({id:e.baseHandler});var a=ns.Model.get("account-information").getEmails();if(-1!==a.indexOf(t))return n.reject("own-email");if(-1!==s.indexOf(t))return n.reject("already");
if(-1!==o.indexOf(t))return n.progress(function(s){"ok"===s&&(i.push({id:"do-"+e.antiHandler+"-remove",params:{email:t}}),i.push({id:e.antiHandler}),ns.forcedRequest(i).then(n.resolve,n.reject))}),n.notify("already-in-anti");if(e.needYandexEmailsCheck){var r=Daria.Filter.checkYandexEmail(t);if(r!==!1)return n.progress(function(e){"ok"===e&&ns.forcedRequest(i).then(n.resolve,n.reject)}),n.notify("is-yandex-email",r)}return ns.forcedRequest(i).then(n.resolve,n.reject),n.promise()},Daria.Filter.removeById=function(e){var t=$.Deferred();
return ns.forcedRequest([{id:"do-filters-delete",params:{id:e}},{id:"filters"}]).then(t.resolve,t.reject),t.promise()},function(){Daria.Collector={},Daria.Collector.remove=function(e){var t=e.popid;Daria.Dialog.confirm({title:"Удаление сборщиков",body:"<p>Вы действительно хотите удалить сборщик «"+_.escape(e.email)+"»?</p>",width:350,okValue:"Удалить",okHandler:function(){ns.forcedRequest([{id:"do-collector-remove",params:e},{model:ns.Model.get("collectors").getMasterRequest()}]).then(function(){var e=Vow.resolve(),n=ns.Model.get("filters").getForCollector(t),i=_.map(n,function(e){return{id:"do-filters-delete",params:{id:e.filid}}
});i.length&&(e=ns.forcedRequest([].concat(i,[{model:ns.Model.get("filters").getMasterRequest()}]))),e.then(function(){if(/^setup/.test(ns.page.current.page)){var e=ns.router.generateUrl("setup",{tab:"collectors"});ns.page.go(e)}else ns.page.refresh()})})}})}}(),function(e){function t(e){e.data("settings",this),this.node=e;var t=this;this.getControl("login").on("nb-changed",function(){t.validate(this.getName())}),this.getControl("password").on("nb-changed",function(){t.validate(this.getName())}),this.getControl("server").on("nb-changed",function(){t.validate(this.getName())
});var n=this.getControl("port");n.on("input",function(){var e=n.getValue(),t=e.replace(/\D/g,"");e.length!==t.length&&n.setValue(t)}),n.on("nb-changed",function(){t.validate(this.getName())}),this.getControl("email").on("nb-changed",function(){t.validate(this.getName()),t.onSettingsChange(!0).always(function(){ns.events.trigger("daria:CollectorSettings:form-type-changed",t.isAdvanced)})}),this.getControl("use_ssl").on("nb-changed",function(){t.onSettingsChange()}),this.getControl("protocol").on("nb-changed",function(){var e="imap"===this.getState().value,n=t.getControl("move_folder"),i=t.getControl("use_ssl");
e?(i&&i.check(),n&&n.disable()):n&&n.enable(),t.onSettingsChange()}),this.updateSSLOption(),this.updateNoDeleteMsgOption()}var n=!1,i=function(e,t,n,i){switch(t){case"loading":return"Проверка соединения...";case"success":return"Соединение установлено.";case"fail":return"Такого сервера нет или к нему не удалось подключиться.";case"tries_exceeded":return"Не удалось подключить сборщик писем. Почта напомнит вам настроить его позже";case"auth_failed":var s=n&&n.split("@")[1],o=(i||"").toUpperCase();return"gmail.com"===s?e?"Ошибка. Проверьте адрес и пароль. Также в подключаемом ящике должен работать доступ по "+o:'Не удалось подключиться к ящику. Проверьте введённый адрес и пароль.<br /> Если вы уверены в их правильности, убедитесь, что в подключаемом ящике у вас активирован <a target="_blank" href="https://mail.google.com/mail/#settings/fwdandpop">доступ по протоколу '+o+"</a>.":"Сервер не отвечает, либо введен неверный логин или пароль.";
case"this_server_belongs_to_yandex":return e?"Пожалуйста, введите адрес, откуда вы хотите собирать письма в Яндекс.Почту.":'Вы пытаетесь создать сборщик почты для текущего почтового ящика.&#160;<p class="b-notification__note">Для сортировки входящей почты в ящиках логин@yandex.ru, логин@yandex.ua, логин@yandex.com и логин@ya.ru используйте&#160;<a href="#setup/filters">фильтры</a>.</p>';case"duplicated":return"Сборщик почты с сервера "+n+" для логина "+i+" уже существует.";default:return""}},s=function(e,t,n,s){var o,a,r,l,d,c;
return"string"==typeof e&&(s=n,n=t,t=e,e=null),e=e||document,l=$(e).find(".b-notification_error-empty_password"),c=$(e).hasClass("js-welcome-wizard-collector"),"required_password"===t?l:(l.addClass("g-hidden"),a=$(e).find(".b-notification_status"+(n?"-"+n:"")),r=a.find(".b-notification"),d=r.data("status"),d&&r.removeClass("b-notification_"+d).removeData("status"),t&&(o=i.apply(null,$.merge([c,t],s||[])),r.addClass("b-notification_"+t).data("status",t).find(".b-notification-content").html(o)),a)},o={form:null,params:null,type:"check",run:function(e,t){n!==!0&&(n=!0,this.owner=t,this.form=e,this.params=this.form.serializeObject(),s(this.form).addClass("g-hidden"),this.buttons=this.form.find("input:submit,input:button,button").closest(".nb-button").map(function(){return nb.block(this)
}),$.each(this.buttons,function(){this.disable()}),ns.events.on("onCollectorCheckStart",this.onCollectorCheckStart.bind(this)),ns.events.on("onCollectorCheckSuccess",this.onCollectorCheckSuccess.bind(this)),ns.events.on("onCollectorCheckFail",this.onCollectorCheckFail.bind(this)),this.collectorCheck())},collectorCheck:function(){var e=$(this.form).closest("form").serializeObject()||this.params;return!e.password&&/^setup/.test(ns.page.current.page)?void ns.events.trigger("onCollectorCheckFail",{status:"required_password"}):(ns.events.trigger("onCollectorCheckStart"),void ns.forcedRequest("do-collector-check",e).then(this._collectorCheckDone,this._collectorCheckFail,this))
},_collectorCheckDone:function(e){var t=e[0],n=t.params.email;"ok"===t.get(".body.test")?n&&-1!=$.inArray(n.toLowerCase(),ns.Model.get("account-information").getEmails())?ns.events.trigger("onCollectorCheckFail",{status:"this_server_belongs_to_yandex"}):ns.events.trigger("onCollectorCheckSuccess"):this._collectorCheckFail()},_collectorCheckFail:function(){ns.events.trigger("onCollectorCheckFail",{status:"auth_failed"})},onCollectorCheckStart:function(){s(this.form,"loading",this.type).removeClass("g-hidden")
},onCollectorCheckSuccess:function(){this.clear(),s(this.form,"success",this.type).removeClass("g-hidden")},onCollectorCheckTriesExceeded:function(e,t){s(e,"tries_exceeded",t).removeClass("g-hidden")},onCollectorCheckFail:function(t,n){if("wizard-collector-create"==this.owner&&"2"==e.urlParams.w){var i=e.getUrlParams(),o=i.exp;o?("4"==o&&Jane.c(["collect-coupons","Шаг 2","collector","Ошибка создания сборщика"]),"5"==o&&Jane.c(["collect-tickets","Шаг 2","collector","Ошибка создания сборщика"]),"6"==o&&Jane.c(["collect-events","Шаг 2","collector","Ошибка создания сборщика"])):Jane.c(["Страница угона вариант №2","Шаг 2","collector","Ошибка создания сборщика"]),ns.action.run("wizard.step-inline-block",{step:"3"})
}this.clear(),ns.events.trigger("onCollectorCreateDidFail."+this.owner,{data:n});var a=/auth_failed|this_server_belongs_to_yandex|required_password/.test(n.status)?n.status:"fail";s(this.form,a,this.type,[this.params.email,this.params.protocol]).removeClass("g-hidden"),this.onCollectorSaveFail()},onCollectorSaveFail:function(){this.form.data("pddDomain")&&this.form.find(".b-form-layout__block_server-settings").removeClass("g-hidden")},clear:function(){this.clearBindings(),this.clearStatuses()},clearBindings:function(){ns.events.off("onCollectorCheckStart"),ns.events.off("onCollectorCheckSuccess"),ns.events.off("onCollectorCheckFail"),$.each(this.buttons,function(){this.enable()
}),n=!1},clearStatuses:function(){s(this.form).addClass("g-hidden")}},a=$.extend({},o,{type:"edit",onCollectorCheckSuccess:function(){if("imap"!==this.params.protocol){var e=ns.Model.get("folders").getFolderBySymbol("inbox");"move_folder"in this.params&&e&&e.fid!==this.params.move_folder&&(this.params.cliker_folder="move")}ns.forcedRequest([{id:"do-collector-edit",params:this.params},{model:ns.Model.get("collectors").getMasterRequest()}]).then(this._doCollectorEditDone,this._doCollectorEditFail,this)
},_doCollectorEditDone:function(e){var t=e[0],n=t.get(".body.updated");if("ok"===n){var i=ns.Model.get("filters").getForCollector(this.params.popid),s=_.map(i,function(e){return{id:"do-filters-delete",params:{id:e.filid}}});s.push({model:ns.Model.get("filters").getMasterRequest()}),ns.forcedRequest(s).then(function(){ns.events.trigger("onCollectorEditSuccess."+this.owner,{popid:this.params.popid}),this.clear()},this)}else this._doCollectorEditFail()},_doCollectorEditFail:function(){this.onCollectorSaveFail(),this.clear()
}}),r=$.extend({},o,{type:"create",onCollectorCheckSuccess:function(){ns.forcedRequest([{id:"do-collector-create",params:this.params},{model:ns.Model.get("collectors").getMasterRequest()}]).then(this._doCollectorCreateDone,this._doCollectorCreateFail,this)},_doCollectorCreateDone:function(e){var t=e[0],n=t.get(".body.popid");n?(ns.events.trigger("onCollectorCreateSuccess."+this.owner,{popid:n,email:this.params.email}),Jane.ErrorLog.send({collector_create:this.params.server}),this.clear()):this._doCollectorCreateFail()
},_doCollectorCreateFail:function(e){var t=e.invalid[0],n=t.getError(),i=n?n.reason:"";this.clear();var o={"rpop from himself error":"this_server_belongs_to_yandex","dublicate error":"duplicated"}[i];o||(o="auth_failed");var a=s(this.form,o,"create",[this.params.server,this.params.login]);a.removeClass("g-hidden");var r={status:i};ns.events.trigger("onCollectorCreateDidFail."+this.owner,{data:r}),this.onCollectorSaveFail()}});t.prototype={ns:".collectorsettings",node:null,fields:null,_fieldError:function(e,t){return this.node.find(".b-notification_error-"+e+"_"+t)
},destroy:function(){this.node.unbind(this.ns),this.node.data("settings",null)},getControl:function(e){var t=$("[name="+e+"]",this.node).closest(".nb-input,.nb-select,.nb-checkbox,.nb-radio-button").get(0);return t?nb.block(t):null},getEmailSettings:function(e,t,n){var i=$.Deferred();if(!e)return i.rejectWith(this);var s=e.split("@"),o=s[0]||null,a=s[1]||null;if(!o||!a)return i.rejectWith(this);var r=ns.Model.get("collector-settings").getByDomain(a,t,n);return r?i.resolveWith(this,[r,e,o]):(ns.forcedRequest(["is-yandex-user"],{email:e}).then(function(s){var a=s[0];
if("yes"===a.get(".y")){var r=ns.Model.get("collector-settings").getByDomain("yandex.ru",t,n);r?(r.pdd=!0,i.resolveWith(this,[r,e,o])):i.rejectWith(this)}else i.rejectWith(this)}.bind(this),function(){i.rejectWith(this)}.bind(this)),i.promise())},onSettingsChange:function(e){var t=this.getControl("email").getValue().toLowerCase(),n=this.getControl("use_ssl").isChecked(),i=this.getControl("protocol").getState().value;e&&(i=null,n=null);var s=vow.fulfill(),o=ns.Model.get("collector-settings").getDefaultConfig(i,n);
return t&&this.validate("email")?s=this.getEmailSettings(t,i,n).done(function(e,t,n){e=$.extend({},o,e),this.fillAll(e,t,n),this.isAdvanced=!1}).fail(function(){this.fillAll(o),this.onEmpty(),this.isAdvanced=!0}).always(function(){return vow.fulfill()}):this.fillAll(o),s},updateNoDeleteMsgOption:function(){var e="imap"===this.getControl("protocol").getState().value,t="pop.yandex.ru"===this.getControl("server").getValue(),n=$(".js-not-delete-msg-option",this.node);e||t?n.addClass("g-hidden"):n.removeClass("g-hidden"),this.checkNoDeleteMsgOption()
},checkNoDeleteMsgOption:function(){this.getControl("no_delete_msg").enable().check()},isSSLOptionEnabled:function(){var e=this.getControl("email").getValue().toLowerCase();if(!e)return!0;var t=_.last(e.split("@"));if(!t)return!0;var n=ns.Model.get("collector-settings").getByDomain(t);return n&&n.SSLOnly?!1:!0},updateSSLOption:function(){var e=this.getControl("use_ssl");this.isSSLOptionEnabled()?e.show():e.check().hide()},fillAll:function(e,t,n){this.fill(e,t,n),this.updateSSLOption(),this.updateNoDeleteMsgOption()
},fill:function(e,t,n){this.onFill();var i=e.server||"";$.isArray(i)&&(i=e.server[0].name),n=("login"===e.tpl?n:t)||"",this.getControl("login").setValue(n),this.getControl("protocol").setState({value:e.useProtocol}),this.getControl("server").setValue(i),this.getControl("port").setValue(e.port),e.useSSL?this.getControl("use_ssl").check():this.getControl("use_ssl").uncheck(),this.node.data("pddDomain",!!e.pdd)},onFill:function(){this.toggleServerSettingsBlock(!1)},toggleServerSettingsBlock:function(e){this.node.hasClass("js-collector-create-form")?(this.node.toggleClass("mail-CollectorCreate-Form_advanced",e),this.node.parents(".js-welcome-wizard-collectors-step").toggleClass("mail-WelcomeWizard-CollectorsStep_expanded",e)):this.node.find(".b-form-layout__block_server-settings").toggleClass("g-hidden",!e),!this.isAdvanced&&e&&this.hideErrors()
},empty:function(){var e=ns.Model.get("collector-settings").getDefaultConfig();this.getControl("login").setValue(""),this.getControl("server").setValue(""),this.getControl("port").setValue(e.port),this.getControl("protocol").setState({value:e.useProtocol}),e.useSSL?this.getControl("use_ssl").check():this.getControl("use_ssl").uncheck(),this.checkNoDeleteMsgOption(),this.onEmpty()},hideErrors:function(){for(var e in this.validationPatterns){if(!this.validationPatterns.hasOwnProperty(e))return;this._fieldError("pattern",e).addClass("g-hidden"),this._fieldError("required",e).addClass("g-hidden")
}},onEmpty:function(){this.toggleServerSettingsBlock(!0)},validationPatterns:{email:{test:Jane.FormValidation.checkEmail.bind(Jane.FormValidation)},password:/.+/,login:/.+/,server:/^[0-9A-Za-z\u0410-\u042f\u0401\u0430-\u044f\u0451\-]+(\.[0-9A-Za-z\u0410-\u042f\u0401\u0430-\u044f\u0451\-]+)*$/,port:/^\d+$/,protocol:/^(pop|imap)$/},validate:function(e){var t=this,n=!0,i=function(e,n){var i,s=!0,o=t.getControl(e),a=o.getType();return"password"!==e&&"input"===a&&o.setValue(o.getValue().replace(/\s/g,"")),"input"===a||"checkbox"===a?i=o.getValue():"select"===a&&(i=o.getState().value),t.validationPatterns[e]&&(i?t.validationPatterns[e].test(i)?(t._fieldError("pattern",e).addClass("g-hidden"),t._fieldError("required",e).addClass("g-hidden")):(t._fieldError("pattern",e).removeClass("g-hidden"),t._fieldError("required",e).addClass("g-hidden"),s=!1):(t._fieldError("pattern",e).addClass("g-hidden"),t._fieldError("required",e).removeClass("g-hidden"),s=!1)),s?!0:!!n&&setTimeout(function(){o.focus()
},1)&&!1};if(e)n=i(e);else{var s=!0;for(var o in this.validationPatterns)s=n=i(o,s)?n:!1}return n}},e.Collectors={Settings:t,Checker:o,Creator:r,Editor:a}}(Daria),function(){Daria.NbDependenceController=function(e,t){return this.init(e,t)},Daria.NbDependenceController.prototype={cache:null,instanceId:null,init:function(e,t){var n=this;this.cache=[],this.instanceId=t;var i=e.find(".daria-dependence-child");i.length&&(i.each(function(){var e=nb.block(this);e&&n.add(this.getAttribute("dependence-child-id").split(","),e)
}),e.find(".daria-dependence-parent").each(function(){var e=nb.block(this);e&&(n.add(this.getAttribute("dependence-parent-id"),e,e.getName(),"radio"===e.getType()),e.on("nb-changed",$.proxy(n.onBlockChange,n)))}),this.onDependenceChange=this.onDependenceChange.bind(this),ns.events.on("dependence.change",this.onDependenceChange))},destroy:function(){ns.events.off("dependence.change",this.onDependenceChange);var e=this;$.each($.makeArray(this.cache),function(){this.block&&this.block.off("nb-changed",$.proxy(e.onBlockChange,e))
}),this.cache=[]},onDependenceChange:function(e,t){t.instance==this.instanceId&&(t.block?this.update(t.block.$node.attr("dependence-parent-id"),this._blockDisabled(t.block)):t.id&&"disable"in t&&this.update(t.id,t.disable))},onBlockChange:function(e,t){this.update(t.$node.attr("dependence-parent-id"),this._blockDisabled(t))},add:function(e,t,n,i){if(n){var s=this._blockDisabled(t),o=this._getItems(e);if(o.length)$.each(o,function(t,o){i&&(o.names[n]=e),o.ids[e]=s});else{var a={ids:{},names:{}};a.ids[e]=s,a.names[n]=e,this.cache.push(a)
}}else this.cache.push({block:t,names:{},ids:function(){for(var t={},n=e.length;n--;)t[e[n]]=!0;return t}()})},_getItems:function(e){for(var t=[],n=this.cache.length;n--;)e in this.cache[n].ids&&t.push(this.cache[n]);return t},_blockDisabled:function(e){var t="invert"===e.$node.attr("dependence-parent-type")?!0:!1;return e.isChecked()===t},_getSet:function(e){function t(e){return function(t,n){n in e.names&&(o.push(e),s.push(n))}}for(var n=this._getItems(e),i=$.map(n,function(t){for(var n in t.names)if(t.names[n]==e)return n
}),s=[],o=[],a=this.cache.length;a--;){var r=this.cache[a];e in r.ids||$.each(i,t(r))}return{items:n,hewings:o,names:s}},update:function(e,t){var n=this._getSet(e);$.each(n.items,function(i,s){this._update(e,s,t,n.names)}.bind(this)),$.each(n.hewings,function(i,s){this._update(e,s,!t,n.names)}.bind(this))},_update:function(e,t,n,i){var s=t.ids,o=!1;$.each(i,function(e,i){i in t.names&&(s[t.names[i]]=n)}),e in s&&(s[e]=n);for(var a in s)if(s[a]){o=!0;break}t.block&&this._updateBlock(t.block,o)},_updateBlock:function(e,t){e.$node.closest(".b-form-element").toggleClass("b-form-element_disabled",t),e.isChecked&&e.isChecked()&&e.$node.hasClass("daria-dependence-parent")&&t&&(e.uncheck(),ns.events.trigger("dependence.change",{block:e,instance:this.instanceId})),t?e.disable():e.enable()
}}}(),Daria.Mixins.Abook=Daria.Mixins.Abook||{},Daria.Mixins.Abook._editGroupDialogInstance=null,Daria.Mixins.Abook._editGroupDialogSubmit=function(e){var t=this._editGroupDialogInstance.$groupName.val().trim();if(!t)return this._editGroupDialogInstance.$groupName.focus(),!1;if(ns.Model.get("abook-groups").getGroupByTitle(t))return this._editGroupDialogInstance.$body.addClass("b-popup__field_error"),this._editGroupDialogInstance.errorName=t,this._editGroupDialogInstance.$groupName.focus(),!1;var n={title:t};
e.tid>0&&(n.tid=e.tid),ns.forcedRequest([{id:e.handlerName,params:n},{id:"abook-groups"}]).then(function(){Daria.Dialog.close()})},Daria.Mixins.Abook.openEditGroupDialog=function(e){var t=this,n=$.Deferred();return Daria.Dialog.open({title:e.title,body:Jane.tt("setup:js-setup-abook-popup-group",{tid:e.tid},["abook-groups"]),width:340,buttons:[{name:"submit",value:e.buttonText,onclick:this._editGroupDialogSubmit.bind(this,e)},{name:"cancel"}],onopen:function(){t._editGroupDialogInstance=null||this,this.$body=$(this.body),this.$groupName=this.$body.find(".js-setup-abook-popup-group-name"),this.$body.on("keyup",".js-setup-abook-popup-group-name",function(n){if(t._editGroupDialogInstance.errorName){var i=t._editGroupDialogInstance.errorName===t._editGroupDialogInstance.$groupName.val().trim();
t._editGroupDialogInstance.$body.toggleClass("b-popup__field_error",i)}13===n.keyCode&&t._editGroupDialogSubmit(e)}),this.$groupName.focus()},onclose:function(){n.resolve()}}),n.promise()},ns.Model.define("do-collector-edit",{params:{popid:null,server:null,login:null,password:null,port:null,use_ssl:null,email:null,no_delete_msg:null,abook_sync:null,mark_old_as_read:null,protocol:null,id:null,filter_name:null,cliker_folder:null,cliker_label:null,move_folder:null,move_label:null}}),ns.Model.define("do-collector-on",{params:{popid:null}}),ns.Model.define("collector-texts",{events:{"ns-model-init":function(){this.setData({"collector-fields":{field:[{type:"text",kind:"quick",name:"email","label-text":"Почта"},{type:"password",kind:"quick",name:"password","label-text":"Пароль"},{type:"select",kind:"full",name:"protocol","label-text":"Протокол",items:[{name:"POP",value:"pop"},{name:"IMAP",value:"imap"}]},{type:"text",kind:"full",name:"login","label-text":"Логин"},{type:"text",kind:"full",name:"server","label-text":"Сервер"},{type:"text",kind:"full",name:"port","label-text":"Порт"},{type:"checkbox",kind:"full",name:"use_ssl","label-text":"Использовать протокол SSL-шифрования"},{type:"checkbox",kind:"full",name:"no_delete_msg","label-text":"Сохранять оригиналы писем в ящике"}]},"collector-field-errors":{field:[{name:"email",type:"pattern",text:"Неверный формат почты"},{name:"password",type:"empty",text:"Необходимо ввести пароль"},{name:"server",type:"pattern",text:"Некорректный сервер"},{name:"port",type:"pattern",text:"Некорректный порт"},{type:"required",text:"Поле не заполнено"}]}})
}},methods:{isValid:Jane.Common._true}}),ns.Model.define("do-collector-check",{params:{popid:null,server:null,port:null,login:null,password:null,use_ssl:null,no_delete_msg:"off",protocol:null}}),ns.Model.define("do-collector-run",{params:{popid:null}}),ns.Model.define("do-collector-off",{params:{popid:null}}),Daria.EnumCollectorCreateFormState={INITIAL:"initial",REQUESTING:"requesting",SUCCESS:"success",FAILURE:"failure",TRIES_EXCEEDED:"tries_exceeded"},ns.Model.define("collector-create-form-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.resetState()
},resetState:function(){this.setData({state:Daria.EnumCollectorCreateFormState.INITIAL,failureCount:0,shouldGoNextWithDelay:!0,advanced:!1})},getState:function(){return this.get(".state")},onSuccess:function(){this.set(".state",Daria.EnumCollectorCreateFormState.SUCCESS)},onFailure:function(){var e=this.get(".failureCount")||0;this.set(".failureCount",e+1),this.set(".state",Daria.EnumCollectorCreateFormState.FAILURE)},onRequesting:function(){this.set(".state",Daria.EnumCollectorCreateFormState.REQUESTING)
},onTriesExceeded:function(){this.set(".state",Daria.EnumCollectorCreateFormState.TRIES_EXCEEDED)},canRetry:function(){return this.get(".failureCount")<3},shouldGoNextWithDelay:function(){return this.get(".shouldGoNextWithDelay")},isAdvancedForm:function(){return this.get(".advanced")},unsetShouldGoNextWithDelay:function(){this.set(".shouldGoNextWithDelay",!1,{silent:!0})}}},ns.ModelStatic),ns.Model.define("do-collector-create",{params:{server:null,login:null,password:null,port:null,use_ssl:null,email:null,no_delete_msg:"off",abook_sync:null,mark_old_as_read:null,protocol:null}}),ns.Model.define("do-filters-accept-email",{params:{e:null}}),ns.Model.define("do-filters-add",{params:{name:null,letter:null,attachment:null,logic:null,field1:null,field2:null,field3:null,clicker:null,move_label:null,move_folder:null,forward_address:null,notify_address:null,autoanswer:null,order:null,stop:null,password:null}}),ns.Model.define("do-filters-blacklist-add",{params:{email:null}}),ns.Model.define("do-filters-blacklist-remove",{params:{email:null}}),ns.Model.define("do-filters-delete",{params:{id:null}}),ns.Model.define("do-filters-edit",{params:{id:null,name:null,letter:null,attachment:null,logic:null,field1:null,field2:null,field3:null,clicker:null,move_label:null,move_folder:null,forward_address:null,notify_address:null,autoanswer:null,order:null,stop:null,password:null}}),ns.Model.define("do-filters-off",{params:{id:null,enabled:null}}),ns.Model.define("do-filters-on",{params:{id:null,enabled:null}}),ns.Model.define("do-filters-sort",{params:{list:null}}),ns.Model.define("do-filters-whitelist-add",{params:{email:null}}),ns.Model.define("do-filters-whitelist-remove",{params:{email:null}}),ns.Model.define("filters-apply",{params:{id:null}}),function(){ns.Model.define("filters-blacklist",{methods:{hasEmail:function(e){return this.select('.[.addresses =="'+e+'"]')[0]
}}})}(),ns.Model.define("filters-check-owner",{params:{e:null,from:null}}),function(){ns.Model.define("filters-check-password",{params:{password:null}})}(),ns.Model.define("filters-preview-message",{params:{ids:null},methods:{preprocessData:function(e){return e.date.view=Daria.MessageTime.getFormattedTime(e.date.timestamp),e}}}),ns.Model.define("filters-preview",{events:{},params:{id:null,field1:null,field2:null,field3:null,logic:null,offset:0,count:10},split:{items:".list.message",model_id:"filters-preview-message",params:{ids:".mid"}}}),function(){ns.Model.define("filters-whitelist",{methods:{hasEmail:function(e){return this.select('.[.addresses =="'+e+'"]')[0]
}}})}(),ns.Model.define("do-folder-remove",{params:{fid:null,force:"yes"}}),ns.Model.define("do-folder-update",{params:{fid:null}}),ns.Model.define("do-label-edit",{params:{lid:null,label_name:null,label_color:null}}),ns.Model.define("do-labels-delete",{params:{lids:null}}),ns.Model.define("journal"),ns.Model.define("setup-menu",{events:{"ns-model-init":function(){var e=[{id:"sender",type:"menu","menu-name":"Информация об отправителе"},{id:"collectors",type:"menu","menu-name":"Сбор почты с других ящиков",title:"Сбор почты",item:[{id:"collector",title:"Изменить правила работы сборщика"}]},{id:"folders",type:"menu","menu-name":"Папки и метки"},{id:"filters",type:"menu","menu-name":"Правила обработки почты",title:"Правила обработки входящей почты",item:[{id:"filters-create",title:"Создать правило"},{id:"filters-create-simple",title:"Создать правило"},{id:"filters-edit",title:"Изменить правило"}]},{id:"security",type:"menu","menu-name":"Безопасность"},{type:"separator"},{id:"abook",type:"menu","menu-name":"Контакты"},{id:"todo",type:"menu","menu-name":"Дела"},{type:"separator"},{id:"client",type:"menu","menu-name":"Почтовые программы"},{id:"other",type:"menu","menu-name":"Прочие параметры",title:"Прочие параметры"},{type:"separator"}];
Jane.Config.allowThemes&&e.unshift({id:"interface",type:"menu","menu-name":"Выбор оформления",title:"Оформление почты"}),this.setData({"setup-menu":{item:{title:"Все настройки",item:e}}})}}},ns.ModelStatic),ns.Model.define("signature-langs",{events:{"ns-model-init":function(){this.setData({langs:[{abbr:"ru","short":"Ru",name:"Русский"},{abbr:"en","short":"En",name:"English"},{abbr:"uk","short":"Ua",name:"Українська"},{abbr:"be","short":"By",name:"Беларуская"},{abbr:"tr","short":"Tr",name:"Türkçe"}]})
}}}),ns.Model.define("timezones",{events:{"ns-model-init":function(){this.setData({timezones:{timezone:[{name:"(GMT-10:00) Гавайи",value:"Pacific/Honolulu"},{name:"(GMT-09:00) Аляска",value:"America/Anchorage"},{name:"(GMT-08:00) Тихуана, Нижная Калифорния",value:"America/Los_Angeles"},{name:"(GMT-07:00) Аризона",value:"America/Phoenix"},{name:"(GMT-07:00) Тихоокеанское время (США и Канада)",value:"America/Denver"},{name:"(GMT-07:00) Ла-Пас, Мазатлан, Чихуахуа",value:"America/Chihuahua"},{name:"(GMT-06:00) Центральная Америка",value:"America/Managua"},{name:"(GMT-06:00) Саскачеван",value:"America/Regina"},{name:"(GMT-06:00) Гвалахара, Мехико, Монтеррей",value:"America/Mexico_City"},{name:"(GMT-06:00) Центральное время (США и Канада)",value:"America/Chicago"},{name:"(GMT-05:00) Индиана (восток)",value:"America/Indianapolis"},{name:"(GMT-05:00) Богота, Рио, Кито, Рио-Бранко",value:"America/Bogota"},{name:"(GMT-05:00) Восточное время (США и Канада)",value:"America/New_York"},{name:"(GMT-04:00) Каракас, Ла Пас",value:"America/Caracas"},{name:"(GMT-04:00) Сантьяго",value:"America/Santiago"},{name:"(GMT-04:00) Атлантическое время (Канада)",value:"America/Halifax"},{name:"(GMT-03:30) Ньюфаундленд",value:"America/St_Johns"},{name:"(GMT-03:00) Буэнос-Айрес, Джорджтаун",value:"America/Buenos_Aires"},{name:"(GMT-03:00) Гренландия",value:"America/Godthab"},{name:"(GMT-03:00) Бразилия",value:"America/Sao_Paulo"},{name:"(GMT-02:00) Среднеатлантическое время",value:"America/Noronha"},{name:"(GMT-01:00) о-ва Зелёного мыса",value:"Atlantic/Cape_Verde"},{name:"(GMT-01:00) Азорские о-ва",value:"Atlantic/Azores"},{name:"(GMT) Касабланка, Монровия",value:"Africa/Casablanca"},{name:"(GMT) Время по Гринвичу: Дублин, Лондон, Лиссабон, Эдинбург",value:"Europe/London"},{name:"(GMT+01:00) Западная и Центральная Африка",value:"Africa/Lagos"},{name:"(GMT+01:00) Амстердам, Берлин, Берн, Вена, Рим, Стокгольм",value:"Europe/Berlin"},{name:"(GMT+01:00) Брюссель, Копенгаген, Мадрид, Париж",value:"Europe/Paris"},{name:"(GMT+01:00) Варшава, Загреб, Сараево, Скопье",value:"Europe/Sarajevo"},{name:"(GMT+01:00) Белград, Братислава, Будапешт, Любляна, Прага",value:"Europe/Belgrade"},{name:"(GMT+02:00) Хараре, Претория",value:"Africa/Johannesburg"},{name:"(GMT+02:00) Иерусалим",value:"Asia/Jerusalem"},{name:"(GMT+02:00) Афины, Бухарест, Стамбул",value:"Europe/Istanbul"},{name:"(GMT+02:00) Каир",value:"Africa/Cairo"},{name:"(GMT+02:00) Бухарест",value:"Europe/Bucharest"},{name:"(GMT+02:00) Киев",value:"Europe/Kiev"},{name:"(GMT+02:00) Калининград",value:"Europe/Kaliningrad"},{name:"(GMT+03:00) Вильнюс, Рига, София, Таллин, Хельсинки",value:"Europe/Helsinki"},{name:"(GMT+03:00) Минск",value:"Europe/Minsk"},{name:"(GMT+03:00) Найроби",value:"Africa/Nairobi"},{name:"(GMT+03:00) Кувейт, Эр-Рияд",value:"Asia/Riyadh"},{name:"(GMT+03:00) Багдад",value:"Asia/Baghdad"},{name:"(GMT+03:00) Москва, Санкт-Петербург, Волгоград",value:"Europe/Moscow"},{name:"(GMT+03:30) Тегеран",value:"Asia/Tehran"},{name:"(GMT+04:00) Самара",value:"Europe/Samara"},{name:"(GMT+04:00) Абу-Даби, Мускат",value:"Asia/Muscat"},{name:"(GMT+04:00) Баку, Ереван, Тбилиси",value:"Asia/Tbilisi"},{name:"(GMT+04:30) Кабул",value:"Asia/Kabul"},{name:"(GMT+05:00) Исламабад, Карачи, Ташкент",value:"Asia/Karachi"},{name:"(GMT+05:00) Актюбинск (Актобе)",value:"Asia/Aqtobe"},{name:"(GMT+05:00) Екатеринбург",value:"Asia/Yekaterinburg"},{name:"(GMT+05:30) Бомбей, Калькутта, Мадрас, Нью-Дели",value:"Asia/Calcutta"},{name:"(GMT+05:30) Шри-Джаяварденепура",value:"Asia/Colombo"},{name:"(GMT+05:45) Катманду",value:"Asia/Katmandu"},{name:"(GMT+06:00) Дхака",value:"Asia/Dhaka"},{name:"(GMT+06:00) Астана, Алматы",value:"Asia/Almaty"},{name:"(GMT+06:30) Янгун (Рангун)",value:"Asia/Rangoon"},{name:"(GMT+07:00) Бангкок, Джакарта, Ханой",value:"Asia/Bangkok"},{name:"(GMT+07:00) Красноярск",value:"Asia/Krasnoyarsk"},{name:"(GMT+07:00) Новосибирск",value:"Asia/Novosibirsk"},{name:"(GMT+08:00) Перт",value:"Australia/Perth"},{name:"(GMT+08:00) Тайпей",value:"Asia/Taipei"},{name:"(GMT+08:00) Куала-Лумпур, Сингапур",value:"Asia/Singapore"},{name:"(GMT+08:00) Гонконг, Пекин, Урумчи",value:"Asia/Hong_Kong"},{name:"(GMT+08:00) Иркутск",value:"Asia/Irkutsk"},{name:"(GMT+09:00) Осака, Саппоро, Токио",value:"Asia/Tokyo"},{name:"(GMT+09:00) Сеул",value:"Asia/Seoul"},{name:"(GMT+09:00) Якутск",value:"Asia/Yakutsk"},{name:"(GMT+09:30) Дарвин",value:"Australia/Darwin"},{name:"(GMT+09:30) Аделаида",value:"Australia/Adelaide"},{name:"(GMT+10:00) Гуам, Порт-Морсби",value:"Pacific/Guam"},{name:"(GMT+10:00) Брисбейн",value:"Australia/Brisbane"},{name:"(GMT+10:00) Хобарт",value:"Australia/Hobart"},{name:"(GMT+10:00) Канберра, Мельбурн, Сидней",value:"Australia/Sydney"},{name:"(GMT+10:00) Владивосток, Магадан",value:"Asia/Vladivostok"},{name:"(GMT+11:00) Колыма, Курильские острова",value:"Asia/Srednekolymsk"},{name:"(GMT+12:00) Камчатка, Чукотка",value:"Asia/Kamchatka"},{name:"(GMT+12:00) Фиджи, Маршалловы о-ва",value:"Pacific/Fiji"},{name:"(GMT+12:00) Окленд, Веллингтон",value:"Pacific/Auckland"},{name:"(GMT+13:00) Нукуалофа",value:"Pacific/Tongatapu"},{name:"(GMT+13:00) о. Мидуэй, Самоа",value:"Pacific/Apia"}]}})
}}},ns.ModelStatic),ns.Model.define("timezone-edit",{params:{timezone:null},ckey:!0}),ns.Model.define("do-abook-group-edit",{params:{tid:null,title:null}}),ns.Model.define("do-abook-group-remove",{params:{tid:null}}),ns.Model.define("do-indexer",{params:{suid:null,mdb:null}}),ns.Model.define("labels-colors",{events:{"ns-model-init":function(){this.setData({row:[{color:["31c73b","7cc3c4","5a8eff","ba99ff","a8bcce","c1be00","f99000","ff8985"]},{color:["28a931","67a3a4","5080e7","a488e2","8e9faf","a19f00","db7f00","ff3f30"]},{color:["1d8925","508182","456ec8","8e75c4","73818e","807e00","bb6c00","f32300"]},{color:["136619","395e5f","385ca8","7760a4","57616c","5c5a00","9c5800","d51e00"]}]})
}}},ns.ModelStatic),ns.View.define("setup-form",{methods:{addFormCacher:function(e){this._formCachers||(this._formCachers=[]);var t=_.uniqueId(this.id+"-"),n=new Daria.nbFormCacher($(e),t);return this._formCachers.push(n),n},getDirtyFormCacher:function(){var e=[];if(this._formCachers){var t;for(t=0;t<this._formCachers.length;t++)this._formCachers[t].isFormDirty()&&e.push(this._formCachers[t])}return e.length>0?e:null},onBeforeUnloadPage:function(){this.getDirtyFormCacher()&&Daria.addUnloadText("Вы не сохранили изменения, при уходе со страницы они потеряются.")
},onPageLeave:function(){this._pageBlockCallback=this.onBeforePageLeave.bind(this),ns.page.block.add(this._pageBlockCallback)},offPageLeave:function(){ns.page.block.remove(this._pageBlockCallback)},onBeforePageLeave:function(e){if(ns.page.currentUrl===e)return!0;var t=this,n=this.getDirtyFormCacher();return n?(Jane.c({"Диалог о сохранении настроек":"Показ"}),Daria.Dialog.open({width:480,body:"<p>Сохранить изменения?</p>",buttons:[{name:"save",value:"Сохранить и перейти",focus:!0,onclick:function(){Jane.c({"Диалог о сохранении настроек":"Клик по сохранить и перейти"}),_.each(n,function(e){e.getForm().submit()
}),Daria.Dialog.close(),t.offPageLeave(),ns.page.go(e)}},{name:"dont_save",value:"Не сохранять",onclick:function(){Jane.c({"Диалог о сохранении настроек":"Клик по не сохранять"}),_.each(n,function(e){e.cancelChanges()}),Daria.Dialog.close(),t.offPageLeave(),ns.page.go(e)}},{link:!0,name:"cancel",value:"Отмена"}]}),!1):void 0},_getFormChangedData:function(e){var t=e.serializeObject();return _.transform(t,this._formDataTransformIterator,{})},_formDataTransformIterator:function(e,t,n){var i=ns.Model.get("settings"),s=i.getSign(n),o=$.type(s);
switch(o){case"boolean":t=Boolean(t);break;case"number":t=Number(t||0);break;default:t=String(t||"")}s!==t&&(e[n]=i.signToSetting(n,t))},_saveSettings:function(e){return ns.Model.get("settings").setSettings(e).then(function(){return e})},onSubmitSetupForm:function(e){e.preventDefault();var t=$(e.currentTarget),n=this._getFormChangedData(t);n=this.preparationFormData(n),vow.resolve(n).then(this._saveSettings,this).then(this.onSaveSettingsSuccess,this).then(function(){Daria.Statusline.showMsg({name:"setup-updates",body:'Настройки сохранены. Перейти во <a href="#inbox" class="b-statusline__link">Входящие</a>'}),t.trigger("onSave",n)
})},preparationFormData:function(e){return e},onSaveSettingsSuccess:function(){}}}),ns.View.define("setup-abook",{models:{"abook-groups":!0,"setup-menu":!1,settings:"onSettingsChange"},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onPageLeave","ns-view-hide":"offPageLeave","click@show .js-setup-abook-group":"_onClickSelectGroup","click@show .js-setup-abook-create-group":"_onClickCreateGroup","click@show .js-setup-abook-rename-group":"_onClickRenameGroup","click@show .js-setup-abook-remove-group":"_onClickRemoveGroup","click@show .js-abook-import":"_onClickAbookImport","click@show .js-abook-export":"_onClickAbookExport","submit@show .js-form-submit":"onSubmitSetupForm","form-cacher.unchanged@show":"onFormCacherUnchanged"},yateModule:"setup",ctor:function(){this._afterUpdateGroup=this._afterUpdateGroup.bind(this),this._pageReload=this._pageReload.bind(this),this._pageReloadOnce=_.noop
},methods:_.extend({onHtmlInit:function(){this.selectedTid="",this.addFormCacher(this.$node.find(".js-setup-form-container")),this.buttons={rename:nb.$block(".js-setup-abook-rename-group",this.$node),remove:nb.$block(".js-setup-abook-remove-group",this.$node)}},_onClickAbookImport:function(e){e.preventDefault(),e.stopPropagation(),Daria.abook.openImportDialog()},_onClickAbookExport:function(e){e.preventDefault(),e.stopPropagation(),Daria.abook.openExportDialog()},_onClickCreateGroup:function(){this.openEditGroupDialog({title:"Создать новую группу",handlerName:"do-abook-group-add",tid:null,buttonText:"Создать группу"}).then(this._afterUpdateGroup)
},_onClickRemoveGroup:function(){ns.forcedRequest([{id:"do-abook-group-remove",params:{tid:this.selectedTid}},{id:"abook-groups"}]).then(this._afterUpdateGroup)},_onClickRenameGroup:function(){this.openEditGroupDialog({title:"Переименовать группу",handlerName:"do-abook-group-edit",tid:this.selectedTid,buttonText:"Переименовать группу"}).then(this._afterUpdateGroup)},_afterUpdateGroup:function(){Daria.Autocompleter.getContact().flushCache(),ns.page.go()},_onClickSelectGroup:function(e){var t=$(e.currentTarget);
t.siblings().removeClass("setup-abook-group_selected"),t.addClass("setup-abook-group_selected"),this.selectedTid=t.data("tid"),this.buttons.rename.enable(),this.buttons.remove.enable()},onSettingsChange:function(){return this.isVisible()?void(this._pageReloadOnce=_.once(this._pageReload)):void this.invalidate()},onFormCacherUnchanged:function(){this._pageReloadOnce()},_pageReload:function(){document.location.reload()}},Daria.Mixins.Abook)},"setup-form"),ns.View.define("setup-client",{models:{folders:!0,"setup-menu":!1,settings:!0},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-enable-all-checkboxes":"onClickEnableAllCheckboxes","click@show .js-enable-imap-btn":"enableImap","click@show .js-imap-show-advantages":"onClickImapShowAdvantages","submit@show .js-form-submit":"onSubmitSetupForm"},yateModule:"setup",ctor:function(){this._foldersCheckboxes=[]
},methods:{onHtmlInit:function(){this.addFormCacher(this.$node.find(".js-setup-form-container"))},onShow:function(){nb.init(this.node),this.dependence=new Daria.NbDependenceController(this.$node.find(".b-setup__inner"),"setup-client"),this.onChangeEnableImap=nb.$block(".js-enable-imap",this.$node),this.onChangeEnableImap&&this.onChangeEnableImap.on("change",this.enableImap.bind(this)),this.onChangeEnablePop=nb.$block(".js-enable-pop",this.$node),this.onChangeEnablePop&&this.onChangeEnablePop.on("change",this.enablePop.bind(this)),this.onPageLeave()
},onHide:function(){this.$node.find(".js-enable-all-checkboxes").off();var e=this.dependence;e&&(e.destroy(),this.dependence=void 0),nb.destroy(this.node),this.offPageLeave(),this.invalidate()},_getCheckboxByFid:function(e){return this._getFoldersCheckboxes().find(function(t){return t.$node.find("input[value="+e+"]").length})},_getFoldersCheckboxes:function(){return this._foldersCheckboxes.length?this._foldersCheckboxes:(this._foldersCheckboxes=this.$node.find(".js-settings-pop3").find(".nb-checkbox:not(.js-enable-pop):not(.js-pop-spam-subject-enable)").map(function(){return nb.block(this)
}).get(),this._foldersCheckboxes)},enableImap:function(e){var t,n=$(e.target),i=n.closest(".b-form-layout__block");n.is("input")||(t=!0,ns.events.trigger("cachedvalue.change",{control:nb.$block(".js-enable-imap",i).check(),instance:"setup-client"})),i.find(".b-box_imap").toggleClass("is-hidden",t||n.prop("checked"))},enablePop:function(e){var t=$(e.target),n=t.closest(".b-form-layout"),i="b-form-layout_pop-disabled";if(n.hasClass(i)){var s=ns.Model.get("folders").getFidBySymbol("inbox"),o=this._getCheckboxByFid(s);
o&&o.check(),n.removeClass(i)}else n.addClass(i)},onClickEnableAllCheckboxes:function(){for(var e=this._getFoldersCheckboxes(),t=$.grep(e,function(e){return e.isChecked()}),n=t.length!==e.length,i=e.length;i--;){var s=e[i];s.isChecked()!==n&&(n?s.check():s.uncheck(),s.$node.hasClass("daria-dependence-parent")&&ns.events.trigger("dependence.change",{block:s,instance:"setup-client"}),ns.events.trigger("cachedvalue.change",{control:s,instance:"setup-client"}))}},onClickImapShowAdvantages:function(e){$(e.target).closest(".b-box").toggleClass("b-box_imap-show-advantages")
},preparationFormData:function(e){var t=_(String(e.fid||"")).chain().split(",").compact().sortBy().value();return _.assign({},e,{fid:t})},onSaveSettingsSuccess:function(e){var t=[];return e.fid&&t.push({id:"do-folder-update",params:{fid:e.fid}}),t.push({id:"folders"}),ns.forcedRequest(t)}}},"setup-form"),function(){ns.View.define("setup-collector",{events:{"ns-view-hide":function(){var e=this.$node;e.find(".b-notification, .b-notification_status, .b-notification_error").addClass("g-hidden").end().find(".b-notification_status .b-notification").removeClass("g-hidden"),nb.$block(".js-move-label",e).off("nb-changed"),nb.$block(".js-move-folder",e).off("nb-changed"),this.dependence&&(this.dependence.destroy(),delete this.dependence),nb.destroy(e[0])
},"ns-view-htmldestroy":function(){this.settings.destroy()},"ns-view-htmlinit":function(){this.settings=new Daria.Collectors.Settings(this.$node.find("form")),this.settings.onFill=$.noop,this.settings.onEmpty=$.noop,delete this.settings.validationPatterns.password,ns.events.on("onCollectorEditSuccess."+this.params.popid,function(e,t){ns.forcedRequest(["do-collector-run"],{popid:t.popid});var n=ns.router.generateUrl("setup",{tab:"collectors"});ns.page.go(n)})},"ns-view-show":function(){nb.init(this.node),this._initLabelsSelect(),this._initFoldersSelect(),this.dependence=new Daria.NbDependenceController(this.$node,"setup-collector")
},"click .js-collector-remove":function(e){e.preventDefault(),Daria.Collector.remove(this.params)},"click .js-toggle-server-settings":function(e){$(e.target).closest(".b-form-layout_collectors").find(".b-form-layout__block_server-settings").toggleClass("g-hidden")},"submit .js-collector-edit":function(e){e.preventDefault();var t=$(e.currentTarget).closest("form"),n=this.params.popid,i=$.data(t[0],"settings");(!i||i.validate())&&Daria.Collectors.Editor.run(t,n)}},yateModule:"setup",methods:{updateLabelsItems:function(e){var t=Jane.tt("setup:new-collector-labels-select",{id:e,filters:{actions:{type:"movel",parameter:e}}},["labels"]);
this.fLabelsSelect.destroy(),this.fLabelsSelect.$node.closest(".b-form-element").replaceWith(t),this._initLabelsSelect()},updateFoldersItems:function(e){var t=Jane.tt("setup:new-collector-folders-select",{id:e,filters:{actions:{type:"move",parameter:e}}},["folders"]);this.fFoldersSelect.destroy(),this.fFoldersSelect.$node.closest(".b-form-element").replaceWith(t),this._initFoldersSelect()},_initLabelsSelect:function(){this.fLabelsSelect=nb.$block(".js-move-label",this.$node),this.fLabelsSelect&&this.fLabelsSelect.on("nb-changed",this.onChangeMoveLabel.bind(this))
},_initFoldersSelect:function(){this.fFoldersSelect=nb.$block(".js-move-folder",this.$node),this.fFoldersSelect&&this.fFoldersSelect.on("nb-changed",this.onChangeMoveFolder.bind(this))},onChangeMoveLabel:function(){var e=this,t=this.fLabelsSelect.getState();if("new_label"===t.value){var n=Daria.LabelCreatePopup();_.extend(n,{success:function(t){e.updateLabelsItems(t)}}),n.init()}},onChangeMoveFolder:function(){var e=this,t=this.fFoldersSelect.getState();if("new_folder"===t.value){var n=Daria.FolderCreatePopup();
_.extend(n,{success:function(t){e.updateFoldersItems(t)}}),n.init()}}},models:["collector","collector-settings","collector-texts","filters","folders","labels","is-yandex-user","setup-menu"]})}(),function(){ns.View.define("setup-collectors",{events:{"ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy","ns-view-htmlinit":"onHtmlInit","ns-view-touch":"onTouch","onCollectorCreateSuccess.setup-collectors@show":"onSetupCollectors","click@show .js-collector-off, .js-collector-on":"onClickCollectorToggle","click@show .js-collector-remove":"onClickCollectorRemove","click@show .js-toggle-extra-info":"onClickToggleExtraInfo","submit@show .js-setup-form":"onCreateCollector"},models:["collectors","collector-settings","collector-texts","filters","labels","folders","setup-menu"],yateModule:"setup",methods:{onHide:function(){this.$node.find(".b-pop__email").removeClass("b-pop__email_more")
},onHtmlDestroy:function(){this.settings&&this.settings.destroy()},onHtmlInit:function(){var e=this.$node.find("form");e.length&&(this.settings=new Daria.Collectors.Settings(e))},onTouch:function(){var e=this.params&&this.params.email;e&&(this.$node.find("input[name=email]").val(e).change(),this.$node.find("input[name=password]").focus())},onClickToggleExtraInfo:function(e){$(e.target).closest(".b-pop__email").toggleClass("b-pop__email_more")},onClickCollectorRemove:function(e){e.preventDefault();
var t=Daria.parseQuery(e.target.getAttribute("data-params"));Daria.Collector.remove(t)},onClickCollectorToggle:function(e){var t=e.currentTarget.getAttribute("data-popid"),n=$(e.currentTarget).closest(".b-switch"),i=n.hasClass("b-switch_on"),s="do-collector-on";i&&(s="do-collector-off"),t&&ns.forcedRequest([{id:s,params:{popid:t}},{model:ns.Model.get("collectors").getMasterRequest()}]).then(function(){n.toggleClass("b-switch_off",i),n.toggleClass("b-switch_on",!i)})},onSetupCollectors:function(e,t){ns.Model.get("settings").setSettingOff("no_collectors_promo");
var n=ns.router.generateUrl("setup",{tab:"collector",popid:t.popid,email:t.email});ns.page.go(n)},onCreateCollector:function(e){e.preventDefault(),ns.action.run("collector.create",{owner:this.id},this.$node.find("form")[0],e)}}},"setup-form")}(),function(){ns.View.define("setup-filters",{models:["folders","filters","filters-blacklist","filters-whitelist","labels","setup-menu","account-information"],events:{"ns-view-htmlinit":"initializeNanoislands","ns-view-htmldestroy":"destroyCache","ns-view-show":"initSort","ns-view-hide":"destroySort","change@show .js-filters-list__added":function(e){var t=$(e.currentTarget),n=this.getAllEmailsNode(t).filter(":checked"),i=nb.$block(".js-delete-button",t);
i&&(n.length?i.enable():i.disable())},"submit@show .js-form-filters-lists-add":"_onSubmitFiltersListsAdd","submit@show .js-form-filters-lists-remove":"_onSubmitFiltersListsRemove","click@show .js-filters-list":"_onClickSortElement","click@show .js-filters-off":"_onClickFiltersOff","click@show .js-filters-on":"_onClickFiltersOn","click@show .js-filters-delete":"_onClickFiltersDelete","click@show .js-filters-create":"onClickFiltersCreate"},yateModule:"setup",methods:{initializeNanoislands:function(){nb.init(this.node)
},getAllEmailsNode:function(e){return $(e||this.node).find(".js-email-from-list input")},_getListNode:function(){return this._$listNode?this._$listNode:(this._$listNode=$(".js-filters-list"),this._$listNode)},destroyCache:function(){delete this._$listNode},initSort:function(){var e=this;this._getListNode().sortable({axis:"y",cancel:"a,img",containment:"parent",tolerance:"pointer"}).on("sortstart",function(e,t){t.item.find(".js-filters-list-item").addClass("b-grab_grabbing")}).on("sortstop",function(e,t){t.item.find(".js-filters-list-item").removeClass("b-grab_grabbing")
}).on("sortupdate",function(){var t=e._getListNode().sortable("toArray",{attribute:"data-params"});t=_(t).map(ns.parseQuery.bind(ns)).pluck("id").join(","),ns.forcedRequest("do-filters-sort",{list:t})}).find(".js-filters-list-item").attr("unselectable","on")},destroySort:function(){var e=this._getListNode();try{e.sortable("destroy")}catch(t){}e.off().find(".js-filters-list-item").removeAttr("unselectable")},_onClickSortElement:function(e){e.stopPropagation();var t=$(e.target).closest("[data-params]").data("params"),n=ns.parseQuery(t).id;
ns.page.go(ns.router.generateUrl("setup",{tab:"filters-create",id:n}))},_onSubmitFiltersListsRemove:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),n=Daria.parseQuery(t.data("params")),i=t.serializeObject();t.find(".js-delete-button").prop("disabled",!0),i.email=$.grep($.makeArray(i.email),function(e){return e}),i.email&&i.email.length&&ns.forcedRequest([{id:"do-filters-"+n.listtype+"list-remove",params:i},{id:"filters-"+n.listtype+"list"}]).then(function(){var e=t.find(".js-email-from-list input[type=checkbox]"),n=e.filter(":checked");
e.length===n.length?(t.closest(".b-filters-list__added").addClass("g-hidden"),t.find(".b-filters-list__added-list").empty()):n.closest(".b-filters-list__item-list").remove()},function(){t.find(".js-delete-button").prop("disabled",!1)})},_onSubmitFiltersListsAdd:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),n=Daria.parseQuery(t.data("params")),i=n.listtype,s=$.trim(nb.$block(".js-input-email",t).getValue()),o="black"===i?Daria.Filter.appendEmailBlackList:Daria.Filter.appendEmailWhiteList,a=t.closest(".b-filters__lists"),r=a.find(".b-filters-list_"+i),l=a.find(".b-filters-list_"+("black"===i?"white":"black"));
nb.$block(".js-button-submit",t).disable(),t.find(".b-notification").addClass("g-hidden");var d=o(s);d.done(function(){r.find(".b-filters-list__added").removeClass("g-hidden").find(".b-filters-list__added-list").prepend(Jane.tt("setup:filters-lists-emails-email",{addresses:s})),l&&(l.find(".js-email-from-list input[type=checkbox]").filter(function(){return this.value===s}).closest(".b-filters-list__item-list").remove(),l.find(".b-filters-list__item-list").length||l.find(".b-filters-list__added").addClass("g-hidden")),nb.$block(".js-input-email",t).setValue(""),Daria.Dialog.close()
}).always(function(){nb.$block(".js-button-submit",t).enable()}).fail(function(e){switch(e){case"required":t.find(".b-notification_error-required").removeClass("g-hidden");break;case"pattern":t.find(".b-notification_error-pattern").removeClass("g-hidden");break;case"own-email":t.find(".b-notification_error-own-email").removeClass("g-hidden");break;case"already":t.find(".b-notification_error-already").removeClass("g-hidden").find(".b-notification__var-email").text(s);break;default:Daria.Statusline.showMsg({name:"setup.filters-lists-add-error",body:"Произошла ошибка. Мы уже в курсе случившегося и стараемся исправить её как можно скорее."})
}}).progress(function(e,n){switch(e){case"cancel":nb.$block(".js-button-submit",t).enable();break;case"is-yandex-email":n=n||{};var o;o=$.isPlainObject(n)?"<p>Добавив этот адрес в чёрный список, вы больше не сможете получать уведомления от сервиса Яндекса.</p> <p>Занести адрес в чёрный список?</p>":"<p>Добавив этот адрес в чёрный список, вы больше не сможете получать уведомления от сервиса Яндекс."+n.name+'.</p> <p><a target="_blank" href="'+n.unsubscribeLink+'">Отписаться</a> от получения уведомлений?</p>',Daria.Dialog.open({body:o,onclose:function(){d.notify("cancel")
},buttons:[{name:"submit",value:"Всё равно перенести",onclick:function(){d.notify("ok")}},{name:"cancel"}]});break;case"already-in-anti":Daria.Dialog.confirm({title:"",body:"black"===i?"<p>Вы хотите добавить в чёрный список адрес из белого списка. После добавления адрес "+s+" будет заблокирован, и вы перестанете получать с него письма. Продолжить?</p>":"<p>Вы хотите добавить в белый список адрес из чёрного списка. После добавления адрес "+s+" будет разблокирован, и вы начнёте получать с него письма. Продолжить?</p>",width:350,okValue:"Да",cancelValue:"Нет",okHandler:function(){d.notify("ok")
},onclose:function(){d.notify("cancel")}})}})},_onClickFiltersOff:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),n=t.data("filid");ns.forcedRequest([{id:"do-filters-off",params:{id:n,enabled:0}},{id:"filters"}]).then(function(){var e=t.closest(".b-switch");e.removeClass("b-switch_on").addClass("b-switch_off"),e.closest(".b-filters-filter").addClass("b-filters-filter_disabled").removeClass("b-filters-filter_enabled")})},_onClickFiltersOn:function(e){e.preventDefault(),e.stopPropagation();
var t=$(e.currentTarget),n=t.data("filid");ns.forcedRequest([{id:"do-filters-on",params:{id:n,enabled:1}},{id:"filters"}]).then(function(){var e=t.closest(".b-switch");e.removeClass("b-switch_off").addClass("b-switch_on"),e.closest(".b-filters-filter").removeClass("b-filters-filter_disabled").addClass("b-filters-filter_enabled")})},_onClickFiltersDelete:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),n=t.data("filid"),i=this;Daria.Dialog.open({title:"Удаление правила",body:"<p>Вы действительно хотите удалить правило?</p>",buttons:[{name:"submit",value:"Удалить",onclick:function(){Daria.Dialog.close(),Daria.Filter.removeById(n).done(function(){t.closest(".b-filters-filter").remove();
var e=ns.Model.get("filters").get('.action[!.hidden && .condition.field != "X-yandex-rpop-id"]');e&&e.length||i.$node.find(".b-filters__created, .b-filters__created-title").remove(),ns.events.trigger("daria:vMessages:invalidate")})}},{name:"cancel"}]})},onClickFiltersCreate:function(){ns.page.go("#setup/filters-create")}}})}(),ns.View.define("setup-filters-confirm",{models:{"filters-check-owner":!0},yateModule:"setup"}),function(){ns.ViewCollection.define("messages-preview",{models:{settings:!1,labels:!1,filters:!1,"filters-preview":!0},split:{byModel:"filters-preview",intoViews:"messages-item-preview"},params:function(e){return e
},events:{"ns-view-init":"_onInit","ns-view-hide":"_onViewHide","ns-view-show":"_onViewShow","ns-view-htmlinit":"_onHtmlInit","ns-page-before-changed":"_beforeChanged","click@show .js-preview-scroll-top":"_onClickScrollTop","click@show .js-preview-more":"_onClickLoadMore"},yateModule:"setup",methods:{_onInit:function(){"logic"in this.params||this._setEmptyPreviewModel()},_onHtmlInit:function(){if("logic"in this.params){this.$node.find(".b-messages__message__checkbox,.js-toggle-important").remove();
var e=this.$node.find(".js-preview-list"),t=e.is(":empty");this.$node.find(".js-preview-buttons,.js-preview-header").toggleClass("g-hidden",t),this.$node.find(".js-preview-empty").toggleClass("g-hidden",!t)}},_onViewShow:function(){Jane.c("Применение правила к старым письмам","Клик по проверить"),this._previewDestroy=no.nop},_onViewHide:function(){this._moreUpdate||this._previewDestroy(),this._previewDestroy=no.nop},__previewDestroy:function(){this.getModel("filters-preview").destroy()},_beforeChanged:function(){"logic"in this.params?this.getModel("filters-preview").invalidate():this._setEmptyPreviewModel()
},_setEmptyPreviewModel:function(){this.getModel("filters-preview").setData({list:{message:[]}})},_onClickLoadMore:function(e){if(e.preventDefault(),!this._lock){var t=this;this._lock=!0;var n=this.getModel("filters-preview"),i=_.clone(this.params);i.offset=n.models.length;var s=ns.Model.get("filters-preview",i);ns.request.models([s]).then(function(){s.models.length||t.$node.find(".js-preview-more").addClass("g-hidden"),n.insert(s.models),t._moreUpdate=!0,t.update().always(function(){t._moreUpdate=!1,t._previewDestroy=t.__previewDestroy
})}).always(function(){t._lock=!1})}},_onClickScrollTop:function(e){if(e.preventDefault(),e.stopPropagation(),Daria.is3pane())$(".b-layout__inner").scrollTop(0);else{var t=this.$node.closest(".ns-view-setup-filters-create").offset().top;$(window).scrollTop(t)}}}})}(),ns.View.define("messages-item-preview",{models:{"filters-preview-message":!0,labels:!1,settings:ns.View.defineModelEvents({"ns-model-changed.enable_firstline":"forceUpdate","ns-model-changed.messages_avatars":"invalidate"}),"module-setup":!1},params:{ids:null},yateModule:"setup"}),ns.View.define("setup-filters-create-common",{events:{"submit .js-form-add":"add"},yateModule:"setup",methods:{add:function(e){e.preventDefault();
var t=$(e.currentTarget),n=nb.$block(".js-add-button",t);t.prop("disabled",!0),n.disable();var i=Daria.FilterSimpleCreate({form:t,validate:function(e){return Daria.SetupFiltersCreate.validate(t,e)},success:function(){var e=ns.router.generateUrl("setup",{tab:"filters"});ns.page.go(e)},complete:function(){n.enable(),t.prop("disabled",!1)},error:function(){n.enable(),t.prop("disabled",!1)}});i.create().then(null,function(){n.enable(),t.prop("disabled",!1)})},_bindSelectEvents:function(t){var n=t.nbSelect;
n.on("nb-changed",function(){n.getState().value===t.runThen&&ns.action.run(t.actionToRun).then(function(t){e(n,{text:t.name,value:t.id,selected:!0})})})}}}),ns.View.edefine("setup-filters-create",{models:{"account-information":!0,folders:!1,labels:!1,filters:!0,"setup-menu":!0,settings:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onshow","ns-view-hide":"onhide","vSetupFiltersCreate:needEnterPassword@show":"_onNeedEnterPassword","submit@show .js-form-edit":"_editFilter","click@show .js-filters-condition-add":"_addCondition","click@show .js-filters-condition-delete":"_deleteCondition","click@show .js-preview":"_preview","click@show .js-filter-apply":"_applyFilter"},"params+":{id:null,message:null,thread:null,folder:null,label:null},yateModule:"setup",methods:{onHtmlInit:function(){this.$form=this.$node.find(".js-form"),this._initialFormParams=this.$form.serializeObject();
var e=this.params.message||this.params.thread;e&&!this.mMessageData&&ns.request("message",{ids:e}).then(function(e){this.mMessageData=e[0].getData(),this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},this)},patchTree:function(){var e=this.super_.patchTree.call(this);return this.mMessageData&&(e["setup-new-filter-by-message"]=this.mMessageData),e},onshow:function(e){var t=this;nb.init(this.$node),this.nbDependenceController=new Daria.NbDependenceController(this.$node,"setup-filters-create"),this.nbSelectLetterType=nb.$block(".js-letter_type_select",this.$node),this.nbInputForwardAddress=nb.$block(".js-forward_address",this.$node),this.nbInputNotifyAddress=nb.$block(".js-notify_address ",this.$node),this.nbLabelsSelect=nb.$block(".js-labels-select",this.$node),this.nbFoldersSelect=nb.$block(".js-move_folder",this.$node);
var n=this.nbFoldersSelect.getSource()[0];this.nbSelectLetterType.on("nb-changed",function(){"nospam"==this.getState().value?t.nbFoldersSelect.removeFromSource(0):t.nbFoldersSelect.addToSource(n,0)}),this.nbSelectLetterType.trigger("nb-changed",this.nbSelectLetterType),this.bindEvents(),this._bindConditionFields(this.$node.find(".b-form-layout__field_conditions .b-form-layout__line:last")),e.id||nb.$block(".js-filters-condition-add",this.$node).focus();var i=this.$node.find(".js-preview-table");i.css("max-width",i.width())
},onhide:function(){this.invalidate(),this.nbDependenceController.destroy(),nb.destroy(this.$node)},bindEvents:function(){var e=this;this._bindSelectEvents({nbSelect:this.nbFoldersSelect,runThen:"new_folder",actionToRun:"folders.add.filters"}),this._bindSelectEvents({nbSelect:this.nbLabelsSelect,runThen:"new_label",actionToRun:"labels.add.filters"}),this.nbInputForwardAddress&&(this.nbInputForwardAddress.on("nb-focused",this._bindAutocompleterToField),this.nbInputForwardAddress.on("focusin",this._bindAutocompleterToField.bind(this.nbInputForwardAddress)),this.nbInputForwardAddress.on("nb-changed",function(){Daria.SetupFiltersCreate.validate(e.$node,{params:{clicker:"forward"}})
})),this.nbInputNotifyAddress.on("nb-focused",this._bindAutocompleterToField),this.nbInputNotifyAddress.on("focusin",this._bindAutocompleterToField.bind(this.nbInputNotifyAddress))},_addCondition:function(e){var t=$(e.target),n=t.closest(".b-form-layout__block"),i=n.find(".b-form-layout__field_conditions"),s=Jane.tt("setup:filters-condition-new",null,["filters"]);i.append(s),nb.init(i),this._bindConditionFields(s);var o=i.find(".b-form-layout__button_delete").length;return 1==o?n.removeClass("b-form-layout__block_setup-filter-filters-start"):2==i.find(".b-form-layout__button_delete").length&&i.removeClass("b-form-layout__field_show-one-mode"),i.find(".b-form-element__input-text:last").focus(),!1
},_bindConditionFields:function(e){function t(){var e=s.getState().value;i.test(e)&&(this.$control.attr("name","field"+(new Date).getTime()),n._bindAutocompleterToField.call(this),this.$control.one("blur",function(){this.$control.attr("name","field3")}.bind(this)))}var n=this,i=/from|to|cc/,s=nb.$block(".js-condition-field-field1",e),o=nb.$block(".js-condition-field-field3",e);s&&o&&(o.on("nb-focused",t),o.on("focusin",t.bind(o)),s.on("nb-changed",function(){var e=s.getState().value;i.test(e)||Daria.Autocompleter.getContact().destroy();
var t=this,n=this.getSource(),o=n[n.length-1],a=n[n.length-1].value;if(e===a){var r=Jane.tt("setup:filters-sender-create",{value:a}),l=$(r),d=nb.$block(".nb-input",l),c=function(){var e=$.trim(d.getValue());e?(o.text='Заголовок "'+e+'"',o.value=e,t.setSource(n),t.setState(o)):(o.text="Заголовок",o.value="sender",t.setSource(n),t.setState({value:"subject"})),Daria.Dialog.close()};Daria.Dialog.open({title:"Заголовок",body:l,buttons:[{name:"submit",value:"Сохранить",onclick:c},{name:"cancel"}],onopen:function(){d.focus()
}}),d.$control.keyup(function(e){13===e.keyCode&&c()})}}))},_deleteCondition:function(e){var t=$(e.target),n=t.closest(".b-form-layout__block"),i=n.find(".b-form-layout__field_conditions"),s=t.closest(".b-form-layout__line");nb.destroy(s),s.remove();var o=i.find(".b-form-layout__button_delete").length;1===o?i.addClass("b-form-layout__field_show-one-mode"):0===o&&n.addClass("b-form-layout__block_setup-filter-filters-start")},_bindAutocompleterToField:function(){var e=Daria.Autocompleter.getContact();
e.setOptions({multiple:!1,formatResult:function(e){if(e.contacts){for(var t=[],n=0,i=e.contacts.length;i>n;n++)t.push(e.contacts[n].email);return t.join(", ")}return e.email}}),e.bindField({field:this.$control,focus:1})},_reset:function(){this._dialog&&this._dialog.$body.find('input[type="text"]').val("")},_getTries:function(){return Jane.watcher.get("filterPasswordTries")||0},_incTries:function(){Jane.watcher.set("filterPasswordTries",this._getTries()+1)},_resetTries:function(){Jane.watcher.set("filterPasswordTries",0)
},_getCaptcha:function(){var e=this;ns.forcedRequest("captcha",{type:"nlatm"}).then(function(t){var n=t[0].data;e._captchaInfo={key:n._,picUrl:n.url},e._showCaptcha()})},_showCaptcha:function(){if(this._dialog){var e=this._dialog.$body;e.find(".b-captcha__image").attr("src",this._captchaInfo.picUrl),e.find(".b-notification_captcha").removeClass("g-hidden")}},_onSuccessPasswordCheck:function(e){return this._captchaInfo=null,this._dialog.close(),$("body").focus(),this._resetTries(),vow.Promise.resolve(e)
},_onFailPasswordCheck:function(e){this._reset();var t=this._dialog.$body,n=!1,i=!1;e.hasOwnProperty("passwordCheck")&&(this._incTries(),this._getTries()>2&&this._getCaptcha(),n=!e.passwordCheck,t.find(".b-notification_error-password").toggleClass("g-hidden",e.passwordCheck)),e.hasOwnProperty("captchaCheck")&&(i=!e.captchaCheck,t.find(".b-notification_error-captcha").toggleClass("g-hidden",e.captchaCheck),e.hasOwnProperty("passwordCheck")||t.find(".b-notification_error-password").addClass("g-hidden")),(n||i)&&this._onErrorPassword()
},_onSubmit:function(){var e,t=this,n=this._dialog.$body,i=n.find('[name="password"]').val();if(!i)return void n.find(".b-notification_error-password").removeClass("g-hidden");if(this._captchaInfo&&(e=$.trim(n.find('[name="captcha_entered"]').val()),!e))return this._reset(),n.find(".b-notification_error-captcha").removeClass("g-hidden"),void this._getCaptcha();n.find(".js-setup-filters-error").addClass("g-hidden");var s=[],o=vow.Promise.resolve(),a=function(e){var n=_.find(e,"id","do-filters-add"),i=n&&n.getError();
return"password_check"===i?(t._onFailPasswordCheck({passwordCheck:!1}),vow.Promise.reject()):i?vow.Promise.reject():(t._onFailPasswordCheck({passwordCheck:!0}),vow.Promise.resolve(e))},r=function(e){var n=_.find(e&&e.invalid,"id","do-filters-add"),i=_.find(e&&e.invalid,"id","do-filters-edit"),s=n&&n.getError()||i&&i.getError();return t._onFailPasswordCheck({passwordCheck:"password_check"!==s}),vow.Promise.reject(e)},l=function(e){var n=_.find(e,"id","captcha-check");return!n||"ok"===n.status&&"ok"===n.data.status?(t._onFailPasswordCheck({captchaCheck:!0}),vow.Promise.resolve(e)):(t._onFailPasswordCheck({captchaCheck:!1}),vow.Promise.reject(e))
},d=function(e){var n=_.find(e,"id","filters-check-password");return!n||"ok"===n.status&&"true"===n.data.body.check?(t._onFailPasswordCheck({passwordCheck:!0}),vow.Promise.resolve(e)):(t._onFailPasswordCheck({passwordCheck:!1}),vow.Promise.reject(e))};this._captchaInfo&&s.push({id:"captcha-check",params:{type:"nlatm",captcha_key:this._captchaInfo.key,captcha_entered:e}}),this._onActionPassword?(s.length&&(o=ns.forcedRequest(s).then(l)),o=o.then(function(){return this._onActionPassword({password:i})
},this),o.then(a,r).then(this._onSuccessPasswordCheck,this).then(this._onSuccessPassword,this)):(s.push({id:"filters-check-password",params:{password:i}}),ns.forcedRequest(s).then(l).then(d).then(this._onSuccessPasswordCheck,this).then(this._onSuccessPassword,this))},_onNeedEnterPassword:function(e,t){this.enterPassword({title:"Для изменения этого правила нужно ввести пароль:",action:t.action,onSuccess:t.onSuccess,onError:t.onError,onCancel:t.onCancel})},enterPassword:function(e){var t=this,n=Jane.Common.keyCode;
e=e||{};var i=e.title||"Введите пароль от вашего ящика";this._onSuccessPassword=e.onSuccess||_.constant(vow.Promise.resolve()),this._onErrorPassword=_.once(e.onError||_.noop),this._onActionPassword=e.action,this._dialog=Daria.Dialog.open({body:Jane.tt("setup:js-filters-check-password"),title:i,width:430,onopen:function(){var e=$(this.body),i=e.find('[name="password"]');i.on("keyup",function(s){var o=i.val(),a=!/^[-a-z0-9.`!@#$%^&*()_=+\[\]{};:"\\|,<>\/?]*$/i.test(o);return e.find(".b-notification__error").addClass("g-hidden"),a?void e.find(".b-notification_error-invalid-password").removeClass("g-hidden"):void(s.keyCode===n.ENTER&&t._onSubmit())
}),e.on("keyup",".js-filters-captcha",function(e){e.keyCode===n.ENTER&&t._onSubmit()}),e.on("click",".js-reload-captcha",t._getCaptcha.bind(t)),i.keyup().focus(),t._captchaInfo&&t._showCaptcha()},oncancel:function(){e.onCancel&&e.onCancel()},buttons:[{name:"submit",value:"Подтвердить",onclick:t._onSubmit.bind(t)},{name:"cancel"}]})},_preview:function(e){e.preventDefault();var t=this.$form.serializeObject();Daria.SetupFiltersCreate.processParams(t),Daria.SetupFiltersCreate.validate(this.$form,t)&&this.update(_.extend({},this.params,t))
},_applyFilter:function(e){e.preventDefault();var t=this,n=this.$form,i=n.serializeObject();if(Daria.SetupFiltersCreate.validate(n,i)){var s=n.find(".js-setup-filter-forward-checkbox"),o={$form:n,isValid:!0},a=!1;if(s.each(function(){var e=nb.block(this).isChecked();return e?(a=!0,!1):void 0}),a)var r=Daria.Dialog.open({body:Jane.tt("setup:js-filters-confirm-filter-without-forward",i),width:430,buttons:[{name:"submit",value:"Продолжить",onclick:function(){r.close(),t.applyFilter(o)}},{name:"cancel"}]});
else t.applyFilter(o);Jane.c("Применение правила к старым письмам","Клик по применить")}},applyFilter:function(e){ns.action.run("filters.edit",{$form:e.$form,isValid:e.isValid,refresh:!0,callback:function(e){ns.forcedRequest("filters-apply",{id:e}).then(function(){ns.page.go("#setup/filters").then(function(){ns.Model.invalidate("folders"),ns.Model.invalidate("messages"),ns.Model.invalidate("message-nearest"),ns.Model.invalidate("message-thread-nearest"),Daria.Statusline.showMsg({name:"filters-apply",speed:"fast",body:"Фильтр применён"})
})},function(){})}})},_editFilter:function(e){e.preventDefault(),ns.action.run("filters.edit",{$form:this.$node.find(".js-form")})}}},"setup-filters-create-common"),Daria.SetupFiltersCreate={validate:function(e,t){var n=!0,i=e.find(".b-notification").addClass("g-hidden"),s=e.find(".b-form-element__input-text[name=field3]"),o=$.isArray(t.clicker)?t.clicker:[t.clicker],a=$.isArray(t.field3)?t.field3:[t.field3],r=t.letter,l="1"==jpath(t,".logic2.or")[0],d=0;return $.each(a,function(e,t){""===t?(i.filter(".b-notification_error-empty-field3").eq(e).removeClass("g-hidden"),n&&s.eq(e).focus(),n=!1):d++
}),l&&(d>0||"1"===t.attachment)&&(i.filter(".b-notification_error-empty-field3").addClass("g-hidden"),n=!0),0===o.length?(Daria.Statusline.showMsg({body:"Укажите действие, которое нужно выполнить"}),!1):"name"in t&&!t.name?(Daria.Statusline.showMsg({body:"Укажите название фильтра"}),!1):t.move_folder&&!ns.Model.get("folders").getFolderById(t.move_folder)?(Daria.Statusline.showMsg({body:"Папка не выбрана"}),!1):-1!==$.inArray("reply",o)&&t.autoanswer.length>2e3?(i.filter(".b-notification_error-reply-too-long").removeClass("g-hidden"),!1):!(-1!==$.inArray("delete",o)||t.move_folder&&ns.Model.get("folders").spamOrTrash(t.move_folder))||"nospam"!=r&&"all"!=r||t.field1&&t.field3?-1===$.inArray("forward",o)||"clearspam"!=r&&"all"!=r?($.each(o,function(e,s){if("forward"===s||"notify"===s){var o=ns.Model.get("account-information").getEmails(),a=t[s+"_address"];
if(Jane.FormValidation.checkEmail(a)){var r=new RegExp("^"+Daria.regexpEscape(a)+"$");o.forEach(function(e){r.test(e)&&(i.filter(".b-notification_error-self-address-"+s).removeClass("g-hidden"),n=!1)})}else i.filter(".b-notification_error-pattern-"+s).removeClass("g-hidden"),n=!1}}),n):(Daria.Statusline.showMsg({body:"Для писем из папки «Спам» пересылка писем с помощью фильтра невозможна."}),!1):(Daria.Statusline.showMsg({body:"Нельзя настроить правило с указанными условиями"}),!1)},processParams:function(e){if($.isArray(e.clicker)){var t={};
e.clicker=$.map(e.clicker,function(e){return t[e]||""===e?null:(t[e]=!0,e)})}}},Daria.FilterSimpleCreate=function(e){return $.extend({create:function(){var e=this,t=_.isFunction(this.complete)?this.complete:_.noop,n=this.form&&this.form.serializeObject()||{},i=$.extend(n,this.params);if(Daria.SetupFiltersCreate.processParams(i),!this.validate($.extend({logic2:{or:1}},i)))return this.error&&this.error(),Vow.reject("Form validation failed");if("on"===i.forward_with_store)for(var s=0,o=i.clicker.length;o>s;s++)i.clicker[s]="forward"===i.clicker[s]?"forwardwithstore":i.clicker[s];
var a,r=function(e){return ns.forcedRequest([{id:"do-filters-add",params:_.assign({},i,e)},{model:ns.Model.get("filters").getMasterRequest()}])},l=function(t){var n=_.find(t,"id","do-filters-add"),i=n.get(".id");return i?($.isFunction(e.success)&&e.success(i),vow.Promise.resolve(t)):vow.Promise.reject()},d=function(){Daria.Statusline.showMsg({body:"Произошла ошибка"})},c=["forward","forwardwithstore","notify","reply"];return a=_.isEmpty(_.intersection($.makeArray(i.clicker),c))?r().then(l,d):new vow.Promise(function(e,t){ns.events.trigger("vSetupFiltersCreate:needEnterPassword",{action:r,onSuccess:function(n){l(n).then(e,d).fail(t)
},onError:function(){d(),t()},onCancel:function(){t()}})}),a.always(t)}},e)},Daria.FilterSimpleCreatePopup=function(e){var t=Daria.FilterSimpleCreate();return $.extend(t,{validate:function(){return this.form.find("input[name=field3],input[name=attachment]").filter(function(){return"text"==this.type&&$.trim(this.value)||this.checked}).size()},bindAutocompleter:function(){var e=Daria.Autocompleter.getContact();e.setOptions({multiple:!1,formatResult:function(e){if(e.contacts){for(var t=[],n=0,i=e.contacts.length;i>n;n++)t.push(e.contacts[n].email);
return t.join(", ")}return e.email}}),e.bindField({field:this.form.find(".b-form-element__input-text_from").get(0),focus:1})},params:{}},e),t},Daria.FilterSimpleCreatePopupSingle=function(e){var t=Daria.FilterSimpleCreatePopup();return $.extend(t,{complete:function(){Daria.Dialog.close()},success:function(e){Daria.Statusline.showMsg({body:'<a href="#setup/filters-create/id='+e+'">Фильтр</a> создан'})},error:function(){var e=this;this.form.addClass("b-popup__field_error"),this.form.find("input:text").keyup(function(){e.form.removeClass("b-popup__field_error"),$(this).off("keyup")
}).eq(0).focus()}},e),t},ns.View.edefine("setup-filters-create-simple",{models:{folders:!0,labels:!0,"setup-menu":!0},events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","ns-view-hide":"onhide"},"params+":{action:null},yateModule:"setup",methods:{onhtmlinit:function(){Daria.indexer.reindexUser(!0),$(".b-form-element__input-text_from",this.$node).focus(function(){var e=Daria.Autocompleter.getContact();e.setOptions({multiple:!1,formatResult:function(e){function t(e){return e.email}if(e.contacts){for(var n=[],i=0,s=e.contacts.length;s>i;i++)n.push(t(e.contacts[i]));
return n.join(", ")}return t(e)}}),e.bindField({field:this,focus:1})})},onshow:function(){nb.init(this.$node);var e=nb.$block(".setup-filters-create-simple-folder",this.$node);e&&this._bindSelectEvents({nbSelect:e,runThen:"new_folder",actionToRun:"folders.add.filters"});var t=nb.$block(".setup-filters-create-simple-label",this.$node);t&&this._bindSelectEvents({nbSelect:t,runThen:"new_label",actionToRun:"labels.add.filters"})},onhide:function(){nb.destroy(this.$node),this.invalidate()}}},"setup-filters-create-common"),ns.View.define("setup-folders",{models:["settings","folders","labels","setup-menu","filters"],events:{"ns-view-htmlinit":function(){nb.init(this.node);
var e=this.$node.find(".b-manager"),t=Jane.watcher.get("setup-folders-scroll-pos");t&&(this.$node.find(".js-folder-container").scrollTop(t),Jane.watcher.set("setup-folders-scroll-pos",null));var n=Jane.watcher.get("setup-labels-scroll-pos");n&&(this.$node.find(".js-labels-container").scrollTop(n),Jane.watcher.set("setup-labels-scroll-pos",null)),this.foldersList=new Daria.FoldersListManager($(e[0])),this.labelsList=new Daria.LabelsListManager($(e[1]))},"ns-view-htmldestroy":function(){nb.destroy(this.node),delete this.foldersList,delete this.labelsList
},"ns-view-show":function(){var e=this;nb.$block(".js-labels-sort-type",this.node).on("nb-changed",function(){e.labelsList.sort(this.getValue())}),this.getModel("settings").isSet("dnd_enabled")&&Jane.DragNDrop.enable()},"ns-view-hide":function(){nb.$block(".js-labels-sort-type",this.node).off("nb-changed"),ns.events.trigger("dragndrop.stop")},"dragndrop.dragstart@show":"_onDragndropDragstart","daria:folders.move:done":"_redrawFolderList","click@show .js-folder-switch-open":"_onClickFolderSwitchOpen","click@show .js-folder-add":"_onClickFolderAdd","click@show .js-folder-add-subfolder":"_onClickFolderAddSubfolder","click@show .js-folder-edit":"_onClickFolderEdit","click@show .js-folder-empty":"_onClickFolderEmpty","click@show .js-folder-delete":"_onClickFolderDelete","daria:folder-remove-done@show":"_redrawFolderList","click@show .js-folder-markread":"_onClickFolderMarkread","click@show .js-folder-filter":"_onClickFolderFilter","click@show .js-label-add":"_onClickLabelAdd","click@show .js-label-edit":"_onClickLabelEdit","click@show .js-label-delete":"_onClickLabelDelete","daria:label-remove-done@show":"_labelRemoveDone","click@show .js-label-filter":"_onClickLabelFilter","dragndrop.dragenter@show":"_onDragEnter","dragndrop.drop@show":"_onDrop"},yateModule:"setup",methods:{_onDragndropDragstart:function(){this.foldersList.deselectAll()
},_onDragEnter:function(e,t){this._timer=setTimeout(function(){$(t.currentTarget).closest(".b-folders__nesting").removeClass("b-folders__nesting_closed"),ns.Model.get("folder",{fid:t.fid}).switchFolded(!1)},300)},_onDrop:function(){this._timer&&clearTimeout(this._timer)},_redrawFolderList:function(){this.$node.find(".js-setup-folders-list").html(Jane.tt("setup:new-folders-list",{},["folders"])),this.foldersList.selectedItem="",this.foldersList.updateButtons({})},_afterAddFolder:function(){this._redrawFolderList()
},_afterEditFolder:function(e,t){this.$node.find(".fid-"+e+" .b-folders__folder__link").text(t)},_errorClearFolder:function(){Daria.Statusline.showMsg({body:"При очистке произошла ошибка"})},_onClickFolderSwitchOpen:function(e){e.preventDefault(),e.stopPropagation(),ns.Model.get("folder",{fid:e.currentTarget.getAttribute("data-fid")}).switchFolded(),Jane.watcher.set("setup-folders-scroll-pos",this.$node.find(".js-folder-container").scrollTop()),Jane.watcher.set("setup-labels-scroll-pos",this.$node.find(".js-labels-container").scrollTop()),ns.page.go()
},_onClickFolderAdd:function(e){e.preventDefault(),e.stopPropagation();var t=Daria.FolderCreatePopup();$.extend(t,{success:this._afterAddFolder.bind(this)}),t.init()},_onClickFolderAddSubfolder:function(e){e.preventDefault(),e.stopPropagation();var t=Daria.FolderCreatePopup({parent_id:this.foldersList.selectedItem,withoutSubfolderDialog:!0});$.extend(t,{success:this._afterAddFolder.bind(this)}),t.init()},_onClickFolderEdit:function(e){e.preventDefault(),e.stopPropagation();var t=this.foldersList.selectedItem,n=Daria.FolderEditPopup({id:t});
$.extend(n,{success:this._afterEditFolder.bind(this)}),n.init()},_onClickFolderEmpty:function(e){e.preventDefault(),e.stopPropagation();var t,n=$(e.currentTarget).data("type"),i=ns.Model.get("folders"),s=i.getFolderById(this.foldersList.selectedItem);t=i.isFolder(s.fid,["trash"])?"<p>Письма из папки будут удалены навсегда и их нельзя будет восстановить.</p>":Jane.tt("setup:js-setup-folders-dialog-folder-exclear");var o=Daria.FolderClearPopup({fid:s.fid,type:n,template:t});$.extend(o,{onsuccess:this._redrawFolderList.bind(this),onerror:this._errorClearFolder.bind(this)}),o.init()
},_onClickFolderDelete:function(e){e.preventDefault(),e.stopPropagation(),Daria.Folder.remove(this.foldersList.selectedItem)},_onClickFolderMarkread:function(e){e.preventDefault(),e.stopPropagation(),Daria.Folder.markRead(this.foldersList.selectedItem)},_onClickFolderFilter:function(e){e.preventDefault(),e.stopPropagation(),Daria.Folder.createFilter(this.foldersList.selectedItem)},_onClickLabelAdd:function(e){e.preventDefault(),e.stopPropagation();var t=Daria.LabelCreatePopup();$.extend(t,{success:function(e){this.$node.find(".js-setup-labels-list").prepend(Jane.tt("setup:new-label",{lid:e},["labels"]))
}.bind(this)}),t.init()},_onClickLabelEdit:function(e){e.preventDefault(),e.stopPropagation();var t=this.labelsList.selectedItem,n=Daria.LabelEditPopup({id:t});$.extend(n,{success:function(){this.$node.find(".js-setup-labels-list .item-"+t).replaceWith(Jane.tt("setup:new-label",{lid:t},["labels"])),this.labelsList.selectedItem=null,this.labelsList.updateButtons({})}.bind(this)}),n.init()},_onClickLabelDelete:function(e){e.preventDefault(),e.stopPropagation(),Daria.Label.remove(this.labelsList.selectedItem)
},_labelRemoveDone:function(e,t){this.$node.find(".js-setup-labels-list .item-"+t).remove(),this.labelsList.selectedItem=null,this.labelsList.updateButtons({}),ns.Model.invalidate("messages")},_onClickLabelFilter:function(e){e.preventDefault(),e.stopPropagation(),Daria.Label.createFilter(this.labelsList.selectedItem)}}}),ns.View.define("setup-index",{models:["account-information","settings","setup-menu"],yateModule:"setup"}),ns.View.define("setup-interface",{models:{settings:!0,"settings-color-schemes":!0,"setup-menu":!0,"account-information":!0},ctor:function(){this.themesSelectorInited=!1,this.grid=[0,0],this.invisible=[0,0],this.arrowsVisibility=[!1,!1],this.overArrow=null,this.allowSlide=!0,this.initialPos=Daria.getCookie("settings-interface-pos",!0)||0,Daria.delCookie("settings-interface-pos"),this.$elems=null,this.data=null
},events:{"ns-view-htmlinit":"onhtmlinit","ns-view-touch":"onrepaint","ns-view-hide":"onhide"},yateModule:"setup",methods:{LAYOUT_SAVED_COOKIE:"layout-saved",SLIDE_SPEED:700,RIGHT_MARGIN:15,FOOTER_HEIGHT:100,ARROWS:[{HIDDEN:{left:-100},VISIBLE:{left:-5}},{HIDDEN:{right:-100},VISIBLE:{right:-5}}],FIELD_RATIO:16/9,initThemesSelector:function(){var e=this;e.refreshConstantData(),e.refreshUI(!0),this.toggleEvents(!0)},toggleEvents:function(e){var t=this,n=this.$elems,i=$(window);e?(n.themesHolder.on("click.setup-interface",".b-color-scheme__theme",function(){Daria.setCookie("settings-interface-pos",n.container.css("left"),1)
}),n.arrows.on({"click.setup-interface":function(){var e=n.arrows.index(this);t.overArrow=e,t.slideThemes(e)},"mouseleave.setup-interface":function(){t.overArrow=null,t.refreshArrowVisibility(n.arrows.index(this))}}),i.on({"resize.setup-interface":function(){t.refreshUI()},"load.setup-interface":function(){t.refreshConstantData(),t.refreshUI(!0)}})):(i.add(n.arrows).off(".setup-interface"),n.themesHolder.off(".setup-interface"))},refreshConstantData:function(){this.data={themeWidth:this.$elems.themes.outerWidth(!0),themeHeight:this.$elems.themes.outerHeight(!0)}
},refreshInvisibleCount:function(){for(var e=this.invisible=[0,0],t=this.$elems.viewport.rect(),n=this.$elems.themes,i=this.grid[0],s=Math.floor(n.length/i),o=n.length%i,a=!0,r=0;i>r;r++){var l=n[r].getBoundingClientRect();if(a)l.left>=t.left&&(a=!1,e[0]=r*s+Math.min(r,o));else if(l.right>t.right){e[1]=(i-r)*s+Math.max(0,o-r);break}}},refreshArrowsState:function(){var e=this,t=e.$elems,n=e.invisible;t.arrows.each(function(i){var s=!n[i];t.arrowsTriangle.eq(i).toggleClass("b-color-scheme__control__arrow_disabled",s),t.arrowsText.eq(i).toggleClass("g-hidden",s).text("Еще "+n[i]),e.refreshArrowVisibility(i)
})},refreshArrowVisibility:function(e){var t=!!this.invisible[e];if(t!==this.arrowsVisibility[e]&&(t||!t&&this.overArrow!==e)){this.arrowsVisibility[e]=t;var n=this.ARROWS[e][t?"VISIBLE":"HIDDEN"];this.$elems.arrows.eq(e).stop(!0,!1).animate(n)}},refreshThemesField:function(){var e=arguments[0],t=this.$elems,n=this.data,i=this.grid,s=$(window).height()-t.themesHolder.offset().top-this.FOOTER_HEIGHT,o=t.themes.length,a=Math.max(1,Math.floor(s/n.themeHeight)),r=Math.ceil(o/a);if(r/a<this.FIELD_RATIO&&(r=Math.ceil(Math.sqrt(o*n.themeHeight*this.FIELD_RATIO/n.themeWidth)),a=Math.ceil(o/r)),i[0]!==r||i[1]!==a){i[0]=r,i[1]=a,t.themesHolder.css({width:r*n.themeWidth,height:a*n.themeHeight});
var l=e?this.initialPos:0;t.container.css("left",l)}},slideThemes:function(e){var t=this;if(t.allowSlide&&t.invisible[e]){t.allowSlide=!1;var n=t.$elems,i=e?-1:1,s=n.container.position().left,o=n.viewport.width(),a=i*(o-2*t.data.themeWidth),r=Math.min(0,Math.max(s+a,o-n.themesHolder.width()-this.RIGHT_MARGIN)),l=Math.abs(r-s)/this.SLIDE_SPEED*1e3;n.container.stop(!0,!1).animate({left:r},l,function(){t.allowSlide=!0,t.refreshInvisibleCount(),t.refreshArrowsState()})}},refreshUI:function(){this.refreshThemesField(arguments[0]),this.refreshInvisibleCount(),this.refreshArrowsState()
},сhangeLayout:function(e){var t=this.LAYOUT_SAVED_COOKIE;if(e!==Daria.Config.layout){ns.Model.get("settings").setSettings({first_show_3pane:"on"}),Daria.setCookie(t,1);var n=Math.max(0,$.inArray(e,Jane.LAYOUTS));ns.Model.get("settings").setSettings({layout:n},function(e,t){_.isEmpty(t)?Jane.Page.forceReload(Jane.Page.loadingHash):alert("Ошибка. Не удалось загрузить данные, повторите через некоторое время.")})}else Daria.getCookie(t)&&(Daria.delCookie(t),this.$savedBlock=this.$currentBlock.find(".js-saved").removeClass("g-hidden"))
},onhtmlinit:function(){var e=this.$elems={viewport:this.$node.find(".b-color-scheme"),container:this.$node.find(".b-color-scheme__inner"),arrows:this.$node.find(".b-color-scheme__control")};e.arrowsText=e.arrows.find(".b-color-scheme__control__text"),e.arrowsTriangle=e.arrows.find(".b-color-scheme__control__arrow"),e.themesHolder=e.container.find(".js_custom_themes"),e.themes=e.themesHolder.find(".b-color-scheme__theme"),e.layoutBlocks=this.$node.find(".b-setup__layout"),e.layoutBtns=this.$node.find(".b-mail-button_filter")
},onrepaint:function(e,t){var n=t.layout,i=".js-"+t.layout;n==Daria.Config.layout&&(this.$currentBlock=this.$elems.layoutBlocks.addClass("g-hidden").filter(i).removeClass("g-hidden")),this.$elems.layoutBtns.removeClass("b-mail-button_filter-selected").filter(i).addClass("b-mail-button_filter-selected"),this.сhangeLayout(n),"2pane"===n&&(this.themesSelectorInited?this.refreshUI():(this.themesSelectorInited=!0,this.initThemesSelector()))},onhide:function(){this.themesSelectorInited=!1,this.toggleEvents(!1),this.$savedBlock&&(this.$savedBlock.addClass("g-hidden"),this.$savedBlock=null)
}}}),ns.View.define("setup-journal",{models:["journal","folders","labels"],events:{},yateModule:"setup"}),function(){ns.View.define("setup-left",{events:{"ns-view-hide":"onHide","ns-view-show":"onShow","ns-view-touch":function(e,t){var n=t.tab;n&&0===n.indexOf("filters")&&(n="filters"),n&&0===n.indexOf("collector")&&(n="collectors"),this.activeFolder&&this.getSetupItem(this.activeFolder).removeClass("mail-NestedList-Item_current"),n?(this.activeFolder=n,this.getSetupItem(n).addClass("mail-NestedList-Item_current")):this.activeFolder=null
}},yateModule:"setup",methods:{activeFolder:null,onHide:function(){ns.events.trigger("daria:vApp:enableLeftColumnResize"),$(document).off(".setup-left")},onShow:function(){ns.events.trigger("daria:vApp:disableLeftColumnResize"),$(document).on("click.setup-left",".js-setup-timezone",this.onChangeTimezone.bind(this))},getSetupItem:function(e){return this.$node.find(".js-setup-item_"+e)},onChangeTimezone:function(e){e.preventDefault();var t=$(e.currentTarget),n=t.text(),i=t.data("value");this.$node.find(".js-timezone").text(n).attr("title",n),Daria.Dropdown.closeCurrent();
var s=Vow.promise();s.then(Daria.IS_CORP?this._changeTimezoneRequestCorp:this._changeTimezoneRequestCommon,this).then(this._changeTimezoneRequestInfo,this).then(this._changeTimezoneSuccess,this),s.fulfill(i)},_changeTimezoneRequestCorp:function(e){return ns.forcedRequest("do-staff-settings",{tz:e})},_changeTimezoneRequestCommon:function(e){return ns.forcedRequest("timezone-edit",{timezone:e})},_changeTimezoneRequestInfo:function(){var e=Vow.promise();return ns.forcedRequest("account-information",{}).then(function(t){var n=t[0];
e.fulfill(n.get(".tz_offset"))}),e},_changeTimezoneSuccess:function(e){Daria.tz_offset=e,Daria.IS_CORP&&(Daria.Statusline.showMsg({name:"setup-updates",body:'Настройки сохранены. Перейти во <a href="#inbox" class="b-statusline__link">Входящие</a>'}),ns.Model.invalidate("messages"),ns.Model.invalidate("message-nearest"))}},models:["account-information","languages","setup-menu","timezones"]})}(),ns.View.define("setup-other",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-shortcuts-help":"onShowShortcutsHelp","keypress@show .js-messages-per-page":"onMessagesPerPageChange","keydown@show .js-messages-per-page":"onMessagesPerPageKeydown","submit@show .js-setup-form":"onSubmitSetupForm","beforeunload@show window":"onBeforeUnloadPage","form-cacher.unchanged@show":"onFormCacherUnchanged"},models:{"setup-menu":!1,settings:{"ns-model-changed":"onSettingsChange","ns-model-changed.show_advertisement":"onChangedShowAdvertisement","ns-model-changed.messages_per_page":"onChangedMessagesPerPage","ns-model-changed.dnd_enabled":"onChangedDndEnabled","ns-model-changed.disable_inboxattachs":"onChangedDisableInboxattachs","ns-model-changed.enable_hotkeys":"onChangedEnableHotkeys"}},yateModule:"setup",ctor:function(){this.operaArrowPressed=!1,this._pageReload=this._pageReload.bind(this),this._pageReloadOnce=_.noop
},methods:{onHtmlInit:function(){var e=this;this.$node.find(".js-setup-form-container").each(function(){var t=$(this);e.addFormCacher(t),new Daria.NbDependenceController(t,_.uniqueId(e.id))})},onShow:function(){this.onPageLeave()},onHide:function(){this.offPageLeave()},onShowShortcutsHelp:function(e){e.preventDefault(),"undefined"!=typeof Daria.Shortcuts&&Daria.Shortcuts.showShortcutsHelp()},onMessagesPerPageKeydown:function(e){var t=[37,38,39,40];this.operaArrowPressed=Modernizr.opera&&_(t).contains(e.which)
},onMessagesPerPageChange:function(e){var t=[0,9,8,48,49,50,51,52,53,54,55,56,57];e.ctrlKey||e.metaKey||_(t).contains(e.which)||this.operaArrowPressed||e.preventDefault(),this.operaArrowPressed=!1},onSettingsChange:function(e,t){return this.isVisible()?void(t?this.invalidate():document.location.reload()):void this.invalidate()},onChangedShowAdvertisement:function(){this.isVisible()&&(this._pageReloadOnce=_.once(this._pageReload))},onChangedMessagesPerPage:function(){this.isVisible()&&ns.Model.invalidate("messages")
},onChangedDndEnabled:function(){this.isVisible()&&(this.getModel("settings").getSign("dnd_enabled")?Jane.DragNDrop.enable():Jane.DragNDrop.disable())},onChangedDisableInboxattachs:function(){this.isVisible()&&ns.events.trigger("daria:vSetupOther:inboxattachs-changed")},onChangedEnableHotkeys:function(){if(this.isVisible()){var e=this.getModel("settings").getSign("enable_hotkeys")?"on":"off";ns.events.trigger("toggleShortcuts",e)}},onFormCacherUnchanged:function(){this._pageReloadOnce()},_pageReload:function(){document.location.reload()
}}},"setup-form"),ns.View.define("setup-security",{models:["settings","setup-menu","account-information"],yateModule:"setup"}),function(){ns.View.define("setup-sender-editor-mixin",{yateModule:"setup",methods:{getEditorId:function(){throw new Error("Daria.vSetupSenderEditorMixin.getEditorId не имеет реализации")},getEditor:function(){var e=CKEDITOR.instances[this.getEditorId()];return e&&"ready"===e.status?e:void 0},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},toggleLock:function(e){var t=this.getEditor();
t&&t.setReadOnly(e)},focusEditor:function(){var e,t=this.getEditor();t&&(t.focus(),e=t.createRange(),e.moveToElementEditEnd(e.root),t.getSelection().selectRanges([e]))},onPastefileDrop:function(e){e.data.info&&e.data.info.hasImage&&Daria.Dialog.notice({title:"Произошла ошибка",body:"<p>Превышен максимальный размер файла (7МБ). Сократите, пожалуйста.</p>",width:500,hideCrossClose:!0})}}})}(),function(){function e(t,n){this.id=e.uniqueID(),this.name="signature_"+this.id,this.$node=n,this.data=t||{},this._changed=!1
}ns.action.define("setup.signature.change.lang",function(e,t){ns.events.trigger(e,t)}),e.uniqueID=function(){var e=0;return function(){return e++}}(),_.extend(e.prototype,ns.View.info("setup-sender-editor-mixin").methods),e.prototype.getEditorId=function(){return this.$node&&this.$node.length?this.$node.find("textarea").attr("id")||"":""},e.prototype.insertAfter=function(e){var t=Jane.tt("setup:js-setup-signatures",{id:this.id,name:this.name,text:this.data.convert,emails:this.data.emails,lang:this.data.lang,userLang:this.data.userLang},["settings","signature-langs"],ns.page.current.params);
return this.$node=$(t).insertAfter(e),t.signature=this,this},e.prototype.remove=function(){this.$node&&(this.destroyEditor(),this.$node.remove())},e.prototype.update=function(e){return this.data=e,this._changed=!1,this.$node&&(this.$node.find(".js-setup-signature-text").html(this.data.convert),this.$node.find(".js-setup-signature-emails").html(this.data.emails.join(", ")),this.$node.find(".js-setup-signature-lang").html(Jane.tt("setup:js-setup-signatures-info-lang",{lang:this.data.lang},["signature-langs"],ns.page.current.params))),this
},e.prototype.index=function(){if(!this.$node)return-1;var e=$(".js-setup-signature");return e.length-e.index(this.$node)-1},e.prototype.openEditor=function(e,t){if(this.isEditable()||!this.$node)return this;e=e||$.noop;var n=this.$node.height(),i=this.$node.find("textarea").attr("id"),s=this;return this.getEditor()?(this._onEditorInit(e,n,!0),this):(setTimeout(function(){CKEDITOR.replace(i,s.getConfig(e,n,t))},0),this)},e.prototype.closeEditor=function(){return this.isEditable()&&this.$node&&(ns.events.off("setup.signature.change.lang"),this.$node.addClass("b-form-element_signature-inactive"),Daria.Dropdown.closeAll(),nb.destroy(this.$node)),this
},e.prototype.clearEditor=function(e){if(!this.$node)return this;e=e||"";var t=this.getEditor(this.$node.attr("id"));return t&&(t.updateElement(),t.setData(e)),nb.$block(".js-bind-address",this.$node).uncheck(),this},e.prototype.isEditable=function(){return this.$node&&this.$node.hasClass("b-form-element_signature-inactive")?!1:!0},e.prototype.saveState=function(e){if(!this.isEditable())return this;e=e||{};var t=$.extend({},{text:this.data.text,emails:this.data.emails,userLang:this.data.userLang}),n="",i=this.getEditor(this.$node.find("textarea").attr("id"));
if(this.$node&&i){n=i.getData()||"",this.data.text=n;var s=[];nb.$block(".js-bind-address",this.$node).isChecked()&&s.push(nb.$block(".js-radio-select",this.$node).getState().value),this.data.emails=s,this.data.userLang=this.$node.find('[name="userLang"]').val()}return $.extend(this.data,e),this._changed=!1,t.text!==n?this._changed=!0:JSON.stringify(t.emails)!==JSON.stringify(this.data.emails)?this._changed=!0:t.userLang!==this.data.userLang&&(this._changed=!0),this},e.prototype.getData=function(){return this.data
},e.prototype.isEmpty=function(){return Daria.signs.isEmpty(this.data.text)},e.prototype.getNode=function(){return this.$node},e.prototype.isChanged=function(){return this._changed||this._transaction},e.prototype.transaction=function(e){return this._transaction=!!e,this._transaction},e.prototype.setLang=function(e){return this.$node.find('[name="userLang"]').val(e),this},e.prototype.getConfig=function(e,t,n){var i={};CKEDITOR.editorConfig(i);var s={pastefileGetPlaceholderContext:function(){return new CKEDITOR.dom.element(document.body)
},pastefileGetDropContext:function(){return document},startupMode:"wysiwyg"};return!t||"string"!=typeof t&&"number"!=typeof t||(s.height=t),_.extend(i,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.SIGNATURE,{instanceReady:this._onEditorInit.bind(this,e,!1,!1),"pastefile:dropfile":this.onPastefileDrop.bind(this)},s,n))},e.prototype._onEditorInit=function(e,t,n){var i=this,s=this.getEditor();nb.init(this.$node),n||s.setData(this.data.convert),t&&s.resize(s.config.width,t,!0),this.$node.removeClass("b-form-element_signature-inactive"),this.focusEditor();
var o=nb.$block(".js-bind-address",i.$node),a=nb.$block(".js-radio-select",i.$node);if(this.data.emails.length?o.check():o.uncheck(),this.data.emails.length){var r=this.data.emails.shift();a.setState({value:r})}a.on("nb-changed",function(){o.check()}),ns.events.on("setup.signature.change.lang",function(e,t){i.setLang(t.lang),Daria.Dropdown.closeAll(),i.$node.find(".js-setup-signature-edit-lang").replaceWith(Jane.tt("setup:js-setup-signatures-edit-lang",{lang:t.lang,userLang:t.lang},["signature-langs"],ns.page.current.params)),Jane.c(t.metrika.split(":"))
}),this.$node.find(".js-setup-signature-edit-lang").replaceWith(Jane.tt("setup:js-setup-signatures-edit-lang",{lang:i.data.lang,userLang:i.data.userLang},["signature-langs"],ns.page.current.params)),e()},ns.View.edefine("setup-sender",{models:{"module-editor":!1,settings:!0,"account-information":!0,"setup-menu":!0,"signature-langs":!0},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy","click .js-signature-edit":"onSignatureEdit","click .js-signature-save":"onSignatureSave","click .js-signature-add":"onSignatureAdd","click .js-signature-delete":"onSignatureDelete","click .b-form-element_signature-inactive.js-setup-signature":"onSignatureEdit","click input[name=default_email]":"onDefaultEmailClick",click:"onCacheNodeClick","resize@show window":"_onWindowResize","submit@show .js-form-submit":"onSubmitSetupForm","daria:vSetupSender:createNewSignature@show":"createNewSignature","setup-sender-masonry-reset@show":"_masonryReset","setup-sender-masonry-reload@show":"_masonryReload"},yateModule:"setup",methods:{editorId:"signature_new",onHtmlInit:function(){var e=this.$node,t=this.form=e.find("form:eq(0)");
nb.init(e),this.formCacher=this.addFormCacher(this.$node.find(".js-setup-form-container")),this.formCacher.cancelChanges=function(){$("form:eq(0)",e).find(".js-radio-input input[name=default_email]").each(function(){var e=nb.block($(this).closest(".js-radio-input").get(0)),t=e&&e.$node.attr("original-value");if(t){var n=e.$node.closest(".b-form-layout__line"),i=nb.$block(".js-radio-select",n);e.setValue(t),i.setState({value:t})}}),Daria.nbFormCacher.prototype.cancelChanges.apply(this)},t.on("onSave",function(){var e=$(this);
e.find(".nb-checkbox").each(function(){var e=$(this).closest(".b-form-layout__line"),t=nb.block(this);return"radio"!==t.getType()?!0:void(t.isChecked()?e.addClass("b-form-element__radio_checked"):e.removeClass("b-form-element__radio_checked"))});var t=[];e.find(".nb-checkbox input[name=default_email]").each(function(){var e=nb.block($(this).closest(".nb-checkbox").get(0)),n=e.$node.attr("original-value"),i=e.isChecked(),s=e.$node.closest(".b-form-layout__line"),o=nb.$block(".js-radio-select",s);t.push([e,n,i,o])
}),$.each(t,function(e,t){t[1]&&!t[2]&&(t[0].setValue(t[1]),t[3]&&t[3].setState({value:t[1]})),t[1]&&t[2]&&t[0].$node.attr("original-value",t[0].getValue())}),$.each(t,function(e,t){t[2]&&(t[0].check(),t[3]&&t[3].setState({value:t[0].getValue()}),ns.action.run("header.update-default-email",{email:t[0].getValue()}))})}),$(".nb-select.js-radio-select",this.$node).each(function(){nb.block(this).on("nb-changed",function(){var e=this.getState().value,t=this.$node.closest(".b-form-layout__line"),n=nb.$block(".js-radio-input",t);
n&&(n.setValue(e),n.check())})}),$(".js-bind-address",this.$node).each(function(){nb.block(this).on("nb-changed",function(){this.isChecked()?Jane.c("Настройки","Отправитель","Подписи","Привязать к адресу","On"):Jane.c("Настройки","Отправитель","Подписи","Привязать к адресу","Off")})}),$(".js-signature_select",this.$node).each(function(){nb.block(this).on("nb-changed",function(){this.isChecked()?Jane.c("Настройки","Отправитель","Подписи","Разрешить выбор подписи","On"):Jane.c("Настройки","Отправитель","Подписи","Разрешить выбор подписи","Off")
})})},onHtmlDestroy:function(){nb.destroy(this.node)},onShow:function(){this._lockSignature=!1,this._$signatureContext=$(".js-setup-signatures",this.form);var t=Boolean(ns.page.current.params.signaturePromo),n=this._$signatureContext.find(".js-new-signature");$.each(Daria.signs.getHtml(),function(t,i){new e(i).insertAfter(n)}),ns.events.trigger("setup-sender-masonry-reload");var i=this.getConfig();i.startupMode="wysiwyg",i.viewParams=_.clone(this.params),this._timeoutEditorCreate=setTimeout(function(){CKEDITOR.replace("signature_new",i)
},0),t&&$("body,html").animate({scrollTop:n.offset().top},500);var s=Daria.signs.count();s?1===s?Jane.c("Настройки","Отправитель","Показ","Одна подпись"):Jane.c("Настройки","Отправитель","Показ","2 или более подписей"):Jane.c("Настройки","Отправитель","Показ","Без подписей"),this.onPageLeave()},onHide:function(){Daria.Dropdown.closeAll(),this.destroyEditor(),$(".js-setup-signature",this._$signatureContext).each(function(){this.signature.destroyEditor()}),$(".js-setup-signature",this._$signatureContext).remove(),this._masonryDestroy(),delete this._$signatureContext,this.offPageLeave()
},_onWindowResize:function(){ns.events.trigger("setup-sender-masonry-reset")},saveSignatures:function(e,t,n){n=n||$.noop,t=$.makeArray(t),e=$.makeArray(e);var i=this,s=ns.Model.get("settings"),o=$(".js-setup-signature",this._$signatureContext);t.length&&(o=o.not($.map(t,function(e){return e.getNode()[0]})));var a=[],r=o.map(function(){return this.signature.saveState(),this.signature.isEmpty()?void a.push(this.signature):this.signature}).get().reverse();if(a=a.concat(t),r=r.concat(e),!a.length){var l=!1;
if($.each(r,function(e,t){return t.isChanged()?void(l=!0):void 0}),!l)return $(".js-setup-signature",i._$signatureContext).each(function(){this.signature.closeEditor()}),void n(!0,Daria.signs.getHtml(),!1)}var d=[];$.each(r,function(e,t){t.transaction(!0),d.push(t.getData())});var c=Daria.signs.count(),u=d.length;s.setSettings({signs:d},function(e,t){var s=Daria.signs.getHtml();return e?($.each(r,function(e,t){t.transaction(!1)}),Daria.Statusline.showMsg({name:"signatures-updates",body:'Подписи сохранены. Перейти во <a href="#inbox" class="b-statusline__link">Входящие</a>'}),$.each(a,function(){this.remove()
}),r.length===s.length&&$(".js-setup-signature",i._$signatureContext).each(function(){this.signature.update(s[this.signature.index()]).closeEditor()}),void n(!0,s,c!==u)):(-1!==$.inArray("signs.maxcount",t)?(Daria.Dialog.notice({body:"<p>К сожалению, нельзя добавить более 20 подписей.</p>",width:350}),$(".js-setup-signature",i._$signatureContext).each(function(){this.signature.closeEditor()}),ns.events.trigger("setup-sender-masonry-reset")):-1!==$.inArray("signs.maxlen",t)?Daria.Dialog.notice({body:"<p>Подпись должна быть не длиннее 10000 символов. Пожалуйста, сократите.</p>",width:350}):Daria.Statusline.showMsg({name:"signature.append.result",body:"Редактирование списка подписей временно недоступно"}),void n(!1,s,!1))
})},onSignatureEdit:function(e){if(this._lockSignature)return!1;var t=$(e.target).closest(".js-setup-signature").get(0).signature;if(t.isEditable())return!1;var n=this;return this.onSignatureSave($.Event("signature-edit",{data:{callback:function(){t.openEditor(function(){ns.events.trigger("setup-sender-masonry-reset"),Jane.c("Настройки","Отправитель","Подписи","Редактировать")},n)}}})),!1},onSignatureSave:function(e){if(this._lockSignature)return!1;var t=e&&e.data&&e.data.callback||$.noop,n=$(".js-setup-signature",this._$signatureContext),i=n.filter(function(){return this.signature.isEditable()
});if(!i.length)return t(),!1;this.lockSignature(!0);var s=this;return this.saveSignatures(null,null,function(e,n,o){s.lockSignature(!1),e&&(t(),ns.events.trigger(o?"setup-sender-masonry-reload":"setup-sender-masonry-reset"),i.find(".js-setup-signature-text img").one("load",function(){ns.events.trigger("setup-sender-masonry-reset")}))}),"click"===e.type&&Jane.c("Настройки","Отправитель","Подписи","Сохранить"),!1},appendSignature:function(t,n){if(this._lockSignature)return!1;var i=(new e).saveState(t);
if(i.isEmpty())return!1;this.lockSignature(!0);var s=this;return this.saveSignatures(i,null,function(e,t){s.lockSignature(!1),e&&(i.update(t.pop()).clearEditor().insertAfter($(".js-new-signature",s._$signatureContext)),ns.events.trigger("setup-sender-masonry-reload"),n())}),!1},createNewSignature:function(){var e=this.$node.find(".js-new-signature"),t=Daria.signs,n=t.sample(),i=this;if(t.count()<2&&n){var s=n.content;this.appendSignature({text:s,convert:s},function(){ns.events.trigger("daria:vSignaturePromo:close"),i.focusEditor()
}),Jane.c("Настройки","Отправитель","Промо подписей","Клик с добавлением примера")}else{var o=e.offset().top;Daria.is2pane()?$("body,html").animate({scrollTop:o},500):$(".js-block-setup-sender").animate({scrollTop:o},500),this.focusEditor(),Jane.c("Настройки","Отправитель","Промо подписей","Клик для скрола")}},onSignatureAdd:function(){if(this._lockSignature)return!1;var t=$(".js-new-signature",this._$signatureContext),n=new e(null,t).saveState();if(n.isEmpty())return!1;this.lockSignature(!0),n.data.text&&(n.data.text=Daria.signs.appendSeperator(n.data.text));
var i=this;return this.saveSignatures(n,null,function(e,s){i.lockSignature(!1),e&&s.length&&(n.update(s.pop()).clearEditor("").insertAfter(t),n.$node.find(".js-setup-signature-text img").one("load",function(){ns.events.trigger("setup-sender-masonry-reset")}),ns.events.trigger("setup-sender-masonry-reload"))}),Jane.c("Настройки","Отправитель","Подписи","Добавить"),!1},onSignatureDelete:function(e){function t(){n.lockSignature(!0);var t=$(e.currentTarget).closest(".js-setup-signature").get(0).signature;
n.saveSignatures(null,t,function(e){return n.lockSignature(!1),e?(ns.events.trigger("setup-sender-masonry-reload"),void Daria.Dialog.close()):void Daria.Dialog.close()}),Jane.c("Настройки","Отправитель","Подписи","Подтверждение удаления","Удалить")}if(this._lockSignature)return!1;Daria.Dialog.open({body:"<p>Удалить подпись?</p>",width:200,buttons:[{name:"delete",value:"Удалить",onclick:t},{name:"cancel",link:!0,value:"Отмена"}],oncancel:function(){Jane.c("Настройки","Отправитель","Подписи","Подтверждение удаления","Отмена")
}});var n=this;return Jane.c("Настройки","Отправитель","Подписи","Подтверждение удаления"),!1},lockSignature:function(e){e=!!e,this._lockSignature=e,this.toggleLock(e),$(".js-setup-signature",this._$signatureContext).each(function(){this.signature.toggleLock(e)}),$(".js-signature-add,.js-signature-save",this._$signatureContext).each(function(){e?nb.block(this).disable():nb.block(this).enable()}),$("input:checkbox,select",this._$signatureContext).prop("disabled",e)},onDefaultEmailClick:function(e){var t=this.$node.find("input[name=default_email]").index(e.currentTarget);
t?Jane.c("Настройки","Отправитель","Email","Выбор не первого"):Jane.c("Настройки","Отправитель","Email","Выбор первого")},onCacheNodeClick:function(e){var t=$(e.target).closest(".js-setup-signature").get(0);t&&t.signature.isEditable()||this.onSignatureSave($.Event("click",{originalEvent:e}))},_masonryOptions:function(){return{autoResize:!0,container:$(".js-setup-signatures"),offset:20,align:"left",direction:"left",comparator:function(e,t){var n=$(e).data("index"),i=$(t).data("index");return n="undefined"==typeof n?Number.POSITIVE_INFINITY:parseInt(n,0),i="undefined"==typeof i?Number.POSITIVE_INFINITY:parseInt(i,0),n>i?-1:1
}}},_masonry:function(e){if(e=e||$.noop,this.__masonry)return void e(this.__masonry);var t=this;Daria.Libs(["Wookmark"],function(){setTimeout(function(){var n=$(".js-new-signature,.js-setup-signature");n.height(function(e,t){$(this).data("wookmark-height",t)}),t.__masonry=n.wookmark(t._masonryOptions()).wookmarkInstance,e(t.__masonry)},200)})},_masonryDestroy:function(){this.__masonry&&(this.__masonry.clear(),this.__masonry=null,delete this.__masonry)},_masonryReset:function(){this._masonry(function(e){$(".js-new-signature,.js-setup-signature").height(function(e,t){$(this).data("wookmark-height",t)
}),e.layout(!1)})},_masonryReload:function(){var e=this;Daria.Libs(["Wookmark"],function(){e.__masonry=$(".js-new-signature,.js-setup-signature").wookmark(e._masonryOptions()).wookmarkInstance})},preparationFormData:function(e){return _.omit(e,"userLang")},getConfig:function(){var e={},t=this;return CKEDITOR.editorConfig(e),_.extend(e,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.SIGNATURE,{"pastefile:dropfile":this.onPastefileDrop.bind(this)},{pastefileGetPlaceholderContext:function(){var e=t.$node.closest(".mail-Editor .cke_contents_wrap")[0];
return e||(e=document.body),new CKEDITOR.dom.element(e)},pastefileGetDropContext:function(){var e=t.$node.closest(".mail-Editor .cke_contents_wrap")[0];return e||(e=document),e}},this)),e},getEditorId:function(){return this.editorId}}},"setup-sender-editor-mixin","setup-form")}(),ns.View.define("setup-todo",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onPageLeave","ns-view-hide":"offPageLeave","form-cacher.changed@show":"onFormCacherChanged","form-cacher.unchanged@show":"onFormCacherUnchanged","click@show .js-todo-go-mobile":"onClickTodoGoMobile","submit@show .js-setup-form":"onSubmitSetupForm"},models:{"setup-menu":!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_todo":"onChangedShowTodo"}},yateModule:"setup",ctor:function(){this._pageReload=this._pageReload.bind(this),this._pageReloadOnce=_.noop
},methods:{onHtmlInit:function(){nb.init(this.node),this.addFormCacher(this.$node.find(".js-setup-form-container"))},onFormCacherChanged:function(e,t){_.contains(t.instance,"setup-todo")&&$.inArray("show_todo",t.changed)&&this.$node.find(".js-setup-todo-promo").removeClass("g-hidden")},onFormCacherUnchanged:function(e,t){_.contains(t.instance,"setup-todo")&&this.$node.find(".js-setup-todo-promo").addClass("g-hidden"),this._pageReloadOnce()},onClickTodoGoMobile:function(){Jane.c("Todo","setup","gomobile")
},onChangedShowTodo:function(){return this.isVisible()?void(this.getModel("settings").getSign("show_todo")&&window.Todo&&window.Todo.init?window.Todo.init():this._pageReloadOnce=_.once(this._pageReload)):void this.invalidate()},_pageReload:function(){document.location.reload()}}},"setup-form"),ns.View.edefine("setup-avatar-setup",{models:{settings:!1,"account-information":!1},ctor:function(){this.SRC=Daria.Config["user-pic-domain"]+Daria.uid+"/normal/mail/"},yateModule:"setup"},"setup-avatar"),ns.View.define("signature-promo",{models:{settings:!0,"account-information":!0},events:{"setup-avatar-change@show":"_onSetupAvatarChange","setup-avatar-remove@show":"_onSetupAvatarChange","daria:vSignaturePromo:close@show":"close","click .js-signature-new-select":"onSignatureNewSelect"},yateModule:"setup",methods:{close:function(){var e=this;
return this.$node.find(".js-promo-signature").slideUp(400,function(){e.destroy()}),!1},onSignatureNewSelect:function(e){ns.events.trigger("daria:vSetupSender:createNewSignature"),e.preventDefault()},_updateSignatureAvatar:function(e){var t=$(".js-signature-promo-sample-photo",this.node);t.length&&(t[0].src=e)},_onSetupAvatarChange:function(e,t){this._updateSignatureAvatar(t)}}})}()});