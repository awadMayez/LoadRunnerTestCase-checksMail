Jane.module("jane.message.js",function(){"use strict";!function(){Daria.MessageWidget={},Daria.MessageWidget._widgets={"message-widget-spam":"_checkShowSpam","message-widget-translate":"_checkShowTranslate","message-widget-noreply":"_checkShowNoreply","message-widget-imap-deleted":"_checkShowImapDeleted","message-widget-download-full":"_checkShowDownloadFull"},Daria.MessageWidget.creatingListOfWidgets=function(e){var t=_.clone(e.params),s=ns.Model.get("message-widget-state",t);for(var i in Daria.MessageWidget._widgets)if(!s.isViewUserClose(i)){var n=Daria.MessageWidget._widgets[i];
(s.isShow(i)||Daria.MessageWidget[n](t))&&(s.show(i,{silent:!0}),e.insertWidget(i))}},Daria.MessageWidget._checkShowDownloadFull=function(e){var t=ns.Model.get("message-body",e),s=t.getFirstBody();return s&&s.trimmed?!0:!1},Daria.MessageWidget._checkShowIgnoreThread=function(e){var t=ns.Model.get("message",e),s=ns.Model.get("labels"),i=s.getMuteThreadLabel();return i&&t.hasLabel(i.lid)?!0:!1},Daria.MessageWidget._checkShowImapDeleted=function(e){if(ns.Model.get("settings").isSet("hide-imap-deleted"))return!1;
var t=ns.Model.get("message",e);return t.hasLabelWithSymbolicName("deleted_label")||t.get(".flags.imap-deleted")?!0:!1},Daria.MessageWidget._checkShowNoreply=function(e){var t=ns.Model.get("message",e),s=ns.Model.get("labels"),i=s.getWaitingForReplyLabel();return i&&t.hasLabel(i.lid)?!0:!1},Daria.MessageWidget._checkShowTranslate=function(e){var t=ns.Model.get("settings");if(!t.isSet("translate"))return!1;var s=Daria.Translate.getLangByMid(e.ids),i=Daria.Config.locale;if(!s||s===i)return!1;var n=ns.Model.get("message-body",e),a=$(n.getHTML()),o=a.html();
if(o.length>2e5)return Jane.c(71105,"msg.too_big"),!1;var r=$.trim(a.text());return r?!0:!1},Daria.MessageWidget._checkShowSpam=function(e){var t=ns.Model.get("message",e);if(t.isYaSupport())return!1;var s=ns.Model.get("message-body",e),i=s.hasPhishingBody();if(!t.isSpam()&&!i)return!1;var n=s.getData();return n.hasOwnProperty("has-links")&&n.hasOwnProperty("has-img")||s.getHTML(),n["has-links"]||n["has-img"]?!0:!1},Daria.MessageWidget._checkShowEvent=function(){return"RUS"!=Jane.Config.product||Daria.IS_CORP?!1:!0
}}(),function(){var e=function(e){e=e||$("body"),setTimeout(function(){e.addClass("repaint-ie").removeClass("repaint-ie")},0)},t=function(){var e=["Предложение фильтровать групоны"],t=Daria.GrouponFilters,s=$.merge([],arguments);t.grouponPagType&&e.push(t.grouponPagType),t.grouponAction&&e.push(t.grouponAction),s=$.map(s,function(e){return $.trim(Daria.supplant(e,[t.popupShowed||""]))}),$.merge(e,s),Daria.DEBUG&&console&&console.info&&console.info("metrika groupon: ",e),Jane.c(e)},s=function(e,t){return ns.forcedRequest(["do-folders-add","folders"],e).then(function(){var s=ns.Model.get("folders").getFolderByName(e.folder_name);
s&&s.fid&&t(s)})},i=function(e){return ns.forcedRequest(["do-filters-delete","filters"],{id:e})};ns.action.define("groupon.addCondition",function(e,s,i,n){var a={event:n,params:s},o=$(a.event.currentTarget),r=[];return o.is("[data-nb=checkbox]")?(o.toggleClass("is-checked"),r.push("Промо на всех","Выбор "+o.attr("data-label"))):(o.addClass("b-link_selected"),r.push("Плашки с тематиками (popup)","Тематики {0}",o.attr("data-label"))),o.attr("data-click-action","groupon.removeCondition").attr("data-selected","selected"),Daria.GrouponFilters.onChangeCondition(!0),t.apply(null,r),!0
}),ns.action.define("groupon.removeCondition",function(e,t,s,i){var n={event:i,params:t},a=$(n.event.currentTarget);return a.removeClass("b-link_selected").attr("data-click-action","groupon.addCondition").removeAttr("data-selected"),Daria.GrouponFilters.onChangeCondition(),!0}),ns.action.define("groupon.addCustomCondition",function(){var e,s=Daria.GrouponFilters.getCurrentNode(),i=s.find(".js-groupon-filter-input"),n=i.val();n&&(e=Jane.tt("mail:groupon-filter-item",{label:n,selected:!0}),s.find(".js-groupon-list").append(e),i.val(""),t("Плашки с тематиками (popup)","Тематики {0}",n),Daria.GrouponFilters.onChangeCondition(!0))
}),ns.action.define("groupon.createFilter",function(e,s,a,o){var r={event:o,params:s},l=Daria.GrouponFilters.getCurrentNode(),u=Daria.GrouponFilters,d=function(){l.find(".b-link_js").removeClass("g-hidden"),l.find("[data-text]").each(function(){var e=$(this);e.html(e.attr("data-text")),e.removeAttr("data-text")}),Daria.GrouponFilters.isPromo?Daria.GrouponFilters.dialog.close():Daria.GrouponFilters.showSuccessPopup()},c=ns.Model.get("folders").getFolderBySymbol("inbox"),h=[],g=l.find("[data-selected]:not([data-filter-id])").each(function(){var e=$(this).attr("data-label");
h.push({id:"do-filters-add",params:{fid:r.params.fid1,clicker:"move",field1:["ya_syslabel","body"],field2:["1","3"],field3:["vtnrf0grouponsite",e],name:"X-Yandex-Groupon",letter:"nospam",logic:1,move_folder:c.fid}})});h.length&&h.push({model:ns.Model.get("filters").getMasterRequest()});var m=ns.Model.get("settings").getSetting("groupon_filter");if(l.find("[data-filter-id]:not([data-selected])").each(function(){var e=$(this).attr("data-filter-id");i(e),$(this).attr("data-filter-id",!1)}),m&&t("Плашки с тематиками (popup)","Сохранить изменения"),ns.forcedRequest(h).then(function(e){var t=e.slice(-1).map(function(e){e.get(".id")
});if(t.length&&g.each(function(e){var s=t[e][0];$(this).attr("data-filter-id",t[e][0]),t[e]=s}),m){var s=ns.Model.get("filters"),i=jpath(s.getData(),'.action[.name == "X-Yandex-Groupon"].filid'),n=jpath(s.getData(),'.action[.name == "X-Yandex-Groupon-2"].filid')[0];$.merge(i,t),i.push(n),ns.forcedRequest(["do-filters-sort"],{list:i.join(",")})}}),m)return void d();ns.Model.get("settings").getSetting("groupon_time")||ns.Model.get("settings").setSettings({groupon_time:(new Date).getTime()});var p=r.params.promo?"Промо на всех":"Плашки с тематиками (popup)";
t(p,"Мне интересны только такие скидки {0}"),u.editing=!0,u.popupShowed=null,n(d)});var n=function(e){a();var t=ns.Model.get("folders"),i="Скидки";ns.Model.get("settings").setSettings({groupon_filter:"on",groupons_merge:"disable"}),s({folder_name:t.getFolderByName(i)?"Скидочные сервисы":i},function(t){ns.forcedRequest([{id:"do-filters-add",params:{clicker:"move",field1:["ya_syslabel"],field2:["1"],field3:["vtnrf0grouponsite"],name:"X-Yandex-Groupon-2",letter:"nospam",logic:0,move_folder:t.fid}},{model:ns.Model.get("filters").getMasterRequest()}]).then(e)
})};ns.action.define("groupon.showFilter",function(){Daria.GrouponFilters.showPopup()}),ns.action.define("groupon.showPromo",function(){Daria.GrouponFilters.showPromoPopup()}),ns.action.define("groupon.hide",function(e,s,i,n){var o,r={event:n,params:s};return a(!0,r),Boolean(r.params.get_all)&&t("Промо на всех","Получать все"),Daria.GrouponFilters.$dialog?void ns.events.trigger("dialog.close"):void(Daria.GrouponFilters&&(o=Daria.GrouponFilters.getCurrentNode(),o.find(".js-hiding").delay(100).slideUp()))
});var a=function(e,s){var i=ns.Model.get("settings");return e?($(".js-groupon-head-actions").show(),s&&s.params.skip_mcounter||t("Кнопки в шапке без плашек","Показ кнопок в шапке"),void i.setSettingOn("show_groupon_actions")):($(".js-groupon-head-actions").hide(),void i.setSettingOff("show_groupon_actions"))};ns.action.define("groupon.undo",function(s,i,n,a){var o,r,l={event:a,params:i},u=Daria.GrouponFilters.getCurrentNode();l.params.force?(r=Jane.tt("mail:groupon-container",null,["filters","groupon-topics","filters","message-body","folders","message","settings"]),u.removeClass("b-intruder__unsubscribe").html(r),o=$(r)):(r=Jane.tt("mail:groupon-filter-list",null,["filters","groupon-topics"]),u.find(".js-groupon-list").replaceWith(r),Daria.GrouponFilters.onChangeCondition(),o=u.find(".js-groupon-editor"));
var d=u.find("[data-previous]").removeAttr("data-previous");o.delay(100).slideUp(function(){var s,i=d.attr("data-mcounter");Modernizr.msie&&(s=$.proxy(e,null,d)),i&&(i=i.split(":"),t.apply(t,i)),d.delay(100).slideDown("slow",s)})}),ns.action.define("groupon.cancel",function(e,s,i,n){var a={event:n,params:s},o=ns.Model.get("filters").getData(),r=jpath(o,'.action[.name == "X-Yandex-Groupon" || .name == "X-Yandex-Groupon-2"].filid'),l=[];$.each(r,function(e,t){l.push({id:"do-filters-delete",params:{id:t}})
}),l.length&&l.push({id:"filters"}),ns.Model.get("settings").setSettings({groupon_filter:!1,groupons_merge:"enable",groupon_time:!1}),Daria.GrouponFilters.editing=!1,l.length?(ns.forcedRequest(l).then(function(){ns.action.run("groupon.undo",{force:!0})}),a.params.skip_mcounter||t("Плашки с тематиками (popup)","Получать все скидки")):(ns.action.run("groupon.undo"),a.params.skip_mcounter||t("Плашки с тематиками (popup)","Оставить как есть")),ns.action.run("groupon.hide",a.params)}),ns.action.define("groupon.tospam",function(e,t,s,i){var n,a,o={event:i,params:t},r=o.params;
if(r.mcounter&&delete r.mcounter,r.skip_mcounter=!0,ns.action.run("groupon.cancel",r),"message"===ns.page.current.page){a=Daria.GrouponFilters.dialog,n=a&&a.params.byAction;var l=ns.Model.get("message",ns.page.current.params);!n&&l.isCouponService()&&ns.action.run("tospam",r)}}),ns.action.define("groupon.toggle",function(s,i,n,a){var o={event:a,params:i},r=$(o.event.currentTarget),l="block-groupon-filters",u=r.closest(".b-intruder_promo"),d=u.height();u.hasClass(l+"_full")?(u.removeClass(l+"_full"),t("Плашки с тематиками (popup)","Нажали Скрыть")):(u.removeClass(l+"_short"),u.addClass(l+"_full"),t("Плашки с тематиками (popup)","Нажали Больше скидок"));
var c=u.height();return u.height(d),u.animate({height:c},"fast",function(){u.removeAttr("style"),Modernizr.msie&&e(u.closest(".block-groupon-filters"))}),!0}),ns.action.define("groupon.blackList",function(){var e=Daria.GrouponFilters,s=ns.Model.get("folders").getFolderBySymbol("spam"),i=[];t("Плашки с тематиками (popup)","Нажали Отписаться. Письма от скидочных сервисов перекладывать в СПАМ"),i.push({id:"do-filters-add",params:{clicker:"move",field1:["ya_syslabel"],field2:["1"],field3:["vtnrf0grouponsite"],name:"Письма от скидочных сервисов перекладывать в СПАМ",letter:"nospam",logic:1,move_folder:s.fid}},{model:ns.Model.get("filters").getMasterRequest()}),e.blackListIds=null,ns.forcedRequest(i),ns.events.trigger("dialog.close")
}),ns.action.define("groupon.focusInput",function(){Daria.GrouponFilters.focusInput()})}(),ns.action.define("message.nextprev.stat",function(e,t,s,i){var n={event:i,params:t};ns.action.run("common.clck",n.params);var a=n.event.currentTarget;if(a){var o=a.href;if(o){var r;return r=n.params.path&&n.params.path.indexOf("next")>-1?"Goto_next":"Goto_previous",ns.page.go(o.replace(/^[^#]*/,"")).then(function(){ns.action.run("trigger-hotkeys-promo-bubble",{eventName:r})}),!1}}}),function(){var e=function(e){var t=e.parent();
return e.offset().left+e.innerWidth()-11<t.offset().left+t.width()},t=null,s=null;ns.events.on("b-mail-dropdown-closed",function(){t&&(t.removeClass(s&&s[0]==t[0]?"b-yabble_selected":"b-yabble b-yabble_contact b-yabble_selected"),t=null)}),ns.action.define("contact-yabble.show",function(t,i){e(i)?(i.addClass("b-yabble"+($(i).data("cid")?" b-yabble_contact":"")),i.removeClass("b-message-head__contact_readonly"),s=i):i.addClass("b-message-head__contact_readonly")}),ns.action.define("contact-yabble.hide",function(e,t){t.hasClass("b-yabble_selected")||t.removeClass("b-yabble b-yabble_contact"),s=null
}),ns.action.define("message-head.dropdown",function(s,i,n,a){i=i||{};var o=$(a.currentTarget);if(e(o)&&!o.hasClass("b-message-head__contact_readonly")){var r=t&&t[0]==o[0],l=o.find(".b-message-head__contact__arrow"),u={id:i.id,value:{name:i.name,email:i.email},root:o,arrow:l,fromMessage:!0,delay:-1,my:i.my?"yes":"",cid:i.cid||o.data("cid")||""};Daria.YabbleDropdown.toggle(u),r||(o.addClass("b-yabble_selected"),t=o)}}),ns.action.define("dropdown-contact.show",function(t,s){if(e(s)){var i=$(s),n=Daria.parseQuery(i.attr("data-hover-params")),a=i.data("cid");
a&&(n.cid=a);var o=Jane.tt("message:dropdown-contact",n);o=$(o).find(".b-mail-dropdown__box__content")[0],Daria.Dropdown.showHover(s[0],o,{counter:{cid:71052},timeout:50,location:{vert:"center",tailvert:"box"},callback:function(){ns.action.run("common.copy",{container:o,text:n.email,onmouseup:function(){$(document).trigger("b-mail-dropdown-closeall")}})}})}}),ns.action.define("dropdown-contact.hide",function(){Daria.Dropdown.hideHover()}),ns.action.define("message.add-contact",function(e,t){t=t||{};
var s=ns.request("abook-contact",{email:t.email}).then(function(e){return e[0]},function(){return null});Jane.Services.runModules(["jane.abook.js"],function(){s.then(function(e){var s=Boolean(e),i=s&&(e.isShared()||e.isSharedLocal()),n={mail_addr:t.email,first_name:t.name,shared:i};return s?ns.Model.get("abook-person-manager").updatePerson(e,n):ns.Model.get("abook-person-manager").addPerson(n)}).then(function(e){ns.Model.invalidateAll("abook-contacts");var s=e[0].get(".cid");$(".b-message-head__contact").each(function(e,i){var n=ns.action.getParams(i);
n.email!=t.email||n.cid||$(i).data("cid",s)})})}),$(document).trigger("b-mail-dropdown-closeall")})}(),ns.action.define("message.counter-filters-create",function(){return!0}),ns.action.define("message.counter-properties",function(){return!0}),ns.action.define("message.right-save-contact-link",function(e,t,s,i){var n={event:i,params:t};$(n.event.target).closest("form").submit()}),ns.action.define("message.right-show-contact-editor",function(e,t,s,i){var n={event:i,params:t};$(n.event.target).closest(".b-mail-card__section").addClass("g-hidden").next(".b-mail-card__section").removeClass("g-hidden")
}),ns.action.define("message.right-search",function(e,t,s,i){var n={event:i,params:t},a=$(n.event.currentTarget).find("input").val();return a&&(Jane.c(Daria.message.messageRight.MTabs[n.params.tab].concat("Поиск")),ns.page.go(ns.router.generateUrl("messages",{search:"search",request:encodeURIComponent(a)}))),!1}),ns.action.define("message.right-call-staff",function(e,t,s,i){var n={event:i,params:t},a=nb.$block(".js-message-head-call-phone-button",i.currentTarget);return a.isEnabled()?((new Image).src="//staff.yandex-team.ru/api/call/"+encodeURIComponent(n.params.phone),Jane.c("Звонок на офисный телефон"),a.disable(),void _.delay(function(){a.enable()
},5e3)):!1}),ns.action.define("attachments.image-preview-next",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Jane.c("Просмотрщик картинок","Показ стрелок"),Jane.c("Просмотрщик картинок","Клик по стрелкам"),Daria.ImageViewer.next()}),ns.action.define("attachments.image-preview-prev",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Jane.c("Просмотрщик картинок","Показ стрелок"),Jane.c("Просмотрщик картинок","Клик по стрелкам"),Daria.ImageViewer.prev()}),ns.action.define("attachments.image-preview-print",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Jane.c("Просмотрщик картинок","Печать");
var n=window.open();n.document.open(),n.document.write('<!doctype html><html><body><img src="'+t.src+'"></body></html>'),n.document.close(),n.onload=function(){try{n.focus(),n.print(),n.close()}catch(e){}}}),ns.action.define("attachments.image-preview-gallery",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Jane.c("Просмотрщик картинок",t.closer?"Клик по крестику галереи":"Показать всё"),Daria.ImageViewer.toggleGallery()}),ns.action.define("attachments.image-preview-select",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Daria.ImageViewer.select(Number(t.index)),Daria.ImageViewer.hideGallery()
}),ns.action.define("attachments.image-preview-scroll",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Daria.ImageViewer.scrollGallery(Number(t.to))}),ns.action.define("attachments.image-preview-subject",function(e,t,s,i){i.preventDefault(),i.stopPropagation(),Jane.c("Просмотрщик картинок","Клик по теме"),Daria.Layer.close(),ns.page.go(s.hash)}),ns.action.define("attachments.image-preview-download",function(e,t,s,i){return i.stopPropagation(),Jane.c("Просмотрщик картинок",t.count),!0}),ns.action.define("layer.close",function(){Daria.Layer.close()
}),ns.action.define("message.video-player-open",function(e,t){return t&&"mr"===t.metrika&&Jane.c(Daria.message.messageRight.MTabs.links.concat("Превью видео",t.hosting_name)),Daria.VideoPlayer.open(t)}),ns.action.define("message.video-player-close",function(){return Daria.VideoPlayer.close()}),ns.action.define("message.lists-add-from-message",function(e,t){Jane.Services.runModules(["jane.setup.js"],function(){ns.action.run("filters.lists-add-from-message",t)})}),borschik.addLinks({"b-mail-icon_ai-16.png":"//yastatic.net/mail/_/JZGjykF0dOzrwA3AcwNbSUZcFnM.png","b-mail-icon_application-16.png":"//yastatic.net/mail/_/30M3oGCuPzCr56RdMOtCayEwmJ4.png","b-mail-icon_archive-16.png":"//yastatic.net/mail/_/DenksqYswoSwG2Scoi_B1jT5dbk.png","b-mail-icon_audio-16.png":"//yastatic.net/mail/_/vpHxL6LuPiZGgbQcdR9hDOlqwJ0.png","b-mail-icon_avi-16.png":"//yastatic.net/mail/_/6366bWVGnK7spSE7HEZKXAW7Q4s.png","b-mail-icon_bmp-16.png":"//yastatic.net/mail/_/RWXjXy2ewUtmJ_HhWDBrRwIDzcY.png","b-mail-icon_cdr-16.png":"//yastatic.net/mail/_/P7OuAowWWsyhKnxGsEWahv3uS6w.png","b-mail-icon_csv-16.png":"//yastatic.net/mail/_/g4kmsjQoSeNDuM4LPoAXByZFQmo.png","b-mail-icon_development-16.png":"//yastatic.net/mail/_/rFpQ2rMJcgAPE28kz91oU4vShk.png","b-mail-icon_djvu-16.png":"//yastatic.net/mail/_/p1qnrqRBNra21BYHvXl_lZ5DXrs.png","b-mail-icon_doc-16.png":"//yastatic.net/mail/_/b5ScH5MifK9jlb2Xq-rbk14fTN8.png","b-mail-icon_eml-16.png":"//yastatic.net/mail/_/MMo6SayRRp-8faWKuLASgTn6cLg.png","b-mail-icon_exe-16.png":"//yastatic.net/mail/_/hvRkdLD66d1JJmGhAitm9RR8kyk.png","b-mail-icon_executable-16.png":"//yastatic.net/mail/_/QB_MYCW7XlUVoDMhvMCcZU8zHac.png","b-mail-icon_flash-16.png":"//yastatic.net/mail/_/Qdh4nuVgPRAiYX2pdVFWmz0b0mw.png","b-mail-icon_font-16.png":"//yastatic.net/mail/_/RFH7aXbSq6EdDFK6LWhoL7TmzOo.png","b-mail-icon_general-16.png":"//yastatic.net/mail/_/QlvAl4EZyGDO-zsBLTx7sFyNic8.png","b-mail-icon_gif-16.png":"//yastatic.net/mail/_/iMidOEwY3oIbgS2D3SIDPwspwGM.png","b-mail-icon_image-16.png":"//yastatic.net/mail/_/RWXjXy2ewUtmJ_HhWDBrRwIDzcY.png","b-mail-icon_jpg-16.png":"//yastatic.net/mail/_/W188CWMCYyuWMEWRij5QyW6PZrM.png","b-mail-icon_mail-16.png":"//yastatic.net/mail/_/MMo6SayRRp-8faWKuLASgTn6cLg.png","b-mail-icon_mov-16.png":"//yastatic.net/mail/_/jgDnsR4CNSAphuBJMOKIDVDaOic.png","b-mail-icon_mp3-16.png":"//yastatic.net/mail/_/GW26Cgv7HqtLMNhhwWF2lIqnAls.png","b-mail-icon_mp4-16.png":"//yastatic.net/mail/_/UQRipWSYZc7Of44EcW_-R7gnR3E.png","b-mail-icon_none-16.png":"//yastatic.net/mail/_/8h1DSomDZbGiBIb5gKChbopw9aM.png","b-mail-icon_odp-16.png":"//yastatic.net/mail/_/A__Re9QOAcaIJ6iFDvbqlA5aBBg.png","b-mail-icon_ods-16.png":"//yastatic.net/mail/_/C2qwSvbaDh1rg4RlV7YFC1XkVHw.png","b-mail-icon_odt-16.png":"//yastatic.net/mail/_/7xp1vJgAHxzyZi0z1_BOPefl5hU.png","b-mail-icon_pcx-16.png":"//yastatic.net/mail/_/3xB3t6QkBlVZMOE27L0mjmhesjM.png","b-mail-icon_pdf-16.png":"//yastatic.net/mail/_/gIL7ZcLfJcfLgBef3H371avZzI4.png","b-mail-icon_pls-16.png":"//yastatic.net/mail/_/vpHxL6LuPiZGgbQcdR9hDOlqwJ0.png","b-mail-icon_png-16.png":"//yastatic.net/mail/_/MYpTfBfNcfNr77785x4zXEqAQZI.png","b-mail-icon_ppt-16.png":"//yastatic.net/mail/_/PT4r8KbCGbfSDa7MpAa7072aX0A.png","b-mail-icon_psd-16.png":"//yastatic.net/mail/_/xnTUXcLmN-fDN5MUPgZ8x-NbmgI.png","b-mail-icon_rar-16.png":"//yastatic.net/mail/_/yktqXC8jPjC3RYAONf76MYuAI0.png","b-mail-icon_rtf-16.png":"//yastatic.net/mail/_/9gRfUm1ewpOcD6zfjHdt39XHdPM.png","b-mail-icon_script-16.png":"//yastatic.net/mail/_/rFpQ2rMJcgAPE28kz91oU4vShk.png","b-mail-icon_text-16.png":"//yastatic.net/mail/_/g4kmsjQoSeNDuM4LPoAXByZFQmo.png","b-mail-icon_tiff-16.png":"//yastatic.net/mail/_/plUtHPjSKRt1cXxvCBE6192nxtg.png","b-mail-icon_txt-16.png":"//yastatic.net/mail/_/CMS_qKmN5-DCFBlTTTy6V8HuSmk.png","b-mail-icon_video-16.png":"//yastatic.net/mail/_/vkfoQwxzDglgi0Z2ID1zYbZWHc4.png","b-mail-icon_virus-16.png":"//yastatic.net/mail/_/VRbQC01KngdVDDSYwSPXYZO5DBs.png","b-mail-icon_wav-16.png":"//yastatic.net/mail/_/oe_K5kX9aI_NleISUVm8Mb1H6LM.png","b-mail-icon_wma-16.png":"//yastatic.net/mail/_/Kg7EQDnqCuGEO4P2JF5aT0wFS0M.png","b-mail-icon_wmv-16.png":"//yastatic.net/mail/_/M9gArzAcacBYbnBY5y3Z8Ebouk.png","b-mail-icon_xls-16.png":"//yastatic.net/mail/_/VH4wuCvBd0acbW6MCP3QrOHcErk.png","b-mail-icon_zip-16.png":"//yastatic.net/mail/_/DenksqYswoSwG2Scoi_B1jT5dbk.png"}),borschik.addLinks({"b-mail-icon_ai-32.png":"//yastatic.net/mail/_/75yk6g_NVSZldYcc1VDDYXwwQfI.png","b-mail-icon_application-32.png":"//yastatic.net/mail/_/vEawwDwG20d8sMNv-3j3Paro8Sc.png","b-mail-icon_archive-32.png":"//yastatic.net/mail/_/FkTUX7UY5TAMGByWQur0Jb2zuuQ.png","b-mail-icon_audio-32.png":"//yastatic.net/mail/_/31j4bxcL2rDpD7k7vsHnBK366CE.png","b-mail-icon_avi-32.png":"//yastatic.net/mail/_/MkWNSB1UejPBKIRrNGjkn18H-Uo.png","b-mail-icon_bmp-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_cdr-32.png":"//yastatic.net/mail/_/QxO57lKWdnOUeAvtfNaAosj92kI.png","b-mail-icon_csv-32.png":"//yastatic.net/mail/_/Ur926vcDzZ77nohvYMZIjEPProQ.png","b-mail-icon_development-32.png":"//yastatic.net/mail/_/_cbDI9pGklI4b0FCqoVxICS8bGk.png","b-mail-icon_djvu-32.png":"//yastatic.net/mail/_/pUhMSHcqHaUp8XaVSu8PHZd1MAU.png","b-mail-icon_doc-32.png":"//yastatic.net/mail/_/lCN_dcr6F9TKdrEClWPVbhYfUKc.png","b-mail-icon_eml-32.png":"//yastatic.net/mail/_/533YbkUG4BktvL5fziMAFuH1st4.png","b-mail-icon_exe-32.png":"//yastatic.net/mail/_/vEawwDwG20d8sMNv-3j3Paro8Sc.png","b-mail-icon_executable-32.png":"//yastatic.net/mail/_/vEawwDwG20d8sMNv-3j3Paro8Sc.png","b-mail-icon_flash-32.png":"//yastatic.net/mail/_/czuPwdSTamAU7MxS7Zezpcu_T7o.png","b-mail-icon_font-32.png":"//yastatic.net/mail/_/IJKKrgZtYhMY7mv-1xu3RnJSybU.png","b-mail-icon_general-32.png":"//yastatic.net/mail/_/tkaQN6Y9U9hsbMTdXLvRnAATrkw.png","b-mail-icon_gif-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_image-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_jpg-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_mail-32.png":"//yastatic.net/mail/_/533YbkUG4BktvL5fziMAFuH1st4.png","b-mail-icon_mov-32.png":"//yastatic.net/mail/_/7jIuk6nov5GlBR2DXXgiCTng17Y.png","b-mail-icon_mp3-32.png":"//yastatic.net/mail/_/aW8QoIXfj3hbQrO-OqFad7m99Xo.png","b-mail-icon_mp4-32.png":"//yastatic.net/mail/_/MkWNSB1UejPBKIRrNGjkn18H-Uo.png","b-mail-icon_none-32.png":"//yastatic.net/mail/_/L_ThKQeg3-ghviFFr3JC4KgchLQ.png","b-mail-icon_odp-32.png":"//yastatic.net/mail/_/1N7wg1agbl_pWrqfM8vHzC4bttk.png","b-mail-icon_ods-32.png":"//yastatic.net/mail/_/VAG1FlDeiLeFfjEoJ597rFKiGUA.png","b-mail-icon_odt-32.png":"//yastatic.net/mail/_/7WxD5Q1odtq5e_Zm4X0AhhA7aHE.png","b-mail-icon_pcx-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_pdf-32.png":"//yastatic.net/mail/_/RFWdW9kGq9Sx7IRMFfs3vRNCIo4.png","b-mail-icon_pls-32.png":"//yastatic.net/mail/_/aW8QoIXfj3hbQrO-OqFad7m99Xo.png","b-mail-icon_png-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_ppt-32.png":"//yastatic.net/mail/_/7mCBQ6UUGO--pWzr5tqfE4ZcDw0.png","b-mail-icon_psd-32.png":"//yastatic.net/mail/_/xL8s3W7WzJd_t_t8DNxo_5HXP3o.png","b-mail-icon_rar-32.png":"//yastatic.net/mail/_/J0IlvupZ6GJ-YJcQAHxyayNg3cM.png","b-mail-icon_rtf-32.png":"//yastatic.net/mail/_/7WxD5Q1odtq5e_Zm4X0AhhA7aHE.png","b-mail-icon_script-32.png":"//yastatic.net/mail/_/VJm9pbwg95WJVcaYhz-Kia5qseg.png","b-mail-icon_text-32.png":"//yastatic.net/mail/_/7WxD5Q1odtq5e_Zm4X0AhhA7aHE.png","b-mail-icon_tiff-32.png":"//yastatic.net/mail/_/H6V4lV9K2bZqQ4b43NsUcEtHAis.png","b-mail-icon_txt-32.png":"//yastatic.net/mail/_/7WxD5Q1odtq5e_Zm4X0AhhA7aHE.png","b-mail-icon_video-32.png":"//yastatic.net/mail/_/MkWNSB1UejPBKIRrNGjkn18H-Uo.png","b-mail-icon_virus-32.png":"//yastatic.net/mail/_/5p2SC09lwybXLLq0Kr2xjiy_RHM.png","b-mail-icon_wav-32.png":"//yastatic.net/mail/_/aW8QoIXfj3hbQrO-OqFad7m99Xo.png","b-mail-icon_wma-32.png":"//yastatic.net/mail/_/aW8QoIXfj3hbQrO-OqFad7m99Xo.png","b-mail-icon_wmv-32.png":"//yastatic.net/mail/_/MkWNSB1UejPBKIRrNGjkn18H-Uo.png","b-mail-icon_xls-32.png":"//yastatic.net/mail/_/9eoQR82E6DzSGhzstEQwf7JPKxE.png","b-mail-icon_zip-32.png":"//yastatic.net/mail/_/tF7UrK38nw2UO3Qt6H9wKzb3D2g.png"}),borschik.addLinks({"message-right-attachments.gif":"//yastatic.net/mail/_/xdj3byznysmRtPKzflTG7oS5Ajw.gif","message-right-history.gif":"//yastatic.net/mail/_/TCWS7Y5KV6CW-NQHjU5EOpqD0RQ.gif","message-right-links.gif":"//yastatic.net/mail/_/n3FZvmw7G5Wgk937MUUd8ILTwLs.gif","message-right-thread.gif":"//yastatic.net/mail/_/8xeabaevRKsXGTLFFtAgEMK_aYk.gif"}),borschik.addLinks({"profile-icon_facebook.com":"//yastatic.net/mail/_/HOroI2nBODx4ishaPQNkrh4uA_E.png","profile-icon_moikrug.ru":"//yastatic.net/mail/_/dxoRln6Vv7T7ce1Dwkr1BrSMDsE.png","profile-icon_my.mail.ru":"//yastatic.net/mail/_/6qPVbEE1-TVQ9btJYdCThg16_e8.png","profile-icon_odnoklassniki.ru":"//yastatic.net/mail/_/0eCLzJME3jBZRS6G0e6-XAEuApA.png"}),function(){var e={"thread-sidebar-wrap&":{},"message-head":function(){var e={"message-head-subject":{},"message-head-folder":{},"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{},"important-toggleable-head":{},"message-head-sender-wrap":{},"message-head-labels":{},"message-head-date":{}};
return Daria.showPriorityLabel()&&(e["priority-toggleable-head"]={}),e},"message-widget&":{},"message-body&":{},"attachments-widget-body&":{}};Daria.is3pane()||(e["message-quick-reply&"]={}),ns.layout.define("layout-message",{message:e}),ns.layout.define("message",{"app messages-direct-box@":{},"app right-box@":function(){var t={};return Daria.getPrevPageSearchContext()&&(t["messages-search-session"]={}),ns.View.infoLite("message-headline").methods.checkShow()?(t["message-headline"]={},t.message=e):t.message=e,t["message-fake-list"]={},Daria.is2pane()&&(t["message-prevnext"]={},t.footer={"footer-journal-link&":{},"footer-help-link":{}}),t
}},"common+left+toolbar");var t={"message-head-eml":{"message-head-subject-eml":{"message-head-date-eml":{}},"message-head-sender-name-eml&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-dkim&":{}},"message-body":{},"attachments-widget-body":{}};ns.layout.define("attached-message-preview",{"attached-message":t})}(),ns.layout.define("map-up",{"map-up":{map:{"map-city-complaint":{}},"map-actions":{}}}),ns.layout.define("no-message",{"app service-box@":{404:{}},"app messages-direct-box@":{}},"common"),ns.layout.define("layout-quick-reply-message",{"quick-reply-message":{message:{"message-head":{"message-head-sender-name&":{},"message-head-recipient&":{},"message-head-recipient-count&":{},"message-head-sender-wrap":{},"message-head-date":{},"message-head-labels":{}},"message-toolbar-fake":{},"message-body&":{}}}}),ns.layout.define("message-head-sender-empty",{"message-head-sender@":{}}),ns.layout.define("message-head-sender-info",{"message-head-sender@":{"message-head-sender-info&":{}}}),ns.layout.define("layout-thread-sidebar",{"thread-sidebar-box":{"thread-sidebar":{},"thread-sidebar-expand-button":{}}}),ns.layout.define("layout-thread-sidebar-item",{"thread-sidebar-item-box@":{"thread-sidebar-item-title":{}}}),ns.layout.define("layout-thread-sidebar-item-related",{"thread-sidebar-item-box@":{"thread-sidebar-item-title":{},"thread-sidebar-item-related&":{}}}),ns.layout.define("layout-thread-sidebar-item-attachments",{"thread-sidebar-item-box@":{"thread-sidebar-item-title":{},"thread-sidebar-item-attachments&":{}}}),ns.layout.define("layout-thread-sidebar-item-links",{"thread-sidebar-item-box@":{"thread-sidebar-item-title":{},"thread-sidebar-item-links&":{}}}),ns.layout.define("layout-thread-sidebar-item-same-author",{"thread-sidebar-item-box@":{"thread-sidebar-item-title":{},"thread-sidebar-item-same-author&":{}}}),ns.Model.define("do-send-promise-sms",{params:{phone:null,offset:null}}),ns.Model.define("do-postmaster",{params:{from:null,mid:null,perc:null,readTime:null,time:null,yandexuid:null}}),ns.Model.define("do-unsubscribe",{params:{ids:null}}),ns.Model.define("get-event",{params:{data:null}}),ns.Model.define("get-event-ics",{params:{ids:null,stid:null,inc_hid:null}},"base-calendar-event"),ns.Model.define("get-event-by-ics",{params:{uid:null,icsUrl:null}}),ns.Model.define("geo-coder",{params:{geocode:null,ll:null}}),ns.Model.define("geo-ip",{methods:{getCoordinates:function(){var e=this.select(".get_coordinates_by_ip.latitude")[0],t=this.select(".get_coordinates_by_ip.longitude")[0];
return e&&t?t+","+e:""}}}),function(){ns.Model.define("groupon-topics",{events:{"ns-model-init":function(){this.setData({exclude:["vtnrf0grouponsite"],"groupon-emails":["daily@deals.groupon.ru","daily@e.groupon.ru","no-reply@groupon.ru"],labels:[{label:"Фитнес",img:"//yastatic.net/mail/_/0vUCECpLeu8xnYbh4bifNBY4iwA.png"},{label:"Отдых",img:"//yastatic.net/mail/_/seooZtaTApziniWoSHBBqbiU2g.png"},{label:"Обувь",img:"//yastatic.net/mail/_/9B4i_blM3i_PabI3I5Dw7vm1osg.png"},{label:"Стрижка",img:"//yastatic.net/mail/_/0HKIfr73fuAZwx8X3JF-QDme6EM.png"},{label:"Фотоаппарат",img:"//yastatic.net/mail/_/ieSwNdtHyuoJc2YxQFH7IqC_LNE.png"},{label:"Одежда",img:"//yastatic.net/mail/_/91yiKeG60x-rkpCYKRup5kLNNMY.png"},{label:"Авиабилеты","filter-label":"Авиабилет",img:"//yastatic.net/mail/_/BQz677pUpSPmyVMFCNKqU9Ngho.png"},{label:"Косметика",img:"//yastatic.net/mail/_/mn0kHsVoi0NPiOF8O9LcxYAQ4vc.png"},{label:"Ножи",img:"//yastatic.net/mail/_/8WGQnNhPorHfJ8_YbnqfpgPNpmU.png"},{label:"Жесткий диск",img:"//yastatic.net/mail/_/WkarIoD0WvoxShRMV6CPheCINYU.png"},{label:"Сковородки","filter-label":"Сковородка",img:"//yastatic.net/mail/_/oXLYSiEzC693tcYPVrJMZjoqLHg.png"},{label:"Кастрюли","filter-label":"Кастрюля",img:"//yastatic.net/mail/_/AXTQ4i1mIGzvLnpQLWgT8m4sjZY.png"},{img:"//yastatic.net/mail/_/eh1XPCVTV3654eB5facVs9lgFcw.png",label:"Мебель"},{label:"Химчистка",img:"//yastatic.net/mail/_/5d_FIiP2PbCAu9qwZa_ksWoNjdI.png"},{label:"Электроварка",img:"//yastatic.net/mail/_/9cQJpGpBpjRjZi81VBlsjmrK1Ac.png"},{label:"Навигатор",img:"//yastatic.net/mail/_/ypZokK9KszJJSDLWNE6mw5JKYks.png"},{label:"Йога",img:"//yastatic.net/mail/_/nrDyG4hMBerfgbXVZA-HVMTr54o.png"},{label:"Хранение шин",img:"//yastatic.net/mail/_/r9lB-2A636coCj4arkNdUM0fzMw.png"},{label:"Робот-пылесос",img:"//yastatic.net/mail/_/igyvcz_w9Nx4Kc0CoG7VNiMb9v8.png"},{label:"Смартфон",img:"//yastatic.net/mail/_/TUHGbktrvBoSRN29vS0biVFxPgs.png"},{label:"Диван",img:"//yastatic.net/mail/_/doZgrNfSfCbpk8bX8UAVA_Hl9sg.png"},{label:"Ресторан",img:"//yastatic.net/mail/_/xevMXk49nCcvP51ipVzDW0m4FDE.png"},{label:"Маникюр",img:"//yastatic.net/mail/_/76W8ZC3g-2wD9hBhdB7f335FRcI.png"},{label:"Клининг, уборка","filter-label":"Клининг",img:"//yastatic.net/mail/_/982ulbTSh_bB-k-1HAb47Ybpm2I.png"},{label:"Бокалы","filter-label":"Бокал",img:"//yastatic.net/mail/_/wu_8I0BGQ6BN-dtauXgcpsY9W08.png"},{label:"Кровать",img:"//yastatic.net/mail/_/CWWS1F9Viy2F4znsUEhkTqBEdZM.png"},{label:"Планшет",img:"//yastatic.net/mail/_/4bBTjZW4oMC8uGvhOkSf5kQF-tw.png"},{label:"Телевизор",img:"//yastatic.net/mail/_/d7dQIr9zVVPOgHZgZly33ns3uN4.png"},{label:"Компьютер","filter-label":"Компьютер",img:"//yastatic.net/mail/_/Vc2VbVl7UBUTIOkVpWYNnV6Z93U.png"},{label:"Ноутбук","filter-label":"Ноутбук",img:"//yastatic.net/mail/_/Vc2VbVl7UBUTIOkVpWYNnV6Z93U.png"},{label:"Холодильник",img:"//yastatic.net/mail/_/h42grs7B_IMgK2O4eMfztaesEOY.png"},{label:"Наручные часы",img:"//yastatic.net/mail/_/IEefNaPbWgqyn77Mu8FxM-Yrf_A.png"},{label:"Принтеры","filter-label":"Принтер",img:"//yastatic.net/mail/_/s1PeC3Kud55mIvB3_fuo4hI1h8c.png"},{label:"Видеорегистратор",img:"//yastatic.net/mail/_/3xKNuNKnQ_NSfROkDdlAEYiey2M.png"},{label:"Колесные диски",img:"//yastatic.net/mail/_/yw9ixXwc4VNlhPttNM3oo2KsckU.png"},{label:"Электронные книги",img:"//yastatic.net/mail/_/9rbOYeV505d-qDcIQDH-2KkUavY.png"},{label:"Монитор",img:"//yastatic.net/mail/_/e1Wesje9XxoBnag3pJ_jonjgsBs.png"},{label:"Автомагнитола",img:"//yastatic.net/mail/_/dn2JsxYYbF8fwarPOO34Ag7ukM4.png"},{label:"Объектив",img:"//yastatic.net/mail/_/IJWfFqhzkeHXB_v0gc5uNnYwsRc.png"}],"promo-labels":[{label:"Фитнес",theme:"fitness"},{label:"Отдых",theme:"relax"},{label:"Обувь",theme:"shoes"},{label:"Стрижка",theme:"haircut"},{label:"Фотоаппарат",theme:"camera"},{label:"Одежда",theme:"clothes"},{label:"Авиабилеты",theme:"avia-tickets"},{label:"Косметика",theme:"cosmetics"}]})
}}},ns.ModelStatic)}(),ns.Model.define("map-data",{params:{address:null}}),ns.Model.define("message-in-reply-to-full",{params:{ids:null},methods:{preprocessData:function(e){if(e&&(e.mid&&!ns.Model.get("message",{ids:e.mid}).isValid()&&ns.Model.get("message",{ids:e.mid}).setData(e),e.date)){var t=e.date.chunks;e.date.ts=new Date(t.year,t.month,t.date,t.hours,t.minutes).getTime()}return e}}}),ns.Model.define("message-in-reply-to-ng",{params:{message_id:null},methods:{_sortByDateDesc:function(e,t){return e.date>t.date?-1:e.date<t.date?1:0
},getLastDraft:function(){if(!this.isValid())return null;var e=ns.Model.get("folders").getFolderBySymbol("draft");if(!e)return null;var t=null,s=e.fid;return this.getData().envelopes.sort(this._sortByDateDesc).some(function(e){return e.fid===s?(t=e,!0):!1}),t}}}),ns.Model.define("message-nearest",{params:{ids:null},methods:{preprocessData:function(e){return _.forEach(e.message,function(e){if(e.mid){var t=ns.Model.get("message",{ids:e.mid});t.isValid()||t.setData(e)}}),e},getNearestMessages:function(){var e={prev:null,current:null,next:null};
return(this.get(".message")||[]).forEach(function(t){["next","prev","current"].forEach(function(s){t[s]&&(e[s]=t)})}),e},getNextMid:function(){return this.select(".message[.next].mid")[0]||null},canShowPrevNext:function(){var e=this.getNearestMessages();return e.prev||e.next}}}),ns.Model.define("message-toolbar",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null},ctor:function(){this.recalculateButtons=this.recalculateButtons.bind(this)},methods:{toShowUnsubscribeButton:function(e,t,s){return!e&&(t.hasListUnsubscribe()||t.hasFactUnsubscribe()||s.isNews())
},SMART_BUTTON_ID_FALLBACK:"reply",onBeforeDestroyed:function(){this._unbindModelEvents()},request:function(){return ns.request(["message","message-body"],{ids:this.params.ids}).then(this._bindModelEvents,this)},_bindModelEvents:function(e){this.mMessage=_.find(e,"id","message"),this.mMessageBody=_.find(e,"id","message-body"),this.mMessage.on("ns-model-changed",this.recalculateButtons),this.recalculateButtons()},_unbindModelEvents:function(){this.mMessage.off("ns-model-changed",this.recalculateButtons)
},recalculateButtons:function(){var e={},t=this.mMessage,s=this.mMessageBody,i="",n=ns.Model.get("all-toolbar-buttons"),a=n.getData(),o=[],r=t.inFolderBySymbol("draft"),l=t.inFolderBySymbol("archive"),u=t.isSpam(),d=t.isPinned(),c=t.getSOLabels(),h=_.contains(c,"12"),g=s.allowedReplyAll(),m=this.toShowUnsubscribeButton(u,s,t);if(h||r||o.push(g?"reply-all":"reply"),r&&(i="draft-finish"),o.push("delete"),r||(u?o.push("not-spam"):h||o.push("spam"),!h&&g&&o.push("reply"),h||o.push("forward"),m&&o.push("unsubscribe"),!h&&g&&o.push("reply"),l||o.push("archive")),h||r||o.push("forward"),o.push("folders-actions"),o.push("labels-actions"),t.isValidForPin()){var p=d?"unpin":"pin";
o.push(p)}var f;f=i||-1===o.indexOf(this.SMART_BUTTON_ID_FALLBACK)?[].concat(i||this.SMART_BUTTON_ID_FALLBACK,o):o;var b=_.filterValuesContainingPropValue(a,"id",f);b.sort(function(e,t){return f.indexOf(e.id)>f.indexOf(t.id)?1:-1}),e.visibleButtons=b.splice(0,3).concat(n.getButtonsByIds("more")),e.moreButtons=b,this.setData(e)}}}),ns.Model.define("message-thread-nearest",{events:{"ns-model-init":"_onInit"},params:{ids:null},methods:{_onInit:function(){this.setData({})},getNearestMessages:ns.Model.infoLite("message-nearest").methods.getNearestMessages}},ns.ModelStatic),ns.Model.define("save-event",{params:{data:null}}),ns.Model.define("staff-get-user-info",{params:{email:null}}),ns.Model.define("message-widget-state",{params:{ids:null},events:{"ns-model-init":function(){this.setData({show:{"message-widget-translate":!1}})
}},methods:{isViewUserClose:function(e){return Boolean(this.get("."+e+"-user-close"))},setViewUserClose:function(e){this.set("."+e+"-user-close",!0),this.setIfChanged(".show."+e,!1)},resetViewUserClose:function(e){this.set("."+e+"-user-close",!1),this.setIfChanged(".show."+e,!1)},show:function(e,t){this.set("."+e+"-user-close",!1),this.setIfChanged(".show."+e,!0,t)},isShow:function(e){return Boolean(this.get(".show."+e))}}},ns.ModelStatic),ns.Model.define("message-draft",{params:{ids:null},methods:{request:function(){return ns.request("message-body",this.params).then(this._requestMessageInReplyTo,this).then(this._requestDraftMessage,this).then(this._requestApplyData,this)
},getDraftMid:function(){var e=this.get(".mid");if(e){var t=ns.Model.get("message",{ids:e});t.isValid()&&!t.isDraftLike()&&(e=void 0,this.setIfChanged(".mid",e))}return e},_requestMessageInReplyTo:function(e){var t=_.find(e,"id","message-body"),s=t.get(".info.message-id");return s?new vow.Promise(function(e){ns.forcedRequest("message-in-reply-to-ng",{message_id:s}).then(function(t){var s=t[0],i=s.getLastDraft(),n=i&&i.mid;e(n)},function(){e()})}):vow.Promise.resolve()},_requestDraftMessage:function(e){return e?new vow.Promise(function(t){ns.request(["message","message-body"],{ids:e}).then(function(s){var i=_.find(s,"id","message"),n=i.getFolderId();
n&&ns.Model.get("folders").isFolder(n,["draft","outbox"])?t(e):t()},function(){t()})}):vow.Promise.resolve()},_requestApplyData:function(e){this.setData({mid:e})}}}),Daria.InfiniteModelCollection=function(){},no.inherit(Daria.InfiniteModelCollection,ns.ModelCollection,{canLoadMore:function(){return Boolean(this.get(".details.canLoadMore"))},isEmpty:function(){return!this.models||!this.models.length},loadMore:function(){var e=0;this.isValid()?e=this.models.length:this.clear();var t=_.assign({},this.params,{first:e});
return ns.request(this.id,t).then(function(e){var t=e[0];this.data&&this.isValid()||(this.data={},this.status=this.STATUS.OK);var s=t.get(".details")||{},i=this.get(".details")||{},n=t.models;return this.set(".details",_.merge(i,s),{silent:!0}),this.insert(n),ns.Model.destroy(t),n},this)}}),ns.Model.define("thread-attachments-item",{model:{"thread-attachments-item":!0},params:{"url-key":null},methods:{preprocessData:function(e){var t=Daria.getExtensionInfo(e.name);return t.class&&(e.icon=t.class),e
}}}),ns.Model.define("thread-attachments",{params:{thread_id:null,first:null},split:{items:".attachments",params:{"url-key":".url-key"},model_id:"thread-attachments-item"}},Daria.InfiniteModelCollection),ns.Model.define("thread-sidebar-item",{params:{thread_id:null,id:null},methods:{getId:function(){return this.get(".id")}}}),ns.Model.define("thread-sidebar",{events:{"ns-model-init":"_onInit"},params:{thread_id:null},split:{items:".items",params:{thread_id:".thread_id",id:".id"},model_id:"thread-sidebar-item"},methods:{_onInit:function(){this.setData({items:[]})
}}},ns.ModelCollectionStatic),ns.Model.define("thread-sidebar-state",{events:{"ns-model-init":"_onInit"},ctor:function(){this.triggerUpdateDebounce=_.debounce(this.triggerUpdate.bind(this),50)},methods:{_onInit:function(){this.setData({activeItemId:1,flight:!1,body:{},relatedScrollTop:0,relatedScrollIntoView:!0,update:!1})},toggleItem:function(e){var t=this.get(".activeItemId");return t===e?(this.set(".activeItemId",null),!1):(null!==t&&(this.setIfChanged(".relatedScrollTop",0,{silent:!0}),this.setIfChanged(".relatedScrollIntoView",!0,{silent:!0})),this.set(".activeItemId",e),!0)
},unsetActiveItem:function(){this.setIfChanged(".relatedScrollTop",0,{silent:!0}),this.setIfChanged(".relatedScrollIntoView",!0,{silent:!0}),this.setIfChanged(".activeItemId",1)},isActive:function(e){return this.get(".activeItemId")==e},isFlight:function(){return this.get(".flight")},shouldScrollRelatedIntoView:function(){return Boolean(this.get(".relatedScrollIntoView"))},disableScrollRelatedIntoViewFlag:function(){this.setIfChanged(".relatedScrollIntoView",!1,{silent:!0})},triggerUpdate:function(){this.set(".update",!0)
},metrikaCount:function(){var e=Array.prototype.slice.call(arguments);e.unshift("Правая колонка",this.get(".flight")?"Плавающая правая колонка":"Статичная правая колонка"),Jane.c.apply(Jane,e)},metrikaBlockCount:function(e){Jane.c("Правая колонка","Блоки правых колонок",e)}}},ns.ModelStatic),ns.Model.define("messages-from",{params:{first:null,from:null},split:{items:".envelopes",model_id:"messages-from-item",params:{ids:".mid"}}},Daria.InfiniteModelCollection),ns.Model.define("messages-from-item",{params:{ids:null},methods:{preprocessData:function(e){return e.subject&&"No subject"!==e.subject||(e.subject="(Без темы)"),e.date.view=Daria.MessageTime.getFormattedTime(e.date.timestamp),e
},hasRelativeTime:function(){return this.get(".date.view.isRelative")},updateTime:function(){var e=Daria.MessageTime.getFormattedTime(this.get(".date.timestamp"));this.set(".date.view",e)}}}),ns.Model.define("messages-thread-link",{params:{id:null},methods:{preprocessData:function(e){return e.host=$.url(e.src).Host,e}}}),ns.Model.define("messages-thread-links",{params:{thread_id:null,first:null},split:{items:".links",params:{id:".id"},model_id:"messages-thread-link"}},Daria.InfiniteModelCollection),ns.Model.define("message-widget",{events:{"ns-model-init":"_onInit"},params:{ids:null,type:null},methods:{_onInit:function(){this.setData({type:null})
}}},ns.ModelStatic),ns.Model.define("message-widget-list",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null},methods:{_onInit:function(){this.setData({})},insertWidget:function(e){return this.insert(ns.Model.get("message-widget",_.extend({type:e},this.params)).setData({type:e}))}}},ns.ModelCollectionStatic),function(e,t){t.message={},function(){t.message.audioPlayer={},t.message.audioPlayer.init=function(e){if(!swfobject.hasFlashPlayerVersion("9.0.0"))return void t.Dialog.open({title:"Flash",body:"Для прослушивания музыкальных вложений необходим Flash-проигрыватель."});
var s,i=e.currentTarget,n=$(i),a=i.getAttribute("href")||i.getAttribute("data-href"),o=Boolean(i.getAttribute("data-large")),r=n.parent().find(".b-file__player"),l=r.children('[id ^= "attach-player-"]');l.length?s=l.attr("id"):(s="attach-player-"+t.getRandomNumber(),$("<span/>",{id:s}).appendTo(r)),this._players[s]||(this._players[s]={playLink:i}),this._players[s].url||(this._players[s].url=a),o?n.closest(".b-file").addClass("b-file_player"):n.hide(),$("#"+s).parent().removeClass("g-hidden"),this._players[s].swf||(this.pause(),swfobject.embedSWF(t.Config.mailStatic+"/swf/audio-player"+(o?"-large":"")+".swf",s,o?80:160,o?96:20,"9.0.0",null,{player_id:s,audio_url:encodeURIComponent(this._players[s].url)},{wmode:"transparent",quality:"high",bgcolor:"#ffffff",allowScriptAccess:"always"},{id:s}),this._players[s].swf=!0,this.playerAction(s,"play"))
},t.message.audioPlayer._players={},t.message.audioPlayer._activePlayer=null,t.message.audioPlayer.pause=function(){if(this._activePlayer)try{$("#"+this._activePlayer)[0].pausePlayer()}catch(e){}},t.message.audioPlayer.playerAction=window.playerAction=function(e,t){switch(t){case"play":e!=this._activePlayer&&this.pause(),this._players[e].status="playing",this._activePlayer=e;break;case"pause":this._players[e].status="paused";break;case"close":e==this._activePlayer&&this.pause(),$("#"+e).parent().addClass("g-hidden"),$(this._players[e].playLink).show()
}},t.message.audioPlayer.reset=function(){for(var e in this._players)swfobject.removeSWF(e),$(this._players[e].playLink).show(),delete this._players[e]}}(),t.message._formWhiteList=["booking.com","google.com","livejournal.com","mail.ru","yandex.ru"],t.message.formWarning=function(s){var i=s.getAttribute("action"),n=i.split("/")[2];return n&&(n=n.split(".").slice(-2).join("."),t.message._formWhiteList.indexOf(n)>0)?!0:(e.ErrorLog.send({event:"formWarning",host:i}),window.confirm("Вы отправляете данные на сайт, не имеющий отношения к Яндексу. Продолжить?"))
},function(){function s(){var s=["Предложение фильтровать групоны"],i=$.merge([],arguments);t.GrouponFilters.grouponPagType&&s.push(t.GrouponFilters.grouponPagType),t.GrouponFilters.grouponAction&&s.push(t.GrouponFilters.grouponAction),i=$.map(i,function(e){return $.trim(t.supplant(e,[t.GrouponFilters.popupShowed||""]))}),$.merge(s,i),t.DEBUG&&console&&console.info&&console.info("metrika groupon: ",s),e.c(s)}function i(e,s){return s="undefined"!=typeof s?s:1,"undefined"==typeof e?!0:(e=Number(e),e+864e5*s<t.now()||!1)
}t.GrouponFilters={},t.GrouponFilters.dialog=null,t.GrouponFilters.$dialog=null,t.GrouponFilters.grouponPagType=!1,t.GrouponFilters.grouponAction=!1,t.GrouponFilters.popupShowed=!1,t.GrouponFilters.showPopup=function(i){i=i||{};var n=i.message||"Выберите, какие скидки вам интересны, и получайте только их в Яндекс.Почте",a=t.GrouponFilters.grouponPagType,o=t.GrouponFilters.grouponAction,r=t.Dialog.open({body:e.tt("message:groupon-dialog",{pageType:a,grouponAction:o},["filters","labels","groupon-topics"]),additionalClass:"b-groupon-promo__popup",easyclose:!0,title:n,width:"tt"===t.Config.locale?"760":"650",byAction:i.byAction,onopen:function(){s("Плашки с тематиками (popup)","показ")
},oncancel:function(){s("Плашки с тематиками (popup)","закрыли по крестику {0}")},onclose:function(){s("Плашки с тематиками (popup)","закрыли {0}"),t.GrouponFilters.$dialog=null,t.GrouponFilters.dialog=null,t.GrouponFilters.grouponPagType=!1,t.GrouponFilters.grouponAction=!1}});return t.GrouponFilters.$dialog=r.$dialog,t.GrouponFilters.dialog=r,t.GrouponFilters.isPromo=!1,r.$dialog.removeClass("b-intruder__unsubscribe"),e.Services.runModules(["jane.setup.js"]),r},t.GrouponFilters.showPromoPopup=function(){var i="Настройте почту для себя",n=t.Dialog.open({body:e.tt("message:groupon-promo",{},["groupon-topics"]),additionalClass:["b-groupon-promo__popup","b-groupon-promo__popup_promo2"],title:i,width:"520",onopen:function(){s("Промо на всех","показ")
},oncancel:function(){s("Промо на всех","закрыли по крестику {0}")},onclose:function(){s("Промо на всех","закрыли {0}"),t.GrouponFilters.$dialog=null,t.GrouponFilters.dialog=null,t.GrouponFilters.grouponPagType=!1,t.GrouponFilters.grouponAction=!1}});return t.GrouponFilters.$dialog=n.$dialog,t.GrouponFilters.dialog=n,t.GrouponFilters.isPromo=!0,n},t.GrouponFilters.getCurrentNode=function(){return t.GrouponFilters.$dialog||$(".block-groupon-filters:visible")},t.GrouponFilters.onChangeCondition=function(s){var i=t.GrouponFilters.getCurrentNode(),n=t.GrouponFilters.editing||ns.Model.get("settings").getSetting("groupon_filter"),a=i.find("[data-selected]").length;
return s||a?(i.find(".js-services-count").text("Вы подписаны на "+e.i18n.convert([a+" тематику",a+" тематики",a+" тематик"],a)),i.removeClass("b-intruder__unsubscribe"),void this.enableButton(i.find(".nb-button.daria-onchange"))):n?(i.find(".js-services-count").text("Вы подписаны на "+e.i18n.convert(["0 тематику","0 тематики","0 тематик"],"0")),void i.addClass("b-intruder__unsubscribe")):(i.find(".js-services-count").text("Вы подписаны на все тематики"),void this.disableButton(i.find(".nb-button.daria-onchange")))
},t.GrouponFilters.disableButton=function(t){var s=$(t);return e.disableButton(s),s},t.GrouponFilters.enableButton=function(t){var s=$(t);return e.enableButton(s),s},t.GrouponFilters.savePromoData=function(e){this.params=$.extend(this.params,e),e=$.param(e),ns.Model.get("settings").setSettings({groupon_promo:e})},t.GrouponFilters.readPromoData=function(){var e=ns.Model.get("settings").getSetting("groupon_promo");return e&&(e=e.replace(/&amp;/g,"&")),e=t.parseQuery(e),this.params=e,e},t.GrouponFilters.onPageLoad=function(){var e;
t.GrouponFilters.showDialog&&(e=t.GrouponFilters.showDialog,t.GrouponFilters.showDialog=!1,t.GrouponFilters.showPopup(e))},t.GrouponFilters._onActionComplete=function(e,n){var a,o,r,l,u=n.action,d=n.force,c=ns.Model.get("settings").getSetting("groupon_filter");if(o=n.eventObject.hasCouponMessage){if(a=t.GrouponFilters.params||t.GrouponFilters.readPromoData(),r=Number(a.popup_showed)||0,l=a.lastTS,n.byAction=!0,r&&c)return;(!r||3>r&&i(l,1)||r>=3&&i(l,40))&&(t.GrouponFilters.grouponAction=u,r+=1,t.GrouponFilters.savePromoData({lastTS:t.now(),popup_showed:r}),t.GrouponFilters.grouponPagType=ns.page.current.page,s("Плашки с тематиками (popup)","показ "+r),t.GrouponFilters.popupShowed=r,"mark"===u||d?t.GrouponFilters.showPopup(n):t.GrouponFilters.showDialog=n)
}},t.GrouponFilters.onActionComplete=function(){},t.GrouponFilters.showSuccessPopup=function(){t.Dialog.open({body:e.tt("mail:groupon-success-dialog",{type:ns.page.current.page}),additionalClass:"b-groupon-promo__popup",title:"Теперь вам будут приходить только избранные скидки",easyclose:!0,width:"650",onopen:function(){s("Плашка о создании фильтра (popup)","показ")},onclose:function(){s("Плашка о создании фильтра (popup)","закрыли {0}"),ns.events.trigger("daria:vGrouponFilters:update",{noFakeProgress:!0})
}})},t.GrouponFilters.focusInput=function(){this.getCurrentNode().find(".js-groupon-filter-input").focus()},t.GrouponFilters.testHelper={removeHiddenFilters:function(){var e=ns.Model.get("filters").getData(),t=jpath(e,'.action[.name == "X-Yandex-Groupon" || .name == "X-Yandex-Groupon-2"].filid'),s=[];$.each(t,function(e,t){s.push({handlers:["do-filters-delete","filters"],params:{id:t}})}),ns.Model.get("settings").setSettings({show_groupon_actions:!1,groupon_filter:!1,groupon_time:!1}),ns.forcedRequest(s).then($.proxy(console.log,console))
},removeFolder:function(){var e=jpath(ns.Model.get("folders").getData(),'.folder[.name == "Скидки" || .name == "Скидочные сервисы"].fid');$.each(e,function(e,t){ns.action.run("folder.remove",{id:t})})},removeSettings:function(){ns.Model.get("settings").setSettings({groupon_promo:!1,groupon_filter:!1})},clear:function(){this.removeHiddenFilters(),this.removeFolder(),this.removeSettings(),window.location.reload()}}}(),t.message.getLinkStaffByEmail=function(s){return t.email.isCorp(s)?e.Config["staff-host"]+"/"+s.split("@")[0]:""
},t.ImageViewer={openImages:function(s,i){var n=this,a=$(window);this.images=$.isArray(s)?s:[],this.images.length&&(this.ppyrus=!1,this.images[0].mid||(this.ppyrus=!0),this.images=$.map(this.images,function(e){return n.getImageData(e)}),this.imgObjects={},this.$currentImage=null,this.$content=$(e.tt("message:image-viewer",{count:this.images.length,attachment:this.images})),this.$title=this.$content.find(".b-image-viewer__title"),this.$download=this.$content.find(".b-image-viewer__download"),this.$fullsize=this.$content.find(".b-image-viewer__fullsize"),this.$page=this.$content.find(".b-image-viewer__page"),this.$subject=this.$content.find(".b-image-viewer__subject"),this.$from=this.$content.find(".b-image-viewer__from"),this.$to=this.$content.find(".b-image-viewer__to"),this.$date=this.$content.find(".b-image-viewer__date"),this.$print=this.$content.find(".b-image-viewer__print"),this.$gallery=this.$content.find(".b-image-viewer__gallery-i"),this.ppyrus&&this.$content.find(".b-image-viewer__meta").hide(),this.originalScrollTop=a.scrollTop(),t.Layer.open({body:this.$content,onclose:function(){n.onclose()
}}),1===this.images.length?this.$content.addClass("b-image-viewer_single"):e.c("Просмотрщик картинок","Показ стрелок"),this.$content.addClass("b-image-viewer_loading"),this.updateLayout(),a.on("resize",this.onresize),$(document).on("click",this.ondocumentclick),this.$gallery.on("mousewheel",this.onmousewheel),$.Shortcuts.modalListOn("image-viewer"),isNaN(i)||"number"!=typeof i?this.currentIndex=0:(this.currentIndex=i,this.select(i)))},showSavePopup:function(t){var s="в просмотрщике картинок",i=this.images[this.currentIndex];
ns.View.create("disk-widget-save-popup").open({mid:i.mid,hid:i.hid,popup:{where:t,withTail:!1,appendTo:".js-image-viewer"},countLocationName:s}),e.c(["Вложения",'клик "сохранить на диск"',s])},open:function(e,t,s,i){var n=this,a={ids:t};i&&(a.hid=i),ns.request(["message-body"],a).then(function(e){var i=[],a=0,o=[{mid:t,attachment:e[0].data.attachment}],r=[];$.each(o,function(e,n){n.attachment&&$.each(n.attachment,function(){if("image"==this["class"]&&this["browser-supports"]){r.push({handlers:["message"],params:{ids:n.mid}});
var e=$.extend({mid:n.mid},this);n.mid==t&&this.hid==s&&(a=i.length),i.push(e)}})}),n.openImages(i),n.select(a)})},onclose:function(){var t=$(window);t.off("resize",this.onresize),$(document).off("click",this.ondocumentclick),this.$gallery.off("mousewheel",this.onmousewheel),$.Shortcuts.modalListOff("image-viewer"),"originalScrollTop"in this&&(t.scrollTop(this.originalScrollTop),delete this.originalScrollTop),this.images=[],this.imgObjects={},this.$currentImage=null,e.c("Просмотрщик картинок","Закрытие")
},onresize:function(){var e=t.ImageViewer;e.$content.find(".b-image-viewer__container, .b-image-viewer__arrow").css({width:"",height:""}),e.updateLayout()},ondocumentclick:function(e){var s=$(e.target);s.closest(".b-image-viewer__gallery").length||t.ImageViewer.hideGallery(),s.closest(".b-image-viewer").length||t.Layer.close();var i=s.closest(".js-show-save-popup");i.length&&(e.preventDefault(),e.stopPropagation(),t.ImageViewer.showSavePopup(i.get(0)))},onmousewheel:function(e){var s=e.originalEvent;
t.ImageViewer.scrollGallery(-s.wheelDelta||s.detail,50,!0)},updateImage:function(){var e=this.images[this.currentIndex];this.$currentImage&&this.$currentImage.removeClass("b-image-viewer__image_current"),this.createImage(this.currentIndex),this.createImage(this.getNextIndex(this.currentIndex)),this.createImage(this.getPrevIndex(this.currentIndex)),this.$currentImage=this.imgObjects[this.currentIndex],this.$currentImage.addClass("b-image-viewer__image_current"),this.$currentImage[0].complete?this.$content.removeClass("b-image-viewer_loading"):this.$content.addClass("b-image-viewer_loading"),this.$title.html(e.name),this.$title.attr("title",e.name),this.$download.attr("href",e.downloadUrl),this.$page.html(this.currentIndex+1),this.$subject.html(e.subject),this.$subject.attr("href",e.emailUrl),this.$from.html(e.from),this.$to.html(e.to),this.$date.html(e.date),this.$content.find(".b-image-viewer__preview").removeClass("b-image-viewer__preview_current"),this.$content.find(".b-image-viewer__preview_"+this.currentIndex).addClass("b-image-viewer__preview_current"),e.fullSizeUrl?(this.$print.attr("data-params","src="+encodeURIComponent(e.fullSizeUrl)),this.$fullsize.attr("href",e.fullSizeUrl),this.$print.show(),this.$fullsize.show()):(this.$print.hide(),this.$fullsize.hide())
},createImage:function(e){var t=this;if(!this.imgObjects[e]){this.$content.addClass("b-image-viewer_loading");var s=$('<img class="b-image-viewer__image">');s.appendTo(this.$content.find(".b-image-viewer__container")),s.one("load",function(){t.$currentImage&&t.$currentImage.length&&(t.$currentImage[0].complete?t.$content.removeClass("b-image-viewer_loading"):t.$content.addClass("b-image-viewer_loading"))});var i=this.images[e];i.fullSizeUrl?s.attr("src",i.fullSizeUrl):s.attr("src",i.downloadUrl),s.css({maxWidth:this.maxImageSize[0],maxHeight:this.maxImageSize[1]}),this.imgObjects[e]=s
}},updateLayout:function(){var e=$(window),t=e.width()-185,s=e.height()-100;this.ppyrus||(s-=this.$content.find(".b-image-viewer__meta").height()),this.maxImageSize=[t,s];var i=t/3,n=2*i;this.$content.find(".b-image-viewer__content").css({width:e.width()-170}),this.$content.find(".b-image-viewer__container").css({width:t,lineHeight:s+"px"}),this.$content.find(".b-image-viewer__container, .b-image-viewer__arrow").css("height",s),this.$content.find(".b-image-viewer__image").css({maxWidth:t,maxHeight:s}),this.$content.find(".b-image-viewer__arrow_prev").css({width:i}),this.$content.find(".b-image-viewer__arrow_next").css({width:n,marginLeft:-n+"px",backgroundPosition:n-35+"px 50%"})
},getImageData:function(e){var s,i,n,a,o,r,l,u;if("object"==typeof e&&e||(e={}),e.mid){var d=ns.Model.get("message",{ids:e.mid}),c=d.getEmails();s=t.url.attachment(e,e.mid),i=t.url.attachment(e,e.mid,{no_disposition:!0,exif_rotate:!0}),n=t.url.attachment(e,e.mid,{no_disposition:!0,thumb:!0,exif_rotate:!0}),a=c.from,o=c.to,r=_.escape(d.getSubject()),l="#message/"+e.mid,u=d.getDate()}else s=e.url,i=e.fullSizeUrl,n=e.thumbUrl,a=e.from||"",o=e.to||"",r=e.subject||"",l=e.emailUrl||"",u=e.date||"";return a=this.formatEmail(a),o=this.formatEmail(o),{name:_.escape(e.name),filename:_.escape(e.filename),downloadUrl:s,fullSizeUrl:i,thumbUrl:n,from:a,to:o,subject:r,emailUrl:l,date:u,mid:e.mid,hid:e.hid}
},formatEmail:function(e){var t="";return e&&"object"==typeof e&&(t=_.escape(e.name||e.email),e.name&&e.email&&(t+=" &lt;"+_.escape(e.email)+"&gt;")),t},next:function(){this.currentIndex=this.getNextIndex(this.currentIndex),this.updateImage()},getNextIndex:function(e){var t=e+1;return t>=this.images.length&&(t=0),t},prev:function(){this.currentIndex=this.getPrevIndex(this.currentIndex),this.updateImage()},getPrevIndex:function(e){var t=e-1;return 0>t&&(t=this.images.length-1),t},select:function(e){e>=0&&e<this.images.length&&(this.currentIndex=e,this.updateImage())
},toggleGallery:function(){this.$content.toggleClass("b-image-viewer_gallery"),this.$gallery[0].scrollLeft=168*(this.currentIndex+1)-this.$gallery.width()/2,this.scrollGallery(1,1e-4,!0)},hideGallery:function(){this.$content.removeClass("b-image-viewer_gallery")},isGalleryOpen:function(){return this.$content.hasClass("b-image-viewer_gallery")},scrollGallery:function(e,t,s){t=t||800;var i=this.$gallery[0],n=i.scrollLeft+(0>e?-1:1)*t,a=this,o=function(){a.$content.find(".b-image-viewer__gallery-arrow").removeClass("b-image-viewer__gallery-arrow_disabled");
var e=i.scrollLeft;0===e&&a.$content.find(".b-image-viewer__gallery-arrow_left").addClass("b-image-viewer__gallery-arrow_disabled"),n>e&&a.$content.find(".b-image-viewer__gallery-arrow_right").addClass("b-image-viewer__gallery-arrow_disabled")};s?i.scrollLeft=n:this.$gallery.animate({scrollLeft:n},500,"linear",o),o()}},t.Layer={init:function(){this.$el=$('<div class="b-layer"><div class="b-layer__overlay"></div><div class="b-layer__content-wrap"><div class="b-layer__close ns-action" data-click-action="layer.close"></div><div class="b-layer__content"></div></div></div>'),this.$el.appendTo(document.body),this.$content=this.$el.find(".b-layer__content"),this.$window=$(window);
var e=this;this.$window.resize(function(){e.opened&&e.$el.css({width:e.$window.width(),height:e.$window.height()})}),ns.events.on("ns-page-before-changed",function(){t.Layer.close()})},open:function(e){this.opened&&this.close(),this.opened=!0,this.$el||this.init(),this.onclose=e.onclose,this.$el.css({width:this.$window.width(),height:this.$window.height()}),this.$content.empty().append(e.body),window.scrollTo(0,0),$(document.documentElement).addClass("b-page_layer")},close:function(){this.opened=!1,$(document.documentElement).removeClass("b-page_layer"),"function"==typeof this.onclose&&this.onclose()
}},t.message.Location=function(e){if(!(e instanceof jQuery))throw new Error("Node should be a jQuery object");if(!e.get(0).childNodes)throw new Error("Malformed address node");if(this._$node=e,this._parsed=null,this._highlighted=!1,this._address=e.data("address"),!this._address)throw new Error("Passed node should have an address")},t.message.Location.prototype.getAddress=function(){return this._address},t.message.Location.prototype._getMapData=function(){return ns.Model.get("map-data",{address:this._address}).getData()
},t.message.Location.prototype.findParsedMetadata=function(e){this._parsed=_.find(e,{geo_addr:this.getAddress()})},t.message.Location.prototype._needsHighlight=function(){return this.isKnownAddress()?this.inUserArea()?!0:this.hasCity()||this.isUnique():!1},t.message.Location.prototype._doHighlight=function(){var e=this._$node.get(0),t=_.last(e.childNodes),s=t.textContent.lastIndexOf(" ");-1!==s?$(t.splitText(s+1)).wrap('<span class="mail-Message-Map-NoBreak"></span>').parent().append('<span class="mail-Message-Map-Link-Icon icon"></span>').parent().addClass("js-extracted-highlighted-address mail-Message-Map-Link"):this._$node.append('<span class="mail-Message-Map-Link-Icon icon"></span>').addClass("js-extracted-highlighted-address mail-Message-Map-Link")
},t.message.Location.prototype.highlight=function(){this._needsHighlight()&&(this._doHighlight(),this._highlighted=!0)},t.message.Location.prototype.isHighlighted=function(){return this._highlighted},t.message.Location.prototype.isKnownAddress=function(){return Boolean(this._getMapData().addressLocation)},t.message.Location.prototype.inUserArea=function(){return this._getMapData().inUserArea},t.message.Location.prototype.isUnique=function(){return this.isKnownAddress()&&1===this._getMapData().addressLocation.precision
},t.message.Location.prototype._checkHasMeta=function(){if("object"!=typeof this._parsed)throw new Error("Set parsed address metadata from tomita using location.setParsedMeta()")},t.message.Location.prototype.hasCity=function(){return this._checkHasMeta(),Boolean(this._parsed.geo&&this._parsed.geo.city)},t.message.Location.prototype.hasStreet=function(){return this._checkHasMeta(),Boolean(this._parsed.addr&&this._parsed.addr.street)},function(){var e=t.IS_CORP?["Правая колонка","Корп"]:["Правая колонка"];
t.message.messageRight={},t.message.messageRight=e,t.message.messageRight.MTabs={thread:e.concat("Вкладка «Треды»"),history:e.concat("Вкладка «Переписка»"),attachments:e.concat("Вкладка «Вложения»"),links:e.concat("Вкладка «Ссылки»")}}(),function(){var s={heights:{},rootWrappers:{},offsetWrappers:{},itemHeight:43,collapsed:{},vpHeight:{},footerHeight:null,lastResize:0,lastHeight:0},i={thread:["message-thread-nearest","folders"],history:["message-history-nearest","folders"],attachments:["message-history-nearest"],links:["message-history-nearest"]},n={thread:"fixed",history:"fluid",attachments:"fluid",links:"fluid"},a=".grid-right",o=function(){var e;
$(window).on("resize"+a,function(){"number"==typeof e&&clearTimeout(e),e=setTimeout(function(){s.lastResize=new Date-0,r.active&&r.active.setHeight()},16)}),ns.events.on("ns-page-after-load",function(){"message"!==ns.page.current.page&&(s.lastHeight=0)})},r=function(e,n){var l=this;o.inited||(o(),o.inited=!0),l.root=e,l.grid=e.closest(".b-grid"),l.mid=n,l.params=t.parseQuery(l.root.attr("data-params")),s.rootWrappers[n]=l.root.closest(".b-message__right"),s.offsetWrappers[n]=s.rootWrappers[n].find(".b-mail-tabs"),l.grid.on("click"+a,".b-link_arrow-up",function(){l.scroll("up")
}),l.grid.on("click"+a,".b-link_arrow-down",function(){l.scroll("down")}),s.rootWrappers[n].on("click"+a,".b-mail-tabs__toggler",function(){l===r.active&&l.collapse()}),l.initScroll(),s.footerHeight||(s.footerHeight=$(".b-footer:first").height()),l.loadHandlers=i[l.params.type],l.bindEvent("set-height",function(e,t){l.setHeight(t)}),l.bindEvent("set-collapse",function(e,t){l.recalculateCollapse(t)}),delete s.collapsed[n]};r.getHeight=function(e){var t=s.heights[e];return t&&t.stamp>=s.lastResize&&t.value
},r.getVpHeight=function(){var e=s.vpHeight;return(!e.stamp||e.stamp<s.lastResize)&&(e.stamp=new Date-0,e.value=$(window).height()),e.value},r.triggerEvent=function(e,t,s){ns.events.trigger(e+".message-right"+(t?"."+t:""),s)},r.bindEvent=function(e,t,s){ns.events.on(e+".message-right"+(t?"."+t:""),s)},r.active=null,r.prototype={root:null,mid:null,params:null,contentHeight:null,getContentHeight:function(){return!this.contentHeight&&this.root[0]&&(this.contentHeight=this.root[0].scrollHeight),this.contentHeight
},arrows:null,getArrows:function(e){return this.arrows||(this.arrows=this.root.closest(".b-grid").find(".b-link_arrow")),e?this.arrows.filter(".b-link_arrow-"+e):this.arrows},loadHeight:function(){return r.getHeight(this.mid)},saveHeight:function(e){s.heights[this.mid]={value:e,stamp:new Date-0},s.lastHeight=e,this.contentHeight=void 0},getScrollMetrics:function(){var e=this.root.find(".js-grid-message"),t=this.getItemHeight();return{count:Math.round(this.getContentHeight()/t),height:Math.floor((this.loadHeight()||this.root.height())/t),offset:(this.root.scrollTop()||0)/t,items:e,item:t}
},getItemHeight:function(){return s.itemHeight},onshow:function(){var e=this;r.active&&r.active.onhide(),r.active=this,this.showed||this.recalculateCounters(),s.lastHeight&&e.setHeight({height:s.lastHeight,dry:!0}),setTimeout(function(){e.setHeight(),e.recalculateArrows(),e.recalculateCollapse()},16),this.showed=!0},onhide:function(){r.active=null},collapsed:null,recalculateCollapse:function(e){if(e&&e.force)return this.collapse();if(this.mid in s.collapsed)return this.collapsed=s.collapsed[this.mid],this.collapsed;
var t=this.root.closest(".b-message"),i=t.find(".b-message-body"),n=t.width()<i.width();s.rootWrappers[this.mid].closest(".b-layout__inner").toggleClass("b-layout__inner_full",n),n-0!==this.collapsed-0&&this.collapse()},collapse:function(){var i=s.offsetWrappers[this.mid],n=t.message.messageRight;if(this.collapsed)i.removeClass("b-mail-tabs_folded"),this.setHeight(),e.c(n.concat("Развёрнута"));else if(this.collapsed===!1)i.addClass("b-mail-tabs_folded"),e.c(n.concat("Свёрнута"));else{var a=this.getArrows().fadeOut("slow"),o=this.grid.find(".b-grid__i");
o.animate({height:0},"slow",function(){i.addClass("b-mail-tabs_folded"),o.css({height:"auto"}),a.fadeIn(0),e.c(n.concat("Свёрнута атоматически"))})}s.collapsed[this.mid]=this.collapsed=!this.collapsed},resolveFooter:function(){var e=r.getVpHeight(),t=$(document).height(),i=s.footerHeight;s.rootWrappers[this.mid].toggleClass("b-message__right_big",e+i>t)},recalculateHeight:function(){if(this.root.is(":visible")){var e=r.getVpHeight(),t=this.getItemHeight(),s=e-this.root.offset().top-3*t;s=Math.floor(s/t)*t,t>s&&(s=t),s>11*t&&(s=11*t),this.saveHeight(s)
}},recalculateArrows:function(){var e=this.getScrollMetrics();this.getArrows().removeClass("b-link_disabled"),this.params.prev||0!==e.offset||this.getArrows("up").addClass("b-link_disabled"),!this.params.next&&e.height+e.offset>e.count-1&&this.getArrows("down").addClass("b-link_disabled")},recalculateCurrent:function(){var e=this.getScrollMetrics(),t=e.count===e.items.length,s=$.inArray(e.items.filter(".b-grid-item_current")[0],e.items),i=t?1:Math.round(e.items.eq(s).height()/e.item);if(!t){var n=0,a=e.items.slice(0,s);
$.each(a,function(e,t){n+=$(t).height()}),s=Math.round(n/e.item)}var o=e.offset+(i>=e.height?0:Math.floor((e.height-i)/2)),r=o-s;r&&(this.getArrows().removeClass("b-link_disabled"),this.scroll(r>0?"up":"down",Math.abs(r),0))},recalculateCounters:function(){var e="fluid"===n[this.params.type],t=e?this.root.find(".js-grid-item").length:this.params.count;0===t||1===t?t="":t>99?t="99+":e&&(this.params.prev||this.params.next)&&(t+="+"),s.offsetWrappers[this.mid].find(".js-mail-tabs__counter_"+this.params.type).text(t)
},scrollAberration:Modernizr.msie?10:2,scrollOnTop:!1,scrollOnBottom:!1,scrollDelta:void 0,scrollTimeout:void 0,scrollLast:0,scrollAnimate:function(e,t){var s=this;t>20?(this.scrollAI=!0,this.root.stop(!0,!1).animate({scrollTop:e},function(){s.recalculateArrows(),this.scrollAI=!1})):(this.scrollAI=!0,this.root.stop(!0,!1).scrollTop(e),s.recalculateArrows(),this.scrollAI=!1)},initScroll:function(){var e=this;e.root.on("mousewheel",function(t,s,i,n){("number"!=typeof n||0!==n)&&e.onmousewheel(t,s||t.wheelDelta)
})},onmousewheel:function(e,t){var s=this,i=this.root.scrollTop(),n=this.loadHeight(),a=this.getContentHeight(),o=new Date-0,r=100;if(this.scrollLast&&(r=2*(o-this.scrollLast),25>r&&(r=25),r>500&&(r=500)),this.scrollLast=o,!(n>a)&&(this.root.stop(!0,!1),this.scrollAI=!1,"number"==typeof this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(function(){s.onscrollend()},r),this.scrollDelta=t,this.scrollOnTop=t>0&&i<this.scrollAberration,this.scrollOnBottom=0>t&&i+n>a-this.scrollAberration,this.scrollOnTop&&t>0||this.scrollOnBottom&&0>t)){if(e.preventDefault(),this.isLoading)return;
t>0&&this.params.prev?this.load("up"):0>t&&this.params.next?this.load("down"):this.recalculateArrows()}},onscrollend:function(e,t){var s=this.root.scrollTop(),i=this.getItemHeight(),n=s%i;if(e=e||this.scrollDelta,t="undefined"==typeof t?100:t,0===n||0===e)return void this.recalculateArrows();var a=e>0?0-n:i-n;this.scrollAnimate(s+a,Math.ceil(t*Math.abs(a)/i)),this.scrollLast=0},scroll:function(e,t,s){if(!this.isLoading){var i=this,n=this.getArrows(e);if(!n.hasClass("b-link_disabled")){this.root.stop(!0,!0),this.onscrollend(e>0?1:-1,0);
var a=this.getScrollMetrics(),o=a.offset,r=a.height,l=a.count;if(t="undefined"==typeof t?r:t,s="undefined"==typeof s?200:s,"down"===e)if(r>l-o-t){if(this.params.next)return void this.load(e,function(){i.scroll(e,t,s)});o=l-r}else o+=t;if("up"===e)if(0>o-t){if(this.params.prev)return void this.load(e,function(){i.scroll(e,t,s)});o=0}else o-=t;this.scrollAnimate(a.item*o,s)}}},load:function(s,i){if(!this.isLoading){this.isLoading=!0;var n=this,a=this.params.type,o=this.root.find(".js-grid-message")["up"===s?"first":"last"](),r=o[0].className.match(/mtn\-(\d+)/)[1],l=this.loadHandlers,u={ids:r,tab:a},d={mid:r,tab:a};
ns.request(l,u).then(function(){var a=$(e.tt("mail:message-right-grid",d,l,u)).find(".b-grid__i2"),c=t.parseQuery(a.attr("data-params")),h=a.find(".js-grid-message"),g=$.inArray(a.find(".mtn-"+r)[0],h),m="up"===s?h.slice(0,g):h.slice(g+1);o["up"===s?"before":"after"](m),n.contentHeight=null,"up"===s&&n.scrollAnimate(n.getItemHeight()*m.length,0),$.each(["prev","next"],function(e,t){c[t]||(n.params[t]=c[t])}),n.recalculateCounters(),e.c(t.message.messageRight.MTabs[n.params.type].concat("Дозагружена")),i&&i()
}).always(function(){n.isLoading=!1})}},getHeight:function(){return this.root.attr("style")&&this.root.height()},setHeight:function(e){var t=this,s=this.getItemHeight();e=e||{};var i=e.height||this.loadHeight();if(i||(this.recalculateHeight(),i=this.loadHeight()),i=Math.floor(i/s)*s,s>i&&(i=s),this.getHeight()!==i){var n=function(){t.recalculateCurrent(),!e.dry&&e.height&&t.saveHeight(i),t.resolveFooter(),e.callback&&e.callback()};e.animationSpeed?this.root.animate({height:i},e.animationSpeed,n):(this.root.height(i),n())
}},triggerEvent:function(e,t){r.triggerEvent(e,this.mid,t)},bindEvent:function(e,t){r.bindEvent(e,this.mid,t)}},t.GridRight=r}(),t.VideoPlayer={flashPlayerVersion:swfobject.getFlashPlayerVersion().major,currentSWFOptions:{},currentHostingOptions:{},defaultSWFOptions:{width:425,height:355,flashvars:{}},SWFParams:{allowscriptaccess:"always",allowfullscreen:!0,quality:"high",bgcolor:"#000000"},expressInstallSWFUrl:"http://img.yandex.net/i/expressinstall.swf",hostingOptions:{youtube:{urlAddon:"&amp;enablejsapi=1&amp;playerapiid=ytplayer",pauseMethod:"pauseVideo"}},defaultHostingOptions:{flashPlayerVersion:8},open:function(e){if(e=$.extend({},this.defaultSWFOptions,e),!e.player_url||!e.hosting_name)return!0;
var t=this.hostingOptions[e.hosting_name.toLowerCase().split(".")[0]];if(t=$.extend({},this.defaultHostingOptions,t),this.flashPlayerVersion<t.flashPlayerVersion)return!0;this.$popup||this.init(),e.width=parseInt(e.width,10),e.height=parseInt(e.height,10),e.player_url!==this.currentSWFOptions.player_url&&($(".b-movie-player").css({width:e.width+"px",height:e.height+"px"}),e.player_url=e.player_url.replace(/^https?:/,""),swfobject.embedSWF(e.player_url+(t.urlAddon||""),"movie-player",e.width,e.height,String(t.flashPlayerVersion),this.expressInstallSWFUrl,e.flashvars,this.SWFParams),this.currentSWFOptions=e,this.currentHostingOptions=t),this.$paranja.removeClass("g-hidden");
var s=$(window),i=s.height(),n=s.scrollTop(),a=e.width+60,o=this.$popup.height(),r=i>o?(i-o)/2:0;this.$popup.css({width:a,"margin-right":-Math.round(a/2),top:n+Math.round(r)}),this.$popup.css("visibility","visible"),$("#movie-player").css("visibility","visible"),$.Shortcuts.modalListOn("video-player")},close:function(){this.$popup.css("visibility","hidden"),$("#movie-player").css("visibility","hidden"),this.$paranja.addClass("g-hidden"),$.Shortcuts.modalListOff();var e=this.currentHostingOptions.pauseMethod;
if(e){var t=document.getElementById("movie-player");t[e]instanceof Function&&t[e]()}else swfobject.removeSWF("movie-player"),this.$popup.find(".b-movie-player").html('<div id="movie-player"></div>'),this.currentSWFOptions={},this.currentHostingOptions={}},init:function(){var t=e.tt("message:video-player");this.$popup=$(t),this.$popup.css("visibility","hidden").appendTo(document.body),this.$paranja=$('<div class="b-paranja b-paranja_mail"><iframe></iframe></div>').addClass("g-hidden").appendTo(document.body)
}},function(){var s=t.MessageProcess={};!function(){t.MessageProcess.Actions={},t.MessageProcess.Actions.quoteExpand=function(e){var s=$(e.target);if(s.closest("a,.js-quote-control-expand").length)return!0;var i=s.data(),n=s.closest(".b-quote").get(0);return t.MessageProcess.quoteExpandToggle(n,!0,i,this.node),!0},t.MessageProcess.Actions.quoteExpandAll=function(e){var s=$(e.currentTarget),i=s.closest(".b-quote"),n=s.data();return i.addClass("b-quote_loading"),s.removeClass("ns-action"),t.MessageProcess.quoteExpandAll(i[0],function(){i.removeClass("b-quote_loading"),s.addClass("ns-action")
},n),!0},t.MessageProcess.Actions.quoteExpandToggle=function(e){var s=$(e.currentTarget),i=s.closest(".b-quote").get(0);return t.MessageProcess.quoteExpandToggle(i),!0},t.MessageProcess.Actions.quoteMaximize=function(e){var t=$(e.currentTarget),s=t.closest(".b-quote");s.removeClass("b-quote_minimized b-quote_minimized_first b-quote_minimized_center b-quote_minimized_last")},t.MessageProcess.Actions.toggleQuote=function(e){this.quoteExpand(e);var t=$(e.target);t.prev(".js-quote_content").removeClass("is-hidden"),t.addClass("is-hidden")
}}(),function(s){var i=s.Author={};i.AUTHOR_CHUNK_SIZE=10,i.REG_AUTHOR_PART_CONTEXT=/^(?:\)?>)\s?(?:wrote|\u043f\u0438\u0448\u0435\u0442|\u043f\u0438\u0448\u0435|\u043f\u0456\u0448\u0430|\u043d\u0430\u043f\u0438\u0441\u0430\u0432|\u043d\u0430\u043f\u0456\u0441\u0430\u045e|yazd\u0131|yaz\u0131yor|\u043d\u0430\u043f\u0438\u0441\u0430\u043b(?:\(\u0430\)))?\s?:/,i.PARSE_AUTHOR_FORMATS=[["?prefix","namefirst","?date","?time"],["?prefix","?date","?time","namelast"]],i.PARSE_AUTHOR_PARTS={prefix:[[/^Sent from my (?:iPad|iPhone|iPod)/i,function(){return{weight:5}
}]],date:[[/^\[?(?:on\s)?(\d\d)[\.\/\-](\d\d)[\.\/\-](\d\d(?:\d\d)?)\]?/i,function(e){var t=Number(e[3]);100>t&&(t=2e3+t);var s=Date.UTC(t,Number(e[2])-1,Number(e[1]));return{weight:5,datetime:{date:e[1]+"."+e[2]+"."+e[3],ts:isNaN(s)?!1:s}}}],[/^\[?(?:on\s)?(\d{4})[\/\.\-](\d{2})[\/\.\-](\d{2})\]?/i,function(e){var t=Date.UTC(Number(e[1]),Number(e[2])-1,Number(e[3]));return{weight:5,datetime:{date:e[3]+"."+e[2]+"."+e[1],ts:isNaN(t)?!1:t}}}],[/^\[?(?:on\s)?[^\s\d]*?\s?(\d{1,2})\s([^\s\d]+?)\s(\d{4})(?:\s\u0433.)?\]?/i,function(t){var s,i=e.Date.getMonthByName(t[2]);
return-1!==i&&(s=Date.UTC(Number(t[3]),i,Number(t[1]))),{weight:5,datetime:{date:t[1]+" "+t[2]+" "+t[3],ts:!s||isNaN(s)?!1:s}}}],[/^\[?(?:on\s)?[^\s\d]*?\s?([^\s\d]+?)\s(\d{1,2})\s(\d{4})(?:\s\u0433.)?\]?/i,function(t){var s,i=e.Date.getMonthByName(t[1]);return-1!==i&&(s=Date.UTC(Number(t[3]),i,Number(t[2]))),{weight:5,datetime:{date:t[1]+" "+t[2]+" "+t[3],ts:!s||isNaN(s)?!1:s}}}],[/^\[?(?:on\s)?([^\s\d]+?)\s(\d{1,2})\s(\d{4})(?:\s\u0433.)?\]?/i,function(t){var s,i=e.Date.getMonthByName(t[1]);return-1!==i&&(s=Date.UTC(Number(t[3]),i,Number(t[2]))),{weight:5,datetime:{date:t[1]+" "+t[2]+" "+t[3],ts:!s||isNaN(s)?!1:s}}
}]],time:[[/^\[?(?:at\s|\u0432\s)?(\d{1,2}:\d\d(?::\d\d)?\s?(?:am|pm)?\s?(?:(?:[A-Z]{3})?[+-]\d\d:?(?:\d\d)?)?)\]?/i,function(e){return{weight:5,datetime:{time:$.trim(e[1])}}}]],namefirst:[[/^\*\s(?:\u043e\u0442\s|\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c\s)?(?:"|\\")?([^"\\\[\]<>]*)(?:"|\\")?\s?(?:<([^<>]+)>)?/i,function(t){var s={weight:0},i=$.trim(t[1]);i&&(s.name=i,s.weight=s.weight+30);var n=e.FormValidation.getEmailFromString($.trim(t[2]));return n&&(s.email=n,s.weight=s.weight+30),s
}]],namelast:[[/^(?:\u043e\u0442\s|\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c\s|from\s|user\s|\u0430\u0434\s|\u0432\u0456\u0434\s|\u043a\u0430\u0440\u044b\u0441\u0442\u0430\u043b\u044c\u043d\u0456\u043a\s|\u043a\u043e\u0440\u0438\u0441\u0442\u0443\u0432\u0430\u0447\s|kullan\u0131c\u0131\s)?(?:"|\\")?([^\:]*?)(?:"|\\")?\s?(?:<([^<>]+)>)?\s?(wrote|\u043f\u0438\u0448\u0435\u0442|\u043f\u0438\u0448\u0435|\u043f\u0456\u0448\u0430|\u043d\u0430\u043f\u0438\u0441\u0430\u0432|\u043d\u0430\u043f\u0456\u0441\u0430\u045e|yazd\u0131|yaz\u0131yor|\u043d\u0430\u043f\u0438\u0441\u0430\u043b(?:\(\u0430\))?)?(?:\s?"?:)?$/i,function(t){var s={weight:0},i=$.trim(t[1]);
i&&"*"!==i&&"."!==i&&(s.name=i,s.weight=s.weight+30);var n=e.FormValidation.getEmailFromString($.trim(t[2]));return n&&(s.email=n,s.weight=s.weight+30),t[3]&&(s.weight=s.weight+5),s}]]},i.getQuoteAuthor=function(e){var s=e.getAttribute("data-author");if(!s)return null;try{return s=JSON.parse(decodeURIComponent(s)),s.email&&(s.href=t.message.getLinkStaffByEmail(s.email)),s}catch(i){return null}return s},i.removeQuoteAuthorData=function(e){e.removeAttribute("data-author")},i.parseAuthorText=function(e){e=e.replace(/[,\n]/g," ").replace(/\s+/g," ").trim();
for(var t,s,n,a,o,r,l,u,d,c,h,g,m=i.PARSE_AUTHOR_FORMATS,p=i.PARSE_AUTHOR_PARTS,f=0;t=m[f++];){for(n=0,c=0,h={},g=e;s=t[n++];){for(a="?"!==s.charAt(0),a||(s=s.substr(1)),d=null,u=null,o=p[s],l=0;r=o[l++];)if(u=g.match(r[0])){d=r[1](u);break}if(d)c+=d.weight,$.extend(!0,h,d);else if(a)break;u&&u[0]&&(g=g.substr(u[0].length).trim())}if(c>30)break}return h.weight=c,h.weight>30?h:null},i.findAndRemoveQuoteAuthorSync=function(e,t,s){for(var n,a=i._getQuotesAuthorNotProcessed(e,t),o=0;n=a[o++];)i._findAndRemoveQuoteAuthor(n);
i._compareQuoteAuthorPosition(t,s)},i.findAndRemoveQuoteAuthor=function(e,s,n){function a(e){return function(){for(var t,a=e*i.AUTHOR_CHUNK_SIZE,r=0;r<i.AUTHOR_CHUNK_SIZE;r++)t=o[a+r],t&&i._findAndRemoveQuoteAuthor(t);u--,0===u&&(i._compareQuoteAuthorPosition(s),n())}}n=n||$.noop;var o=i._getQuotesAuthorNotProcessed(e,s),r=o.length,l=Math.ceil(r/i.AUTHOR_CHUNK_SIZE),u=l;if(!l)return void n();for(var d=0;l>d;d++)t.setZeroTimeout(a(d))},i._findQuoteAuthorContentCheck=function(t,s,n,a){if(e.DOM.isBlockquote(t))return!1;
var o=e.DOM.isBlockNode(t);if(n.author&&o)return!1;if(a&&!n.author&&o&&(n.firstBlockNode=!0),3!==t.nodeType)return!0;var r=e.String.countLines(s);if(r>4)return!1;if(r!==e.String.countActualLines(s))return!1;!n.firstNode&&s.length>0&&(n.firstNode=t);var l=i.parseAuthorText(s);if(l){if(n.author&&n.author.weight>l.weight)return!1;n.authorStr=s,n.author=l,n.lastNode=t,delete n.firstBlockNode}else{if(n.firstBlockNode)return!1;if(a&&n.author&&n.author.datetime&&n.author.name&&!n.author.email&&t.nodeValue){var u=t.nodeValue.match(i.REG_AUTHOR_PART_CONTEXT);
if(u&&(s=n.authorStr+u[0],l=i.parseAuthorText(s),l&&l.weight>n.author.weight))return n.author=l,n.tmpNode&&(n.lastNode=n.tmpNode,delete n.tmpNode),t.nodeValue=t.nodeValue.substr(u[0].length),!1;n.tmpNode=t,n.authorStr=s}}return!0},i._findQuoteAuthorCreateRange=function(e,t){var s;try{s=document.createRange(),e===t?s.selectNode(e):(s.setStartBefore(e),s.setEndAfter(t))}catch(i){s=[e,t]}return s},i._findQuoteAuthorInner=function(t){var s={};if(e.DOM.eachInnerFollowingText(t,function(t,n){return i._findQuoteAuthorContentCheck(t,e.String.ltrim(n),s,!0)
}),!s.author||!s.lastNode||!s.firstNode)return null;var n=!1;return e.DOM.eachAfter(s.lastNode,function(t){return 3!==t.nodeType||e.DOM.isEmptyTextNode(t)?e.DOM.isBlockquote(t)?!1:void 0:(n=!0,!1)},t),n?{range:i._findQuoteAuthorCreateRange(s.firstNode,s.lastNode),author:s.author}:null},i._findQuoteAuthor=function(t){var s={};return e.DOM.eachBeforeText(t,function(t,n){return i._findQuoteAuthorContentCheck(t,e.String.rtrim(n),s,!1)},t.parentNode),s.author&&s.lastNode&&s.firstNode?{range:i._findQuoteAuthorCreateRange(s.lastNode,s.firstNode),author:s.author}:null
},i.__findAndRemoveQuoteAuthor=function(t){var s=i._findQuoteAuthor(t);return s||(s=i._findQuoteAuthorInner(t)),s?(Array.isArray(s.range)?e.DOM.deleteRangeContents(s.range[0],s.range[1]):(s.range.deleteContents(),s.range.detach()),s.author):null},i._findAndRemoveQuoteAuthor=function(t){s.flagAdd(t,s.F_QUOTE.SEARCH_AUTHOR);var n=i.__findAndRemoveQuoteAuthor(t);return n?(e.DOM.classAdd(t,"b-quote_a"),s.flagAdd(t,s.F_QUOTE.FOUND_AUTHOR),t.setAttribute("data-author",encodeURIComponent(JSON.stringify(n))),!0):!1
},i.__getQuotesAuthorNotProcessed=function(e){return!s.flagContains(e,s.F_QUOTE.SEARCH_AUTHOR)},i._getQuotesAuthorNotProcessed=function(e,t){return Array.prototype.filter.call(s.getQuotesByLevel(e,t),i.__getQuotesAuthorNotProcessed)},i._compareQuoteAuthorPosition=function(t,i){var n=s.getTopParent(i);if(n)for(var a,o,r=s.getQuotesByLevel(n,t),l={},u=0;a=r[u++];)s.flagContains(a,s.F_QUOTE.AUTHOR_POSITION_SEARCH)||(o=s.getQuoteLevel(a),l[o]?(e.DOM.classAdd(a,"b-quote_an"),s.flagAdd(a,s.F_QUOTE.AUTHOR_NEXT,s.F_QUOTE.AUTHOR_POSITION_SEARCH)):(s.flagContains(a,s.F_QUOTE.FOUND_AUTHOR)&&(l[o]=!0),s.flagAdd(a,s.F_QUOTE.AUTHOR_POSITION_SEARCH)))
}}(t.MessageProcess),function(){var e=3,s="message-body.transformers.location-facts",i=/\s/g,n={traverse:function(){var e=function(t,s,i){s(t)&&(i(t),t.childNodes.length>0&&(t.normalize(),_.forEach(t.childNodes,function(t){e(t,s,i)})))};return function(i,n,a){t.assert(i instanceof Node,"Top node should be an instance of Node",s),t.assert("function"==typeof n,"Criterion should be a function",s),t.assert("function"==typeof a,"Action should be a function",s),e.apply(null,arguments)}}(),contains:function(){var e=function(t,s,i){return s===t?!0:null===s.parentNode||s===i?!1:e(t,s.parentNode,i)
};return function(i,n,a){return t.assert(i instanceof Node&&n instanceof Node&&a instanceof Node,"All arguments should be nodes",s),e(i,n,a)}}(),getSmallestContainingNodes:function(e,i){t.assert(e instanceof Node,"TopNode should be a Node",s),t.assert(i instanceof RegExp,"Regexp should be a RegExp",s);var a=[],o=function(e){var t=i.test(e);return i.lastIndex=0,t};return n.traverse(e,function(e){return o(e.textContent)},function(e){a.push(e)}),_.filter(a,function(t){return 0===t.childNodes.length?!0:!a.some(function(s){return s!==t&&n.contains(t,s,e)?!o(t.textContent.replace(s.textContent)):!1
})})}},a=function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},o=function(e,t,s){this._char=e,this._position=t,this._node=s};o.prototype={getChar:function(){return this._char},getPosition:function(){return this._position},getNode:function(){return this._node}};var r=function(){this._stack=[]};r.prototype={push:function(e){this._stack.push(e)},getStart:function(){return this._stack[0]},getEnd:function(){return this._stack[this._stack.length-1]},getSize:function(){return this._stack.length
},isEmpty:function(){return 0===this.getSize()},shift:function(){this._stack.shift()},pop:function(){this._stack.pop()},toString:function(){return _.map(this._stack,function(e){return e.getChar()?e.getChar():e.getNode().toString()}).join("")}};var l=function(e){this._fact=e,this._parsedAddress=e.geo_addr,this._reset()};l.prototype={_reset:function(){this._parts=[],this._parsedPosition=0,this._matched=!1,this._prevsiousChar=""},getCurrentPart:function(){return 0===this._parts.length&&this.addPart(),this._parts[this._parts.length-1]
},addPart:function(){this._parts.push(new r)},getExpectedChar:function(){return this._parsedAddress.charAt(this._parsedPosition)},shiftExpectedChar:function(){return this._parsedPosition++,this.getExpectedChar()},isSkippableNode:function(e){return 0===e.childNodes.length&&["br","wbr"].indexOf(e.nodeName.toLowerCase())>-1},spaceRe:/\s/,match:function(e){var t=this.getCurrentPart().isEmpty(),s=!1;if(t?this._previousSymbol&&(s=e.getNode()!==this._previousSymbol.getNode()):s=e.getNode()!==this.getCurrentPart().getEnd().getNode(),e.getChar()===this.getExpectedChar())!s||t||this.isSkippableNode(this.getCurrentPart().getEnd().getNode())||this.addPart(),this.getCurrentPart().push(e),this.shiftExpectedChar(),this._previousSymbol=e;
else if(this.anyMatched()&&this.isSkippableNode(e.getNode()))this.getCurrentPart().push(e);else if(this.spaceRe.test(e.getChar())){if(" "!==this.getExpectedChar())return;this.getCurrentPart().push(e),this.shiftExpectedChar()}else" "===this.getExpectedChar()?(this.shiftExpectedChar(),this.match(e)):s&&!e.getChar()?this.addPart():1===this.numMatched()&&this._previousSymbol.getChar()&&e.getChar()===this._previousSymbol.getChar()?(this._reset(),this.match(e)):this._reset();this._matched=this.numMatched()===this._parsedAddress.length
},anyMatched:function(){return this.numMatched()>0},numMatched:function(){return this._parsedPosition},matches:function(){return this._matched},getAnchor:function(){var e=this._fact.addr,t=null;return["street","quarter","km","metro","numbers"].some(function(s){return s in e?(t=e[s].toLowerCase(),!0):!1}),t},partToRange:function(e){if(this.normalizePart(e),e.isEmpty())return null;var t=document.createRange();return t.setStart(e.getStart().getNode(),e.getStart().getPosition()),t.setEnd(e.getEnd().getNode(),e.getEnd().getPosition()+1),t
},normalizePart:function(e){for(;!e.isEmpty()&&(d.test(e.getStart().getChar())||this.isSkippableNode(e.getStart().getNode()));)e.shift();for(;!e.isEmpty()&&(c.test(e.getEnd().getChar())||this.isSkippableNode(e.getEnd().getNode()));)e.pop()},selectPart:function(){if(this._parts.forEach(function(e){this.normalizePart(e)},this),this._parts=this._parts.filter(function(e){return!e.isEmpty()}),1===this._parts.length)return this.getCurrentPart();var e,t=this.getAnchor();return t&&this._parts.some(function(s){var i=this.partToRange(s);
return i&&i.toString().toLowerCase().indexOf(t)>-1?(e=s,!0):!1},this)?e:_.max(this._parts,function(e){return e.toString().length})},wrap:function(e){var t=this.partToRange(this.selectPart());if(t&&0===$(t.commonAncestorContainer).closest("a, .js-extracted-address").size()){var s=document.createElement("span");s.setAttribute("class","js-extracted-address"),s.setAttribute("data-address",this._parsedAddress),s.setAttribute("data-ids",e);var i=t.extractContents();t.insertNode(s),s.appendChild(i),t.commonAncestorContainer.normalize()
}}};var u=function(e,t){this._topNode=e,this._addressFact=t,this._currentNode=null,this._currentPositionInsideNode=-1,this._nodesQueue=[],this.buildQueue()};u.prototype={start:function(e){for(var t,s=this.getNewAddress(),i=[];t=this.shiftSymbol();)s.match(t),s.matches()&&(i.push(s),s=this.getNewAddress());i.reverse().forEach(function(t){t.wrap(e)})},getNewAddress:function(){return new l(this._addressFact)},_getCharAtPosition:function(t,s){return t.nodeType===e&&s<t.textContent.length?new o(t.textContent.charAt(s),s,t):null
},shiftSymbol:function(){var e=this.getCurrentNode();this._currentPositionInsideNode+=1;var t=this._getCharAtPosition(e,this._currentPositionInsideNode);return t?t:(e=this.shiftNode())?(this._currentPositionInsideNode=0,t=this._getCharAtPosition(e,this._currentPositionInsideNode),t?t:n.contains(this._topNode,e,this._topNode)?new o(null,this._currentPositionInsideNode,e):null):null},getCurrentNode:function(){return this._currentNode||this.shiftNode()},shiftNode:function(){if(!this._currentNode)return this._currentNode=this._nodesQueue[0],this._currentNode;
var e=this._nodesQueue.indexOf(this._currentNode);return this._nodesQueue.length>e?(this._currentNode=this._nodesQueue[e+1],this._currentNode):null},buildQueue:function(){var t=this._nodesQueue;this._topNode.nodeType===e?t.push(this._topNode):n.traverse(this._topNode,function(){return!0},function(e){t.push(e)})}};var d=/^[^\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\d\u0022\u0027\u00AB\u00BB\u2018\u2019\u201A\u201B\u201C\u201D\u201E\u201F\u2039\u203A\u300C\u300D\u300E\u300F\u301D\u301E\u301F\uFE41\uFE42\uFE43\uFE44\uFF02\uFF07\uFF62\uFF63\u0028\u0029\u005B\u005D\u2045\u2046\u003C\u003E\u007B\u007D\u00AB\u00BB\u2039\u203A\u2308\u2309\u230A\u230B\u231C\u231D\u231E\u231F\u239B\u239C\u239D\u239E\u239F\u23A0\u23A1\u23A2\u23A3\u23A4\u23A5\u23A6\u23A7\u23A8\u23A9\u23AB\u23AC\u23AD\u23AA\u23B0\u23B1\u27E6\u27E7\u27E8\u27E9\u27EA\u27EB\u27EC\u27ED\u27EE\u27EF\u2983\u2984\u2985\u2986\u2987\u2988\u2989\u298A\u298B\u298C\u298D\u298E\u298F\u2990\u2991\u2992\u2993\u2994\u2995\u2996\u2997\u2998\u2E22\u2E23\u2E24\u2E25\u2329\u232A\uFF62\uFF63\u3008\u3009\u300A\u300B\u300C\u300D\u300E\u300F\u3010\u3011\uFF08\uFF09\uFF3B\uFF3D\uFF1C\uFF1E\uFF5B\uFF5D]+/,c=/[^\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA78E\uA790-\uA793\uA7A0-\uA7AA\uA7F8-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\d\u0022\u0027\u00AB\u00BB\u2018\u2019\u201A\u201B\u201C\u201D\u201E\u201F\u2039\u203A\u300C\u300D\u300E\u300F\u301D\u301E\u301F\uFE41\uFE42\uFE43\uFE44\uFF02\uFF07\uFF62\uFF63\u0028\u0029\u005B\u005D\u2045\u2046\u003C\u003E\u007B\u007D\u00AB\u00BB\u2039\u203A\u2308\u2309\u230A\u230B\u231C\u231D\u231E\u231F\u239B\u239C\u239D\u239E\u239F\u23A0\u23A1\u23A2\u23A3\u23A4\u23A5\u23A6\u23A7\u23A8\u23A9\u23AB\u23AC\u23AD\u23AA\u23B0\u23B1\u27E6\u27E7\u27E8\u27E9\u27EA\u27EB\u27EC\u27ED\u27EE\u27EF\u2983\u2984\u2985\u2986\u2987\u2988\u2989\u298A\u298B\u298C\u298D\u298E\u298F\u2990\u2991\u2992\u2993\u2994\u2995\u2996\u2997\u2998\u2E22\u2E23\u2E24\u2E25\u2329\u232A\uFF62\uFF63\u3008\u3009\u300A\u300B\u300C\u300D\u300E\u300F\u3010\u3011\uFF08\uFF09\uFF3B\uFF3D\uFF1C\uFF1E\uFF5B\uFF5D\.,?!]+$/,h=function(e){return e.replace(d,"").replace(c,"")
},g=function(e,t){var s=ns.Model.get("message-body",{ids:t.ids}).getLocations();s=_.uniq(s,function(e){return e.geo_addr}),_.forEach(s,function(e){e.geo_addr=h(e.geo_addr)}),_.sortBy(s,function(e){return-e.geo_addr.length}),_.forEach(s,function(s){var o=new RegExp(a(s.geo_addr).replace(i,"\\s*"),"g");n.getSmallestContainingNodes(e,o).forEach(function(e){var i=new u(e,s);i.start(t.ids)})})};t.Transformers||(t.Transformers={}),t.Transformers.AddressTransformer=_.extend(g,{transformerName:"location-facts",debugMode:s,trimPunctuation:h,escapeRegExp:a,Nodes:n,Symbol:o,Stack:r,Address:l,Parser:u})
}(),function(s){function i(e){var t=e.getAttribute("background");t&&(e.style.backgroundImage='url("'+t+'")'),e.removeAttribute("background")}var n="/re.jsx?",a="/re.jsx?uid="+t.uid+"&c=LIZA&cv="+t.Config.version+"&",o='<a href="{url}" target="_blank" rel="noopener noreferrer" class="ns-action" data-click-action="message.video-player-open" data-params="{params}"><img src="//yastatic.net/mail/_/Q79exothQy0eqGpEScw20S8cMWk.gif" class="b-mail-icon b-mail-icon_video-link" alt="" title="Просмотреть"/></a><a href="{url}" target="_blank" rel="noopener noreferrer">{url}</a>',r=["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении","attachment","attachments","attached"],l="\\xac\\xb1\\xd7\\xf7",u="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",d="\\u2018\\u2019\\u201c\\u201d",c=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",h=l+u+d+c;
s.REG_ATTACHMENTS_STOP_WORDS=new RegExp("(^|.*?["+h+"]+)("+r.join("|")+")($|["+h+"]+)","im"),s.REG_ATTACHMENTS_STOP_WORDS_LIGHT=new RegExp("("+r.join("|")+")","im"),s._checkParentAttachmentsSelect=function(e){var t=e.tagName;return"A"===t||"BLOCKQUOTE"===t?!1:!0},s.attachmentsSelect=function(t){for(var i,n=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,function(i){return s.REG_ATTACHMENTS_STOP_WORDS_LIGHT.test(i.data)&&s.REG_ATTACHMENTS_STOP_WORDS.test(i.data)&&e.DOM.passByParents(i,s._checkParentAttachmentsSelect,t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP
},!1),a=[];i=n.nextNode();)a.push(i);var o=document.createElement("span");o.className="b-pseudo-link b-pseudo-link_attach js-attachments-scroll";for(var r,l,u,d,c,h=0;(i=a.shift())&&(l=i.data.match(s.REG_ATTACHMENTS_STOP_WORDS),!l||(u=l.index+l[1].length,d=u+l[2].length,u>=d||(r=document.createRange(),r.setStart(i,u),r.setEnd(i,d),r.surroundContents(o.cloneNode(!0)),r.detach(),c=i.nextSibling&&i.nextSibling.nextSibling,c&&c.nodeType===Node.TEXT_NODE&&c.data.length>0&&a.unshift(c),h++,e.c("Аттачи в тексте письма","Показ ссылки"),!(h>4)))););h&&e.c("Аттачи в тексте письма","Количество открытий писем с подсвеченными ссылками")
},s.BODY_TRANSFORMERS={regs:[[/(<img[\s\S]*?)src="([^"]*?)"([\s\S]*?\/?>)/gm,function(e,t,s,i){return t+'data-fake-img-src="'+s+'"'+i}]],dom:[t.Transformers.AddressTransformer,function(e){for(var t=$(e).find("*[background]"),s=t.length;s--;){var n=t[s];i(n)}i(e)},function(s,i){for(var o=ns.Model.get("message",i),r=ns.Model.get("message-body",i).getData(),l=r["is-spam"],u=i.forceShowHrefs,d=r["is-support"],c=!1,h=s.getElementsByTagName("a"),g=h.length,m=a+"mid="+i.ids+"&";g--;){var p=h[g],f=p.getAttribute("href");
if(f&&-1!==f.indexOf(n)){var _,b=f.slice(f.indexOf("&l=")+3);o.hasType(38)&&(_=$(p).data("livemail")),b&&(_?(f="//"+_.host+"/?ui=ext&spec="+encodeURIComponent(_.spec+_.inv),b=f):b=t.base64UrlDecode(b),p.setAttribute("data-vdir-href",f.replace(n,m)),p.setAttribute("data-orig-href",b),p.setAttribute("href",b))}if(f&&0===f.indexOf("mailto:")){var v=f.substr(7).split("?"),y=v.shift(),A=ns.parseQuery(v.shift()||""),w=t.lowerifyObjectKeys(A);w.mailto=y,e.DOM.classAdd(p,"ns-action"),p.setAttribute("data-click-action","common.go"),p.setAttribute("data-params","new_window&url="+encodeURIComponent(ns.router.generateUrl("compose2",w)))
}else u||!l||d?(c=!0,e.DOM.classAdd(p,"daria-goto-anchor"),p.setAttribute("target","_blank"),p.setAttribute("rel","noopener noreferrer")):(c=!0,p.setAttribute("h_href",p.getAttribute("href")),p.removeAttribute("href"),e.DOM.classAdd(p,"ya-hidden-link"))}r["has-links"]=c},function(e,t){for(var s=t.forceShowImages,i=ns.Model.get("message-body",t).getData(),n=!1,a=i["hide-imgs"],o=i["has-links"],r=e.getElementsByTagName("img"),l=r.length;l--;){var u=r[l];if(n=!0,a&&!s){for(var d=u.attributes,c=document.createElement("img"),h=0,g=d.length;g>h;h++){var m=d[h],p=m.nodeName,f=m.nodeValue;
"data-fake-img-src"==p?c.setAttribute("h_src",f):c.setAttribute("h_"+p,f)}c.setAttribute("src","//yastatic.net/mail/_/La6qi18Z8LwgnZdsAr1qy1GwCwo.gif"),c.setAttribute("class","ya-hidden-image"+(o?" ya-without-notice":"")),u.parentNode.replaceChild(c,u)}else{var _=u.getAttribute("data-fake-img-src");null!==_&&(u.removeAttribute("data-fake-img-src"),u.setAttribute("src",_))}}i["has-img"]=n},function(e){var t=e.getElementsByTagName("object"),s=t.length;if(!s)return e;var i=document.createElement("param");
for(i.setAttribute("name","wmode"),i.setAttribute("value","opaque");s--;)t[s].appendChild(i.cloneNode(!1));i=null},function(e){for(var t=e.getElementsByTagName("embed"),s=t.length;s--;)t[s].setAttribute("wmode","opaque")},function(e){for(var t,s=e.getElementsByTagName("form"),i=s.length;i--;)t=s[i],t.setAttribute("onsubmit","return Daria.message.formWarning(this)"),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener noreferrer"),t.removeAttribute("formaction")},function(e){for(var t=e.getElementsByTagName("area"),s=t.length;s--;)t[s].setAttribute("target","_blank"),t[s].setAttribute("rel","noopener noreferrer")
},function(e){$("span.wmi-video-link",e).each(function(){var e=$(this);e.replaceWith(t.supplant(o,{url:e.text(),params:this.getAttribute("params")}))})},function(t){for(var i,n,a=s.getQuotesByLevel(t),o=a.length,r=0,l={};o>r;r++){i=a[r];for(var u=i,d=0;u=u.parentNode;)if(e.DOM.isBlockquote(u)){d=s.getQuoteLevel(u);break}var c=d+1,h=(l[c]||0)+1;i.setAttribute("type","cite"),i.setAttribute("data-level",String(c)),i.removeAttribute("style"),n="b-quote",0===d&&(n+=" b-quote_lt"),n+=c%2?" b-quote_odd":" b-quote_even",i.className=n,l[c]=h
}},function(e){s.fixQuotesSync(e,1)},function(t){for(var i,n,a=s.getQuotesByLevel(t),o=a.length,r=0,l={};o>r;r++)i=a[r],n=s.getQuoteLevel(i),l[n]?(e.DOM.classAdd(i,"b-quote_lc"),s.flagAdd(i,s.F_QUOTE.LEVEL_CENTER)):(e.DOM.classAdd(i,"b-quote_lf"),s.flagAdd(i,s.F_QUOTE.LEVEL_FIRST)),l[n]=i;for(var u in l)i=l[u],e.DOM.classAdd(i,"b-quote_ll"),e.DOM.classRemove(i,"b-quote_lc"),s.flagAdd(i,s.F_QUOTE.LEVEL_LAST),s.flagRemove(i,s.F_QUOTE.LEVEL_CENTER);l=null},function(t,i){for(var n,a=s.getQuotesByLevel(t,1),o=a.length,r=0,l=ns.Model.get("message",{ids:i.ids}).isBodyAutoExpand(),u=o>1;o>r;r++)n=a[r],s.flagContains(n,s.F_QUOTE.LEVEL_LAST)||(l||u)&&(s.flagAdd(n,s.F_QUOTE.EXPANDED_ALL),u&&e.DOM.classAdd(n,"js-quote-mini"))
},function(e,t){for(var i=s.getQuotesByLevel(e,1),n=i.length,a=0;n>a;a++)s.wrapQuote(i[a],t)},function(s,i){var n=t.MessageProcess.getQuotesByLevel(s,1);if(1===n.length&&!ns.Model.get("message",{ids:i.ids}).isForward()){var a=n[0],o=a.querySelector(".js-quote_content"),r=a.querySelector(".js-mail-Quote-Toggler");o&&r&&(e.DOM.classAdd(o,"is-hidden"),e.DOM.classRemove(r,"is-hidden"))}}]}}(t.MessageProcess),s.QUOTES_CHUNK_SIZE=10,s.F_QUOTE={AUTHOR_NEXT:"an",AUTHOR_POSITION_SEARCH:"aps",BUBBLING_CONTENT:"bc",CONCAT:"cq",EXPANDED_ALL:"ea",FOUND_AUTHOR:"fa",LEVEL_FIRST:"lf",LEVEL_LAST:"ll",LEVEL_CENTER:"lc",SEARCH_AUTHOR:"sa",WRAP:"qw",WRAP_SEP:"qws"},s.BODY_PROCESS=null,s.getTopParent=function(e){return s.BODY_PROCESS||e
},s.flagContains=function(e,t){return t?1!==e.nodeType?!1:-1!==(" "+(e.getAttribute("data-processed")||"")+" ").indexOf(" "+t+" "):!1},s.flagAdd=function(e){if(1!==e.nodeType)return!1;var t=Array.prototype.slice.call(arguments);t.shift();var s=e.getAttribute("data-processed");s=s?" "+s+" ":" ";for(var i,n=!1,a=0;i=t[a++];)-1===s.indexOf(" "+i+" ")&&(s+=i+" ",n=!0);return n?(e.setAttribute("data-processed",s.trim()),!0):!1},s.flagRemove=function(e){if(1!==e.nodeType)return!1;var t=Array.prototype.slice.call(arguments);
t.shift();var s=e.getAttribute("data-processed");s=s?" "+s+" ":"";for(var i,n=!1,a=0;i=t[a++];)for(;-1!==s.indexOf(" "+i+" ");)s=s.replace(" "+i+" "," "),n=!0;return n?(e.setAttribute("data-processed",s.trim()),!0):!1},s.getQuotesByLevel=function(e,t){return t?e.querySelectorAll?e.querySelectorAll('blockquote[data-level="'+t+'"]'):(t=Number(t),Array.prototype.filter.call(e.getElementsByTagName("blockquote"),function(e){return s.getQuoteLevel(e)===t})):e.getElementsByTagName("blockquote")},s.getQuoteLevel=function(e){return Number(e.getAttribute("data-level")||0)
},s._findQuoteFirstLine=function(t){if(!t.hasChildNodes())return"";var i,n,a=/\n/g,o=0;if(e.DOM.eachInnerFollowingText(t,function(t,s){return e.DOM.isBlockquote(t)?!1:(s=e.String.removeNonLetterString(s.trim()),n=s.match(a),n=n?n.length:0,n!==o&&s.length>100?!1:(i=s,void(o=n)))}),!i)return"";var r=!1;if(i=i.split("\n").filter(function(t){return r||e.String.REG.NONLETTER_STR.test(t)?(r=!0,!1):!0}),!i.length)return"";for(var l=i.length,u="",d=-1;l--;)u=i[l]+u,s.Author.parseAuthorText(u)&&(d=l);return-1!==d&&(i=i.slice(0,d)),i.length?i=e.String.substrWord(i.join(" "),0,200):""
},s._removeEmptyNodeCheck=function(t){return e.DOM.isBlockquote(t)?!1:-1!==["IMG","HR"].indexOf(t.nodeName)?!1:e.DOM.hasAttribute(t,"style")?!1:e.DOM.classContains(t,"icon")?!1:!0},s._quoteWrapSeparator=function(t){if(!s.flagContains(t,s.F_QUOTE.WRAP_SEP)){s.flagAdd(t,s.F_QUOTE.WRAP_SEP);var i=t.parentNode;e.DOM.removeEmptyNodeBefore(t,s._removeEmptyNodeCheck,i),e.DOM.removeEmptyNodeAfter(t,s._removeEmptyNodeCheck,i),e.DOM.eachBefore(t,function(s){return e.DOM.classContains(s,"js-quote-ignore")?"next":e.DOM.isBlockquote(s)?!1:e.DOM.isEmptyText($.text(s))?!0:(e.DOM.classAdd(t,"b-quote__t_sep"),!1)
},i),e.DOM.eachAfter(t,function(s){return e.DOM.classContains(s,"js-quote-ignore")?"next":e.DOM.isBlockquote(s)?!1:e.DOM.isEmptyText($.text(s))?!0:(e.DOM.classAdd(t,"b-quote__b_sep"),!1)},i)}},s._quoteWrapSeparatorInner=function(t){e.DOM.eachInnerPrevious(t,function(s){return 3!==s.nodeType||e.DOM.isEmptyTextNode(s)?e.DOM.isBlockNode(s)&&s!==t?!1:void 0:(e.DOM.classAdd(t,"b-quote__cb_sep"),!1)}),e.DOM.eachInnerFollowing(t,function(s){return 3!==s.nodeType||e.DOM.isEmptyTextNode(s)?e.DOM.isBlockNode(s)&&s!==t?!1:void 0:(e.DOM.classAdd(t,"b-quote__ct_sep"),!1)
})},s._bubblingQuoteContentCheckNode=function(t){return!e.DOM.hasAttribute(t,"style")},s._bubblingQuoteContent=function(t,i){if(!t.hasChildNodes())return t;for(var n=s.getQuotesByLevel(t,i),a=0,o=n.length;o>a;a++)s.flagContains(n[a],s.F_QUOTE.BUBBLING_CONTENT)||(e.DOM.bubblingDivContent(n[a],s._bubblingQuoteContentCheckNode),s.flagAdd(n[a],s.F_QUOTE.BUBBLING_CONTENT));return t},s._concatQuotes=function(e,t){if(!e.hasChildNodes())return e;var i,n,a,o,r=s.getQuotesByLevel(e,t),l=t?!1:!0;for(a=0,o=r.length;o>a;a++)i=r[a],i&&(n=i.parentNode,n&&s._concatChildQuotes(n,l));
return e},s._concatChildQuotesIsEmptyNode=function(t){return e.DOM.isBr(t)||e.DOM.isEmptyTextNode(t)||e.DOM.isEmptyPreNode(t)},s._concatChildQuotes=function(t,i){for(var n,a,o,r,l,u,d=[t],c=[],h=t.ownerDocument.createElement("br");r=d.shift();)if(r.hasChildNodes()&&!s.flagContains(r,s.F_QUOTE.CONCAT)){for(a=r.firstChild,o=e.DOM.isBlockquote(a)?a:null;n=a.nextSibling;){if(e.DOM.isBlockquote(n)){if(o){if(c.length){for(u=!0,l=0;l<c.length;l++)u&&!e.DOM.isEmptyTextNode(c[l])&&(u=!1),o.appendChild(c[l]);
c=[],u&&o.appendChild(h.cloneNode(!1))}else o.lastChild&&n.firstChild&&!e.DOM.isNewlineNode(o.lastChild)&&!e.DOM.isNewlineNode(n.firstChild)&&o.appendChild(h.cloneNode(!1));for(;n.firstChild;)o.appendChild(n.firstChild);a=n.previousSibling,n.parentNode.removeChild(n),i&&-1===d.indexOf(o)&&s.getQuotesByLevel(o).length>0&&d.push(o);continue}o=n}else o&&s._concatChildQuotesIsEmptyNode(n)?c.push(n):(c=[],o=null,i&&e.DOM.isBlockNode(a)&&-1===d.indexOf(a)&&s.getQuotesByLevel(a).length>0&&d.push(a));a=n
}s.flagAdd(r,s.F_QUOTE.CONCAT)}return h=null,t},s.fixQuotesSync=function(e,t,i){s._bubblingQuoteContent(e,t),s._concatQuotes(e,t),s.Author.findAndRemoveQuoteAuthorSync(e,t,i)},s.fixQuotes=function(e,t,i){s._bubblingQuoteContent(e,t),s._concatQuotes(e,t),s.Author.findAndRemoveQuoteAuthor(e,t,i)},s.wrapQuote=function(t,i){if(s.flagContains(t,s.F_QUOTE.WRAP))return!1;s.flagAdd(t,s.F_QUOTE.WRAP),i=i||{};var n=s.Author.getQuoteAuthor(t);s.Author.removeQuoteAuthorData(t);var a=s._findQuoteFirstLine(t);
s._quoteWrapSeparator(t),s._quoteWrapSeparatorInner(t);var o=t.cloneNode(!0);s._expandSmallQuotes(o);var r=$(o);r.wrapInner('<div class="b-quote_content js-quote_content"/>');var l=r.find("> .b-quote_content");l.contents().wrapAll('<div class="b-quote__i js-quote-content"/>'),l.prepend(e.tt("message:js-message-body-quote-ctrls",{ids:i.ids})),a&&l.prepend(e.tt("message:js-message-body-quote-firstline",{firstline:a})),n&&(n.mid=i.ids,l.prepend(e.tt("message:js-message-body-quote-author",n)));var u=$(e.tt("message:js-message-body-quote-toggler"));
return l.after(u),t.parentNode.replaceChild(o,t),s.flagContains(o,s.F_QUOTE.EXPANDED_ALL)&&(s.flagRemove(o,s.F_QUOTE.EXPANDED_ALL),s.wrapQuotesSync(o,!1,function(t){e.DOM.classAdd(t,"b-quote_expanded")},i),e.DOM.classAdd(o,"b-quote_expanded")),!0},s.wrapQuotesSync=function(e,t,i,n,a){i=i||$.noop,s.fixQuotesSync(e,t,a);for(var o=s.getQuotesByLevel(e,t),r=0,l=o.length;l>r;r++)s.wrapQuote(o[r],n),i(o[r])},s.wrapQuotes=function(e,i,n){var a=$({});a.queue(function(t){s.fixQuotes(e,null,t)}),a.queue(function(i){function a(e){return function(){for(var t=e*s.QUOTES_CHUNK_SIZE,a=0;a<s.QUOTES_CHUNK_SIZE;a++){var r=o[t+a];
r&&s.wrapQuote(r,n)}l--,0===l&&i()}}var o=s.getQuotesByLevel(e),r=Math.ceil(o.length/s.QUOTES_CHUNK_SIZE),l=r;if(!r)return void i();for(var u=0;r>u;u++)t.setZeroTimeout(a(u))}),a.queue(i)},s.quoteExpandToggle=function(t,i,n,a){var o=e.DOM.classContains(t,"b-quote_expanded"),r="undefined"==typeof i;if(i===!1||r&&o)return void e.DOM.classRemove(t,"b-quote_expanded");if(i===!0||r&&!o){var l=s.getQuoteLevel(t)+1;s.wrapQuotesSync(t,l,null,n,a),e.DOM.classAdd(t,"b-quote_expanded")}},s.quoteExpandAll=function(t,i,n){i=i||$.noop;
var a=$(t).closest(".b-quote_lt").get(0);s.wrapQuotes(a,function(){i();for(var n=s.getQuotesByLevel(a),o=n.length;o--;)n[o]&&e.DOM.classAdd(n[o],"b-quote_expanded");a===t&&e.DOM.classAdd(a,"b-quote_expanded")},n)},s.processBody=function(t,i){var n,a,o,r,l=document.createElement("div");s.BODY_PROCESS=l;try{for(n=0,a=s.BODY_TRANSFORMERS.regs.length;a>n;n++)o=s.BODY_TRANSFORMERS.regs[n],r=o[2],(!r||r(i.ids))&&(t=t.replace(o[0],o[1]));for(l.innerHTML=t,n=0,a=s.BODY_TRANSFORMERS.dom.length;a>n;n++)(o=s.BODY_TRANSFORMERS.dom[n])(l,i)
}catch(u){e.ErrorLog.sendException("PROCESS_BODY_ERROR",u)}return s.BODY_PROCESS=null,l},s.initQuotesByPage=function(t){$(".js-quote-mini > * > .js-quote-content",t).each(function(){if(!(this.offsetHeight<160)){var t=this.parentNode.parentNode,i=!1;s.flagContains(t,s.F_QUOTE.LEVEL_LAST)?(i=!0,s.quoteExpandToggle(t,!1)):s.flagContains(t,s.F_QUOTE.LEVEL_FIRST)?e.DOM.classAdd(t,"b-quote_minimized","b-quote_minimized_first"):e.DOM.classAdd(t,"b-quote_minimized","b-quote_minimized_center"),i||setTimeout(function(){this.scrollTop=this.scrollHeight
}.bind(this),50)}})},s._expandSmallQuotes=function(t){e.DOM.classContains(t,"b-quote_expanded")||$.text(t).length>200||s.getQuotesByLevel(t).length||e.DOM.classAdd(t,"b-quote_expanded")}}(),function(e){var t=function(t,s){this._$main=e(t),this._onViewScrollBinded=e.proxy(this._onViewScroll,this),this._$blocks=this._$main.on("scroll.fixedscroll",_.debounce(this.recalc.bind(this),50)).find(s).on("scroll.fixedscroll",this._onViewScrollBinded),this.recalc()};t.prototype={addBlock:function(e){return this._$blocks=this._$blocks.add(e),e.on("scroll.fixedscroll",this._onViewScrollBinded),this
},destroy:function(){this._$main.off(".fixedscroll"),this._$blocks.off(".fixedscroll"),this._$scroller&&(this._$scroller.off(".fixedscroll").remove(),delete this._$scroller)},_getCustomScroller:function(t){return this._$scroller||t||(this._$scroller=e('<div class="jquery-fixedscroll" style="display: none;"><div class="jquery-fixedscroll__i"></div></div>').on("scroll.fixedscroll",e.proxy(this._onCustomScroll,this)).appendTo(this._$main)),this._$scroller},_onCustomScroll:function(e){this._curBlock&&(this._curBlock.scrollLeft=e.currentTarget.scrollLeft)
},_onViewScroll:function(e){var t=e.currentTarget;this._curBlock&&this._curBlock===t&&this._getCustomScroller().scrollLeft(t.scrollLeft)},recalc:function(){for(var t=0,s=this._$blocks.length;s>t;t++){var i=this._$blocks[t],n=i.scrollWidth,a=i.offsetWidth;if(n>a){var o=e(i),r=this._$main.offset(),l=this._$main[0].scrollTop,u=o.offset(),d=u.top-r.top+l,c=d+i.offsetHeight,h=l+this._$main[0].offsetHeight,g=d>=l&&h>=d,m=c>=l&&h>=c,p=l>=d&&c>=h;if((g||p)&&!m){this._setScroller(i);continue}}this._resetScroller(i)
}},_setScroller:function(e){if(e!=this._curBlock||e.offsetWidth!=this._curBlockWidth){var t=this._getCustomScroller();this._curBlock=e,this._curBlockWidth=e.offsetWidth,t.width(this._curBlockWidth),t.find(":first").width(e.scrollWidth),t.show(),t.scrollLeft(e.scrollLeft)}},_resetScroller:function(e){if(e==this._curBlock){var t=this._getCustomScroller(!0);t&&t.hide(),delete this._curBlockWidth,delete this._curBlock}}},e.fn.fixedScroll=function(e){return new t(this,e)}}(jQuery),function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)
}(function(e){function t(t){return e.isFunction(t)||"object"==typeof t?t:{top:t,left:t}}var s=e.scrollTo=function(t,s,i){return e(window).scrollTo(t,s,i)};return s.defaults={axis:"xy",duration:parseFloat(e.fn.jquery)>=1.3?0:1,limit:!0},s.window=function(){return e(window)._scrollable()},e.fn._scrollable=function(){return this.map(function(){var t=this,s=!t.nodeName||-1!=e.inArray(t.nodeName.toLowerCase(),["iframe","#document","html","body"]);if(!s)return t;var i=(t.contentWindow||t).document||t.ownerDocument||t;
return/webkit/i.test(navigator.userAgent)||"BackCompat"==i.compatMode?i.body:i.documentElement})},e.fn.scrollTo=function(i,n,a){return"object"==typeof n&&(a=n,n=0),"function"==typeof a&&(a={onAfter:a}),"max"==i&&(i=9e9),a=e.extend({},s.defaults,a),n=n||a.duration,a.queue=a.queue&&a.axis.length>1,a.queue&&(n/=2),a.offset=t(a.offset),a.over=t(a.over),this._scrollable().each(function(){function o(e){u.animate(c,n,a.easing,e&&function(){e.call(this,d,a)})}if(null!=i){var r,l=this,u=e(l),d=i,c={},h=u.is("html,body");
switch(typeof d){case"number":case"string":if(/^([+-]=?)?\d+(\.\d+)?(px|%)?$/.test(d)){d=t(d);break}if(d=h?e(d):e(d,this),!d.length)return;case"object":(d.is||d.style)&&(r=(d=e(d)).offset())}var g=e.isFunction(a.offset)&&a.offset(l,d)||a.offset;e.each(a.axis.split(""),function(e,t){var i="x"==t?"Left":"Top",n=i.toLowerCase(),m="scroll"+i,p=l[m],f=s.max(l,t);if(r)c[m]=r[n]+(h?0:p-u.offset()[n]),a.margin&&(c[m]-=parseInt(d.css("margin"+i))||0,c[m]-=parseInt(d.css("border"+i+"Width"))||0),c[m]+=g[n]||0,a.over[n]&&(c[m]+=d["x"==t?"width":"height"]()*a.over[n]);
else{var _=d[n];c[m]=_.slice&&"%"==_.slice(-1)?parseFloat(_)/100*f:_}a.limit&&/^\d+$/.test(c[m])&&(c[m]=c[m]<=0?0:Math.min(c[m],f)),!e&&a.queue&&(p!=c[m]&&o(a.onAfterFirst),delete c[m])}),o(a.onAfter)}}).end()},s.max=function(t,s){var i="x"==s?"Width":"Height",n="scroll"+i;if(!e(t).is("html,body"))return t[n]-e(t)[i.toLowerCase()]();var a="client"+i,o=t.ownerDocument.documentElement,r=t.ownerDocument.body;return Math.max(o[n],r[n])-Math.min(o[a],r[a])},s})}(Jane,Daria),ns.View.define("attached-message",{events:{"ns-view-show":"onShow","click .js-attachments-scroll":"scrollToAttachments"},models:{message:!1,"message-body":!1},params:{ids:null,hid:null,subj:null},yateModule:"message",methods:{onShow:function(){ns.events.trigger("daria:vApp:changeAppWidth")
},scrollToAttachments:function(){Jane.DOM.scrollIntoView(this.$node.find(".js-attachments-snippet")[0]),Jane.c("Аттачи в тексте письма","Клик")}}}),ns.View.define("attached-message-popup",{events:{"ns-view-destroyed":"_onDestroyed","wheel window":"onWheel"},params:{ids:null,hid:null,subj:null},yateModule:"message",ctor:function(){["_destroyContent","_onOpenedPopup","_onClosedPopup","_onDestroyedPopup","_onContentSetPopup"].forEach(function(e){this[e]=this[e].bind(this)},this),this._nbPopup=null,this._vContent=null,this._contentNode=null
},methods:{open:function(e){this._destroyContent();var t=this.getPopup();t.isOpen()?this._resetContentPopup():(this._show(),t.open(e))},close:function(){this.getPopup().close()},getPopup:function(){return this._nbPopup?this._nbPopup:(this._nbPopup=nb.find("attached-message-popup-"+this.params.ids+"-"+this.params.hid),this._nbPopup||(this._nbPopup=nb.block(ns.renderNode(this.params,"js-attached-message-popup","message"))),this._nbPopup.on("nb-opened",this._onOpenedPopup),this._nbPopup.on("nb-closed",this._onClosedPopup),this._nbPopup.on("nb-destroyed",this._onDestroyedPopup),this._nbPopup.on("nb-content-set",this._onContentSetPopup),this._nbPopup)
},_resetContentPopup:function(){this._contentNode=ns.renderNode({},"js-attached-message-popup-loader","message"),this.getPopup().setContent(this._contentNode)},_destroyContent:function(){this._vContent&&(this._vContent.destroy(),this._vContent=null),this._contentNode=null},_destroyPopup:function(){this._nbPopup&&(this._nbPopup.destroy(),this._nbPopup=null),this.hideAndUnbindEvents()},_onContentSetPopup:function(){this._vContent=ns.View.create("attached-message",this.params),this._vContent._setNode(this._contentNode),this._vContent.invalidate(),this._vContent.updateByLayout("attached-message-preview",this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){var e=this.getPopup().$node,t=e.find("._nb-popup-content");
if(Modernizr.ie10||Modernizr.ie11){var s=e.cssUnit("max-height"),i=e.find("._nb-popup-title"),n=s[0]-i.outerHeight();t.css("max-height",n+"px")}e.position({at:"center",of:window}),t.attr("tabindex","1").focus(),ns.events.trigger("daria:vApp:changeAppWidth")},this)},_onOpenedPopup:function(){this._resetContentPopup(),this.getPopup().node.widget.option("beforeClose",this._onClosedPopup.bind(this))},_onClosedPopup:function(){setTimeout(function(){this.trigger("closed"),this._destroyPopup()}.bind(this),0)
},_onDestroyedPopup:function(){this._destroyContent()},_onDestroyed:function(){this._destroyPopup()},getScrollContent:function(e){return $(e.target).parents("._nb-popup-content")[0]}}},"prevent-scroll-propagation-mixin",ns.View),ns.View.define("3pane-scroller",{events:{"ns-view-show":"onShow"},params:function(e){return{ids:e.thread_id||e.ids}},yateModule:"message",methods:{onShow:function(){this.$node.closest(".js-message-scroll-area").scrollTop(0)}}}),function(){ns.View.define("map",{models:{"map-data":!1},ctor:function(){this._map=null,this.initMap=this.initMap.bind(this),this.destroyMap=this.destroyMap.bind(this)
},events:{"ns-view-htmlinit":"onhtmlinit"},yateModule:"message",methods:{onhtmlinit:function(){this.$frame=this.$node.find(".js-mail-message-map-frame"),ns.events.on("daria:vMap:initMap",this.initMap),ns.events.on("daria:vMap:closeMap",this.destroyMap)},initMap:function(){var e=this;Daria.Libs("Ya.Maps",function(){ymaps.ready(function(){var t=e.getModel("map-data").getData(),s=t.addressLocation,i=15,n=new ymaps.Map(e.$frame.get(0),{center:[s.lat,s.lon],behaviors:["default","scrollZoom"],zoom:i,type:"yandex#map",controls:["zoomControl","geolocationControl"]},{copyrightLogoVisible:!1,copyrightProvidersVisible:!1,copyrightUaVisible:!1});
n.controls.add(new ymaps.control.RulerControl({options:{position:{bottom:10,right:10}}})),n.controls.add("trafficControl",{"float":"left",size:"small"});var a=new ymaps.Placemark([s.lat,s.lon],{},{preset:"islands#redDotIcon"});n.geoObjects.add(a),e._map=n})})},destroyMap:function(){this._map&&(ns.events.off("daria:vMap:initMap",this.initMap),ns.events.off("daria:vMap:closeMap",this.destroyMap),this._map.destroy(),this._map=null)}}})}(),ns.View.define("map-actions",{yateModule:"message",models:{"map-data":!1}}),function(){ns.View.define("map-up",{params:{ids:null,address:null},yateModule:"message",methods:{open:function(){var e=this,t=ns.layout.page("map-up",this.params);
return new ns.Update(this,t,this.params).render().then(function(){var t=Jane.tt("message:map-up"),s=nb.block(t);s.setContent(e.node),s.open({where:$("body").get(0),autoclose:!0,width:684,height:500});var i=function(e){e.keyCode===Jane.Common.keyCode.ESC&&(s.trigger("nb-closed"),e.preventDefault(),e.stopPropagation())},n=_.once(function(){window.removeEventListener("keydown",i,!0),_.defer(function(){ns.events.trigger("daria:vMap:closeMap"),s.destroy(),s=null})});s.on("nb-closed",n),window.addEventListener("keydown",i,!0),ns.events.trigger("daria:vMap:initMap"),Jane.c("Карты в письмах","Показ попапа с картой")
})}}})}(),ns.View.define("map-city-complaint",{models:{"message-body":!1,"map-data":!1},events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-destroyed":"_onNsViewDestroyed","click .js-next":"_onClickNext","click .js-prev":"_onClickPrev","submit@show .js-form":"_onClickSubmit"},ctor:function(){this.slides=[]},yateModule:"message",methods:{_onNsViewHtmlinit:function(){this.slides=[".js-slide1",".js-slide2",".js-slide3"].map(function(e){return this.$node.find(e)},this),_.defer(this._initMapCityComplaint.bind(this))
},_onNsViewDestroyed:function(){clearTimeout(this._errorTimeout);var e=nb.$block(".js-city",this.node);e&&nb.$block(".js-city",this.node).hideError(),this.slides=[]},_onClickNext:function(){this._animateSlide(1,!0),this._animateSlide(2,!1)},_onClickPrev:function(e){e.stopPropagation(),this._animateSlide(1,!1),this._animateSlide(2,!0)},_onClickSubmit:function(e){e&&e.preventDefault(),this._sendMapCityComplaint()&&this._closeMapCityComplaint()},_initMapCityComplaint:function(){var e=this,t=ns.Model.get("account-information");
(t.getDataKey("home")||t.hasSid(669))&&(e._getSlide(1).removeClass("js-init"),e._getSlide(2).css({bottom:-500}).each(function(){e._toggleSlide(2,!1,$(this))}).each(function(){var e=$(this);e.css({bottom:-1*e.outerHeight()})}).each(function(){e._toggleSlide(2,!0,$(this))}))},_getSlide:function(e){var t=$();return e>=1&&e<=this.slides.length&&(t=this.slides[e-1]),t},_toggleSlide:function(e,t,s){return s=s||this._getSlide(e),s.toggleClass("js-init",t)},_animateSlide:function(e,t,s){var i=this;return s=s||i._getSlide(e),t||(s=i._toggleSlide(e,t,s)),_.contains([1,3],e)?_.defer(function(){s=s.toggleClass("js-hide",t)
}):2===e&&(t&&nb.$block(".js-city",s).hideError().blur(),_.defer(function(){var e=t?-1*s.outerHeight():"";s.css({bottom:e})}),t||s.afterTransition(function(){nb.$block(".js-city",s).focus()})),t&&(s=s.afterTransition(function(){i._toggleSlide(e,t,s)})),s},_closeMapCityComplaint:function(){var e=this,t=Daria.timify({seconds:2});e._animateSlide(2,!0);var s=e._animateSlide(3,!1).afterTransition(function(){setTimeout(function(){e._animateSlide(3,!0,s)},t)})},_serializeMessage:function(e){return _(e).map(function(e,t){return[t,JSON.stringify(e)]
}).invoke("join",":\n").join("\n\n")},_sendMapCityComplaint:function(){var e=1e3,t=this._getSlide(2),s=nb.$block(".js-city",t),i=$.trim(s.getValue());if(!i.length)return clearTimeout(this._errorTimeout),s.showError().focus(),this._errorTimeout=setTimeout(function(){s.hideError().focus()},e),!1;var n={};n["Корректировка пользователя"]=i,n.Подчеркнули=this.params.address,n.Факты=this.getModel("message-body").get(".facts");var a={subj:"Неправильный город",send:this._serializeMessage(n)},o=t.find(".js-form");
return nb.$block(".js-attach",o).isChecked()&&(a.ign_overwrite="yes",a.ids=this.params.ids),Daria.SendMail.sendForm({$form:o,params:a}),!0}}}),ns.View.edefine("message",{models:{"account-information":!1,labels:!1,message:{"ns-model-changed":function(e,t){if(!this.isVisible())return void this.invalidate();var s=this.getModel("message");if(".lid"===t||".new"===t){var i;switch(i=this.$node.hasClass("b-message")?this.$node:this.$node.find(".b-message"),t){case".lid":i.toggleClass("b-message_important",s.isImportant());
break;case".new":var n=s.isNew();i.toggleClass("b-message_unread",n),i.toggleClass("is-unread",n),i.toggleClass("b-message_read",!n)}}}},"messages-checked":!1,"module-compose":!1,"module-message":!1,"scroller-message":!1,settings:!1,"state-message-thread-item":{"ns-model-changed":!1,"ns-model-changed.shouldBeInViewport":"placeInViewport","ns-model-destroyed":"keepValid"}},events:{"ns-view-init":"oninit","ns-view-show":"onshow","ns-view-touch":"ontouch","ns-view-hide":"onhide","ns-view-htmldestroy":"onhtmldestroy","daria:vMessage:message-body-loaded":function(){this.$node.addClass("b-message_loaded"),nb.init(this.node),this._initAttachments()
},"daria:vToolbarButton:label":"_onLabelToolbarButton","daria:vToolbarButton:unlabel":"_onUnlabelToolbarButton","daria:vToolbarButton:mark":"_onToolbarButton","daria:vToolbarButton:unmark":"_onUnmarkToolbarButton","daria:vToolbarButton:move":"_onMoveToolbarButton","daria:vToolbarButton:remove":"_onRemoveToolbarButton","daria:vToolbarButton:tospam":"_onTospamToolbarButton","daria:vToolbarButton:notspam":"_onNotspamToolbarButton","daria:vToolbarButton:archive":"_onArchiveToolbarButton","daria:vToolbarButton:infolder":"_onInfolderToolbarButton","daria:vToolbarButton:unsubscribe":"_onToolbarButton","daria:vToolbarButton:reply":"_onReplyToolbarButton","daria:vToolbarButton:reply-all":"_onReplyAllToolbarButton","daria:vToolbarButton:reply-tmpl":"_replyHelper","daria:vToolbarButton:sendon":"_replyHelper","dragndrop.drop@show":"_onDrop","hotkeys.print":"print","hotkeys.alignOpenMessage":"onAlignOpenMessage","daria:folder-remove-done@show":"_onFolderRemove","daria:MOPS:action-complete@show":"_onActionComplete","click .js-attachments-scroll":"scrollToAttachments","click .js-message-close-button":"onCloseMessage","daria:vScrollerMessage:scroll@show":"onScroll","daria:layout-changed@show":"onScroll","folder.cleared@show":"onFolderCleared","resize@show window":"onResizeDebounce"},yateModule:"message",ctor:function(){this.onResizeDebounce=_.debounce(this.onResize.bind(this),50,{maxWait:50}),this._fixedToolbar=_.throttle(this._fixedToolbar.bind(this),20,{trailing:!0,leading:!0})
},methods:{oninit:function(){this.mMessagesChecked=ns.Model.get("messages-checked",{mid:this.params.ids}),this.mMessagesChecked.on("run-action",this._runAction.bind(this))},onshow:function(){this.onResize(),this.placeInViewport();var e=this.params;ns.events.trigger("user.action.log",{action:"show",eventObject:{params:e,ids:{ids:[e.ids],mids:[e.ids]}}});var t=this.getModel("message");this.mMessagesChecked.check(t,!0),Daria.isMessagePage()?Jane.c({"Просмотр письма":"Показ Письма на отдельной странице"}):Jane.c("Просмотр письма",Daria.Metric.getPath(t),Daria.is2pane()?"2pane":"3pane","Показ Письма в списке писем (одиночное письмо, из треда)"),this.writeToUserJournal("startReading"),Daria.is3pane()&&Daria.lom.save(ns.page.current.params),Daria.setZeroTimeout(function(){ns.events.trigger("quick-reply:open-last-draft")
}),ns.events.trigger("search.blur-input"),Daria.isMessagePage()||this.getModel("scroller-message").init()},onScroll:function(){this._fixedToolbar()},ontouch:function(){this._reSetMessagesChecked()},_reSetMessagesChecked:function(){this.mMessagesChecked.touch()},onhide:function(){this.mMessagesChecked.check(this.getModel("message"),!1,{silent:!0}),this._fixedToolbar.cancel()},scrollToAttachments:function(){var e=this.getModel("scroller-message"),t=e.getScrollOffset(),s=Daria.is2pane()?this.$node.offset().top:this.node.offsetTop;
e.setScrollTop(s-t,!0),Jane.c("Аттачи в тексте письма","Клик")},getMessageBodyBlock:function(){return this.getBlockByName("message-body-box").getActive()},getMessageBlock:function(){return this},onhtmldestroy:function(){$(window).off(".b-message")},_initAttachments:function(){var e=this.$node.find("#message-attachments-"+this.params.ids);if(e.length){var t=this.$node,s=t.find(".b-message-head"),i=this.attachments={blocks:{head:s.find(".b-message-head__field_attachments-expand"),body:e},shrinked:{head:!1,body:!1},view:{head:null,body:null}};
this.attachments.buttons={head:s.find(".js-attachments-view"),body:i.blocks.body.find(".js-attachments-view")};var n="b-mail-button_";t.find(".b-file__actions").each(function(){var e=$(".b-mail-button_light",this);e.length>1&&(e.eq(0).addClass(n+"first"),e.slice(1,-1).addClass(n+"middle"),e.eq(-1).addClass(n+"last"))}),$.each(i.blocks,function(e,t){t.find(".js-attachments-view-btn").attr("data-params",function(t,s){return(s?s+"&":"")+"metrika=attach:"+e+":viewfile"}).end().find(".js-attachments-get-btn").attr("data-params",function(t,s){return(s?s+"&":"")+"metrika=attach:"+e+":loadfile"
})}),i.blocks.head.length||(Jane.c("attach","onefile","show"),s.find(".js-attachments-view-btn").attr("data-params","metrika=attach:head:viewone").end().find(".js-attachments-get-btn").attr("data-params","metrika=attach:head:loadone"))}},_onMoveMopsFulfilled:function(){ns.events.trigger("daria:vToolbarButton:loader:end"),this.invalidate()},_moveHelper:function(e,t){t=t||{};var s=_.last(e.split(":")),i=_.clone(t);i=_.extend({ids:this.mMessagesChecked.getIds()},i),$(document).trigger("b-mail-dropdown-closeall");
var n=Daria.messages.whereToGoAfterMove(s,this.mMessagesChecked,i);return Daria.MOPS[s](this.mMessagesChecked,_.extend(t,n)).then(function(){this._onMoveMopsFulfilled()},this)},_onArchiveToolbarButton:function(e,t){return this._moveHelper("archive",t)},_onMoveToolbarButton:function(e,t){return this._moveHelper("move",t)},_onInfolderToolbarButton:function(e,t){return this._moveHelper("infolder",t)},_onRemoveToolbarButton:function(){return this._moveHelper("remove")},_onTospamToolbarButton:function(){return this._moveHelper("tospam")
},_onNotspamToolbarButton:function(){return this._moveHelper("notspam")},_onMarkToolbarButton:function(e,t){return this._onToolbarButton("mark",t)},_onUnmarkToolbarButton:function(e,t){return this._onToolbarButton("unmark",t)},_onLabelToolbarButton:function(){var e=["daria:vToolbarButton:label"];return Array.prototype.push.apply(e,Array.prototype.slice.call(arguments,1)),this._onToolbarButton.apply(this,e)},_onUnlabelToolbarButton:function(){var e=["daria:vToolbarButton:unlabel"];return Array.prototype.push.apply(e,Array.prototype.slice.call(arguments,1)),this._onToolbarButton.apply(this,e)
},_onReplyToolbarButton:function(e,t){return this._replyHelper("reply",t)},_onToolbarButton:function(e,t){if(t=t||{},t._viewKey&&t._viewKey!==this.key)return Vow.reject();var s=this,i=_.last(e.split(":"));$(document).trigger("b-mail-dropdown-closeall");var n,a=["label","mark","unlabel"];return n=-1===a.indexOf(i),Daria.MOPS.updateHelper(i,this.mMessagesChecked,t).then(function(){if(ns.events.trigger("daria:vToolbarButton:loader:end"),"unmark"===i&&!Daria.is3pane()||"unsubscribe"===i){var e=s.getModel("message").getFolderId();
ns.page.go(ns.router.generateUrl("messages",{current_folder:e}))}else n&&s.update(ns.page.current.params)})},getMessagesCheckedInstance:function(){return this.mMessagesChecked},_onCloseDropdown:function(){$(".js-message-toolbar-dropdown",this.node).filter(function(){return nb.block(this).isOpen()}).each(function(){nb.block(this).close()})},markUnread:function(){this._onToolbarButton("daria:vToolbarButton:mark")},_runAction:function(e,t){if(this.isVisible()){var s="_on"+Daria.capitalize(t.action)+"ToolbarButton";
_.isFunction(this[s])&&this[s](e,t.params)}},_onFolderRemove:function(e,t){var s=this.getModel("message"),i=this.getModel("message").getFolderId();i===t&&s.invalidate()},placeInViewport:function(){this.getModel("state-message-thread-item").get(".shouldBeInViewport")&&Jane.DOM.placeInViewport(this.node)},_onActionComplete:function(e,t){var s,i=Daria.isMessagePage()&&Daria.is2pane()||_.has(t,".whereToGo.updateRequired");switch(t.action){case"delete":case"unmark":case"move":case"tospam":case"notspam":"delete"===t.action&&this.invalidate(),i&&(s=_.get(t,".whereToGo.where"),s||(s=Daria.messages.whereToGoAfterMove(t.action,this.mMessagesChecked,t).where),_.delay(ns.page.go,50,s))
}},onAlignOpenMessage:function(e,t){ns.page.current.params.ids===this.params.ids&&t.scroller.scrollIntoView(this.node,t.alignOptions)},getFocusableChildren:function(){return[this]},onFocusEvent:function(e){switch(e.type){case"focus":this.focusOn();break;case"blur":this.focusOff();break;case"enter":ns.page.go(Jane.Page.generateUrl.closeMessage());break;case"print":this.print()}},print:function(){Daria.Printer.printMessage(this.params.ids)},toggleCheck:function(){var e=this.getModel("message"),t=this.getModel("messages-checked");
t.toggleCheck(e)},focusOn:function(){"message"!==ns.page.current.page&&this.$node.addClass("is-focused")},focusOff:function(){this.$node.removeClass("is-focused")},onCloseMessage:function(){ns.page.go("#inbox")},isOpen:function(){var e=ns.page.current.params;return!(!e.thread_id&&!e.ids)},onFolderCleared:function(e,t){this.isOpen()&&this.getModel("message").getFolderId()===t&&ns.page.go(ns.router.generateUrl("messages",{current_folder:t}))},onResize:function(){Daria.isMessagePage()&&this.$node.toggleClass("mail-Message_wide",this.$node.width()<1e3)
}}},"message-dimensions-mixin","fixed-message-toolbar-mixin","journal-log-mixin","message-actions"),ns.View.define("message-body",{models:{settings:{"ns-model-changed":!1,"ns-model-changed.use_monospace_in_text":"forceUpdate"},message:!1,"message-body":{"ns-model-changed":!1,"daria:vMessageWidgetTranslate:translate":"_onMessageWidgetTranslateTranslate","daria:vMessageWidgetTranslate:revert":"_onMessageWidgetTranslateRevert"}},ctor:function(){this.anyLocationsHighlighted=!1,this.fireResizeBodyDebounce=_.debounce(this.fireResizeBody.bind(this),50)
},events:{"ns-view-async":"_onNsViewAsync","ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-show":"_onNsViewShow","ns-view-hide":"_onNsViewHide","ns-view-htmldestroy":"_onNsViewHtmldestroy","daria:vThreadSidebarBox:flight@show":"onThreadSidebarFlight","daria:vMessageWidgetSpam:showContent@show":"_onMessageWidgetSpamShowContent","click .daria-goto-anchor":"changeLinkHref","mousedown@show .daria-goto-anchor":"changeLinkHref","mousemove@show .daria-goto-anchor":"resetLinkHref","mouseleave@show .daria-goto-anchor":"resetLinkHref","daria:vMessageBody:showLocations@show":"showLocations","messages-thread.open-body":"onMessagesThreadOpenBody","click .js-attachments-switch-view":"onSwitchAttachmentsView","click .js-extracted-highlighted-address":"_onClickExtractedAddress","click .js-message-audio-play":"_onClickMessageAudioPlay","click .js-quote-expand":Daria.MessageProcess.Actions.quoteExpand,"click .js-quote-expand-all":Daria.MessageProcess.Actions.quoteExpandAll,"click .js-quote-maximize":Daria.MessageProcess.Actions.quoteMaximize,"click .js-quote-expand-toggle":Daria.MessageProcess.Actions.quoteExpandToggle,"click .js-mail-Quote-Toggler":"toggleQuote",'click [mailcollectorson="1"]':"collectorsRambler","resize@show window":"fireResizeBodyDebounce"},yateModule:"message",methods:{BODY_LOADING_TIMEOUT:200,MESSAGE_HEAD_HEIGHT:51,MESSAGE_TOOLBAR_HEIGHT:28,MAIL_TOOLBAR_HEIGHT:59,CLASS_MESSAGE_SCROLL_AREA:"js-message-scroll-area",_timerOpenLoader:0,_onNsViewAsync:function(){var e=this.$node;
this._timerOpenLoader=setTimeout(function(){e.find(".js-body-loading").removeClass("g-hidden")},this.BODY_LOADING_TIMEOUT)},_onNsViewHtmlinit:function(e,t){clearTimeout(this._timerOpenLoader),this._timerOpenLoader=null;var s=this.getModel("message-body").getHTML(_.extend({},t,{forceShowImages:this.forceShowImages,forceShowHrefs:this.forceShowHrefs}));this.$node.append(s),ns.events.trigger("daria:vMessage:message-body-loaded");var i=this.$node.find("#message-attachments-"+t.ids);if(i.length){var n=this.$node.closest(".b-message"),a=n.find(".b-message-head"),o=this.attachments={blocks:{head:a.find(".b-message-head__field_attachments-expand"),body:i},shrinked:{head:!1,body:!1},view:{head:null,body:null}};
this.attachments.buttons={head:a.find(".js-attachments-view"),body:o.blocks.body.find(".js-attachments-view")};var r="b-mail-button_";this.$node.find(".b-file__actions").each(function(){var e=$(".b-mail-button_light",this);e.length>1&&(e.eq(0).addClass(r+"first"),e.slice(1,-1).addClass(r+"middle"),e.eq(-1).addClass(r+"last"))}),$.each(o.blocks,function(e,t){t.find(".js-attachments-view-btn").attr("data-params",function(t,s){return(s?s+"&":"")+"metrika=attach:"+e+":viewfile"}),t.find(".js-attachments-get-btn").attr("data-params",function(t,s){return(s?s+"&":"")+"metrika=attach:"+e+":loadfile"
})}),o.blocks.head.length||(Jane.c("attach","onefile","show"),a.find(".js-attachments-view-btn").attr("data-params","metrika=attach:head:viewone"),a.find(".js-attachments-get-btn").attr("data-params","metrika=attach:head:loadone"))}Daria.MessageProcess.initQuotesByPage(this.node),this.waitForImages(t),this._timerColumnSizeRecalculate=setTimeout(function(){this._timerColumnSizeRecalculate=null,s[0]&&this.getModel("message-body").getAttachments().length&&this.$node.closest(".js-message-wrap").find(".js-attachments-snippet").length&&Daria.MessageProcess.attachmentsSelect(s[0]),ns.events.trigger("daria:vMessageThreadList:checkVisible"),this.fireResizeBodyDebounce()
}.bind(this),300),this.showLocations()},initFixedScroll:function(){this._fixedScroll=this.$node.closest(".js-message-scroll-area").fixedScroll(this.$node),this._fixedScrollRecalc=_.debounce(this._fixedScroll.recalc.bind(this._fixedScroll),50),this.__bindFixedScrollEvents()},destroyFixedScroll:function(){this.__unbindFixedScrollEvents(),this._fixedScroll&&(this._fixedScroll.destroy(),this._fixedScroll=null,delete this._fixedScrollRecalc)},changeLinkHref:function(e){var t=e.currentTarget,s=t.getAttribute("data-vdir-href");
s&&t.href!==s&&("click"===e.type||2===e.which||e.ctrlKey)&&(t.href=s);var i=t.href.replace(/^[^#]*(.*)$/,"$1");if(i){var n=this.$node.find(i+', a[name="'+i.substr(1)+'"]')[0];if(n){var a=Daria.isMessagePage()?this.MAIL_TOOLBAR_HEIGHT:this.MESSAGE_HEAD_HEIGHT+this.MESSAGE_TOOLBAR_HEIGHT,o=Daria.isMessagePage()?window:this.$node.closest("."+this.CLASS_MESSAGE_SCROLL_AREA)[0];return Jane.DOM.placeInViewport(n,{top:a},{nodePositionBelow:"top",nodePositionAbove:"top"},o),!1}}return!0},resetLinkHref:function(e){var t=e.currentTarget,s=t.getAttribute("data-orig-href");
s&&t.href!==s&&(t.href=s)},collectorsRambler:function(){var e=this.getModel("message").type;return-1!==e.indexOf(12)?(Daria.openCollectorPopup({from:"buttondirect",form:"yes"}),!1):void 0},waitForImages:function(){var e=this.$node.find("img"),t=0,s=[],i=this;e.each(function(){s.push($.Deferred())}),e.one("load",function(){s[t++].resolve()}).one("error",function(){s[t++].reject();var e=this.src;e&&e.indexOf("cache.mail.yandex.net")>-1&&Jane.ErrorLog.send({event:"imgNotLoaded",src:e})}),$.when.apply($,s).then(function(){i.fireResizeBodyDebounce()
})},__bindFixedScrollEvents:function(){!this._eventsBinded&&this._fixedScroll&&(this._eventsBinded=!0,$(window).on("resize.b-message-body",this._fixedScrollRecalc),ns.events.on("layout-ratio-change",this._fixedScrollRecalc))},__unbindFixedScrollEvents:function(){this._eventsBinded&&this._fixedScroll&&(this._eventsBinded=!1,$(window).off(".b-message-body"),ns.events.off("layout-ratio-change",this._fixedScrollRecalc))},_onNsViewShow:function(e,t,s){this.logTimings(s);try{this.sendOpenPGPEvent()}catch(i){Jane.ErrorLog.sendException("Daria.vMessageBody.sendOpenPGPEvent",i)
}var n=this;this.attachments&&(Jane.c("attach","show"),this.switchAttachmentsViewEverywhere()),this.initFixedScroll();var a=this.getModel("message");if(Daria.is2pane()&&!a.hasLabelWithSymbolicName("seen_label")&&a.hasLabelWithSymbolicName("postmaster_label")){var o=_.debounce(function(){this.postmaster.scroll<window.scrollY&&(this.postmaster.scroll=window.scrollY)}.bind(this),50);$(window).on("scroll",o),this.postmaster={time:$.now(),scroll:window.scrollY,unload:function(){$(window).off("scroll",o),ns.events.off("ns-page-before-load",n.postmaster.unload);
var e=n.$node;if(e){var t=e.offset().top,s=e.height(),i=n.postmaster.scroll-t+$(window).height(),a=i>s?100:Math.floor(i/s*100);a=a||0;var r=$.now()-n.postmaster.time;ns.forcedRequest(["do-postmaster"],{time:(n.getModel("message-body").get(".info.date.timestamp")||0)/1e3,readTime:Math.floor(r/1e3),perc:a,mid:n.params.ids,from:n.getModel("message").getFromEmail(),yandexuid:Daria.getCookie("yandexuid")})}}},ns.events.on("ns-page-before-load",this.postmaster.unload)}this.anyLocationsHighlighted&&Jane.c("Карты в письмах","Открыто писем с подсвеченным адресом"),this.fireResizeBodyDebounce()
},_onNsViewHide:function(){this._timerOpenLoader&&(clearTimeout(this._timerOpenLoader),this._timerOpenLoader=null),this._timerColumnSizeRecalculate&&(clearTimeout(this._timerColumnSizeRecalculate),this._timerColumnSizeRecalculate=null),this.fireResizeBodyDebounce.cancel(),this._onMessageWidgetTranslateRevert(),this._onMessageWidgetTranslateResetVisibility(),Daria.message.audioPlayer.reset(),this.destroyFixedScroll(),this.sendHidePGPEvent()},_onNsViewHtmldestroy:function(){$("#att-buttons").appendTo($(".b-layout")).addClass("g-hidden")
},onSwitchAttachmentsView:function(e){var t=e.currentTarget.getAttribute("data-where"),s=e.currentTarget.getAttribute("data-view");this.switchAttachmentsView(t,s),Jane.c("attach",t,s+"view")},onMessagesThreadOpenBody:function(){this.switchAttachmentsViewEverywhere()},switchAttachmentsViewEverywhere:function(){$.each(["head","body"],function(e,t){this.switchAttachmentsView(t)}.bind(this))},switchAttachmentsView:function(e,t){var s=this.attachments;if(s&&s.view[e]!==t){var i=s.buttons[e],n=s.blocks[e],a="attach-"+e+"-view",o=["icons","list"];
t=t||Daria.getCookie(a),-1===$.inArray(t,o)&&(t=o[0]),s.view[e]=t,$.each(o,function(e,s){var a=t===s;i.find(".js-attachments-"+s).toggleClass("b-mail-button_light-selected",a);var o=n.find(".js-attachments-"+s+"-view").toggleClass("g-hidden",!a);a||o.find("object").attr("id",function(e,t){Daria.message.audioPlayer.playerAction(t,"close")})}),t===o[0]&&this.shrinkAttachmentsNames(e),Daria.setCookie(a,t,90)}"body"===e&&this.$node.find(".b-file__pic:visible").length&&Jane.c("Просмотрщик картинок","Показ превью")
},shrinkAttachmentsNames:function(e){var t=this.attachments.shrinked;if(!t[e]){var s=this.attachments.blocks[e].find(".js-attachments-icons-view");s.is(":visible")&&(t[e]=!0,s.find(".b-shrinker").each(function(){var e=$(this),t=e.find(".b-shrinker__right").width();e.css("margin-right",t)}))}},_onMessageWidgetSpamShowContent:function(){this.forceShowImages=!0,this.forceShowHrefs=!0,this.invalidate(),this.update({is_spam:!1}).then(function(){Jane.c("Сообщение о непоказе картинок и ссылок в спаме","Клик по Включить")
})},sendOpenPGPEvent:function(){var e=this.getModel("message-body"),t=this.params.ids;e.hasPGP()&&e.getPGP().then(function(e){window.postMessage({mid:t,data:e,type:"PGP_MESSAGE_SHOWN"},"*")})},sendHidePGPEvent:function(){window.postMessage({mid:this.params.ids,type:"PGP_MESSAGE_HIDDEN"},"*")},parseLocations:function(e,t){return _.map(e.find(".js-extracted-address").get(),function(e){var s=new Daria.message.Location($(e));return s.findParsedMetadata(t),s})},showLocations:function(){var e=this,t=this.$node,s=this.getModel("message-body").getLocations(),i=this.parseLocations(t,s),n=i.map(function(e){return{id:"map-data",params:{address:e.getAddress()}}
}),a=this.getModel("message-body").getInvalidLocations(),o=s.concat(a),r=function(e){return e.geo&&e.geo.city},l=function(e){return e.addr&&e.addr.street},u=function(e,t){var s=_.filter(i,function(e){return t(e)}).length;s&&Jane.c("Карты в письмах","Города",e,s)};_.find(o,function(e){return r(e)&&!l(e)})&&Jane.c("Карты в письмах","Города","адреса, в которых город указан отдельно от улицы",_.filter(o,function(e){return!r(e)&&l(e)}).length),n.length>0?(Daria.Libs("Ya.Maps"),ns.request(n).then(function(){i.forEach(function(e){e.highlight()
});var t=_.filter(i,function(e){return e.isHighlighted()}).length;Jane.c("Карты в письмах","Адреса","подсветили "+t,"томита прислала валидных "+s.length),u("Адреса с городом",function(e){return e.hasCity()}),u("Адреса, в которых есть улица, но не указан город",function(e){return e.hasStreet()&&!e.hasCity()}),u("Адреса, в которых есть улица, но не указан город, и они находятся в городе пользователя",function(e){return e.hasStreet()&&!e.hasCity()&&e.inUserArea()}),t>0&&(e.anyLocationsHighlighted=!0,Jane.c("Карты в письмах","Открыто писем с подсвеченным адресом"))
})):s.length>0&&Jane.c("Карты в письмах","Адреса","подсветили 0","томита прислала валидных "+s.length)},_onClickMessageAudioPlay:function(e){Daria.message.audioPlayer.init(e),e.preventDefault()},_onClickExtractedAddress:function(e){var t=$(e.currentTarget),s=t.data("address"),i=t.data("ids");if(s&&i){var n=ns.View.create("map-up",{address:s,ids:i});n.open()}},_onMessageWidgetTranslateTranslate:function(e,t){var s=this.$node.html(),i=this.getModel("message").getSubject(),n=Date.now(),a=this,o=this.getModel("message-body");
o.trigger("daria:vMessageBody:startTranslate"),Daria.Translate.translate(t.langFrom,t.langTo,[{text:i,format:"text"},{text:s,format:"html"}]).then(function(e){var r=a.params.ids;Jane.ErrorLog.send({event:"translate",duration:(Date.now()-n)/1e3,langs:t.langFrom+"-"+t.langTo,mid:r}),ns.events.trigger("daria:vMessageBody:setSubject",e[0]),a.$node.html(e[1]),Daria.Translate.getCache(r)||Daria.Translate.setCache(r,[i,s]),o.trigger("daria:vMessageBody:stopTranslate",!0)},function(){Daria.Dialog.notice({body:'Не удалось перевести письмо. Попробуйте ещё раз, а если ошибка повторяется, сообщите об этом в <a href="http://feedback.yandex.ru/?from=mail" target="_blank">службу поддержки</a>.',width:350}),Jane.ErrorLog.send({errorType:"translateError",mid:a.params.ids}),Jane.c(71105,"msg.click.error"),o.trigger("daria:vMessageBody:stopTranslate",!1)
}),Jane.c(71105,"msg.click.go")},_onMessageWidgetTranslateRevert:function(){var e=Daria.Translate.getCache(this.params.ids);e&&(ns.events.trigger("daria:vMessageBody:setSubject",e[0]),this.$node.html(e[1]),Daria.Translate.clearCache(this.params.ids)),Jane.c(71105,"msg.click.cancel"),this.getModel("message-body").trigger("daria:vMessageBody:revertTranslate")},_onMessageWidgetTranslateResetVisibility:function(){this.getModel("message-body").trigger("daria:vMessageBody:resetTranslateWidgetVisibility")
},toggleQuote:function(e){Daria.MessageProcess.Actions.toggleQuote(e)},fireResizeBody:function(){if(this.node&&this.node.firstChild){var e=this.node.firstChild,t={scrollWidth:e.scrollWidth,clientWidth:e.clientWidth};ns.Model.get("thread-sidebar-state").set(".body",t),ns.events.trigger("message-body-full-load",this.$node.width())}},onThreadSidebarFlight:function(e,t){this.$node.children().css("margin-right",t||"")}}}),ns.View.define("message-close-button",{yateModule:"message"}),ns.View.define("message-head-date-eml",{models:{"message-body":{"ns-model-changed":!1,"ns-model-changed.info.date.view":"updateSelf"}},yateModule:"message",methods:{updateSelf:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})
}}}),ns.View.define("message-head-date",{models:{message:{"ns-model-changed":!1,"ns-model-changed.date.view":"forceUpdate"}},yateModule:"message"}),ns.View.define("message-headline",{events:{"ns-view-touch":"_onTouch"},yateModule:"message",methods:{checkShow:function(){return!!Daria.getPrevPageSearchContext()},_onTouch:function(){var e=Daria.getPrevPageSearchContext(),t="";e&&(e.request&&(t+='Письмо найдено по&#160;запросу <a href="'+e.url+'" class="b-message-headline__query">«<span class="b-message-headline__query__i">'+_.escape(e.request)+"</span>»</a>. "),t+='<a href="'+e.url+'" class="b-message-headline__action">Вернуться к&#160;поиску</a>',this.$node.html(t))
}}}),ns.View.define("message-head-dkim",{params:{ids:null},models:{"message-body":!1},events:{click:"onClick"},yateModule:"message",methods:{onClick:function(e){e.preventDefault(),e.stopPropagation();var t=nb.find(this.key);t&&t.open({where:this.$node.find(".mail-Message-Sender-Dkim-Wrap"),how:{at:"bottom",my:"top"}})}}}),ns.View.define("message-head-eml",{events:{"click .js-mail-Message-Head-Recievers_more":"toggleMoreRecievers"},models:{message:!1,"message-head-state":!1,"message-body":!1},params:function(e){return e
},yateModule:"message",methods:{toggleMoreRecievers:function(){var e,t=this.$node.find(".js-mail-Message-Head-Recievers");e=t.hasClass("with-tooManyRecipients")?t.hasClass("is-folded"):this.getModel("message-head-state").toggleRecieversOpened(),t.toggleClass("is-folded",!e)}}}),ns.View.define("message-head-folder",{params:{ids:null},models:{message:{"ns-model-changed":"keepValid","ns-model-changed.fid":"forceUpdate"}},yateModule:"message",methods:{_viewCheckHide:function(){var e=ns.page.current.params||{},t=e.current_folder;
if(!t)return!0;var s=this.getModel("message").getFolderId();return s&&t!==s?!1:!0}}}),ns.View.define("message-head",{models:{folders:!1,settings:!1,"message-head-state":!1,message:!1},events:{"daria:vMessageBody:setSubject@show":"_onMessageBodySetSubject","click .js-toggle-message-head":"_onClickToggleMessageHead"},yateModule:"message",methods:{_viewSenderFolded:function(){return this.getModel("message-head-state").get(".sender-closed")},_onClickToggleMessageHead:function(){var e=this.getModel("message-head-state").toggleSenderOpened();
this.$node.toggleClass("is-folded",e)},_onMessageBodySetSubject:function(e,t){this.$node.find(".js-subject-content").text(t)},_onReadUnreadMessage:function(){var e=this.getModel("message");e.toggleMark()},_selfUpdate:function(){this.update()},onAttachesWidgetShow:function(){this.$node.addClass("mail-Message-Head_with-attachments")}}}),ns.View.define("message-head-labels",{models:{message:{"ns-model-changed":!1,"ns-model-changed.lid":"forceUpdate"}},yateModule:"message"}),ns.View.define("message-head-recipient-count",{events:{"ns-view-htmlinit":"_checkCorpMaillists",click:"toggleMoreRecievers"},models:{message:!1,"message-body":!1,"message-head-state":!1},yateModule:"message",methods:{toggleMoreRecievers:function(){this.getModel("message-head-state").toggleRecieversOpened()
},patchTree:function(){var e=this.super_.patchTree.call(this),t=this.getModel("message"),s=this.getModel("message-body"),i=s.isValid()?s:t;return e.isRecipient=i.isRecipient(),e},_maillistsCount:-1,getMaillistsCount:function(){return this._maillistsCount},_checkCorpMaillists:function(){if(-1===this._maillistsCount){var e=this.getModel("message-body"),t=_(e.getRecipients(!0,!0)).values().flatten().pluck("email").compact().uniq().value(),s=t.slice(0,35);ns.request("abook-contacts",{emails:s.join(",")});
var i=this;if(Daria.IS_CORP){var n=t.filter(Daria.email.isCorp),a=n.length;a&&ns.Model.get("get-maillists-static").getMaillists(n).then(function(e){i.setMaillists(e),i.forceUpdate()})}}},setMaillists:function(e){this._maillistsCount=e.length}}}),ns.View.define("message-head-recipient",{params:function(e){return e},models:{message:!1,"message-body":!1,"message-head-state":{"ns-model-changed":!1,"ns-model-changed.recievers-opened":"onRecieversOpenedToggled"},settings:!1},events:{"ns-view-show":"onViewShow","click .js-contact-actions-dropdown":"_onClickContactActionsDropdown","click .js-mail-Message-Head-Recievers_more":"toggleMoreRecievers"},yateModule:"message",methods:{onViewShow:function(){this.getModel("message-body").hasTooManyRecipients()&&this.getModel("message-head-state").setRecieversOpened(!1)
},toggleMoreRecievers:function(){this.getModel("message-head-state").toggleRecieversOpened()},onRecieversOpenedToggled:function(){var e=!this.getModel("message-head-state").getRecieversOpened();this.$node.toggleClass("is-folded",e)},_onClickContactActionsDropdown:function(e){var t=e.currentTarget,s=ns.parseQuery($(t).data("params"));Daria.ContactActions.openMessageMenu(t,s)}}}),ns.View.define("message-head-sender-info",{params:function(e){var t=ns.Model.get("message",{ids:e.ids}),s=t.getEmailInfoParams()||{};
return{email:s.email,ref:s.ref,ids:e.ids}},models:{message:!1,"email-info":!0,settings:!1},events:{"ns-view-htmlinit":"_onInit","click .js-social-button":"_onClickSocialButton","click .js-call-staff":"_onClickCallStaff"},yateModule:"message",methods:{CLASS_PHONE_DISABLED:"is-disabled",TIME_PHONE_DISABLED:5e3,_onInit:function(){this.$node.children().length&&this.$node.closest(".mail-Message-Head-Content").find(".js-toggle-message-head").addClass("mail-ui-HoverLink")},_onClickCallStaff:function(e){e.preventDefault(),e.stopPropagation();
var t=$(e.currentTarget);if(!t.hasClass(this.CLASS_PHONE_DISABLED)){var s=this.getModel("email-info").get(".staff.phones.work"),i=this;s&&((new Image).src="//staff.yandex-team.ru/api/call/"+encodeURIComponent(s)),t.addClass(this.CLASS_PHONE_DISABLED),_.delay(function(){t.removeClass(i.CLASS_PHONE_DISABLED)},this.TIME_PHONE_DISABLED)}},_onClickSocialButton:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target).closest(".nb-button"),s=t.data("value");if("enable-social"===s)this.getModel("settings").setSettingOn("show_socnet_avatars");
else{var i=t.find("a"),n=window.open(i.attr("href"),i.attr("target"));n&&n.focus()}}}}),ns.View.define("message-head-sender-name",{models:{message:!1},events:{click:"showPersonPopup"},yateModule:"message",methods:{showPersonPopup:function(){return this.vPopup&&this.vPopup.isValid()?(this.vPopup.close(),void(this.vPopup=null)):void Jane.Services.load("#contacts",function(){this.vPopup=ns.View.create("abook-person-popup");var e=this.getFieldFrom(),t=_.extend({email:e.email,ref:e.ref},this.params);ns.request("abook-contact",{email:t.email}).then(function(e){var s=e[0],i=s.get(".cid");
i&&(t.cid=i),this.vPopup.open(this.getPopupOptions(),t)},function(){this.vPopup.open(this.getPopupOptions(),t)},this),Daria.vAbook.Metrika.c("Карточка контакта","В Почте","показ карточки (клик на имейл)")}.bind(this))},getFieldFrom:function(){return this.getModel("message").getFieldsByType("from")[0]},getPopupOptions:function(){return Daria.is2pane()?{where:this.$node,how:{my:"left top",at:"left-52 top"}}:{where:$(window),how:{my:"center",at:"center"}}}}}),ns.View.define("message-head-sender-name-eml",{events:{click:"showPersonPopup"},models:{"message-body":!1},yateModule:"message",methods:{getFieldFrom:function(){return this.getModel("message-body").getFieldsByType("from")[0]
}}},"message-head-sender-name"),ns.View.define("message-head-sender-wrap",{models:{folders:!1,message:!1,settings:{"ns-model-changed":!1,"ns-model-changed.show_socnet_avatars":"forceUpdate"}},yateModule:"message",methods:{patchLayout:function(){return this._patchLayoutCheckSenderInfo()?"message-head-sender-info":"message-head-sender-empty"},_patchLayoutCheckSenderInfo:function(){var e=this.getModel("message");if(!e.isValid())return!1;if(e.hasSocialLabels())return!1;var t=this.getModel("folders");
if(t.isFolder(e.getFolderId(),["spam","trash"]))return!1;var s=this.getModel("settings");return s.isSet("show_avatars")&&e.getEmailInfoParams()?!0:!1}}}),ns.View.edefine("message-head-subject-eml",{events:{"daria:vApp:changeAppWidth@show":"onShow","click .js-toggle-title":"_onClickToggleTitle"},models:{message:!1},params:function(e){return e},yateModule:"message",methods:{onShow:function(){this._toggleTitleToggler()},CLASS_LONG_TITLE:"mail-Message-Toolbar_longTitle",_onClickToggleTitle:function(){return this.$node.find(".js-thread-toolbar").toggleClass("is-folded"),!1
},_toggleTitleToggler:function(){var e=this.$node,t=e.find(".js-thread-toolbar");if(t.hasClass("is-folded")){var s=e.find(".js-toolbar-subject")[0],i=s.scrollWidth,n=!i||s.offsetWidth>=i-1;n&&t.addClass("is-folded"),t.toggleClass(this.CLASS_LONG_TITLE,!n)}}}}),ns.View.edefine("message-head-subject",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmlinit":"onInit","resize@show window":"_toggleTitleTogglerLazy","mouseenter .js-toolbar-subject":"onHoverSubjectOn","mouseleave .js-toolbar-subject":"onHoverSubjectOff"},ctor:function(){this._toggleTitleTogglerLazy=_.throttle(this._toggleTitleToggler.bind(this),20),this.recalculateHeaderFixedState=_.throttle(this.recalculateHeaderFixedState.bind(this),20,{trailing:!0,leading:!0})
},models:{message:{"ns-model-changed":!1,"ns-model-changed.subject":"invalidate","ns-model-changed.subject_prefix":"invalidate"},settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"lazyFixedRecalc","ns-model-changed.liza_minified_header":"lazyFixedRecalc"},"scroller-message":!1},yateModule:"message",methods:{CLASS_LONG_TITLE:"mail-Message-Toolbar_longTitle",onInit:function(){this._$toolbar=this.$node.find(".js-thread-toolbar"),this._$toolbarSubject=this.$node.find(".js-toolbar-subject")
},onHoverSubjectOn:function(){this.$node.find(".js-mail-Message-Toolbar").addClass("with-subject-hovered")},onHoverSubjectOff:function(){this.$node.find(".js-mail-Message-Toolbar").removeClass("with-subject-hovered")},_toggleTitleToggler:function(){var e=this.initialHeight||this._$toolbarSubject[0].offsetHeight,t=this._$toolbarSubject[0].scrollHeight<=e;t||this.initialHeight||(this.initialHeight=this._$toolbarSubject[0].offsetHeight),this._$toolbarSubject.css("max-height",t?"":this._$toolbarSubject[0].scrollHeight),this._$toolbar.toggleClass(this.CLASS_LONG_TITLE,!t)
},onShow:function(){var e=this.getModel("message").get(".mid");Daria.lom.isLastOpen(e)||this.onShowMarkAsRead(),this.fixedElementStart(),this._toggleTitleToggler()},onHide:function(){this.fixedElementStop(),this.recalculateHeaderFixedState.cancel(),this._toggleTitleTogglerLazy.cancel()},onShowMarkAsRead:function(){var e=this.getModel("message"),t=ns.Model.get("messages-checked",{mid:e.get(".mid")});t.check(e,!0),Daria.MOPS.updateHelper("mark",t,{})}}},"fixed-element-in-message-mixin"),ns.View.define("message-toolbar-fake",{params:{ids:null},yateModule:"message"}),ns.View.define("message-toolbar",{params:{ids:null},models:{"message-toolbar":!0,message:!1,settings:!1},events:{"ns-view-show":"onShow","click .js-toolbar-item-reply":"_onReplyToolbarButton","click .js-toolbar-item-reply-all":"_onReplyAllToolbarButton","click .js-toolbar-item-forward":"_onForwardToolbarButton","click .js-toolbar-item-delete":"_onRemoveToolbarButton","click .js-toolbar-item-spam":"_onTospamToolbarButton","click .js-toolbar-item-not-spam":"_onNotspamToolbarButton","click .js-toolbar-item-unsubscribe":"_onUnsubscribeToolbarButton","click .js-toolbar-item-archive":"_onArchiveToolbarButton","click .js-toolbar-item-draft-finish":"_onDraftFinishToolbarButton","click .js-toolbar-item-labels-actions":"_openLabelsDropdown","click .js-toolbar-item-folders-actions":"_openFoldersDropdown","click .js-toolbar-item-pin":"_onPinToolbarButton","click .js-toolbar-item-unpin":"_onUnpinToolbarButton","click .js-toolbar-item-more":"_onMoreToolbarButton","daria:vMessageToolbar:reply@show":"onReplyHotkey"},yateModule:"message",methods:{onShow:function(){ns.events.atrigger("daria:vMessageToolbar:toolbar-didRendered")
},_onReplyToolbarButton:function(){Jane.ToolbarMetric.messageToolbar("ответить"),this.showQuickReply(!1),this.closePopup()},_onReplyAllToolbarButton:function(){Jane.ToolbarMetric.messageToolbar("ответить всем"),this.showQuickReply(!0),this.closePopup()},_onDraftFinishToolbarButton:function(){ns.page.go(ns.router.generateUrl("compose2",{ids:this.params.ids}))},_onLabelToolbarButton:function(e,t){return this._onToolbarButton("label",t)},_onUnlabelToolbarButton:function(e,t){return this._onToolbarButton("unlabel",t)
},_onMoveToolbarButton:function(e,t){return this._onToolbarButton("move",t)},_onRemoveToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("удалить"),this._onToolbarButton("remove",{ignoreUnsavedDraft:!0})},_onTospamToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("спам"),this._onToolbarButton("tospam")},_onNotspamToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("не спам"),this._onToolbarButton("notspam")},_onUnsubscribeToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("отписаться"),this._onToolbarButton("unsubscribe")
},_onArchiveToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("архивировать"),this._onToolbarButton("archive")},_onPinToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("закрепить"),this._onToolbarButton("pin")},_onUnpinToolbarButton:function(){return Jane.ToolbarMetric.messageToolbar("открепить"),this._onToolbarButton("unpin")},onReplyHotkey:function(e,t){if("qr"===t.compose)this.showQuickReply(t.replyAll);else{var s=t.replyAll?"reply-all":"reply";this._replyHelper(s,{from:"message-toolbar"})
}},_onToolbarButton:function(e,t){t=t||{},Daria.DEBUG&&console.log(e),this.closePopup();var s=t.mMessagesChecked||this.getMessagesCheckedInstance();return Daria.MOPS[e](s,t)},getMessagesCheckedInstance:function(){return this._mMessagesChecked=ns.Model.get("messages-checked",{mid:this.params.ids}).checkByMidInParams(),this._mMessagesChecked},_openLabelsDropdown:function(e){var t=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,t,"label",this.getModel("message")),this._openDropdown("labels",e)
},_openFoldersDropdown:function(e){var t=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,t,"move",this.getModel("message")),this._openDropdown("folders",e)},_openDropdown:function(e,t){var s=$(t.currentTarget);if(!s.hasClass("js-open-dropdown")){var i=ns.View.create(e+"-actions"),n=ns.Model.get("messages-checked",{mid:this.params.ids}).checkByMidInParams();i.open(t.currentTarget,n,{isInDropdown:!0,isInMore:!0}).then(function(){s.addClass("js-open-dropdown"),i.nbPopup.on("nb-closed",function(){s.removeClass("js-open-dropdown")
})})}},_onMoreToolbarButton:function(e){return this.vPopup&&this.vPopup.isValid()?(this.vPopup.closePopup(),void(this.vPopup=null)):(this.vPopup=ns.View.create("message-toolbar-popup",this.params),void this.vPopup.open({where:e.currentTarget}))},closePopup:function(){this.vPopup&&this.vPopup.closePopup()}}},"message-actions"),ns.View.edefine("message-toolbar-popup",{params:{ids:null},models:{"message-toolbar":!0,"message-body":!0,message:!0},events:{"click .js-toolbar-item-reply":"_onReplyToolbarButton","click .js-toolbar-item-reply-all":"_onReplyAllToolbarButton","click .js-toolbar-item-forward":"_onForwardToolbarButton","click .js-toolbar-item-delete":"_onRemoveToolbarButton","click .js-toolbar-item-spam":"_onTospamToolbarButton","click .js-toolbar-item-not-spam":"_onNotspamToolbarButton","click .js-toolbar-item-unsubscribe":"_onUnsubscribeToolbarButton","click .js-toolbar-item-archive":"_onArchiveToolbarButton","click .js-toolbar-item-draft-finish":"_onDraftFinishToolbarButton","click .js-toolbar-item-labels-actions":"_openLabelsDropdown","click .js-toolbar-item-folders-actions":"_openFoldersDropdown","click .js-toolbar-item-pin":"_onPinToolbarButton","click .js-toolbar-item-unpin":"_onUnpinToolbarButton","click .js-toolbar-item-message-properties":"_onClickMessageProperties","click .js-toolbar-item-filters-create":"_onClickFiltersCreate","click .js-kbd-print":"_onPrintToolbarButton"},yateModule:"message",methods:{open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this)},closePopup:function(){this.nbPopup&&this.nbPopup.close()},_onClickMessageProperties:function(e){var t=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,t,"message-source",this.getModel("message")),this.closePopup()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},_onPrintToolbarButton:function(e){var t=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,t,"print",this.getModel("message"))
},_onClickFiltersCreate:function(e){var t=ns.action.getParams(e.currentTarget);Jane.ToolbarMetric.setToolbarMetrics(e,t,"filters-create",this.getModel("message"))}}},"message-toolbar"),ns.View.define("message-widget-common",{methods:{_onNsViewDestroyed:function(){this.getModel("message-widget-state").setViewUserClose(this.id)}}}),ns.View.define("message-widget-download-full",{params:{ids:null},models:{"message-body":!1,"message-widget-state":!1},events:{"ns-view-show":"_onNsViewShow","ns-view-destroyed":"_onNsViewDestroyed"},yateModule:"message",methods:{_onNsViewShow:function(){Jane.c("Скачать письмо целиком","показ"),Jane.ErrorLog.send({event:"message.trimmed",stid:this.getModel("message-body").get(".info.stid")})
}}},"message-widget-common"),ns.View.define("message-widget-ignore-thread",{params:{ids:null},models:{settings:!1,message:!1,"message-widget-state":!1},events:{"ns-view-show":"_onNsViewShow","ns-view-destroyed":"_onNsViewDestroyed","click .js-unignore":"_onClickUnignore"},yateModule:"message",methods:{_onNsViewShow:function(){Jane.c("Статуслайн игнорирования треда","Показ в письме")},_onClickUnignore:function(){var e=this.getModel("message").getThreadId();Daria.MOPS.unignore({tids:e}),this.destroy()
}}},"message-widget-common"),ns.View.define("message-widget-imap-deleted",{params:{ids:null},models:{settings:!1,"message-widget-state":!1},events:{"ns-view-destroyed":"_onNsViewDestroyed","click .js-close":"_onClickClose"},yateModule:"message",methods:{_onClickClose:function(){this.getModel("settings").setSettingOn("hide-imap-deleted"),this.destroy()}}},"message-widget-common"),ns.View.define("message-widget-noreply",{params:{ids:null},models:{message:!1,labels:!1,"message-widget-state":!1},events:{"ns-view-destroyed":"_onNsViewDestroyed","click .js-stop-waitreply":"_onClickStopWaitreply"},yateModule:"message",methods:{_onClickStopWaitreply:function(){var e=this.getModel("labels").getWaitingForReplyLabel(),t=e&&e.lid;
t&&ns.events.trigger("daria:vToolbarButton:unlabel",{lid:t}),this.destroy()}}},"message-widget-common"),ns.View.define("message-widget-translate",{params:{ids:null},models:{message:!1,"message-body":{"ns-model-changed":!1,"daria:vMessageBody:startTranslate":"onMessageBodyStartTranslate","daria:vMessageBody:stopTranslate":"onMessageBodyStopTranslate","daria:vMessageBody:revertTranslate":"onMessageBodyRevertTranslate","daria:vMessageBody:resetTranslateWidgetVisibility":"onMessageBodyResetWidgetVisibility"},"message-widget-state":!1,"translate-langs":!1},events:{"ns-view-show":"onShow","ns-view-destroyed":"_onNsViewDestroyed","click .js-open-translate-menu":"onClickOpenTranslateMenu","click .js-translate":"onClickTranslate","click .js-revert":"onClickRevert","click .js-close":"onClickClose"},yateModule:"message",ctor:function(){this._langTo=null,this._langFrom=null,this._isLoaded=!1,this._isTranslated=!1
},methods:{onShow:function(){Jane.c("Просмотр письма","Плашка переводчика",Daria.is2pane()?"2pane":"3pane","Показ")},getLangFromDefault:function(){return Daria.Translate.getLangByMid(this.params.ids)||Daria.Translate.defineLanguage(this.getModel("message-body").getComposeHTML())},getLangFrom:function(){return this._langFrom||this.getLangFromDefault()},getLangTo:function(){return this._langTo||Daria.Translate.getDefaultLangTo(this.getLangFrom())},isLoaded:function(){return this._isLoaded},isTranslated:function(){return this._isTranslated
},onClickOpenTranslateMenu:function(e){var t=this,s=ns.parseQuery($(e.currentTarget).data("params")),i=s.dir,n="_popupTranslateSelectLang_"+i,a=this[n];return a?void a.close():(a=ns.View.create("translate-select-lang",{currentLang:s.lang}),a.on("selected",function(e,s){this.close(),"to"===i?(t.getLangFrom()===s&&(t._langFrom=t.getLangTo()),t._langTo=s):(t.getLangTo()===s&&(t._langTo=t.getLangFrom()),t._langFrom=s),t.forceUpdate()}),a.on("closed",function(){delete t[n]}),a.open({where:e.currentTarget}),this[n]=a,void Jane.c(71105,"msg.click.select"+i))
},onClickTranslate:function(){this.getModel("message-body").trigger("daria:vMessageWidgetTranslate:translate",{langFrom:this.getLangFrom(),langTo:this.getLangTo()})},onClickRevert:function(){this.getModel("message-body").trigger("daria:vMessageWidgetTranslate:revert")},onMessageBodyStartTranslate:function(){this._isLoaded=!0,this.forceUpdate()},onMessageBodyStopTranslate:function(e,t){this._isTranslated=t,this._isLoaded=!1,this.forceUpdate()},onMessageBodyRevertTranslate:function(){this._isTranslated&&(this._isTranslated=!1,this._isLoaded=!1,this.forceUpdate())
},onMessageBodyResetWidgetVisibility:function(){this.getModel("message-widget-state").resetViewUserClose(this.id)},onClickClose:function(){Jane.c(71105,"msg.click.close"),this.getModel("message-widget-state").setViewUserClose(this.id)}}},"message-widget-common"),ns.View.define("message-widget-spam",{params:{ids:null},models:{message:!1,"message-body":!1,"message-widget-state":!1},events:{"ns-view-show":"_onNsViewShow","ns-view-destroyed":"_onNsViewDestroyed","click .js-show-content":"_onClickShowContent","click .js-delete":"_onClickDelete"},yateModule:"message",methods:{patchTree:function(){var e=this.super_.patchTree.call(this),t=this.getModel("message-body");
return e.isPhishing=this._checkPhishing(),e.hasImg=t.get(".has-img"),e.hasLinks=t.get(".has-links"),e},_checkPhishing:function(){return this.getModel("message-body").hasPhishingBody()},_onNsViewShow:function(){this._checkPhishing()&&Jane.c("Просмотр письма","показ плашки про фишинг")},_onClickDelete:function(){ns.events.trigger("daria:vToolbarButton:remove"),this.destroy()},_onClickShowContent:function(){ns.events.trigger("daria:vMessageWidgetSpam:showContent"),this.destroy()}}},"message-widget-common"),ns.ViewCollection.define("message-widget",{params:{ids:null},models:{message:!1,"message-body":!1,"message-widget-list":!1,"message-widget-state":{"ns-model-changed":!1,"ns-model-changed.show":"onChangeStateShow"}},events:{"ns-view-show":"onShow"},split:{byModel:"message-widget-list",intoViews:function(e){return e.get(".type")
}},yateModule:"message",methods:{onShow:function(){this.updateListOfWidgets()},onChangeStateShow:function(){this.updateListOfWidgets()},updateListOfWidgets:function(){var e=this.getModel("message-widget-list");e.clear(),Daria.MessageWidget.creatingListOfWidgets(e),_.defer(function(){this.isVisible()&&this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL})}.bind(this))}}}),ns.View.define("no-message",{events:{"ns-view-hide":"onhide","ns-view-show":"onshow","click .js-goto-inbox":"onClick"},yateModule:"message",methods:{onhide:function(){$(".ns-view-app").removeClass("g-hidden").append(this.node)
},onshow:function(){ns.Model.invalidate("message"),ns.Model.invalidate("messages"),ns.Model.invalidate("messages-item-state"),$(".ns-view-app").addClass("g-hidden").before(this.node),Jane.c({"Переход к недоступному письму":"Показ плашки"}),Jane.ErrorLog.send({errorType:"no_such_message",pageType:ns.page.current.page||"",pageReferref:Daria.Page.referer||"",params:Daria.Page.params2query(ns.page.current.params)})},onClick:function(){Jane.c({"Переход к недоступному письму":"клик по 'Вернуться в почту'"})
}}}),ns.View.define("message-fake-list",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy"},models:{message:!1},params:function(e){return{ids:e.thread_id||e.ids}},ctor:function(){this.forceUpdate=_.debounce(this.forceUpdate.bind(this),50)},yateModule:"message",methods:{onShow:function(){var e=this.getMessages();e.on("ns-model-insert",this.forceUpdate)},onHide:function(){var e=this.getMessages();e.off("ns-model-insert",this.forceUpdate)},onHtmlDestroy:function(){this.$node.children().each(this._childrenIterate)
},getMessages:function(){var e=this.getModel("message").getThreadId();return ns.Model.get("messages",{thread_id:e})},_childrenIterate:function(){this._nsView?this._nsView.destroy():$(this).remove()}}}),Daria.InfiniteViewCollection=function(){},no.inherit(Daria.InfiniteViewCollection,ns.ViewCollection,{fillList:function(){!this.__lockLoadMore&&this.canLoadMore()&&this.isVisible()&&(this.node.scrollHeight-this.node.offsetHeight>44||(this.__lockLoadMore=!0,_.method("loadMoreStart")(this),this.loadMore().then(function(){return this.update()
},this).then(function(){this.setFullyLoadedStateIfNeeded(),this.__lockLoadMore=!1,_.method("loadMoreStop")(this)},this).then(function(){_.delay(this.fillList.bind(this),50)},this)))},loadMoreByScrolling:_.debounce(function(){var e,t=54;!this.__lockLoadMore&&this.canLoadMore()&&(e=this.node.scrollHeight-this.node.scrollTop-this.node.clientHeight,e>t||(this.__lockLoadMore=!0,_.method("loadMoreStart")(this),this.loadMore().then(function(){return this.update()},this).then(function(){this.setFullyLoadedStateIfNeeded(),this.__lockLoadMore=!1,_.method("loadMoreStop")(this)
},this)))},50),setFullyLoadedStateIfNeeded:function(){this.$node.toggleClass("mail-ThreadSidebar-Item-FullyLoaded",!this.canLoadMore())}}),ns.View.define("thread-sidebar-wrap",{models:{message:!1,"thread-sidebar-state":{"ns-model-changed":!1,"ns-model-changed.flight":"onChangeFlightDebounce","ns-model-changed.update":"update"}},params:{ids:null},yateModule:"message",events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},ctor:function(){this.onChangeFlightDebounce=_.debounce(this.onChangeFlight.bind(this),0)
},methods:{onShow:function(){if(this.checkShow()){var e=this.getModel("message"),t=e.getThreadId(),s=this.getMenuItems();ns.Model.get("thread-sidebar",{thread_id:t}).setData({items:s});var i=this.updateParams(),n=this.node.appendChild(this.node.ownerDocument.createElement("div"));this.vThreadSidebar=ns.View.create("thread-sidebar-box",i),this.vThreadSidebar._setNode(n),this.vThreadSidebar.invalidate(),this.vThreadSidebar.updateByLayout("layout-thread-sidebar",i,{execFlag:ns.U.EXEC.PARALLEL}).then(this.onChangeFlight,this)
}},update:function(){this.vThreadSidebar&&this.vThreadSidebar.update(this.updateParams(),{execFlag:ns.U.EXEC.PARALLEL})},onHide:function(){this.onChangeFlightDebounce.cancel(),this.vThreadSidebar&&(this.vThreadSidebar.destroy(),this.vThreadSidebar=null)},updateParams:function(){var e=this.getModel("message"),t=e.getThreadId();return{thread_id:t,ids:this.params.ids,mid:e.get(".mid"),from:e.get('.field[.type=="from"].email')[0]}},checkShow:function(){var e=this.getModel("message");return!e.inFolderBySymbol(["trash","spam"])
},onChangeFlight:function(){var e=this.getModel("thread-sidebar-state"),t="";e.isFlight()&&(t=this.$node.closest(".js-message-wrap").find(".js-message-heads").height(),t-=1),this.$node.css("min-height",t),ns.events.trigger("daria:vApp:changeRightColumSize")},getMenuItems:function(){var e=this.getModel("message"),t=e.getThreadId(),s=[{id:1,layout:"layout-thread-sidebar-item-related",thread_id:t,title:"Письма на тему",metrika_onshow_title:"Показ Писем на тему",className:"qa-thread-sidebar-related"}];
return e.hasSocialLabels()||s.push({id:2,layout:"layout-thread-sidebar-item-attachments",thread_id:t,title:"Вложения",metrika_onshow_title:"Показ Вложения",className:"qa-thread-sidebar-attachments"},{id:3,layout:"layout-thread-sidebar-item-links",thread_id:t,title:"Ссылки",metrika_onshow_title:"Показ Ссылки",className:"qa-thread-sidebar-links"}),s.push({id:4,layout:"layout-thread-sidebar-item-same-author",thread_id:t,title:"Письма от "+e.get('.field[.type=="from"].name')[0],metrika_onshow_title:"Показ Письма от",className:"qa-thread-sidebar-same-author"}),s
}}}),ns.ViewCollection.define("thread-sidebar",{events:{"ns-page-before-load@show":"onPageBeforeLoad","ns-view-show":"toggleExpand"},models:{"thread-sidebar":!1,"thread-sidebar-state":{"ns-model-changed":!1,"ns-model-changed.activeItemId":"onStateChange","ns-model-changed.update":"onStateChange","ns-model-changed.flight":"toggleExpand"},settings:{"ns-model-changed":!1,"ns-model-changed.right_column_expanded":"toggleExpand"}},params:{thread_id:null,ids:null,mid:null,from:null},split:{byModel:"thread-sidebar",intoViews:"thread-sidebar-item"},yateModule:"message",methods:{isColumnFlight:function(){return this.getModel("thread-sidebar-state").isFlight()
},toggleExpand:function(){var e=this.getModel("settings").getSign("right_column_expanded");this.$node.toggleClass("is-collapsed",this.isColumnFlight()&&!e)},onStateChange:function(){this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},onPageBeforeLoad:function(e,t){var s=this.getModel("thread-sidebar-state");_.get(t[0],".page")!==_.get(t[1],".page")?s.unsetActiveItem():s.trigger("daria:thread-sidebar:save-scroll-in-related")}}}),ns.View.define("thread-sidebar-box",{events:{"ns-view-show":"onShow"},models:{"thread-sidebar-state":{"ns-model-changed":!1,"ns-model-changed.flight":"onChangeFlight","ns-model-changed.body":"checkFlight"}},yateModule:"message",methods:{onShow:function(){this.checkFlight(),this.getModel("thread-sidebar-state").metrikaCount("Показ")
},onChangeFlight:function(){var e=this.getModel("thread-sidebar-state");this.$node.toggleClass("is-flight",e.isFlight()),this.getModel("thread-sidebar-state").metrikaCount("Показ")},checkFlight:function(){var e=this.getModel("thread-sidebar-state"),t=e.get(".body"),s=20;if(!_.isEmpty(t)){var i=t.scrollWidth-t.clientWidth>s;i?ns.events.trigger("daria:vThreadSidebarBox:flight",this.$node.outerWidth(!0)):ns.events.trigger("daria:vThreadSidebarBox:flight",0),e.setIfChanged(".flight",i)}}}}),ns.View.define("thread-sidebar-item",{models:{"thread-sidebar-item":!1,"thread-sidebar-state":!1},params:{thread_id:null,ids:null,mid:null,from:null,id:null},yateModule:"message",methods:{patchLayout:function(){var e=this.getModel("thread-sidebar-state").get(".activeItemId");
return e===this.params.id?this.getModel("thread-sidebar-item").get(".layout"):"layout-thread-sidebar-item"}}}),ns.View.define("thread-sidebar-item-save-scroll",{methods:{scrollInit:function(){ns.assert(this.getModel("thread-sidebar-state"),"Daria.vThreadSidebarItemSaveScroll","требует наличия модели thread-sidebar-state в зависимостях"),_.bindAll(this,["_saveScrollTopPosition"])},scrollStart:function(){var e=this.getModel("thread-sidebar-state");e.shouldScrollRelatedIntoView()?(e.disableScrollRelatedIntoViewFlag(),this._scrollCurrentLetterIntoView()):this._restoreScrollTopPosition(),this.getModel("thread-sidebar-state").on("daria:thread-sidebar:save-scroll-in-related",this._saveScrollTopPosition)
},scrollStop:function(){this.getModel("thread-sidebar-state").off("daria:thread-sidebar:save-scroll-in-related",this._saveScrollTopPosition)},_saveScrollTopPosition:function(){this.getModel("thread-sidebar-state").set(".relatedScrollTop",this.$node.scrollTop(),{silent:!0})},_scrollCurrentLetterIntoView:function(){var e=this.$node.find(".mail-ThreadSidebar-List-Item.is-selected")[0];e&&(this.node.scrollTop=e.offsetTop-(this.node.offsetHeight-e.offsetHeight)/2)},_restoreScrollTopPosition:function(){var e=this.getModel("thread-sidebar-state");
this.$node.scrollTop(e.get(".relatedScrollTop"))}}}),ns.View.define("thread-sidebar-item-title",{events:{click:"toggleItem"},models:{"thread-sidebar-item":!1,"thread-sidebar-state":{"ns-model-changed":"keepValid","ns-model-changed.activeItemId":"onActiveChanged"}},params:{thread_id:null,id:null},yateModule:"message",methods:{toggleItem:function(){var e=this.getModel("thread-sidebar-state"),t=this.getModel("thread-sidebar-item"),s=e.toggleItem(t.getId());s&&e.metrikaBlockCount(t.get(".metrika_onshow_title"))
},onActiveChanged:function(){var e=this.getModel("thread-sidebar-state"),t=this.getModel("thread-sidebar-item");this.$node.toggleClass("mail-ThreadSidebar-Item_title_active",e.isActive(t.getId()))}}}),ns.ViewCollection.edefine("thread-sidebar-item-related",{models:{messages:!1,"thread-sidebar-state":!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","scroll@show":"loadMoreByScrolling"},params:function(e){return{thread_id:e.thread_id}},split:{byModel:"messages",intoViews:"thread-sidebar-item-related-item"},yateModule:"message",methods:{outputError:no.true,onHtmlInit:function(){this.setFullyLoadedStateIfNeeded(),this.scrollInit()
},onShow:function(){this.scrollStart(),this.fillList()},onHide:function(){this.scrollStop(),this.loadMoreByScrolling.cancel()},canLoadMore:function(){return this.getModel("messages").canLoadMore()},loadMore:function(){return this.getModel("messages").loadMore()}}},"thread-sidebar-item-save-scroll",Daria.InfiniteViewCollection),ns.View.define("thread-sidebar-item-related-item",{models:{message:{"ns-model-changed":!1,"ns-model-changed.date.view":"onDateChange"}},yateModule:"message",methods:{onDateChange:function(){this.invalidate(),ns.Model.get("thread-sidebar-state").triggerUpdateDebounce()
}}}),ns.ViewCollection.edefine("thread-sidebar-item-attachments",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","scroll@show":"loadMoreByScrolling"},models:{"thread-attachments":!0,"thread-sidebar-state":!1},split:{byModel:"thread-attachments",intoViews:"thread-sidebar-item-attachments-item"},params:{thread_id:null},yateModule:"message",methods:{outputError:no.true,onHtmlInit:function(){this.setFullyLoadedStateIfNeeded(),this.scrollInit()},onShow:function(){this.scrollStart()
},onHide:function(){this.scrollStop(),this.loadMoreByScrolling.cancel()},canLoadMore:function(){return this.getModel("thread-attachments").canLoadMore()},loadMore:function(){return this.getModel("thread-attachments").loadMore()}}},"thread-sidebar-item-save-scroll",Daria.InfiniteViewCollection),ns.View.defineNg("thread-sidebar-item-attachments-item",{models:{"thread-attachments-item":!0},events:{"click .js-image-preview":"previewImage","click .js-docviewer-preview":"onDocviewerPreviewClick","click .js-download-attach":"attachmentDownloadMetrika"},params:{"url-key":null},yateModule:"message",methods:{attachmentDownloadMetrika:function(){Jane.c(["Правая колонка","Блоки правых колонок","Показ Вложения","Клик во вложение","Скачивание вложения"])
},onDocviewerPreviewClick:function(){Jane.c(["Правая колонка","Блоки правых колонок","Показ Вложения","Клик во вложение","Показ вложения"])},previewImage:function(e){var t=Daria.parseQuery($(e.currentTarget).data("params")),s=t.mid||this.params.ids,i=t.hid,n=this.params.hid;Daria.ImageViewer.open("",s,i,n),Jane.c(["Правая колонка","Блоки правых колонок","Показ Вложения","Клик во вложение","Показ вложения"]),e.preventDefault()},countSaveToDisk:function(){Jane.c(["Правая колонка","Блоки правых колонок","Показ Вложения","Клик во вложение","Сохранить на Диск"])
}}},"save-to-disk-mixin",ns.View),ns.View.define("thread-sidebar-item-link",{models:{"messages-thread-link":!0},yateModule:"message"}),ns.ViewCollection.edefine("thread-sidebar-item-links",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","scroll@show":"loadMoreByScrolling"},models:{"messages-thread-links":!1,"thread-sidebar-state":!1},split:{byModel:"messages-thread-links",intoViews:"thread-sidebar-item-link"},yateModule:"message",methods:{outputError:no.true,onHtmlInit:function(){this.setFullyLoadedStateIfNeeded(),this.scrollInit()
},onShow:function(){this.scrollStart()},onHide:function(){this.scrollStop(),this.loadMoreByScrolling.cancel()},canLoadMore:function(){return this.getModel("messages-thread-links").canLoadMore()},loadMore:function(){return this.getModel("messages-thread-links").loadMore()}}},"thread-sidebar-item-save-scroll",Daria.InfiniteViewCollection),ns.ViewCollection.edefine("thread-sidebar-item-same-author",{models:{"messages-from":!1,"thread-sidebar-state":!1},yateModule:"message",split:{byModel:"messages-from",intoViews:"thread-sidebar-item-same-author-item"},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","scroll@show":"loadMoreByScrolling"},methods:{outputError:no.true,onHtmlInit:function(){this.setFullyLoadedStateIfNeeded(),this.scrollInit()
},onShow:function(){this.scrollStart()},onHide:function(){this.scrollStop(),this.loadMoreByScrolling.cancel()},canLoadMore:function(){return this.getModel("messages-from").canLoadMore()},loadMore:function(){return this.getModel("messages-from").loadMore()}}},"thread-sidebar-item-save-scroll",Daria.InfiniteViewCollection),ns.View.define("thread-sidebar-item-same-author-item",{models:{"messages-from-item":{"ns-model-changed":!1,"ns-model-changed.date.view":"onDateChange"},message:!1},yateModule:"message",methods:{onDateChange:function(){this.invalidate(),ns.Model.get("thread-sidebar-state").triggerUpdateDebounce()
}}}),ns.View.define("thread-sidebar-expand-button",{events:{"click@show":"onClick"},yateModule:"message",models:{"thread-sidebar-state":{"ns-model-changed":!1,"ns-model-changed.flight":"_update"},settings:{"ns-model-changed":!1,"ns-model-changed.right_column_expanded":"_update"}},methods:{_update:function(){this.invalidate(),this.getModel("thread-sidebar-state").triggerUpdate()},onClick:function(){var e=this.getModel("settings").getSign("right_column_expanded"),t=e?'Клик в "Свернуть"':'Клик в "Развернуть"';
Jane.c("Правая колонка","Плавающая правая колонка",t),this.getModel("settings").setSettings({right_column_expanded:!e})}}}),ns.View.define("message-prevnext",{events:{"daria:vMessagePrevNextInMessage:changeMessage@show":"onChangeMessage"},models:{"message-nearest":!1,folders:!0},yateModule:"message",methods:{onChangeMessage:function(e,t){if(t.direction){var s,i=this.getModel("message-nearest").getNearestMessages(),n=i[t.direction];n&&(s=n.mid),s&&ns.page.go(ns.router.generateUrl("message",{ids:s}))
}}}}),yr.externals["event-pretty-date"]=function(e){var t=Jane.Common.n,s=[],i=new Date(e),n=new Date,a=i.getFullYear(),o=i.getMonth(),r=i.getDate(),l=i.getHours(),u=i.getMinutes(),d=n.getFullYear(),c=n.getMonth(),h=n.getDate();return d==a&&c==o&&h==r?s.push("Сегодня"):new Date(a,o,r)-new Date(d,c,h)===864e5&&s.push("Завтра"),s.push(Jane.Date.format("%Date_dBY_year",i)),s.push(" <input class='b-calendar-event__time__input' type='text' value='"+t(l)+":"+t(u)+"' maxlength='5'>"),s.join(", ")},yr.externals.lang2index=function(e){var t=Daria.Translate.langs.all.s.indexOf(e);
return t>-1?t:0},yr.externals["get-recipients-corp-logins"]=function(e){var t=ns.Model.get("message-body",{ids:e}),s=t.getRecipients(!0,!0);return _(s.to).union(s.cc).pluck("email").filter(Daria.isCorpEmail).map(Daria.getEmailLogin).value()},yr.externals["remove-http-protocol"]=function(e){return e.replace(/^https?:\/\/(www\.)?/,"")}});