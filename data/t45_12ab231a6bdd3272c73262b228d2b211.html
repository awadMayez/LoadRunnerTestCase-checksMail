Jane.module("jane.compose2.js",function(){"use strict";ns.View.prototype.composeUpdate=function(){this.info&&!this.info.isCollection&&this.invalidate(),this.isVisible()&&this.getModel("compose-state").trigger("ns-model:compose:update")},Daria.composeEqualRoutes=function(e,t){var o=_.omit(e.params,["_cuid","showDatePager"]),s=_.omit(t.params,["_cuid","showDatePager"]);return e.page===t.page&&_.isEqual(o,s)?!0:!1},Daria.utils=Daria.utils||{},Daria.utils.dirname=function(e){e=e||"";var t="/",o=e.charAt(0)===t,s=$.grep(e.split(t),function(e){return e.length
});return s.pop(),(o?t:"")+s.join(t)},Daria.utils.checkReplaceFakeMessage=function(e){if("message"===ns.page.current.page)return!1;if("yes"!==ns.page.current.params.threaded)return!1;if(!ns.Model.get("settings").isThreaded())return!1;var t=no.jpath(".message.hdr_message_id",e),o=no.jpath(".message.mid",e),s=no.jpath(".message.thread_id",e);if(!s||!t||!o)return!1;var i=ns.Model.get("messages",{thread_id:"t"+s}).isValid();return i?!0:!1},Daria.ComposeComponents={},Daria.FileSizer=function(e,t){var o=Daria.getRandomNumber(),s="attach-iframe-"+o;
ns.events.on("attach-size:"+o,function(e,o){o>-1?(this.stop(),t(o)):this._getSizeAttempt()}.bind(this)),this.url="//filesize.mail.yandex.net/poster/"+o+"/",this.attachId=o,this.attempts=5,this.$iframe=$('<iframe class="g-hidden" name="'+s+'" src="javascript:false"/>').appendTo("body"),this.$form=$('<form class="g-hidden" method="post" enctype="multipart/form-data" action="'+this.url+'" target="'+s+'"/>').append(e).append('<input name="txt" value=""/>').appendTo("body").submit(),this._failTimer=window.setTimeout(this._fail.bind(this),5e3),this._getSizeAttempt()
},Daria.FileSizer.prototype={_getSizeAttempt:function(){var e=this.url;this.attempts>0?(this.attempts--,this._getSizeTimer=window.setTimeout(function(){$.getScript(e)},300)):this._fail()},_fail:function(){ns.events.trigger("attach-size:"+this.attachId,0)},stop:function(){this.$iframe&&(this.$iframe.remove(),delete this.$iframe),this.$form&&(this.$form.remove(),delete this.$iframe),ns.events.off("attach-size:"+this.attachId),window.clearTimeout(this._getSizeTimer),window.clearTimeout(this._failTimer)
}},window.setFileSize=function(e,t){ns.events.trigger("attach-size:"+e,t)},ns.action.define("attachments.retry",function(e,t){ns.events.trigger("daria:vComposeAttachArea:retryAttach",t)}),function(){var e={ATTACHING_TO_DISK:"ATTACHING_TO_DISK",ATTACHING_TO_DISK_FAILED:"ATTACHING_TO_DISK_FAILED"},t=Daria.Attachment2=function(e,o){this.bindMethodsToContext(),this._collection=o,this._aborted=!1,this.deleted=!1,this.info=e||{},"mail"===this.info["class"]&&"eml"!==Daria.getExtension(_.unescape(this.info.name))&&(this.info.name+=".eml"),ns.assert(e.mComposeMessage,"Daria.Attachment2",'"mComposeMessage" parameter is not passed to the constructor'),this.mComposeMessage=e.mComposeMessage,this.info.id=this.info.hid?parseInt(this.info.hid.replace(/\./g,"0"),10):t._COUNTER++,this.info.id>=t._COUNTER&&(t._COUNTER=this.info.id+1),this.info.name=_.unescape(this.info.name||this._getFileName()),this.info["name-uri-encoded"]=encodeURIComponent(this.info.name),this.info.extension=Daria.getExtensionInfo(this.info.name),this.info["class"]=this.info["class"]||this.info.extension["class"],this.previewSupported=this.info.extension.preview||"audio"==this.info["class"]&&"mp3"==this.info.extension.icon,"narod"===this.type()&&(this.previewSupported=!!this.info.narodPreview),this._updatePreviewUrls(),this.status=this.info.type?this.ATTACH_STATUS_COMPLETED:this.ATTACH_STATUS_NEW,this._uploadDeferred=$.Deferred(),this._requests=[],this.getSize()
};t.fromMessageBody=function(e,o,s){var i=e.narod,n={stid:o.getSTID(),mid:o.params.ids,bid:e.bid,hid:e.hid,name:_.unescape(e.name),"browser-supports":e["browser-supports"]};return i?(n.narodUrl=e.url,n.size=e.size,n.type="narod",n.folder=e.folder,n.narodPreview=e.preview):(n.size=parseInt(e.length,10),n.type="simple",n["class"]=e["class"],n.message=!!e.message,n.external_transformer=e.external_transformer,n.external_transformer_filetype=e.external_transformer_filetype),n.mComposeMessage=s,new t(n)
},t.METRIKA_EVENTS=e,t._COUNTER=0,t.prototype={ATTACH_STATUS_NEW:0,ATTACH_STATUS_UPLOADING:1,ATTACH_STATUS_COMPLETED:2,ATTACH_STATUS_FAILED:3,ATTACH_STATUS_VIRUS:4,bindMethodsToContext:function(){this._updateShrinker=this._updateShrinker.bind(this)},isRegularFile:function(){var e=$.Deferred(),t=this.info.file;if(!t||Modernizr.webkit)return e.resolve(!0),e;if(!window.FileReader){var o=t.size,s=0===o||102===o||4096===o;return e.resolve(!(s&&""===t.type&&-1===t.name.indexOf("."))),e}if(window.opera&&navigator.platform.toLowerCase().indexOf("mac")>-1&&"12.00"===window.opera.version())e.resolve(null);
else{if(t.size>4096)return e.resolve(!0),e;try{var i=new FileReader;i.onerror=function(){i.onloadend=i.onprogress=i.onerror=null,e.resolve(!1)},i.onloadend=i.onprogress=function(t){i.onloadend=i.onprogress=i.onerror=null;try{"loadend"!=t.type&&i.abort()}catch(o){}e.resolve(!0)},i.readAsDataURL(t)}catch(n){e.resolve(!1)}}return e},isCancelled:function(){return this._aborted||this.deleted},setNode:function(e){return this._$node&&this._$node.replaceWith(e),this._$node=e,this.bindEvents(),_.defer(this._updateShrinker),this.status===this.ATTACH_STATUS_FAILED&&this.setStatus(this.ATTACH_STATUS_FAILED),this._addToComposeMessage(),this.trigger("update"),this
},bindEvents:function(){this._$node&&this._$node.on("click",".js-mark-deleted",this.markDeleted.bind(this)).on("click",".js-unmark-deleted",this.unmarkDeleted.bind(this)).on("click",".js-retry",this.retry.bind(this))},getNode:function(e){if(e||!this._$node){var t=this._collection?this._collection.templateMode:"compose2:attachments",o=Jane.tt(t,{attachment:[this.getJSONForTransform()]});this.setNode($(o.firstChild))}return this._$node},getJSONForTransform:function(){var e=this.info.name,t=Daria.splitName(e),o={id:this.info.id,name:e,"name-uri-encoded":this.info["name-uri-encoded"],filename:t[0],fileext:t[1]?"."+t[1]:"","class":this.info["class"],folder:this.info.folder,"browser-supports":this.info["browser-supports"],length:this.info.size,status:this.status};
return this.status==this.ATTACH_STATUS_VIRUS&&$.extend(o,{errorCode:106}),this.info.stid&&(o.stid=this.info.stid),this.info.extension.icon&&(o.icon=this.info.extension.icon),this.info.external_transformer&&(o.external_transformer=this.info.external_transformer,o.external_transformer_filetype=this.info.external_transformer_filetype),this.info.message&&(o.message=!0),this.info.narodUrl||this.info.url?o.url=this.info.narodUrl||this.info.url:this.info.mid&&this.info.hid?(o.mid=this.info.mid,o.hid=this.info.hid,o.bid=this.info.bid):o.uploading=!0,"narod"==this.info.type&&(o.narod=!0),this.previewSupported&&(o["preview-supported"]=!0,o["preview-src"]=this.info.previewSrc?this.info.previewSrc:!1,o["preview-href"]=this.info.previewHref?this.info.previewHref:!1),o
},_updateShrinker:function(){var e=this.getNode().find(".b-shrinker");if(e[0]){var t=e.find(".b-shrinker__right").width();e.css("margin-right",t)}},markDeleted:function(){return this.status===this.ATTACH_STATUS_COMPLETED?(this.getNode().removeClass("b-file_deletable").addClass("b-file_deleted"),this.deleted=!0,this._removeFromComposeMessage(),!1):(this.remove(),this._uploadDeferred.reject(),!0)},forceRemove:function(){this.remove(),this._uploadDeferred.reject()},unmarkDeleted:function(){this.getNode().removeClass("b-file_deleted").addClass("b-file_deletable"),this._addToComposeMessage(),this.deleted=!1
},removeIfMarked:function(){return this.deleted?(this.remove(),!0):!1},stop:function(){if(this.status!==this.ATTACH_STATUS_COMPLETED){this.getNode().remove(),this._aborted=!0,this._fileSizer&&(this._fileSizer.stop(),delete this._fileSizer);for(var e,t=0,o=this._requests.length;o>t;t++)e=this._requests[t],e instanceof Vow.Promise?e.notify("abort"):e.abort();var s=this.getDiskResourceId();s&&ns.Model.get("disk-resources").removeAttach(s),this._stopNarod(),this._requests=[]}},_stopNarod:function(){this.info.narod&&(this.info.narod.$iframe&&(this.info.narod.$iframe.remove(),this.info.narod.$form.remove()),window.clearTimeout(this.info.narod.getNarodProgressTimer),delete this.info.narod)
},remove:function(){this._removeFromComposeMessage(),this.stop(),this.getNode().remove(),this.deleted=!1,this.trigger("attachment.removed",this)},getId:function(){return this.info.id},getDiskResourceId:function(){return this.info._id},getSize:function(){if(!this._sizeDeferred){this._sizeDeferred=$.Deferred();var e=this.info.file;"size"in this.info?this._sizeDeferred.resolve(this.info.size,this):e?(this.info.size="size"in e?e.size:e.fileSize,this._sizeDeferred.resolve(this.info.size,this)):this._fileSizer=new Daria.FileSizer(this.info.input,function(e){this.info.size=e||0,this._sizeDeferred.resolve(this.info.size,this),delete this._fileSizer,this.getNode().find(".b-file__size").text(Jane.getHumanSize(this.info.size))
}.bind(this))}return this._sizeDeferred},type:function(e){return e&&(this.info.type=e),this.info.type},isSimpleAttach:function(){return"simple"===this.type()},isDiskAttach:function(){return"narod"===this.type()},getMediaType:function(){return this.info.mediaType},isFolder:function(){return this.info.folder},metrika:function(t){var o=[];switch(t){case e.ATTACHING_TO_DISK:var s=this.isFolder();o.push(["Аттачи из Диска","Прикрепление",s?"Папка":"Файл"]),s||o.push(["Аттачи из Диска","Типы файлов",this.getMediaType()]),Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("ATTACHFROMDISK");
break;case e.ATTACHING_TO_DISK_FAILED:o.push(["Аттачи из Диска","Ошибка загрузки"])}o.forEach(function(e){Jane.c.apply(null,e)})},launchStriveAnimation:function(){var e=this,t=this.strive(100),o=0;this.animationIntervalId=window.setInterval(function(){e._onUploadProgress(null,t(o++))},100)},strive:function(e){return function(t){return e*(Math.sqrt(t)/(1+Math.sqrt(t)))}},stopAnimation:function(){clearInterval(this.animationIntervalId),delete this.animationIntervalId},updateWithDiskData:function(e){var t=this;
this.info.narodUrl=e.url;var o=(new $.Deferred).resolve().promise();return this.info.narodPreview&&(o=ns.Model.get("disk-resources").getPreview(e.hash).always(function(e){t.info.narodPreview=e})),o},attach:function(){var t=this;return this.setStatus(this.ATTACH_STATUS_UPLOADING),this.retry=function(){t.attach()},this.metrika(e.ATTACHING_TO_DISK),this.launchStriveAnimation(),ns.Model.get("disk-resources").attach(this.getDiskResourceId()).then(this.updateWithDiskData.bind(this)).then(this._onUploadSuccess.bind(this,!0)).fail(function(){t.metrika(e.ATTACHING_TO_DISK_FAILED),t.setStatus(t.ATTACH_STATUS_FAILED)
}).always(function(){t.stopAnimation()})},upload:function(){return this.status=this.ATTACH_STATUS_UPLOADING,this.isDiskAttach()?this._fileUploadDisk():this.info.file&&window.FormData?this._fileUploadXHR():this._fileUploadIFrame(),this._uploadDeferred},_getUploadUrl:function(){return Daria.url.upload()},_onUploadProgress:function(e,t){if(!this.isFailed()){e&&e.lengthComputable&&(t=e.loaded/e.total*100),t=parseInt(t,10),t=isNaN(t)?-1:t;var o=t>=0&&100>t;this._setBlockMod(o?"loading":"wait"),this.getNode().find(".js-progress").width((o?t:100)+"%")
}},_getDiskProgress:function(){this.info&&this.info.narod&&ns.forcedRequest("do-attach-file-status",{oid:this.info.narod.oid}).then(function(e){var t=e[0].getData(),o=jpath(t,".operation")[0];if(!o)return Jane.ErrorLog.send({errorType:"upload.disk.no_operation"}),void this.setStatus(this.ATTACH_STATUS_FAILED,6);var s=o.status;if("EXECUTING"==s||"WAITING"==s){var i=jpath(o,'.stages.stage[.name == "kladun_upload"].progress')[0];"undefined"==typeof i||100==i?this._onUploadProgress(null,100):this._onUploadProgress(null,i)
}else if("FAILED"==s){var n=jpath(o,".error.code")[0];"106"==n?(this.setStatus(this.ATTACH_STATUS_VIRUS,106),Jane.ErrorLog.send({errorType:"upload.disk.virus"})):(Jane.ErrorLog.send({errorType:"upload.disk.failed",code:n}),this.setStatus(this.ATTACH_STATUS_FAILED,6))}else if("DONE"==s){var a=o.file;if(a){var r=function(){delete this.info.narod,this._updatePreviewUrls(),this.info.narodUrl&&this.info.size?this._onUploadSuccess(!0):(Jane.ErrorLog.send({errorType:"upload.disk.no_size_or_nourl",disk_url:this.info.narodUrl,disk_size:this.info.size}),this.setStatus(this.ATTACH_STATUS_FAILED,6))
}.bind(this);this.info.narodUrl=jpath(a,".meta.short_url")[0],this.info.size=a.size;var c=jpath(a,".meta.preview")[0],l=jpath(a,".meta.public_hash")[0];c&&l?ns.Model.get("disk-resources").getPreview(l).always(function(e){this.info.narodPreview=e,r()}.bind(this)):(this.info.narodPreview=c,r())}else Jane.ErrorLog.send({errorType:"upload.disk.no_fileinfo"}),this.setStatus(this.ATTACH_STATUS_FAILED,6)}else Jane.ErrorLog.send({errorType:"unknown_disk_status",status:s},window.JSON&&JSON.stringify(t));this.isUploading()&&this._setDiskProgressTimeout()
}.bind(this),function(){this.setStatus(this.ATTACH_STATUS_FAILED),Jane.ErrorLog.send({errorType:"fail-do-attach-file-status"})}.bind(this))},_simpleUploadComplete:function(e){var t=e.responseText,o={};if(t)try{o=$.parseJSON(t)}catch(s){Jane.ErrorLog.send({errorType:"simpleUpload.json_parse",aborted:this._aborted,xhr_status:e.status,xhr_readystate:e.readyState,xml_length:t?t.length:0},t)}if(o.write_attachment){var i=o.write_attachment,n=i.id,a=i.downloadUrl,r=i.previewUrl;if(n&&a)return this.info.att_id=n,this.info.url=a.replace("http://","//"),this.previewSupported&&r&&(this.info.previewHref=this.info.url+"&no_disposition=y",this.info.previewSrc=r.replace("http://","//")+"&no_disposition=y"),void this._onUploadSuccess(!0)
}else o.error&&"AUTH_NO_AUTH"==o.error.code&&Jane.doLogin("upload_attachment");this._aborted||Jane.ErrorLog.send({errorType:"simpleUpload",aborted:this._aborted,xhr_status:e.status,xhr_readystate:e.readyState,xml_length:t?t.length:0},t),this.setStatus(this.ATTACH_STATUS_FAILED,0)},_setBlockMod:function(e){e=e||"";var t=this.getNode();t.removeClass("b-file_wait b-file_loading b-file_error"),e&&t.addClass("b-file_"+e)},setStatus:function(e,t){this.status=e,e===this.ATTACH_STATUS_FAILED?(this._onUploadFail(t),this._setBlockMod("error")):e===this.ATTACH_STATUS_VIRUS?(this._onUploadFail(t),this._setBlockMod("virus")):(delete this._failErrorCode,this._setBlockMod(""))
},retry:function(){Daria.Dialog.close(),this.setStatus(this.ATTACH_STATUS_NEW),this._setBlockMod("wait"),this._uploadDeferred=$.Deferred()},tooBigAttach:function(e){this.type("simple"),this.setStatus(this.ATTACH_STATUS_FAILED,e)},_onUploadSuccess:function(e){return this.isCancelled()?void this._uploadDeferred.reject():(this._updatePreviewUrls(),this.setStatus(this.ATTACH_STATUS_COMPLETED),this.getNode(e),this._addToComposeMessage(),void this._uploadDeferred.resolve())},getDataToSend:function(){return this.isSimpleAttach()?_.pick(this.info,["att_id","hid"]):this.isDiskAttach()?{disk:this.getNarodHTML()}:void 0
},_addToComposeMessage:function(){this.mComposeMessage.addAttachment(this)},_removeFromComposeMessage:function(){this.mComposeMessage.removeAttachment(this.getId())},_updatePreviewUrls:function(){this.info.mid&&this.previewSupported&&(this.info.previewHref=Daria.url.attachment(this.info,this.info.mid,{no_disposition:!0}),this.info.previewSrc=Daria.url.attachment(this.info,this.info.mid,{no_disposition:!0,thumb:!0})),this.info.narodPreview&&this.previewSupported&&(this.info.previewSrc=this.info.previewHref=this.info.narodPreview)
},_onUploadFail:function(e){var t=Daria.AttachmentCollection2.prototype.HAS_DISK?"Превышен максимальный размер файла (2&#160;ГБ). Сократите, пожалуйста.":"Файл больше максимально допустимого (100&#160;МБ). Загрузите его на Яндекс.Диск и добавьте в письмо ссылку на него.",o={0:"Произошла ошибка при загрузке файла.",1:t,2:"Суммарный размер вложений превысил 100&#160;МБ.",106:"Файл не будет отправлен, так как в нём обнаружен вирус. Проверено Dr.Web."};106==e&&this.getNode(!0),e=e||this._failErrorCode||0,e in o||(e=0),this._failErrorCode=e;
var s=o[e]+(0===e?'  <a class="b-pseudo-link ns-action" data-click-action="attachments.retry" data-params="id='+this.getId()+'">Повторить</a>':"");this.getNode().find(".b-file__fail").attr("data-params","width=30em&side=top&text="+encodeURIComponent(s)),this._aborted||(this.trigger("attachment.failed"),Jane.ErrorLog.send({errorType:"UploadFail",aborted:this._aborted,fileName:this.info.name,uploaderType:this.info.type,errorCode:e})),this._uploadDeferred.reject()},_fileUploadIFrame:function(){this._onUploadProgress();
var e=document.createElement("form");e.className="g-hidden",this.info.input.name="attachment",e.appendChild(this.info.input);var t=this;$(e).appendTo("body").ajaxSubmit({url:this._getUploadUrl(),type:"POST",dataType:"text",iframe:!0,data:{Filename:this.info.name,_iframe:!0},beforeSend:function(e){t._requests.push(e)},complete:function(e){t._removeRequest(e),t._simpleUploadComplete(e)}})},_diskUploadIFrame:function(){var e=this;this._onUploadProgress(null,0);var t=$('<form class="g-hidden" method="post" enctype="multipart/form-data" action="'+this.info.narod.url+'"></form>');
this.info.input.name="file",t.appendTo(document.body).append(this.info.input),t.ajaxSubmit({type:"POST",iframe:!0,beforeSend:function(t){e._requests.push(t)},complete:function(t){e._removeRequest(t)}})},_diskUploadXHR:function(){var e=this,o=new FormData;o.append("file",this.info.file);var s=new XMLHttpRequest;s.open("POST",this.info.narod.url,!0),s.upload&&!window.opera?s.upload.addEventListener("progress",this._onUploadProgress.bind(this),!1):this._setDiskProgressTimeout(),s.onreadystatechange=function(){4===this.readyState&&(e._removeRequest(this),this.status>=200&&this.status<300?e.info.narod&&e._setDiskProgressTimeout():(e._aborted||Jane.ErrorLog.send({errorType:"upload.disk.xhr_fail",status:this.status},this.responseText),0!==this.status||e._aborted||(t.prototype._failXDR=!0),window.clearTimeout(e.info.narod.getNarodProgressTimer),e.setStatus(e.ATTACH_STATUS_FAILED,0)))
},s.send(o),this._requests.push(s)},_removeRequest:function(e){Jane.Array.remove(this._requests,e)},_fileUploadXHR:function(){var e=this,t=new FormData;t.append("Filename",this.info.name);var o=new XMLHttpRequest;o.open("POST",this._getUploadUrl(),!0),o.upload&&o.upload.addEventListener("progress",this._onUploadProgress.bind(this),!1),o.onreadystatechange=function(){4===this.readyState&&(e._removeRequest(this),e._simpleUploadComplete(this))},t.append("attachment",this.info.file,this.info.name),this._onUploadProgress(null,0),o.send(t),this._requests.push(o)
},_fileUploadDisk:function(){var e=this,t=ns.forcedRequest("do-attach-file-store",{file:this.info.name}).then(function(o){e._removeRequest(t);var s=o[0].getData(),i=s&&jpath(s,".upload_url")[0],n=s&&jpath(s,".oid")[0];return i&&n?(e.info.narod={url:i,oid:n},void(e.info.file&&window.FormData&&window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest?e._diskUploadXHR():(e._diskUploadIFrame(),e._setDiskProgressTimeout()))):(Jane.ErrorLog.send({errorType:"upload.disk.no_url_or_oid"},s&&window.JSON?JSON.stringify(s):""),void e.setStatus(e.ATTACH_STATUS_FAILED))
},function(){e.setStatus(e.ATTACH_STATUS_FAILED),Jane.ErrorLog.send({errorType:"fail-do-attach-file-store"})});this._requests.push(t),this._onUploadProgress(null,0)},_setDiskProgressTimeout:function(){this._getDiskProgressBinded||(this._getDiskProgressBinded=this._getDiskProgress.bind(this)),window.clearTimeout(this.info.narod.getNarodProgressTimer),this.info.narod.getNarodProgressTimer=window.setTimeout(this._getDiskProgressBinded,1500)},getNarodHTML:function(){var e="";return"narod"===this.info.type&&this.status===this.ATTACH_STATUS_COMPLETED&&(e+='<a class="narod-attachment" target="_blank" rel="noopener noreferrer" href="'+this.info.narodUrl+'"',this.info.previewSrc&&(e+=' data-preview="'+encodeURIComponent(this.info.previewSrc)+'"'),e+=">",e+=this.info.name,this.info.size&&(e+=" ("+this.info.size+")"),this.info.folder&&(e+=" (папка)"),e+="</a><br>"),e
},isUploading:function(){return this.status===this.ATTACH_STATUS_UPLOADING},isFailed:function(){return this.status===this.ATTACH_STATUS_FAILED},needUpload:function(){return this.status===this.ATTACH_STATUS_NEW},_getFileName:function(){var e;if(this.info.file)e=this.info.file.name||this.info.file.fileName;else if(this.info.input){var t=this.info.input.value.replace(/\\/g,"/").split("/");e=t[t.length-1]}else e="(Без темы)";return _.escape(e)},updateInfo:function(e,t){var o,s=this.info;return"narod"===s.type?!1:(s.att_id?o=jpath(e,'.[.att_id == "'+s.att_id+'"]')[0]:s.hid&&(o=jpath(e,'.[.old_hid == "'+s.hid+'"]')[0]),o?(this._removeFromComposeMessage(),delete s.att_id,delete s.url,s.hid=o.hid,s.mid=t,this.info.id=parseInt(this.info.hid.replace(/\./g,"0"),10),this._onUploadSuccess(),Jane.Array.remove(e,o),!0):!1)
},updateNarodInfo:function(){"audio"===this.info["class"]&&(this.previewSupported=!1)},inSize:function(e){return"boolean"==typeof e&&(this._inSize=e),this._inSize}},_.extend(t.prototype,ns.Events)}(),function(e,t){var o=t.AttachmentCollection2=function(e){this.bindMethodsToContext(),this._attachments={},this._currentAttachSize=0,this._id=t.getRandomNumber(),this._init=!1,e&&this.setOptionsAndInit(e)};o.prototype={MAX_ATTACH_SIZE:t.IS_CORP?104857600:25165824,HAS_DISK:!t.IS_CORP,setOptionsAndInit:function(e){ns.assert(e,"Daria.AttachmentCollection2",'"options" parameter is not passed to the #setOptions method'),this.options=e,ns.assert(e.node||e.$node,"Daria.AttachmentCollection2",'neither "options.node" nor "options.$node" parameter is passed to the #setOptions method'),this.$node=$(e.node||e.$node),ns.assert(e.mComposeMessage,"Daria.AttachmentCollection2",'"options.mComposeMessage" parameter is not passed to the #setOptions method'),this.mComposeMessage=e.mComposeMessage,ns.assert(e.mComposeState,"Daria.AttachmentCollection2",'"options.mComposeState" parameter is not passed to the #setOptions method'),this.mComposeState=e.mComposeState,this.templateMode=e.templateMode||"compose2:js-attachments-collection",this.$files=this.$node.find(".js-compose-attachments-container");
var t={_$attsImg:".js-compose-attachments-images",_$attsRecent:".js-compose-attachments-common",_$attsNarodCommon:".js-compose-attachments-narod-common",_$attsNarodImages:".js-compose-attachments-narod-images",_$attsDiskInfo:".js-compose-attachments-narod-header"};_.keys(t).forEach(function(e){this[e]=this.$files.find(t[e])},this),this._init=!0,this.checkVisibility()},_appendAttach:function(e,t,o){var s=e.getNode(t);e.previewSupported?e.isDiskAttach()?this._$attsNarodImages.append(s):this._$attsImg.append(s):e.isSimpleAttach()?this._$attsRecent.append(s):this._$attsNarodCommon.append(s),o||(this.checkVisibility(),this.trigger("attachments.appended",e))
},addAttachToCollection:function(e,t){t=t||{},t.processAttachSize=_.isBoolean(t.processAttachSize)?t.processAttachSize:!0,this._attachments[e.getId()]=e,t.processAttachSize&&e.getSize().done(this.onAttachmentGetSize),t.silent||this.trigger("attachments.added",e),this.bindEventsToAttach(e)},removeAttachFromCollection:function(e,t){t=t||{},this.unbindEventsFromAttach(e),this._reduceAttachmentsSize(e),this.checkVisibility(),delete this._attachments[e.getId()],t.silent||this.trigger("attachments.removed",e)
},bindMethodsToContext:function(){this.onAttachmentUpdated=this.onAttachmentUpdated.bind(this),this.onAttachmentRemoved=this.onAttachmentRemoved.bind(this),this.onAttachmentFailed=this.onAttachmentFailed.bind(this),this.onAttachmentGetSize=this.onAttachmentGetSize.bind(this)},bindEventsToAttach:function(e){e.on("update",this.onAttachmentUpdated),e.on("attachment.removed",this.onAttachmentRemoved),e.on("attachment.failed",this.onAttachmentFailed)},unbindEventsFromAttach:function(e){e.off("update",this.onAttachmentUpdated),e.off("attachment.removed",this.onAttachmentRemoved),e.off("attachment.failed",this.onAttachmentFailed)
},onAttachmentUpdated:function(){this.trigger("attachments.updated")},onAttachmentRemoved:function(e,t){this.removeAttachFromCollection(t)},onAttachmentFailed:function(){this.trigger("attachments.failed")},checkVisibility:function(){var e=this._$attsImg.find("> .b-file").length,t=this._$attsRecent.find("> .b-file").length,o=this._$attsNarodCommon.find("> .b-file").length,s=this._$attsNarodImages.find("> .b-file").length;this._$attsDiskInfo.toggleClass("g-hidden",o+s===0),this._$attsImg.toggleClass("g-hidden",0===e),this._$attsRecent.toggleClass("g-hidden",0===t),this._$attsNarodCommon.toggleClass("g-hidden",0===o),this._$attsNarodImages.toggleClass("g-hidden",0===s)
},isCompleted:function(){return _.every(this._attachments,function(e){return!e.needUpload()&&!e.isUploading()})},isUploading:function(){for(var e in this._attachments){var t=this._attachments[e];if(!t.isCancelled()&&t.isUploading())return!0}return!1},isFailed:function(){return _.some(this._attachments,function(e){return e.isFailed()})},hasFiles:function(){return!$.isEmptyObject(this._attachments)},reset:function(){if(this._init){this.$node.off(),this.off(),$(document).off(".compose");for(var e in this._attachments)this._attachments[e].remove();
this._attachments={},this._$attsImg.addClass("g-hidden").empty(),this._$attsRecent.addClass("g-hidden").empty(),this._$attsNarodCommon.addClass("g-hidden").empty(),this._$attsNarodImages.addClass("g-hidden").empty(),this.$dropzone&&this.$dropzone.remove()}},add:function(e,t){this.removeMarkedAsDeleted(),t?this._addAttaches(e,t):this._addAttach(e)},_addAttaches:function(e,o){for(var s=[],i=[],n=0,a=o.length;a>n;n++){var r=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o[n]},this);
this.addAttachToCollection(r,{processAttachSize:!1}),i.push(r.isRegularFile()),s.push(r)}$.when.apply(null,i).done(function(){for(var e=[],t=[],o=0,i=arguments.length;i>o;o++)if(arguments[o]!==!1){var n=s[o];this._attachments[n.getId()]=n,t.push(n),e.push(n.getSize().done(this.onAttachmentGetSize))}e.length&&$.when.apply(null,e).done(function(){this.redrawAttachesBulk(t),this._uploadQueue()}.bind(this))}.bind(this))},onAttachmentGetSize:function(e,t){if(e>this.MAX_FILE_SIZE)t.tooBigAttach(1);else{var o=e+this._currentAttachSize,s=o<this.MAX_ATTACH_SIZE;
s?(t.type("simple"),t.inSize(!0),this._currentAttachSize=o):this.HAS_DISK?(t.type("narod"),t.updateNarodInfo()):t.tooBigAttach(2)}},getAttaches$Html:function(t,o,s){for(var i=[],n=0,a=t.length;a>n;n++)i.push(t[n].getJSONForTransform());var r={"collection-id":this._id,attachment:i};return o&&(r.mid=o),s&&(r=$.extend({},r,s)),$(e.tt(this.templateMode,r))},redrawAttachesBulk:function(e,t,o){e||(e=_(this._attachments).chain().values().filter(function(e){return!e.isCancelled()}).value());var s=this.getAttaches$Html(e,t);
this._appendAttachBulk(e,s,o),ns.events.trigger("attachments.redrawn")},_appendAttachBulk:function(e,t,o){if(e.length){for(var s=0,i=e.length;i>s;s++){var n=e[s],a=n.getId(),r=t.find("#att_"+this._id+"_"+a);n.setNode(r),this._appendAttach(n,!1,!0)}o||(this.checkVisibility(),this.trigger("attachments.appended",e))}},_addAttach:function(e,o){var s=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:o},this);this.addAttachToCollection(s,{processAttachSize:!1});var i=this;s.getSize().done(this.onAttachmentGetSize).done(function(){i._appendAttach(s,!0),i._scrollToAttachInput(),i._uploadQueue()
})},addDiskAttach:function(e,o){var s,i=this,n="dir"===o.type,a=jpath(o,".meta.mediatype")[0];"image"===a&&(s=jpath(o,".meta.preview")[0]);var r=new t.Attachment2({name:o.name,type:"narod",size:o.meta&&o.meta.size,narodPreview:s,folder:n,mediaType:o.meta&&o.meta.mediatype||"unknown",_id:e,mComposeMessage:this.mComposeMessage},this);this.addAttachToCollection(r,{processAttachSize:!1}),this._appendAttach(r,!0),r.attach().then(function(){i._uploadQueue()}),this.removeMarkedAsDeleted()},_uploadQueue:function(){var e,o=this;
for(var s in this._attachments){var i=this._attachments[s];if(i.isUploading())return!1;if(!e&&i.needUpload()){i.removeIfMarked()?(this._reduceAttachmentsSize(i),delete this._attachments[s]):e=i;break}}e?e.getSize().done(function(){o.isUploading()||e.upload().always(function(){e.isDiskAttach()&&e._addToComposeMessage(),e.isFailed()&&o._reduceAttachmentsSize(e),t.setZeroTimeout(function(){o._uploadQueue()})})}):ns.events.trigger("attachments.all-uploaded")},removeMarkedAsDeleted:function(){for(var e in this._attachments){var t=this._attachments[e];
t.removeIfMarked()&&(this._reduceAttachmentsSize(t),delete this._attachments[e])}this.checkVisibility(),this.isUploading()||ns.events.trigger("attachments.all-uploaded")},_reduceAttachmentsSize:function(e){e.inSize()&&(e.inSize(!1),this._sizeReducer||(this._sizeReducer=function(e){this._currentAttachSize-=e}.bind(this)),e.getSize().done(this._sizeReducer))},updateAfterSave:function(e,t,o){if(e){var s=[],i={};_.each(this._attachments,function(o,n){if(o.updateInfo(e,t)){var a=o.getId();i[a]=o,s.push(o)
}else i[n]=o}),this._attachments=i,this.redrawAttachesBulk(s,t,o)}},stopUploading:function(){for(var e in this._attachments)this._attachments[e].stop();this.checkVisibility()},retryAttach:function(e){var t=this._attachments[e];t&&(t.retry(),this._uploadQueue())}},_.extend(o.prototype,ns.Events);var s=o.prototype;s.MAX_FILE_SIZE=s.HAS_DISK?2147483648:s.MAX_ATTACH_SIZE}(Jane,Daria),function(){function e(e,t){this.$node=e,this.selector=t,this.$target=null,this.currentValue=""}$.fn.startEmulateInputEvent=function(t){return"string"==typeof t?this.each(function(){var o=$(this),s=new e(o,t);
s.init(),o.data("inputEmulator",s)}):this},$.fn.stopEmulateInputEvent=function(){return this.each(function(){var t=$(this),o=t.data("inputEmulator");o instanceof e&&o.destroy(),t.data("inputEmulator",null)})},e.prototype.$doc=$(document),e.prototype.init=function(){"string"==typeof this.selector&&this.$node.on("focusin.inputEmulator",this.selector,this.startEmulate.bind(this)).on("focusout.inputEmulator",this.selector,this.stopEmulate.bind(this))},e.prototype.destroy=function(){this.stopEmulate(),this.$node.off(".inputEmulator")
},e.prototype.startEmulate=function(e){this.$target=$(e.currentTarget),this.currentValue=this.$target.val(),this.$target.on("keydown.inputEmulator keyup.inputEmulator",this.triggerInputEvent.bind(this)),this.$doc.on("selectionchange.inputEmulator",this.triggerInputEvent.bind(this))},e.prototype.stopEmulate=function(){this.$target&&this.$target.off(".inputEmulator"),this.$target=null,this.currentValue="",this.$doc.off(".inputEmulator")},e.prototype.triggerInputEvent=function(){if(this.$target){var e=this.$target.val();
e!==this.currentValue&&this.$target.trigger("input"),this.currentValue=e}},Daria.InputEventEmulator=e}(),function(){Daria.ComposeComponents.confirmations={_confirmations:{},addConfirmation:function(e,t){this._confirmations[e]=t},getConfirmation:function(e){return this._confirmations[e]},getConfirmations:function(){return _.map(this._confirmations,function(e){return e})}}}(),function(){var e="send-without-to",t=function(t){var o=t.get(".to"),s=t.get(".cc"),i=t.get(".bcc");return o||!s&&!i?!1:e};Daria.ComposeComponents.confirmations.addConfirmation(e,t)
}(),function(){var e="attachments-forgotten",t=["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении"],o=new RegExp(t.join("|"),"i"),s=function(t,s){if(t.hasAttach())return!1;var i=t.get(".send"),n=t.get(".subj");/^RE:/i.test(n)||(i=n+" "+i),i=i.replace(new RegExp("(?:^\\s*>.*$)|(?:[\n\r])","gmi"),""),i=i.replace(/<blockquote[^>]*>.*<\/blockquote>/gi,""),i=i.replace(/<[^>]+>/g,"");
var a=o.exec(i);if(!a)return!1;var r=[],c=2;return $.each([a.index,a.index+a[0].length-1],function(e,t){e=2*e-1;for(var o=c+1,s=!1,n=t,a=i.length;n>=0&&a>n;n+=e)if(/[\s,.!?\-+:;()]/i.test(i.charAt(n))){if(!s){if(!--o)break;s=!0}}else s=!1;r.push(n)}),s.stopWordGroup=$.trim(i.substring.apply(i,r)),e};Daria.ComposeComponents.confirmations.addConfirmation(e,s)}(),function(e,t){t.Signature=function(){e.extend(this,t.UI.IEvent()),this._log("create"),this.__init=!1,this._isMouseenter=!1,this._isMouseleave=!0,this._coordYBegin=0,this._coordYEnd=0,this._currentYCursor=0,this._limitRangeFind=100,this._maxSignLine=100,this._range=[],this._updateCoords=_.debounce(this._updateCoords,0),this._onInput=_.debounce(this._onInput,50)
};var o=t.Signature.prototype;o._log=function(){},o._mouseEnter=function(){this._isMouseenter||(this._isMouseenter=!0,this._isMouseleave=!1,this.trigger("mouseenter",[this]))},o._mouseLeave=function(){this._isMouseleave||(this._isMouseleave=!0,this._isMouseenter=!1,this.trigger("mouseleave",[this]))},o._mouseMove=function(e){return this._coordYBegin>=this._coordYEnd?void this._mouseLeave():(this._currentYCursor=e,void(this._currentYCursor>=this._coordYBegin&&this._currentYCursor<=this._coordYEnd?(this._mouseEnter(),this.trigger("mousemove",[this])):this._mouseLeave()))
},o._updateCoords=function(){var e=this._offset();e&&(this._log("_updateCoords"),(this._coordYBegin!==e.top||this._coordYEnd!==e.bottom)&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this])))},o.__onInput=function(){return this._log("__onInput"),this._range=this._findRange(),this._range.length?void this._updateCoords():(this._coordYBegin=0,this._coordYEnd=0,void this._mouseLeave())},o._onInput=function(t){t&&e.inArray(t.keyCode,[37,38,39,40,16,17,18])>-1||(this._log("_onInput"),this.__onInput())
},o._onClick=function(){this._range.length&&this._isMouseenter&&(this._log("_onClick"),this.trigger("click",[this]))},o._onScroll=function(){this._range.length&&(this._log("_onScroll"),this._updateCoords())},o.isMouseEntered=function(){return this._isMouseenter},o.offset=function(){return{top:this._coordYBegin,bottom:this._coordYEnd}},o.update=function(){this._range=this._findRange();var e=this._offset();e&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this]))
},o._destroy=function(e){this.__init&&(this._log("_destroy"),this.__init=!1,this._updateCoords.cancel(),this._onInput.cancel(),this._events.empty(),this._range=[],this._currentYCursor=0,this._coordYBegin=0,this._coordYEnd=0,this._isMouseenter=!1,this._isMouseleave=!0,e&&e.call(this))},o._init=function(e){this.__init||(this._log("_init"),this.__init=!0,e&&e.call(this),this.__onInput())},o.__offsetY=function(e){var t;return"undefined"!=typeof e.offsetY?t=e.offsetY:e.originalEvent&&"undefined"!=typeof e.originalEvent.layerY&&(t=e.originalEvent.layerY),t
},o.setFirstSignatureMatch=function(e){this._firstSignatureMatch=e},o.getFirstSignatureMatch=function(){return this._firstSignatureMatch||"--\\s"},o._offset=function(){},o.getLinesCount=function(){return 0},o._findRange=function(){return[]},o._onMouseMove=function(){},o._onMouseLeave=function(){},o._onMouseEnter=function(){},o.destroy=function(){},o.init=function(){},o.select=function(){},o.replace=function(){},o.get=function(){},o.getText=function(){}}(jQuery,Daria),function(e,t){t.SignatureTextarea=function(o){t.SignatureTextarea.superClass.constructor.apply(this,arguments),this._$node=e(o)
},Jane.extend(t.SignatureTextarea,t.Signature);var o=t.Signature.prototype;o._widthNode=function(){var e=0,t=this._$node[0].scrollWidth||this._$node[0].clientWidth;return window.getComputedStyle&&(e=window.getComputedStyle(this._$node[0],null).getPropertyValue("width"),e=-1!==e.indexOf("px")?parseFloat(e):0),e?Math.min(e,t):t},o._textCoords=function(t,o,s){this._$placeholder.width(this._widthNode()).text(t);var i=parseInt(this._$placeholder.css("top"),10),n=this._$placeholder[0].firstChild,a=document.createRange();
a.setStart(n,o),a.setEnd(n,s);var r=a.cloneRange(),c={};if(!Modernizr.msie&&!Modernizr.opera&&(r.getBoundingClientRect&&(c=r.getBoundingClientRect(),c={top:c.top,bottom:c.bottom}),!c.top&&!c.bottom&&r.getClientRects)){var l=r.getClientRects();l.length&&(c.top=l[0].top,c.bottom=l[l.length-1].bottom)}if(c.top||c.bottom){var d=e(window).scrollTop();c.top=c.top+d,c.bottom=c.bottom+d}else{r.surroundContents(this._highlight);var u=e(this._highlight);c.top=u.offset().top,c.bottom=c.top+u.height()}return c.top&&c.bottom?(c.top=c.top-i,c.bottom=c.bottom-i,c):null
},o._offset=function(){if(!this._range.length)return null;var e=this._$node.scrollTop();return{top:this._range[0].top-e,bottom:this._range[1].bottom-e}},o._findRange=function(){if(!this._lineHeight)return[];for(var e,t=new RegExp("^"+this.getFirstSignatureMatch()+"$","gm"),o=this._$node.val(),s=/^--------[^\-]+.*--------$/gm,i=[-1,-1],n=!1;null!==(e=s.exec(o));)n||(n=!0,i[0]=e.index),i[1]=s.lastIndex;var a,r,c=t.exec(o);if(c&&c.index>i[0]&&c.index<i[1]&&(t.lastIndex=i[1],c=t.exec(o)),c){a={simbol:c.index,simbolOffset:t.lastIndex+1,top:void 0};
var l,d=this._maxSignLine,u=/^.+$/gm,h=!1,p=[0,0],m=/^\s*>/,f=/^\s*$/;for(u.lastIndex=t.lastIndex;null!==(l=u.exec(o))&&d;){if(m.test(l[0])){h=!0;break}if(u.lastIndex>=i[0]&&u.lastIndex<=i[1])break;f.test(l[0])||(p=[u.lastIndex,p[0]]),d--}if(p=h&&p[1]?p[1]:p[0]?p[0]:a.simbolOffset-1){r={simbol:p,bottom:void 0};var g=this._textCoords(o,a.simbol,r.simbol);g?(a.top=g.top,r.bottom=g.bottom):(a=null,r=null)}}return a&&r?[a,r]:[]},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove"),this._mouseMove(this.__offsetY(e))
},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){return this._range.length?this._$node.val().slice(this._range[0].simbol,this._range[1].simbol):""},o.getText=function(){return this.get()},o.replace=function(e){if(this._range.length){var t=this._$node.val();t=t.substr(0,this._range[0].simbol)+e+t.substr(this._range[1].simbol),this._$node.val(t),this.__onInput()
}},o.select=function(){this._range.length&&t.setSelection(this._$node[0],this._range[0].simbol,this._range[1].simbol)},o.init=function(t,o){t=t||{},this._init(function(){this.setFirstSignatureMatch(t.firstSignatureMatch);var s=parseInt(this._$node.css("font-size"),10)||13;if(this._lineHeight=s+2,this._$node.css("line-height",this._lineHeight+"px"),this._highlight=document.createElement("span"),this._$placeholder=e("<pre></pre>").css({font:this._$node.css("font"),fontFamily:this._$node.css("fontFamily"),fontSize:this._$node.css("fontSize"),fontStyle:this._$node.css("fontStyle"),fontVariant:this._$node.css("fontVariant"),fontWeight:this._$node.css("fontWeight"),lineHeight:this._$node.css("lineHeight"),padding:this._$node.css("padding"),paddingTop:this._$node.css("paddingTop"),paddingBottom:this._$node.css("paddingTop"),paddingLeft:this._$node.css("paddingLeft"),paddingRight:this._$node.css("paddingRight"),margin:this._$node.css("margin"),marginTop:this._$node.css("marginTop"),marginBottom:this._$node.css("marginTop"),marginLeft:this._$node.css("marginLeft"),marginRight:this._$node.css("marginRight"),width:this._widthNode()+"px",wordWrap:"break-word",whiteSpace:"pre-wrap",visibility:"hidden",position:"absolute",top:"-9999px",left:"-9999px"}).appendTo("body"),this._$node.on("keyup",e.proxy(this._onInput,this)).on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("click",e.proxy(this._onClick,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("scroll",e.proxy(this._onScroll,this)),Modernizr.msie){var i=this,n=this._$node.css("overflow-y");
this._$node.css("overflow-y","hidden"),setTimeout(function(){i._$node.css("overflow-y",n)},0)}o&&o.call(this)})},o.destroy=function(){this._destroy(function(){this._highlight=null,this._$placeholder.remove(),this._$placeholder=null,this._lineHeight=0,this._$node.off("keyup",e.proxy(this._onInput,this)).off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("click",e.proxy(this._onClick,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("scroll",e.proxy(this._onScroll,this))
})},e.fn.signature=function(){return this.each(function(){this.signature||(this.signature=new t.SignatureTextarea(this))})},e.fn.signatureDestroy=function(){return this.each(function(){this.signature&&(this.signature.destroy(),this.signature=null,delete this.signature)})}}(jQuery,Daria),function(e,t){t.SignatureCkeditor=function(o){t.SignatureCkeditor.superClass.constructor.apply(this,arguments),this._ed=o,this._$node=e(this._ed.editable().$),this._isFirstSignature=!0,this._isNormalizeSupport="normalize"in document.createElement("div")
},Jane.extend(t.SignatureCkeditor,t.Signature);var o=t.SignatureCkeditor.prototype;o._offset=function(){if(!this._range.length)return null;var e,t,o;try{if(e=this._range[0][0].getBoundingClientRect(),!e.height)return null;if(t=this._range[1][0].getBoundingClientRect(),!t.height)return null;if(o=this._$node[0].getBoundingClientRect(),!o.height)return null}catch(s){return null}return{top:e.top-o.top,bottom:t.bottom-o.top}},o._findForwardRange=function(){var t=[-1,-1],o=this._ed.getData(!0);if("undefined"==typeof o)return t;
if(!/<div>--------[^\-]+.*--------<\/div>/i.test(o))return t;var s=this._$node[0],i=s.childNodes.length;if(!i)return t;for(var n,a=0,r=/^--------[^\-]+.*--------$/;i>a;a++)if(n=s.childNodes[a],"DIV"===n.nodeName&&r.test(e.text(n))){t[0]=a;break}for(;i--;)if(n=s.childNodes[i],"DIV"===n.nodeName&&r.test(e.text(n))){t[1]=i;break}return t},o._checkFirstRange=function(e){var o=t.Html2Text.html2text(e.innerHTML),s=new RegExp("^"+this.getFirstSignatureMatch()+"$","m"),i=s.exec(o);return i&&0===i.index?!0:!1
},o._findFirstRangeForward=function(e,t){var o,s,i=this._$node[0],n=i.childNodes.length,a=0;if(s=e?Math.min(this._limitRangeFind,n-this._limitRangeFind):Math.min(this._limitRangeFind,n),!(a>=s)){for(;s>a;a++)if(!(a>=t[0]&&a<=t[1])){var r=i.childNodes[a];if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRangeBack=function(e,t){var o,s,i=this._$node[0],n=i.childNodes.length,a=n-1;if(s=e?Math.max(this._limitRangeFind,n-this._limitRangeFind):Math.max(0,n-this._limitRangeFind),!(s>a)){for(;a>=s;--a)if(!(a>=t[0]&&a<=t[1])){var r=i.childNodes[a];
if(this._checkFirstRange(r)){o=r;break}}return o}},o._findFirstRange=function(){var e,t=this._findForwardRange();return this._isFirstSignature?(e=this._findFirstRangeForward(!1,t),e||(e=this._findFirstRangeBack(!0,t))):(e=this._findFirstRangeBack(!1,t),e||(e=this._findFirstRangeForward(!0,t))),e},o._findRange=function(){var t,o=this._findFirstRange();if(o){t=[];var s=this._maxSignLine,i=!1,n=/^--------[^\-]+.*--------$/,a=/^\s*>/,r=/^\s*$/,c=/<img[^>]*>/;e(o).nextAll().each(function(){if("BLOCKQUOTE"===this.nodeName)return i=!0,!1;
var o=e.text(this);return a.test(o)?(i=!0,!1):n.test(o)?!1:s?(r.test(o)?this.childNodes.length>0&&c.test(this.innerHTML)&&(t=[this,t[0]]):t=[this,t[0]],void s--):!1}),t=i&&t[1]?t[1]:t[0]?t[0]:o}return o&&t?[e(o),e(t)]:[]},o._createRange=function(){if(!this._range.length)return!1;var e=this._ed.createRange();return this._range[0][0]===this._range[1][0]?e.selectNodeContents(new CKEDITOR.dom.node(this._range[0][0])):(e.setStartBefore(new CKEDITOR.dom.node(this._range[0][0])),e.setEndAfter(new CKEDITOR.dom.node(this._range[1][0]))),e
},o._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove");var t=e.currentTarget.getBoundingClientRect(),o=e.clientY-t.top;this._mouseMove(o)},o._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},o._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},o.get=function(){return this._range.length?this._range[0][0]===this._range[1][0]?this._range[0]:this._range[0].nextUntil(this._range[1]).andSelf().add(this._range[1]):void 0
},o.getText=function(){var e=this.get();return e?e.map(function(){return t.Html2Text.html2text(this.innerHTML).replace(/^[\u0020\u00a0]+$/gm,"")}).get().join("\n"):""},o.replace=function(e){if(this._range.length){var t=this._createRange();this._ed.insertHtml(e,"html",t),this.__onInput()}},o.select=function(){if(!this._range.length)return!1;var e=this._createRange();return this._ed.getSelection().selectRanges([e]),!0},o.init=function(t,o){t=t||{},this._init(function(){"firstSignature"in t&&(this._isFirstSignature=Boolean(t.firstSignature)),this.setFirstSignatureMatch(t.firstSignatureMatch),this._$node.on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("scroll",e.proxy(this._onScroll,this)).on("keyup",e.proxy(this._onInput,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("click",e.proxy(this._onClick,this)),this._ed.on("setData",e.proxy(this.__onInput,this)),o&&o.call(this)
})},o.destroy=function(){this._destroy(function(){this._$node.off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("scroll",e.proxy(this._onScroll,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("click",e.proxy(this._onClick,this)).off("keyup",e.proxy(this._onInput,this)),this._ed.removeListener("setData",e.proxy(this.__onInput,this))})}}(jQuery,Daria),function(){function e(e,t){for(var o=e.length-1;o>=0;o--){var i=e.charAt(o);if(Daria.Bubble.SEPARATORS[i]){var n=e.substring(o+1).trim();
n&&t.unshift(n),e=s(e,o),o=e.length}}return e&&(t.unshift(e.trim()),e=""),e}function t(e,t){for(var i=0;i<e.length;i++){var n=e.charAt(i);if(">"===n){var a=e.substring(0,i+1).trim();if(a&&Daria.Bubble.REG_CONTACT.test(a)){var r=[];a=o(a,r),r.length&&t.push.apply(t,r),t.push(a),e=s(e,0,i+1),i=-1}}}return e.trim()}function o(e,t){for(var o=0;o<e.length;o++){var i=e.charAt(o);if(Daria.Bubble.SEPARATORS[i]){var n=e.substring(0,o).trim();(!n||Daria.Bubble.REG_EMAIL.test(n))&&(n&&t.push(n),e=s(e,0,o+1),o=-1)
}}return e.trim()}function s(e,t,o){return e.substr(0,t)+(o>0?e.substr(o):"")}Daria.Bubble=function(e){var t={};for(var o in this._fields){var s=_.unescape(e.getAttribute("data-contact-"+o));s=this._fields[o]?_.method(this._fields[o][0],s)(this):s,t[o]=s}if(!t.tid){if(_.isEmpty(t.value)){var i=Jane.FormValidation.contact2obj(e.innerText);t.name=i.name,t.email=this._fieldToArray(i.email)}if(!t.cid&&!_.isEmpty(t.email)){var n=ns.Model.get("abook-contacts").getContactDataByEmail(t.email[0]);n&&(t.cid=n.cid)
}if(t.cid){var a=ns.Model.get("abook-contact",{cid:t.cid});a.isValid()&&!t.name&&(t.name=a.getName())}t.value=this._fieldToArray(Jane.FormValidation.obj2contact({name:t.name,email:t.email[0]}))}this._data=t},Daria.Bubble.EMAIL_LEN_REQUEST=256,Daria.Bubble.REG_EMAIL=/^[^@\s,;]+@[^\.\s,;]+(\.[^\.]+)*\.[^@\.\s,;]{2,}$/,Daria.Bubble.REG_CONTACT=/^(.*)<[^<>]*>$/,Daria.Bubble.SEPARATORS={",":!0,";":!0},Daria.Bubble.tokenizer=function(o){for(var s=999,i=[],n=1;o&&s;)n>0?(o=t(o,i),n=-1):(o=e(o,i),n=1),s--;
return i},Daria.Bubble.update=function(e){var t=new Daria.Bubble(e);t.applyTo(e)},Daria.Bubble.toString=function(e){return _.unescape(e.getAttribute("data-contact-value"))||e.innerText},Daria.Bubble.node2object=function(e){var t=Daria.Bubble.toString(e),o=t.indexOf('"');o=-1!==o?o+1:0;var s=t.lastIndexOf('"');return s=s>o?s:t.length,{text:t,startOffset:o,endOffset:s}},Daria.Bubble.copy=function(e){return e.map(Daria.Bubble.toString).join(", ")},Daria.Bubble.checkPaste=function(e){return Jane.FormValidation.checkContacts(e)
},Daria.Bubble.prototype._fields={cid:null,tid:null,name:null,type:null,email:["_fieldToArray","_fieldToString"],value:["_fieldToArray","_fieldToString"]},Daria.Bubble.prototype.AVATAR_SIZE=20,Daria.Bubble.prototype._fieldToArray=function(e){return _.compact(Daria.Bubble.tokenizer(String(e||"").trim()))},Daria.Bubble.prototype._fieldToString=function(e){return String(e)},Daria.Bubble.prototype.toString=function(){return String(this._data.value)},Daria.Bubble.prototype.needUpdate=function(){return!this._data.tid&&!this._data.cid&&!this.haveInvalidEmails()&&this.getHeadEmail()&&this.getHeadEmail().length<Daria.Bubble.EMAIL_LEN_REQUEST?!0:!1
},Daria.Bubble.prototype.get=function(e){return _.get(this._data,e)},Daria.Bubble.prototype.setEmail=function(e){this._data.email=this._fieldToArray(e),this._data.value=this._fieldToArray(Jane.FormValidation.obj2contact({name:this._data.name,email:e}))},Daria.Bubble.prototype.appendEmail=function(e,t){this._data.email=_.uniq(this._data.email.concat(e));for(var o=Jane.FormValidation.obj2contact({name:t,email:e}),s=!1,i=0;i<this._data.value.length;){var n=Jane.FormValidation.contact2obj(this._data.value[i]);
n.email===e&&(n.name!==t&&this._data.value.splice(i,1,o),s=!0),i++}s||this._data.value.push(o)},Daria.Bubble.prototype.removeEmail=function(e){this._data.email=_.difference(this._data.email,[e]);for(var t=0;t<this._data.value.length;){var o=Jane.FormValidation.contact2obj(this._data.value[t]);o.email===e?this._data.value.splice(t,1):t++}},Daria.Bubble.prototype.getHeadEmail=function(){return this._data.email[0]},Daria.Bubble.prototype.getHeadPhone=function(){if(this._data.cid){var e=ns.Model.get("abook-contact",{cid:this._data.cid});
return _.get(e.get(".phone"),[0,"value"])}},Daria.Bubble.prototype.isGroup=function(){return Boolean(this._data.tid)},Daria.Bubble.prototype.isContact=function(){return Boolean(this._data.cid)},Daria.Bubble.prototype.haveExternalEmails=function(){for(var e=this._data.email.length;e--;)if(Jane.FormValidation.checkExternalEmail(this._data.email[e]))return!0;return!1},Daria.Bubble.prototype.haveInvalidEmails=function(){for(var e=this._data.email.length;e--;)if(!Jane.FormValidation.checkEmail(this._data.email[e]))return!0;
return!1},Daria.Bubble.prototype.getText=function(){return this._data.name||this.getHeadEmail()},Daria.Bubble.prototype.getAvatar=function(){var e={href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Picture_sprite mail-User-Picture-Noavatar"};if(this._data.tid)e={href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Picture_sprite mail-User-Picture-Group"};else if("wsContainer"===this._data.type)e={href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Picture-WsContainer"};
else if(!this.haveInvalidEmails()&&(e={email:_.escape(this.getHeadEmail()),name:_.escape(this.getText()),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar"},this._data.cid)){var t=ns.Model.get("abook-contact",{cid:this._data.cid});t.isValid()&&(e.ref=t.getRefByEmail(e.email))}return e},Daria.Bubble.prototype.applyTo=function(e){var t=ns.renderNode({isGroup:Boolean(this._data.tid),isContact:Boolean(this._data.cid),haveInvalidEmails:this.haveInvalidEmails(),haveExternalEmails:this.haveExternalEmails(),avatar:Daria.SocialAvatars2.register(this.getAvatar()),text:this.getText()},"bubble","compose2");
for(var o in this._data){var s=this._data[o];s=this._fields[o]?_.method(this._fields[o][1],s)(this):s,s&&e.setAttribute("data-contact-"+o,_.escape(s))}for(this._data.tid&&e.setAttribute("readonly","readonly");e.firstChild;)e.removeChild(e.firstChild);e.appendChild(t)}}(),ns.action.define("yabble.change-email",function(e,t){return Daria.Dropdown.closeAll(),ns.events.trigger(e,t),!0}),ns.action.copy("yabble.change-email","yabble.edit"),ns.action.copy("yabble.change-email","yabble.remove"),ns.action.copy("yabble.change-email","yabble.single-target"),ns.action.define("yabble.change-group",function(e,t){return ns.events.trigger(e,t),!0
}),ns.action.define("yabble.add-to-abook",function(e,t){Jane.Services.load("#contacts",function(){ns.View.create("abook-person-popup").open({where:$(window),how:{my:"center",at:"center",of:window,fixed:!0}},{email:[t.email],first_name:t.name,yabbleId:t.id})}),Daria.Dropdown.closeAll()}),function(e,t){Daria.Yabble=function(e){var t=this;this.id=Daria.Yabble.genId(),this.value={},e&&this.val(e),this.root=$(Daria.Yabble.getHTML()),this.text=this.root.find(".js-yabble-content"),this.input=this.root.find(".js-yabble-input"),this.$smsLink=this.root.find(".js-sms-open-link"),this.$smsLink.on("click",function(e){e.stopPropagation();
var o=t.value;t.$smsLink.trigger("sms-link-click",o)}),this.$smsLink.on("dblclick",function(e){e.stopPropagation()}),this.hideSmsLink(),Modernizr.msie&&this.root.on("selectstart",function(e){t.focused||e.preventDefault()}),$.isEmptyObject(this.value)||this.pasteValue()},Daria.Yabble.KEY={UP:38,LEFT:37,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:44,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SHIFT:16,SEMI:59,SPACE:32,META:91,END:35,HOME:36,C:67,X:88,V:86,A:65,Z:90,ALT:18};var o=0,s={contact:"mail-Yabble_contact",group:"mail-Yabble_group",unreachable:"mail-Yabble_unreachable",external:"mail-Yabble_external",selected:"mail-Yabble_selected",focused:"mail-Yabble_focused"};
Daria.Yabble.YC=s,Daria.Yabble.genId=function(){return o++},Daria.Yabble.getHTML=function(){return Daria.Yabble.template||(Daria.Yabble.template=$("<div></div>").html(Jane.tt("compose2:yabble"))),Daria.Yabble.template.html()},Daria.Yabble.template=null,Daria.Yabble.mergeContact=function(t,o){return"string"==typeof t&&(t=e.contact2obj(t)),"string"==typeof o&&(o=e.contact2obj(o)),o.email!=t.email?$.extend({},o):$.extend({},t,o)},Daria.Yabble.prototype={value:null,focused:!1,selected:!1,isContact:!1,isGroup:!1,isUnreachable:!1,isExternal:!0,doInput:function(e,t){var o=this.input[0];
switch(e){case"focus":try{(t||document.activeElement!=o)&&(o.focus(),o.select())}catch(s){Jane.ErrorLog.sendException("activeElement",s)}break;case"enable":o.removeAttribute("disabled");break;case"disable":o.setAttribute("disabled","disabled")}},focus:function(){if(!this.focused&&!this.isGroup){this.deselect(!0),this.focused=!0;var t=e.obj2contact(this.value),o=this.value.name;this.doInput("enable"),this.doInput("focus"),t&&(this.text.text(t),this.input.val(t),Daria.setSelection(this.input[0],o?1:0,o?o.length+1:t.length)),this.root&&this.root.length&&(Modernizr.msie&&this.root.css("min-width",this.root.parent().width()-this.root.position().left-20),this.root.attr("draggable",""),this.root.addClass(s.focused))
}},blur:function(e){this.focused&&(this.val(Daria.Yabble.mergeContact(this.value,this.getValue())),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},select:function(){return this.selected?void this.doInput("focus"):(this.blur(!0),this.selected=!0,this.root.addClass(s.selected),this.doInput("enable"),void this.doInput("focus"))},deselect:function(e){this.selected&&(e||this.doInput("disable"),this.root&&(this.root.removeClass(s.selected),this.selected=!1))
},validate:function(){this.value.email?(this.isUnreachable=!e.checkEmail(this.value.email),this.root.toggleClass(s.unreachable,this.isUnreachable),this.isExternal=e.checkExternalEmail(this.value.email),this.root.toggleClass(s.external,this.isExternal)):this.isUnreachable=!1},pasteValue:function(){var e=this.value.name||this.value.email,t=this.root.find(".js-yabble-avatar");if(t.length){var o;o=Daria.SocialAvatars2.register("wsContainer"===this.value.type?{href:!1,size:20,className:"mail-Yabble__avatar mail-User-Picture-WsContainer"}:this.value.email&&this.value.ref?{email:this.value.email,name:this.value.name||this.value.email,monogram:this.value.monogram,ref:this.value.ref,href:!1,size:20,className:"mail-Yabble__avatar"}:Array.isArray(this.value.contacts)?{href:!1,size:20,className:"mail-Yabble__avatar mail-User-Picture_sprite mail-User-Picture-Group"}:{href:!1,size:20,className:"mail-Yabble__avatar mail-User-Picture_sprite mail-User-Picture-Noavatar"}),t.replaceWith(o)
}this.input.val(this.val()),this.text.text(e),this.root.removeClass(s.focused),this.isContact=!!this.value.cid,this.isGroup=!!this.value.tid,this.root.toggleClass(s.contact,this.isContact),this.root.toggleClass(s.group,this.isGroup),this.validate()},userVal:function(){return this.input.val()},getValue:function(){var e=this.input,t=e.data("suggest")||$.trim(this.userVal()).replace(/(?:,|;)$/,"");return e.removeData("suggest"),t},val:function(o){return o===t?this.value.tid?$.map(this.value.contacts,function(t){return!t.ignored&&e.obj2contact(t)||null
}).join(", "):e.obj2contact(this.value):void(this.value="object"==typeof o?o:e.contact2obj(o))},showSmsLink:function(){this.$smsLink.removeClass("is-hidden")},hideSmsLink:function(){this.$smsLink.addClass("is-hidden")},destroy:function(){this.root.remove(),this.root=this.text=this.input=null},onkeypress:function(){this.focused&&this.text.text(this.userVal())},onkeyup:function(){this.focused&&this.text.text(this.userVal())}};var i=".b-mail-dropdown__box__content_yabble-",n={timeout:null,request:null,delay:150,template:"compose2:yabble-dropdown",json:{},toggle:function(e){var t=$(i+e.id).is(":visible");
n.close(e),t||(n.remove(e),this.yabble=e,this.getParams(),this.load())},close:function(e){"number"==typeof this.timeout?(clearTimeout(this.timeout),this.timeout=null):this.request?(this.request.notify("abort"),this.request=null):(Daria.Dropdown.closeCurrent(),e&&n.remove(e))},remove:function(e){$(i+e.id).remove()},getParams:function(){var e=this.yabble,t=e.id,o=e.value,s=_.escape(o.name||""),i=_.escape(o.email||"");switch(!0){case e.isPhone:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown-phone",this.json={email:i,id:t};
break;case e.isContact:this.params={cid:o.cid},this.handlers=["abook-contact"],this.template="compose2:yabble-dropdown-contact",this.json={email:i,id:t};break;case e.isGroup:this.params={tid:o.tid},this.handlers=["abook-contacts"],this.template="compose2:yabble-dropdown-group",this.json={id:t,email:$.map(o.contacts,function(e){return!e.ignored&&e.email||null})};break;case e.isUnreachable:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,name:s,email:i};break;
case e.fromMessage:this.params=null,this.handlers=null,this.template="message:dropdown-contact",this.json={id:t,email:i,name:s,my:e.my,cid:e.cid};break;default:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,email:i,name:s}}},load:function(){var e=this.delay;if(this.handlers){var t,o=$.now();this.request=ns.request(this.handlers,this.params).then(function(){e-=$.now()-o,t=!0,this.request=null,this.open(0>e?0:e)},this),t&&(this.request=null)}else this.open(e)
},initializeNanoislands:function(e){nb.init(e)},open:function(e){var t=this,o=this.yabble,s=i+o.id,n=$(Jane.tt(this.template,this.json,this.handlers,this.params));e="delay"in o?o.delay:e,this.initializeNanoislands(n),$(s).remove();var a=function(){t.timeout=null,Daria.Dropdown.toggle(null,{content:$(n).find(s),dropdown:t.yabble.root,handle:t.yabble.root}),o.value&&o.value.email&&ns.action.run("common.copy",{container:s,text:o.value.email,onmouseup:function(){$(document).trigger("b-mail-dropdown-closeall")
},doNotCloseDropdown:!0})};0>e?a():this.timeout=setTimeout(a,e)}};Daria.YabbleDropdown=n}(Jane.FormValidation),function(){var e=Jane.FormValidation,t={onlyFirstEmail:!0,joinName:!0},o=function(e,t){this.options=$.extend({},{maxItems:Number.MAX_VALUE,yabbleCtor:Daria.Yabble,yabbleType:"contact"},t||{}),this.id=Daria.Yabble.genId(),this.ids={},this.yabbles=[],this.strVal="",this.root=e,this.wrapper=e.find(".js-yabbles-container"),this.input=e.find(".js-yabbles-controller"),this.init(),this.multi=new Daria.YabbleMulti(this),Daria.YabbleHistory.start(this)
};o.actions=["yabble.change-email","yabble.change-group","yabble.edit","yabble.remove","yabble.add-to-abook","yabble.single-target"],o.yabbleEvents=["dblclick","paste","keydown","keypress","keyup","focusout","focusin"],o.directEvents=["mousedown","mouseup","click"],o.prototype={option:function(e,t){var o=arguments.length;return 1===o?this.options[e]:void(2===o&&(this.options[e]=t))},getEmails:function(){return _.uniq($.map(this.yabbles,function(e){return e.value.email}).sort())},recalcStrVal:function(e){e=e||{};
var t=[];$.each(this.yabbles,function(e,o){t.push(o.val())}),this.strVal=$.map(t,function(e){return e||null}).join(", "),this.root.find("input[type=hidden]").val(this.strVal),e.silent||this.trigger("change")},init:function(){var e=this;this.input.focus(function(){e.focus()}),$.each(o.directEvents,function(t,o){e["ondirect"+o]&&e.root.bind(o,function(t){e.e=t,e["ondirect"+o].apply(e,arguments)})}),$.each(o.yabbleEvents,function(t,o){e._setYabbleEvent(o)}),this.onactionRef=function(){e.onaction.apply(e,arguments)
},o.actions.forEach(function(t){ns.events.on(t,e.onactionRef)})},ondirectmousedown:function(e){if(!Daria.isLeftButton(e))return e.preventDefault(),void(Modernizr.opera||Modernizr.msie?this.add().focus():setTimeout(function(){this.add().focus()}.bind(this),200));var t=this.find("fromEvent",e);this.clicked=!1,this.mousedownId=null,t&&(this.mousedownId=t.id,this.onmousedown&&this.onmousedown(e,t))},ondirectmouseup:function(e){if(Daria.isLeftButton(e)&&this.mousedownId){var t=this.find("fromEvent",e),o=this.find("id",this.mousedownId);
this.onmouseup&&this.onmouseup(e,o),o!=t&&(this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null)}},ondirectclick:function(e){if(Daria.isLeftButton(e)){var t=this.find("fromEvent",e);if(this.mousedownId){var o=this.find("id",this.mousedownId);o!=t&&this.onmouseup&&this.onmouseup(e,o),this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null}t||this.clicked||($(e.target).hasClass("js-sms-open-link")||(this.directclick=!0),this.add().focus(),this.directclick=!1)}},onaction:function(e,t){if(t.id in this.ids){var o=this.find("id",t.id);
switch(e){case"yabble.change-email":o.value.email=t.email,o.pasteValue(),this.recalcStrVal(),o.select();break;case"yabble.change-group":$.each(o.value.contacts,function(e,o){o.cid==t.cid&&o.email==t.email&&(o.ignored=!o.ignored)}),this.recalcStrVal();break;case"yabble.edit":o.focus();break;case"yabble.single-target":this.trigger("single-target",o);break;case"yabble.remove":this.remove(o);break;case"yabble.add-to-abook":this.update(o,t.cid)}}},onclick:function(e,t){if(!t.focused){var o=t.select();
o||Daria.YabbleDropdown.toggle(t)}},ondblclick:function(e,t){Daria.YabbleDropdown.close(),t.focus()},onfocusin:function(e,t){e=e||$.Event("focusin",{target:this.root[0]});var o=this;if(Daria.composeParams){var s=this.input.closest(".js-compose-mail-input_to").length>0;Daria.composeParams["field-to-focused"]=s}var i=this.option("suggest");i&&(i.changeInputField(t.input[0]),t.focused?(i.setOptions({hide:function(){i.options.yabble.blur()},disabled:!1,timeoutOfCopyToSms:!0,yabble:t,previousValues:o.val().split(/,\s*/)}),this.directclick&&(i.show(""),setTimeout(function(){this.directclick=!1
}.bind(this)))):i.setOptions({disabled:!0,hide:Daria.nop})),t.id!=this.mousedownId&&Daria.YabbleDropdown.close(),this.input.attr("disabled","disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))},onfocusout:function(t,o){var s=this;if(this.mousedownId!=o.id){var i=this.option("suggest");if(i){if(i.dontClose)return;i.setOptions({hide:Daria.nop}),i.hide()}var n=$.trim(o.userVal()).replace(/(?:,|;)$/,"");if(n||o.input.data("suggest"))if(o.focused){if(Daria.YabbleHistory.push(s),Daria.YabbleHistory.ignore=!0,n.indexOf(",")>-1||n.indexOf(";")>-1){var a=e.splitContacts(n),r=[];
$.each(a,function(e,t){r.push(s.add(t,o))}),this.remove(o),"contact"===this.options.yabbleType&&this.resolveContacts(a,r)}else o.blur(),this.recalcStrVal(),o.isContact||o.isGroup||o.isUnreachable||"contact"===this.options.yabbleType&&this.resolveContacts([o.value],[o]);Daria.YabbleHistory.ignore=!1}else o.selected&&o.deselect();else this.remove(o);this.input.removeAttr("disabled"),this.root.trigger($.Event(t,{target:this.root[0]}))}},onkeydown:function(e,t){var o=this;switch(e.which){case Daria.Yabble.KEY.TAB:!e.shiftKey&&this.options.maxItems>this.yabbles.length&&(t.focused&&$.trim(t.userVal())||t.selected)&&(e.preventDefault(),this.add().focus());
break;case Daria.Yabble.KEY.RETURN:Daria.isCtrlPressed(e)||e.preventDefault(),this.multi.history.length>1?this.add().focus():$.trim(t.userVal())&&(t.focused?this.add().focus():(t.focus(),this.onfocusin(null,t)));break;case Daria.Yabble.KEY.BACKSPACE:case Daria.Yabble.KEY.DEL:if(this.multi.history.length>1)e.preventDefault(),this.multi.remove();else{var s=this.find(e.which==Daria.Yabble.KEY.DEL?"next":"prev",t),i=this.find(e.which==Daria.Yabble.KEY.DEL?"prev":"next",t);(t.focused&&!$.trim(t.userVal())&&(s||i)||t.selected)&&(e.preventDefault(),this.remove(t),s?s.select():i?i.select():this.add().focus())
}break;case Daria.Yabble.KEY.LEFT:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var n=this.find("prev",t);n&&n.select()}break;case Daria.Yabble.KEY.RIGHT:if(t.selected){e.preventDefault();var a=this.find("next",t);a?a.select():this.add().focus()}break;case Daria.Yabble.KEY.HOME:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var r=this.find("first");r&&r.select()}break;case Daria.Yabble.KEY.END:if(t.selected){e.preventDefault();var c=this.find("last");c&&c.select()
}break;default:if(t.focused)Daria.isCtrlPressed(e)&&!$.trim(t.val())&&(e.which==Daria.Yabble.KEY.A?this.multi.selectAll():e.which==Daria.Yabble.KEY.Z&&Daria.YabbleHistory.pop(this));else if(Daria.isCtrlPressed(e))switch(e.which){case Daria.Yabble.KEY.C:this.multi.onCtrlC(t);break;case 17:case 91:case 224:break;case Daria.Yabble.KEY.V:o.add().focus();break;case Daria.Yabble.KEY.X:o.multi.history.length&&(o.multi.onCtrlX(t),setTimeout(function(){o.multi.remove()},16));break;case Daria.Yabble.KEY.A:this.multi.selectAll();
break;case Daria.Yabble.KEY.Z:Daria.YabbleHistory.pop(this);break;default:o.add().focus()}else e.which!=Daria.Yabble.KEY.SHIFT&&this.add().focus()}},onkeypress:function(t,o){var s,i=this;switch(t.which){case Daria.Yabble.KEY.SPACE:case Daria.Yabble.KEY.SEMI:case Daria.Yabble.KEY.COMMA:if(s=o.userVal().replace(/[,;\s]/g,""),o.focused&&s){if(t.which===Daria.Yabble.KEY.SPACE&&!e.checkEmail(s))break;setTimeout(function(){i.add().focus()},0)}else t.preventDefault()}},onpaste:function(e,t){var o=this;setTimeout(function(){o.add().focus(),t.isUnreachable&&(t.focus(),Daria.setSelection(t.input[0],9999))
},0)},add:function(e,t){if(this.options.maxItems<=this.yabbles.length){var o=this.find("last");return o&&o.input&&o.input.val()?(o.select(),this.recalcStrVal()):o&&o.focus(),{focus:$.noop}}var s=this.multi.wrap(new this.options.yabbleCtor(e)),i=t&&$.inArray(t,this.yabbles);return this.ids[s.id]=!0,e&&Daria.YabbleHistory.push(this),i>-1?(s.root.insertBefore(t.root),this.yabbles.splice(i,0,s)):(this.wrapper.append(s.root),this.yabbles.push(s)),s},showSmsYabble:function(){this.yabbles.forEach(function(e){e.showSmsLink&&e.showSmsLink()
})},hideSmsYabble:function(){this.yabbles.forEach(function(e){e.hideSmsLink&&e.hideSmsLink()})},update:function(e,o){ns.request("abook-contact",{cid:o}).then(function(o){var s=o[0],i=s.getContactInfo(t);$.isEmptyObject(i)||(e.val(i),e.pasteValue()),e.select()})},remove:function(e,t){var o=$.inArray(e,this.yabbles);if(-1!==o){Daria.YabbleHistory.push(this),this.yabbles.splice(o,1),delete this.ids[e.id],Daria.YabbleDropdown.close(e),e.destroy();var s=this.option("suggest");s&&s.destroy(),this.recalcStrVal(t)
}},find:function(e,t){var o;if("fromEvent"==e)return o=$(t.target).closest(".js-yabble",this.wrapper[0])[0],o&&this.find("target",o);if("first"==e)return this.yabbles[0];if("last"==e)return this.yabbles[this.yabbles.length-1];for(var s=0;s<this.yabbles.length;s++)if(o=this.yabbles[s],"target"===e){if(o.root[0]===t)return o}else if("prev"===e||"next"===e){if(o===t){if("prev"===e)return this.yabbles[s-1];if("next"===e)return this.yabbles[s+1]}}else if("id"===e){if(o.id==t)return o}else if(o[e])return o
},_setYabbleEvent:function(e,t){var o=this;t=t||this["on"+e],this.root.on(e,".js-yabble",function(s){if(o.e=s,"focusout"!=e||"input"==s.target.tagName.toLowerCase()){var i=o.find("target",s.currentTarget);i&&(t&&t.call(o,s,i),i["on"+e]&&i["on"+e].call(i,s))}})},resolveContacts:function(e,o){if(e.length){var s=this;o=o||this.yabbles;var i,n=1/0,a=[];e.forEach(function(e){e.email.length<256&&(n+=e.email.length+1,n>256&&(n=0,i=[],a.push(i)),i.push(e.email))}),a.forEach(function(i){var n=[],a=i.join(",");
n.push({id:"abook-contacts",params:{emails:a}}),Daria.Config.workspace&&n.push({id:"abook-contacts",params:{emails:a,shared:1}}),ns.request(n).then(function(n){var a=!1,r=n[0].getContactsInfoByEmails(i,t),c=n[1]?n[1].getContactsInfoByEmails(i,_.extend({shared:!0},t)):[],l=c.concat(r);$.each(e,function(e,t){var s=t.email,i=o[e];if(i&&i.value.email==s)for(var n=l.length;n--;)if(s==l[n].email)return a=!0,i.val(Daria.Yabble.mergeContact(l[n],i.value)),i.pasteValue(),!0}),a&&s.recalcStrVal()})})}},val:function(t){var o=this;
if(void 0===t)return this.strVal;for(;this.yabbles[0];)this.remove(this.yabbles[0],{silent:!0});if("string"==typeof t&&t){var s;s="contact"===this.options.yabbleType?e.splitContacts(t):t.split(/[;\s]/),$.each(s,function(e,t){o.add(t)}),"contact"===this.options.yabbleType&&(o.recalcStrVal(),o.resolveContacts(s))}else $.isArray(t)&&($.each(t,function(e,t){o.add(t)}),"contact"===this.options.yabbleType&&(o.recalcStrVal(),o.resolveContacts(t)));Daria.YabbleHistory.ignore||Daria.YabbleHistory.start(this)
},focus:function(e){e&&(this.directclick=!0),this.add().focus()},isFocused:function(){return _.some(this.yabbles,"focused",!0)},validate:function(){for(var e=this.yabbles.length;e--;)if(this.yabbles[e].isUnreachable)return!1;return!0},destroy:function(){var e=this;this.val(""),o.actions.forEach(function(t){ns.events.off(t,e.onactionRef)}),this.root.unbind(),this.input.unbind(),this.multi.destroy(),Daria.YabbleHistory.stop(this);var t=this.option("suggest");t&&t.destroy()}},no.extend(o.prototype,ns.Events),Daria.Yabbles=o
}(),function(){var e=Daria.Yabble,t=Jane.FormValidation,o=function(e){this.options=$.extend({},o.defaultOptions,$.isPlainObject(e)?e:{root:e}),Daria.Yabbles.call(this,this.options.root,this.options),this.options.draggable||this.root.off("dragstart",".b-yabble").off("drag",".b-yabble").off("dragend",".b-yabble").unbind("dragover").unbind("dragenter").unbind("dragleave").unbind("drop")};Jane.extend(o,Daria.Yabbles),o.defaultOptions={root:null,autocomplete:!1,draggable:!0,dropdown:Daria.YabbleDropdown,yabble:e,maxItems:Number.MAX_VALUE,placeholder:!1},o.prototype.disabled=function(e){e="boolean"==typeof e?e:!0,this.root.toggleClass("b-mail-input_yabbles__disabled",e)
},o.prototype.isDisabled=function(){return this.root.hasClass("b-mail-input_yabbles__disabled")},o.prototype.placeholder=function(e){if(!this.options.placeholder)return!1;switch(e){case"show":if(this.yabbles.length)return;$('<span class="js-yabbles-placeholder b-mail-input_yabbles__placeholder"></span>').text(this.root.data("placeholder")||this.options.placeholder).appendTo(this.wrapper);break;case"hide":if(!this.yabbles.length)return;this.wrapper.find(".js-yabbles-placeholder").remove()}},o.prototype.dropdown=function(e){if(!this.options.dropdown)return!1;
var t=Array.prototype.slice.call(arguments,1);this.options.dropdown[e].apply(this.options.dropdown,t)},o.prototype.autocomplete=function(e){function t(e){e.input.__autocompleter||(e.input.__autocompleter=!0,i&&a.bindField({field:e.input,focus:1,currentValue:this.val()}),n&&a.changeInputField(e.input[0]).setOptions({yabble:e,timeoutOfCopyToSms:!0,hide:function(){e.blur()},select:function(){Daria.setZeroTimeout(function(){var t=s.add();t?t.focus():e.blur()})},previousValues:this.val().split(/,\s*/)}))
}function o(e){e.input.__autocompleter&&(delete e.input.__autocompleter,a.abort(),a.destroy())}var s=this,i=this.options.autocomplete instanceof Daria.Autocompleter,n=this.options.autocomplete instanceof Daria.Suggest;if("boolean"==typeof this.options.autocomplete&&!this.options.autocomplete)return!1;if("object"!=typeof this.options.autocomplete)return!1;var a;if(!i&&!n)return!1;a=this.options.autocomplete;var r=Array.prototype.slice.call(arguments,1);switch(e){case"start":t.apply(this,r);break;case"stop":o.apply(this,r);
break;case"get":return i?a:!1}},o.prototype.init=function(){var e=this;this.input.focus(function(){e.focus()}),$.each(Daria.Yabbles.directEvents,function(t,o){e["ondirect"+o]&&e.root.bind(o,function(t){e.isDisabled()||(e.e=t,e["ondirect"+o].apply(e,arguments))})}),$.each(Daria.Yabbles.yabbleEvents,function(t,o){e.on(o)}),this.onactionRef=function(){e.isDisabled()||e.onaction.apply(e,arguments)},Daria.Yabbles.actions.forEach(function(t){ns.events.on(t,e.onactionRef)}),this.placeholder("show")},o.prototype.on=function(e,t){var o=this;
t=t||this["on"+e],this.root.on(e,".b-yabble",function(s){if(!o.isDisabled()&&(o.e=s,"blur"!=e||"input"==s.target.tagName.toLowerCase())){var i=o.find("target",s.currentTarget);i&&(t&&t.call(o,s,i),i["on"+e]&&i["on"+e].call(i,s))}})},o.prototype.add=function(e,t){if(this.options.maxItems<=this.yabbles.length){var o=this.find("last");return o&&o.focus(),!1}var s=this.multi.wrap(new this.options.yabble(e)),i=t&&$.inArray(t,this.yabbles);return this.ids[s.id]=!0,e&&Daria.YabbleHistory.push(this),i>-1?(s.root.insertBefore(t.root),this.yabbles.splice(i,0,s)):(this.wrapper.append(s.root),this.yabbles.push(s)),this.placeholder("hide"),s
},o.prototype.remove=function(e){var t=$.inArray(e,this.yabbles);-1!=t&&(Daria.YabbleHistory.push(this),this.yabbles.splice(t,1),delete this.ids[e.id],this.dropdown("close",e),e.destroy(),this.recalcStrVal(),this.placeholder("show"))},o.prototype.onfocus=function(e,t){t.focused&&this.autocomplete("start",t),t.id!=this.mousedownId&&this.dropdown("close"),this.input.attr("disabled","disabled")},o.prototype.onblur=function(e,o){var s=this;if(this.mousedownId!=o.id){this.autocomplete("stop",o);var i=$.trim(o.userVal()).replace(/(?:,|;)$/,"");
if(i)if(o.focused){if(Daria.YabbleHistory.push(s),Daria.YabbleHistory.ignore=!0,i.indexOf(",")>-1||i.indexOf(";")>-1){var n=t.splitContacts(i),a=[];$.each(n,function(e,t){var i=s.add(t,o);i&&a.push(i)}),this.remove(o),this.resolveContacts(n,a)}else o.blur(),this.recalcStrVal(),o.isContact||o.isGroup||o.isUnreachable||this.resolveContacts([o.value],[o]);Daria.YabbleHistory.ignore=!1}else o.selected&&o.deselect();else s.remove(o);this.input.removeAttr("disabled")}},o.prototype.onclick=function(e,t){if(!t.focused){var o=t.select();
o||this.dropdown("toggle",t)}},o.prototype.ondblclick=function(e,t){this.dropdown("close"),t.focus()},o.prototype.ondirectclick=function(e){if(Daria.isLeftButton(e)){var t=this.find("fromEvent",e);if(this.mousedownId){var o=this.find("id",this.mousedownId);o!=t&&this.onmouseup&&this.onmouseup(e,o),this.onclick&&this.onclick(e,o),this.clicked=!0,this.mousedownId=null}if(!t&&!this.clicked){var s=this.add();s&&s.focus()}}},o.prototype.onkeydown=function(e,t){var o,s=this;if(e.altKey)return e.stopPropagation&&e.stopPropagation(),e.preventDefault(),!1;
switch(e.which){case Daria.Yabble.KEY.TAB:!e.shiftKey&&this.options.maxItems>this.yabbles.length&&(t.focused&&$.trim(t.userVal())||t.selected)&&(e.preventDefault(),o=this.add(),o&&o.focus());break;case Daria.Yabble.KEY.RETURN:Daria.isCtrlPressed(e)||e.preventDefault(),this.multi.history.length>1?(o=this.add(),o&&o.focus()):$.trim(t.userVal())&&(t.focused?(o=this.add(),o&&o.focus(),o||(t.blur(),setTimeout(function(){t.select()},10),this.recalcStrVal())):(t.focus(),this.onfocus({},t)));break;case Daria.Yabble.KEY.BACKSPACE:case Daria.Yabble.KEY.DEL:if(this.multi.history.length>1)e.preventDefault(),this.multi.remove();
else{var i=this.find(e.which==Daria.Yabble.KEY.DEL?"next":"prev",t),n=this.find(e.which==Daria.Yabble.KEY.DEL?"prev":"next",t);(t.focused&&!$.trim(t.userVal())&&(i||n)||t.selected)&&(e.preventDefault(),this.remove(t),i?i.select():n?n.select():(o=this.add(),o&&o.focus()))}break;case Daria.Yabble.KEY.LEFT:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var a=this.find("prev",t);a&&a.select()}break;case Daria.Yabble.KEY.RIGHT:if(t.selected){e.preventDefault();var r=this.find("next",t);
r?r.select():(o=this.add(),o&&o.focus())}break;case Daria.Yabble.KEY.HOME:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var c=this.find("first");c&&c.select()}break;case Daria.Yabble.KEY.END:if(t.selected){e.preventDefault();var l=this.find("last");l&&l.select()}break;case Daria.Yabble.KEY.SPACE:var d=this.autocomplete("get");if(d&&1==d.results.length){e.which=Daria.Yabble.KEY.SEMI,this.onkeypress(e,t);break}default:if(t.focused)Daria.isCtrlPressed(e)&&!$.trim(t.val())&&(e.which==Daria.Yabble.KEY.A?this.multi.selectAll():e.which==Daria.Yabble.KEY.Z&&Daria.YabbleHistory.pop(this));
else if(Daria.isCtrlPressed(e))switch(e.which){case Daria.Yabble.KEY.C:this.multi.onCtrlC(t);break;case 17:case 91:case 224:break;case Daria.Yabble.KEY.V:o=s.add(),o&&o.focus();break;case Daria.Yabble.KEY.X:s.multi.history.length&&(s.multi.onCtrlX(t),setTimeout(function(){s.multi.remove()},16));break;case Daria.Yabble.KEY.A:this.multi.selectAll();break;case Daria.Yabble.KEY.Z:Daria.YabbleHistory.pop(this);break;default:o=s.add(),o&&o.focus()}else e.which!=Daria.Yabble.KEY.SHIFT&&(o=this.add(),o&&o.focus())
}},o.prototype.onkeypress=function(e,t){var o=this;switch(e.which){case Daria.Yabble.KEY.SEMI:case Daria.Yabble.KEY.COMMA:t.focused&&t.userVal().replace(/,|;/g,"")?setTimeout(function(){var e=o.add();e&&e.focus()},0):e.preventDefault()}},o.prototype.onpaste=function(){var e=this;setTimeout(function(){var t=e.add();t&&t.focus()},0)},o.prototype.focus=function(){var e=this.add();e&&e.focus()},Daria.Yabbles2=o}(),function(){var e=Daria.Yabble.prototype,t=Daria.YabbleMulti=function(e){this.set=e,this.clear(),(new Image).src="//yastatic.net/mail/_/8tYjtQAGDGww1hyG-DO0JdxRzM0.png"
};t.prototype={history:null,push:function(e){this.pop(e),this.history.push(e),this.focusLast=void 0},pop:function(e){for(var t=this.history.length;t--;)this.history[t]==e&&this.history.splice(t,1)},clear:function(){this.shiftFirst=void 0,this.focusLast=void 0,this.history=[]},first:function(){return this.history[0]},last:function(){return this.history[this.history.length-1]},val:function(){return $.map(this.history,function(e){return e.val()}).join(", ")},ids:function(){return $.map(this.history,function(e){return e.id
})},wrap:function(t){var o=this;return t.deselect=function(){var e=o.set.mousedownId;if(!o.set.find("id",e)){var t=o.ids().join(",");setTimeout(function(){t==o.ids().join(",")&&o.deselectAll()},0)}},t.select=function(){var s=o.set.e||{},i=Daria.isCtrlPressed(s),n=s.shiftKey,a=$.inArray(s.which,[Daria.Yabble.KEY.LEFT,Daria.Yabble.KEY.RIGHT])>-1;return n&&(!a||0!==o.history.length)||i&&!a?(n?o.selectTo(t):t.selected?(o.pop(t),e.deselect.apply(t),o.last()&&e.select.apply(o.last())):(e.select.apply(t,arguments),o.push(t)),!0):(o.deselectAll(),o.push(t),e.select.apply(this,arguments),void 0)
},t.focus=function(){var s=o.set.find("prev",t);o.deselectAll(),setTimeout(function(){o.focusLast=s},16),e.focus.apply(t,arguments)},t.destroy=function(){o.pop(t),e.destroy.apply(t,arguments)},t},onCtrlC:function(e){if(this.history.length>1){var t=this.val();e.input.val(t),e.doInput("focus",!0),e.input.one("keyup blur",function(){e.root&&e.doInput("focus",!0)})}},remove:function(){var e=this;Daria.YabbleHistory.push(this.set),Daria.YabbleHistory.ignore=!0,$.each(this.history.slice(),function(t,o){e.set.remove(o)
});var t=e.set.add();t&&t.focus(),Daria.YabbleHistory.ignore=!1},selectAll:function(){var t=this,o=$.map(this.set.yabbles,function(e){return e.selected?null:e});$.each(o,function(o,s){s&&!s.focused&&(e.select.apply(s),t.push(s))})},selectTo:function(t){var o=this,s=this.shiftFirst||this.focusLast||this.last()||this.set.yabbles[0];this.deselectAll(),this.shiftFirst=s;for(var i=$.inArray(s,this.set.yabbles),n=$.inArray(t,this.set.yabbles),a=i>n?"prev":"next";s&&s!=t;)e.select.apply(s),o.push(s),s=this.set.find(a,s);
e.select.apply(t),o.push(t)},deselectAll:function(){this.clear(),$.each(this.set.yabbles,function(t,o){e.deselect.apply(o)})},unwrap:function(){},destroy:function(){this.clear()}},t.prototype.onCtrlX=t.prototype.onCtrlC}(),function(){Daria.YabbleHistory={sets:{},history:{},ignore:!1,start:function(e){this.history[e.id]=[],this.sets[e.id]=e},stop:function(e){delete this.history[e.id]},key:function(e){return $.map(e,function(e){return e.email||""}).join(",")},values:function(e){return $.map(e.yabbles,function(e){return!$.isEmptyObject(e.value)&&$.extend({},e.value)||null
})},push:function(e,t){if(!this.ignore&&this.history[e.id]){var o=this.history[e.id],s=o[o.length-1],i=this.values(e),n=this.key(i);if(s&&s.key==n)t&&(s.link=t);else{var a={values:i,key:n};t&&(a.link=t),o.push(a)}}},pop:function(e){this.ignore=!0;var t=this.history[e.id];if(t&&t.length){var o=t.pop();e.val(o.values);var s=e.add();if(s&&s.focus(),o.link)for(var i in this.history){var n=this.history[i];n.length&&o.link==n[n.length-1].link&&this.pop(this.sets[i])}}this.ignore=!1}}}(),Daria.YabblePhone=function(){Daria.Yabble.apply(this,arguments)
},Jane.extend(Daria.YabblePhone,Daria.Yabble),Daria.YabblePhone.prototype.validate=function(){var e=this.value;e?(this.isUnreachable=!Jane.FormValidation.checkPhoneNumber(e),this.root.toggleClass(Daria.Yabble.YC.unreachable,this.isUnreachable)):this.isUnreachable=!1},Daria.YabblePhone.prototype.blur=function(e){this.focused&&(this.val(this.getValue()),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},Daria.YabblePhone.prototype.val=function(e){return void 0===e?this.value:void(this.value="object"==typeof e?e.phone:e)
},Daria.YabblePhone.prototype.pasteValue=function(){var e=this.value;this.input.val(this.val()),this.text.text(e),this.root.removeClass(Daria.Yabble.YC.focused),this.isContact=!0,this.isPhone=!0,this.isGroup=!1,this.root.toggleClass(Daria.Yabble.YC.contact,this.isContact),this.root.toggleClass(Daria.Yabble.YC.group,this.isGroup);var t=this.root.find(".js-yabble-avatar");if(t.length){var o=Daria.SocialAvatars2.register({href:!1,size:20,className:"mail-Yabble__avatar mail-User-Picture_sprite mail-User-Picture-Noavatar"});
t.replaceWith(o)}this.validate()},function(){var e=Daria.Yabbles;e.yabbleEvents.push("dragstart","drag","dragend"),e.directEvents.push("dragover","dragenter","dragleave","drop");var t,o={},s=function(e){return e.originalEvent.dataTransfer},i={timeouts:{},on:function(e,t){this.timeouts[e]||(this.timeouts[e]=setTimeout(function(){t(),this.timeouts[e]=null}.bind(this),100))},clear:function(e){this.timeouts[e]&&(clearTimeout(this.timeouts[e]),this.timeouts[e]=null)}};$.extend(e.prototype,{ondragstart:function(e,i){if(!i.focused){var n=this.multi;
t=!1,n.history.length>1?($.each(n.history,function(e,t){o[t.id]=$.extend({},t.value)}),"setDragImage"in s(e)&&s(e).setDragImage($('<img src="//yastatic.net/mail/_/8tYjtQAGDGww1hyG-DO0JdxRzM0.png"/>')[0],30,10),s(e).setData("Text",n.val())):(o[i.id]=$.extend({},i.value),s(e).setData("Text",i.val())),s(e).effectAllowed="all"}},ondrag:function(){},ondragend:function(){var e=this;setTimeout(function(){t?(Daria.YabbleHistory.push(e,Object.keys(o).join(",")),Daria.YabbleHistory.ignore=!0,$.each(o,function(t){e.remove(e.find("id",t))
}),Daria.YabbleHistory.ignore=!1):e.multi.deselectAll(),e.mousedownId=null,t=!1,o={}},0)},ondirectdragenter:function(){i.clear(this.id),this.trigger("dragenter")},ondirectdragover:function(e){e.preventDefault(),i.clear(this.id),s(e).dropEffect=$.isEmptyObject(o)?"copy":"move"},ondirectdragleave:function(){i.on(this.id,function(){this.trigger("dragleave")}.bind(this))},ondirectdrop:function(e){var i=this;e.preventDefault(),Daria.YabbleHistory.push(i,Object.keys(o).join(",")),Daria.YabbleHistory.ignore=!0;
var n,a;if($.isEmptyObject(o)){var r=$.trim(s(e).getData("Text")||"");if(r){if(r=r.replace(/\n/g,","),r.indexOf(",")>-1||r.indexOf(";")>-1){var c=Jane.FormValidation.splitContacts(r);n=$.map(c,function(e){return i.add(e)||null}),i.recalcStrVal(),i.resolveContacts(c,n)}else{var l=this.add(r);l&&(i.recalcStrVal(),i.resolveContacts([l.value],[l]))}a=this.add(),a&&a.focus()}}else n=[],$.each(o,function(e,o){if(!i.find("id",e)){t=!0;var s=i.add(o);s&&n.push(s)}}),t&&(i.recalcStrVal(),i.resolveContacts(o,n),a=i.add(),a&&a.focus());
Daria.YabbleHistory.ignore=!1,this.trigger("drop")}})}(),function(){if("ontouchend"in window&&/iPad|iPhone/.test(navigator.userAgent)){var e=Daria.Yabble.KEY,t=Daria.Yabbles;t.directEvents=["touchend"];var o=t.prototype.onkeydown;$.extend(t.prototype,{ondirecttouchend:function(e){var t=this.find("fromEvent",e);if(t&&this.onclick&&(!t.focused||t.userVal()))this.onclick(e,t);else{var o=this.add();o&&o.focus()}},onkeydown:function(t,s){if(t.which==e.BACKSPACE||t.which==e.DEL){var i=this.find(t.which==e.DEL?"next":"prev",s),n=this.find(t.which==e.DEL?"prev":"next",s);
if(s.focused&&!$.trim(s.userVal())&&(i||n))t.preventDefault(),i?this.remove(i):n&&this.remove(n);else if(s.selected)if(t.preventDefault(),this.remove(s),i)i.select();else if(n)n.select();else{var a=this.add();a&&a.focus()}}else o.apply(this,arguments)}})}}(),function(){ns.Model.define("do-attach-file-status",{params:{oid:null}})}(),function(){ns.Model.define("do-attach-file-store",{params:{file:null}})}(),function(){var e=ns.ModelStatic,t=["attachments.added","attachments.appended","attachments.updated","attachments.removed","attachments.failed"];
ns.Model.define("compose-attachments",{params:{ids:null,oper:null},ctor:function(){this._attachments=null,this.processCollectionEvent=this.processCollectionEvent.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this,t=ns.Model.info("message-body").calculateParamsForMessageBody(this.params);return t?ns.request(["message-body","compose-message"],t).then(function(t){e._initByModels(t[0],t[1])
}):(e.setData({}),vow.resolve())},init:function(e){this._attachments?this._attachments.setOptionsAndInit(e):(this._attachments=new Daria.AttachmentCollection2(e),this.bindEventsToAttachments())},_initByModels:function(e,t){this.setData({}),this._mMessageBody=e,this._mComposeMessage=t;var o=new Daria.AttachmentCollection2;o.mComposeMessage=t,this._attachments=o,this.bindEventsToAttachments(),t.isReplyAny()||_(e.getAttachments()).reject("inline").forEach(this._addAttachData,this).value()},_addAttachData:function(e){this._attachments&&this._attachments.addAttachToCollection(Daria.Attachment2.fromMessageBody(e,this._mMessageBody,this._mComposeMessage),{silent:!0,processAttachSize:!1})
},destroy:function(){e.prototype.destroy.apply(this,arguments),this.unbindEventsFromAttachments(),this._attachments&&(this._attachments.reset(),this._attachments=null)},bindEventsToAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.on(e,this.processCollectionEvent)},this)},unbindEventsFromAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.off(e,this.processCollectionEvent)},this)},processCollectionEvent:function(e,t){this.trigger("ns-model:"+e,t)
},addAttach:function(e){this._attachments&&(e.resource?this._attachments.addDiskAttach(e.id,e.resource):this._attachments.add(e.input,e.files))},drawAttaches:function(){if(this._attachments){var e=this.params.ids||Daria.getPageComposeIds();this._attachments.redrawAttachesBulk(null,e)}},updateAfterSave:function(e,t){this._attachments&&this._attachments.updateAfterSave(e,t,!0)},isUploading:function(){return this._attachments&&this._attachments.isUploading()},isFailed:function(){return this._attachments?this._attachments.isFailed():!1
},hasFiles:function(){return this._attachments&&this._attachments.hasFiles()},retryAttach:function(e){this._attachments.retryAttach(e)}}})}(),function(){ns.Model.define("disk-default-folders",{methods:{isPhotostream:function(e){return e&&this.get(".photostream")===e}}})}(),function(e,t){function o(t){t.meta&&t.meta.sizes&&$.each(t.meta.sizes,function(o,r){"mail"===t.service?-1===r.url.indexOf("yandex.net")&&(r.url=n(r.url,a())):(r.url=i(r.url,e.Config["downloader-prefix"]+"."+a()),"ua"===a()&&(r.url=n(r.url,"ru"))),r.url=s(r.url)
})}function s(e){return e.replace(/^(https?:)/,"")}function i(e,t){return e.replace(/((https?\:)?\/\/)?[^\/]*/,t)}function n(e,t){var o=e.match(/(?:(?:https?\:)?\/\/)?[^\/]*/g)[0];return e.replace(o,o.replace(/(com\.tr|[^\.]+)$/,t))}function a(){var e;if(location.host.match(/\.com\.tr$/))e="com.tr";else{var o=location.host.split(".");e=o.pop(),"ru"!==e&&"com"!==e&&"ua"!==e&&(e=r(t.Config.locale))}return e}function r(e){switch(e){case"tr":return"com.tr";case"uk":return"ua";case"ru":return"ru";default:return"com"
}}var c=null;ns.Model.define("disk-resources",{params:{path:null,offset:null,sort:null,order:null},methods:{cancelledAttachPaths:[],getDefaultSort:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"etime":"name"},removeAttach:function(e){this.cancelledAttachPaths.push(e)},getDefaultOrder:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"0":"1"},deselect:function(){var e=c;c=null,ns.events.trigger("disk-resources.selected",{before:e})},select:function(e){if(e&&e!==c){var t=c;
c=e,ns.events.trigger("disk-resources.selected",{before:t,now:e})}},getSelected:function(){return c},extractError:function(e){return 404==jpath(e,".error.http_status")[0]?(ns.events.trigger("disk-resources.not-found",e.error),e.data={},null):e.error},preprocessData:function(e){var t=jpath(e,".resource.resource")[0];if(Array.isArray(t)){if(t.forEach(o),this.params.hasOwnProperty("offset")){var s=$.extend({},this.params);delete s.offset;var i=ns.Model.get(this.id,s),n=i.getData();if(n){var a=no.jpath(".resource",n)[0];
a&&(Array.prototype.push.apply(a.resource,t),i.__offset=t.length+(i.__offset||0))}else i.setData(e),i.__offset=t.length;return i.__complete=0===t.length,e}this.__offset=t.length,this.__complete=0===t.length}return e},getPreview:function(e){var t=$.Deferred(),o={private_hash:e,meta:"preview"};return ns.request("do-disk-get-public-preview",o).then(function(e){var o=jpath(e[0].getData(),".resource.meta.preview")[0];o?t.resolve(o):t.reject()},function(){t.reject()}),t.promise()},attach:function(e){function t(e,t){ns.forcedRequest("do-disk-attach-file",{src:e,dst:t}).then(function(t){var i=t[0];
if(i.getError())ns.Model.invalidate(s.id),o.reject(i.getError());else{var n=i.getData();if(n&&n.oid){var a={oid:n.oid,meta:"short_url,public,size,public_hash"};s.poll(a,e).done(function(e){var t=e.file||e.folder;t.type=e.file?"file":"dir",o.resolve({url:t.meta&&t.meta.short_url,name:t.name,type:t.type,size:t.meta&&t.meta.size,hash:t.meta&&t.meta.public_hash})}).fail(function(e){o.reject(e)})}else o.reject()}},function(e){ns.Model.invalidate(s.id),o.reject(e.data||e)})}var o=$.Deferred(),s=this;return t(e),o.promise()
},poll:function(e,t){function o(){ns.forcedRequest("do-attach-file-status",e).then(function(e){var a=e[0],r=jpath(a.getData(),".operation")[0];if(!r)return s.reject();if(-1!==n.cancelledAttachPaths.indexOf(t))return _.remove(n.cancelledAttachPaths,t),s.reject();var c=r.status;"EXECUTING"===c||"WAITING"===c?window.setTimeout(o,i):"FAILED"==c?s.reject(c.error):"DONE"==c&&s.resolve(r)},function(){s.reject()})}var s=$.Deferred(),i=1500,n=this;return o(),s.promise()},loadMore:function(e){var t=$.Deferred(),o=$.extend({},e);
delete o.offset;var s=ns.Model.get(this.id,o);return s.__complete?t.reject():(ns.forcedRequest("disk-resources",$.extend({offset:s.__offset},o)).then(function(e){var o=e[0],s=no.jpath(".resource.resource",o.getData())[0];if(s){var i=s[0];if(i)return t.resolve(i)}t.reject()},function(){t.reject()}),t.promise())},find:function(e){var o=t.utils.dirname(e)+"/",s=ns.Model.get(this.id,{path:o,sort:this.getDefaultSort(o),order:this.getDefaultOrder(o)});if(!s.getData()||!s.get(".resource")||!s.get(".resource")[0])return!1;
for(var i=s.get(".resource")[0],n=0,a=i.resource.length;a>n;n+=1)if(i.resource[n].id===e)return i.resource[n];return!1}}})}(Jane,Daria),function(){ns.Model.define("do-disk-attach-file",{params:{dst:null,src:null}})}(),function(){ns.Model.define("do-disk-get-public-preview",{params:{private_hash:null,meta:null}})}(),function(){var e={IS_OPTION_SET:"no_reply_notify",TIME_DELTA:"no_reply_notify_time",WAS_FIRST_VISIT_POPUP_SHOWN:"noreply_popup_shown",IS_SAVE_SENT_SET:"save_sent"},t="seconds",o=[{time:{hours:1}},{time:{hours:12}},{time:{days:1}},{time:{days:2}},{time:{days:3}},{time:{days:5},"default":!0},{time:{weeks:1}},{time:{weeks:2}}];
ns.Model.define("compose-notify-noreply-options",{params:{ids:null,oper:null},methods:{request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"}]},_initFromModels:function(e){this.mSettings=e[0],this.setData({enabledNotify:!1,alwaysNotify:!1,currentTimeDelta:null,timeDeltaItems:this._generateTimeDeltaItems(o)}),this.initData()},_getTimeDeltasUnitToStore:function(){return t},_generateTimeDeltaItems:function(e){var t=this.mSettings.getSetting("no_reply_notify_time"),o=this._getTimeDeltasUnitToStore(),s=Boolean(this.isSetInSettings()&&t);
return t=t?parseInt(t,10):0,e=_.clone(e,!0),_.map(e,function(e){var i=!1,n=Daria.timify(e.time,o);return s?i=n===t:e["default"]&&(i=!0),_.extend(e,{value:Daria.timify(e.time,o),text:Jane.Date.daysIntervalLocalization(e.time,!0),selected:i})})},getCurrentTimeDelta:function(){return this.get(".currentTimeDelta")},setCurrentTimeDelta:function(e){e=this.findTimeDeltaItem(e),e||(e=this.getDefaultTimeDeltaItem()),this.set(".currentTimeDelta",e),this.set(".enabledNotify",!0)},getCurrentTimeDeltaLocalizedText:function(){var e=Jane.Date.daysIntervalLocalization(this.getCurrentTimeDelta().time);
return"Напомнить через "+e},findTimeDeltaItem:function(e){var t=e;return e&&e.value&&(t={value:Number(e.value)}),_.find(this.get(".timeDeltaItems"),t)},getSelectedTimeDeltaItem:function(){return this.findTimeDeltaItem({selected:!0})},getDefaultTimeDeltaItem:function(){return this.findTimeDeltaItem({"default":!0})},isSetInSettings:function(){return Boolean(this.mSettings.isSet(e.IS_OPTION_SET)&&this.mSettings.isSet(e.IS_SAVE_SENT_SET))},setAlwaysNotifyOption:function(t){var o={};t?(o[e.IS_OPTION_SET]=!0,o[e.TIME_DELTA]=this.getCurrentTimeDelta().value,o[e.IS_SAVE_SENT_SET]=!0,this.set(".alwaysNotify",!0),this.set(".enabledNotify",!0)):(o[e.IS_OPTION_SET]=!1,this.set(".alwaysNotify",!1)),this.mSettings.setSettings(o)
},wasFirstVisitPopupShown:function(){return this.mSettings.isSet(e.WAS_FIRST_VISIT_POPUP_SHOWN)},setFirstVisitPopupWasShown:function(){this.mSettings.setSettingOn(e.WAS_FIRST_VISIT_POPUP_SHOWN)},initData:function(){this.set(".currentTimeDelta",this.getSelectedTimeDeltaItem()),this.set(".enabledNotify",this.isSetInSettings()),this.set(".alwaysNotify",this.isSetInSettings())}}})}(),ns.Model.define("abook-invite",{params:{email:null}}),ns.Model.define("abook-invites",{params:{limit:null},ctor:function(){this._viewedContacts={},this._reserve=[]
},methods:{getFilteredContacts:function(){var e=this.get(".contact");return e.filter(this._isNotHiddenOrShowedContact,this).map(this._mapContact,this)},_mapContact:function(e){var t=e.email[0];return{email:t.value,ref:t.ref,name:e.name.full||t.value,cid:e.cid}},_isNotHiddenOrShowedContact:function(e){var t=e.email[0].value;return this._viewedContacts[t]?!1:Daria.Done.Invite.isContactHidden(t)?!1:!0},saveInReserve:function(e){this._reserve=[e]},getReserve:function(){return this._reserve},saveContactsViewed:function(e){e.forEach(function(e){var t=e.email[0].value;
this._viewedContacts[t]=!0},this)}}}),function(){var e=Vow.resolve();ns.Model.define("compose-predefined-data",{events:{"ns-model-init":"_onInit"},params:{},methods:{request:function(){return e},_replaceParams:{mailto:"to",body:"send",subject:"subj"},_validParams:["to","cc","bcc","save_symbol","send","subj"],_onInit:function(){var e=this._createDataFromUrl();this.setData(e),_.isEmpty(e)||this._cleanUrl()},_replaceParamsCallback:function(e,t){this.hasOwnProperty(t)&&(this[e]=this[t],delete this[t])
},_createDataFromUrl:function(){var e={};return"compose2"===ns.page.current.page&&(e=_.clone(ns.page.current.params),_.forEach(this._replaceParams,this._replaceParamsCallback,e),e=_.pick(e,this._validParams),e.send&&(e.send=Daria.Html2Text.html2text(e.send))),e},_cleanUrl:function(){var e=this._validParams.concat(Object.keys(this._replaceParams)),t=_.omit(ns.page.current.params,e);ns.page.replacePage(ns.page.current.page,t)}}})}(),function(){var e={att_ids:null,bcc:"",captcha_entered:null,captcha_key:null,cc:"",charset:null,compose_check:null,confirm_limit:null,current_folder:null,doit:null,errors:{to:"",cc:"",bcc:"",phone:""},fid:null,from_mailbox:null,from_name:null,get_abook:null,html:null,idcs:null,ids:[],ign_overwrite:null,initial_cc:"",initial_to:"",inreplyto:null,lids:[],mark_as:null,mark_ids:[],narod_att:null,nosave:null,nosend:null,notify_on_send:null,overwrite:null,parts:null,phone:null,references:null,remind_period:null,"recipients-diff":{added:[],removed:[]},retpath:null,returl:null,saveDraft:null,save_symbol:"draft",send:"",send_time:null,store_fid:null,store_name:null,strict_charset:null,style:null,subj:null,to:"",ttype:null,where:null},t=["to","cc","bcc","phone","subj","send","from_mailbox","from_name","ttype","att_ids","parts","narod_att","save_symbol","lids"],o=_.map(t,function(e){return"."+e
}),s=ns.Model;ns.Model.define("compose-message",{params:{ids:null,tids:null,oper:null},events:{"ns-model-destroyed":"_onDestroyed","ns-model-changed.to":"_onRecipientsChanged","ns-model-changed.cc":"_onRecipientsChanged","ns-model-changed.bcc":"_onRecipientsChanged"},ctor:function(){this._attachments={},this.mSettings=null,this.mComposePredefinedData=null,this.mMessage=null,this.mMessageBody=null,this.mComposeState=null},methods:{_onDestroyed:function(){this._isDirty=!1},setIfChanged:function(e,t){if(this.isValid()&&this.data){var o=!0;
if(-1!==[".to",".cc",".bcc"].indexOf(e)){var s=/,\s*$/,i=this.get(e).replace(s,""),n=t.replace(s,"");o=i!==n}o&&ns.Model.prototype.setIfChanged.apply(this,arguments)}},set:function(e,t){return _.isEqual(t,this.get(e))?void 0:(_.contains(o,e)&&(this._isDirty=!0),s.prototype.set.apply(this,arguments))},setData:function(){return this._isDirty=!0,s.prototype.setData.apply(this,arguments)},setPhoneIfExist:function(e,t){var o=this.get(".phone");(!o||t)&&ns.request("abook-contact",{email:e}).then(function(e){var t=e[0];
if(!_.isEmpty(t.get(".phone"))){var o=t.get(".phone")[0].value;this.setIfChanged(".phone",o)}},this)},setSingleRecipient:function(e){this.setIfChanged(".to",e),this.setIfChanged(".cc",""),this.setIfChanged(".bcc","")},canRequest:function(){var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params),t=ns.Model.get("message-body",e);return t.canRequest()&&!t.get(".error")},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)
},isDraft:function(){return this.isTemplate()?!1:"no"===this.get(".ign_overwrite")&&this.get(".overwrite")?!0:!this.params.oper&&this.mMessage&&this.mMessage.isDraftLike()?!0:!1},getDraftMid:function(){var e=this.get(".overwrite");return this.isDraft()&&e?e:void 0},getTemplateMid:function(){var e=this.get(".overwrite");return this.isTemplate()&&e?e:void 0},_constructModelRequest:function(){var e=[{id:"settings"},{id:"compose-predefined-data"}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message",params:{ids:this.params.ids}},{id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e
},_prepareDataForSet:function(t){var o=_.extend(_.cloneDeep(e),this.mComposePredefinedData.getData(),t,this._customizerPrepareData);return this.mComposePredefinedData.destroy(),o},_customizerPrepareData:function(e,t,o){return"send"===o?e+t:t},_setDefaultData:function(){var e=this._getFromEmail()||ns.Model.get("account-information").getFromDefaultEmail(),t=this.mSettings.getSetting("from_name"),o=this._getMessageType(),s=this._prepareDataForSet({from_mailbox:e,from_name:t,ttype:o,send:""});s.send=Daria.signs.appendToBody(s.send,o,!0),this.setData(s)
},_setDraftData:function(){var e=this._getMessageType(),t=this.mMessage.isTemplate()?"template":"draft",o=_.clone(this.mMessage.get(".lid")),s=this.mMessage.getDelayedTime();if(!s){var i=ns.Model.get("labels").getDelayedMessageLabel();i&&(o=_.pull(o,i.lid))}var n=this._prepareDataForSet({overwrite:this.params.ids,ign_overwrite:"no",save_symbol:t,to:this.mMessageBody.getAddressField("to"),cc:this.mMessageBody.getAddressField("cc"),bcc:this.mMessageBody.getAddressField("bcc"),phone:this.mMessageBody.getAddressField("phone"),lids:o,from_name:this.mMessage.getFromName(),from_mailbox:this.mMessage.getFromEmail(),subj:this.mMessage.getSubject(),send:this.mMessageBody.getDraftBody(e),ttype:e,inreplyto:this.mMessageBody.getInReplyTo(),references:this.mMessageBody.getReferences(),current_folder:this.mMessage.getFolderId(),send_time:s});
this.setData(n)},_setReplyData:function(){var e=this._getMessageType(),t=this.mMessageBody.getRecipients(this.isReplyAll()),o=this.mMessageBody.getMessageId(),s=this.mMessageBody.getReferences(),i=this.mMessageBody.getInReplyTo(),n=this.mMessageBody.getInfo("delivered-to")[0],a=this._getFromEmail(),r=this.needCollapsedQuotedMessage(),c="";r||(c=this.mMessageBody.getReplyBody(e,a));var l=this._prepareDataForSet({from:{receiver:n},from_mailbox:a,from_name:this.mSettings.getSetting("from_name"),overwrite:this.params.ids,ign_overwrite:"yes",mark_as:"replied",mark_ids:[this.params.ids],to:t.to,cc:t.cc,bcc:"",subj:"Re: "+this.mMessage.getSubject(!0),send:c,collapsedMessage:r,ttype:e,inreplyto:o,references:_.trim((s||i||"")+" "+o)});
this.setData(l)},_getForwardMarkIds:function(){return this.mMessage?this.mMessage.isThread()&&1===this.mMessage.get(".count")?[this.mMessage.get(".last_mid")]:this.mMessage.isThread()?[]:[this.mMessage.get(".mid")]:[]},_setForwardData:function(){var e=this._getMessageType(),t=this._getFromEmail(),o="",s=null,i="",n=null;this.mMessage&&(o="Fwd: "+this.mMessage.getSubject(!0),s=this.mMessage.getFolderId()),this.mMessageBody&&(i=this.mMessageBody.getForwardBody(e,t),n=this.mMessageBody.getMessageId());
var a=this._prepareDataForSet({ttype:e,from_mailbox:t,from_name:this.mSettings.getSetting("from_name"),cc:"",bcc:"",subj:o,send:i,inreplyto:n,current_folder:s,overwrite:this.params.ids,ign_overwrite:"yes",references:"",mark_ids:this._getForwardMarkIds(),mark_as:"forwarded"});this.setData(a)},_setRecipients:function(){var e="",t="";if(this.isDraft())e=this.mMessageBody.getAddressField("to"),t=this.mMessageBody.getAddressField("cc");else if(this.isReplyAny()){var o=this.mMessageBody.getRecipients(this.isReplyAll());
e=o.to,t=o.cc}this.set(".initial_to",e,{silent:!0}),this.set(".initial_cc",t,{silent:!0})},_initFromModels:function(e){this.mMessage=_.find(e,"id","message"),this.mSettings=_.find(e,"id","settings"),this.mMessageBody=_.find(e,"id","message-body"),this.mComposePredefinedData=_.find(e,"id","compose-predefined-data"),this.mComposeState=ns.Model.get("compose-state",this.params),this.isTemplate()||this.isDraft()?this._setDraftData():this.isReplyAny()?this._setReplyData():this.isForward()?this._setForwardData():this._setDefaultData(),this._setRecipients(),this.markSaved()
},isMessageCollapsed:function(){return Boolean(this.get(".collapsedMessage"))},needCollapsedQuotedMessage:function(){return"compose2"===ns.page.current.page?!1:!0},expandMessage:function(){this.isMessageCollapsed()&&(this.isReplyAny()&&this.set(".send",this.getSendMessage()),this.set(".collapsedMessage",!1))},getSendMessage:function(){var e=this.get(".send");if(this.isMessageCollapsed()&&this.isReplyAny()){var t=this.get(".ttype"),o=this.get(".from_mailbox"),s=this.mMessageBody.getReplyBody(t,o);
e+=s}return e},_getMessageType:function(){var e;return Jane.UA.isMobile?e="plain":this.mSettings.isSet("enable_richedit")?e="html":this.mMessageBody&&(e=this.mMessageBody.getSubtype()),e||"plain"},_getFromEmail:function(){return this.mMessage&&this.mMessage.getToEmail()||this.mSettings.getSetting("default_email")},isTypeDefined:function(){return _.isString(this.get(".ttype"))},isHtmlType:function(){return"html"===this.get(".ttype")},isDirty:function(){return this._isDirty},markSaved:function(){this._isDirty=!1
},changeRecipientsToOpposite:function(){var e=this.isReplyAll(),t={to:this.get(".to"),cc:this.get(".cc")},o=this.mMessageBody.getRecipients(e),s=this.mMessageBody.getRecipients(!e);this.set(".to",this._calculateOppositeRecipients(t.to,o.to,s.to)),this.set(".cc",this._calculateOppositeRecipients(t.cc,o.cc,s.cc))},_extractEmailsFromContacts:function(e){return _(e).pluck("email").compact().value()},_calculateOppositeRecipients:function(e,t,o){e=Jane.FormValidation.splitContacts(e),t=Jane.FormValidation.splitContacts(t),o=Jane.FormValidation.splitContacts(o);
var s=this._extractEmailsFromContacts(t),i=_.filter(e,function(e){return!_.contains(s,e.email)}),n=this._extractEmailsFromContacts(i),a=_.filter(o,function(e){return!_.contains(n,e.email)});return Daria.formatContacts([].concat(i,a))},checkData:function(){var e=this.getData(),t={isValid:!0,errors:{}};return _.each(e,function(e,o){var s=this.validators[o];s&&_.each(s,function(s){t.errors[o]||s.test(e,this)||(t.isValid=!1,t.errors[o]=s.error)},this)},this),t},storeErrors:function(e){_.each(e,function(e,t){this.setIfChanged(".errors."+t,e)
},this),this.triggerFieldErrors(e)},triggerFieldErrors:function(e){this.trigger("ns-model:validation-error",e)},cleanErrors:function(){_.each(["to","cc","bcc","phone","att_ids"],function(e){this.setIfChanged(".errors."+e,"")},this)},getFieldError:function(e){return this.get(".errors."+e)},validators:{to:[{test:function(e,t){var o=t.get(".cc"),s=t.get(".bcc");return o||s?!0:Boolean(e)},error:"to_is_empty"},{test:function(e){return e?Jane.FormValidation.checkContacts(e):!0},error:"email_is_invalid"}],phone:[{test:function(e){return e?Jane.FormValidation.checkPhoneNumber(e):!0
},error:"phone_is_invalid"}],cc:[{test:function(e){return e?Jane.FormValidation.checkContacts(e):!0},error:"email_is_invalid"}],bcc:[{test:function(e){return e?Jane.FormValidation.checkContacts(e):!0},error:"email_is_invalid"}],att_ids:[{test:function(e,t){var o=ns.Model.get("compose-attachments",t.params);return o.isValid()&&o.isFailed()?!1:!0},error:"attachment_upload_is_failed"}]},confirmations:Daria.ComposeComponents.confirmations.getConfirmations(),checkConfirmations:function(){var e=!1,t={};
return _.each(this.confirmations,function(o){return e=o(this,t),!e},this),e&&this.trigger("ns-model:need-to-confirm:"+e,t),e},hasAttach:function(){return!_.isEmpty(this._attachments)},_getAttributeFromData:function(e,t){return _(e).pluck(t).compact().value()},_excludeFromProperty:function(e,t){return _.without(this.get("."+e),t)},addAttachment:function(e){this._attachments[e.getId()]=e,this._saveAttachmentData()},removeAttachment:function(e){delete this._attachments[e],this._saveAttachmentData()},addTextFromMessageBody:function(e){var t=this.get(".ttype"),o=e.getComposeHTML();
"html"===t?o+="<br>":o=Daria.Html2Text.html2text(o)+"\n";var s=this.get(".send");this.set(".send",o+s)},setRecepientsFromMessageBody:function(e){var t=this;["to","cc","bcc"].forEach(function(o){var s=e.getAddressField(o);s&&t.set("."+o,s)}),this.mComposeState.set(".isCcVisible",Boolean(this.get(".cc"))),this.mComposeState.set(".isBccVisible",Boolean(this.get(".bcc")))},addForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.uniq(this.get(".mark_ids").concat(e));
this.set(".mark_ids",t);var o=_.uniq(this.get(".ids").concat(e));this.set(".ids",o)}},removeForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.difference(this.get(".mark_ids"),e);this.set(".mark_ids",t);var o=_.difference(this.get(".ids"),e);this.set(".ids",o)}},_saveAttachmentData:function(){var e=_.map(this._attachments,function(e){return e.getDataToSend()});this.set(".att_ids",this._getAttributeFromData(e,"att_id")),this.set(".parts",this._getAttributeFromData(e,"hid")),this.set(".narod_att",this._getAttributeFromData(e,"disk").join(""))
},_getCommonSendParams:function(){var e={"handler.do-send":"1",compose_check:ns.Model.get("account-information").getDataKey("compose-check")};return ns.request.addRequestParams(e),e},_updateDataAfterSave:function(e){this.set(".ign_overwrite","no"),this.set(".overwrite",e.storedmid),e.store_fid&&this.set(".current_folder",e.store_fid)},_updateDraftAfterAction:function(e,t){if(t=t||this.getDraftMid()){var o=ns.Model.get("message",{ids:t});if(!e){ns.Model.traverse("messages",function(e){e.remove(o)});
var s=o.getThreadMessage();s&&s.hasRealData()&&s.updateThreadCount(-1)}var i=function(e){return e.isValid()&&e.params.ids===t};ns.Model.invalidate("message",i),ns.Model.invalidate("message-body",i),this._updateFolders(["draft","outbox"])}},_updateTemplateAfterAction:function(){this._updateFolders(["draft","template"]);var e=this.getTemplateMid();if(e){var t=ns.Model.get("folders"),o=t.getFidBySymbol("template"),s=ns.Model.get("message",{ids:e});s.get(".fid")!==o&&s.set(".fid",o);var i=function(t){return t.isValid()&&t.params.ids===e
};ns.Model.invalidate("message",i),ns.Model.invalidate("message-body",i)}},_updateFolders:function(e){e=Array.isArray(e)?e:[e];var t=ns.Model.get("folders");e.forEach(function(e){var o=t.getFidBySymbol(e);Daria.messages.clearCacheByFID(o)}),ns.forcedRequest(["folders","labels"])},_updateMessageFlagsAfterSend:function(){var e=this.get(".mark_ids");e&&e.length&&(this.isForward()&&e.forEach(function(e){ns.Model.get("message",{ids:e}).markForwarded()}),this.isReplyAny()&&e.forEach(function(e){ns.Model.get("message",{ids:e}).markAnswered()
}))},_processSaveResponse:function(e){var t,o=e.storedmid||this.getDraftMid();if(o&&this.mMessage){t=this.mMessage.get(".mid");var s=ns.Model.get("message-draft",{ids:this.mMessage.params.ids});s.isValid()&&s.setIfChanged(".mid",o)}if(!e.storedmid||this.inNotInitedState())return this.isDraft()?e.storedmid?this._updateDraftAfterAction(!0,e.storedmid):this._updateFolders(["draft","outbox"]):this.isTemplate()&&this._updateFolders(["draft","template"]),vow.Promise.reject();if(this._updateDataAfterSave(e),this.isDraft())this._updateDraftAfterAction(!0);
else if(this.isTemplate()){this._updateTemplateAfterAction();var i=this.getTemplateMid();ns.events.trigger("daria:mComposeMessage:template-saved",{oldMid:t,mid:i})}return this.markSaved(),this.trigger("ns-model:draft-saved",{mid:e.storedmid,attachments:e.attachment}),e},_processSendResponse:function(e){var t=no.jpath(".limited.recipient",e);t&&this.set(".limited",this._parseLimited(t));var o=no.jpath(".message_id",e);o&&this.set(".sentMessageId",o),this._updateDraftAfterAction(),this._updateMessageFlagsAfterSend()
},_parseLimited:function(e){var t=[],o=[],s={},i=function(e,s){t.push(s.limit),o.push("<"+s.login+"@"+s.$t+">")};return $.isArray(e)?($.each(e,i),t.sort(),s.recipients=o.join(", ")):(i(null,e),s.recipient=o[0]),s.limit=Jane.getHumanSize(t[0]),s},isTemplate:function(){var e=!1;return this.mMessage&&this.mMessage.isTemplate()?e=!0:"template"===this.get(".save_symbol")&&(e=!0),e},isNewMessage:function(){return!this.params.ids},isForward:function(){return Boolean("forward"===this.params.oper)},isReplyAll:function(){return Boolean(this.mMessageBody&&"reply-all"===this.params.oper)
},isReply:function(){return Boolean(this.mMessageBody&&"reply"===this.params.oper)},isReplyAny:function(){return this.isReply()||this.isReplyAll()},isNewTemplate:function(){var e=!1;return this.mMessage||"template"!==this.get(".save_symbol")||(e=!0),e},isAutosaveEnabled:function(){return this.mSettings.isSet("enable_autosave")&&!this.isTemplate()},_prepareDataForMailSend:function(e,t){if(e=_.clone(e),t?(e.lids=_.filter(e.lids,_.negate(this._systemLabelFilter),this),e.remind_period=null,e.send_time=null):(this.isTemplate()&&(e.ign_overwrite="yes"),ns.Model.get("settings").isSet("save_sent")||(e.nosave="yes")),Daria.IS_CORP&&!this.mComposeState.get(".recipients-diff-pane-close")){var o="",s=this._getRecipientsDiffStr();
s.length>0&&(o=this.isHtmlType()?Daria.Html2Text.text2html(s)+"<div>&nbsp;</div>":this._getRecipientsDiffStr()+"\n\n",e.send=o+e.send)}return e},createTemplateFolder:function(){var e=ns.Model.get("folders"),t=e.getFidBySymbol("template"),o=vow.Promise.resolve();return t?this.set(".templates_fid",t):o=e.createTemplateFolder().then(function(e){return this.set(".templates_fid",e.fid),e},this),o},save:function(e){e=e||{};var t=vow.Promise.resolve();if(!e.force&&!this.isDirty())return t;this.isTemplate()&&(t=this.createTemplateFolder());
var o=this.getData(),s=this._getCommonSendParams(),i={nosend:"yes"},n=_.extend({},o,s,i);return n=this._prepareDataForMailSend(n,!0),n.send=this.getSendMessage(),t.then(this.makeRequest.bind(this,n,"_save=true","save")).then(this._processSaveResponse,this)},makeRequest:function(e,t,o){var s=this;return this.isTemplate()&&!e.templates_fid&&(e.templates_fid=this.get(".templates_fid")),new vow.Promise(function(i,n){$.ajax({url:Daria.handlersPrefix+"/do-send-json.jsx?"+t,method:"POST",dataType:"json",cache:!1,data:e,success:function(e,t,a){Daria.parseLoginInfo(e)?s.onXHRSuccess(e,i,n,o):s.onXHRError(a,"no_auth",n,o)
},error:function(e,t){s.onXHRError(e,t,n,o)}})})},_waitForAttachmentsUploaded:function(){var e=this;return new vow.Promise(function(t,o){var s=ns.Model.get("compose-attachments",e.params);s.isValid()&&s.isUploading()?(ns.events.once("attachments.all-uploaded",t),s.once("ns-model:attachments.failed",function(){var t=e.checkData();t.isValid||(e.storeErrors(t.errors),Daria.Statusline.hide(),o("attachments-failed"))})):t()})},_preSend:function(e){this.cleanErrors();var t=this.checkData();return t.isValid?!e.force&&this.checkConfirmations()?vow.reject("need-confirm"):(ns.events.trigger("message.sending",{name:"message-sending",hideOnTimeout:!1,body:"Письмо отправляется…"}),this._waitForAttachmentsUploaded().then(function(){return e
})):(this.storeErrors(t.errors),vow.reject("message-not-valid"))},_send:function(){var e=this.getData(),t=this._getCommonSendParams(),o=_.extend({},e,t);return o.send=this.getSendMessage(),o=this._prepareDataForMailSend(o,!1),ns.Model.get("message-failed").setMid(this.getDraftMid()),this.makeRequest(o,"_send=true","send").then(this._processSendResponse,this)},send:function(e){return e=e||{},this._preSend(e).then(this._send,this)},onXHRError:function(e,t,o,s){var i,n,a=e&&e.status;"parsererror"===t?(n="bad_json",i="no_data"):"no_auth"===t?(n="NoAuth",i="no_auth"):i=413===a?"attachment_too_big":a>0?"no_data":"http_status_0",n=n?n:i,Jane.ErrorLog.send({errorType:"compose.http",status:n,ckey:ns.Model.get("account-information").get(".ckey")},e.responseText),"NoAuth"!==n&&this.onSendError(i,o,s)
},onXHRSuccess:function(e,t,o,s){var i=jpath(e,".status")[0];switch(i){case"ok":t(e);break;case"captcha_request":e.captcha_key&&ns.Model.get("captcha").setData({key:e.captcha_key,url:e.captcha_url,_:e.captcha_key}),this.trigger("ns-model:captcha-request"),this.onSendError(i,o,s);break;case"compose_check_failed":this.onSendError(i,o,s);break;default:this.onSendError(i,o,s)}},onSendError:function(e,t,o){e=e||"internal_error",Jane.ErrorLog.send({errorType:"compose."+o+".failed",status:e,ckey:ns.Model.get("account-information").get(".ckey")}),ns.Model.get("message-failed").removeMid(this.getDraftMid()),t(e)
},isSystemLabel:function(e){var t=ns.Model.get("labels"),o=t.getLabelById(e);if(!o)return!1;if(o.user)return!1;var s=t.getWaitingForReplyLabel(),i=t.getDelayedMessageLabel();return _.contains([s,i],o)},getLabelsHash:function(){var e=ns.Model.get("labels").getLabelsHash(),t=this.get(".lids")||[];return _.each(t,function(t){e[t]=1}),e},addLid:function(e){e=$.makeArray(e);var t=this.get(".lids")||[];if(e=_.difference(e,t),e.length){t=t.concat(e);var o=_.all(e,this._systemLabelFilter,this);this.set(".lids",t,{silent:o})
}},removeLid:function(e){e=$.makeArray(e);var t=this.get(".lids");t&&t.length&&(t=_.difference(t,e),t.length?this.set(".lids",t,{silent:this.isSystemLabel(e)}):(this.set(".lids",[]),delete this.getData().lids))},hasUserLabels:function(){return!_(this.get(".lids")).filter(this._userLabelFilter,this).isEmpty()},getUserLabels:function(){return _(this.get(".lids")).filter(this._userLabelFilter,this).value()},_userLabelFilter:function(e){var t=ns.Model.get("labels"),o=t.getLabelById(e),s=t.getImportantLID();
return o&&(o.user||e===s)&&!this.isSystemLabel(e)},_systemLabelFilter:function(e){return this.isSystemLabel(e)},getFromEmails:function(){var e=String(this.get(".from_mailbox")||"");return _.map(ns.Model.get("account-information").getFromEmails(),function(t){return{text:"("+t+")",value:t,selected:e.toLowerCase()===t.toLowerCase()}})},getLanguage:function(){var e="ru";if(this.isReply()){var t=this.params.ids;if(e=Daria.Translate.getLangByMid(t),!e){var o=this.mMessageBody.getComposeHTML();e=Daria.Translate.defineLanguage(o)
}}else{var s=this.get(".send");_.trim(s.replace(/\&nbsp;/gi,"")).length?e=Daria.Translate.defineLanguage(s):_.contains(Daria.Translate.langs.all.s,Daria.Config.locale)&&(e=Daria.Config.locale)}return e},formatContacts:function(e,t){var o=this.get("."+e);return Jane.FormValidation.splitContacts(o).map(function(o){return o.type=e,o.ref=t.getEmailRef(o.email),o},this)},getContacts:function(e){var t,o=this.get("."+e);return t="phone"===e?o.split(/[;\s]/):Jane.FormValidation.splitContacts(o)},getAllRecepients:function(){var e=this.getContacts("to"),t=this.getContacts("cc"),o=this.getContacts("bcc");
return Array.prototype.concat.call(e,t,o)},getAllRecepientEmails:function(){var e={to:this._extractEmailsFromContacts(this.getContacts("to")),cc:this._extractEmailsFromContacts(this.getContacts("cc")),bcc:this._extractEmailsFromContacts(this.getContacts("bcc"))};return e},setContacts:function(e,t){var o="."+e;this.set(o,_.map(t,function(e){return Jane.FormValidation.obj2contact(e)}).join(", ")+",")},appendContact:function(e,t){t&&this.setContacts(e,this.getContacts(e).concat(t))},isDelayed:function(){return Boolean(this.get(".send_time"))
},_getArrayOfEmails:function(e){return e.map(function(e){return e.email})},_onRecipientsChanged:function(){if(!Daria.IS_CORP)return vow.resolve();if(this.isTemplate()||this.isNewMessage()||this.isForward())return vow.resolve();var e=this;return vow.resolve().then(function(){var t=_.union(Jane.FormValidation.splitContacts(e.get(".initial_to")||""),Jane.FormValidation.splitContacts(e.get(".initial_cc")||"")),o=_.union(Jane.FormValidation.splitContacts(e.get(".to")||""),Jane.FormValidation.splitContacts(e.get(".cc")||"")),s=_.uniq(e._getArrayOfEmails(t)),i=_.uniq(e._getArrayOfEmails(o)),n=_.difference(i,s).sort(),a=_.difference(s,i);
return s.length-a.length<2&&a.length>0?s.length-a.length===1?ns.Model.get("get-maillists-static").getMaillists(i).then(function(e){return 0===e.length&&(a=["все"]),{removed:a,added:n}}).fail(function(e){throw e}):(a=["все"],{removed:a,added:n}):{removed:a,added:n}}).then(function(t){e.set(".recipients-diff",{added:t.added,removed:t.removed})}).fail(function(e){throw e})},_getRecipientsDiffStr:function(){var e=this.get(".recipients-diff"),t=[];return 0===e.added.length&&0===e.removed.length?t=[]:(e.added.length>0&&t.push("+ "+e.added.join(", ")),e.removed.length>0&&t.push("- "+e.removed.join(", "))),t.join("\n")
}}})}(),function(){var e=190,t={editorMode:"",editorMaximize:2,messageHeight:e,bodyPos:0,editorBookmark:null,isCcVisible:!1,isBccVisible:!1,isReplyAllNoticeVisible:!1,isPhoneVisible:!1,isPhoneEnabled:!0,isOpenedWithToolbarAttachPopup:!1,saveTemplateAndLeave:!1,saveTemplateAndReset:!1,submitButtonText:"Отправить",activeActionButtonView:"compose-send-link",focusField:"to",waitSuggest:!1,formRect:null,"recipients-diff-pane-close":!1,visibleNotices:{to:[],phone:[],cc:[],bcc:[]},translationEnabled:!1},o=ns.Model.prototype;
ns.Model.define("compose-state",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null,oper:null},ctor:function(){this._onComposeMessageFieldChanged=this._onComposeMessageFieldChanged.bind(this),this._refreshSubmitButtonText=this._refreshSubmitButtonText.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)
},_constructModelRequest:function(){var e=[{id:"compose-message",params:this.params}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_initFromModels:function(e){this.mComposeMessage=_.find(e,"id","compose-message"),this.mMessageBody=_.find(e,"id","message-body"),this._bindModelEvents();var o="reply"===this.params.oper&&this.mMessageBody&&this.mMessageBody.allowedReplyAll();
this.mComposeMessage.on("ns-model-changed.to",this.refreshIsPhoneEnabled.bind(this)),this.mComposeMessage.on("ns-model-changed.cc",this.refreshIsPhoneEnabled.bind(this)),this.mComposeMessage.on("ns-model-changed.bcc",this.refreshIsPhoneEnabled.bind(this)),ns.Model.get("userphones").on("ns-model-changed",this.refreshIsPhoneEnabled.bind(this)),this.setData(_.extend({},t,{isReplyAllNoticeVisible:o,isCcVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".cc")),isBccVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".bcc")),isPhoneVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".phone")),focusField:this.mComposeMessage.isReplyAny()?"send":t.focusField,quickReplyAttaches:[]})),this.refreshIsPhoneEnabled(),this._refreshSubmitButtonText()
},refreshIsPhoneEnabled:function(){var e=ns.Model.get("userphones").hasActiveNumber();this.set(".userHasValidatedPhone",e);var t=Daria.Config.MAY_HAVE_SMS_COPY,o=this.mComposeMessage.getAllRecepients(),s=o.some(function(e){return ns.Model.get("account-information").isMyEmail(e.email)}),i=t&&e&&!s&&o.length<=1;this.set(".isPhoneEnabled",i,{force:!0})},onBeforeDestroyed:function(){this._unbindModelEvents()},_bindModelEvents:function(){this.on("ns-model-changed.translationEnabled",this._refreshSubmitButtonText),this.mComposeMessage&&(this.mComposeMessage.on("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.on("ns-model-changed."+e,this._onComposeMessageFieldChanged)
},this))},_unbindModelEvents:function(){this.mComposeMessage&&(this.mComposeMessage.off("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.off("ns-model-changed."+e,this._onComposeMessageFieldChanged)},this))},_isNdaNoticeNeeded:function(e){if(Daria.IS_CORP)return!1;var t=this.mComposeMessage.getContacts(e),o=!1,s=!1;return _(t).pluck("email").each(function(e){Jane.FormValidation.checkExternalEmail(e)?s=!0:o=!0}).value(),o&&s
},_onComposeMessageFieldChanged:function(e,t){var o=t.substr(1),s={nda:this._isNdaNoticeNeeded.bind(this,o)},i=this.get(".visibleNotices."+o);_.each(s,function(e,t){i=e()?_.uniq(i.concat(t)):_.without(i,t)}),this.setIfChanged(".visibleNotices."+o,i)},setFocusField:function(e,t){this.set(".focusField",e,t)},getFocusField:function(){return this.get(".focusField")},setWaitSuggest:function(e,t){this.set(".waitSuggest",e,t)},getWaitSuggest:function(){return this.get(".waitSuggest")},set:function(e,t,s){s||(s={});
var i=this.get(e);(!_.isEqual(i,t)||s.force)&&o.set.call(this,e,t,s)},setMessageHeight:function(t){e>t&&(t=e),this.set(".messageHeight",t)},hasSpellingCheck:function(){return"TUR"!=Daria.Config.product&&!_.contains(["ka","hy","ro"],Daria.Config.locale)},hasEnSpellingCheckIcon:function(){return!_.contains(["ru","uk","be"],Daria.Config.locale)},hasDisk:function(){return _.contains(Daria.SIDS,"59")},isFieldEnabled:function(e){return _.contains(["phone"],e)?this.get(".is"+_.capitalize(e)+"Enabled"):!0
},isFieldVisible:function(e){return _.contains(["phone","cc","bcc"],e)?this.get(".is"+_.capitalize(e)+"Visible"):!0},isCcVisible:function(){return this.get(".isCcVisible")},isBccVisible:function(){return this.get(".isBccVisible")},isPhoneVisible:function(){return this.get(".isPhoneVisible")},isReplyAllNoticeVisible:function(e){return"to"===e&&this.get(".isReplyAllNoticeVisible")},isNdaNoticeVisible:function(e){return Daria.IS_CORP&&_.contains(this.get(".visibleNotices."+e),"nda")},setLastSaveTime:function(){this.set(".lastSaveTime",Jane.Date.format("%R",Daria.now()))
},isMinWidth:function(){var e=ns.Model.get("settings"),t=Number(e.getSetting("size-view-app")),o=Number(e.getSetting("size-layout-left")),s=_.find(Daria.resize.elements.all,function(e){return"size-view-app"===e.settingName}).params.minWidth,i=_.find(Daria.resize.elements.all,function(e){return"size-layout-left"===e.settingName}).params.maxWidth;return t===s&&o===i},getSubmitButtonText:function(){var e=this.get(".translationEnabled"),t=Jane.Date.parseCalendarDate(this.mComposeMessage.get(".send_time"));
if(t){var o=this._toHumanFormat(t),s=Jane.Date.format("%Date_HM__colon",t);return e?"Отправить перевод "+o+" в "+s:"Отправить "+o+" в "+s}return e?"Отправить перевод":"Отправить"},_toHumanFormat:function(e){var t=new Date(Daria.passportNow()),o=e.getFullYear(),s=e.getMonth(),i=e.getDate();return o===t.getFullYear()&&s===t.getMonth()&&i===t.getDate()?"сегодня":Jane.Date.format("%Date_dBY_year",e)},_refreshSubmitButtonText:function(){this.setIfChanged(".submitButtonText",this.getSubmitButtonText())
}}})}(),function(){var e=500;ns.Model.define("compose-forwarded-messages",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){return this.mComposeMessage=ns.Model.get("compose-message",_.clone(this.params)),ns.request([this.mComposeMessage]).then(function(){this.setData([]),ns.request(this._constructModelRequest()).then(this._initFromModels,this)},null,this)
},_constructModelRequest:function(){var t=[];if("forward"!==this.params.oper)return t;var o=$.makeArray(this.params.tids),s=$.makeArray(this.params.ids);return t=t.concat(_.map(o,function(t){var o=ns.Model.get("message",{ids:t}).getThreadCount()||e;return{id:"messages",params:{thread_id:t,first:0,count:o}}})),t=t.concat(_.map(s,function(e){return{id:"message",params:{ids:e}}}))},_initFromModels:function(e){var t=[];_.each(e,function(e){switch(e.id){case"messages":t.push.apply(t,e.models);break;case"message":t.push(e)
}}),this._setMessages(t)},_setMessages:function(e){var t=!1;e.length>1&&(t=!0);var o=_.map(e,function(e){return{mid:e.get(".mid"),subject:e.get(".subject"),checked:t,link:e.getMessageLink()}});this.setData(o),t&&this.mComposeMessage.addForwardedMessages(_.pluck(o,"mid"))},checkMessage:function(e){var t=_.find(this.getData(),{mid:e});t.checked=!0,this.mComposeMessage.addForwardedMessages(e)},uncheckMessage:function(e){var t=_.find(this.getData(),{mid:e});t.checked=!1,this.mComposeMessage.removeForwardedMessages(e)
}}})}(),function(){ns.Model.define("compose-fsm",{params:{ids:null,oper:null},methods:{start:"edit",transitions:{save:["edit","sending","cancel"],edit:["save","sending","cancel"],sending:["edit","sent"],cancel:["edit"]}}},ns.ModelFsm)}(),ns.Model.define("compose-signature",{params:{oper:null,ids:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();
return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"},{id:"compose-message",params:_.clone(this.params)}]},_initFromModels:function(e){this.mSettings=e[0],this.mComposeMessage=e[1],this.setData({signature:""})},getSignatureList:function(){var e=this.mComposeMessage.get(".from_mailbox"),t=this.mComposeMessage.getLanguage(),o={mode:this.mComposeMessage.get(".ttype"),signs:[]};switch(o.mode){case"html":o.signs=Daria.signs.getHtml();break;case"plain":o.signs=Daria.signs.getPlain()
}return o.signs.sort(Daria.signs.sort(e,t)),o},hasSignatureControl:function(){return Jane.Config.NO_SETTINGS?!1:!Modernizr.ios&&!this.mSettings.isSet("no_signature_select")}}}),ns.Model.define("do-abook-invite-send",{params:{mcid:null}}),function(){var e={};ns.Model.define("done",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData(e)},_getDoneTitle:function(e){var t,o=Jane.Config["db-status"],s=e.get(".limited"),i=e.get(".send_time");return"ro"===o?t="Ваше письмо отправлено. Оно появится в папке «Отправленные» чуть позже":s&&(s.recipient||s.recipients)?s.recipient?t='<div class="b-done-title__normal">Возможно, адресат '+s.recipient+' не сможет получить письмо из-за ограничений, установленных администратором его почты.</div> <div class="b-done-title__small">Если письмо не будет доставлено, вы получите уведомление от сервера получателя. В этом случае рекомендуем сократить размер вложений до '+s.limit+" и отправить письмо повторно.</div>":s.recipients&&(t="Возможно, адресаты "+s.recipients+" не смогут получить письмо из-за ограничений, установленных администраторами их почтовых сервисов. Если письмо не будет доставлено, вы получите уведомление от сервера получателя. В этом случае рекомендуем сократить размер вложений до "+s.limit+" и отправить письмо повторно."):t=i?Daria.supplant("{1}&#160;{2}&#160;{3}",{1:"Письмо",2:"будет отправлено "+i+".",3:'До тех пор оно будет лежать в папке <a class="b-done-title__link" href="#outbox">"Исходящие"</a>.'},!0):"Письмо отправлено.",t
},fromComposeMessage:function(t){var o=_.pick(t.getData(),["to","cc","phone"]),s=_.extend({allowDone:!0,title:this._getDoneTitle(t)},e,o);this.setData(s)},isDoneAllowed:function(){return this.get(".allowDone")}}},ns.ModelStatic)}(),ns.Model.define("facebook-badge",{params:{email:null}}),ns.Model.define("quick-reply-state",{events:{"ns-model-init":"_onInit"},params:{qrIds:null},methods:{_onInit:function(){this.setData({show:!1,forceShow:!1,formIsShown:!1,showFieldPlaceholder:!0,verboseFieldPlaceholder:!1,sentMessageId:void 0,showDone:!1,needPlaceInViewport:!1,isReplyAll:!0,tmpEditorId:void 0,fixed:!1})
},showForm:function(e){this.get(".formIsShown")||(this.set(".show",!0,e),this._tmpEditorInit())},toShowForm:function(){return this.get(".show")},isVisible:function(){return this.get(".formIsShown")},hideForm:function(e){this.setIfChanged(".show",!1,e),this.setIfChanged(".showFieldPlaceholder",!0,e),this._tmpEditorDestroy()},showDone:function(e){this.hideForm(e),this.setIfChanged(".showDone",!0,e)},isShowDone:function(){return this.get(".showDone")},existOpenQR:function(){var e=!1;return ns.Model.traverse("quick-reply-state",function(t){!e&&t.isVisible()&&(e=!0)
}),e},placeInViewport:function(){this.set(".needPlaceInViewport",!0)},isReplyAll:function(){return this.get(".isReplyAll")},setReplyAllState:function(e){return this.set(".isReplyAll",e)},_tmpEditorInit:function(){this._tmpEditorDestroy();var e=_.uniqueId("tmpeditor_");this.set(".tmpEditorId",e,{silent:!0});var t={position:"fixed",width:"1px",height:$(window).height(),overflow:"hidden",top:0,left:0,margin:0,padding:0,"user-select":"text",opacity:0};$('<div id="'+e+'" contenteditable="true" />').css(t).appendTo("body").focus()
},_tmpEditorDestroy:function(){var e=this.get(".tmpEditorId");e&&(this.set(".tmpEditorId",void 0,{silent:!0}),$("#"+e).remove())},getTmpContentAndRemove:function(){var e=this.get(".tmpEditorId"),t=e&&$("#"+e),o="";return t&&t.length&&(o=t.html(),o&&(Modernizr.mozilla||Modernizr.msie||Modernizr.edge)&&(o=o.replace(/<br\/?>$/i,"").replace(/\s$/,"&nbsp;")),t.remove()),o}}},ns.ModelStatic),function(){ns.Model.define("compose-popular-contacts",{events:{},params:{ids:null,oper:null,count:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=ns.Model.get("compose-message",this.params),o=!t||t.canRequest();
return e&&o},request:function(){var e=this._constructModelRequest();return ns.request(e).then(function(e){var t=_.zipObject(_.pluck(e,"id"),e);this._initFromModels(t)},this)},_constructModelRequest:function(){return[{id:"abook-suggest",params:{q:"",popular:!0,climit:this.params.count}},{id:"compose-message",params:this.params}]},_initFromModels:function(e){var t=e["abook-suggest"],o=e["compose-message"],s=o.getAllRecepients(),i=t.get(".contacts"),n=_.map(i,function(e){return e.name||(e.name=e.email),_.extend({},e,{used:_.any(s,{email:e.email})})
},this);this.setData(n)},getContact:function(e){return _.find(this.getData(),e)},actualizeUsedContacts:function(e){_.each(this.getData(),function(t){t.used=_.any(e,{email:t.email})})},isAnyUnusedContact:function(){return this.isValid()?_.any(this.getData(),function(e){return!e.used}):!0},clean:function(){_.each(this.getData(),function(e){e.used=!1})}}})}(),ns.Model.define("compose-field-notice",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})
}}},ns.ModelStatic),ns.Model.define("compose-field-extras",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic),ns.Model.define("compose-field-notices",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic),ns.Model.define("compose-field-extras-collection",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})
}}},ns.ModelCollectionStatic),ns.Model.define("compose-emoticons",{events:{"ns-model-init":"_onInit"},params:{},methods:{_onInit:function(){this.setData({items:[{suid:21,name:"Улыбается"},{suid:22,name:"Подмигивает"},{suid:23,name:"Показывает язык"},{suid:24,name:"Благодарит"},{suid:25,name:"Крутой"},{suid:26,name:"Удивляется"},{suid:27,name:"Огорчается"},{suid:28,name:"Обижается"},{suid:29,name:"Плачет"},{suid:30,name:"Зевает"},{suid:31,name:"Смущается"},{suid:32,name:"Не может сказать вслух"},{suid:33,name:"Не в себе"},{suid:34,name:"Сумасшедший"},{suid:35,name:"Ехидный"},{suid:36,name:"Ангелочек"},{suid:37,name:"Влюбленный"},{suid:38,name:"Сердце разбито"},{suid:45,name:"Отдых"},{suid:51,name:"Подарок"},{suid:40,name:"Мокро"},{suid:43,name:"Дождь"},{suid:46,name:"Солнечно"},{suid:47,name:"Холодно"},{suid:50,name:"Планета"},{suid:42,name:"Не одобряю"},{suid:41,name:"Одобряю"},{suid:48,name:"Бомба"},{suid:49,name:"Идея!"},{suid:44,name:"Музыка"}]})
}}},ns.ModelStatic),function(){ns.View.edefine("labels-actions-compose",{models:{labels:!1,settings:!1,"compose-message":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{_yateModule:"mail"})},yateModule:"toolbar",methods:{onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByComposeMessage()},filterByComposeMessage:function(){var e=this.getModel("compose-message").getLabelsHash();
this._filterByLabelsHash(e,{showReadLabel:!1,showUnreadLabel:!1,messagesCount:1})},_onLabelClick:function(e){var t=this._getDataFromClickedLabel(e),o=this.getModel("compose-message");switch(t.action){case"label":o.addLid(t.lid);break;case"unlabel":o.removeLid(t.lid)}this.nbPopup.close()},getLabelCreatedCallback:function(){return this.getModel("compose-message").addLid.bind(this.getModel("compose-message"))}}},"labels-actions")}(),function(){ns.View.define("compose-leave-mixin",{yateModule:"compose2",methods:{leaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeFsm в зависимостях"),ns.assert(this.getModel("compose-state"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeState в зависимостях"),this._pageGoUrl=null,_.bindAll(this,["_leaveOnPageGo","_leaveOnSent","_leaveOnCancel","_nbSaveChangesPopupResolve","_nbSaveChangesPopupReject","_onExternalComposeButtonClick"])
},leaveStart:function(){ns.page.block.add(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.on("# sent",this._leaveOnSent),e.on("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.on("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.on("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.on("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},leaveStop:function(){ns.page.block.remove(this._leaveOnPageGo);var e=this.getModel("compose-fsm");
e.off("# sent",this._leaveOnSent),e.off("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.off("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.off("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.off("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},checkSameUrlParams:function(e){if(!e)return!1;var t=ns.router(ns.page.currentUrl),o=ns.router(e);if(Daria.composeEqualRoutes(t,o))return!0;var s=_.get(o,"params._cuid");return"compose2"===o.page||Daria.composeHasParams(s)?!0:!1
},_onExternalComposeButtonClick:function(){var e=ns.router.generateUrl("compose2");this._leaveOnPageGo(e,!0)},_leaveOnPageGo:function(e,t){var o=this.getModel("compose-state"),s=o.get(".nbSaveChangesPopup");if(s&&s.isOpen())return!1;if(!t&&e===ns.page.currentUrl)return!0;if(!t&&e&&this.checkSameUrlParams(e))return!0;this._pageGoUrl=e;var i=this.getModel("compose-fsm"),n=this.getModel("compose-sidebar-fsm"),a=this.getModel("compose-message");return n.isCurrentState("edit")||i.isCurrentState(["save","sent"])||!a.isDirty()?(t&&this.hardResetCompose(),!0):!this._showSaveChangesPopup(t)
},_showSaveChangesPopup:function(e){var t=this,o=this.getModel("compose-state");if(o.get(".nbSaveChangesPopup"))return!1;this.autosaveStop(),nb.trigger("popup-close"),Daria.Dropdown.closeAll(),Daria.Dialog.close();var s=this.params,i=ns.View.create("compose-unsaved-popup");return i.on("resolve",function(t,o){ns.Model.get("compose-state",s).trigger("nbSaveChangesPopup:resolve",o,e)}),i.on("reject",function(){ns.Model.get("compose-state",s).trigger("nbSaveChangesPopup:reject"),t.autosaveStart()}),o.set(".nbSaveChangesPopup",i,{silent:!0}),i.open(),!0
},_nbSaveChangesPopupResolve:function(e,t,o){var s=this.getModel("compose-state");s.set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.isQuickReply()||this.getModel("compose-fsm").switchOff(),"save"===t?(o&&s.set(".saveTemplateAndReset",!0),this.getModel("compose-message").save({force:!0})):o&&this.hardResetCompose(),this._leaveCompose(!0))},_nbSaveChangesPopupReject:function(){this.getModel("compose-state").set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").setState("edit"),ns.Model.get("focus").setLastActionFocus(),ns.page.refresh())
},_whereToGoAfterSend:function(){var e,t=ns.Model.get("folders"),o=ns.Model.get("settings"),s=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol("inbox")}),i=Daria.is3pane()?"prev":o.getSetting("page_after_send");switch(i){case"done":e=ns.router.generateUrl("done");break;case"sent_list":e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol("sent")});break;case"current_list":e=ns.page.history.getPreviousPageUrl({match:"messages"});break;case"prev":e=ns.page.history.getPreviousPageUrl({mismatch:"compose2"})
}return e||(e=s),e},_sendMetrika:function(){Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("SEND")},_incrementDoneCounter:function(){var e=ns.Model.get("settings"),t=e.getSetting("done_shown_counter")||0;e.setSettings({done_shown_counter:++t})},_onAfterSent:function(){ns.events.trigger("message.sent",{body:"Письмо отправлено"});var e=this._whereToGoAfterSend();return"#done"===e&&(this._incrementDoneCounter(),ns.Model.get("done").fromComposeMessage(this.getModel("compose-message"))),this._pageGoUrl=e,this._leaveCompose(!0,!0),vow.resolve()
},_leaveOnSent:function(){return this._sendMetrika(),this._onAfterSent()},_leaveOnCancel:function(){return this._leaveCompose()},_leaveCompose:function(e,t){e&&ns.page.block.clear();var o=this._pageGoUrl;o||(o=ns.page.history.getPreviousPageUrl({mismatch:"compose2"})),o||(o=ns.page.HOME_HASH);var s=ns.router(o);s.page===ns.R.REDIRECT&&(s=ns.router(s.redirect)),s.params=_.omit(s.params,"_cuid");var i=_.delay(function(){Jane.ErrorLog.send({event:"after_send_wait_10_sec"})},1e4),n=_.delay(function(){Jane.ErrorLog.send({event:"after_send_wait_20_sec"}),ns.page.go(ns.page.HOME_HASH)
},2e4);return o=ns.router.generateUrl(s.page,s.params),ns.page.go(o,t?"replace":null).fail(function(e){return Jane.ErrorLog.send(_.assign({},e,{event:"after_send_failed",loadingHash:o})),"expired"!==_.get(e,".error")&&_.defer(ns.page.go,ns.page.HOME_HASH),Vow.reject(e)}).always(function(){window.clearTimeout(i),window.clearTimeout(n)})}}})}(),ns.View.define("compose-autosave-mixin",{yateModule:"compose2",methods:{AUTOSAVE_PERIOD:Daria.timify({seconds:10}),autosaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeFsm в зависимостях"),this._autosaveSaveMessageModel=this._autosaveSaveMessageModel.bind(this),this._autosaveTimerAction=this._autosaveTimerAction.bind(this),this._autosaveTimer=0
},autosaveStart:function(){var e=this.getModel("compose-fsm");e.on("# save",this._autosaveSaveMessageModel),this._setAutosaveTimeout()},autosaveStop:function(){this._clearAutosaveTimeout();var e=this.getModel("compose-fsm");e.off("# save",this._autosaveSaveMessageModel)},_isAutosaveEnabled:function(){return this.isValid()&&this.getModel("compose-message").isAutosaveEnabled()},_autosaveSaveMessageModel:function(){this._clearAutosaveTimeout(),this.getModel("compose-message").save().always(this._onAutosave,this)
},_onAutosave:function(){var e=this.getModel("compose-fsm");e.isCurrentState("save")&&!e.inTransition()&&(e.setState("edit"),this._isAutosaveEnabled()&&this._setAutosaveTimeout())},_clearAutosaveTimeout:function(){this._autosaveTimer&&(window.clearTimeout(this._autosaveTimer),this._autosaveTimer=0)},_setAutosaveTimeout:function(){this._isAutosaveEnabled()&&(this._clearAutosaveTimeout(),this._autosaveTimer=window.setTimeout(this._autosaveTimerAction,this.AUTOSAVE_PERIOD))},_autosaveTimerAction:function(){this.getModel("compose-fsm").setState("save")
}}}),function(){ns.View.define("compose-disable-on-sending-mixin",{yateModule:"compose2",methods:{disableOnSendingInit:function(){ns.assert(this.getModel("compose-fsm"),"vComposeDisableOnSendingMixin","должен иметь mComposeFsm в зависимостях"),this.onToggleControl=this.onToggleControl.bind(this)},disableOnSendingStart:function(){var e=this.getModel("compose-fsm");e.on("# *",this.onToggleControl),e.on("* > *",this.onToggleControl)},disableOnSendingStop:function(){var e=this.getModel("compose-fsm");
e.off("# *",this.onToggleControl),e.off("* > *",this.onToggleControl)},onToggleControl:function(e,t){var o=!0,s=this.getModel("compose-fsm");if(s.isCurrentState(["edit","save"])){if(s.inTransition()){var i=_([t.from,t.to]).difference(["save","edit"]).isEmpty();i||(o=!1)}}else o=!1;this.$node.toggleClass("is-disabled",!o)}}})}(),function(){ns.View.define("compose-field-base-hotkeys",{yateModule:"compose2",events:{"keydown@show":"_onKeydown"},methods:{_onKeydown:function(e){var t=ns.Model.get("settings"),o=t.getSetting("enable_hotkeys");
if("compose2"!==ns.page.current.page&&o){var s=Boolean(Modernizr.mac?e.metaKey:e.ctrlKey);s&&e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.getModel("compose-fsm").setState("sending"))}}}})}(),function(){ns.View.define("compose-attach-quick-reply-mixin",{yateModule:"compose2",methods:{_openComposePage:function(){var e=_.omit(this.params,"qrIds"),t=ns.router.generateUrl("compose2",e);ns.page.go(t).then(function(){ns.Model.get("compose-fsm",e).setInitialState("edit"),ns.Model.get("compose-message",e).expandMessage()
})},addQuickReplyAttach:function(e){ns.Model.get("compose-state",this.params).get(".quickReplyAttaches").push(e)},inQuickReply:function(){return ns.Model.get("quick-reply-state",this.params).toShowForm()}}})}(),function(){var e={_openDiskOnClick:function(e){e&&e.inQuickReply?Jane.c("Quick Reply","Кнопка Прикрепить",this._getMetrikaPart()):Jane.c("Кнопка Прикрепить",this._getMetrikaPart()),this._popup=ns.View.create("browse-disk",this.params),this._popup.on("close",this._openDiskOnClosePopup.bind(this)),this._popup.open(this._getPath()).then(this._openDiskOnRenderPopup,this)
},_openDiskOnRenderPopup:function(){$("body").append(this._popup.node)},_openDiskOnClosePopup:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_getMetrikaPart:function(){return this.METRIKA_PARTS[this.MODE]},_getPath:function(){return this.PATHS[this.MODE]},METRIKA_PARTS:{mail:"Клик по Прикрепить из почты",disk:"Клик по Прикрепить с диска"},PATHS:{mail:"/mail/",disk:"/disk/"}};ns.View.edefine("compose-attach-open-disk-mixin",{yateModule:"compose2",methods:_.extend({openDiskInit:function(){this.openDiskOnClick=this.openDiskOnClick.bind(this),this.$node.on("click",this.openDiskOnClick)
},openDiskDestroy:function(){this.$node.off("click",this.openDiskOnClick)},openDiskOnClick:function(e){e.inQuickReply=this.inQuickReply(),this._openDiskOnClick(e)},_popup:null,PATH:null},e)},"compose-attach-quick-reply-mixin",ns.View)}(),function(){ns.View.define("compose-field-phone-error-mixin",{yateModule:"compose2",methods:{getErrorMessage:function(){var e=this.getModel("compose-message"),t=e.getAllRecepients();if(t.length>1)return"Нельзя отправить смс-уведомление сразу нескольким получателям.";
var o=t.some(function(e){return ns.Model.get("account-information").isMyEmail(e.email)});return o?"Нельзя отправить копию письма в смс себе.":""}}})}(),function(){ns.View.define("compose-template-list-popup-mixin",{yateModule:"compose2",methods:{openTemplateListInit:function(){this._openTemplateListOnClick=this._openTemplateListOnClick.bind(this),this.$node.on("click",this._openTemplateListOnClick)},openTemplateListDestroy:function(){this.$node.off("click",this._openTemplateListOnClick),this.popup&&this.popup.close()
},_openTemplateListOnClick:function(){this.popup=ns.View.create("compose-template-list",this.params),this.popup.open({where:this.node,autofocus:!0})}}})}(),ns.View.edefine("message-quick-reply",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:action-start@show":"onActionStart","daria:MOPS:action-complete":"onHtmlInit"},models:{"module-compose":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onChangedShow"},message:!1,"scroller-message":!1,dimensions:{"ns-model-changed":!1,resize:"onResize"}},params:function(e){return{ids:e.ids,qrIds:e.ids}
},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state");return e.toShowForm()?"layout-quick-reply":e.isShowDone()?"layout-quick-reply-done":this.isMessageInDrafts()?"layout-quick-reply-empty":"layout-quick-reply-placeholder"},isMessageInDrafts:function(){return ns.Model.get("folders").isFolder(this.getModel("message").get(".fid"),["draft","template"])},onHtmlInit:function(){this.$node.toggleClass("is-hidden",this.isMessageInDrafts())},onShow:function(){this.fixedInit(),this.toggleStickyMode()
},onHide:function(){this.fixedDestroy(),this.invalidate()},onChangedShow:function(){this.isVisible()&&this.forceUpdate()},onPageBeforeLoad:function(e,t,o){o!==ns.page.currentUrl&&(Daria.composeEqualRoutes(t[0],t[1])||this.getModel("quick-reply-state").hideForm({silent:!0}))},onActionStart:function(e,t){"delete"===t.action&&this.getModel("quick-reply-state").hideForm()}}},"fixed-quick-reply-mixin",ns.View),ns.View.define("thread-quick-reply",{events:{"ns-view-hide":"invalidate","ns-page-before-load@show":"onPageBeforeLoad"},models:{messages:!1,"module-compose":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onChangedShow"}},params:function(e){var t=e.thread_id||e.ids;
return{qrIds:t,thread_id:t}},yateModule:"compose2",methods:{patchLayout:function(){var e="layout-thread-quick-reply-empty",t=this.getModel("messages").getLastReplyMessageQR();if(t){var o=this.getModel("quick-reply-state");e=o.toShowForm()?"layout-thread-quick-reply":"layout-thread-quick-reply-placeholder"}return e},onPageBeforeLoad:function(e,t,o){o!==ns.page.currentUrl&&(Daria.composeEqualRoutes(t[0],t[1])||this.getModel("quick-reply-state").hideForm({silent:!0}))},onChangedShow:function(){this.isVisible()&&this.forceUpdate()
}}}),ns.View.define("quick-reply-message",{events:{"xiva.mail.insert@show":"onXivaMailInsert"},models:{message:!1,"message-body":!1},params:{ids:null},yateModule:"compose2",methods:{onXivaMailInsert:function(e,t){if(Daria.utils.checkReplaceFakeMessage(t)){var o=no.jpath(".message.hdr_message_id",t),s=no.jpath(".message.mid",t),i=this.getModel("message-body").get(".info.message-id");i===o&&(ns.Model.get("state-message-thread-item",{ids:s}).setOpen(!0),ns.Model.get("message",{ids:s}).isValid()&&this.destroy())
}}}}),function(){var e={compose_check_failed:"Неверное значение compose_check.",virus_found:"Нельзя отправить сообщение, обнаружен вирус.",strongspam_found:"Нельзя отправить письмо, потому что оно кажется похожим на спам. Возможно, вы отправили слишком много писем сегодня.<br><br> Вы снова сможете отправлять письма примерно через сутки после прекращения любых попыток что-то отправить. Подробнее о причинах ошибки можно узнать <a href=http://help.yandex.ru/mail/spam/sending-limits.xml target=_blank>в нашей статье</a>.",incorrect_to:"Некорректный адрес получателя",incorrect_cc:"Некорректное поле Сс.",incorrect_bcc:"Некорректное поле Bcc.",msg_too_big:"Нельзя отправить или сохранить письмо, потому что оно слишком большое. Письмо сохранено в черновиках.",no_recipients:"Нет получателей.",fail_limit:"Слишком большой размер письма.",too_many_emails:"Превышен дневной лимит писем.",max_email_addr_reached:"Нельзя отправить письмо более чем 50&#160;адресатам одновременно.",no_data:"Произошла ошибка при передаче данных на&#160;сервер.",http_status_0:"Ошибка. Не удалось загрузить данные, так как нет интернета. Проверьте подключение и попробуйте ещё раз.",attachment_too_big:"Письмо не&#160;может быть отправлено: превышено количество пересылаемых писем. Вы&#160;можете одновременно пересылать не&#160;более 200&#160;писем суммарным объёмом до "+(Daria.IS_CORP?100:24)+" МБ.",internal_error:"Пожалуйста, повторите через несколько минут. <br /> Не обновляйте страницу, при обновлении текст письма потеряется.",access_denied:"Вы не можете отправлять почту",illegal_params:"Некоторые поля не заполнены или заполнены неверно"},t=[void 0,"","message-not-valid","captcha_request","need-confirm","attachments-failed"],o=["compose-forwarded-messages","compose-state","compose-fsm","compose-attachments","compose-notify-noreply-options","compose-signature","compose-message"],s=["to","cc","bcc"];
Daria.getPageComposeIds=function(){var e=ns.page.current.params,t=Daria.composeKey(e);return Daria.composeHasParams(t)?t:void 0},Daria.getRealComposeIds=function(e){var t=e.ids,o=ns.page.current.params;return!t&&i.cache.has(Daria.composeKey(o))&&"compose2"===ns.page.current.page&&o._cuid&&o.ids&&(t=o.ids),t},Daria.composeHasParams=function(e){var t=i.cache.get(e);return _.isUndefined(t)?!1:ns.Model.get("compose-message",t).isValid()},Daria.composeKey=function(e){return e&&e._cuid||"compose"},Daria.composeKeyParams=function(e){return{_cuid:Daria.composeKey(e)}
};var i=_.memoize(function(e){return _.pick(e,["ids","tids","oper","qrIds","_cuid"])},Daria.composeKey);ns.View.edefine("compose2",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroyed":"onDestroyed","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:delete":"onMessageRemoved","daria:vCompose2:send@show":"onSend","daria:vCompose2:save@show":"onSave"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"onLidsChange","ns-model:validation-error":"onValidationError","ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"showForgottenAttachmentsDialog"},"compose-sidebar-fsm":!1,"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"quick-reply-state":!1,"compose-fsm":{"ns-model-changed":!1,"# sending":"onSending","# cancel":"onCancel","# sent":"onSent","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1,captcha:!1},params:function(e){return i(e)
},ctor:function(){this._forgottenAttachView=null,this._popup=null,this._composeUpdate=_.debounce(this._composeUpdate.bind(this),50)},yateModule:"compose2",methods:{ERROR_CODES:e,_composeUpdate:function(){this.isVisible()&&this.update()},onInit:function(){this.autosaveInit()},onMessageRemoved:function(e,t){if(t.originalAction&&"remove.draft"===t.originalAction&&t.messageInfo&&t.messageInfo.data){var o=ns.router.generateUrl("messages",{current_folder:t.messageInfo.data.fid});ns.page.go(o)}},isQuickReply:function(){return this.getModel("quick-reply-state").toShowForm()
},onHtmlInit:function(){if(this.leaveInit(),"compose2"===ns.page.current.page&&ns.Model.get("focus").resetFocus(!0),!this.isQuickReply()&&!this.getModel("compose-sidebar-fsm").isCurrentState("edit")){var e=this.getModel("compose-message");if((e.isTemplate()||e.isDraft())&&e.mMessage){var t=ns.Model.get("messages-checked");t.resetChecked(),t.check(e.mMessage,!0)}}this.scrollToComposeTop()},onShow:function(){this.isDestroyed=!1,this.getModel("compose-fsm").switchOn(),this.autosaveStart(),this.leaveStart(),this.isQuickReply()||(ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}),this.attachFilesFromQuickReply())
},onHide:function(){this.autosaveStop(),this.leaveStop(),_.defer(function(){if("message"!==ns.page.current.page){var e=ns.Model.get("messages-checked");e.resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0})}})},onDestroyed:function(){this._destroy()},onPageBeforeLoad:function(e,t,o){if(o!==ns.page.currentUrl){var s=t[0],i=t[1];if(!Daria.composeEqualRoutes(s,i)){var n=i.params._cuid,a="template"===i.params.save_symbol&&!s.params.save_symbol;if(!a&&i.params.ids&&(!s.params.ids||s.params.ids!==i.params.ids)){var r=ns.Model.get("message",{ids:i.params.ids});
a=r.isTemplate()}var c=this.getModel("compose-sidebar-fsm");return c.isCurrentState("edit")?void("compose2"===i.page&&(Daria.composeHasParams(n)||(this.shouldСlearModel=!0),c.setState("cancel"))):void(("compose2"!==s.page||a||"compose2"!==i.page&&!Daria.composeHasParams(n))&&("compose2"!==s.page&&"compose2"===i.page&&Daria.composeHasParams(n)||(this.shouldСlearModel=!0,this._destroy())))}}},attachFilesFromQuickReply:function(){var e=this.getModel("compose-state"),t=e.get(".quickReplyAttaches"),o=this.getModel("compose-attachments");
_.isArray(t)&&t.length>0&&(t.forEach(function(e){o.addAttach(e)}),e.set(".quickReplyAttaches",[]))},onDraftSaved:function(e,t){if(this.isVisible()){var o=this.getModel("compose-state");if(o.get(".saveTemplateAndLeave"))return void o.set(".saveTemplateAndLeave",!1);if(o.get(".saveTemplateAndReset"))return o.set(".saveTemplateAndReset",!1),void this.hardResetCompose();var s=_(ns.page.current.params).pick("_cuid").assign({ids:t.mid}).value(),i=ns.router.generateUrl("compose2",s);ns.page.go(i,"replace")
}},hardResetCompose:function(){this.clean(),ns.page.go(ns.router.generateUrl("compose2"))},_destroy:function(){this.isDestroyed||(this.isDestroyed=!0,this.shouldСlearModel&&(delete this.shouldСlearModel,this.clean()))},setState:function(e,t){return this.getModel("compose-fsm").setState(e,t)},onSending:function(e,t){this.isVisible()&&this.setState("sent",t.data)},onCancel:function(){this.isVisible()&&(this.shouldСlearModel=!0)},onSent:function(){this.isVisible()&&(this.shouldСlearModel=!0)},onSendingToSent:function(e,t){return this.isVisible()?(this.closePopup(),this.send(t.data)):void 0
},onSendingToSentFailed:function(e,t){this.isVisible()&&(this.setState("edit"),_.contains(this.silentStatuses,t.error)||(this.showErrorPopup(t.error),ns.events.trigger("message.error",t.error)))},send:function(e){return e=_.extend({},{force:this.params.sendWithForce},e),this.getModel("compose-message").send(e)},silentStatuses:t,showErrorPopup:function(e){var t=this.getErrorMessageByCode(e);Daria.Dialog.notice({title:"Произошла ошибка",body:"<p>"+t+"</p>"})},getErrorMessageByCode:function(e){var t=this.ERROR_CODES[e];
return t||(t="Не удалось отправить сообщение."),t},showCaptcha:function(){if(this.isVisible()){var e=ns.View.create("compose-captcha");e.update().then(function(){Daria.Dialog.open({title:e.popupData.title,body:e.$node,width:e.popupData.width,onopen:function(){e.focusInput()},onclose:function(){e.invalidate(),e.destroy()}})})}},showForgottenAttachmentsDialog:function(e,t){if(this.isVisible()){var o=_.clone(this.params),s=this._forgottenAttachView=ns.View.create("compose-forgotten-attach",o);s.data=t,s.updateByLayout("forgotten-attach",o).then(this.onForgottenAttachUpdated.bind(this)),s.once("ns-view:close",this.onForgottenAttachClose.bind(this))
}},onForgottenAttachUpdated:function(){var e=this._forgottenAttachView;this.closePopup(),this._popup=Daria.Dialog.open({width:e.popupData.width,body:e.$node})},onForgottenAttachClose:function(){this.closePopup();var e=this._forgottenAttachView;setTimeout(function(){e.destroy(),e=null},0)},closePopup:function(){this._popup&&this._popup.isOpen()&&(this._popup.close(),this._popup=null)},showConfirmPopup:function(){this.isVisible()&&Daria.Dialog.confirm({body:'<div class="b-popup__p">Вы не заполнили поле «Кому». Отправить письмо?</div>',width:360,okValue:"Отправить",okHandler:function(){this.setState("sending",{force:!0})
}.bind(this),oncancel:function(){}})},onLidsChange:function(){this.isVisible()&&this._composeUpdate()},onValidationError:function(e,t){if(this.isVisible()){var o=_.find(s,function(e){return t.hasOwnProperty(e)});this.scrollToComposeTop(),this.getModel("compose-state").setFocusField(o,{force:!0})}},scrollToComposeTop:function(){this.node.scrollIntoView(!0)},clean:function(){_.each(o,function(e){this.getModel(e).destroy()},this);var e=ns.View.infoLite("compose-popular-contacts").params(this.params),t=ns.Model.get("compose-popular-contacts",e);
t.clean(),this.invalidate(),i.cache.delete(Daria.composeKey(this.params))},onSend:function(){this.setState("sending")},onSave:function(){this.setState("save")}}},"compose-autosave-mixin","compose-leave-mixin",ns.View)}(),function(){var e="compose2",t=ns.View.infoLite(e);ns.View.edefine("quick-reply",{models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onQuickReplyStateShow","ns-model:delete-draft":"onDeleteDraft"},"compose-sidebar-state":!1,"compose-sidebar-fsm":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"onAttachmentsForgotten"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# edit":"onEdit","# sent":"onSent","# sending":"onSending","# cancel":"onCancel","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:t.params,ctor:function(){this._xivaInsertMessages={},t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{_parentApply:function(e,o){t.methods[e]&&t.methods[e].apply(this,o)},onShow:function(){this._parentApply("onShow",arguments),this.getModel("compose-state").setFocusField("send"),this._countMetrika("Показ")},onEdit:function(){var e=ns.Model.get("message-draft",{ids:this.params.qrIds});if(e.isValid()){var t=this.getModel("compose-message").getDraftMid();e.setIfChanged(".mid",t)}},onSent:function(){this._parentApply("onSent",arguments);var e=ns.Model.get("message-draft",{ids:this.params.qrIds});
e.isValid()&&e.setIfChanged(".mid",void 0),this._countMetrika('Клик на "Отправить"')},onQuickReplyStateShow:function(){this.getModel("quick-reply-state").toShowForm()||(this.shouldСlearModel=!0)},onDeleteDraft:function(){this.isVisible()&&(this.shouldСlearModel=!0)},onDraftSaved:_.noop,scrollToComposeTop:_.noop,_onAfterSent:function(){return Daria.Statusline.hide("message-sending"),ns.events.trigger("message.sent"),this.getModel("quick-reply-state").showDone(),vow.Promise.resolve()},onAttachmentsForgotten:function(){this.getModel("compose-fsm").once("# edit",function(){this.setState("sending",{force:!0})
})},_countMetrika:function(e){Daria.isMessagePage()?Jane.c("Quiсk Reply","Письмо на отдельной странице",e):Jane.c("Quiсk Reply",e)}}},e)}(),ns.View.define("compose-send-loader",{models:{"compose-fsm":{"sending > sent":"showLoader","# *":"hideLoader"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{CLASS_HIDDEN:"is-hidden",showLoader:function(){this.$node.removeClass(this.CLASS_HIDDEN)},hideLoader:function(){this.$node.addClass(this.CLASS_HIDDEN)}}}),ns.View.define("compose-head",{params:ns.View.info("compose2").params,yateModule:"compose2"}),ns.View.define("compose-template-list",{models:{messages:!1,"compose-message":!1,"compose-state":!1,"compose-fsm":!1},events:{"click@show":"_onClick","click@show .js-template-item":"onTemplateClick","click@show .js-new-template":"onCreateTemplateClick","click@show .js-create-template":"onCreateTemplateClick","click@show .js-save-template":"onSaveTemplateClick"},ctor:function(){this._defaultOptions={withoutTail:!1,autofocus:!1,autoclose:!0},this._options={},this._popup=null
},yateModule:"compose2",params:function(e){return _.extend({},ns.View.info("compose2").params(e),{current_folder:ns.Model.get("folders").getFidBySymbol("template")})},methods:{onTemplateClick:function(e){var t=$(e.currentTarget).data("mid");if(t){Jane.c("Шаблоны:","Шаблоны дропдаун","Выбор шаблона");var o=this.getModel("compose-message");o.isDraft()||o.isReplyAny()||o.isForward()?ns.request(["message","message-body"],{ids:t}).then(this.onMessageBodyRequestSuccess.bind(this,o)):ns.page.go(ns.router.generateUrl("compose2",{ids:t}))
}},onMessageBodyRequestSuccess:function(e,t){var o=t[0],s=t[1];if(e.addTextFromMessageBody(s),0===e.getAllRecepients().length&&e.setRecepientsFromMessageBody(s),!e.get(".subj")){var i=o.get(".subject");i&&e.set(".subj",i)}},onCreateTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Новый шаблон");var e=ns.router.generateUrl("compose2",{save_symbol:"template"});ns.page.go(e)},onSaveTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Сохранить шаблон");var e=this.getModel("compose-message"),t=this.getModel("compose-fsm");
e.set(".save_symbol","template"),t.setState("save")},open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.updateByLayout("compose-template-list",this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onClick:function(){this.close()},_onAfterRender:function(){this._popup=nb.block(Jane.tt("compose2:js-compose-template-list")),this._popup.setContent(this.node),this._popup.on("nb-closed",this._onDestroyed.bind(this)),this._popup.open(this._options)
},_onDestroyed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.destroy()}}}),function(){ns.View.edefine("compose-template-list-button",{models:{},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){this.openTemplateListInit()},onHide:function(){this.openTemplateListDestroy()}}},"compose-template-list-popup-mixin")}(),ns.View.define("compose-field-message-resize",{yateModule:"compose2",methods:{messageResizeInit:function(){ns.assert(this.getModel("compose-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-state"),ns.assert(this.getModel("quick-reply-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель quick-reply-state"),ns.assert(this.getModel("compose-sidebar-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-sidebar-state"),ns.assert(this.getModel("compose-sidebar-fsm"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-sidebar-fsm"),this._messageResizeInitShow=this._messageResizeInitShow.bind(this),this._onChangeMessageHeight=this._onChangeMessageHeight.bind(this)
},messageResizeStart:function(){var e=this.getModel("compose-state");e.on("ns-model-changed.messageHeight",this._onChangeMessageHeight);var t=this.getModel("compose-sidebar-state");t.on("ns-model-changed.popupRect",this._messageResizeInitShow);var o=ns.Model.get("timeline-state");o.on("ns-model-changed.height",this._messageResizeInitShow),this._messageResizeInitShow()},messageResizeStop:function(){var e=this.getModel("compose-state");e.off("ns-model-changed.messageHeight",this._onChangeMessageHeight);
var t=this.getModel("compose-sidebar-state");t.off("ns-model-changed.popupRect",this._messageResizeInitShow);var o=ns.Model.get("timeline-state");o.off("ns-model-changed.height",this._messageResizeInitShow)},getHeight:function(){return this._getHeight()},onChangeHeight:function(){ns.assert(!1,"Daria.vComposeFieldMessageResize",'"onChangeHeight" must be implemented by subclass')},_onChangeMessageHeight:function(){this.onChangeHeight()},_getHeight:function(){var e=this.getModel("compose-state");return e.get(".messageHeight")
},_messageResizeInitShow:function(){var e=this.getModel("quick-reply-state");if(!e.toShowForm()){var t=this.$node.closest(".js-form").children(":last-child");if(t.length){var o=t[0].getBoundingClientRect();if(o&&(o.width||o.height)){var s,i=this.getModel("compose-sidebar-fsm"),n=0;if(i.isCurrentState("edit")?s=this.getModel("compose-sidebar-state").get(".popupRect").bottom:(s=this._$window.height(),n=ns.Model.get("timeline-state").get(".height")),s&&!(s<o.bottom)){var a=this.$node.outerHeight(!1)-10,r=Math.floor(a+s-o.bottom-n),c=this.getModel("compose-state");
c.setMessageHeight(r)}}}}}}}),ns.View.define("compose-field-base-abook",{models:{"compose-message":!1},events:{"click .js-field-caption":"onCaptionClick"},yateModule:"compose2",methods:{abookInit:function(){this._loadModulesOnce()},isAbookPopupAvailable:!0,onCaptionClick:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.showAbookContactsPopup("compose-field-caption")},showAbookContactsPopup:function(e){Jane.Services.runModules(["jane.abook.css","jane.abook.js","jane.abook.yate"],this._showPopupWhenReady.bind(this,e))
},_showPopupWhenReady:function(e){var t={};t[this.FIELD_NAME]=this.getModel("compose-message").getContacts(this.FIELD_NAME);var o=new vow.Deferred;o.promise().then(this.onAbookContactsSelected.bind(this),this.onAbookPopupClosed.bind(this)),ns.action.run("mail-common.abook-popup",{popupType:"select",emails:t,resultDeferred:o}),this._countAbookPopupShow(e)},onAbookContactsSelected:function(e){this.getModel("compose-message").setContacts(this.FIELD_NAME,e),this.onAbookPopupClosed()},onAbookPopupClosed:function(){this.focus()
},_countInfo:{sourceType:{"compose-field-caption":"через клик на подпись поля композа","compose-field-suggest":'через клик на "Все контакты" в саджесте'},fieldName:{to:"Кому",cc:"Копия",bcc:"Скрытая копия"}},_countAbookPopupShow:function(e){Jane.c(["АК в саджесте композа","показ попапа",this._countInfo.sourceType[e],this._countInfo.fieldName[this.FIELD_NAME]])},_loadModulesOnce:function(){var e=!1;return function(){e||(e=!0,Jane.Services.loadModules(["jane.abook.css","jane.abook.js","jane.abook.yate"]))
}}()}}),ns.View.define("compose-field-base-suggest",{yateModule:"compose2",methods:{suggestInit:function(e,t){this._suggestItemSelect=this._suggestItemSelect.bind(this),this._suggestValueSet=this._suggestValueSet.bind(this),this._suggestGetPositionNode=this._suggestGetPositionNode.bind(this);var o=$.extend({getPositionNode:this._suggestGetPositionNode,fieldType:this.FIELD_NAME,multiple:this.areYabblesDisabled(),position:{my:"left top",at:"left+9px bottom-1px",collision:"none"},showAbookPopupButton:this.isAbookPopupAvailable},t);
"phone"===e?this.suggestInstance=new Daria.Suggest.Phones(null,o):(o.exclude=function(){var e=this.getModel("compose-message").getAllRecepientEmails();return this.areYabblesDisabled()&&e[this.FIELD_NAME].pop(),e}.bind(this),this.suggestInstance=new Daria.Suggest.Contacts(null,o))},suggestStart:function(){return this.areYabblesDisabled()?(this.suggestInstance.on("select",this._suggestItemSelect),this.suggestInstance.on("value-set",this._suggestValueSet),this.suggestInstance.changeInputField(this.getControllerNode()),!0):!1
},suggestStop:function(){return this.areYabblesDisabled()?(this.suggestInstance.off("select",this._suggestItemSelect),this.suggestInstance.off("value-set",this._suggestValueSet),this.suggestInstance.destroy(),!0):!1},_suggestGetPositionNode:function(){return this.node},_suggestValueSet:function(e,t,o,s){this.setFieldData(s)},_suggestItemSelect:function(e,t,o){var s=o.item;switch(s.type){case"abook-popup-button":t.preventDefault(),this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")
}}}}),ns.View.define("compose-field-base-yabble",{models:{"compose-message":!1},yateModule:"compose2",methods:{CLASS_YABBLE_FOCUS:"mail-Yabble-FocusArea",yabbleInit:function(){ns.assert(this.getModel("compose-state"),"Daria.vComposeFieldBaseYabble","Должна быть определена модель compose-state"),this._yabbleSuggestItemSelect=this._yabbleSuggestItemSelect.bind(this),this._yabbleAfterSuggestItemSelect=this._yabbleAfterSuggestItemSelect.bind(this),this._yabbleOnChange=this._yabbleOnChange.bind(this),this._yabbleDragStart=this._yabbleDragStart.bind(this),this._yabbleDragEnd=this._yabbleDragEnd.bind(this),this._yabbleSingleTarget=this._yabbleSingleTarget.bind(this),this.yabbleCtor||(this.yabbleCtor=Daria.Yabble),this.yabbleType||(this.yabbleType="contact")
},yabbleStart:function(){if(this.areYabblesDisabled())return!1;var e={yabbleCtor:this.yabbleCtor,yabbleType:this.yabbleType};return this.suggestInstance&&(e.suggest=this.suggestInstance),this.maxItems&&(e.maxItems=this.maxItems),this._yabbleInstance=new Daria.Yabbles(this.getControllerNode(),e),this._yabbleInstance.val(this.getFieldData()),this._yabbleInstance.on("change",this._yabbleOnChange),this._yabbleInstance.on("dragenter",this._yabbleDragStart),this._yabbleInstance.on("dragleave",this._yabbleDragEnd),this._yabbleInstance.on("drop",this._yabbleDragEnd),this._yabbleInstance.on("single-target",this._yabbleSingleTarget),this.suggestInstance&&this.suggestInstance.on("select",this._yabbleSuggestItemSelect),this._customFocus=this._yabbleFocus,this._customIsFocused=this._yabbleIsFocused,this._customSyncDataToView=this._yabbleSyncDataToView,this._customSyncViewToData=this._yabbleSyncViewToData,this.onWaitSuggestChanged(),!0
},yabbleStop:function(){return this.areYabblesDisabled()?!1:(this.suggestInstance&&this.suggestInstance.off("select",this._yabbleSuggestItemSelect),this._yabbleInstance&&(this._yabbleInstance.off("dragenter",this._yabbleDragStart),this._yabbleInstance.off("dragleave",this._yabbleDragEnd),this._yabbleInstance.off("drop",this._yabbleDragEnd),this._yabbleInstance.off("change",this._yabbleOnChange),this._yabbleInstance.destroy(),this._yabbleInstance=null),this._customFocus=null,this._customIsFocused=null,this._customSyncDataToView=null,this._customSyncViewToData=null,!0)
},areBubblesNg:no.False,onWaitSuggestChanged:function(){var e=this.getModel("compose-state"),t=e.getFocusField(),o=e.getWaitSuggest();this.isVisible()&&this.FIELD_NAME===t&&o&&(this._yabbleInstance.focus(!0),e.setWaitSuggest(!1))},_yabbleSuggestItemSelect:function(e,t,o){t.preventDefault();var s=$(t.currentTarget),i=nb.block(t.currentTarget),n=o.item;switch(n.type){case"group":s.data("suggest",{tid:n.id,name:n.title,contacts:$.extend(!0,[],$.makeArray(n.contacts))}),i.setValue(n.title);break;case"contact":s.data("suggest",$.extend({},n)),i.setValue("phone"===this.FIELD_NAME?n.phone:n.email);
break;case"wsContainer":s.data("suggest",$.extend({},n)),i.setValue(n.email);break;case"popdom":s.data("suggest",{name:n.name,email:n.email}),i.setValue(n.email);break;case"abook-popup-button":this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}Daria.setZeroTimeout(this._yabbleAfterSuggestItemSelect)},_yabbleAfterSuggestItemSelect:function(){var e=this._yabbleInstance.add();e?e.focus():this.suggestInstance&&this.suggestInstance.options.yabble.blur()},_yabbleOnChange:function(){this.setFieldData(this._yabbleInstance.val())
},_yabbleDragStart:function(){this.$node.addClass(this.CLASS_YABBLE_FOCUS);var e=this.getModel("compose-state");e.setIfChanged(".isCcVisible",!0),e.setIfChanged(".isBccVisible",!0)},_yabbleDragEnd:function(){this.$node.removeClass(this.CLASS_YABBLE_FOCUS)},_yabbleSingleTarget:function(e,t){var o=Jane.FormValidation.obj2contact(t.value);this.getModel("compose-message").setSingleRecipient(o)},_yabbleFocus:function(){this._yabbleInstance.focus()},_yabbleIsFocused:function(){return this._yabbleInstance.isFocused()
},_yabbleSyncDataToView:function(){var e=this.getModel("compose-message").getContacts(this.FIELD_NAME);this._yabbleInstance.val(e)},_yabbleSyncViewToData:function(){this._yabbleInstance.recalcStrVal()}}}),ns.View.define("compose-field-base-yabble-ng",{models:{"compose-state":!1,"compose-message":!1},yateModule:"compose2",methods:{CLASS_YABBLE_FOCUS:"mail-Bubbles-FocusArea",yabbleInit:function(){_.bindAll(this,["_bubbleSuggestItemSelect","_bubbleSuggestOpen","_bubbleSuggestClose","_yabbleSyncViewToData","_bubbleDragStart","_bubbleDragEnter","_bubbleDragEnd","_bubbleEdit","_bubbleInput","_bubblesetFocus","_bubblesetBlur","_bubblesetKeydown","_bubblesetClick","_bubbleClick","_bubblesUpdate","_onBubbleDropdownDestroy","_onBubbleDropdownOpened","_onBubbleDropdownClosed","_onBubbleSmsLinkToggle","_onBubbleFieldValueChanged"]),this._bubblesUpdateDebounce=_.debounce(this._bubblesUpdate,100),this._bubbleClickDebounce=_.debounce(this._bubbleClick,200),this._onBubbleFieldValueChangedDebounce=_.debounce(this._onBubbleFieldValueChanged,50)
},yabbleStart:function(){if(this.areYabblesDisabled())return!1;var e=this.getControllerNode();return e.on({blur:this._bubblesetBlur,"bubble-input":this._bubbleInput,"bubble-edit":this._bubbleEdit,change:this._yabbleSyncViewToData,click:this._bubblesetClick,dragstart:this._bubbleDragStart,dragenter:this._bubbleDragEnter,dragleave:this._bubbleDragEnd,drop:this._bubbleDragEnd,focus:this._bubblesetFocus,keydown:this._bubblesetKeydown}),this.suggestInstance&&(this.$suggestProxy=this.$node.find(".js-suggest-proxy"),this.suggestInstance.on("select",this._bubbleSuggestItemSelect).on("open",this._bubbleSuggestOpen).on("close",this._bubbleSuggestClose)),this.getModel("compose-state").on("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").on("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce),this._customSyncDataToView=this._yabbleSyncDataToView,this._customSyncViewToData=this._yabbleSyncViewToData,this._customOnInput=_.noop,this._bubblesUpdateDebounce(),this._onBubbleFieldValueChanged(),!0
},yabbleStop:function(){return this.areYabblesDisabled()?!1:(this.getControllerNode().off(),this.suggestInstance&&(this.$suggestProxy=null,this.suggestInstance.off("select",this._bubbleSuggestItemSelect).off("open",this._bubbleSuggestOpen).off("close",this._bubbleSuggestClose),this.suggestInstance.destroy()),this.getModel("compose-state").off("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").off("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce),this._customSyncDataToView=null,this._customSyncViewToData=null,this._customOnInput=null,!0)
},areBubblesNg:no.True,_getBubbleset:function(){return this.getControllerNode()[0]},_bubbleSuggestOpen:function(){this._getBubbleset().options("disableControls",!0)},_bubbleSuggestClose:function(){this._getBubbleset().options("disableControls",!1)},_bubbleInput:function(e){this.$suggestProxy.val(e.originalEvent.detail.data).trigger("keydown")},_bubbleEdit:function(){this._bubbleClickDebounce.cancel(),this._bubbleDropdownDestroy()},_bubblesetFocus:function(){this.suggestInstance.changeInputField(this.$suggestProxy)
},_bubblesetBlur:function(){this.suggestInstance&&this.suggestInstance.hide()},_bubblesetKeydown:function(e){if(this.suggestInstance){var t=e.charCode||e.keyCode,o=Jane.Common.keyCode;switch(t){case o.TAB:this.suggestInstance.isOpen()&&this.suggestInstance.focusedSelect();break;case o.ENTER:case o.ESC:case o.UP:case o.DOWN:this.suggestInstance.isOpen()&&this.suggestInstance.$inputField.trigger(e)}}},onWaitSuggestChanged:function(){var e=this.getModel("compose-state"),t=e.getFocusField(),o=e.getWaitSuggest();
this.isVisible()&&this.FIELD_NAME===t&&o&&(this.getControllerNode().focus(),e.setWaitSuggest(!1))},_bubbleSuggestItemSelect:function(e,t,o){t.preventDefault();var s=o.item,i=this._getBubbleset();switch(i.focus(),s.type){case"group":i.addBubble(s.name,{"contact-tid":s.id,"contact-value":s.value,"contact-email":s.email,"contact-name":s.name,"contact-type":s.type});break;case"contact":i.addBubble(s.value,{"contact-cid":s.id,"contact-type":s.type});break;case"wsContainer":i.addBubble(s.value,{"contact-cid":s.id,"contact-type":s.type});
break;case"popdom":i.addBubble(s.value,{"contact-cid":s.id,"contact-type":s.type});break;case"abook-popup-button":this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}this._yabbleSyncViewToData()},_bubblesetChange:function(){var e=this.getControllerNode().prop("items"),t=e.map(Daria.Bubble.toString).join(",");this.setFieldData(t),this._bubblesUpdateDebounce()},_bubbleDragStart:function(){this.suggestInstance&&this.suggestInstance.hide();var e=this.getModel("compose-state");
e.setIfChanged(".isCcVisible",!0),e.setIfChanged(".isBccVisible",!0)},_bubbleDragEnter:function(){this.$node.addClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragEnd:function(){this.$node.removeClass(this.CLASS_YABBLE_FOCUS)},_yabbleSyncDataToView:function(){var e=this.getModel("compose-message").getContacts(this.FIELD_NAME).map(Jane.FormValidation.obj2contact).join(",");this._getBubbleset().setContent(e)},_yabbleSyncViewToData:function(){this.suggestInstance&&this.suggestInstance.hide(),this._bubbleDropdown&&this._bubbleDropdown.destroy(),this._bubblesetChange()
},_onBubbleFieldValueChanged:function(){if(this.getModel("compose-state").get(".isPhoneEnabled")){var e=this.getModel("compose-message"),t=e.getAllRecepients(),o=e.getContacts(this.FIELD_NAME);this.getControllerNode().toggleClass("mail-Bubbles-Sms",1===t.length&&1===o.length)}},_bubblesUpdate:function(){for(var e=this.getControllerNode(),t=e.prop("items"),o=t.length,s=[];o--;){var i=t[o];if(!i.hasAttribute("lock")){var n=new Daria.Bubble(i);n.needUpdate()&&(s.push(n.getHeadEmail()),i.setAttribute("lock","lock"))
}}if(s.length){var a,r=1/0,c=this;s.reduce(function(e,t){return t.length<Daria.Bubble.EMAIL_LEN_REQUEST&&(r+=t.length+1,r>Daria.Bubble.EMAIL_LEN_REQUEST&&(r=0,a=[],e.push(a)),a.push(t)),e},[]).forEach(function(t){var o=[],s=t.join(",");o.push({id:"abook-contacts",params:{emails:s}}),Daria.Config.workspace&&o.push({id:"abook-contacts",params:{emails:s,shared:1}}),ns.request(o).then(function(o){for(var s=o[0].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0}),i=o[1]?o[1].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0,shared:!0}):[],n=i.concat(s).reduce(function(e,t){return e[t.email]=!0,e
},{}),a=e.prop("items"),r=a.length;r--;){var l=a[r],d=new Daria.Bubble(l),u=d.getHeadEmail();n[u]&&d.applyTo(l)}c._bubblesetChange()})})}},_onBubbleDropdownDestroy:function(){this._bubbleDropdown=null},_onBubbleDropdownOpened:function(e,t){return _.get(t,"where.parentNode")?(_.defer(function(){var e=t.$node&&t.$node.find(".js-bubble-copy");if(e.length){var o=new Daria.Clipboard(e);o.on("ready",function(){if(t.where){var o=new Daria.Bubble(t.where).getHeadEmail();this.setText(o),e.removeClass("is-disabled")
}}),o.on("complete",function(){t.destroy()}),t.on("nb-closed",_.debounce(function(){o.destroy()},50))}}),this._onBubbleDropdownDestroy=t.destroy.bind(t),this._$window.one("scroll",this._onBubbleDropdownDestroy),this._$document.one("keydown",this._onBubbleDropdownDestroy),ns.events.once("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),void ns.events.once("daria:layout-changed",this._onBubbleDropdownDestroy)):void t.destroy()},_onBubbleDropdownClosed:function(e,t){this._onBubbleDropdownDestroy&&(this._$window.off("scroll",this._onBubbleDropdownDestroy),this._$document.off("keydown",this._onBubbleDropdownDestroy),ns.events.off("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.off("daria:layout-changed",this._onBubbleDropdownDestroy),delete this._onBubbleDropdownDestroy),t.destroy()
},_bubblesetClick:function(e){var t=$(e.target).closest("[bubble]")[0];if(t){var o=Boolean($(e.target).closest(".js-sms-open-link").length),s=!0;this._bubbleDropdown&&(s=this._bubbleDropdown.where!==t,this._bubbleDropdown.close()),this._bubbleClickDebounce(t,s,o)}else this.suggestInstance.show()},_bubbleClick:function(e,t,o){if(o||!t)return void(o&&this.getModel("compose-state").atrigger("sms-link-click"));this._bubbleDropdownPromise&&!this._bubbleDropdownPromise.isResolved()&&this._bubbleDropdownPromise.reject();
var s=new Daria.Bubble(e),i=vow.resolve();s.isGroup()?i=ns.request("abook-contacts",{tid:s.get("tid")}):s.isContact()&&(i=ns.request("abook-contact",{cid:s.get("cid")})),i.then(function(){e.parentNode&&this._bubbleOpenDropdown(s,e)},this),this._bubbleDropdownPromise=i},_bubbleOpenDropdown:function(e,t){var o={canCopy:Daria.Clipboard.canUse,contact:{isContact:e.isContact(),isGroup:e.isGroup(),email:e.getHeadEmail()},emails:e.get("email")};if(e.isGroup())o.contacts=ns.Model.get("abook-contacts",{tid:e.get("tid")}).get(".contact"),o.contacts=_(o.contacts).chain().reduce(function(e,t){return _.forEach(t.email,function(s){e.push({name:_.get(t,"name.full"),email:s.value,checked:-1!==o.emails.indexOf(s.value)})
}),e},[]).value();else if(e.isContact()){var s=ns.Model.get("abook-contact",{cid:e.get("cid")}).get(".email");o.emails=_(s).chain().map("value").concat(o.emails).compact().uniq().value()}this._bubbleDropdown=nb.block(ns.renderNode(o,"js-bubble-dropdown","compose2")),this._bubbleDropdown.on("nb-destroyed",this._onBubbleDropdownDestroy),this._bubbleDropdown.on("nb-opened",this._onBubbleDropdownOpened),this._bubbleDropdown.on("nb-closed",this._onBubbleDropdownClosed),this._bubbleDropdown.$node.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,t)).on("click",".js-bubble-single-target",this._onClickSingleTargetBubble.bind(this,t)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,t)).on("click",".js-bubble-add-to-abook",this._onClickAddAbookBubble.bind(this,t)).on("click",".js-bubble-change-email",this._onClickChangeEmailBubble.bind(this,t)).on("change",".js-bubble-change-group",this._onChangeGroupBubble.bind(this,t)),this._updateItemsGroupBubble(),this._bubbleDropdown.open({withoutTail:!1,autofocus:!1,animation:!1,where:t})
},_bubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.destroy()},_onClickRemoveBubble:function(e){this._bubbleDropdownDestroy(),this._getBubbleset().removeBubble(e)},_onClickSingleTargetBubble:function(e){this._bubbleDropdownDestroy();var t=new Daria.Bubble(e),o=this._getBubbleset();o.items.forEach(function(t){t!==e&&o.removeBubble(t)}),this.getModel("compose-message").setSingleRecipient(t.toString())},_onClickEditBubble:function(e){this._bubbleDropdownDestroy();var t=this._getBubbleset();
t.focus(),t.editBubble(e)},_onClickAddAbookBubble:function(e){this._bubbleDropdownDestroy(),this._onSuccessAddAbookBubble&&(ns.events.off("yabble.add-to-abook",this._onSuccessAddAbookBubble),this._onSuccessAddAbookBubble=null);var t=_.uniqueId(),o=new Daria.Bubble(e);ns.action.run("yabble.add-to-abook",{id:t,name:o.get("name"),email:o.getHeadEmail()}),this._onSuccessAddAbookBubble=_.bind(function(o,s){this._onSuccessAddAbookBubble=null,s.id===t&&e.parentNode&&this._bubblesUpdate()},this),ns.events.once("yabble.add-to-abook",this._onSuccessAddAbookBubble)
},_onClickChangeEmailBubble:function(e,t){this._bubbleDropdownDestroy();var o=$(t.currentTarget).data("email"),s=new Daria.Bubble(e);s.setEmail(o),s.applyTo(e),this._bubblesetChange()},_onChangeGroupBubble:function(e,t){var o=$(t.currentTarget),s=o.find("input"),i=s.prop("checked"),n=s.val(),a=new Daria.Bubble(e);i?a.appendEmail(n,o.data("name")):a.removeEmail(n),a.applyTo(e),this._updateItemsGroupBubble(),this._bubblesetChange()},_updateItemsGroupBubble:function(){if(this._bubbleDropdown){var e=this._bubbleDropdown.$node.find("input:checked");
e.closest(".js-bubble-change-group").toggleClass("is-disabled",1===e.length)}},_onBubbleSmsLinkToggle:function(e,t){this.getControllerNode().toggleClass("mail-Bubbles-Sms_hidden",!t)}}}),ns.View.define("compose-field-base-sms-controls",{yateModule:"compose2",methods:{smsControlsInit:function(){this.suggestItemButtonClick=this.suggestItemButtonClick.bind(this),this.onFieldValueChanged=this.onFieldValueChanged.bind(this),this.onPhoneFieldStateChanged=this.onPhoneFieldStateChanged.bind(this),this.smsLinkClick=this.smsLinkClick.bind(this)
},smsControlsStart:function(){var e=this.getModel("compose-message");e.on("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var t=this.getModel("compose-state");return t&&(t.on("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),t.on("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),t.on("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.on("button-click",this.suggestItemButtonClick),this._yabbleInstance&&this._yabbleInstance.root.on("sms-link-click",this.smsLinkClick),this.onPhoneFieldStateChanged(),!0
},smsControlsStop:function(){var e=this.getModel("compose-message");e.off("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var t=this.getModel("compose-state");return t&&(t.off("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),t.off("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),t.off("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.off("button-click",this.suggestItemButtonClick),this._yabbleInstance&&this._yabbleInstance.root.off("sms-link-click",this.smsLinkClick),!0
},onFieldValueChanged:function(){var e=this.getModel("compose-state").get(".isPhoneEnabled"),t=this.getModel("compose-state").get(".isPhoneVisible");if(e&&t){var o=this.getModel("compose-message"),s=o.getContacts(this.FIELD_NAME);1===s.length&&o.setPhoneIfExist(s[0].email)}},onPhoneFieldStateChanged:function(){var e=this.getModel("compose-state"),t=e.get(".isPhoneEnabled"),o=e.get(".isPhoneVisible"),s=e.get(".userHasValidatedPhone");this.suggestInstance&&Daria.Config.MAY_HAVE_SMS_COPY&&(this.suggestInstance.options.noSmsButton=!s),this.refreshSmsYabbles(t,o)
},refreshSmsYabbles:function(e,t){this._yabbleInstance&&(e&&!t?this._yabbleInstance.showSmsYabble():this._yabbleInstance.hideSmsYabble()),this.getModel("compose-state").atrigger("sms-link-toggle",e&&!t)},suggestItemButtonClick:function(e,t,o){o.button.hasClass("js-compose-add-phone")&&o.item.phone&&this.setPhoneValue(o.item.phone)},smsLinkClick:function(e,t){t=t||{},this.setPhoneValue(t.phone)},setPhoneValue:function(e){var t=this.getModel("compose-state"),o=t.get(".isPhoneEnabled");o&&(t.setIfChanged(".isPhoneVisible",!0),e&&this.getModel("compose-message").set(".phone",e),t.setFocusField("phone"))
}}}),ns.View.define("compose-field-base-resize",{yateModule:"compose2",methods:{resizeInit:function(){this._$resizeInputController=null,this._$resizeMeasurer=null,this._resizeMeasurerHeight=0,this._resizeKeypressPrevent=this._resizeKeypressPrevent.bind(this),this._resizeCheck=this._resizeCheck.bind(this),this._resizeCheckDebounce=_.debounce(this._resizeCheck,50)},resizeStart:function(){return this.areYabblesDisabled()?(this._$resizeInputController=this.getControllerNode(),this._resizeMeasurerInit(),this._resizeBindEvents(),!0):!1
},resizeStop:function(){return this.areYabblesDisabled()?(this._resizeUnbindEvents(),this._resizeMeasurerDestroy(),this._$resizeInputController=null,!0):!1},_resizeBindEvents:function(){this._$resizeInputController.on("keypress",this._resizeKeypressPrevent),this.on("ns-view-show",this._resizeCheck),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeUnbindEvents:function(){this._$resizeInputController.off("keypress",this._resizeKeypressPrevent),this.off("ns-view-show",this._resizeCheck),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)
},_resizeKeypressPrevent:function(e){e.which===Jane.Common.keyCode.ENTER&&e.preventDefault()},_resizeMeasurerInit:function(){this._$resizeMeasurer=$('<div class="is-vhidden">measurer</div>').insertAfter(this._$resizeInputController),this._resizeMeasurerHeight=this._$resizeMeasurer.height()},_resizeMeasurerDestroy:function(){this._$resizeMeasurer.remove(),this._$resizeMeasurer=null,this._resizeMeasurerHeight=0},_resizeCheck:function(){var e=1,t="auto";if(this._resizeMeasurerHeight){this._$resizeMeasurer.text(this.getFieldData()),this._$resizeMeasurer.width(this._$resizeInputController.width()),e=Math.ceil(this._$resizeMeasurer.height()/this._resizeMeasurerHeight);
var o=e;1>e?o=1:e>3&&(o=3),t=o*this._resizeMeasurerHeight}this._$resizeInputController.height(t).toggleClass("is-multiline",e>3)}}}),ns.View.define("compose-field-base-focus",{events:{"focusin@show .js-compose-field":"onFocus","focusout@show .js-compose-field":"onBlur"},yateModule:"compose2",methods:{FIELD_NAME:null,CLASS_FOCUSED:"is-focused",_customFocus:null,_customIsFocused:null,focusInit:function(){this.onFocusFieldChanged()},focusDestroy:function(){},onFocusFieldChanged:function(){var e=this.getModel("compose-state").getFocusField();
this.isVisible()&&this.FIELD_NAME===e&&this.focus()},onFocus:function(){this.toggleFocus(!0)},onBlur:function(){this.toggleFocus(!1)},toggleFocus:function(e){this.getModel("compose-state").setFocusField(e?this.FIELD_NAME:null,{silent:!0}),this.$node.toggleClass(this.CLASS_FOCUSED,e),this.$node.find(".js-compose-field-wrapper").toggleClass(this.CLASS_FOCUSED,e)},focus:function(){this._customFocus?this._customFocus():this.$node.find(".js-compose-field").focus(0)},isFocused:function(){return this._customIsFocused?this._customIsFocused():this.$node.find(".js-compose-field").is(":focus")
}}}),function(){ns.View.edefine("compose-field-base",{models:{"compose-message":!1,"compose-state":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","input@show .js-compose-field":"onInput"},params:{},ctor:function(){this.onFieldDataChanged=this.onFieldDataChanged.bind(this),this.yabbleCtor=Daria.Yabble},yateModule:"compose2",methods:{NEED_TO_EMULATE:Modernizr.ie9&&Modernizr.opera<15,_customSyncDataToView:null,_customSyncViewToData:null,getContextNode:function(){return this.$node.closest(".js-form")
},getControllerNode:function(){return this.$node.find(".js-compose-field")},setFieldData:function(e){var t={data:{needUpdate:!1}};this.getModel("compose-message").setIfChanged("."+this.FIELD_NAME,e,t)},getFieldData:function(){return this.getModel("compose-message").get("."+this.FIELD_NAME)},onFieldDataChanged:function(e,t,o,s){s=s||{},s.needUpdate!==!1&&this.syncDataToView()},syncDataToView:function(){this.isVisible()&&(this._customSyncDataToView?this._customSyncDataToView():this.getControllerNode().val(this.getFieldData()))
},syncViewToData:function(){if(this.isVisible())if(this._customSyncViewToData)this._customSyncViewToData();else{var e=this.getControllerNode().val();this.setFieldData(e)}},onInit:function(){},onShow:function(){this.startEmulateInputEvent(),this.focusInit(),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},onHide:function(){this.stopEmulateInputEvent(),this.focusDestroy(),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)
},startEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.startEmulateInputEvent(".js-compose-field")},stopEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.stopEmulateInputEvent()},onInput:function(e){if(e.target==e.currentTarget)if(this._customOnInput)this._customOnInput();else{var t=$(e.currentTarget);this.setFieldData(t.val())}},areYabblesDisabled:function(){return ns.Model.get("settings").isSet("disable_yabbles")}}},"compose-field-base-focus")}(),function(){var e="compose-field-base",t=ns.View.infoLite(e);
ns.View.defineNg("compose-field-to",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":ns.View.defineModelEvents({"ns-model-changed.to":"onFieldValueChanged"}),"compose-fsm":!1},mixins:["compose-field-base-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{FIELD_NAME:"to",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),t.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),t.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),t.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook",e)
}(),function(){var e="compose-field-base",t=ns.View.infoLite(e);ns.View.defineNg("compose-field-cc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-base-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{FIELD_NAME:"cc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),t.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),t.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),t.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook",e)
}(),function(){var e="compose-field-base",t=ns.View.infoLite(e);ns.View.defineNg("compose-field-bcc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-base-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{FIELD_NAME:"bcc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),t.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),t.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),t.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook",e)
}(),ns.View.define("compose-field-phone",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-state");return e.get(".isPhoneEnabled")?"layout-compose-field-phone-input":"layout-compose-field-phone-input-error"}}}),function(){var e="compose-field-base",t=ns.View.infoLite(e);
ns.View.edefine("compose-field-phone-input",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-message":!1},params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments),this.yabbleCtor=Daria.YabblePhone,this.yabbleType="phone",this.maxItems=1},yateModule:"compose2",methods:{FIELD_NAME:"phone",onInit:function(){this.resizeInit(),this.suggestInit("phone",{multiple:!1}),this.yabbleInit(),t.methods.onInit.apply(this,arguments)
},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),t.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),t.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-yabble",e)}(),function(){ns.View.define("compose-field-phone-input-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{}},"compose-field-phone-error-mixin")
}(),function(){var e="compose-field-base";ns.View.edefine("compose-field-subject",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){ns.View.info(e).ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"subj"}},"compose-field-base-hotkeys",e)}(),ns.View.define("compose-field-placeholder",{events:{"click@show":"onClick","click@show .js-recipient":"onClickRecipient","mouseenter@show .js-recipient":"onMouseEnterLeaveRecipient","mouseleave@show .js-recipient":"onMouseEnterLeaveRecipient","click@show .js-recipients-edit":"onClickEditButton","click@show .js-recipients-expand":"onClickYetButton"},models:{"quick-reply-state":{"ns-model-changed":"keepValid","ns-model-changed.formIsShown":"updateYetField"},"compose-state":!1,"compose-message":{"ns-model-changed":"keepValid","ns-model-changed.to":"invalidate","ns-model-changed.cc":"invalidate","ns-model-changed.bcc":"invalidate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onMouseEnterLeaveRecipient:function(e){var t=$(e.target).closest(".js-recipients"),o="mouseenter"==e.type;
t.toggleClass("has-inner-target",o)},updateYetField:function(){var e=this.getModel("quick-reply-state").get(".formIsShown");if(!e)return void this._setVerboseState(!1);var t=this.$node.find(".js-recipients-expand-to"),o=this.$node.find(".js-recipients"),s=o.width(),i=o.find(".js-recipient"),n=[],a=!1;i.each(function(e,t){var o=$(t).position().left,i=o+$(t).width();o>s&&n.push(t),i>s&&(a=!0)});var r=n.length>0,c="...";r&&(c+=" и ещё "+(n.length+this.getCopyCount())),t.text(c),t.toggleClass("is-visible",r||a)
},onClickYetButton:function(e){e.preventDefault(),e.stopPropagation(),this._setVerboseState(!0)},_setVerboseState:function(e){var t=this.getModel("quick-reply-state");t.setIfChanged(".verboseFieldPlaceholder",e)},onClick:function(){var e=this.getModel("quick-reply-state");e.setIfChanged(".showFieldPlaceholder",!1)},onClickRecipient:function(e){var t=this.getModel("compose-message"),o=t.get(".to"),s=t.get(".cc"),i=t.get(".bcc"),n=Jane.FormValidation.obj2contact({name:e.target.dataset.name,email:e.target.dataset.email});
(s||i||o!==n)&&(e.preventDefault(),e.stopPropagation(),t.setSingleRecipient(n))},onClickEditButton:function(e){e.preventDefault(),e.stopPropagation();var t=this.getModel("quick-reply-state");t.setIfChanged(".showFieldPlaceholder",!1);var o=this.getModel("compose-state"),s=$(e.target).data("field");o.setFocusField(s),o.setWaitSuggest(!0)},_getFieldItems:function(e){var t=this.getModel("compose-message"),o=t.get("."+e);return o?Jane.FormValidation.splitContacts(o):""},getRecipients:function(){return this._getFieldItems("to")
},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}}),ns.View.define("compose-field-to-extras",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"quick-reply-state":!1,"compose-field-extras-collection":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})
},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state"),t=this.getModel("compose-state"),o=this.getModel("compose-field-extras-collection"),s=ns.Model.get("userphones").hasActiveNumber(),i=s&&Daria.Config.MAY_HAVE_SMS_COPY;return o.clear(),e.toShowForm()?(e.get(".showFieldPlaceholder")||(i&&!t.isFieldVisible("phone")&&o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-phone"},this.params)).setData({type:"extras-phone"})),t.isFieldVisible("cc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),t.isFieldVisible("bcc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"}))),o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-go-to-compose"},this.params)).setData({type:"extras-go-to-compose"})),o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-qr-close"},this.params)).setData({type:"extras-qr-close"}))):(i&&!t.isFieldVisible("phone")&&o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-phone"},this.params)).setData({type:"extras-phone"})),t.isFieldVisible("cc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),t.isFieldVisible("bcc")||o.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"}))),"layout-compose-field-to-extras"
}}}),ns.View.define("compose-field-to-extras-cc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-cc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isCcVisible",!0)}}}),ns.View.define("compose-field-to-extras-bcc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();
var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-bcc").methods.FIELD_NAME;t.setFocusField(o),t.setIfChanged(".isBccVisible",!0)}}}),ns.View.edefine("compose-field-to-extras-qr-close",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick"},models:{"quick-reply-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()
},onHide:function(){this.disableOnSendingStop()},onClick:function(){var e=this.getModel("quick-reply-state");e.hideForm(),Daria.isMessagePage()&&Jane.c("Quiсk Reply","Письмо на отдельной странице","Клик на крестик")}}},"compose-disable-on-sending-mixin",ns.View),ns.View.define("compose-field-to-extras-go-to-compose",{events:{"click@show":"onClick"},models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{onClick:function(){this._openComposePage(),this._countMetrika()
},_openComposePage:function(){var e=_.omit(this.params,"qrIds"),t=ns.router.generateUrl("compose2",e);ns.page.go(t).then(function(){ns.Model.get("compose-fsm",e).setInitialState("edit"),ns.Model.get("compose-message",e).expandMessage()})},_countMetrika:function(){var e={"compose-attach-fake":"Клик на скрепку","compose-go-to-compose":'Клик на "Перейти в полную форму"'}[this.id];Daria.isMessagePage()&&e&&Jane.c("Quiсk Reply","Письмо на отдельной странице",e)}}}),ns.View.edefine("compose-go-to-compose",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2"},"compose-field-to-extras-go-to-compose"),ns.View.define("compose-field-to-extras-phone",{events:{"click@show":"onClick"},models:{"compose-message":!1,"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();
var t=this.getModel("compose-state"),o=ns.View.infoLite("compose-field-phone-input").methods.FIELD_NAME;if(t.get(".isPhoneEnabled")){t.setFocusField(o),t.setIfChanged(".isPhoneVisible",!0);var s=this.getModel("compose-message"),i=s.getAllRecepients();1===i.length&&s.setPhoneIfExist(i[0].email,!0)}else{var n=nb.block(Jane.tt("common:js-hint",{content:this.getErrorMessage()}));n.on("nb-closed",function(){this.destroy()}),n.open({where:this.$node,how:{autoclose:!0,at:"center bottom",my:"center top"}}),$(window).one("scroll",function(){n.close()
})}}}},"compose-field-phone-error-mixin"),ns.View.define("compose-field-to-notice-replyall",{events:{"click@show .js-reply-all-link":"onReplyAllLinkClick"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onReplyAllLinkClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),o=this.getModel("compose-message");o.changeRecipientsToOpposite(),t.set(".isReplyAllNoticeVisible",!1),t.set(".isCcVisible",Boolean(o.get(".cc")),{force:t.isCcVisible()}),t.set(".isBccVisible",Boolean(o.get(".bcc")),{force:t.isBccVisible()})
}}}),function(){ns.View.define("compose-field-to-notice-nda",{yateModule:"compose2"})}(),function(){ns.View.define("compose-field-cc-notice-nda",{yateModule:"compose2"})}(),function(){ns.View.define("compose-field-bcc-notice-nda",{yateModule:"compose2"})}(),function(){ns.View.define("compose-field-phone-notice-help",{yateModule:"compose2"})}(),ns.View.edefine("compose-recipients",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_getFieldItems:function(e){var t=this.getModel("compose-message").get("."+e);
return t?Jane.FormValidation.splitContacts(t):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}}),function(){var e={to_is_empty:"Поле не заполнено. Необходимо ввести адрес.",email_is_invalid:"Некорректный адрес электронной почты.",phone_is_invalid:"Неверный формат номера телефона. Пожалуйста, введите номер в формате +7 916 123 45 67",attachment_upload_is_failed:"Один или несколько файлов не смогли загрузиться"};
ns.View.define("compose-field-error-mixin",{yateModule:"compose2",methods:{FIELD_NAME:null,getErrorMessage:function(){var t=this.getModel("compose-message").getFieldError(this.FIELD_NAME);return e[t]}}})}(),function(){var e="to";ns.View.define("compose-field-to-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:e}},"compose-field-error-mixin")}(),function(){var e="phone";ns.View.define("compose-field-phone-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:e}},"compose-field-error-mixin")
}(),function(){var e="cc";ns.View.define("compose-field-cc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:e}},"compose-field-error-mixin")}(),function(){var e="bcc";ns.View.define("compose-field-bcc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:e}},"compose-field-error-mixin")}(),ns.View.define("compose-field-att_ids-error",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"att_ids"}},"compose-field-error-mixin"),ns.View.define("compose-field-to-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.to":"composeUpdate","ns-model-changed.isReplyAllNoticeVisible":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.errors.to":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})
},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("to")&&t.isNdaNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("to")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-to"
}}}),function(){ns.View.define("compose-field-cc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.cc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.errors.cc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"cc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");
return o.clear(),e.getFieldError("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("cc")&&t.isNdaNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("cc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-cc"}}})}(),function(){ns.View.define("compose-field-bcc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.bcc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.errors.bcc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"bcc"})
},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");return o.clear(),e.getFieldError("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("bcc")&&t.isNdaNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("bcc")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-bcc"
}}})}(),ns.View.define("compose-field-phone-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.phone":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.errors.phone":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"phone"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),o=this.getModel("compose-field-notices");
return o.clear(),e.getFieldError("phone")?o.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})):t.isFieldVisible("phone")&&t.isFieldEnabled("phone")&&o.insert(ns.Model.get("compose-field-notice",_.extend({type:"help"},this.params)).setData({type:"help"})),"layout-compose-field-notices-phone"}}}),ns.View.define("compose-field-att_ids-notices-wrapper",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.errors.att_ids":"onErrorChanged"},"compose-field-notices":!1,"compose-state":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"att_ids"})
},ctor:function(){this._autoHide=!1,this.autoHideDebounce=_.debounce(this.autoHide.bind(this),5e3)},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-field-notices");return t.clear(),!this._autoHide&&e.getFieldError("att_ids")&&t.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),"layout-compose-field-notices-att_ids"},onShow:function(){var e=this.getModel("compose-field-notices");
e.models.length&&this.autoHideDebounce()},onHide:function(){this.autoHideDebounce.cancel()},onErrorChanged:function(){this._autoHide=!1,this.composeUpdate()},autoHide:function(){this._autoHide=!0;var e=this.getModel("compose-field-notices");e.clear(),this.composeUpdate()}}}),ns.View.define("compose-fields-wrapper",{models:{"compose-state":!1,"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.showFieldPlaceholder":"composeUpdate","ns-model-changed.verboseFieldPlaceholder":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("quick-reply-state");
return e.toShowForm()&&e.get(".showFieldPlaceholder")?"layout-compose-fields-placeholder":"layout-compose-fields"}}}),function(){ns.View.define("compose-popular-contacts",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","click .js-contact":"onContactClick","click .js-close":"onCloseClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onRecepientFieldChanged","ns-model-changed.cc":"onRecepientFieldChanged","ns-model-changed.bcc":"onRecepientFieldChanged"},"compose-popular-contacts":!1},params:function(e){return _.extend({},ns.View.info("compose2").params(e),{count:10})
},ctor:function(){this.onMouseEnter=this.onHover.bind(this,!0),this.onMouseLeave=this.onHover.bind(this,!1),this._$closeButton=null},yateModule:"compose2",methods:{onHtmlInit:function(){this._$closeButton=this.$node.find(".js-close")},onHtmlDestroy:function(){this._$closeButton=null},onContactClick:function(e){var t=$(e.currentTarget),o=["email","name"],s=_.zipObject(o,_.map(o,function(e){return t.data(e)})),i=this.getModel("compose-popular-contacts").getContact(s);this.getModel("compose-message").appendContact("to",i),this.updateContacts()
},onCloseClick:function(){var e=ns.Model.get("settings");e.setSettingOff(e.POPULAR_CONTACTS_SETTING_NAME),this.getModel("compose-state").trigger("ns-model:contacts:redraw")},onHover:function(e){this._$closeButton.toggleClass("is-hidden",!e)},onRecepientFieldChanged:function(){this.updateContacts(),this.composeUpdate()},updateContacts:function(){var e=this.getModel("compose-message").getAllRecepients();this.getModel("compose-popular-contacts").actualizeUsedContacts(e)}}})}(),function(){ns.View.define("compose-popular-contacts-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model:contacts:redraw":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=ns.Model.get("settings");
return e.isSet(e.POPULAR_CONTACTS_SETTING_NAME)?"layout-compose-popular-contacts":"layout-compose-popular-contacts-empty"}}})}(),function(){ns.View.define("compose-popup-button",{yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposePopupButton",onHtmlInit:function(){this.initNbs()},onHtmlDestroy:function(){this.destroyNbs()},initNbs:function(){this.nbs={},this.nanoislands&&(_.each(this.nanoislands.blocks,function(e,t){this.nbs[t]=nb.$block(e,this.$node)},this),this._nbsInited=!0,this.bindNbs())
},destroyNbs:function(){this.unbindNbs(),this._nbsInited=!1,nb.destroy(this.node)},bindNbs:function(){this.handleBinding("on")},unbindNbs:function(){this.handleBinding("off")},handleBinding:function(e){this._nbsInited&&this.nanoislands&&_.each(this.nanoislands.events,function(t,o){var s;o=o.split(" ");var i=o[0],n=o[1],a=o[2],r=this.nbs[n];if(!r)return void ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist nanoblock with name of "+n);switch(s=3===o.length?this.nbs[n].$node.find(a):this.nbs[n],e){case"on":s.on(i,this[t].bind(this));
break;default:s.off(i)}},this)},showBubble:function(){this.containerSelector||ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist selector of container for popup");var e=this.nbs.popup,t=!e.isOpen();return t?(e.open({where:this.$node.find(this.containerSelector),how:{at:"top",my:"bottom"}}),vow.resolve(e)):vow.reject()},setCheckboxState:function(e,t){var o=this.nbs[e];return o?void(o.isChecked()!==t&&(t?o.check():o.uncheck())):void ns.assert(!1,this.ASSERT_CLASS_NAME,"Can't find nbCheckbox with name of "+e)
}}})}(),ns.View.define("compose-action-buttons",{models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e,t,o=this.getModel("compose-message"),s=this.getModel("compose-state");return o.isTemplate()?o.isNewTemplate()?(e="compose-save-link",t="layout-compose-action-buttons-new-template"):(e="compose-send-link",t="layout-compose-action-buttons-template"):(e="compose-send-link",t="layout-compose-action-buttons"),s.set(".activeActionButtonView",e),t
}}}),function(){ns.View.define("compose-save-link",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-save-button":"onSave"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()
},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSave:function(){this.getModel("compose-state").set(".saveTemplateAndLeave",!0),this.getModel("compose-message").once("ns-model:draft-saved",function(){var e=ns.Model.get("folders").getFidBySymbol("template"),t=ns.router.generateUrl("messages",{current_folder:e});ns.page.go(t)}),this.setState("save")}}},"compose-disable-on-sending-mixin")}(),function(){var e={size:"m",text:"Отправить",highlight:!0,"class":["js-send-button"],type:"submit",attrs:{tabindex:"10",title:"Отправить письмо"+Daria.Shortcuts.getShortcutLabelFor("Send","compose2",!0)}};
ns.View.define("compose-send-link",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroy":"onHtmlDestroy","click .js-send-button":"onSendingToSent"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText","ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1,"compose-sidebar-fsm":!1,"quick-reply-state":!1},ctor:function(){this._nbButton=null
},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onHtmlInit:function(){nb.init(this.node),this._nbButton=nb.$block(".js-send-button",this.node)},onHtmlDestroy:function(){nb.destroy(this.node),this._nbButton=null},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSendingToSent:function(){this.composeMetrics(),this.setState("sending")},getButtonSpec:function(){var t=this.getModel("compose-state"),o=t.get(".submitButtonText"),s=t.get(".activeActionButtonView");
return e.highlight="compose-send-link"===s,o&&(e.text=o),e},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this._nbButton.setContent(e)},composeMetrics:function(){var e="";e=this.getModel("quick-reply-state").toShowForm()?"QR":this.getModel("compose-sidebar-fsm").isCurrentState("edit")?"sidebar-compose":"compose",Jane.c("Отправка письма",e)}}},"compose-disable-on-sending-mixin")}(),function(){ns.View.define("compose-cancel-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick","keydown@show window":"onKeydown"},models:{"compose-fsm":!1,"compose-sidebar-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()
},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},onClick:function(){this.getModel("compose-fsm").setState("cancel")},onKeydown:function(e){this.getModel("compose-sidebar-fsm").isCurrentState("edit")&&e.keyCode===Jane.Common.keyCode.ESC&&(e.preventDefault(),this.getModel("compose-fsm").setState("cancel"))}}},"compose-disable-on-sending-mixin")}(),function(){var e="compose-send-link",t=ns.View.infoLite(e);ns.View.edefine("compose-send-button-complex",{models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.send_time":"onChangedSendTime"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendingMessage"},"compose-sidebar-fsm":!1,"quick-reply-state":!1},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-send":"onSendingToSent"},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){_.bindAll(this,["onClickSendtime","onClosedSendtimePopup"])
},methods:{onShow:function(){t.methods.onShow.apply(this,arguments),this.nbSendtime=nb.$block(".js-sendtime",this.node),this.nbSendtime.on("click",this.onClickSendtime),this.nbSend=nb.$block(".js-send",this.node)},onHide:function(){t.methods.onHide.apply(this,arguments),nb.destroy(this.node)},onClickSendtime:function(e){e.preventDefault(),this._sendtimePopup?this._sendtimePopup.close():(this._sendtimePopup=ns.View.create("compose-send-button-complex-popup",_.clone(this.params)),this._sendtimePopup.on("closed",this.onClosedSendtimePopup),this._sendtimePopup.open({where:e.currentTarget}))
},onClosedSendtimePopup:function(){delete this._sendtimePopup},onChangedSendTime:function(){this.getModel("compose-message").get(".send_time")?this.nbSendtime.check():this.nbSendtime.uncheck()},onSendingMessage:function(){this.getModel("compose-message").get(".send_time")&&Jane.c("Click in compose","отправить сегодня в ...","отправка письма с настройкой")},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this.nbSend.setContent(e)}}},e)}(),ns.View.define("compose-send-button-complex-popup",{events:{"ns-view-show":"_onShow","click@show .send_time-date":"_onClickSendDateTime","click@show .js-help":"_onClickShowHelp","click@show .js-close":"_onClickClose","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll","daria:layout-changed@show":"_onScroll"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!0,autoclose:!0,how:{my:"center bottom",at:"center top"}},this._options={},this._popup=null,this._date=null
},yateModule:"compose2",methods:{open:function(e){return this._date=Jane.Date.parseCalendarDate(this.getModel("compose-message").get(".send_time")),this._options=_.extend({},this._defaultOptions,e),this._dateValidation(),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},close:function(){_.method("close")(this._popup)},_onClickClose:function(){Jane.c("Click in compose","отправить сегодня в ...","клик на крестик"),this.close()},_onScroll:function(){var e=_.get(this._popup,"node.widget");
_.method("_position")(e)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-send-button-complex-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){this.trigger("opened")},_onClosed:function(e,t){t.destroy(),this.trigger("closed")},_onDestroyed:function(){delete this._popup,this._options={},this.destroy()
},_onShow:function(){this._nbTime=nb.$block(".js-time",this.node),this._nbTime.on("nb-changed",this._onChangedTime.bind(this)),this._nbActivate=nb.$block(".js-activate",this.node),this._nbActivate.on("nb-checked",this._onCheckedActivate.bind(this)),this._nbActivate.on("nb-unchecked",this._onUncheckedActivate.bind(this));var e=Daria.passportNow(),t=new Date(e),o=new Date(e);o.setFullYear(o.getFullYear()+1),this.$node.find(".send_time-date").date_input({action:"click",zIndex:105,container:this.$node,usePosition:!0,autoOrientation:!0,minDate:t,maxDate:o,dateToString:this._dateToString,stringToDate:this._stringToDate,keydownHandler:!1,setInputVal:this._onSetInputVal.bind(this),getInputVal:this._onGetInputVal.bind(this)}),this._updateDisplay()
},_onGetInputVal:function(){return this._dateToString(this._date)},_onSetInputVal:function(e){var t=this._stringToDate(e);if(t){var o=t.getFullYear(),s=t.getMonth(),i=t.getDate();(this._date.getFullYear()!==o||this._date.getMonth()!==s||this._date.getDate()!==i)&&(this._date.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),this._updateDisplay())}},_onClickSendDateTime:function(e){e.stopPropagation(),e.preventDefault(),this._nbActivate.isChecked()||this._nbActivate.check()},_onCheckedActivate:function(){Jane.c("Click in compose","отправить сегодня в ...","выбор чекбокса"),this._nbTime.enable(),this._updateData()
},_onUncheckedActivate:function(){this._nbTime.disable(),this._updateData()},_onChangedTime:function(){var e=this._nbTime.getState(),t=e.value&&e.value.match(/^(\d{2}):(\d{2})$/);if(t){var o=parseInt(t[1],10);o!==this._date.getHours()&&(this._date.setHours(o,0,0,0),this._updateDisplay())}},_updateDisplay:function(){if(this._dateValidation())this._updateDisplay();else{this.$node.find(".send_time-date").text(this._toHumanFormat(this._date));var e=new Date(Daria.passportNow());e.setHours(e.getHours(),0,0,0);
var t=new Date(this._date),o=_.times(24).filter(function(o){return t.setHours(o,0,0,0),t>e}).map(this._dateItemGenerate);this._nbTime.setSource(o),this._nbTime.setState(this._dateItemGenerate(this._date.getHours())),this._updateData()}},_dateItemGenerate:function(e){var t=Jane.Common.n(e)+":00";return{text:t,value:t}},_dateToString:function(e){return Jane.Date.format("%F",e)},_stringToDate:function(e){var t=String(e||"").match(/^(\d{2,4})\-(\d{2})\-(\d{2})$/);return t?new Date(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)):null
},_toHumanFormat:function(e){var t=new Date(Daria.passportNow()),o=e.getFullYear(),s=e.getMonth(),i=e.getDate();return o===t.getFullYear()&&s===t.getMonth()&&i===t.getDate()?"сегодня":Jane.Date.format("%Date_dBY_year",e)},_dateValidation:function(){var e=new Date(Daria.passportNow());return e.setHours(e.getHours()+1,0,0,0),!this._date||this._date<e?(this._date=e,!0):!1},_onClickShowHelp:function(){var e=this.$node.find(".js-compose-sendtime-help-text");e.hasClass("is-hidden")&&Jane.c("Click in compose","отправить сегодня в ...","клик на вопросик"),e.toggleClass("is-hidden")
},_updateData:function(){var e=this.getModel("compose-message"),t=null;this._nbActivate.isChecked()&&(t=Jane.Date.format("%Date_FT",this._date)),e.setIfChanged(".send_time",t)}}}),ns.View.edefine("compose-button-translate-apply",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1,"compose-sidebar-fsm":!1,"quick-reply-state":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-edit"),Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Клик на Редактировать")
}}},"compose-send-link"),ns.View.edefine("compose-button-translate-close",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1,"compose-sidebar-fsm":!1,"quick-reply-state":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-cancel"),Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Клик на Отмена")
}}},"compose-send-link"),ns.View.define("compose-message-toolbar-button-common",{events:{"ns-view-show":"_onNsViewShow"},yateModule:"compose2",methods:{_onNsViewShow:function(){this.rect=this.node.getBoundingClientRect()},checkShortlink:function(){return this.$node.hasClass("is-shortlink")},isShortlink:function(){return this._isShortlink},setShortlink:function(){this._isShortlink=!0,this.$node.addClass("is-shortlink")},removeShortlink:function(){this._isShortlink=!1,this.$node.removeClass("is-shortlink")
}}}),ns.View.edefine("compose-message-toolbar-spellcheck",{models:{"compose-state":!1},yateModule:"compose2"},"compose-message-toolbar-button-common"),function(){ns.View.define("compose-attach-area",{events:{"ns-view-show":"onShow","click@show .js-eml-preview":"previewEml","daria:vComposeAttachArea:retryAttach@show":"onRetryAttach"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){var e=this.getModel("compose-attachments"),t=this.getModel("compose-message"),o=this.getModel("compose-state");
e.init({node:this.node,ids:this.params.ids,operation:this.params.oper,mComposeMessage:t,mComposeState:o}),(this.params.ids||e.hasFiles())&&(e.drawAttaches(),t.markSaved())},onDraftSaved:function(e,t){if(!this.isVisible())return void this.invalidate();var o=this.getModel("compose-attachments");o.updateAfterSave(t.attachments,t.mid);var s=this.getModel("compose-message");s.markSaved()},onRetryAttach:function(e,t){this.getModel("compose-attachments").retryAttach(t.id)}}},"preview-eml-mixin")}(),function(){ns.View.define("compose-footer",{models:{"compose-message":!1,"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.appended":"onAttachmentsAppended"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onAttachmentsAppended:function(){this.isVisible()&&Jane.DOM.placeInViewport(this.node)
}}})}(),function(){var e="compose-field-base",t=ns.View.infoLite(e);ns.View.edefine("compose-from",{events:{"ns-view-htmlinit":"onHtmlInit","keydown@show .js-compose-field":"onInputKeydown"},models:{"account-information":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"forceUpdate"},"compose-sidebar-state":{"ns-model-changed":!1,"ns-model-changed.popupRect":"resizeField"}},params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{FIELD_NAME:"from_name",onHtmlInit:function(){this._nbEmailSelect=nb.$block(".js-compose-changemail",this.$node),this._nbEmailSelect.on("nb-changed",this.onEmailChange.bind(this)),this._$input=this.$node.find(".js-compose-field"),Modernizr.ie11&&(this.resizeField=this.resizeFieldIE,this._$inputFakeDiv=this.$node.find(".js-compose-field-fake")),this.resizeField()},resizeField:function(){this.isVisible()&&(this._$input.width(0),this._$input.width(this._$input[0].scrollWidth))
},resizeFieldIE:function(){this.isVisible()&&(this._$input.width(0),this._$inputFakeDiv.html(this._$input.val()),this._$input.width(this._$inputFakeDiv.width()+2))},onInputKeydown:function(e){(e.keyCode===Jane.Common.keyCode.ENTER||e.keyCode===Jane.Common.keyCode.ESC)&&(e.preventDefault(),this._$input.blur())},onInput:function(){this.resizeField(),t.methods.onInput.apply(this,arguments)},onEmailChange:function(e,t){this.getModel("compose-message").set(".from_mailbox",t.value)}}},e)}(),function(){ns.View.define("compose-signature-list-popup",{events:{"click@show .js-signature-add-button":"_onClickAddSignature","click@show .js-signature-list-item":"_onClickSelectFromList"},models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0,how:{at:"center+60px bottom"}},this._options={},this._popup=null
},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-list-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)
},_onOpened:function(){Jane.c("Подписи","Окно выбора","Показ")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._signatureIsSelected||Jane.c("Подписи","Окно выбора","Закрыто без выбора")},_getSignatureList:function(){return this.getModel("compose-signature").getSignatureList()},_onClickSelectFromList:function(e){this._signatureIsSelected=!0;var t=$(e.currentTarget),o=parseInt(t.attr("data-signature-index"),10);
0===o&&Jane.c("Подписи","Окно выбора","Выбор первой"),Jane.c("Подписи","Окно выбора","Выбор подписи");var s=this.getModel("compose-signature"),i=s.getSignatureList(),n=i.signs[o].convert;this.trigger("select",n),this._popup.close()},_onClickAddSignature:function(){this._signatureIsSelected=!0;var e=ns.View.create("compose-signature-add-popup",this.params);e.open(),this._popup.close()}}})}(),function(){ns.View.define("compose-signature-add-popup",{models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null
},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-add-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)
},_onOpened:function(){Jane.c("Подписи","Окно выбора","Окно добавления","Показ"),this._popup.$node.on("click",".js-save",this._onSave.bind(this)),this._popup.$node.on("click",".js-cancel",this._onClosed.bind(this))},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._clickSave||Jane.c("Подписи","Окно выбора","Окно добавления","Закрыть без добавления")},_onSave:function(){this._clickSave=!0,Jane.c("Подписи","Окно выбора","Окно добавления","Добавление");
var e=$.trim(this._popup.$node.find(".js-signature-new").val());if(e){var t=Daria.signs.getHtml(),o=_.any(t,function(t){return Daria.signs.compare(t.convert,e)});return o?void this._popup.close():void Daria.signs.addSignature({text:_.escape(e)},this._onSaveSuccess.bind(this))}},_onSaveSuccess:function(e,t){this._popup.close(),e?Daria.Statusline.showMsg({name:"signature.append.result",body:"Подпись добавлена"}):_.contains(t,"signs.maxcount")?Daria.Dialog.notice({body:"<p>К сожалению, нельзя добавить более 20 подписей.</p>",width:350}):_.contains(t,"signs.maxlen")?Daria.Dialog.notice({body:"<p>Подпись должна быть не длиннее 10000 символов. Пожалуйста, сократите.</p>",width:350}):Daria.Statusline.showMsg({name:"signature.append.result",body:"Ошибка при добавлении подписи"})
}}})}(),ns.View.define("compose-message-editor-bottom-buttons",{params:ns.View.info("compose2").params,yateModule:"compose2"}),ns.View.define("compose-message-editor-top",{params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-message-editor-top"}}}),ns.View.define("compose-message-editor-bottom",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.editorMaximize":"editorViewUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-state").get(".editorMaximize");
return e===CKEDITOR.TRISTATE_ON?"layout-compose-message-editor-bottom":"layout-compose-message-editor-bottom-buttons-empty"},editorViewUpdate:function(){this.getEditor().execCommand("viewUpdate")}}}),function(){var e="compose-field-base",t=ns.View.infoLite(e),o=795,s=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onChangeHeight","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorPastefile","onEditorSwitchedMode","onEditorMaximize","_applyTmpContent"];
ns.View.edefine("compose-message-editor",{models:{"module-editor":!1,"quick-reply-state":!1,"compose-sidebar-state":!1,"compose-sidebar-fsm":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"onFromMailboxChanged"},"compose-attachments":!1,"compose-signature":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged","daria:mComposeState:translate-edit":"onTranslateEdit","daria:mComposeState:translate-cancel":"onTranslateCancel"}},events:{"click@show .cke_button__translate":"onClickShowTranslator"},params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments),_.bindAll(this,s),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,50),this.onChangeHeightDebounce=_.debounce(this.onChangeHeight,50)
},yateModule:"compose2",methods:{TOOLBAR_HEIGHT:47,FIELD_NAME:"send",getConfig:function(){var e,t,o=this,s={},i=_.get(ns.page.current,"params.translate","").match(/^([a-z]{2,3})\-([a-z]{2,3})$/);return i?(e=i[1],t=i[2]):this.params.ids&&(e=this.getModel("compose-message").getLanguage(),t=Daria.Translate.getDefaultLangTo(e)),CKEDITOR.editorConfig(s),_.extend(s,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,maximize:this.onEditorMaximize,"pastefile:dropfile":this.onEditorPastefile,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark,"translate:enabled":function(){o.onChangeHeight(),o.$node.addClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!0)
},"translate:disabled":function(){o.onChangeHeight(),o.$node.removeClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!1)}},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),translateInfo:"//yandex.ru/support/mail-new/web/letter/translation.xml#translation-outgoing",translateAutoEnable:i,translateFrom:e,translateTo:t,pastefileGetPlaceholderContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document.body),new CKEDITOR.dom.element(e)
},pastefileGetDropContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document),e},translate:function(e,t,s,i){i||(i=Daria.Translate.getDefaultLangTo(o.getModel("compose-message").getLanguage()));var n="wysiwyg"===e.mode?"html":"plain",a={text:t,format:n,lang:i};return s&&i&&(a.lang=s+"-"+i),new vow.Promise(function(e,t){ns.request("do-translate",a).then(function(t){var o=_.find(t,"id","do-translate"),n=(o.get(".text")||[]).join(""),a=o.get(".detected.lang");e({data:n,langFrom:s||a,langTo:i})
},t)})},translateLangSelect:function(e,t,s,i){return new vow.Promise(function(e,n){var a="_popupTranslateSelectLang_"+i,r=o[a];if(r)return r.close(),void n();var c=_.assign({},o.params,{currentLang:t});r=ns.View.create("translate-select-lang",c),r.on("selected",function(t,o){e({lang:o,direction:i}),this.close()}),r.on("closed",function(){delete o[a],n()}),r.open({where:s.$}),o[a]=r})}},this)),s},getEditor:function(){var e=CKEDITOR.instances[this.editorId];return e&&"ready"===e.status?e:void 0},getEditorId:function(){return this.editorId
},onInit:function(){this.messageResizeInit(),t.methods.onInit.apply(this,arguments)},onShow:function(e,t,s){this._timings=s,this._timings.showEditor=Date.now(),this._timings.versionEditor=CKEDITOR.version,this.messageResizeStart();var i=this.getModel("compose-message"),n=this.getConfig();n.height=this.getHeight()-this.TOOLBAR_HEIGHT,n.startupMode=i.isHtmlType()?"wysiwyg":"source",n.viewParams=_.clone(this.params),n.firstSignature=ns.Model.get("settings").isSet("signature_top"),n.firstSignatureMatch=Daria.signs.getSignatureMatch(),n.hasSignature=this.getModel("compose-signature").hasSignatureControl(),n.fileInputMultiple=Daria.Config["input-multiple"],n.canShowDisk=this.getModel("compose-state").hasDisk()&&!Daria.Config["is-corp"],this._timeoutEditorCreate=setTimeout(function(){this.getControllerNode().width()<o&&(n.toolbar="Min"),CKEDITOR.replace(this.getEditorId(),n)
}.bind(this),0);var a=this.getControllerNode();a.on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),i.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged);var r=this.getModel("compose-state");r.setIfChanged(".editorMode",n.startupMode)},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.onChangeHeightDebounce.cancel(),this.messageResizeStop(),this.destroyEditor()
},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){var o=this.getModel("compose-state");o.setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()
}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark();var e=this.getModel("quick-reply-state").getTmpContentAndRemove();e&&(this._timeoutApplyTmpContent=_.defer(this._applyTmpContent,e))},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())
},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},onChangeHeight:function(){var e=this.getHeight();this.getControllerNode().height(e).css("min-height",e);var t=this.getEditor();t&&t.resize("100%",e)},syncViewToData:function(e){if(this.isVisible()){var t=this.getEditor();if(t&&("edit > sending"===e&&this.getModel("compose-state").get(".translationEnabled")&&(t.execCommand("translate_apply"),Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Клик на Отправить перевод")),t.checkDirty())){var o=t.getData();
"undefined"!=typeof o&&(this.setFieldData(o),t.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,{callback:function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings),this.syncDataToView(),this.onFocusFieldChanged(),this.onChangeHeightDebounce()},onEditorChange:function(){this.syncViewToData()
},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);t!==!1&&(e.data.dataValue=t)}},onEditorPastefile:function(e){this.getModel("compose-attachments").addAttach({input:null,files:e.data.files})},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",s=t.getData(),i=this.getModel("compose-state");
i.setIfChanged(".editorMode",t.mode);var n=this.getModel("compose-message");n.setIfChanged(".ttype",o),this.setFieldData(s),t.resetDirty();var a=ns.Model.get("settings");"source"===t.mode?a.setSettingOff("enable_richedit"):a.setSettingOn("enable_richedit")},onEditorMaximize:function(e){var t=this.getModel("compose-state");t.setIfChanged(".editorMaximize",e.data),e.data===CKEDITOR.TRISTATE_OFF&&(this.$node.toggleClass("mail-Compose-Field-Translate",t.get(".translationEnabled")),this.onChangeHeightDebounce()),_.defer(function(){this.getModel("compose-message").expandMessage()
}.bind(this))},onFromMailboxChanged:function(){var e=this.getEditor();if(e){var t=_.first(this.getModel("compose-signature").getSignatureList().signs);t&&e.fire("signature:set",t.convert)}},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();
if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var s=e.getSelection(),i=s&&!s.isLocked&&s.getRanges();t.setIfChanged(".editorBookmark",i)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");Daria.setSelection(e.editable().$,o)}else{var s=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(s)&&s.length){var i=e.getSelection();
i&&i.selectRanges(s)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}},onTranslateEdit:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_apply")}},onTranslateCancel:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_toggle",!1)}},onClickShowTranslator:function(){var e=this.getEditor();if(e){var t=e.getCommand("show_translator");if(t)switch(t.state){case CKEDITOR.TRISTATE_ON:Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Клик на Перевести");
break;case CKEDITOR.TRISTATE_OFF:Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Клик на Отмена")}}}}},"compose-field-message-resize",e)}(),function(){ns.View.define("compose-autosave-status",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","click .mail-ui-Link":"togglePopup"},models:{"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){this._nbPopup=null
},yateModule:"compose2",methods:{onHtmlInit:function(){nb.init(this.node),this._nbPopup=nb.$block(".js-template-popup",this.node),this.bindEvents()},onHtmlDestroy:function(){this.unbindEvents(),nb.destroy(this.node)},bindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.on("click",".js-template-link",this.onClickTemplateLink.bind(this))},unbindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.off("click")},onClickTemplateLink:function(e){e.preventDefault(),this._nbPopup.close(),this.getModel("compose-message").set(".save_symbol","template"),this.getModel("compose-fsm").setState("save")
},togglePopup:function(e){this._nbPopup.isOpen()?this._nbPopup.close():this._nbPopup.open({where:e.target,how:{at:"top",my:"bottom"},autoclose:!0})},onDraftSaved:function(){this.getModel("compose-state").setLastSaveTime(),this.composeUpdate()}}})}(),function(){ns.View.edefine("compose-attach-buttons-wrapper",{models:{"compose-state":!1,"compose-fsm":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()
},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},patchLayout:function(){return"layout-compose-attach-buttons-wrapper"}}},"compose-disable-on-sending-mixin","compose-attach-quick-reply-mixin",ns.View)}(),ns.View.define("compose-attach-button-mail",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"mail",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()
}}},"compose-attach-open-disk-mixin"),ns.View.define("compose-attach-button-disk",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"disk",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()}}},"compose-attach-open-disk-mixin"),ns.View.define("compose-attach-button-computer",{events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-htmldestroy":"_onNsViewHtmldestroy","click@show .js-controller":"_onClickController","change@show .js-controller":"_onChangeController"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_$controllerNode:null,_onNsViewHtmlinit:function(){this._$controllerNode=this._getControllerNode().clone()
},_onNsViewHtmldestroy:function(){this._$controllerNode=null},_onClickController:function(){this.inQuickReply()?Jane.c("Quick Reply","Кнопка Прикрепить","Клик по Прикрепить с компьютера"):Jane.c("Кнопка Прикрепить","Клик по Прикрепить с компьютера")},_onChangeController:function(e){var t={input:e.target,files:e.target.files};this.inQuickReply()?(this.addQuickReplyAttach(t),this._openComposePage()):this.getModel("compose-attachments").addAttach(t)},_getControllerNode:function(){return this.$node.find(".js-controller")
},_onNsModelAttachmentsAdded:function(){this._$controllerNode.clone().replaceAll(this._getControllerNode())}}},"compose-attach-quick-reply-mixin"),function(){var e="Внимание! Ваше письмо пока не&#160;отправлено",t=550;ns.View.define("compose-captcha",{events:{"ns-view-show":"onShow","click .js-captcha-submit":"send","keydown .js-captcha-input":"onInputKeydown","click .js-captcha-another-image":"showAnotherImage"},models:{captcha:!1,"compose-message":!1,"compose-fsm":!1},yateModule:"compose2",params:ns.View.info("compose2").params,methods:{popupData:{title:e,width:t},onShow:function(){this.focusInput()
},showAnotherImage:function(){this.getModel("captcha").invalidate(),this.update()},onInputKeydown:function(e){e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.send())},getInputValue:function(){return $.trim(this.$node.find(".js-captcha-input").val())},focusInput:function(){this.$node.find(".js-captcha-input").focus()},send:function(){var e=this.getModel("compose-message"),t=this.getInputValue();return t?(e.set(".captcha_entered",t),e.set(".captcha_key",this.getModel("captcha").get(".key")),this.getModel("compose-fsm").setState("sending",{force:!0}),void Daria.Dialog.close()):(this.focusInput(),!1)
}}})}(),function(){ns.View.define("compose-forgotten-attach",{events:{"click .js-close":"onClose","click .js-forgotten-attach-send":"onSend"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"onAttachAdded"},"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{popupData:{width:440},data:{},onSend:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!0}),this.getModel("compose-fsm").setState("sending",{force:!0}),this.triggerCloseEvent()
},onAttachAdded:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},onClose:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},triggerCloseEvent:function(){this.trigger("ns-view:close")}}})}(),ns.View.edefine("compose-forgotten-attach-button",{models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:function(e){return _.extend({},ns.View.info("compose2").params(e),e)
},yateModule:"compose2"},"compose-attach-button-computer"),function(){ns.View.define("compose-forwarded-messages",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":!1,"compose-message":!1,"compose-forwarded-messages":{"ns-model-changed":"composeUpdate"}},params:ns.View.info("compose2").params,ctor:function(){this.onCheckboxChanged=this.onCheckboxChanged.bind(this)},yateModule:"compose2",methods:{onHtmlInit:function(){var e=this;nb.init(this.node),this.$node.find(".js-message-checkbox").each(function(t,o){var s=nb.block(o);
s.on("nb-changed",e.onCheckboxChanged)})},onHtmlDestroy:function(){nb.destroy(this.node)},onCheckboxChanged:function(e,t){var o=t.isChecked()?"checkMessage":"uncheckMessage";this.getModel("compose-forwarded-messages")[o](t.getValue())}}})}(),ns.View.define("compose-labels-wrapper",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message");return e.hasUserLabels()?"layout-compose-labels":"layout-compose-labels-empty"
}}}),function(){ns.View.define("compose-labels",{events:{"click@show .js-compose-label-unlabel":"onClickRemoveLabel"},models:{labels:!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"invalidate"}},params:ns.View.infoLite("compose2").params,ctor:function(){this.getDataForLabel=this.getDataForLabel.bind(this)},yateModule:"compose2",methods:{getDataForLabel:function(e){return this.getModel("labels").getLabelById(e)},getDataForLabels:function(){var e=this.getModel("compose-message").getUserLabels();
return e?_.map(e,this.getDataForLabel):[]},onClickRemoveLabel:function(e){var t=e.currentTarget.dataset.lid;this.getModel("compose-message").removeLid(t)}}})}(),function(){ns.View.define("compose-notify-noreply-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-destroy":"onHtmlDestroy"},models:{"compose-sidebar-fsm":!1,"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.messageHeight":"showFirstVisitPopup","ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"},"compose-notify-noreply-options":{"ns-model-changed":!1,"ns-model-changed.currentTimeDelta":"onChangedCurrentTimeDelta","ns-model-changed.alwaysNotify":"onChangedAlwaysNotify","ns-model-changed.enabledNotify":"onChangedEnabledNotify"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyNoreplyButton",nanoislands:{blocks:{notifyCheckbox:".js-compose-notify-noreply-button",popup:".js-compose-noreply-notify-popup",firstVisitPopup:".js-noreply-first-visit-popup",toggleCheckbox:".js-compose-noreply-toggle-checkbox",alwaysCheckbox:".js-compose-noreply-always-notify-checkbox",daysSelect:".js-compose-noreply-days-select"},events:{"click notifyCheckbox":"onNotifyCheckboxClick","nb-checked notifyCheckbox":"onNotifyCheckboxChecked","nb-unchecked notifyCheckbox":"onNotifyCheckboxUnchecked","nb-checked toggleCheckbox":"onToggleCheckboxChecked","nb-unchecked toggleCheckbox":"onToggleCheckboxUnchecked","nb-checked alwaysCheckbox":"onAlwaysCheckboxChecked","nb-unchecked alwaysCheckbox":"onAlwaysCheckboxUnchecked","nb-changed daysSelect":"onDaysSelectChanged","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-notify-noreply-button",onShow:function(){this.isEnabledNotify()?this.addNotifyToMessage():this.removeNotifyFromMessage()
},isMinimize:function(){return this.getModel("compose-sidebar-fsm").isCurrentState("edit")||this.getModel("compose-state").get(".translationEnabled")},isSaveSentEnabled:function(){return ns.Model.get("settings").isSet("save_sent")},isEnabledNotify:function(){return this.getModel("compose-notify-noreply-options").get(".enabledNotify")},showFirstVisitPopup:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options");e.wasFirstVisitPopupShown()||(this.nbs.firstVisitPopup.open({where:this.containerSelector,how:{at:"top",my:"bottom"}}),e.setFirstVisitPopupWasShown())
}},hasCurrentTimeDelta:function(){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta(),o=this.nbs.daysSelect.getState(),s=Number(o.value);return t.value===s},replaceTextInWaitForReply:function(e,t){e.$node.find(".js-nb-icon-wait-for-reply").text(t)},resetTextInWaitForReply:function(){this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,"Напомнить")},onChangedCurrentTimeDelta:function(){if(this.isVisible()&&!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta();
this.nbs.daysSelect.setState(t)}},onChangedAlwaysNotify:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options"),t=e.get(".alwaysNotify");this.setCheckboxState("alwaysCheckbox",t),t&&Jane.c({"Click in compose":{"напомнить, если в течение 5 дней не будет получен ответ на письмо":'выбор чекбокса "Напоминать всегда"'}})}},onChangedEnabledNotify:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options"),t=this.isEnabledNotify();if(this.setCheckboxState("notifyCheckbox",t),this.setCheckboxState("toggleCheckbox",t),t){var o=e.getCurrentTimeDeltaLocalizedText();
this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,o),Jane.c({"Click in compose":{"Напомнить, если в течение 5 дней не будет получен ответ на письмо":"выбор чекбокса"}}),this.addNotifyToMessage()}else this.resetTextInWaitForReply(),this.removeNotifyFromMessage()}},onNotifyCheckboxClick:function(){this.isSaveSentEnabled()?this.showBubble():Daria.Dialog.confirm({body:"<p>У вас отключено сохранение писем в папке «Отправленные». Включите его, чтобы воспользоваться напоминанием.</p>",okValue:"Включить",cancelValue:"Не включать",okHandler:function(){var e=ns.Model.get("settings");
e.setSettingOn("save_sent"),e.setSettingOn("no_reply_notify"),this.getModel("compose-notify-noreply-options").initData()}.bind(this)})},onNotifyCheckboxChecked:function(){this.isSaveSentEnabled()&&this.isEnabledNotify()||this.nbs.notifyCheckbox.uncheck()},onNotifyCheckboxUnchecked:function(){this.isSaveSentEnabled()&&this.isEnabledNotify()&&this.nbs.notifyCheckbox.check()},getNotifyLabelId:function(){var e=ns.Model.get("labels");return jpath(e.getWaitingForReplyLabel(),".lid")[0]},addNotifyToMessage:function(){var e=this.getNotifyLabelId();
if(e){var t=this.getModel("compose-message"),o=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta().value;t.addLid(e),t.setIfChanged(".remind_period",o)}},removeNotifyFromMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message");t.removeLid(e),t.setIfChanged(".remind_period",null)}},onToggleCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!0)},onToggleCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!1)
},onAlwaysCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!0)},onAlwaysCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!1)},onDaysSelectChanged:function(){if(!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=this.nbs.daysSelect.getState();e.setCurrentTimeDelta(t),this.nbs.popup.close()}},onClosePopupClick:function(){Jane.c({"Click in compose":{"напомнить, если в течение 5 дней не будет получен ответ на письмо":"клик на крестик"}}),this.nbs.popup.close()
},onSendEmail:function(){this.isVisible()&&this.isEnabledNotify()&&Jane.c({"Click in compose":{"Напомнить, если в течение 5 дней не будет получен ответ на письмо":"отправка письма с настройкой"}})}}},"compose-popup-button")}(),function(){var e="compose-popup-button";ns.View.define("compose-notify-on-send-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-sidebar-fsm":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.notify_on_send":"onChangedNotifyOnSend"}},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.closeBubble=this.closeBubble.bind(this)
},methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyOnSend",nanoislands:{blocks:{checkbox:".js-compose-remind-button",popup:".js-compose-remind-popup"},events:{"nb-checked checkbox":"onChecked","nb-unchecked checkbox":"onUnchecked","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-remind-button",isMinimize:function(){return this.getModel("compose-sidebar-fsm").isCurrentState("edit")||this.getModel("compose-state").get(".translationEnabled")},onChangedNotifyOnSend:function(){if(this.isVisible()){var e=this.getModel("compose-message");
switch(e.get(".notify_on_send")){case"yes":this.showBubble(),this.setCheckboxState("checkbox",!0),Jane.c({"Click in compose":{"уведомление о получении":"выбор чекбокса"}});break;default:this.setCheckboxState("checkbox",!1),clearTimeout(this._popupTimeout)}}},onChecked:function(){this.getModel("compose-message").set(".notify_on_send","yes")},onUnchecked:function(){this.getModel("compose-message").set(".notify_on_send",null)},onClosePopupClick:function(){Jane.c({"Click in compose":{"уведомление о получении":"клик на крестик"}}),this.closeBubble()
},closeBubble:function(){clearTimeout(this._popupTimeout),this._$window.off("scroll",this.closeBubble),ns.events.off("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.off("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.off("daria:layout-changed",this.closeBubble),this.nbs.popup.close()},showBubble:function(){this.super_.showBubble.call(this).then(this._activateClosingTimeout.bind(this))},_activateClosingTimeout:function(){var e=Daria.timify({seconds:3});this._popupTimeout=setTimeout(this.closeBubble,e),this._$window.one("scroll",this.closeBubble),ns.events.once("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.once("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.once("daria:layout-changed",this.closeBubble)
}}},e)}(),function(){var e="/disk/";ns.View.define("browse-disk",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","daria:vBrowseDisk:close@show":"_onClose","click .js-browse-disk-close":"_onClose","click .js-browse-disk-attach":"attachSelected","click .js-finder-crumb":"onCrumbClick","dblclick .js-finder-resource":"onResourceDblClick"},ctor:function(){this.LAYOUT_PULL_Z_INDEX_CLASS="b-layout__inner_pull"},models:{"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onHtmlInit:function(){this.$dialog=this.$node.find(".js-browse-disk-dialog"),this.$paranja=this.$node.find(".b-paranja"),this.onNotFound=this.onNotFound.bind(this),this.onSelected=this.onSelected.bind(this),this.openFolderDebounce=_.debounce(this.openFolder.bind(this),0)
},onShow:function(){this.nbButtonAttach=nb.$block(".js-browse-disk-attach",this.$dialog),nb.init(this.node),ns.events.on("disk-resources.not-found",this.onNotFound),ns.events.on("disk-resources.selected",this.onSelected)},onHide:function(){nb.destroy(this.node),this._diskResourcesDeselect(),delete this.nbButtonAttach,ns.events.off("disk-resources.not-found",this.onNotFound),ns.events.off("disk-resources.selected",this.onSelected)},_onClose:function(e,t){Jane.c("Аттачи из Диска","Отмена прикрепления"),this.close(t)
},open:function(t){t=t||e,Daria.Dialog.close();var o=ns.Model.get("disk-resources"),s=_.extend({},this.params,{path:t,sort:o.getDefaultSort(t),order:o.getDefaultOrder(t)});return this.updateByLayout("browse-disk",s).then(this._showDialog,this)},close:function(e){this._diskResourcesDeselect(),this._hideDialog(),e&&this.reset(),this.invalidate(),this.trigger("close")},_diskResourcesDeselect:function(){var e=ns.Model.get("disk-resources");e.deselect()},_hideDialog:function(){this.$dialog.addClass("g-invisible"),this.$paranja.addClass("g-hidden"),this.$dialog.closest(".b-layout__inner").removeClass(this.LAYOUT_PULL_Z_INDEX_CLASS),$.Shortcuts.modalListOff("finder")
},_showDialog:function(){this.$dialog.removeClass("g-invisible"),this.$paranja.removeClass("g-hidden"),this.$dialog.closest(".b-layout__inner").addClass(this.LAYOUT_PULL_Z_INDEX_CLASS),$.Shortcuts.modalListOn("finder"),Jane.c("Аттачи из Диска","Открытие диалога")},openFolder:function(e){if(!this._running){this._running=!0,this.openFolderDebounce.cancel();var t=ns.Model.get("disk-resources"),o=_.extend({},this.params,{path:e,sort:t.getDefaultSort(e),order:t.getDefaultOrder(e)});this.update(o).then(function(e){var t=e.async;
return t.length?Vow.all(t):Vow.fulfill()}).then(this.__openFolder,this)}},__openFolder:function(){this.$node.find(".b-finder__resource_selected").removeClass("b-finder__resource_selected"),this._running=!1},attach:function(e){var t=this._getFileResourceById(e);t&&(this.getModel("compose-attachments").addAttach({id:e,resource:t}),this.close())},quickReplyAttach:function(e){var t=this._getFileResourceById(e);if(t){this.addQuickReplyAttach({id:e,resource:t});var o=this.params;this.close(),this.params=o,this._openComposePage()
}},attachAction:function(e){return this.inQuickReply()?this.quickReplyAttach(e):this.attach(e)},attachSelected:function(){var e=ns.Model.get("disk-resources"),t=e.getSelected();return t?this.attachAction(t):void 0},_getFileResourceById:function(e){return ns.Model.get("disk-resources").find(e)},reset:function(){delete this.params.path},onSelected:function(e,t){this.canAttachResource(t.now)?this.nbButtonAttach.enable():this.nbButtonAttach.disable()},canAttachResource:function(e){if(!e)return!1;var t=ns.Model.get("disk-resources"),o=t.find(e);
if(!o)return!1;var s=0===e.indexOf("/mail/"),i=s&&"dir"===o.type;return i?!1:!0},onCrumbClick:function(e){var t=$(e.currentTarget);this.openFolder(decodeURIComponent(t.data("id")))},onResourceDblClick:function(e){var t=$(e.currentTarget),o=decodeURIComponent(t.data("id")),s=t.data("type");"dir"===s?this.openFolder(o):"file"===s&&this.attachAction(o)},onNotFound:function(e,t){if(404==t.http_status){var o=Daria.utils.dirname(this.params.path)+"/",s=ns.Model.get("disk-resources");s.clearCacheByParams({path:o}),this.openFolderDebounce(o)
}}}},"compose-attach-quick-reply-mixin")}(),ns.View.define("browse-disk-crumbs",{models:{"disk-default-folders":!0,"disk-resources":!0},"params-":["sort","order","offset"],yateModule:"compose2"}),ns.View.define("browse-disk-listing",{models:{"disk-resources":!0,"disk-default-folders":!0},"params-":["offset"],events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-hide":"_onNsViewHide","ns-view-show":"_onNsViewShow","mousedown@show .js-finder-resource":"select","scroll@show .js-finder-listing":"loadMoreDebounce","disk-resources.selected@show":"onselect"},ctor:function(){this.SELECTED_CLASS="b-finder__resource_selected",this.LOADING_CLASS="b-finder__listing_portion",this.COMPLETE_CLASS="b-finder__listing_complete",this.PRELOAD_OFFSET=50,this.loadMoreDebounce=_.debounce(this.loadMore.bind(this),200),this.__update=this.__update.bind(this),this.__loadMore=this.__loadMore.bind(this)
},yateModule:"compose2",methods:{_onNsViewHtmlinit:function(){this.$listing=this.$node.find(".js-finder-listing"),this.$listing.toggleClass(this.COMPLETE_CLASS,this.models["disk-resources"].__complete)},_onNsViewShow:function(){this.listingHeight=this.$listing.children(".js-finder-loader").position().top,this.onselect(null,{now:ns.Model.get("disk-resources").getSelected()})},_onNsViewHide:function(){this.loadMoreDebounce.cancel(),ns.Model.get("disk-resources").deselect()},select:function(e){ns.Model.get("disk-resources").select(decodeURIComponent($(e.currentTarget).data("id")))
},onselect:function(e,t){t.before&&this.$node.find('[data-id="'+encodeURIComponent(t.before)+'"]').removeClass(this.SELECTED_CLASS),t.now&&this.$node.find('[data-id="'+encodeURIComponent(t.now)+'"]').addClass(this.SELECTED_CLASS)},loadMore:function(){this.loading||this.$listing.scrollTop()+this.$listing.outerHeight()>=this.listingHeight-this.PRELOAD_OFFSET&&(this.loading=!0,this.$listing.addClass(this.LOADING_CLASS),ns.Model.get("disk-resources").loadMore(this.params).then(this.__update).always(this.__loadMore))
},__loadMore:function(){this.loading=!1,this.$listing.removeClass(this.LOADING_CLASS)},__update:function(){this.isVisible()&&(this._scrollTop=this.$listing.scrollTop(),this.invalidate(),this.update(this.params).then(this.restoreScroll,this))},restoreScroll:function(){this.isVisible()&&this.$listing&&this._scrollTop&&(this.$listing.scrollTop(this._scrollTop),delete this._scrollTop)}}}),ns.View.define("quick-reply-done",{events:{"ns-view-show":"onShow"},models:{"quick-reply-state":"keepValid"},params:function(e){return{qrIds:e.ids}
},yateModule:"compose2",methods:{onShow:function(){this.getModel("quick-reply-state").set(".showDone",!1)}}}),ns.View.define("quick-reply-done-success",{yateModule:"compose2"}),ns.View.define("quick-reply-form",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","daria:shortcuts:replyall@show":"focusQuickReply"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.needPlaceInViewport":"placeInViewport"},"message-draft":!1},params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2",methods:{onShow:function(){this.$node.find(".js-loader").removeClass("is-hidden"),this.getComposeParams().then(this.onLoadComposeParams,this.onLoadErrorComposeParams,this)
},onHide:function(){this.vCompose.destroy(),this.vCompose=null,this.getModel("quick-reply-state").setIfChanged(".formIsShown",!1),this.invalidate(),HTMLElement.xEditorRestoreNodeActions()},onLoadErrorComposeParams:function(){this.getModel("quick-reply-state").hideForm()},onLoadComposeParams:function(e){if(this.isVisible()){var t=this.node.appendChild(this.node.ownerDocument.createElement("div"));this.vCompose=ns.View.create("quick-reply",e),this.vCompose._setNode(t),this.vCompose.invalidate(),this.vCompose.updateByLayout("layout-quick-reply-form",e,{execFlag:ns.U.EXEC.PARALLEL}).done(this.onAfterRender,this)
}},onAfterRender:function(){this.isVisible()&&(this.$node.find(".js-loader").addClass("is-hidden"),this.node.appendChild(this.vCompose.node),this.getModel("quick-reply-state").setIfChanged(".formIsShown",!0),this.placeInViewport(),HTMLElement.xEditorOverrideNodeActions())},getComposeParams:function(){var e=this.getModel("quick-reply-state").isReplyAll(),t={ids:this.params.ids,qrIds:this.params.qrIds,oper:e?"reply-all":"reply",_cuid:_.uniqueId("compose")};return vow.Promise.resolve(t)},placeInViewport:function(){var e=Daria.is3pane(),t=ns.Model.get(e?"scroller-message":"scroller-messages");
t.init(),t.scrollIntoView(this.node,{alignToTop:!1,relative:t.isRelativeOffset(),viewBottomOffset:e?0:-ns.Model.get("timeline-state").get(".height")}),ns.events.trigger("daria:vApp:changeRightColumSize")},focusQuickReply:function(){this.isVisible()&&this.vCompose&&(this.vCompose.getModel("compose-state").setFocusField("send"),this.placeInViewport())}}}),ns.View.define("quick-reply-placeholder",{events:{"click@show":"openQuickReply","click .js-quick-reply-placeholder-single-reply":"onSingleReplyClick","click .js-quick-reply-placeholder-forward":"onForwardClick","click .js-quick-reply-placeholder-reply-all":"onReplyAllClick","daria:shortcuts:replyall@show":"openQuickReply"},models:{"message-body":!1,"quick-reply-state":!1},params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2",methods:{openQuickReply:function(){var e=this.getModel("message-body").allowedReplyAll(),t=this.getModel("quick-reply-state");
t.setReplyAllState(e),t.showForm(),this._countMetrika(e?'Клик на "Ответить всем"':'Клик на "Ответить"')},onSingleReplyClick:function(e){var t=this.getModel("quick-reply-state");t.setReplyAllState(!1),t.showForm(),e.stopPropagation(),this._countMetrika('Клик на "Ответить"')},onReplyAllClick:function(e){this.openQuickReply(),e.stopPropagation()},onForwardClick:function(e){var t=ns.Model.get("messages-checked",{mid:this.params.ids});ns.action.run("forward",{mMessagesChecked:t}),e.stopPropagation(),this._countMetrika('Клик на "Переслать"')
},_countMetrika:function(e){Daria.isMessagePage()&&Jane.c("Quiсk Reply","Письмо на отдельной странице",e)}}}),ns.View.define("quick-reply-form-wrap",{params:ns.View.infoLite("message-quick-reply").params,yateModule:"compose2"}),ns.View.define("compose-message-show-hidden-parts",{events:{"click@show":"onClick"},params:ns.View.info("compose2").params,models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.collapsedMessage":"onChangeCollapsed"}},yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-message").expandMessage()
},onChangeCollapsed:function(){this.$node.toggleClass("is-hidden",!this.isCollapsed()),this.getModel("compose-state").trigger("editor-update")},isCollapsed:function(){return this.getModel("compose-message").isMessageCollapsed()}}}),ns.View.define("compose-quick-reply-delete",{events:{"click@show":"onClick"},models:{"quick-reply-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){var e=this.getModel("compose-message"),t=this.getModel("quick-reply-state"),o=e.getDraftMid();
t.trigger("ns-model:delete-draft",o)},onDraftSaved:function(){this.$node.toggleClass("is-hidden",!this.toShow())},toShow:function(){return this.getModel("compose-message").isDraft()}}}),function(){var e="compose2",t=ns.View.infoLite(e);ns.View.edefine("compose-sidebar",{models:{"quick-reply-state":!1,"compose-sidebar-state":!1,"compose-sidebar-fsm":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"onLidsChange","ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"showForgottenAttachmentsDialog"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sending":"onSending","# cancel":"onCancel","# sent":"onSent","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:t.params,ctor:function(){t.ctor.apply(this,arguments)
},yateModule:"compose2",methods:{onDraftSaved:_.noop,scrollToComposeTop:_.noop,_leaveCompose:function(e){e&&ns.page.block.clear();var t=this.getModel("compose-sidebar-fsm");if(!this._pageGoUrl)return t.setState("cancel");if("#done"===this._pageGoUrl)return t.setState("done");var o=this._pageGoUrl;return t.setState("cancel").then(function(){return ns.page.go(o)})}}},e)}(),function(){var e={split:{byModel:"compose-field-notices",intoViews:function(e){var t=e.get(".type"),o=e.params.field;switch(t){case"error":return"compose-field-"+o+"-error";
case"nda":return"compose-field-"+o+"-notice-nda";case"help":return"compose-field-"+o+"-notice-help";case"replyall":return"compose-field-"+o+"-notice-replyall"}return null}}},t=["phone","to","cc","bcc","att_ids"];t.forEach(function(t){var o="compose-field-notices-"+t;ns.ViewCollection.define(o,{models:{"compose-field-notices":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:t})},split:_.clone(e.split),yateModule:"compose2"})})}(),ns.ViewCollection.define("compose-field-extras-to",{models:{"compose-field-extras-collection":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})
},split:{byModel:"compose-field-extras-collection",intoViews:function(e){var t=e.get(".type");switch(t){case"extras-phone":return"compose-field-to-extras-phone";case"extras-cc":return"compose-field-to-extras-cc";case"extras-bcc":return"compose-field-to-extras-bcc";case"extras-go-to-compose":return"compose-field-to-extras-go-to-compose";case"extras-qr-close":return"compose-field-to-extras-qr-close"}return null}},yateModule:"compose2"}),ns.View.define("compose-recipients-diff",{events:{"click@show .js-compose-recipients-diff-close":"onSelectorClick"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.recipients-diff":"selfUpdate"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.recipients-diff-pane-close":"selfUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{selfUpdate:function(){this.invalidate(),this.update()
},onSelectorClick:function(){this.getModel("compose-state").set(".recipients-diff-pane-close",!0)},hasRecipients:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added.length||t.removed.length},getRecipientsEmails:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added=t.added.map(this.recipientsMapIterator),t.removed=t.removed.map(this.recipientsMapIterator),t},recipientsMapIterator:function(e){var t=e.indexOf("@");return-1===t&&(t=e.length-1),e.substring(0,t+1)
}}}),ns.View.define("done-promo-attachments",{events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"invalidate","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave"},checkShowPromo:function(){var e=Jane.watcher.get("compose.was-sent-with-attachments"),t=Jane.watcher.get("compose.attachments-reminder-showed");if(e&&t){var o=Number(ns.Model.get("settings").getSetting("promo_atts_show_date")||0);if(!o||Daria.now()-o>Jane.Date.MONTH)return"done-promo-attachments"}},yateModule:"compose2",methods:{_onNsViewShow:function(){Jane.c("Поделяшки на Done","Забытый файл","Показ"),ns.Model.get("settings").setSettings({promo_atts_show_date:Daria.now()}),Daria.Done.initYaShare({$container:this.$node.find(".js-share-buttons"),title:"Яндекс.Почта напоминает о забытых файлах",description:"Написали «прикрепляю файл» и забыли прикрепить? Яндекс.Почта напомнит об этом.",twitter:"Яндекс.Почта напоминает о файлах, которые вы забыли приложить к письму",url:Daria.Config["mail-url"],partialUrl:"/share/attach-reminder",metrikaCategory:"Забытый файл"})
},_onMouseenter:function(){Daria.Done.Redirect.stop()},_onMouseleave:function(){Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-ca",{events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"_onNsViewHide","daria:done-redirect-timeout@show":"_onDoneRedirectTimeout","click@show .js-done-promo-ca":"_onInteract","dblclick@show .js-done-promo-ca":"_onInteract"},checkShowPromo:function(e){if(e.noDigitPromo)return!1;if(Daria.IS_CORP||Jane.Config.pddDomain)return!1;if(ns.Model.get("settings").isSet("digitsreg"))return!1;
if(Daria.PromoBar.getSetting("shown-on-done"))return!1;var t=Daria.PromoBar.getSetting("closeDate");return!t||Daria.now()-t>60*Jane.Date.DAY?"done-promo-ca":void 0},yateModule:"compose2",methods:{_redirectTimeout:30,_onNsViewShow:function(){var e=this;Daria.loadPromoModule(function(){Daria.PromoBar.isAliasNotExist().done(function(){Daria.PromoBar.saveSettings({"shown-on-done":!0}),e._initPromo()}).fail(function(){Daria.Done.PromoManager.next({noDigitPromo:!0})})})},_onNsViewHide:function(){this._digitPromo&&this._digitPromo.metrika("Уход со страницы(переход)"),this.invalidate()
},_initPromo:function(){Daria.Done.Redirect.restart(1e3*this._redirectTimeout),this._digitPromo=new Daria.PromoBar,Jane.Promo.findPromo("alias-promo").promoBar=this._digitPromo,this._digitPromo.onRenderStart(this._digitPromoRenderStart.bind(this)),this._digitPromo.init("done",this.$node.find(".js-done-promo-ca"))},_digitPromoRenderStart:function(){ns.events.trigger("daria:vDone:repaintRedirectInfo","В&#160;течение "+this._redirectTimeout+"&#160;секунд страница обновится автоматически, и&#160;вы попадете в&#160;эту папку.")
},_onInteract:function(){Daria.Done.Redirect.stop()},_onDoneRedirectTimeout:function(){this._digitPromo&&this._digitPromo.metrika("Уход со страницы(сработал редирект)")}}}),ns.View.define("done-promo-facebook",{events:{"ns-view-htmlinit":"_onViewHtmlinit","ns-view-hide":"invalidate","click@show .js-done-box-fb-no-more":"_doNotShowFBPromo","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave"},checkShowPromo:function(e){if(e.dontFacebook)return!1;if(Daria.IS_CORP)return!1;if(Modernizr.msie)return!1;
if("RUS"!==Daria.Config.product)return!1;var t=ns.Model.get("settings"),o=Number(t.getSetting("promo-fb_show-date")),s=Number(t.getSetting("promo-fb_hold-period")),i=Number(t.getSetting("promo-fb_dont-show")),n=!1;if(n=o?Daria.now()-o>s:!0,!n&&i)return!1;var a=Jane.FormValidation.splitContacts(e.tostr||"");return 1!==a.length?!1:(Daria.Done.PromoManager.setParams({contactEamil:a[0].email}),"done-promo-facebook")},yateModule:"compose2",methods:{_onViewHtmlinit:function(){var e=Daria.Done.PromoManager.getParams(),t=e.contactEamil,o=$.Deferred();
o.done(function(e){this._initPromo(e)}.bind(this)),o.fail(function(){Daria.Done.PromoManager.next({dontFacebook:!0})}),ns.forcedRequest(["facebook-badge","abook-contact"],{email:t}).then(function(e){var s=e[0],i=s.get(".link");if(!i)return void o.reject();var n=ns.Model.get("social-profiles").getCacheByEmail(t),a=n&&jpath(n,'.profile[.type == "facebook.com"]')[0];if(!a||!a.url)return void o.reject();var r={email:t,link:i,avatar:a.url,profile:a.link};if(a.name){var c=a.name.split(" ");r.name=a.name,r.fname=c.shift(),r.lname=c.join(" ")
}var l=e[1],d=l.get(".contact")[0];if(d&&d.cid){var u=d.name||{},h=d.birthdate||{};r.cid=d.cid,r.abook={first:u.first||"",middle:u.middle||"",last:u.last||"",full:u.full||"",phone:d.phone&&d.phone[0].value||"",descr:d.description||"",email:$.map(d.email,function(e){return e.value})},h.day&&(r.abook.day=h.day),h.month&&(r.abook.month=h.month),h.year&&(r.abook.year=h.year)}ns.Model.get("settings").setSettings({"promo-fb_show-date":Daria.now(),"promo-fb_hold-period":6048e5}),o.resolve(r)})},_initPromo:function(e){Jane.c("Done","Facebook","Показ"),this.$node.find(".js-done-promo-facebook").html(Jane.tt("done:js-done-promo-facebook",e))
},_doNotShowFBPromo:function(){var e=ns.Model.get("settings");e.setSettings({"promo-fb_dont-show":!0}),Jane.c("Done","Facebook","не предлагать"),ns.page.home()},_onMouseenter:function(){Daria.Done.Redirect.stop()},_onMouseleave:function(){Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-groups",{events:{"ns-view-htmlinit":"onViewHtmlInit","ns-view-hide":"invalidate","click@show .js-group-promo-button":"createGroup"},checkShowPromo:function(e){return e.groupsPromo?void 0:"done-promo-groups"
},yateModule:"compose2",methods:{onViewHtmlInit:function(){this.initParams().fail(function(){Daria.Done.PromoManager.next({groupsPromo:!0})}).done(function(e){this._initPromo(e)}.bind(this))},_initPromo:function(e){this.$node.find(".js-done-promo-groups").html(Jane.tt("done:js-done-promo-groups",e)),this.cb()},json:{type:"groups",users:[]},variantWithContacts:function(){return Daria.uidEnds([5,6,7,8,9])},getJSONParams:function(){return this.json},getComposeEmails:function(){var e=Daria.Done.PromoManager.getParams(),t=String(e.tostr||"").split(", "),o=[];
return $.each(t,function(e,t){t&&o.push(t.replace(/^[\s\S]*</i,"").replace(/>[\s\S]*$/i,""))}),o},getMiniContactsForPromo:function(){function e(e){this.json.users=this.json.users.concat(e),this.modifyUsersList(),t.resolve()}var t=$.Deferred(),o=this.getComposeEmails();if(o.length<2)return t.reject(),t.promise();var s=[];return this.json.users=[],this.json.emailsWithoutContact=[],ns.forcedRequest(["abook-contacts"],{emails:o.join(",")}).then(function(t){var i=t[0];_.each(o,function(e){var t=i.getContactDataByEmail(e);
t?(t.name.full||(t.name.full=t.email[0].value.split("@")[0]),s.push(t)):(this.json.emailsWithoutContact.push(e),s.push({email:[{value:e}],name:{full:e.split("@")[0]}}))}.bind(this)),e.call(this,s)}.bind(this)),t.promise()},addContact:function(e){return ns.forcedRequest(["do-abook-person-add"],{mail_addr:e})},modifyUsersList:function(){var e=[];$.each(this.json.users,function(t,o){o&&e.push(o.email[0].value)}),this.json.email=e,this.json.params="emails="+e.join(",");var t=this.json.users.length;t>3&&(this.json.more=this.json.users.splice(3,t-3))
},initParams:function(){function e(){var e=this.json;return!e.users||e.users&&e.users.length<2||!e.email?void o.reject():void ns.forcedRequest(["abook-band-info"],{email:e.email}).then(function(t){jpath(t[0].getData(),".band.counter")[0]>1?o.resolve(e):o.reject()})}function t(){o.reject()}this.variantWithContacts()&&(this.json.withcontacts=1);var o=$.Deferred(),s=this.getMiniContactsForPromo();return s.fail(t).done(e.bind(this)),o.promise()},cb:function(){ns.Model.get("settings").setSettings({"promo-done-groups":Daria.now()}),this.variantWithContacts()?($(".b-message-head_full").addClass("g-hidden"),this.$node.find(".js-group-promo-people-more-link").on("click",function(){Daria.Done.Redirect.stop()
}),Jane.c(["Промо-групп","Аватары","показы промо"])):Jane.c(["Промо-групп","Адресаты","показы промо"]),this.$node.find(".group-promo-button").on("mouseover",function(){Daria.Done.Redirect.stop()})},createGroup:function(){var e=this,t=$(".js-group-promo-preloader",this.$node),o=$(".js-group-promo-error",this.$node);t.removeClass("g-hidden"),o.addClass("g-hidden");var s=nb.$block(".js-group-promo-button");s&&s.disable();var i=this.variantWithContacts()?"Аватары":"Адресаты";Jane.c(["Промо-групп",i,"переход в АК"]);
var n=Vow.fulfill();this.json.emailsWithoutContact.length&&_.each(this.json.emailsWithoutContact,function(t){n=n.then(function(){return e.addContact(t)})}),n.then(function(){ns.forcedRequest(["abook-contacts"],{emails:e.json.email.join(",")}).then(function(e){ns.page.go("#contacts").then(function(){ns.Model.get("abook-selected",{type:"normal"}).insert(e[0].models),ns.events.trigger("daria:vAbook.showGroupPopup",{type:"new-group"}),Jane.c(["Промо-групп",i,"показ попапа_1"]),ns.events.on("abook-add-new-group",function(){var e=ns.page.current.params.tid,t=ns.Model.get("abook-groups").getGroupByTid(e),o=t.title;
Jane.c(["Промо-групп",i,'клик на "создать"']),Jane.c(["Промо-групп",i,"показ попапа_2"]),Daria.Dialog.open({width:630,body:Jane.tt("done:promo-group-done-success",{group:o}),additionalClass:"group-promo-success-dialog"})})})})})}}}),ns.View.define("done-promo-hotkeys",{events:{"ns-view-hide":"_hideDonePromo","ns-view-show":"_showDonePromo","click@show .js-show-hotkeys-list":"_onClickShowHotkeysList","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave"},checkShowPromo:function(){return Daria.ShortcutsPromo&&Daria.ShortcutsPromo.doWeNeedToShowPromo("done")?"done-promo-hotkeys":!1
},yateModule:"compose2",methods:{_showDonePromo:function(){Daria.ShortcutsPromo.showDonePromo()},_hideDonePromo:function(){this.invalidate(),Daria.ShortcutsPromo.hideDonePromo()},_onClickShowHotkeysList:function(){ns.action.run("show-hotkeys-list",{type:"done"})},_onMouseenter:function(){Daria.Done.Redirect.stop()},_onMouseleave:function(){Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-invite",{models:{settings:!1},events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"invalidate","click@show .js-show-invite-popup":"_onClickShowInvitePopup","click@show .js-invite-contact-hide":"_onClickInviteContactHide","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave","daria:done-promo-invite:edit@show":function(e,t){this.metrika("Клик по "+(t?'"Отменить изменения"':'"Редактировать"'))
},"daria:done-promo-invite:add@show":function(){this.metrika('Клик по "Добавить адресатов"')},"daria:done-promo-invite:send@show":function(){this.metrika("клик на отправить")}},checkShowPromo:function(e){if(Daria.IS_CORP)return!1;if(e.ccstr)return!1;var t=Jane.FormValidation.splitContacts(e.tostr||"");if(1!==t.length)return!1;var o=Daria.Done.PromoManager.checkPromoInvite(e);return o?o:void 0},yateModule:"compose2",methods:{metrika:function(){var e=Array.prototype.slice.call(arguments);ns.page.current.params.phonestr?e.unshift("промо SMS",'"Пригласи друга" на done'):e.unshift(Daria.Dialog.params&&Daria.Dialog.params.inviteMetrika?Daria.Dialog.params.inviteMetrika:'"Пригласи друга" на done'),Jane.c.apply(Jane,e)
},_onNsViewShow:function(){var e=Daria.Done.PromoManager.getParams(),t=e.inviteEmail;return t?Daria.Done.Invite.isContactHidden(t)?void Daria.Done.PromoManager.next({dontInvite:!0}):void ns.forcedRequest(["is-yandex-user","abook-invite"],{email:t}).done(function(e){var o=e[0],s=e[1];if("yes"===o.get(".y"))return void Daria.Done.PromoManager.next({dontInvite:!0});var i=s.get(".contact")[0];return i&&i.cid&&-1===i.tag.join().indexOf("-42")?void this._initPromo({cid:i.cid,name:i.name.full||t,ref:no.jpath('.email[.value == "'+t+'"].ref',i)[0],email:t}):void Daria.Done.PromoManager.next({dontInvite:!0})
},function(){Daria.Done.PromoManager.next({dontInvite:!0})},this):void Daria.Done.PromoManager.next({dontInvite:!0})},_initPromo:function(e){e.inviteType="note",e.inviteMetrika='"Пригласи" на дан',e.origin="invite1";var t=this.getModel("settings"),o=t.hasSetting("show-promo-invite");o?e.inviteLinkShow=!0:t.setSettingOn("show-promo-invite"),this.$node.find(".js-done-promo-invite").html(Jane.tt("done:js-done-promo-invite",e))},_onClickInviteContactHide:function(e){var t=$(e.currentTarget).data("email");
Daria.Done.Invite.rememberContactHiddenTime(t),this.metrika("клик на скрыть"),Daria.Done.Redirect.restart()},_onClickShowInvitePopup:function(e){var t,o={},s=$(e.currentTarget),i=s.data("metrika"),n=s.data("cid"),a=s.data("origin"),r=s.data("email");r||(r=ns.page.current.params.tostr),r&&(o=Jane.FormValidation.contact2obj(r),t=o.email.split("@")[1]),o.domain=t,o.mail=r,o.inviteMetrika=i,o.origin=a,o.cid=n,Daria.Done.Invite.openPopup(o).then(function(){this._lockMouseAction=!0,this.metrika("клик на пригласить")
},function(e){this._lockMouseAction=!1,"cancel"===e&&this.metrika("клик на крестик в попапе редактирования")},this)},_onMouseenter:function(){this._lockMouseAction||Daria.Done.Redirect.stop()},_onMouseleave:function(){this._lockMouseAction||Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-invites",{models:{settings:!1},events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"invalidate","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave","click@show .js-invites-contact-hide":"_onClickInviteContactHide","click@show .js-invites-show-more":"_onClickInvitesShowMore","click@show .js-show-invite-popup":"_onClickShowInvitePopup","daria:done-promo-invite:edit@show":function(e,t){this.metrika("Клик по "+(t?'"Отменить изменения"':'"Редактировать"'))
},"daria:done-promo-invite:add@show":function(){this.metrika('Клик по "Добавить адресатов"')},"daria:done-promo-invite:send@show":function(){this.metrika("клик на отправить")}},checkShowPromo:function(e){return Daria.IS_CORP?!1:e.dontInvites?!1:e.invite?!1:"done-promo-invites"},yateModule:"compose2",methods:{metrika:function(){var e=Array.prototype.slice.call(arguments);ns.page.current.params.phonestr?e.unshift("промо SMS",'"Инвайты" на дан'):e.unshift(Daria.Dialog.params&&Daria.Dialog.params.inviteMetrika?Daria.Dialog.params.inviteMetrika:'"Инвайты" на дан'),Jane.c.apply(Jane,e)
},_onNsViewShow:function(){var e=this.getModel("settings").getSetting("promo-done-invites");return e&&Daria.now()-e<Jane.Date.WEEK?void Daria.Done.PromoManager.next({dontInvites:!0}):void ns.forcedRequest("abook-invites",{limit:4}).done(function(e){var t=e[0],o=t.getFilteredContacts();return o.length?(4===o.length&&t.saveInReserve(o[o.length-1]),t.saveContactsViewed(o),void this._initPromo({showMore:4===o.length,contacts:o})):void Daria.Done.PromoManager.next({dontInvites:!0})},function(){Daria.Done.PromoManager.next({dontInvites:!0})
},this)},_initPromo:function(e){e.inviteType="note",e.inviteMetrika='"Инвайты" на дан',e.inviteLinkShow=!0,e.origin="invite2",this.getModel("settings").setSettings({"promo-done-invites":Daria.now()}),this.metrika("показ промо"),this.$node.find(".js-done-promo-invites").html(Jane.tt("done:js-done-promo-invites",e))},_onClickInvitesShowMore:function(){ns.forcedRequest("abook-invites",{limit:4}).done(function(e){var t=e[0],o=t.getFilteredContacts();return o.length?(4===o.length&&t.saveInReserve(o[o.length-1]),t.saveContactsViewed(o),void this._initPromo({showMore:4===o.length,contacts:o})):void this._onClickInvitesShowMoreError()
},this._onClickInvitesShowMoreError,this)},_onClickInvitesShowMoreError:function(){var e=ns.Model.get("abook-invites",{limit:4});this._initPromo({showMore:!1,contacts:e.getReserve()})},_onClickInviteContactHide:function(e){var t=$(e.currentTarget),o=t.data("email");Daria.Done.Invite.rememberContactHiddenTime(o),this.metrika("клик на скрыть"),t.closest(".js-invites-contact").remove(),this.$node.find(".js-invites-contact").length||(this.$node.find(".js-invites-show-more").hide(),Daria.Done.Redirect.restart())
},_onClickShowInvitePopup:function(e){var t,o={},s=$(e.currentTarget),i=s.data("metrika"),n=s.data("cid"),a=s.data("origin"),r=s.data("email");r||(r=ns.page.current.params.tostr),r&&(o=Jane.FormValidation.contact2obj(r),t=o.email.split("@")[1]),o.domain=t,o.mail=r,o.inviteMetrika=i,o.origin=a,o.cid=n,Daria.Done.Invite.openPopup(o).then(function(){this._lockMouseAction=!0,this.metrika("клик на пригласить")},function(e){this._lockMouseAction=!1,"cancel"===e&&this.metrika("клик на крестик в попапе редактирования")
},this)},_onMouseenter:function(){this._lockMouseAction||Daria.Done.Redirect.stop()},_onMouseleave:function(){this._lockMouseAction||Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-phone",{events:{"ns-view-htmlinit":"_onViewHtmlinit","ns-view-hide":"invalidate","mouseenter@show":"_onMouseenter","click@show .js-phone-confirm":"_onClickPhoneConfirm","click@show .js-revalidate":"_onClickRevalidate","keydown@show .js-input-code":"_onKeydownInputCode","phone-registered-failure@show":"_onPhoneRegisteredFailure","phone-confirmed-failure@show":"_onPhoneRegisteredFailure","phone-confirmed-success@show":"_onPhoneConfirmedSuccess"},checkShowPromo:function(e){return e.noPhone||Daria.IS_CORP||Jane.Config.pddDomain?!1:"done-promo-phone"
},yateModule:"compose2",methods:{_onViewHtmlinit:function(){ns.forcedRequest(["userphones","settings"]).then(function(e){var t=e[0],o=e[1],s=t.getUnconfirmedNumber();s&&o.isSet("phone-reg")?(o.setSettingOff("phone-reg"),this._initPromo({number:s})):Daria.Done.PromoManager.next({noPhone:!0})}.bind(this))},_initPromo:function(e){this.$node.find(".js-done-promo-phone").html(Jane.tt("done:js-done-promo-phone",e)),Jane.c("промо SMS",'"Введите код из SMS" на Done',"Показ")},_onClickPhoneConfirm:function(){Jane.c("промо SMS",'"Введите код из SMS" на Done','Клик по "Подтвердить"')
},_onClickRevalidate:function(){Jane.c("промо SMS",'"Введите код из SMS" на Done','Клик на "Отправить код ещё раз"')},_onKeydownInputCode:function(e){13===e.keyCode&&ns.action.run("phone.confirm",{$node:this.$node,force:!0})},_onPhoneRegisteredFailure:function(e,t,o){this.$node.find(".js-error").html(ns.Model.get("phone-confirm").parseError(t,o)),Jane.c("промо SMS",'"Введите код из SMS" на Done',"Показ ошибки")},_onPhoneConfirmedSuccess:function(){this.$node.find(".b-done__box_phone").addClass("b-done__box_phone_done"),Jane.c("промо SMS",'"Введите код из SMS" на Done',"Номер подтвержден"),Daria.Done.Redirect.restart()
},_onMouseenter:function(){Daria.Done.Redirect.stop()}}}),ns.View.define("done-promo-signature",{events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"invalidate"},checkShowPromo:function(e){return e.signaturePromo?"done-promo-signature":void 0},yateModule:"compose2",methods:{_onNsViewShow:function(){Jane.c("Done","Signature","Показ")}}}),ns.View.define("done-promo-sms",{events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"invalidate","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave"},checkShowPromo:function(e){if(Daria.IS_CORP)return!1;
if(!e.phonestr)return!1;if(e.ccstr)return!1;var t=Jane.FormValidation.splitContacts(e.tostr||"");if(1!==t.length)return!1;if(Math.random()>.5){var o=Daria.Done.PromoManager.checkPromoInvite(e);if(o)return o}return"done-promo-sms"},yateModule:"compose2",methods:{_onNsViewShow:function(){Jane.c("промо SMS","Копия письма отправлена в SMS"),Jane.c("Поделяшки на Done","Письма в смс","Показы"),Daria.Done.initYaShare({title:"Яндекс.Почта умеет отправлять письма в смс",description:"Собеседник сможет ответить на письмо откуда угодно, даже не открывая свой почтовый ящик.",url:Daria.Config["mail-url"],partialUrl:"/share/sms",$container:this.$node.find(".js-share-buttons"),metrikaCategory:"Письма в смс"})
},_onMouseenter:function(){Daria.Done.Redirect.stop()},_onMouseleave:function(){Daria.Done.Redirect.restart()}}}),ns.View.define("done-promo-templates",{events:{"click@show .js-make-template-from-done":"_onClickMakeTemplateFromDone","ns-view-hide":"invalidate"},checkShowPromo:function(e){if("template"===e.save_symbol)return!1;if("ru"!==Daria.Config.locale)return!1;if(Daria.IS_KCUF)return!1;if(!e.subj)return!1;var t=ns.Model.get("letter-templates"),o=new RegExp("("+t.get(".done-keys").join(")|(")+")","i"),s=e.subj.match(o);
if(!s)return!1;s.shift();var i,n=t.get(".done-texts");return $.each(s,function(e,t){return t?(i=n[e],Jane.c("Шаблоны","Промо шаблонов на done",i,"Показ"),!1):void 0}),Daria.Done.PromoManager.setParams({templateText:i}),"done-promo-templates"},yateModule:"compose2",methods:{getTemplateText:function(){var e=Daria.Done.PromoManager.getParams();return e.templateText},_onClickMakeTemplateFromDone:function(){Jane.c("Шаблоны","Промо шаблонов на done",this.getTemplateText(),"Клик");var e=Daria.Done.PromoManager.getParams();
ns.action.run("compose.go",{subject:e.subj,body:e.body,save_symbol:"template"})}}}),ns.View.define("done-promo-themes",{models:["settings-color-schemes"],events:{"ns-view-hide":"_onNsViewHide","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave","click@show .js-reset-color-scheme":"_onClickResetColorScheme"},checkShowPromo:function(){if(!Jane.Config.allowThemes)return!1;var e=Daria.getCookie("default_color_scheme");if(e=e||"")return"done-promo-themes";var t=ns.Model.get("settings"),o=t.getSetting("color_scheme");
if(!o)return"done-promo-themes";var s=t.getSetting("colorful-theme-skin");return"color"!==o&&"colorful"!==o||"blue"!==s?!1:"done-promo-themes"},yateModule:"compose2",methods:{checkDefaultScheme:function(){return Boolean(Daria.getCookie("default_color_scheme"))},_onNsViewHide:function(){this.checkDefaultScheme()&&(this.showPromoDialog(),Daria.delCookie("default_color_scheme")),this.invalidate()},_onMouseenter:function(){Daria.Done.Redirect.stop()},_onMouseleave:function(){Daria.Done.Redirect.restart()
},_onClickResetColorScheme:function(){var e=ns.Model.get("settings"),t=Daria.getCookie("default_color_scheme"),o=e.getSetting("color_scheme");t!=o&&(Daria.delCookie("default_color_scheme"),Daria.setCookie("show_themes_promo","yes",{duration:1}),Jane.c({"Done-Promo":"Вернуть всё как было"}),e.setSettings({color_scheme:t},function(){document.location.reload()}))},showPromoDialog:function(e){var t=$(".promo-themes");t.is(":visible")&&Daria.Dialog.open({body:'<span style="font-size : 110%">Вы можете изменить оформление Почты в любой момент</span>',onTarget:{target:t,pos:"right",side:"top"},width:250,additionalClass:e||"b-popup_yellow"})
}}}),function(){var e=".js-mail-layout-content",t="mail-PromoMobileApp",o="promo-mobile-app-mixin",s=ns.View.infoLite(o);ns.View.define("done-promo-mobile-app",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-promo-mobile-app-close-button":"closeView","mouseenter@show":"_onMouseenter","mouseleave@show":"_onMouseleave","daria:vApp:changeRightColumSize@show":"onResize","beforeunload@show window":"onHide"},params:function(){return{promo:"mobile-app-done"}
},checkShowPromo:function(){var e=s.methods.isMobileAppInstalled.apply(this),t=ns.Model.get("settings"),o=t.getSetting("inline-wizard-close"),i=t.getSetting("promo-mobile_sms-send_date")||0,n=t.getSetting("promo-mobile-done_show-date")||0,a=Number(t.getSetting("inline-wizard-mobile_show-date")||0)+30,r=Math.max(n,i,a),c=Daria.getAccountAgeInDays()>10,l=!r||Daria.now()-r>2*Jane.Date.WEEK,d=!c||!l;return d||!o||e||Daria.IS_CORP||Daria.is3pane()?!1:"done-promo-mobile-app"},yateModule:"compose2",methods:{PROMO_MOBILE_APP_NAME:"mail-promo-done-liza",PICTURE_PREFIX:"mail-Promo-MailAppLink2",SHOW_CLOSE_BUTTON:!1,CUSTOM_CLASSES:"mail-PromoMobileApp_done",METRIKA_DATA:{prefix:"Промо на Done",actions:{show:"Показы",enterPhone:"ввод телефона",sendClick:"клик на получить",sendSuccess:"сообщение отправлено",closeClick:"клик по закрыть"}},SIZE_INTERVALS:[{className:t+"_big",from:900,to:Number.MAX_VALUE},{className:t+"_medium",from:835,to:900},{className:t+"_small",from:775,to:835},{className:t+"_extra-small",from:0,to:775}],_isRedirectTimerActive:!0,onHtmlInit:function(){this.super_.onHtmlInit.apply(this);
var e=this;this.nbPhoneNumber.$control.on("focus",function(){Daria.Done.Redirect.stop(),e._isRedirectTimerActive=!1})},onShowAction:function(){this.$resizeNode=$(e),this.onResize()},onSendSuccess:function(){Daria.Done.Redirect.restart()},onErrorCanNotRetry:function(){Daria.Done.Redirect.restart()},onHide:function(){ns.Model.get("settings").setSettings({"promo-mobile-done_show-date":Daria.now()}),this._isRedirectTimerActive=!0},_onMouseenter:function(){this._isRedirectTimerActive&&Daria.Done.Redirect.stop()
},_onMouseleave:function(){this._isRedirectTimerActive&&Daria.Done.Redirect.restart()}}},"promo-mobile-app-common")}(),function(){var e=Daria.timify({seconds:15});ns.View.define("done-redirect",{events:{"daria:done-redirect-timeout":"redirect"},yateModule:"compose2",methods:{_timer:null,stopRedirectTimeout:function(){Daria.Done.Redirect.stop()},startRedirectTimeout:function(t){Daria.Done.Redirect.start(t||e)},redirect:function(){ns.page.home()}}})}(),function(){var e="js-direct-done";ns.View.edefine("done",{models:{settings:!1,done:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy","ns-page-before-load@show":"onPageBeforeLoad","daria:daria:vThemesSelector:new-schema@show":"showDirect"},yateModule:"compose2",methods:{onHtmlInit:function(){nb.init(this.node)
},onHtmlDestroy:function(){nb.destroy(this.node)},onShow:function(){this.metrika("Показ");var e=this.getModel("done");e.get(".limited")&&this.metrika("Cообщение о лимите вложений"),this._prevToolbarFixedMode=ns.Model.get("toolbar").getFixedSupport(),ns.Model.get("toolbar").setFixedSupport(!1),this.showDirect(),this.startRedirectTimeout()},onHide:function(){var e=nb.$block(".js-group-promo-init-block",this.node);e&&e.destroy(),ns.Model.get("toolbar").setFixedSupport(this._prevToolbarFixedMode)},onPageBeforeLoad:function(e,t){("done"!==t[0].page||t[0].page!==t[1].page)&&(this.invalidate(),this.getModel("done").destroy(),this.stopRedirectTimeout())
},metrika:function(){var e=["Done"];e=e.concat(Array.prototype.slice.call(arguments,0)),Jane.c.apply(Jane,e)},showDirect:function(){Daria.yabs&&(this.$node.find(".js-direct-block").attr("id",e),Daria.yabs.showDoneDirect(e))}}},"done-redirect",ns.View)}(),function(){var e="done";ns.View.define("compose-sidebar-done",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-close":"onClickClose","click@show .js-goto":"onClickGoto"},models:{"compose-sidebar-fsm":!1},"params+":{_yateModule:"done"},yateModule:"compose2",methods:{onShow:function(){this.metrika("Показ"),this.startRedirectTimeout(Daria.timify({seconds:5}))
},onHide:function(){this.stopRedirectTimeout(),this.invalidate()},onClickClose:function(){this.onHide(),this.getModel("compose-sidebar-fsm").setState("cancel")},onClickGoto:function(){this.onHide(),this.getModel("compose-sidebar-fsm").setState("cancel"),ns.page.go("#inbox")},metrika:function(){var e=["SidebarDone"];e=e.concat(Array.prototype.slice.call(arguments,0)),Jane.c.apply(Jane,e)},redirect:function(){this.getModel("compose-sidebar-fsm").setState("cancel")}}},e)}(),ns.View.define("compose-switchmode-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null
},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-switchmode-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},_onOpened:function(){this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))
},_onResolve:function(){this._promise.fulfill(),this._popup.close()},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject(),this.destroy()}}}),ns.View.define("compose-emoticons-select",{models:{"compose-emoticons":!1},events:{"click@show .js-click":"_onClick","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll"},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null
},yateModule:"compose2",methods:{open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-emoticons-select","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)
},_onOpened:function(e,t){t.$node.on("mousedown",function(e){e.preventDefault()}),this.trigger("opened")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.trigger("closed")},_onDestroyed:function(){this.destroy()},_onClick:function(e){e.preventDefault(),this.trigger("select",$(e.currentTarget).data("suid")),this._popup.close()},_onScroll:function(){var e=this._popup&&this._popup.node&&this._popup.node.widget;e&&e._position()}}}),ns.View.define("compose-maillink-dialog",{events:{"click@show .js-update":"_onClickUpdate","click@show .js-cancel":"_onClickCancel"},params:ns.View.info("compose2").params,ctor:function(){this._onKeyup=this._onKeyup.bind(this),this._popup=null,this._data={}
},yateModule:"compose2",methods:{REG_CHECK_EMAIL:/^(http(s?):\/\/|ftp:\/\/|mailto:)/,getData:function(e,t){return this._data[e]||t||""},open:function(e){this._data=_.isObject(e)?_.clone(e):{},this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},isEdit:function(){return Boolean(this.getData("href"))},getHrefView:function(){return this.getData("href")},getTextView:function(){var e=this.getData("text"),t=this.getData("href");return e===t?"":e},isDisableText:function(){return this.getData("isDisableText")
},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-maillink-dialog","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({autofocus:!0,autoclose:!1,animation:!1})},_onOpened:function(){this._nbInputText=nb.$block(".js-text",this.node),this._nbInputHref=nb.$block(".js-href",this.node),this.$node.on("keyup",this._onKeyup),this.trigger("opened"),this._nbInputHref.focus(),this.getData("href")||Daria.setSelection(this._nbInputHref.$control[0],this.getHrefView().length),this.isDisableText()&&this._nbInputText.disable()
},_onClosed:function(){this.$node.off("keyup",this._onKeyup),nb.destroy(this.node),this._popup&&(this._popup.destroy(),this._popup=null),this.trigger("closed"),this._data=null},_onDestroyed:function(){this.destroy()},_onClickCancel:function(){this._popup.close()},_onKeyup:function(e){13===e.keyCode&&this._onClickUpdate()},_onClickUpdate:function(){var e=this._nbInputHref.getValue().trim();if(!e)return void this._nbInputHref.showError({autoclose:!0});this.REG_CHECK_EMAIL.test(e)||(e="http://"+e);var t=this._nbInputText.getValue().trim()||e,o=this.getData("href"),s=this.getData("text");
this._popup.close(),(e!==o||t!==s)&&this.trigger("update",{text:t,href:e})}}}),ns.View.define("compose-unsaved-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-unsaved-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})
},isOpen:function(){return this._popup?this._popup.isOpen():!1},_onOpened:function(){this._popup.$node.on("keydown click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("keydown click",".js-reject",this._onClosed.bind(this))},_onResolve:function(e){if(!(e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER)){var t=$(e.currentTarget).data("action");this._promise.fulfill(t),this._popup.close()}},_onClosed:function(e){e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER||this._popup&&(this._popup.destroy(),this._popup=null)
},_onDestroyed:function(){this._promise.reject(),this.destroy()}}}),ns.View.define("thread-quick-reply-placeholder",{events:{"click@show":"openQuickReply","daria:vMessageThreadReplyAll:replyAll@show":"openQuickReply"},models:{"quick-reply-state":!1},params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2",methods:{openQuickReply:function(){var e=this.getModel("quick-reply-state");e.showForm()}}}),ns.View.define("thread-quick-reply-form-wrap",{params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2"}),ns.View.define("thread-quick-reply-form",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.needPlaceInViewport":"placeInViewport"}},params:ns.View.infoLite("thread-quick-reply").params,yateModule:"compose2",methods:{onShow:function(){this.$node.find(".js-loader").removeClass("is-hidden"),this.getComposeParams().then(this.onLoadComposeParams,this.onLoadErrorComposeParams,this)
},onHide:function(){var e=ns.Model.get("messages",this.params);e.off("ns-model-remove",this.onMessageReplyRemoveBind),this.vCompose.destroy(),this.vCompose=null,this.getModel("quick-reply-state").setIfChanged(".formIsShown",!1),this.invalidate(),HTMLElement.xEditorRestoreNodeActions()},onLoadErrorComposeParams:function(){var e=this.getModel("quick-reply-state");e.hideForm()},onLoadComposeParams:function(e){if(this.isVisible()){var t=this.node.appendChild(this.node.ownerDocument.createElement("div"));
this.vCompose=ns.View.create("quick-reply-plain",e),this.vCompose._setNode(t),this.vCompose.invalidate(),this.vCompose.updateByLayout("layout-thread-quick-reply-form",e,{execFlag:ns.U.EXEC.PARALLEL}).done(this.onAfterRender,this)}},onMessageReplyRemove:function(e,t,o){var s=_.some(o,function(t){return t.params.ids===e});s&&this.onLoadErrorComposeParams()},onAfterRender:function(){this.isVisible()&&(this.$node.find(".js-loader").addClass("is-hidden"),this.node.appendChild(this.vCompose.node),this.getModel("quick-reply-state").setIfChanged(".formIsShown",!0),this.placeInViewport(),HTMLElement.xEditorOverrideNodeActions())
},getComposeParams:function(){var e=ns.Model.get("messages",this.params),t=e.getLastReplyMessageQR();if(!t)return vow.reject();var o=this.getModel("quick-reply-state").isReplyAll(),s=t.get(".mid"),i={ids:s,qrIds:this.params.qrIds,oper:o?"reply-all":"reply",_cuid:_.uniqueId("compose")};return this.onMessageReplyRemoveBind=this.onMessageReplyRemove.bind(this,s),e.on("ns-model-remove",this.onMessageReplyRemoveBind),new vow.Promise(function(e){e(i)})},placeInViewport:function(){var e=this.$node.closest(".js-thread-quick-reply")[0],t=Daria.is3pane(),o=ns.Model.get(t?"scroller-message":"scroller-messages");
o.init(),o.scrollIntoView(e,{alignToTop:!1,relative:o.isRelativeOffset(),viewBottomOffset:t?0:-ns.Model.get("timeline-state").get(".height")}),ns.events.trigger("daria:vApp:changeRightColumSize")}}}),function(){var e="compose2",t=ns.View.infoLite(e);ns.View.edefine("quick-reply-plain",{events:{"xiva.mail.insert@show":"onXivaMailInsert","daria:vMessageThreadReplyAll:replyAll@show":"focusSendField"},models:{"quick-reply-state":{"ns-model-changed":!1,"ns-model-changed.show":"onQuickReplyStateShow","ns-model:delete-draft":"onDeleteDraft"},"compose-sidebar-state":!1,"compose-sidebar-fsm":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":function(){this.getModel("compose-fsm").once("# edit",function(){this.setState("sending",{force:!0})
})}},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# edit":"onEdit","# sent":"onSent","# sending":"onSending","# cancel":"onCancel","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1},params:t.params,ctor:function(){this._xivaInsertMessages={},t.ctor.apply(this,arguments)},yateModule:"compose2",methods:{_parentApply:function(e,o){t.methods[e]&&t.methods[e].apply(this,o)
},onShow:function(){this._parentApply("onShow",arguments),this.focusSendField(),Jane.c("Треды","Quiсk Reply",Daria.is2pane()?"2pane":"3pane","Показ")},onEdit:function(){var e=ns.Model.get("message-draft",{ids:this.params.qrIds});if(e.isValid()){var t=this.getModel("compose-message").getDraftMid();e.setIfChanged(".mid",t)}},onSent:function(){this._parentApply("onSent",arguments);var e=ns.Model.get("message-draft",{ids:this.params.qrIds});e.isValid()&&e.setIfChanged(".mid",void 0),Jane.c("Треды","Quiсk Reply",Daria.is2pane()?"2pane":"3pane",'Клик на "Ответить"')
},onQuickReplyStateShow:function(){this.getModel("quick-reply-state").toShowForm()||(this.shouldСlearModel=!0)},onDeleteDraft:function(){this.isVisible()&&(this.shouldСlearModel=!0)},onDraftSaved:_.noop,scrollToComposeTop:_.noop,onXivaMailInsert:function(e,t){if(Daria.utils.checkReplaceFakeMessage(t)){var o=no.jpath(".message.hdr_message_id",t),s=no.jpath(".message.mid",t);this._xivaInsertMessages[o]=s}},_getContainer:function(e){return $('[data-key*="ids='+e+'"]')[0]},_openSentMessage:function(e){ns.Model.get("state-message-thread-item",{ids:e}).setOpen(!0)
},_onMessageRenderSuccess:function(e,t,o){var s=this._xivaInsertMessages[t],i=this._getContainer(o);!s&&i.length?(e.node._nsView=e,i.append(e.node),this.scrollToSentMessage(e.params.ids)):(e.destroy(),s&&(this._openSentMessage(s),this.scrollToSentMessage(s))),this._xivaInsertMessages={}},_onAfterSent:function(){Daria.Statusline.hide("message-sending"),ns.events.trigger("message.sent");var e=this.getModel("quick-reply-state"),t=ns.Model.get("settings").isThreaded();return(!t||Daria.is3pane()&&ns.page.current.params.ids||"message"===ns.page.current.page||ns.page.current.params.search)&&this.showSentInList(),e.hideForm(),vow.Promise.resolve()
},showSentInList:function(){var e=this.getModel("compose-message"),t=e.get(".sentMessageId"),o=this._xivaInsertMessages[t],s=e.mMessage.getThreadId();if(t&&!o){var i=this._getContainer(s);if(i.length){var n={ids:_.uniqueId("666")};ns.Model.get("message",n).fromComposeMessage(e,this.params.qrIds),ns.Model.get("message-body",n).fromComposeMessage(e,this.params.qrIds);var a=ns.View.create("quick-reply-message",n);a.updateByLayout("layout-quick-reply-message",n,{execFlag:ns.U.EXEC.PARALLEL}).done(this._onMessageRenderSuccess.bind(this,a,t,s))
}}else o&&(this._openSentMessage(o),this.scrollToSentMessage(o))},scrollToSentMessage:function(e){ns.Model.get("state-message-thread-item",{ids:e}).set(".shouldBeInViewport",!0)},focusSendField:function(){this.getModel("compose-state").setFocusField("send")}}},e)}(),function(){var e="compose-field-base",t=ns.View.infoLite(e),o=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorSwitchedMode","_applyTmpContent"];
ns.View.edefine("compose-message-editor-tiny",{models:{"module-editor":!1,"quick-reply-state":!1,"compose-sidebar-state":!1,"compose-sidebar-fsm":!1,"compose-message":!1,"compose-attachments":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"}},params:ns.View.info("compose2").params,ctor:function(){t.ctor.apply(this,arguments),_.bindAll(this,o),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,50)
},yateModule:"compose2",methods:{FIELD_NAME:"send",getConfig:function(){var e=this,t={};return CKEDITOR.editorConfig(t),_.extend(t,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE_TINY,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),pastefileGetPlaceholderContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];
return t||(t=document.body),new CKEDITOR.dom.element(t)},pastefileGetDropContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document),t}},this)),t},getEditor:function(){var e=CKEDITOR.instances[this.editorId];return e&&"ready"===e.status?e:void 0},getEditorId:function(){return this.editorId},onShow:function(e,t,o){this._timings=o,this._timings.showEditor=Date.now();var s=this.getModel("compose-message"),i=this.getConfig();i.height=60,i.startupMode=s.isHtmlType()?"wysiwyg":"source",i.viewParams=_.clone(this.params),this._timeoutEditorCreate=setTimeout(function(){CKEDITOR.replace(this.getEditorId(),i)
}.bind(this),50);var n=this.getControllerNode();n.on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),s.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged);var a=this.getModel("compose-state");a.setIfChanged(".editorMode",i.startupMode)},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.destroyEditor()
},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),o=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:o&&o.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){var o=this.getModel("compose-state");o.setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()
}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark();var e=this.getModel("quick-reply-state").getTmpContentAndRemove();e&&(this._timeoutApplyTmpContent=_.defer(this._applyTmpContent,e))},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())
},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},syncViewToData:function(){if(this.isVisible()){var e=this.getEditor();if(e&&e.checkDirty()){var t=e.getData();"undefined"!=typeof t&&(this.setFieldData(t),e.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,{callback:function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings),this.syncDataToView(),this.onFocusFieldChanged()
},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);t!==!1&&(e.data.dataValue=t)}},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,o="wysiwyg"===t.mode?"html":"plain",s=t.getData(),i=this.getModel("compose-state");i.setIfChanged(".editorMode",t.mode);
var n=this.getModel("compose-message");n.setIfChanged(".ttype",o),this.setFieldData(s),t.resetDirty();var a=ns.Model.get("settings");"source"===t.mode?a.setSettingOff("enable_richedit"):a.setSettingOn("enable_richedit")},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();
if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",o)}else{var s=e.getSelection(),i=s&&!s.isLocked&&s.getRanges();t.setIfChanged(".editorBookmark",i)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var o=t.get(".bodyPos");o&&Daria.setSelection(e.editable().$,o)}else{var s=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(s)&&s.length){var i=e.getSelection();
i&&i.selectRanges(s)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}}}},e)}(),ns.View.define("compose-addimage-popup",{yateModule:"compose2",events:{"wheel window":"onWheel"},methods:{_popup:null,_input:null,open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this._popup=nb.block(this.node),this._popup.on("nb-opened",this._onOpened.bind(this,e)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})
},this)},_hideError:function(e){e.data.error&&(e.$node.removeClass("_nb-is-wrong"),e.error.close())},_onOpened:function(e){this._input=nb.$block(".js-imageurl-input",this.node),e&&e.defaultValue&&"string"==typeof e.defaultValue&&this._input.setValue(e.defaultValue),e&&e.showError&&this._input.showError(),this._input.on("nb-changed",function(){Jane.FormValidation.isUrl(this.getValue())||this.showError()});var t=function(){this._hideError(this._input)}.bind(this);this._input.$control.on("keydown",t),this._input.$control.on("click",t),this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))
},_onResolve:function(){this._input&&this._input.getValue&&Jane.FormValidation.isUrl(this._input.getValue())?(this.trigger("resolve",this._input.getValue()),this._popup.close()):this._input.showError()},_onClosed:function(){var e=this;_.defer(function(){e._popup.$node.off("click"),e._input&&(e._input.$control&&e._input.$control.off(),e._input.destroy(),e._input=null),e._popup&&(e._popup.destroy(),e._popup=null),e.trigger("reject"),e.destroy()})},getScrollContent:function(){return null}}},"prevent-scroll-propagation-mixin",ns.View),function(){var e=ns.Model.get("all-toolbar-buttons"),t={compose2:{scroll:!1,buttons:[{id:"compose-go",_enable:function(){return!Jane.watcher.get("compose.open")
}},"check-mail","delete-draft","compose-reply","compose-reply-all","labels-actions"]},done:{buttons:["compose-go","check-mail"]}};_.each(t,function(t,o){t.buttons=e.getButtonsByDeclarations(t.buttons),ns.Model.get("toolbar",{layout:o}).setData(t)})}(),function(){function e(){var e={"compose-attach-buttons-wrapper":{},"compose-send-button-complex":{},"compose-button-translate-apply":{},"compose-button-translate-close":{},"compose-autosave-status":{}};return"TUR"!==Daria.Config.product&&(e["compose-notify-on-send-button"]={},ns.Model.get("labels").getWaitingForReplyLabel()&&(e["compose-notify-noreply-button"]={})),e
}var t=function(){return{"compose-fields-wrapper":{},"compose-attach-area":{},"compose-field-att_ids-notices-wrapper":{},"compose-forwarded-messages":{},"compose-message-editor":{}}},o=_.extend({"compose-head":{"compose-action-buttons":{},"compose-from":{},"compose-cancel-button":{}},"compose-footer":e},t());ns.layout.define("layout-compose-action-buttons",{"compose-action-buttons-box@":{"compose-send-link":{}}}),ns.layout.define("layout-compose-action-buttons-template",{"compose-action-buttons-box@":{"compose-send-link":{},"compose-save-link":{}}}),ns.layout.define("layout-compose-action-buttons-new-template",{"compose-action-buttons-box@":{"compose-save-link":{},"compose-send-link":{}}});
var s={compose2:o};Daria.is2pane()&&(s.footer={"footer-help-link":{}}),ns.layout.define("compose2",{"app right-box@":{"compose-box@":s},"app messages-direct-box@":{},"app toolbar-box@":{toolbar:{"toolbar-buttons-box@":"toolbar-buttons"}}},"common+left+toolbar"),ns.layout.define("browse-disk",{"browse-disk":{"browse-disk-crumbs-box@":function(e){return e.path?"browse-disk-crumbs":null},"browse-disk-listing-box@":function(e){return e.path?"browse-disk-listing&":null}}}),ns.layout.define("forgotten-attach",{"compose-forgotten-attach":{"compose-forgotten-attach-button":{}}}),ns.layout.define("compose-attach-select-location",{"compose-attach-select-location":function(){var e={"compose-attach-button-computer":{}},t=ns.Model.get("compose-state");
return t.hasDisk()&&!Daria.Config["is-corp"]&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("layout-compose-attach-buttons-wrapper",{"compose-attach-buttons-box@":function(){var e={"compose-attach-button-computer":{}},t=ns.Model.get("compose-state");return t.hasDisk()&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("compose-template-list",{"compose-template-list":{}}),ns.layout.define("layout-compose-labels",{"compose-labels-box@":{"compose-labels":{}}}),ns.layout.define("layout-compose-labels-empty",{"compose-labels-box@":{}}),ns.layout.define("layout-compose-popular-contacts",{"compose-popular-contacts-box@":{"compose-popular-contacts":{}}}),ns.layout.define("layout-compose-popular-contacts-empty",{"compose-popular-contacts-box@":{}}),ns.layout.define("layout-compose-field-to-extras",{"compose-field-to-extras-box@":{"compose-field-extras-to":{}}}),ns.layout.define("layout-compose-message-editor-bottom",{"compose-message-editor-bottom-box@":{"compose-message-show-hidden-parts":{},"compose-message-editor-bottom-buttons":{"compose-action-buttons":{}}}}),ns.layout.define("layout-compose-message-editor-bottom-buttons-empty",{"compose-message-editor-bottom-box@":{"compose-message-show-hidden-parts":{}}}),ns.layout.define("layout-compose-message-editor-top",{"compose-message-editor-top-box@":{"compose-recipients-diff":{}}}),ns.layout.define("layout-compose-field-notices-att_ids",{"compose-field-notices-box@":{"compose-field-notices-att_ids":{}}}),ns.layout.define("layout-compose-field-notices-to",{"compose-field-notices-box@":{"compose-field-notices-to":{}}}),ns.layout.define("layout-compose-field-notices-phone",{"compose-field-notices-box@":{"compose-field-notices-phone":{}}}),ns.layout.define("layout-compose-field-notices-cc",{"compose-field-notices-box@":{"compose-field-notices-cc":{}}}),ns.layout.define("layout-compose-field-notices-bcc",{"compose-field-notices-box@":{"compose-field-notices-bcc":{}}}),ns.layout.define("layout-compose-fields",{"compose-fields-box@":{"compose-field-to":{"compose-field-to-extras":{}},"compose-field-to-notices-wrapper":{},"compose-popular-contacts-wrapper":{},"compose-field-cc":{},"compose-field-cc-notices-wrapper":{},"compose-field-bcc":{},"compose-field-bcc-notices-wrapper":{},"compose-field-phone":{},"compose-field-phone-notices-wrapper":{},"compose-field-subject":{"compose-template-list-button":{}},"compose-labels-wrapper":{}}}),ns.layout.define("layout-compose-fields-placeholder",{"compose-fields-box@":{"compose-field-placeholder":{"compose-field-to-extras":{}}}}),ns.layout.define("layout-compose-field-phone-input",{"compose-field-phone-input-box@":{"compose-field-phone-input":{}}}),ns.layout.define("layout-compose-field-phone-input-error",{"compose-field-phone-input-box@":{"compose-field-phone-input-error":{}}}),ns.layout.define("layout-quick-reply",{"quick-reply-box@":{"quick-reply-form-wrap":{"quick-reply-form":{}}}}),ns.layout.define("layout-quick-reply-placeholder",{"quick-reply-box@":{"quick-reply-placeholder":{}}}),ns.layout.define("layout-quick-reply-empty",{"quick-reply-box@":{}}),ns.layout.define("layout-quick-reply-done",{"quick-reply-box@":{"quick-reply-done":{"quick-reply-done-box@":{"quick-reply-done-success":{}}}}}),ns.layout.define("layout-quick-reply-form",{"quick-reply":{"compose-recipients":{},"compose-send-loader":{},"compose-attach-buttons-wrapper":{},"compose-go-to-compose":{},"compose-field-to-extras-qr-close":{},"compose-message-editor-tiny":{},"compose-send-link":{}}}),ns.layout.define("layout-thread-quick-reply-form",{"quick-reply-plain":{"compose-recipients":{},"compose-send-loader":{},"compose-attach-buttons-wrapper":{},"compose-go-to-compose":{},"compose-field-to-extras-qr-close":{},"compose-message-editor-tiny":{},"compose-send-link":{}}}),ns.layout.define("layout-thread-quick-reply",{"thread-quick-reply-box@":{"thread-quick-reply-form-wrap":{"thread-quick-reply-form":{}}}}),ns.layout.define("layout-thread-quick-reply-empty",{"thread-quick-reply-box@":{}}),ns.layout.define("layout-thread-quick-reply-placeholder",{"thread-quick-reply-box@":{"thread-quick-reply-placeholder":{}}}),ns.layout.define("layout-compose-sidebar",{"compose-sidebar":o}),ns.layout.define("done",{"app messages-direct-box@":{},"app right-box@":{done:{"done-promo@":function(e){return Daria.Done.PromoManager.checkPromo(e)
}}}},"common+left+toolbar"),ns.layout.define("layout-compose-sidebar-done",{"compose-sidebar-done":{}})}(),borschik.addLinks({"b-mail-icon_bigmail-48.png":"//yastatic.net/mail/_/BISvkUqoFFfBRdVeOJHh6SLDIS0.png","b-mail-icon_blue-48.png":"//yastatic.net/mail/_/qo0uPE3DogGlqA0ccfCyNgSbcrc.png","b-mail-icon_blue-al-48.png":"//yastatic.net/mail/_/luXKKeyD2zbDahE0JFT7x0NAAyg.png","b-mail-icon_blue-ar-48.png":"//yastatic.net/mail/_/RxviFQqbpqVQf71sKxOjNz1hRgY.png","b-mail-icon_camera-48.png":"//yastatic.net/mail/_/lL3Bqyh3OhJRvseinVMFfQ7YIT0.png","b-mail-icon_grey-48.png":"//yastatic.net/mail/_/T2CUN5MS8zDrKq38RrRi4ubPNxk.png","b-mail-icon_narod-48.png":"//yastatic.net/mail/_/lcVBanVBX9b5au3qMUvKzo7ecoo.png","b-mail-icon_shared-foreign-48.png":"//yastatic.net/mail/_/V-IHNd_MGqqp4qHN38vuqmRibQQ.png","b-mail-icon_shared-own-48.png":"//yastatic.net/mail/_/JU3qU_PUyKyVLV5wmQ5mxBsY6Fk.png","b-mail-icon_trash-48.png":"//yastatic.net/mail/_/XTt74JhTKaNTNZI0Y-oLEEWq8B0.png"}),function(){var e=Object.create(HTMLTextAreaElement.prototype);
e.createdCallback=function(){this._isDetached=!1,this.detachedDispatchEvent=_.debounce(this.detachedDispatchEvent.bind(this),20,{leading:!0,trailing:!1}),this.attachedDispatchEvent=_.debounce(this.attachedDispatchEvent.bind(this),20,{leading:!0,trailing:!0}),this.addEventListener("DOMNodeRemoved",this.detachedDispatchEvent),this.addEventListener("DOMNodeRemovedFromDocument",this.detachedDispatchEvent),this.addEventListener("DOMNodeInserted",this.attachedDispatchEvent),this.addEventListener("DOMNodeInsertedIntoDocument",this.attachedDispatchEvent)
},e.attachedCallback=function(){this.attachedDispatchEvent()},e.detachedCallback=function(){this.detachedDispatchEvent()},e.attachedDispatchEvent=function(){if(this._isDetached){this._isDetached=!1;var e=document.createEvent("Event");e.initEvent("x-attached",!1,!1),this.dispatchEvent(e)}},e.detachedDispatchEvent=function(){if(!this._isDetached){this._isDetached=!0;var e=document.createEvent("Event");e.initEvent("x-detached",!1,!1),this.dispatchEvent(e)}},document.registerElement("x-editor",{"extends":"textarea",prototype:e})
}();!function(e){function t(s){if(o[s])return o[s].exports;var i=o[s]={exports:{},id:s,loaded:!1};return e[s].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t,o){function s(e){for(var t in f){var o=c(f[t],2),s=o[0],i=o[1];e[t]=b[s](e[t]),"undefined"==typeof e[t]&&(e[t]=i)}}function i(e){e.editor||Object.defineProperty(e,"editor",{configurable:!0,value:h.init(e)})}function n(e){e.editor&&(h.destroy(e),delete e.editor)}function a(e){return e.map(function(e){return e.innerHTML
}).join(", ")}function r(){return!0}var c=function(){function e(e,t){var o=[],s=!0,i=!1,n=void 0;try{for(var a,r=e[Symbol.iterator]();!(s=(a=r.next()).done)&&(o.push(a.value),!t||o.length!==t);s=!0);}catch(c){i=!0,n=c}finally{try{!s&&r["return"]&&r["return"]()}finally{if(i)throw n}}return o}return function(t,o){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,o);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e
}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d=o(1),u=o(2),h=o(19),p=o(5),m=o(7),f={begining:["reg",null,"begining"],bubbleCopy:["func",a,"bubble-copy"],bubbleDeformation:["func",function(){},"bubble-deformation"],bubbleFormation:["func",function(){},"bubble-formation"],checkBubblePaste:["func",r,"check-bubble-paste"],classBubble:["str","bubble","class-bubble"],disableControls:["bool",!1,"disable-controls"],draggable:["bool",!0,"draggable"],ending:["reg",null,"ending"],separator:["reg",/[,;]/,"separator"],tokenizer:["func",null,"tokenizer"]},g=Object.create(HTMLDivElement.prototype,{createdCallback:{value:function(){i(this)
}},attachedCallback:{value:function(){i(this),u.init(this),p.bubbling(this)}},detachedCallback:{value:function(){u.destroy(this),n(this)}},options:{value:function(e,t){if(!this._options){this._options={};for(var o in f){this._options[o]=void 0;var i="data-"+f[o][2];this.hasAttribute(i)&&(this._options[o]=this.getAttribute(i))}s(this._options)}return"undefined"==typeof t?this._options[e]:(this._options[e]=t,void s(this._options))}},items:{get:function(){return m.getBubbles(this)}},inputValue:{get:function(){return this.editor.inputValue()
}},setContent:{value:function(e){return this.editor.setContent(e)}},addBubble:{value:function(e,t){return this.editor.addBubble(e,t)}},removeBubble:{value:function(e){return this.editor.removeBubble(e)}},editBubble:{value:function(e){return this.editor.editBubble(e)}}});e.exports=d.document.registerElement("x-bubbles",{"extends":"div",prototype:g});var b={func:function(e){var t="undefined"==typeof e?"undefined":l(e);switch(t){case"string":return new Function("context","return context."+e+";")(d);
case"function":return e}},bool:function(e){var t="undefined"==typeof e?"undefined":l(e);switch(t){case"string":return"true"===e||"on"===e;case"boolean":return e}},noop:function(e){return e},reg:function(e){var t="undefined"==typeof e?"undefined":l(e);switch(t){case"string":if(e){var o=e.match(/\/(.+)\/([gimy]{0,3})/i);if(o)return new RegExp(o[1],o[2])}return null;case"object":if(e instanceof d.RegExp||null===e)return e}},str:function(e){return"undefined"!=typeof e?e?String(e):"":void 0}}},function(e){e.exports=function(){return this||(1,eval)("this")
}()},function(e,t,o){var s=o(3),i=o(17),n=o(8),a=n.canUseDrag;t.init=function(e){return a?s.init(e):i.init(e)},t.destroy=function(e){return a?s.destroy(e):i.destroy(e)}},function(e,t,o){function s(e){e.stopPropagation();var t=u.closestNodeSet(e.target),o=u.closestNodeBubble(e.target);if(!t||!o)return void e.preventDefault();var s=l.getSelection();s&&s.removeAllRanges(),y=t,t.classList.add(m.DRAGSTART),d.add(o),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain","");var i=d.get(y);
i.length>1&&e.dataTransfer.setDragImage(g(),_.w,_.h)}function i(e){if(e.stopPropagation(),e.preventDefault(),y){var t=u.closestNodeSet(e.target);if(t&&t!==y){var o=d.get(y);o.length&&(o.forEach(function(e){return t.appendChild(e)}),l.setTimeout(b,0,y,t))}}}function n(e){e.stopPropagation(),e.preventDefault(),y&&(e.dataTransfer.dropEffect="move")}function a(e){if(e.stopPropagation(),e.preventDefault(),y){var t=u.closestNodeSet(e.target);t&&t!==y&&t.classList.add(m.DROPZONE)}}function r(e){if(e.stopPropagation(),e.preventDefault(),y){var t=u.closestNodeSet(e.target);
t&&t!==y&&t.classList.remove(m.DROPZONE)}}function c(e){if(e.stopPropagation(),e.preventDefault(),y){y.classList.remove(m.DRAGSTART);var t=u.closestNodeSet(e.target);t&&t!==y&&t.classList.remove(m.DROPZONE),y=null}}var l=o(1),d=o(4),u=o(7),h=o(12),p=o(14),m=p.CLS,f=o(15),g=f.getDragImage,b=f.onDropSuccess,_=f.DRAG_IMG,v={dragend:c,dragenter:a,dragleave:r,dragover:n,dragstart:s,drop:i},y=null;t.init=function(e){h.on(e,v)},t.destroy=function(e){h.off(e,v)}},function(e,t,o){function s(e){if(b.isBubbleNode(e)){var t=e.parentNode,o=c(t);
if(!o.length)return void u(e);l(t);var s=o[0],i=o[o.length-1];s!==i&&t.startRangeSelect||(t.startRangeSelect=s);var n=void 0,a=void 0,r=e.compareDocumentPosition(t.startRangeSelect);if(r&Node.DOCUMENT_POSITION_PRECEDING?(n=t.startRangeSelect,a=e):(n=e,a=t.startRangeSelect),n&&a){for(var d=n;d&&m(d)&&d!==a;)d=d.nextSibling;b.bubbling(t)}}}function i(e){v.call(e.querySelectorAll(D)).forEach(function(e){return m(e)}),e.startRangeSelect=e.querySelector(y),b.bubbling(e);var t=g.getSelection();t&&t.removeAllRanges()
}function n(e){return Boolean(e.querySelector(y))}function a(e){return c(e)[0]}function r(e){var t=c(e);return t[t.length-1]}function c(e){return v.call(e.querySelectorAll(y))}function l(e){c(e).forEach(function(e){return e.removeAttribute("selected")})}function d(e){if(m(e)){var t=_.closestNodeSet(e);return t.startRangeSelect=e,b.bubbling(t),!0}return!1}function u(e){if(!b.isBubbleNode(e))return!1;var t=_.closestNodeSet(e),o=g.getSelection();return o&&o.removeAllRanges(),l(t),d(e)}function h(e){if(p(e)){var t=_.closestNodeSet(e);
if(1===c(t).length)return f(e)}return u(e)}function p(e){return b.isBubbleNode(e)&&e.hasAttribute("selected")||!1}function m(e){return b.isBubbleNode(e)?(e.setAttribute("selected",""),!0):!1}function f(e){return b.isBubbleNode(e)?(e.removeAttribute("selected"),!0):!1}var g=o(1),b=o(5),_=o(7),v=Array.prototype.slice,y="[bubble][selected]",D="[bubble]:not([selected])";t.all=i,t.add=d,t.clear=l,t.get=c,t.uniq=u,t.head=a,t.last=r,t.has=n,t.range=s,t.toggleUniq=h},function(e,t,o){function s(e){return e&&e.nodeType===Node.ELEMENT_NODE?e.hasAttribute("bubble"):!1
}function i(e,t){if(t.hasAttribute("readonly"))return!1;var o=h.getSelection();if(!o)return!1;var s=e.options("bubbleDeformation"),i=s(t);if(!i){var n=p.textClean(t.innerText);i={text:n,startOffset:0,endOffset:n.length}}var a=p.createZws(),r=h.document.createTextNode(i.text);e.fireEdit(t),e.replaceChild(r,t),e.insertBefore(a,r);var c=h.document.createRange();return c.setStart(r,i.startOffset),c.setEnd(r,i.endOffset),o.removeAllRanges(),o.addRange(c),!0}function n(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};
if(t=p.textClean(t)){var s=e.options("bubbleFormation"),i=e.options("classBubble"),n=g&&e.options("draggable"),a=e.ownerDocument.createElement("span");a.innerText=t;for(var r in o)o[r]&&a.setAttribute("data-"+r,f(o[r]));if(s(a),i)for(var c=String(i).trim().split(/\s+/),l=c.length;l--;)a.classList.add(c[l]);return a.setAttribute("bubble",""),a.setAttribute("contenteditable","false"),n&&a.setAttribute("draggable","true"),a}}function a(e){var t=e.options("begining"),o=e.options("ending"),s=e.options("separator"),i=e.options("tokenizer"),a=r(e),m=[];
return a.forEach(function(a){var r=p.textClean(a.toString());if(!r)return void a.deleteContents();var f=[r];if(i?f=i(r):(s&&(f=r.split(s).map(c).filter(l)),o?f=f.reduce(function(e,t){return e.concat(d(t,o))},[]).map(c).filter(l):t&&(f=f.reduce(function(e,o){return e.concat(u(o,t))},[]).map(c).filter(l))),!Array.isArray(f)||!f.length)return void a.deleteContents();var g=h.document.createDocumentFragment();f.forEach(function(t){var o=n(e,t);o&&(g.appendChild(o),m.push(o))}),a.deleteContents(),a.insertNode(g)
}),e.fireInput(),m.length&&e.fireChange(),m}function r(e){for(var t=[],o=e.childNodes,i=void 0,n=void 0,a=0;a<o.length;a++)n=o[a],s(n)?i&&(i.setEndBefore(n),t.push(i),i=void 0):i||(i=h.document.createRange(),i.setStartBefore(n));return i&&(i.setEndAfter(n),t.push(i)),t}function c(e){return e.trim()}function l(e){return Boolean(e)}function d(e,t){var o=[],s=0,i=999;for(t.lastIndex=0;null!==t.exec(e)&&i;)i--,o.push(e.substring(s,t.lastIndex)),s=t.lastIndex;return o}function u(e,t){var o=[],s=void 0,i=0,n=999;
for(t.lastIndex=0;null!==(s=t.exec(e))&&n;)n--,i!==s.index&&(o.push(e.substring(i,s.index)),i=s.index);return o.push(e.substring(i,e.length)),o}var h=o(1),p=o(6),m=o(8),f=m.escape,g=m.canUseDrag;t.isBubbleNode=s,t.bubbling=a,t.create=n,t.edit=i},function(e,t,o){function s(e,t){var o=v(e),s=o&&i(e,o);return s?(o.removeAllRanges(),o.addRange(s),a(o,t)):e.appendChild(t),!0}function i(e,t){if(t=t||v(e)){var o=t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE?t.focusNode:t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode:void 0;
if(o){for(var s=o,i=o,n=o;n&&n.nodeType===Node.TEXT_NODE;)s=n,n=n.previousSibling;for(n=o;n&&n.nodeType===Node.TEXT_NODE;)i=n,n=n.nextSibling;var a=e.ownerDocument.createRange();return a.setStartBefore(s),a.setEndAfter(i),a}}}function n(e){return a(e,h())}function a(e,t){if(!e||!e.rangeCount)return!1;var o=g.document.createElement("span");if(e.getRangeAt(0).surroundContents(o),o.parentNode.replaceChild(t,o),e.removeAllRanges(),t.nodeType===Node.TEXT_NODE){var s=g.document.createRange();s.setStart(t,t.nodeValue.length),s.collapse(!1),e.addRange(s)
}else e.collapse(t,0);return!0}function r(e,t){if(e=m(e),!e)return!1;t=t||g.getSelection();var o=g.document.createTextNode(e);return a(t,o)?(t.collapse(o,o.nodeValue.length),!0):!1}function c(e,t){if(e=e||g.getSelection(),!e||!e.anchorNode||e.anchorNode.nodeType!==Node.TEXT_NODE)return!1;var o=f(e),s=o.startNode,i=o.endNode,n=o.startOffset,a=o.endOffset,r=o.revert;if(!e.isCollapsed&&!t)return e.collapse(s,n),!0;var c=Boolean(e.extend);r=c?r:!r;for(var l=r?s:i,d=r?n:a;l;){if(l.nodeType!==Node.TEXT_NODE)return!1;
if(null===d&&(d=l.nodeValue.length),0>d-1)l=l.previousSibling,d=null;else{var u=l.nodeValue.substring(d-1,d);if(!p(u))break;d-=1}}if(!l||null===d)return!1;if(t)if(c)e.extend(l,d-1);else{var h=g.document.createRange();r?(h.setStart(l,d-1),h.setEnd(i,a)):(h.setStart(s,n),h.setEnd(l,d-1)),e.removeAllRanges(),e.addRange(h)}else e.collapse(l,d-1);return!0}function l(e,t){if(e=e||g.getSelection(),!e||!e.focusNode||e.focusNode.nodeType!==Node.TEXT_NODE)return!1;var o=f(e),s=o.startNode,i=o.endNode,n=o.startOffset,a=o.endOffset,r=o.revert;
if(!e.isCollapsed&&!t)return e.collapse(i,a),!0;for(var c=r?s:i,l=r?n:a;c;){if(c.nodeType!==Node.TEXT_NODE)return!1;var d=c.nodeValue.length;if(l+1>d)c=c.nextSibling,l=0;else{var u=c.nodeValue.substring(l,l+1);if(!p(u))break;l+=1}}if(!c)return!1;if(t){var h=Boolean(e.extend);if(h)e.extend(c,l+1);else{var m=g.document.createRange();r?(m.setStart(c,l+1),m.setEnd(i,a)):(m.setStart(s,n),m.setEnd(c,l+1)),e.removeAllRanges(),e.addRange(m)}}else e.collapse(c,l+1);return!0}function d(e){if(!e)return"";var t=g.document.implementation.createHTMLDocument("").body;
return t.innerText=e,t.innerText.replace(/^[\u0020\u00a0]+$/gm,"").replace(/\n/gm," ").trim()}function u(e,t){e=e||g.getSelection();var o=e&&e.anchorNode;if(!o||o.nodeType!==Node.TEXT_NODE)return!1;for(var s=void 0,i=void 0,n=o;n&&n.nodeType===Node.TEXT_NODE;)s=n,n=n.previousSibling;for(n=o;n&&n.nodeType===Node.TEXT_NODE;)i=n,n=n.nextSibling;var a=b.hasBubbles(t),r=g.document.createRange();r.setStartBefore(s),r.setEndAfter(i);var c=m(r.toString());return c||!c&&!a?(c||r.collapse(),e.removeAllRanges(),e.addRange(r),!0):!1
}function h(){return g.document.createTextNode(C)}function p(e){return D.test(e)}function m(e){return String(e||"").trim().replace(y,"")}function f(e){var t=e.anchorNode,o=e.focusNode,s=e.anchorOffset,i=e.focusOffset,n=!1;if(t===o)s=Math.min(e.anchorOffset,e.focusOffset),i=Math.max(e.anchorOffset,e.focusOffset),n=e.anchorOffset>e.focusOffset;else{var a=e.anchorNode.compareDocumentPosition(e.focusNode);a&Node.DOCUMENT_POSITION_PRECEDING&&(t=e.focusNode,s=e.focusOffset,o=e.anchorNode,i=e.anchorOffset,n=!0)
}return{startNode:t,endNode:o,startOffset:s,endOffset:i,revert:n}}var g=o(1),b=o(7),_=o(8),v=_.getSelection,y=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,D=/\u200B/,C="​";
t.arrowRight=l,t.arrowLeft=c,t.remove=n,t.html2text=d,t.currentTextRange=i,t.text2bubble=s,t.replaceString=r,t.selectAll=u,t.textClean=m,t.checkZws=p,t.createZws=h},function(e,t,o){function s(e){return e.querySelector("[bubble]:last-child")}function i(e){return e.querySelector("[bubble]:first-child")}function n(e){return Array.prototype.slice.call(e.querySelectorAll("[bubble]"))}function a(e){return Boolean(e.querySelector("[bubble]"))}function r(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.previousSibling;
for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.previousSibling);t;){if(m.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&f.textClean(t.nodeValue))return;t=t.previousSibling}}}function c(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.nextSibling;for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.nextSibling);t;){if(m.isBubbleNode(t))return t;
if(t.nodeType===Node.TEXT_NODE&&f.textClean(t.nodeValue))return;t=t.nextSibling}}}function l(e){for(;e;){if(p(e))return e;e=e.parentNode}}function d(e){for(;e;){if(m.isBubbleNode(e))return e;if(p(e))return;e=e.parentNode}}function u(e){for(var t=e&&e.previousSibling;t;){if(m.isBubbleNode(t))return t;t=t.previousSibling}}function h(e){for(var t=e&&e.nextSibling;t;){if(m.isBubbleNode(t))return t;t=t.nextSibling}}function p(e){return e.nodeType===Node.ELEMENT_NODE&&"x-bubbles"===e.getAttribute("is")
}var m=o(5),f=o(6);t.closestNodeBubble=d,t.closestNodeSet=l,t.findBubbleLeft=r,t.findBubbleRight=c,t.getBubbles=n,t.hasBubbles=a,t.headBubble=i,t.lastBubble=s,t.nextBubble=h,t.prevBubble=u},function(e,t,o){function s(e){return c[e]}function i(e){return r[e]}var n=o(9),a=o(1),r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},c={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},l=/&(?:amp|lt|gt|quot|#39|#96);/g,d=/[&<>"'`]/g,u=RegExp(l.source),h=RegExp(d.source),p=/Trident|Edge/;
t.getSelection=function(e){var t=a.getSelection();return t&&t.anchorNode&&e.compareDocumentPosition(t.anchorNode)&Node.DOCUMENT_POSITION_CONTAINED_BY?t:void 0},t.throttle=function(e,t){var o=0,s=function(){o=0};return function(){o||(o=n(s),e.apply(t||this,arguments))}},t.escape=function(e){return e=String(e),e&&h.test(e)?e.replace(d,i):e},t.unescape=function(e){return e=String(e),e&&u.test(e)?e.replace(l,s):e},t.canUseDrag=function(){return!p.test(a.navigator.userAgent)}(),t.isIE=function(){return p.test(a.navigator.userAgent)
}()},function(e,t,o){(function(t){for(var s=o(10),i="undefined"==typeof window?t:window,n=["moz","webkit"],a="AnimationFrame",r=i["request"+a],c=i["cancel"+a]||i["cancelRequest"+a],l=0;!r&&l<n.length;l++)r=i[n[l]+"Request"+a],c=i[n[l]+"Cancel"+a]||i[n[l]+"CancelRequest"+a];if(!r||!c){var d=0,u=0,h=[],p=1e3/60;r=function(e){if(0===h.length){var t=s(),o=Math.max(0,p-(t-d));d=o+t,setTimeout(function(){var e=h.slice(0);h.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(d)}catch(o){setTimeout(function(){throw o
},0)}},Math.round(o))}return h.push({handle:++u,callback:e,cancelled:!1}),u},c=function(e){for(var t=0;t<h.length;t++)h[t].handle===e&&(h[t].cancelled=!0)}}e.exports=function(e){return r.call(i,e)},e.exports.cancel=function(){c.apply(i,arguments)},e.exports.polyfill=function(){i.requestAnimationFrame=r,i.cancelAnimationFrame=c}}).call(t,function(){return this}())},function(e,t,o){(function(t){(function(){var o,s,i;"undefined"!=typeof performance&&null!==performance&&performance.now?e.exports=function(){return performance.now()
}:"undefined"!=typeof t&&null!==t&&t.hrtime?(e.exports=function(){return(o()-i)/1e6},s=t.hrtime,o=function(){var e;return e=s(),1e9*e[0]+e[1]},i=o()):Date.now?(e.exports=function(){return Date.now()-i},i=Date.now()):(e.exports=function(){return(new Date).getTime()-i},i=(new Date).getTime())}).call(this)}).call(t,o(11))},function(e){function t(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function s(e){if(l===setTimeout)return setTimeout(e,0);
if((l===t||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(o){try{return l.call(null,e,0)}catch(o){return l.call(this,e,0)}}}function i(e){if(d===clearTimeout)return clearTimeout(e);if((d===o||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function n(){m&&h&&(m=!1,h.length?p=h.concat(p):f=-1,p.length&&a())}function a(){if(!m){var e=s(n);m=!0;for(var t=p.length;t;){for(h=p,p=[];++f<t;)h&&h[f].run();
f=-1,t=p.length}h=null,m=!1,i(e)}}function r(e,t){this.fun=e,this.array=t}function c(){}var l,d,u=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:t}catch(e){l=t}try{d="function"==typeof clearTimeout?clearTimeout:o}catch(e){d=o}}();var h,p=[],m=!1,f=-1;u.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var o=1;o<arguments.length;o++)t[o-1]=arguments[o];p.push(new r(e,t)),1!==p.length||m||s(a)},r.prototype.run=function(){this.fun.apply(null,this.array)
},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=c,u.addListener=c,u.once=c,u.off=c,u.removeListener=c,u.removeAllListeners=c,u.emit=c,u.binding=function(){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},function(e,t,o){function s(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e
}function i(){var e=c.document.documentElement,t=c.document.body;return(e&&e.scrollLeft||t&&t.scrollLeft||0)-(e.clientLeft||0)}function n(){var e=c.document.documentElement,t=c.document.body;return(e&&e.scrollTop||t&&t.scrollTop||0)-(e.clientTop||0)}function a(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new d(t,o))}function r(e,t,o){return function s(i){e.removeEventListener(t,s),o(i)}}var c=o(1),l=o(13);t.scrollX=i,t.scrollY=n,t.dispatch=a,t.keyCode=function(e){return e.charCode||e.keyCode
},t.metaKey=function(e){return e.ctrlKey||e.metaKey},t.pageX=function(e){return null===e.pageX&&null!==e.clientX?e.clientX+i():e.pageX},t.pageY=function(e){return null===e.pageY&&null!==e.clientY?e.clientY+n():e.pageY},t.one=function(e,t,o){var i=o?s({},t,o):t;for(var n in i)e.addEventListener(n,r(e,n,i[n]))},t.on=function(e,t,o){var i=o?s({},t,o):t;for(var n in i)e.addEventListener(n,i[n])},t.off=function(e,t,o){var i=o?s({},t,o):t;for(var n in i)e.removeEventListener(n,i[n])},t.prevent=function(e){return e.cancelBubble=!0,e.returnValue=!1,e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1
};var d=function(){return"function"==typeof c.CustomEvent?c.CustomEvent:l}()},function(e,t,o){var s=o(1),i=s.document,n=s.Event.prototype,a=!1;try{a=Boolean(i.createEvent("CustomEvent"))}catch(r){}var c=n.stopImmediatePropagation;n.stopImmediatePropagation=function(){this.immediatePropagationStopped=!0,c?c.call(this):this.stopPropagation()};var l=function(){return a?function(e,t){t=t||{};var o=Boolean(t.bubbles),s=Boolean(t.cancelable),n=i.createEvent("CustomEvent");return n.initCustomEvent(e,o,s,t.detail),n
}:function(e,t){t=t||{};var o=Boolean(t.bubbles),s=Boolean(t.cancelable),n=i.createEvent("Event");return n.initEvent(e,o,s),n.detail=t.detail,n}}();l.prototype=n,e.exports=l},function(e,t){t.KEY={a:65,Backspace:8,Bottom:40,c:67,Cmd:91,Comma:44,Delete:46,Enter:13,Esc:27,Left:37,Right:39,Semicolon:59,Space:32,Tab:9,Top:38,x:88},t.CLS={DRAGSTART:"drag",DROPZONE:"dropzone"},t.EV={BUBBLE_EDIT:"bubble-edit",BUBBLE_INPUT:"bubble-input",CHANGE:"change",DRAGEND:"dragend",DRAGENTER:"dragenter",DRAGLEAVE:"dragleave",DRAGSTART:"dragstart",DROP:"drop"},t.PROPS={BUBBLE_VALUE:"_bubbleValue",CLICK_TIME:"_clickTime",LOCK_COPY:"_lockCopy"}
},function(e,t,o){var s={w:16,h:16},i=null;t.DRAG_IMG=s,t.getDragImage=function(){return i||(i=new Image,i.src=o(16)),i},t.onDropSuccess=function(e,t){e.fireChange(),t.focus(),t.fireChange()}},function(e){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAAAVCAMAAAAw/0MlAAABblBMVEUAAABOXIZJWIKCkbeNnMKMmsJNW4VNW4VWZY57ibFHV4KVpMxRYImCkLh9jbpgcJ1fcJ1JWoaZqdNUZpaHmMaVpdJIWolTZJKHmMZEV4iXqNdkdqhjdal2iLx2ib2Knc6PodNJXpJJXpNOYpdpfLKCk8JPYpdofLNugblugrqUptdZdLdZd8Nfeb93js1+ksuGm9SGm9VHaLhJarxKZqxKbL9La7pNbr9Pb71Ucr1Wbag/XqU/X6pAVopffMdjf8ZphMpwicx2js9BW51CWZN/ldCBl9KCmNNFYKRFZbGJndWOodVKX5RKX5ZKYJdWdcNXbKJYdL1KYJtAVYpaeMVJXpJKbMBgebpjeLBjf8VLYp5kd65kgMlofLRog8log8tJYqBth8xugrpviMtNabBxi851jc8/X6t3i8BOaK56kdB9lNFOaa5Ob8FPY5qBl9NGXJODmNOEmdNQbrpRcsJUb7RGXJSTptmUptiUp9kfFguNAAAAK3RSTlMAJCQkJDw8P0JCRUVubpaWlpmZwMDAw8nJzMzV29vb7e3t7fDw+Pn5+fn8jndhZAAAAQhJREFUeF6tz2VXwgAYBtBnhBKKkgoGKPY2urvT7u7ujn/vtsM5fN/e+w8uJEaLa+HvR7Zfl8WILo293Qq8vykQaLXtGnRoPcH6i1L1oEcLidpde6BQc6shslXvaVSHIdD7S9c0Sv5+ACbfFRXftBoYuzijUry1AXPHJ1QK5349pvYOqeSPfCaM8Dkq/EFxHAMst0mDY3cL89Clkis0kqmd/CxgvUt8Ukg8rub4UYCZicTiT0rFY5HnNY4dBNC32GiGwtFt+aLhULOx9CWMdRAMbVXK6cyNfJl0ubL8IYytEDHe0/XX7IZ82e/9S3HsZSDpmSQZT/SiQ+UgGDtU6DKYnYrGTrMBon97+TS1J80efgAAAABJRU5ErkJggg=="
},function(e,t,o){function s(e){var t=u.closestNodeBubble(e.target);if(t){var o=u.closestNodeSet(e.target);if(o){e.preventDefault(),o.focus();var s=o.__drag__={onMouseup:i.bind(this,o),onMousemove:l.throttle(n.bind(this,o)),onScroll:l.throttle(a.bind(this,o)),nodeOffsetX:e.offsetX,nodeOffsetY:e.offsetY,x:0,y:0};y=null,D=null,C=null,c.one(document,"mouseup",s.onMouseup),c.on(document,"mousemove",s.onMousemove),c.on(document,"scroll",s.onScroll)}}}function i(e,t){var o=e.__drag__;if(o){if(c.off(document,"mousemove",o.onMousemove),c.off(document,"scroll",o.onScroll),delete e.__drag__,C&&(C.parentNode&&C.parentNode.removeChild(C),C=null),D){var s=D;
D=null,s.classList.remove(m.DROPZONE),c.dispatch(s,f.DRAGLEAVE,{bubbles:!1,cancelable:!1})}y&&!function(){var e=u.closestNodeSet(t.target);if(e&&e!==y){var o=d.get(y);o.length&&(o.forEach(function(t){return e.appendChild(t)}),r.setTimeout(_,0,y,e))}var s=y;y=null,s.classList.remove(m.DRAGSTART),c.dispatch(s,f.DROP,{bubbles:!1,cancelable:!1}),c.dispatch(s,f.DRAGEND,{bubbles:!1,cancelable:!1})}()}}function n(e,t){var o=e.__drag__;if(o){if(!y){var s=r.getSelection();s&&s.removeAllRanges(),y=e,y.classList.add(m.DRAGSTART);
var i=u.closestNodeBubble(t.target),n=void 0;i&&(d.add(i),1===d.get(y).length&&(n=i.cloneNode(!0))),n||(n=b(),o.nodeOffsetX=v.w,o.nodeOffsetY=v.h),C=document.body.appendChild(document.createElement("div")),C.style.cssText="position:absolute;z-index:9999;pointer-events:none;top:0;left:0;",C.appendChild(n),c.dispatch(y,f.DRAGSTART,{bubbles:!1,cancelable:!1})}o.x=t.clientX,o.y=t.clientY,a(e);var l=u.closestNodeSet(t.target);if(l&&l!==y)D&&D!==l?(D.classList.remove(m.DROPZONE),l.classList.add(m.DROPZONE),D=l,c.dispatch(D,f.DRAGENTER,{bubbles:!1,cancelable:!1})):D||(l.classList.add(m.DROPZONE),D=l,c.dispatch(D,f.DRAGENTER,{bubbles:!1,cancelable:!1}));
else if(D){var h=D;D=null,h.classList.remove(m.DROPZONE),c.dispatch(h,f.DRAGLEAVE,{bubbles:!1,cancelable:!1})}}}function a(e){var t=e.__drag__;if(t&&C){var o=t.x-t.nodeOffsetX+c.scrollX(),s=t.y-t.nodeOffsetY+c.scrollY();h.csstransforms3d?C.style.transform="translate3d("+o+"px, "+s+"px, 0px)":h.csstransforms?C.style.transform="translate("+o+"px, "+s+"px)":(C.style.top=s+"px",C.style.left=o+"px")}}var r=o(1),c=o(12),l=o(8),d=o(4),u=o(7),h=o(18),p=o(14),m=p.CLS,f=p.EV,g=o(15),b=g.getDragImage,_=g.onDropSuccess,v=g.DRAG_IMG,y=null,D=null,C=null;
t.init=function(e){c.on(e,"mousedown",s)},t.destroy=function(e){c.off(e,"mousedown",s)}},function(e){e.exports=Modernizr},function(e,t,o){function s(e){var t=e.currentTarget;return t[T.LOCK_COPY]?I.prevent(e):(M.clear(t),void w.bubbling(t))}function i(e){var t=e.currentTarget;return t[T.LOCK_COPY]?(I.prevent(e),delete t[T.LOCK_COPY],y(function(){var e=D.getSelection();e&&e.removeAllRanges()}),!1):void S.restore(t)}function n(e){var t=e.currentTarget,o=I.keyCode(e),s=e.key?1===e.key.length:(o>47||o===E.Space||o===E.Backspace)&&o!==E.Cmd;
s&&t.fireInput()}function a(e){var t=I.keyCode(e),o=e.currentTarget;switch(t){case E.Enter:e.preventDefault(),o.options("disableControls")||u(o)||(w.bubbling(o),S.restore(o));break;case E.Space:u(o)&&e.preventDefault();break;default:var s=o.options("separator");s&&s.test(String.fromCharCode(t))&&(e.preventDefault(),w.bubbling(o),S.restore(o))}}function r(e){var t=I.keyCode(e),o=I.metaKey(e),s=e.currentTarget,i=!s.options("disableControls");switch(t){case E.Esc:e.preventDefault(),w.bubbling(s),S.restore(s);
break;case E.Backspace:e.preventDefault(),B(e);break;case E.Delete:e.preventDefault(),N(e);break;case E.Left:e.preventDefault(),c(e);break;case E.Top:if(e.preventDefault(),i){var n=C.headBubble(s);n&&M.uniq(n)}break;case E.Right:e.preventDefault(),l(e);break;case E.Bottom:e.preventDefault(),i&&M.has(s)&&S.restore(s);break;case E.a:o&&(e.preventDefault(),F.selectAll(null,e.currentTarget)||M.all(s));break;case E.c:o&&R(e);break;case E.x:o&&R(e,function(){return N(e)})}}function c(e){var t=D.getSelection();
if(!F.arrowLeft(t,e.shiftKey)){if(t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE){var o=C.prevBubble(t.anchorNode);return void(o&&M.uniq(o))}var s=e.currentTarget,i=M.get(s),n=i.length>1&&i[0]===s.startRangeSelect?i[i.length-1]:i[0],a=C.prevBubble(n);a&&(e.shiftKey?M.range(a):M.uniq(a))}}function l(e){var t=D.getSelection();if(!F.arrowRight(t,e.shiftKey)){if(t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE){var o=C.nextBubble(t.focusNode);return void(o&&M.uniq(o))}var s=e.currentTarget,i=M.get(s),n=i.length>1&&i[i.length-1]===s.startRangeSelect?i[0]:i[i.length-1],a=C.nextBubble(n);
a?e.shiftKey?M.range(a):M.uniq(a):n&&n.nextSibling&&n.nextSibling.nodeType===Node.TEXT_NODE?(M.clear(s),t.collapse(n.nextSibling,0)):S.restore(s)}}function d(e){var t=C.closestNodeSet(e.target);if(t){var o=C.closestNodeBubble(e.target);if(o){var s=Date.now(),i=t[T.CLICK_TIME]&&s-t[T.CLICK_TIME]<200;t[T.CLICK_TIME]=s,I.metaKey(e)?M.add(o):e.shiftKey?t.startRangeSelect?M.range(o):M.uniq(o):i?w.edit(t,o):M.toggleUniq(o)}else{M.clear(t);var n=D.getSelection();n&&n.anchorNode&&n.anchorNode.nodeType===Node.TEXT_NODE||S.restore(t)
}}}function u(e){var t=D.getSelection();if(!t||!t.rangeCount){var o=M.get(e);if(1===o.length)return w.edit(e,o[0])}return!1}function h(e){var t=D.getSelection();for(t&&t.removeAllRanges();this.firstChild;)this.removeChild(this.firstChild);e=F.html2text(e),this.appendChild(this.ownerDocument.createTextNode(e)),w.bubbling(this),S.restore(this)}function p(e,t){var o=w.create(this,e,t);return o&&F.text2bubble(this,o)?(this.fireInput(),this.fireChange(),S.restore(this),!0):!1}function m(e){return this.contains(e)?(this.removeChild(e),this.fireChange(),!0):!1
}function f(e){return this.contains(e)?w.edit(this,e):!1}function g(){var e=F.currentTextRange(this);return e&&F.textClean(e.toString())||""}function b(e){I.dispatch(this,A.BUBBLE_EDIT,{bubbles:!1,cancelable:!1,detail:{data:e}})}function _(){I.dispatch(this,A.CHANGE,{bubbles:!1,cancelable:!1})}function v(){var e=g.call(this);this[T.BUBBLE_VALUE]!==e&&(this[T.BUBBLE_VALUE]=e,I.dispatch(this,A.BUBBLE_INPUT,{bubbles:!1,cancelable:!1,detail:{data:e}}))}var y=o(9),D=o(1),C=o(7),w=o(5),S=o(20),M=o(4),k=o(14),E=k.KEY,A=k.EV,T=k.PROPS,F=o(6),I=o(12),x=o(8),R=o(21),V=o(22),B=o(23),N=o(24),P={blur:s,click:d,focus:i,keydown:r,keypress:a,keyup:n,mscontrolselect:I.prevent,paste:V,resize:I.prevent,resizestart:I.prevent};
t.init=function(e){var t=e;return t.setAttribute("contenteditable","true"),t.setAttribute("spellcheck","false"),t.fireChange=x.throttle(_,e),t.fireEdit=x.throttle(b,e),t.fireInput=x.throttle(v,e),I.on(t,P),{addBubble:p.bind(t),editBubble:f.bind(t),inputValue:g.bind(t),removeBubble:m.bind(t),setContent:h.bind(t)}},t.destroy=function(e){I.off(e,P)}},function(e,t,o){function s(e){r.clear(e);var t=i(e),o=n.getSelection();o.removeAllRanges(),o.collapse(t,1)}function i(e){var t=a.createZws();if(e.hasChildNodes()){var o=e.childNodes[e.childNodes.length-1];
o.isEqualNode(t)?t=o:e.appendChild(t)}else e.appendChild(t);return t}var n=o(1),a=o(6),r=o(4);t.restore=s,t.restoreBasis=i},function(e,t,o){function s(e){e&&e.parentNode&&e.parentNode.removeChild(e)}var i=o(9),n=o(12),a=o(4),r=o(14),c=r.PROPS,l=o(8);e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},o=e.target,r=l.getSelection(o);if(r)return!1;var d=a.get(o);if(!d.length)return!1;var u=o.options("bubbleCopy"),h=u(d);if(!h)return!1;o[c.LOCK_COPY]=!0;var p=o.ownerDocument.createElement("input");
return p.value=h,p.style.cssText="\n        position: absolute;\n        left: -9999px;\n        width: 1px;\n        height: 1px;\n        margin: 0;\n        padding: 0;\n        border: none;",o.parentNode.appendChild(p),n.one(p,{keyup:function(){return o.focus()},blur:function(){s(p),i(t)}}),p.select(),!0}},function(e,t,o){function s(e,t){var o=e.options("checkBubblePaste"),s=a.getSelection(),r=t&&s.isCollapsed&&!e.inputValue?o(t):!1;return l.replaceString(t,s)?(r?u?n(function(){return i(e)}):i(e):e.fireInput(),!0):!1
}function i(e){r.bubbling(e),e.focus(),n(function(){return c.restore(e)})}var n=o(9),a=o(1),r=o(5),c=o(20),l=o(6),d=o(8),u=d.isIE;e.exports=function(e){e.preventDefault();var t=e.currentTarget;a.clipboardData&&a.clipboardData.getData?s(t,a.clipboardData.getData("Text")):e.clipboardData&&!function(){var o="text/plain",i=e.clipboardData,n=i.getData&&i.getData(o);!s(t,n)&&i.items&&Array.prototype.slice.call(i.items).filter(function(e){return"string"===e.kind&&e.type===o}).some(function(e){return e.getAsString(function(e){s(t,e)
}),!0})}()}},function(e,t,o){function s(e){var t=n.get(e);if(!t.length)return!1;var o=t[0].previousSibling,s=t[t.length-1].nextSibling;return t.forEach(function(e){return e.parentNode.removeChild(e)}),c.isBubbleNode(o)?n.uniq(o):c.isBubbleNode(s)?n.uniq(s):(e.focus(),i(function(){return l.restore(e)})),e.fireChange(),!0}var i=o(9),n=o(4),a=o(6),r=o(7),c=o(5),l=o(20),d=o(8);e.exports=function(e){var t=e.target,o=d.getSelection(t);if(o)if(o.isCollapsed)if(a.arrowLeft(o,!0))a.remove(o),t.fireInput();
else{var c=r.findBubbleLeft(o);c&&n.uniq(c)}else a.remove(o),t.fireInput();else s(t)||(t.focus(),i(function(){return l.restore(t)}))}},function(e,t,o){function s(e){var t=n.get(e);if(!t.length)return!1;var o=t[0].previousSibling,s=t[t.length-1].nextSibling;return t.forEach(function(e){return e.parentNode.removeChild(e)}),c.isBubbleNode(s)?n.uniq(s):c.isBubbleNode(o)?n.uniq(o):(e.focus(),i(function(){return l.restore(e)})),e.fireChange(),!0}var i=o(9),n=o(4),a=o(6),r=o(7),c=o(5),l=o(20),d=o(8);e.exports=function(e){var t=e.target,o=d.getSelection(t);
if(o)if(o.isCollapsed)if(a.arrowRight(o,!0))a.remove(o),t.fireInput();else{var c=r.findBubbleRight(o);c&&n.uniq(c)}else a.remove(o),t.fireInput();else s(t)||(t.focus(),i(function(){return l.restore(t)}))}}]);!function(){var e=!1,t=HTMLElement.prototype.removeChild,o=HTMLElement.prototype.replaceChild,s=HTMLElement.prototype.insertBefore,i=function(e){if(1===e.nodeType&&"DIV"===e.tagName&&e.hasAttribute("data-key")){var t=ns.Model.get("quick-reply-state").existOpenQR();if(t){var o=e.querySelector("textarea[is='x-editor']");
o&&o.detachedDispatchEvent()}}};HTMLElement.xEditorOverrideNodeActions=function(){if(!e){var n=ns.Model.get("quick-reply-state").existOpenQR();n&&(t=HTMLElement.prototype.removeChild,o=HTMLElement.prototype.replaceChild,s=HTMLElement.prototype.insertBefore,HTMLElement.prototype.removeChild=function(e){return i(e),t.apply(this,arguments)},HTMLElement.prototype.replaceChild=function(e,t){return i(t),o.apply(this,arguments)},HTMLElement.prototype.insertBefore=function(e){return i(e),s.apply(this,arguments)
},e=!0)}},HTMLElement.xEditorRestoreNodeActions=function(){if(e){var i=ns.Model.get("quick-reply-state").existOpenQR();i||(HTMLElement.prototype.removeChild=t,HTMLElement.prototype.replaceChild=o,HTMLElement.prototype.insertBefore=s,e=!1)}}}(),Daria.Done.initYaShare=function(e){var t=e.url;e.partialUrl&&(t+=e.partialUrl);var o,s;"RUS"===Daria.Config.product?(o=["odnoklassniki","twitter","vkontakte","facebook"],s="ru"===Daria.Config.locale?["yaru","moimir","lj","friendfeed","gplus"]:["yaru","lj","friendfeed","gplus"]):(o=["twitter","facebook"],s=["lj","friendfeed","gplus"]),Jane.share({el:e.$container,title:e.title,description:e.description,link:e.url,icon:"//yastatic.net/mail/_/zBbiVf3dIH8Y5cRJCGEfHz4_pXc.png",size:"big",quickServices:o,popupBlocks:s,serviceSpecific:{facebook:{link:t},gplus:{link:t},odnoklassniki:{link:t},twitter:{title:(e.twitter||e.title)+" #yandexmail"}},onclick:function(t){e.metrikaCategory?Jane.c("Поделяшки на Done",e.metrikaCategory,"Клики",t):Jane.c("Поделяшки на Done","Клики",t)
},onready:function(e){function t(o,s,i){"#done"!==i&&(e&&$(e._popup).hide(),ns.events.off("ns-page-before-changed",t))}ns.events.on("ns-page-before-changed",t)}})},Daria.Done.Redirect={_timer:0,_lastTimeout:0,stop:function(){this._timer&&(clearTimeout(this._timer),this._timer=0)},start:function(e){this._timer||(this._lastTimeut=e,this._timer=setTimeout(function(){ns.events.trigger("daria:done-redirect-timeout")},e||15e3))},restart:function(e){this.stop(),this.start(e||this._lastTimeut)}},Daria.Done.Invite={isContactHidden:function(e){var t=ns.Model.get("settings").getSetting("promo-invite-emails","json")[e];
return t?Daria.now()-t>=3*Jane.Date.MONTH?!1:!0:!1},rememberContactHiddenTime:function(e){var t=ns.Model.get("settings"),o=t.getSetting("promo-invite-emails","json");o[e]=Daria.now(),t.updateSetting("promo-invite-emails",o)},openPopup:function(e){var t=new Vow.Promise;return e.inviteText=Daria.Html2Text.html2text(this._getInviteText(e.domain)),Daria.Dialog.open({body:Jane.tt("done:js-done-promo-invite-popup",e),title:"Приглашение в Яндекс.Почту",additionalClass:"b-popup_blue b-popup_invite",width:"620px",onopen:function(e){Daria.Done.Redirect.stop(),e.$body.off(".invite"),e.$body.on("click.invite",".js-add-contacts",this._onClickAddContacts.bind(this)).on("focus.invite",".js-editor",this._onFocusEditor.bind(this)).on("click.invite",".js-send-invite",this._onClickSendInvite.bind(this)),e.$body.find("form").on("submit",!1),e.$body.find(".js-editor").blur(),_.defer(function(){e.$body.find(".js-send-invite").focus()
});var o=Daria.Autocompleter.getContact();o.bindField({field:e.$body.find(".js-extra-contacts")[0]}),o.setOptions({multiple:!0,formatResult:Daria.Autocompleter.emailAutocompleterOpts.sections[0].formatResult}),t.fulfill()}.bind(this),onclose:function(){setTimeout(function(){Daria.Done.Redirect.restart()},300),t.reject("close")},oncancel:function(){t.reject("cancel")},inviteMetrika:e.inviteMetrika,email:e.mail,origin:e.origin}),t},_onClickAddContacts:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).addClass("g-hidden").closest(".b-popup__field").find(".b-form-layout").removeClass("g-hidden").find(".js-extra-contacts").focus(),ns.events.trigger("daria:done-promo-invite:add")
},_onFocusEditor:function(e){e.currentTarget.getAttribute("readonly")&&e.currentTarget.blur()},_getInviteText:function(e){if(ns.page.current.params.phonestr)return"<p>Привет!</p>  <p>Я пользуюсь Яндекс.Почтой, и она мне нравится.</p>  <p>Здесь не бывает спама, интерфейс очень простой и понятный, а сам почтовый ящик — бесконечный. Если вдруг что-то неясно — можно обратиться в службу поддержки, они отвечают быстро и подробно.</p>  <p>Перенести свои письма в Яндекс.Почту очень просто. При этом сообщать друзьям и знакомым новый адрес не придётся — письма, отправленные на старый адрес, будут автоматически приходить на новый.</p>  <p>И ещё один приятный момент: только Яндекс.Почта умеет отправлять копии писем в смс, а это очень удобно, если письмо срочное. </p>";
switch(e){case"hotmail.com":case"hotmail.com.tr":return"<p>Привет!</p>  <p>Я пользуюсь Яндекс.Почтой, и мне здесь нравится.  Здесь не бывает спама и все письма проверяются на вирусы. Почтовый ящик бесконечный, а с одним письмом можно отправлять неограниченное количество вложений, до 2 ГБ каждое.</p>  <p>Переехать в Яндекс.Почту очень просто. При этом в новый ящик скопируется весь архив писем, а сообщать друзьям и знакомым новый адрес не придётся — письма, отправленные на старый адрес, будут автоматически приходить на новый.</p>  <p>И ещё один приятный момент — в Яндекс.Почте у каждого есть как длинный адрес @yandex.ru или @yandex.com, так и короткий — @ya.ru. А вместо имени в адресе можно использовать номер мобильного (например, 79123456789@ya.ru).</p>";
case"gmail.com":return"<p>Привет!</p>  <p>Я пользуюсь Яндекс.Почтой, и мне здесь нравится.</p>  <p>Здесь не бывает спама и хорошие письма не попадают в нежелательные. Интерфейс очень простой и понятный. А если всё-таки что-то неясно — можно обратиться в службу поддержки, они отвечают быстро и подробно.</p>  <p>Почтовый ящик здесь бесконечный, задумываться об удалении писем не нужно. А с одним письмом можно отправлять неограниченное количество вложений, до 2 ГБ каждое. </p>  <p>Переехать в Яндекс.Почту очень просто. При этом в новый ящик скопируется весь архив писем, а сообщать друзьям и знакомым новый адрес не придётся — письма, отправленные на старый адрес, будут автоматически приходить на новый.</p>  <p>И ещё один приятный момент — в Яндекс.Почте у каждого есть как длинный адрес @yandex.ru или @yandex.com, так и короткий — @ya.ru. А вместо имени в адресе можно использовать номер мобильного (например, 79123456789@ya.ru).</p>";
case"mynet.com":return"<p>Привет!</p>  <p>Я пользуюсь Яндекс.Почтой, и мне здесь нравится.  Здесь не бывает спама и все письма проверяются на вирусы. Здесь не ограничен размер почтового ящика, а темы оформления можно менять хоть каждый день.</p>  <p>Переехать в Яндекс.Почту очень просто. При этом в новый ящик скопируется весь архив писем, а сообщать друзьям и знакомым новый адрес не придётся — письма, отправленные на старый адрес, будут автоматически приходить на новый.</p>  <p>И ещё один приятный момент — в Яндекс.Почте у каждого есть как обычный адрес @yandex.ru или @yandex.com, так и короткий — @ya.ru. А вместо имени в адресе можно использовать номер мобильного (например, 79123456789@ya.ru). </p>";
default:return"<p>Привет!</p> <p>Я пользуюсь Яндекс.Почтой, и мне здесь нравится. </p>   <p>Здесь не бывает спама и все письма проверяются на вирусы. Почтовый ящик бесконечный, поэтому не приходится задумываться об удалении писем. А ещё есть темы оформления — можно выбрать на свой вкус (например, космическую, пластилиновую или апельсиновую) и менять хоть каждый день.</p>   <p>Переехать в Яндекс.Почту очень просто. При этом в новый ящик скопируется весь архив писем, а сообщать друзьям и знакомым новый адрес не придётся — письма, отправленные на старый адрес, будут автоматически приходить на новый.</p>  <p>И ещё один приятный момент — в Яндекс.Почте у каждого есть как длинный адрес @yandex.ru или @yandex.com, так и короткий — @ya.ru. А вместо имени в адресе можно использовать номер мобильного (например, 79123456789@ya.ru).</p>"
}},_onClickSendInvite:function(e){e.preventDefault(),e.stopPropagation(),ns.events.trigger("daria:done-promo-invite:send");var t=Daria.Dialog.params.origin,o=Daria.Dialog.params.email||ns.page.current.params.tostr,s=o||"",i=$(e.currentTarget),n=i.data("cid"),a=i.closest(".b-popup__body").find("form"),r=a.find('input[name="to"]'),c=$.trim(r.val());c&&(s+=(o?", ":"")+c);var l=!(s&&Jane.FormValidation.checkContacts(s));if(r.closest(".b-form-layout__line").toggleClass("b-popup__field_error",l),l)return!1;
var d=a.find("textarea[name=text]"),u=Daria.Html2Text.text2html(d.val(),"p"),h="https://mail."+Daria.Config["yandex-domain"]+"/neo2/collect/?origin="+t,p=Jane.FormValidation.splitContacts(s);if(1==p.length){var m=p[0].email;h+="&login="+encodeURIComponent(m)}u+='<p><a href="'+h+'" style="background:#4d85d9; padding : 5px 10px 5px 10px; color: #fff;" >Принять приглашение</a></p>';var f=ns.Model.get("settings");ns.forcedRequest("do-send",{send:u,to:s,subj:"Приглашаю в Яндекс.Почту",from_name:f.getSetting("from_name"),from_mailbox:f.getSetting("default_email"),compose_check:ns.Model.get("account-information").getDataKey("compose-check"),ttype:"html"}).then(function(){n&&ns.forcedRequest("do-abook-invite-send",{cid:n,fromDialog:!0})
}),ns.events.trigger("daria:vDone:repaintTitleInfo","Приглашение отправлено"),Daria.Done.Redirect.restart(),Daria.Dialog.close()}},Daria.Done.PromoManager.Except=$.noop,Daria.Done.PromoManager._stopInviteDomains=["gmail.com","mail.ru","inbox.ru","bk.ru","list.ru","yandex.ru","yandex.ua","yandex.kz","yandex.by","yandex.com","mail.yandex.ru","yandex.com.tr","yandex-team.ru","ya.ru","narod.ru","yahoo.com"],Daria.Done.PromoManager._inviteDomains=["rambler.ru","ro.ru","autorambler.ru","lenta.ru","myrambler.ru","e1.ru","ngs.ru","eml.ru","mosk.ru","74.ru","chelyabinsk.ru","chel.ru","domchel.ru","autochel.ru","chelfin.ru","mychel.ru","2074.ru","cheldiplom.ru","mail15.com","nm.ru","pochta.ru","hotbox.ru","fromru.com","front.ru","hotmail.ru","krovatka.su","land.ru","mail333.com","nightmail.ru","pisem.net","pochtamt.ru","pop3.ru","rbcmail.ru","smtp.ru","qip.ru","newmail.ru","5ballov.ru","aeterna.ru","ziza.ru","memori.ru","photofile.ru","fotoplenka.ru","gmail.com","km.ru","bossmail.ru","girlmail.ru","boymail.ru","freemail.ru","megabox.ru","safebox.ru","ua.fm","rol.ru","infobox.ru","hotmail.com","hotmail.com.tr","yahoo.com.tr","yahoo.com","mynet.com","live.ru","live.com","tut.by","meta.ua","i.ua","ua.fm","email.ua","3g.ua","mail.ua","a.ua","ukrpost.net","online.ua","ukr.net","bigmir.net"],Daria.Done.PromoManager._promo=[ns.View.info("done-promo-mobile-app").checkShowPromo,ns.View.info("done-promo-hotkeys").checkShowPromo],Daria.Done.PromoManager.checkPromoInvite=function(e){if(e.dontInvite)return!1;
if(e.invite)return!1;var t=Jane.FormValidation.splitContacts(e.tostr||"");if(!t.length)return!1;var o=t[0].email;if(!o)return!1;var s=o.split("@");return s.length<2?!1:(s=(s[1]||"").toLowerCase(),-1===this._inviteDomains.indexOf(s)?!1:(this.setParams({inviteEmail:o}),"done-promo-invite"))},Daria.Done.PromoManager.checkPromo=function(e){var t,o=$.extend({},e,this._params);try{for(var s=0,i=this._promo.length;i>s&&!(t=this._promo[s](o));s++);}catch(n){if(!(n instanceof Daria.Done.PromoManager.Except))throw n
}return t?(e.donePromo=t,t):!1},Daria.Done.PromoManager.next=function(e){this.setParams(e||{}),ns.page.go(!1,!0)}});