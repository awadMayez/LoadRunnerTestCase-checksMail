Jane.module("jane.promo.js",function(){"use strict";function e(e,t,n){var i=t+e.share.link;return n?i:i+"&lang="+Daria.Config.locale}Daria.promo={},Daria.promo.getShareParams=function(t){var n=ns.Model.get("settings-color-schemes").getSchemeById(t);if(n){var i=Daria.Config["yandex-domain"].replace("-team",""),o="http://mail."+i+"/";return{title:n.share.title,description:n.share.description,link:e(n,o),twitterText:n.share.twitter,twitterLink:n.share.twitterLink,icon:Daria.Config.staticPath+"/themes_new/nice/"+n.id+"/images/"+n.share.image}
}},Daria.promo.getShareQuickServices=function(){var e="RUS"===Daria.Config.product;return e?["odnoklassniki","twitter","vkontakte","facebook"]:null},Daria.promo.getSharePopupBlocks=function(){var e="RUS"===Daria.Config.product;return e?["yaru","moimir","lj","friendfeed","gplus"]:null},Daria.bindDataAttrEvents=function(e){function t(e){return e+s}e=e||{};var n=e.$node,i=e.handlersSource,o=e.selector,s=e.eventNamespace;if(_.isUndefined(n)&&_.isUndefined(i))throw new Error("bindDataAttrEvents takes at least 2 arguments");
if(!(n instanceof jQuery))throw new Error("bindDataAttrEvents: parameter `$node` is required and must be a Jquery instance");if(!_.isObject(i))throw new Error("bindDataAttrEvents: parameter `handlersSource` is required and must be an object");o=(o?o:"")+"[data-event]",s=s?s:".dataevent",0!==s.indexOf(".")&&(s="."+s);var r=[];n.find(o).each(function(){var e=$(this),t=[];e.data("event").split(/\s*,\s*/).forEach(function(e){if(e=e.split("."),2!==e.length)throw new Error("bindDataAttrEvents: invalid `data-event` attribute, must be in `<eventType>.<handlerName>` format");
var n=e[0],o=e[1];if(!_.isFunction(i[o]))throw new ReferenceError("bindDataAttrEvents: no method `"+o+"` found");t.push({type:n,handlerName:o})}),e.data("event",t),r=r.concat(t)});var a=_(r).pluck("type").uniq().map(t).values().join(" ");n.on(a,o,function(e){var t=_.find($(this).data("event"),{type:e.type}).handlerName;i[t].call(i,e)}),Daria.getEmailDomain=function(e){return _.last(Daria.splitEmail(e))}},function(){var e="ranks",t="actions",n=e+"."+t;Daria.Ranks={},Daria.Ranks._saveActionsInSettings=function(e){ns.Model.get("settings").updateSetting(n,e)
},Daria.Ranks.saveAction=function(e){var t={};t[e]=Daria.now(),Daria.Ranks._saveActionsInSettings(t)},Daria.Ranks.saveActions=function(e){if(!_.isEmpty(e)){var t=Daria.now(),n=_.reduce(e,function(e,n){return e[n]=t,e},{});Daria.Ranks._saveActionsInSettings(n)}},Daria.Ranks.getSavedActions=function(){return jpath(ns.Model.get("settings").getSetting(e,"json"),"."+t)[0]||{}}}(),function(e,t,n){var i=t.timify;t.phoneValidation={$root:null,$domNodes:null,delay:i({seconds:5}),tries:0,currentStep:0,visible:!1,revalidateCounter:0,build:function(i,o){var s=this.$root;
this.modification=o;var r=ns.Model.get("userphones");if(r.getData()&&(i=r.getUnconfirmedNumber()||ns.Model.get("phone-register").getNumber()),i&&(this.phoneNumber=i),this.tries=3,s)return this;var a=2;this.variant=a,s=this.$root=e(n.tt("promo:phone",{number:i,variant:a,modification:o})),this.afterCreate(),this.getUserPhones(function(){var n;this.init();var i=e("[role=alert]");return t.is3pane()?(e(".b-page").first().prepend(s),n=e(".b-page__content"),this.onAnimate=function(e){n.css("top",e)},void function(e){var t=e.hide;
e.hide=function(){t.apply(e,arguments),n.css("top",0)}}(this)):void(i.length?i.after(s):e("body").prepend(s))})},afterCreate:function(){this.$domNodes=this.$root.find(".b-intruder__i"),this.visible=!0,this.bindEvents()},bindEvents:function(){var t=this.$root,i=t.find(".js-step-6"),o=this,s=t.find("[name=number]"),r=nb.block(i.find(".js-phone-register")[0]);this.onClick=this.onClick.bind(this),s.on("click",this.onClick),this.onKeyUp=this.onKeyUp.bind(this),s.on("keyup",this.onKeyUp),t.on("click",".js-getAppLink",function(){n.c(o.metrika('Клик по "получить смс"'))
}).on("click",".js-phone-register",function(){return 2===o.currentStep?void n.c(o.metrika('Клик по "да, это мой номер"')):void n.c(o.metrika("Клик по привязать"))}).on("click",".js-phone-confirm",function(){n.c(o.metrika("Клик по отправить"))}).on("click",".js-phone-revalidate",function(){n.c(o.metrika("Клики по запросить код повторно"))}).on("click","[data-click-action='phone.faq']",function(){n.c(o.metrika("Клик по вопросику"))}),ns.events.on("phone-registered-failure",function(e,t,n,i,s){return/(TEMPORARYBLOCK|NUMEXISTS)/.test(t)&&6===o.currentStep?(ns.events.trigger("phone-enable-buttons"),ns.action.run("phone.revalidate",n,i,s),void o.step7()):"NUMEXISTS"===t&&o.tries?(ns.events.trigger("phone-revalidate"),ns.action.run("phone.revalidate",n,i,s),void(o.tries-=1)):void ns.events.trigger("phone-enable-buttons")
}),ns.events.on("phone.link-sent-failure",function(e,t){ns.events.trigger("phone-enable-buttons"),o.showError(t)}),ns.events.on("phone-confirmed-failure",this.onConfirmFailure.bind(this)),ns.events.on("phone-registered-failure",this.onRevalidateFailure.bind(this)),ns.events.on("phone-disable-buttons",function(){t.find(".b-round-button").addClass("b-mail-button_disabled")}),ns.events.on("phone-enable-buttons",function(){t.find(".b-round-button").removeClass("b-mail-button_disabled")}),ns.events.on("phone-disable-buttons-step-6",function(){r.disable()
}),ns.events.on("phone-enable-buttons-step-6",function(){r.enable()}),ns.events.on("phone-registered-success",e.proxy(function(e,t,n){var i=n?n.number:"",o=this.currentStep;return ns.events.trigger("phone-enable-buttons"),i&&this.setNumber(i),3===o||7===o?void this.runRevalidateTimer():(this.revalidateCounter=0,2===o?void this.step3():void this.step7())},this)),ns.events.on("phone-confirmed-success",e.proxy(function(){return 3===this.currentStep?void this.step4():void this.step8()},this)),ns.events.on("phone-revalidate",e.proxy(function(){return ns.events.trigger("phone-enable-buttons"),3!==this.currentStep||7!==this.currentStep?this.currentStep>5?void this.step7():void this.step3():void 0
},this)),ns.events.on("phone-close",e.proxy(function(){n.c(this.metrika("Клик по крестику")),this.close()},this)),ns.events.on("phone-goBack",e.proxy(function(){n.c(this.metrika("Клик по назад")),this.showStep(this.currentStep-1)},this)),ns.events.on("phone.linkSent",e.proxy(function(e,n){t.addClass("b-intruder_phone-confirm-short"),this.setNumber(n.number)},this))},unbindEvents:function(){var t=this.$root;e.each(["phone-registered-failure","phone.link-sent-failure","phone-confirmed-failure","phone-registered-failure","phone-disable-buttons","phone-enable-buttons","phone-registered-success","phone-confirmed-success","phone-revalidate","phone-close","phone-goBack","phone.linkSent"],function(e,t){ns.events.off(t)
}),e.each([".js-getAppLink",".js-phone-register",".js-phone-confirm",".js-phone-revalidate","[data-click-action='phone.faq']"],function(e,n){t.off("click",n)}),t.find("[name=number]").off()},onKeyUp:function(t){var n=e(t.target),i=48,o=57,s=i<=t.which&&t.which<=o;if(s&&n.val(this.formatPhoneNumber(n.val())),n.hasClass("js-step-6-input")){var r=n.val();ns.events.trigger(r?"phone-enable-buttons-step-6":"phone-disable-buttons-step-6")}},formatPhoneNumber:function(t){var n=/^(?:\+7|8)(?:\s\d{3}(?:\s\d{3}(?:\s\d{2})?)?)?$/;
return t.match(n)&&(t=e.trim(t)+" "),t},onClick:function(n){var i=e(n.target),o=i.val();t.Validator.predictInput(i),o||(i.val(this.formatPhoneNumber(i.val())),t.Validator.moveCaretToEnd(i),i.hasClass("js-step-6-input")&&ns.events.trigger("phone-enable-buttons-step-6"))},getUserPhones:function(t){t=t||e.noop,this.phoneNumber?(this.setNumber(this.phoneNumber),t.call(this)):ns.request("userphones",{}).then(function(){var e=ns.Model.get("userphones").getUnconfirmedNumber();e&&this.setNumber(e),t.call(this)
}.bind(this))},renamePromoData:function(e){return _.transform(e,function(e,t,n){var i={"phone-confirm":"phone_confirm","phone-confirm-date":"date"};e[i[n]||n]=t})},getPromoData:function(e,t){var n,i=ns.Model.get("settings");"no-hint"===this.modification||"no-hint"===t?(n=i.getSetting("validation-no-hint","json")||{},n=this.renamePromoData(n)):n={phone_confirm:i.getSetting("phone-confirm"),date:i.getSetting("phone-confirm-date"),myp_show:i.getSetting("myp_show"),show_count:i.getSetting("show_count"),step_number:i.getSetting("step_number")};
var o={phone_confirm:!1,date:0,myp_show:!1,show_count:0,step_number:0};return n=_.defaults(n,o),n.date=parseInt(n.date,10),n.show_count=parseInt(n.show_count,10),n.step_number=parseInt(n.step_number,10),e?n[e]:n},savePromoData:function(e,t){var n=ns.Model.get("settings");return"no-hint"===this.modification||"no-hint"===t?n.updateSetting("validation-no-hint",e):void n.setSettings(e)},clearPromoData:function(e){var t=ns.Model.get("settings");t.setSettings("no-hint"===e?{"validation-no-hint":{}}:{"phone-confirm-date":"","phone-confirm":"",myp_show:"",show_count:"",step_number:""})
},isDowntimeExpire:function(e,n,o){if(0===n)return!0;var s=[14,14,90,180];"no-hint"===o&&(s=[90]);var r=_.map(s,function(e){return i({days:e})}),a=r[e]||_.last(r);return t.now()-n>a},check:function(t,n){var i=e.Deferred(),o=this,s=function(){var e;return ns.Model.get("userphones").hasActiveNumber()?(o.savePromoData({"phone-confirm":!1}),i.reject(),!1):(e=o.getPromoData(null,n),e.phone_confirm||o.isDowntimeExpire(e.show_count,e.date,n)?(i.resolve(),!0):(i.reject(),!1))};return t?s():(this.getUserPhones(s),i.promise())
},getLastUsageTime:function(){return this.getPromoData("date")},isClosedByUser:function(){var e=this.getPromoData();return e.date&&!e.phone_confirm},init:function(){var e=this.getPromoData();e.phone_confirm?3!==e.step_number&&7!==e.step_number||!this.phoneNumber?this.step6():this.step7():e.date?(this.savePromoData({show_count:e.show_count+1}),this.getUserPhones(function(){3===e.step_number||7===e.step_number?this.step7():this.step6()})):(this.savePromoData({show_count:e.show_count+1}),this.getUserPhones(function(){this.step6()
}))},step1:function(){var e=this,t=this.promoData("show_count"),n=function(){return e.savePromoData({myp_show:!0}),ns.events.off("phone.linkSent",n),ns.Model.get("account-information").hasSid("36")?void e.step5():(e.savePromoData({show_count:t+1}),void e.step2())};t=parseInt(t,10),ns.events.on("phone.linkSent",n),this.showStep(1)},step2:function(){return ns.Model.get("account-information").hasSid("36")?void this.step5():(this.savePromoData({"phone-confirm-date":t.now(),"phone-confirm":!0,step_number:2}),void this.showStep(2))
},step3:function(){this.savePromoData({step_number:3}),this.runRevalidateTimer(),this.showStep(3)},step4:function(){this.savePromoData({"phone-confirm":!1}),this.closeTimer=setTimeout(e.proxy(function(){this.close()},this),i({minutes:5})),this.showStep(4)},step5:function(){this.savePromoData({"phone-confirm":!1}),this.closeTimer=setTimeout(e.proxy(function(){this.close()},this),i({minutes:5})),this.showStep(5)},step6:function(){this.savePromoData({"phone-confirm-date":t.now(),"phone-confirm":!0,step_number:6}),this.showStep(6)
},step7:function(e){this.savePromoData({"phone-confirm":!0,step_number:7}),e||this.runRevalidateTimer(),this.showStep(7)},step8:function(){this.savePromoData({"phone-confirm":!1,step_number:8}),ns.events.on("phone.linkSent",function(){this.close()}.bind(this)),this.closeTimer=setTimeout(e.proxy(function(){this.close()},this),i({minutes:5})),this.showStep(8)},showStep:function(e){7===e&&n.Promo.setFirstStartSettingOff("phone-validation");var i=this.$domNodes,o=i.filter(":visible"),s=this.$root,r=i.eq(e-1),a=this;
this.currentStep=e||0,s.css("display","").css("height","0"),this.hideError(),o.addClass("g-hidden"),r.css("position","absolute"),r.css("visibility","hidden"),r.removeClass("g-hidden"),t.setZeroTimeout(function(){var e=r.outerHeight();ns.events.trigger("toolbar-reset-offset"),r.addClass("g-hidden"),r.css("position",""),r.css("visibility",""),s.animate({height:e},{duration:300,step:a.onAnimate,complete:function(){a.visible||a.bindEvents(),a.hideError(),r.fadeIn().removeClass("g-hidden"),a.visible=!0,ns.events.trigger("toolbar-reset-offset")
}})}),n.c(this.metrika("показы"))},setNumber:function(e){var t;this.phoneNumber=e,e&&this.$root&&(t=ns.Model.get("phone-register").getFormattedNumber(e),this.$root.find("[name=number]").val(t),this.$root.find(".b-intruder__phone").html(t),this.$root.find('[data-click-action="phone.getAppLink"]').attr("data-params","phone_full="+e),this.$root.find('[data-click-action="phone.revalidate"]').attr("data-params","number="+e))},tickTimer:function(e){var t=e,n=this;this.revalidateTimerInterval&&(clearInterval(this.revalidateTimerInterval),this.$root.find(".b-intruder__timer").html("")),this.revalidateTimerInterval=setInterval(function(){t-=1e3;
var e=t/36e5,i=t/6e4,o=t/1e3,s="";e-=e%1,i=i-i%1-60*e,o=o-o%1-60*i,o-=3600*e,e&&(s+=e+":"),10>o&&(o="0"+o),s+=i+":",s+=o,n.$root.find(".b-intruder__timer").html(s),t||clearInterval(n.revalidateTimerInterval)},1e3)},runRevalidateTimer:function(){var t;return this.revalidateLinkToggle(0),this.currentStep?(t=this.getRevalidateTimeout(),this.tickTimer(t),void(this.revalidateTimeout=setTimeout(e.proxy(function(){(3===this.currentStep||7===this.currentStep)&&(this.hideError(),this.revalidateLinkToggle(1))
},this),t))):void this.revalidateLinkToggle(1)},showError:function(e,t){var i,o=this;t=t||"register",i=ns.Model.get("phone-"+t).parseError(e.status,e.left),this.$root.find(".b-notification_error").html(i).end().addClass("b-intruder_phone-confirm_error").find("[name=number]").one("focus",function(){o.hideError()}),n.c(o.metrika("Показ ошибок"))},onAnimate:null,onConfirmFailure:function(e,t,n){ns.events.trigger("phone-enable-buttons"),this.showError({status:t,left:n},"confirm")},onRevalidateFailure:function(e,t){ns.events.trigger("phone-enable-buttons"),this.showError({status:t},"register")
},hideError:function(){this.$root.removeClass("b-intruder_phone-confirm_error").find(".b-notification_error").html("")},isLessThenOneWeekAfterShow:function(){var e=this.getPromoData("phone-confirm-date","no-hint");return t.now()-e<t.timify({weeks:1})},motivationMetrika:function(e){var t="Валидация (контрольный вопрос)",i=[t,"Мотивация"];n.c(i.concat(e))},metrika:function(e){var t,i,o,s=this.getPromoData("show_count")||1,r="no-hint"===this.modification?"Валидация (контрольный вопрос)":"МЯП->Валидация";
return t=[r,"Показ "+s,"шаг "+this.currentStep],this.variant&&(i=Number(this.variant),o="Вариант "+i,3===i&&(o+=" (новый)"),t.splice(1,0,o)),e&&(t=t.concat(e)),n.ErrorLog.send({event:"phone-metrika",data:t.join(" | ")}),t},revalidateLinkToggle:function(e){this.hideError(),e?(this.$root.addClass("b-intruder_phone-confirm_revalidate"),this.$root.find(".js-timer").addClass("g-hidden")):(this.$root.removeClass("b-intruder_phone-confirm_revalidate"),this.$root.find(".js-timer").removeClass("g-hidden"))
},getRevalidateTimeout:function(){var e=this.revalidateCounter;return this.revalidateCounter+=1,[i({minutes:3}),i({minutes:10}),i({hours:24})][e]||i({hours:24})},close:function(){n.Promo.setFirstStartSettingOff("phone-validation"),this.savePromoData({"phone-confirm-date":t.now(),"phone-confirm":!1}),1===this.currentStep&&this.savePromoData({myp_show:!0}),this.hide(function(){this.destroy()}.bind(this))},hide:function(e){this.unbindEvents(),this.visible=!1,this.$root.delay(200).slideUp(e)},destroy:function(){clearTimeout(this.revalidateTimeout),clearTimeout(this.closeTimer),clearInterval(this.revalidateTimerInterval),this.visible=!1,this.$root&&(this.$root.remove(),delete this.$root),ns.events.trigger("toolbar-reset-offset")
}},ns.events.on("ns-page-after-load",function(){var i=t.phoneValidation,o=ns.page.current.page,s=i.$root,r=["compose","done"];if(e.inArray(o,r)>-1)return void(s&&s.is(":visible")&&(s.css("display","none"),i.hide()));if(i.currentStep&&s&&!s.is(":visible"))return void i.showStep(i.currentStep);var a,c=n.Promo._queue&&n.Promo._queue[0];c&&"phone-validation"===c.name&&(a=c.check(),a&&a.done(c.callback))})}(jQuery,Daria,Jane),Jane.Promo={_queue:[],_promos:[],promo:{},defaults:{alwaysShow:!1,showOnlyOnce:!1,bubble:!0,width:420,target:{x:0,y:0,side:"top",pos:"center"},correct3pane:{x:0,y:0},additionalClass:"",paranjaFade:!1,noPosition:!1,delayBeforeShow:0,share:{el:$('<div class="b-teaser b-teaser_share">').appendTo(".b-service-tabs__share")[0],quickServices:"RUS"===Daria.Config.product?["odnoklassniki","twitter","vkontakte","facebook"]:["twitter","facebook"],popupBlocks:"RUS"===Daria.Config.product?["yaru","moimir","lj","friendfeed","gplus"]:["lj","friendfeed","gplus"],onclick:function(e){$(this.params.share.el).addClass("b-teaser_fade"),ns.Model.get("settings").setSettingOn(this.shareSetting),this.params.metrika.sharecustom.onclick?this.params.metrika.sharecustom.onclick(e):this.log(e,!0)
},onready:function(){var e=this,t=ns.Model.get("settings");$(this.params.share.el).append('<div class="b-teaser_share_close ns-action" data-click-action="common.close-share">×</div>'),"on"!=t.getSetting(this.shareSetting)&&Daria.minifyMode.isDisabled()&&setTimeout(function(){ns.action.run("common.show-share-popup",{onCancel:function(){t.setSettingOn(e.shareSetting)}}),t.setSettingOn(e.shareSetting)},18e4),this.params.metrika.sharecustom.onready&&this.params.metrika.sharecustom.onready()}},metrika:{bubble:"Баббл",onopen:"Показ",oncancel:"Закрытие",share:"Поделяшка",sharecustom:{}},onopen:$.noop,oncancel:$.noop,onclose:$.noop,buttons:[{title:"Ok"}],_presets:{settings:{"2pane":[".header-settings",{x:12,y:6,pos:"right"}],"2paneM":[".header-settings",{x:12,y:5,pos:"right"}],"3pane":[".b-link_setup",{x:12,y:20,pos:"right"}]},themes:{"2pane":[".promo-themes",{x:12,y:6,pos:"right"}],"2paneM":[".promo-themes",{x:12,y:5,pos:"right"}],"3pane":[".b-link_setup",{x:12,y:20,pos:"right"}]},compose:{"2pane":[".b-toolbar__item_compose",{x:7,y:8,pos:"center"}],"2paneM":[".b-toolbar__item_compose",{x:7,y:8,pos:"center"}],"3pane":[".b-toolbar__item_compose",{x:40,y:10,pos:"center"}]}}},_shareLauncher:function(){if(this.promo.name){this.shareSetting=this.promo.name.slice(0,18)+"_f";
var e=this.params.share;e.onready=e.onready.bind(this),e.onclick=e.onclick.bind(this),("on"==ns.Model.get("settings").getSetting(this.shareSetting)||"yes"==ns.Model.get("settings").getSetting(this.shareSetting))&&$(e.el).addClass("b-teaser_fade"),Jane.share(e)}},log:function(e,t){var n=this.params.metrika,i=[];i.push(n.bubble,this.promo.name),t&&i.push(n.share),i.push(e),Jane.c(i)},callback:function(e){var t=this.params=$.extend(!0,{},this.defaults,e),n=this;t.targetNode&&"nonode"!=t.targetNode&&this._targetCorrect(),t.bubble?(t.targetNode&&"nonode"!=t.targetNode&&$(window).on("resize",function(){n._onResize.call(n)
}),this.dialogOpen(e)):!e.share||$.isEmptyObject(e.share)||t.bubble||this._shareLauncher(),t.onopen.call(this)},_makeBody:function(){var e=this.params.body;return"object"==typeof e?Jane.tt("promo:promo-default",e):e},dialogOpen:function(e){var t=this,n=this.params,i=n.metrika,o=ns.Model.get("settings"),s=t.target;"nonode"===n.targetNode&&(s=n.paranjaFade?"":{x:"",y:"",side:"",pos:""});for(var r=0;r<n.buttons.length;r++)n.buttons[r].promo=!0;this.dialog=Daria.Dialog.open({width:n.width,body:t._makeBody(),onTarget:s||"",additionalClass:n.additionalClass,paranjaFade:n.paranjaFade,noPosition:n.noPosition,oncancel:function(){n.oncancel.call(t)
},onclose:function(){n.onclose.call(t),t.log(i.oncancel),n.targetNode&&"nonode"!==n.targetNode&&$(window).off("resize",t._onResize)},onopen:function(){t.log(i.onopen),n.alwaysShow||o.setSettingOn(t.shownSetting),e.share&&!$.isEmptyObject(e.share)&&t._shareLauncher.call(t,n)},buttons:n.buttons})},_targetCorrect:function(){var e=this.params,t=e.targetNode,n=Daria.is3pane();e.correct3pane.side=e.correct3pane.side||e.target.side,e.correct3pane.pos=e.correct3pane.pos||e.target.pos;var i,o;if(e._presets[t]){var s="2pane";
!n&&Daria.minifyMode.isEnabled()?s="2paneM":n&&(s="3pane");var r=e._presets[t][s];i=$(r[0]),o=i.offset();var a=r[1];this.target={x:o.left+i.width()/2+a.x,y:o.top+i.height()+a.y,side:"top",pos:a.pos}}else{i=$("string"==typeof t?t:e.targetNode.for2pane);var c=e.target;if(Daria.minifyMode.isEnabled()&&e.targetNode.for2paneMin?i=$(e.targetNode.for2paneMin):n&&e.targetNode.for3pane&&(i=$(e.targetNode.for3pane)),o=i.offset(),this.target={x:o.left+i.width()/2+c.x,y:o.top+c.y,side:c.side,pos:c.pos},Daria.is3pane()){var d=e.correct3pane;
this.target.x+=d.x-c.x,this.target.y+=d.y-c.y,d.side&&(this.target.side=d.side),d.pos&&(this.target.pos=d.pos)}"top"==this.target.side&&(this.target.y+=i.height())}e.selectedNode=i},_onResize:function(){var e=this.params,t={left:32,right:e.width-18,center:e.width/2},n=Daria.is3pane()?"correct3pane":"target",i={left:e.selectedNode.offset().left-t[this.target.pos]+e.selectedNode.width()/2+e[n].x};"bottom"==this.target.side&&(i.top=e.selectedNode.offset().top-this.dialog.$dialog.height()+e[n].y),this.dialog.$dialog.offset(i)
},_callbackLauncher:function(e){this.promo.name=e.name;try{e.options?this.callback(e.options):e.callback(),this.setSettingsAfterSuccessRun(e)}catch(t){Jane.ErrorLog.sendException("promo-error."+e.name,t)}},setSettingsAfterSuccessRun:function(e){var t=e.params,n=ns.Model.get("settings");t.autoclosing&&this._setFirstTimeShow(e.name,t.autoclosing),t.showOnlyOnce&&n.setSettingOn(this.shownSetting),t.notAffectPromoDelay||n.updateSetting("promo-manager",{"last-time-show-promo":Daria.now(),"last-promo-was-name":e.name})
},_setFirstTimeShow:function(e,t){Daria.now()-this.getFirstStartSetting(e)>t&&ns.Model.get("settings").updateSetting(e,{firstStart:Daria.now()})},checkAutoClosing:function(e,t){var n=this.getFirstStartSetting(e);return n&&Daria.now()-n>t?!0:!1},setFirstStartSettingOff:function(e){ns.Model.get("settings").updateSetting(e,{firstStart:0})},getForceShowPromo:function(){var e=this.findPromo(Daria.urlParams.promo);if(!e)return null;if(_.isFunction(e.mandatoryCheck)){var t=e.mandatoryCheck();if(t===!0)return e;
if(t.then)throw new Error("mandatoryCheckResult must return Boolean");return null}return e},run:function(e){var t=this.getForceShowPromo();if(t)return void this._callbackLauncher(t);e&&(this._queue=$.merge(this._queue,$.map(this._promos,function(e){return"priority"in e?e:void 0})).sort(function(e,t){return e.priority-t.priority}));for(var n=ns.Model.get("settings"),i=0,o=this._promos.length;o>i;i++)if(this._promos[i].name===Daria.themeId&&this._promos[i].check()===!0&&"on"!=n.getSetting(this._promos[i].name.slice(0,18)+"_x")&&"yes"!=n.getSetting(this._promos[i].name.slice(0,18)+"_x")&&!Daria.IS_CORP){this._callbackLauncher(this._promos[i]);
break}for(var s=this,r=!1,a=function(e){var t=e.params,i=n.getSetting("promo-manager","json")||{},o=i["last-time-show-promo"]||0,r=i["last-promo-was-name"]||"",a=Daria.now()-Number(o)>7*Jane.Date.DAY,c=t.ignoreStartPromoDelay||Daria.getAccountAgeInDays()>10;return(t.ignorePromoDelay||r===e.name)&&(a=!0),t.autoclosing&&s.checkAutoClosing(e.name,t.autoclosing)?(s.setFirstStartSettingOff(e.name),_.isFunction(e.closePromo)&&e.closePromo(),!1):s.checkCommonPromoRules(e)&&a&&c&&!n.getSetting(s.shownSetting)&&e.check()
},c=function(){s._queue.shift(),s.run()},d=function(e){return function(){r=!0,s._callbackLauncher(e)}};this._queue[0]&&!r;){var l;for(i=0,o=this._promos.length;o>i;i++)if(this._queue[0].name===this._promos[i].name){l=this._promos[i];break}this.shownSetting=l.name.slice(0,18)+"_s";var h=a(l);if(h===!0)return void this._callbackLauncher(l);if(h&&_.isFunction(h.then))return void h.then(d(l),c);this._queue.shift()}},checkCommonPromoRules:function(e){var t=e.params,n=ns.Model.get("settings-color-schemes").getSchemeById(Daria.themeId),i=!Jane.Config.allowThemes,o=Boolean(n&&n["new"]),s=n?i||o:!0;
return"themesBubble"===t.type&&s?!1:!(!t.ignoreInboxMessages&&!Jane.Promo.has("hasInboxMessages")||!t.ignoreShowPromoSetting&&ns.Model.get("settings").getSetting("disable_promo")||!t.ignoreKCUFfilter&&Daria.IS_KCUF||!t.ignoreCORPfilter&&Daria.IS_CORP||"messages"!==ns.page.current.page&&"message"!==ns.page.current.page)},getFirstStartSetting:function(e){var t=ns.Model.get("settings").getSetting(e,"json")||{};return t.firstStart||0},showPromo:function(e){var t=this.findPromo(e);t&&this._callbackLauncher(t)
},findPromo:function(e){return e?_.find(this._promos,{name:e})||null:null},add:function(e){e.params=e.params||{},this._promos.push(e)},removeAllPromos:function(){this._promos=[],this._queue=[]}},function(e,t,n){var i=null,o=function(t){return i[t]=$.isFunction(i[t])?i[t](e):i[t],i[t]};i=o.cache={},o.add=function(e,t,s,r){return(i[e]===n||r)&&(i[e]=t),s&&o(e)},t.has=o}(this,Jane.Promo),Jane.Promo.has.add("hasInboxMessages",function(){return Daria.messages.everHadMessages()}),Jane.Promo.has.add("promo-suggest",function(){var e=Daria.uid.slice(-2),t=ns.Model.get("account-information").hasSid("669");
return"26"===e||t}),Jane.Promo.has.add("promo-suggest-2",function(){var e=Daria.uid.slice(-2);return"22"===e}),function(){var e=Daria.Validator={};e._namespace="validator",e._hMethods={},e.assert=function(t,n,i){var o=e._namespace;Daria.assert.call(Daria,t,n,o,i)};var t=e.assert;e._getHandlerMethodLazy=function(e,t){return function(){var n=ns.Model.get(e),i=n[t];return i.apply(n,Array.prototype.slice.call(arguments))}},e._inject=function(e,n,i){return t(!this._hMethods[e],"This method already exists"),this._hMethods[e]=this._getHandlerMethodLazy(n,i),this
},e.getUserPhones=function(t){var n=e._UserPhones,i=this._hMethods.getAllPhones(t),o=function(e){return new n(e[0].select(".phone"))};return i.then(o)},e.getLocalPhoneInfo=function(e,t){var n={7:{country:"Russia",code:"7",placeholder:"7 ххх ххх хх хх"},380:{country:"Ukraine",code:"+380",placeholder:"+380 хх ххх хх хх"},90:{country:"Turkey",code:"90",placeholder:"90 ххх ххх х ххх"},1:{country:"USA",code:"1",placeholder:"1 ххх ххх хххх"},other:{country:"All other world!",code:"+7",placeholder:"+7 ххх ххх хх хх"}},i=n[e]||n.other;
return t?i[t]:i},e.predictInput=function(e,t){t=t||e.attr.bind(e,"placeholder");var n=e.val();if(""===n){if(!e)throw new Error("Argument $inputNumber must be a present");if(!_.isFunction(t))throw new Error("Argument getPredict must be a function");var i=t();e.val(i)}},e.moveCaretToEnd=function(e){var t=e.get(0),n=t.value.length;if(document.selection){t.focus();var i=document.selection.createRange();i.moveStart("character",-n),i.moveStart("character",n),i.moveEnd("character",0),i.select()}else(t.selectionStart||"0"==t.selectionStart)&&(t.selectionStart=n,t.selectionEnd=n,t.focus())
},e._inject("getAllPhones","userphones","getAll"),e._inject("register","phone-register","register"),e._inject("resendCode","phone-register","resendCode"),e._inject("confirm","phone-confirm","confirm"),e._inject("prolong","phone-prolong","prolong"),e._inject("remove","phone-delete","remove")}(),function(e,t,n){var i,o,s,r,a=n.assert;n._UserPhone=function(e){a(e,"UserPhone constructor: parameter phoneData is undefined"),this._phoneData=e,this._errors=[]},i=n._UserPhone,o=i.prototype,s=n._hMethods,r=n._getHandlerMethodLazy,o.get=function(e){return void 0===this._phoneData[e]&&a(!1,"phone doesn't have property "+e),this._phoneData[e]
},o.isSecure=function(){return this.get("secure")},o.isSimple=function(){return!this.isSecure()},o.isValid=function(){return"valid"===this.get("valid")},o.isRegistered=function(){return!this.isValid()},o.getValidationTimestamp=function(){return a(this.isValid(),"Validation timestamp for registered phone is unconsistent"),this.get("validation_date")},o.getRegistrationTimestamp=function(){return a(this.isRegistered(),"Validation timestamp for registered phone is unconsistent"),this.get("validation_date")
},o.getNumber=function(){return this.get("number")},o.confirm=function(e,t){a(this.isRegistered(),"Phone must be registered"),a(this.isSecure()&&t,"Parameter password for secure phone is compulsory");var n=this,i=this.getNumber(),o=s.confirm(i,e,t),r=function(e){return n._reset(e),n._trigger("confirm",n),n},c=function(e){return n._fail(e,"confirm-fail"),e};return o.then(r,c)},o.resendCode=function(){var e,t=this;e=s.resendCode(this.getNumber());var n=function(e){return t._reset(e),t._trigger("resend-code",t),t
},i=function(e){return t._fail(e,function(e){return"TEMPORARYBLOCK"===e.errorcode?"resend-code-block":"resend-code-fail"}),e};return e.then(n,i)},o.getResendCodeTimeout=function(){var e=this.get("next_validation");if(!e)return null;var n=e-t.now();return 0>n?0:n},o.onResendCodeTimeout=function(e){var t=this,n=this.getResendCodeTimeout();if(null===n)throw new Error("No field resendCodeTimeout");return this.on("confirm-timeout",e),this._timerId=setTimeout(function(){t._trigger("confirm-timeout",t)},n),this
},o.canResendCode=function(){var e=this.getResendCodeTimeout();if(null===e){if(t.DEBUG)throw new Error("Normal operation of this method is impossible");return null}return 0===e},o.prolong=function(){var e=this;if(this.isRegistered())throw new Error("Phone must be valid for prolonging");if(this.isSimple())throw new Error("Phone must be secure for prolonging");var t=function(t){return e._reset(t),e._trigger("prolong",e),e};return s.prolong(this.getNumber()).then(t)},o.remove=function(){var e=this,t=function(t){return a(t,"Result must be exist"),a("OK"===t.status||"STARTED"===t.status,"Successfull result of remove operation must return `OK` or `STARTED`"),"OK"===t.status?(e._trigger("remove",e),e.die()):"STARTED"===t.status&&(e._trigger("remove-secure-start",e),e.die()),null
};return s.remove(this.getNumber()).then(t)},o._fail=function(e,i){a("object"==typeof e,"Parameter error is compulsory");var o;$.isFunction(i)?o=i.call(null,e):"string"==typeof i&&(o=i);var s={error:e};return t.DEBUG===n._namespace&&console.error(o,e),"string"==typeof o&&(this._trigger(o,e),s.errorName=o),this._errors.push(s),this},o.getLastError=function(){return this._errors?this._errors.slice(-1)[0]:null},o._set=function(e,t){if(a("string"==typeof e,"Parameter fieldName must be string"),this._phoneData[e]!==t){var n=this._phoneData[e];
return this._phoneData[e]=t,this._trigger("change",this,{fieldName:e,previous:n,current:t}),this}},o._reset=function(e){a("object"==typeof e,"Parameter phoneRawData must be object");var t=this._phoneData;return this._phoneData=e,this._trigger("reset",this,{previous:t,current:e}),this},o._trigger=function(e){a("string"==typeof e,"Parameter eventName must be string");var i;i=$(this);var o=Array.prototype.slice.call(arguments);return t.DEBUG===n._namespace&&console.info.apply(console,["Trigger event "+e+" with args:"].concat(o)),i.triggerHandler.apply(i,o),this
},o.on=function(e,t){a("string"==typeof e,"Parameter eventName must be string"),a($.isFunction(t),"Parameter eventName must be function");var n=this,i=1;$(this).bind(e,function(){t.apply(n,Array.prototype.slice.call(arguments,i))})},o.off=function(e,t){a("string"==typeof e,"Parameter eventName must be string"),a($.isFunction(t),"Parameter eventName must be function"),$(this).unbind(e,t)},o.die=function(){return $(this).unbind(),clearTimeout(this._timerId),this}}(this,Daria,Daria.Validator),function(e,t,n){var i,o,s,r=t.assert;
i=t._hMethods,s=t._UserPhones=function(e){e=e||[],this._userPhoneStore=[];var t=this;$.each(e,function(e,i){var o=new n(i);t._add(o)})},o=s.prototype,o._fail=t._UserPhone.prototype._fail,o.getLastError=t._UserPhone.prototype.getLastError,o._trigger=t._UserPhone.prototype._trigger,o.on=t._UserPhone.prototype.on,o.off=t._UserPhone.prototype.off,o.die=t._UserPhone.prototype.die,o._add=function(e){return r(e instanceof n,"Parameter phone must be instance of UserPhone"),e.on("remove",$.proxy(this.removePhone,this)),e.on("remove-secure-start",$.proxy(this.removePhone,this)),this._userPhoneStore.push(e),e
},o.removePhone=function(e){var t;return $.each(this._userPhoneStore,function(n,i){return i===e?(t=n,!1):void 0}),this._userPhoneStore.splice(t,1),this._trigger("remove",e),this},o.getPhoneCount=function(){return this._userPhoneStore.length},o.isEmpty=function(){return!Boolean(this.getPhoneCount())},o.getSecure=function(){if(!this._userPhoneStore.length)return null;var e=$.grep(this._userPhoneStore,function(e){return e.isSecure()})[0];return e||null},o.getAll=function(){return this._userPhoneStore
},o.getAllValid=function(){var e=$.grep(this.getAll(),function(e){return e.isValid()});return e},o.getLastValid=function(){var e,t=this.getAllValid();return t.length?(e=t[0],$.each(t,function(t,n){e.getValidationTimestamp()<n.getValidationTimestamp()&&(e=n)}),e):null},o.getLastRegistered=function(){var e,t=this.getAll();if(!t.length)return null;var n=$.grep(t,function(e){return e.isRegistered()});return n.length?(e=n[0],$.each(n,function(t,n){e.getRegistrationTimestamp()<n.getRegistrationTimestamp()&&(e=n)
}),e):null},o.registerSecure=function(e){return r(!this.getSecure(),"Secure phone must not be in collection"),this._register(e,!0)},o.registerSimple=function(e){return r("string"==typeof e,"Parameter phoneNumber must be string"),this._register(e,!1)},o._register=function(e,t){var o=this;if(this.getPhone(e))throw new Error("This phone must not be in collection");var s=function(e){var t=new n(e);return o._add(t),t};return i.register(e,t).then(s)},o.getPhone=function(e){r("string"==typeof e,"Parameter phoneNumber must be string");
var t=this.getAll(),n=$.grep(t,function(t){return t.getNumber()===e})[0];return n=n||null}}(this,Daria.Validator,Daria.Validator._UserPhone),function(){var e={shouldShow:function(){var e=ns.Model.get("settings");return"welcome"===Daria.urlParams.wizard?!0:Jane.Config.NO_SETTINGS?!1:Daria.IS_CORP||Daria.Config.workspace?!1:Daria.Wizard.isNewAccount()?e.isSet("welcome_wizard_date")?!1:["ru","uk","en","tr"].indexOf(Daria.Config.locale)<0?!1:!0:!1},getSteps:function(){return["welcome-wizard-mobile-app-step","welcome-wizard-theme-step","welcome-wizard-collectors-step"]
},show:function(){var e=ns.Model.get("settings");return this.vPopup&&this.vPopup.isValid()?void this.close():(this._getWizardState().on("daria:wizard:complete",this.close.bind(this)),this.vPopup=ns.View.create("welcome-wizard-popup"),this.vPopup.open({"class":"mail-WelcomeWizardPopup",close:!1,height:500,width:770,where:document,autoclose:!1,autofocus:!1}),void e.setSettings({welcome_wizard_date:Daria.now()}))},close:function(){this._getWizardState().off("daria:wizard:complete"),this.vPopup&&this.vPopup.isValid()&&(this.vPopup.close(),this.vPopup=null)
},_getWizardState:function(){return ns.Model.get("wizard-state",{wizard_name:"welcome"})}};Daria.WelcomeWizard=e}(),Daria.Wizard={_wizard:null,start:function(e){Jane.Services.runModules(["jane.setup.js"],function(){Daria.Wizard._start(e)})},_start:function(e){Daria.Wizard._wizard||(Daria.Wizard._wizard=ns.View.create("wizard",e));var t=Daria.Wizard._wizard,n=this,i="b-popup_wizard";if(e.experiment&&(i+=" b-popup_wizard_experiment","intro"==e.step&&(e.step="labels")),$(".ns-view-wizard-interface .b-color-scheme__theme").on("click",function(){Daria.setCookie("wizard","interface")
}),this.active)t.stepChanged(e);else{var o=ns.layout.page("wizard",e);e._yateModule="promo",new ns.Update(t,o,e,{execFlag:ns.U.EXEC.PARALLEL}).render().then(function(){Daria.Dialog.open({title:"Быстрая настройка почты",body:t.node,width:750,additionalClass:i,onopen:function(){ns.events.trigger("wizard-open",e.step),n.active=!0,t.bindMetriks(Daria.Dialog.$dialog,e.experiment),t.stepChanged(e)},onclose:function(){n.active=!1,t.unbindMetriks(),t.invalidate(),Jane.ErrorLog.send(null,"WizardClose"),Daria.Wizard.saveEndSetting(),ns.events.trigger("wizard-close")
}})})}},isNewAccount:function(){return Daria.getAccountAgeInDays()<=3},valid:function(){var e=Daria.urlParams,t="2"==e.w;if(this.step)return t&&(this.directInterface=!0),this.step;var n,i=Daria.getCookie("wizard"),o="1"==e.w,s=ns.Model.get("settings").isSet("inline-wizard");return s||(Jane.ErrorLog.send(null,"WizardOn"),n="intro"),o&&(n=e["wizard-step"]||"intro"),t&&!s&&(n="collector"),i&&(n=i,Daria.delCookie("wizard")),this.step=n,n},getParams:function(){var e={},t=this.valid(),n=["labels","collector","sender","interface","done"];
return("collector"==t||this.directInterface)&&(n=["collector","sender","interface","done"],e["coollect-experiment"]=!0),Jane.Config.allowThemes||(n=["labels","collector","sender","done"],this._metrikaSteps=["","Метки","Сборщики","Информация об отправителе","Валидация","Done"]),e.experiment=1,e.step=t,e.order=n,e},saveEndSetting:function(){ns.Model.get("settings").setSettings({"inline-wizard":Daria.now()})}},Daria.InlineWizard={interval:500,max:5,currentStep:1,footerHeight:50,height:480,minHeight:5,labelHeight:49,wizardView:null,stepsViewsNames:["inline-wizard-mobile-app-step"],start:function(e){var t=this;
this.$node=$(e),this.writeStepNumber(1),ns.events.on("ns-page-after-load",function(){"messages"!==ns.page.current.page&&t.forceClose()});var n=this.$node.find(".js-inline-wizard-parent");n.on("scroll",function(){n.scrollLeft(0)})},onResizeWizard:function(){Daria.InlineWizard.step("check")},needToShowOpenWizard:function(){return Daria.Wizard.isNewAccount()&&!ns.Model.get("settings").isSet("inline-wizard-close")},writeStepNumber:function(e){this.$node.find(".js-inline-wizard-step-"+e+" .js-wizard-step__number").text("Шаг "+(e<=this.max?e:this.max)+" из "+this.max)
},removeWizard:function(){var e=this.$node.find(".js-inline-wizard-parent");e.css({height:0,minHeight:0}),e.on("webkitTransitionEnd oTransitionEnd transitionend mozTransitionEnd",function(){e.remove()})},end:function(){this.removeWizard()},getPageHeight:function(e){return this.$node.find(".js-inline-wizard-parent").offset().top+e.height()-this.footerHeight},onTransitionEnd:function(e,t){!Modernizr.cssanimations||Modernizr.opera&&!Modernizr.webkit?t():e.one("webkitTransitionEnd oTransitionEnd transitionend mozTransitionEnd",t)
},open:function(){var e=this.$node.find(".js-inline-wizard-parent"),t=this.$node.find(".js-inline-wizard-current"),n=this.getPageHeight(t);e.addClass("inline-wizard-wrapper-small mail-InlineWizard-Wrapper_small").addClass("inline-wizard-wrapper-open mail-InlineWizard-Wrapper_open").css({height:this.minHeight,minHeight:this.minHeight}),Daria.forceNodeReflow(e[0]),e.removeClass("inline-wizard-wrapper-small mail-InlineWizard-Wrapper_small"),this.onTransitionEnd(e,this.afterOpenAnimation.bind(this,e,n))
},afterOpenAnimation:function(e,t){Daria.forceNodeReflow(e[0]),this.$node.find(".js-inline-wizard-label").addClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").removeClass("g-hidden"),e.css({height:this.height,minHeight:this.height}),$("body").stop().animate({scrollTop:t},this.interval),ns.events.trigger("wizard-open",this.getCurrentStep())},openBeforeRender:function(){var e=this.$node.find(".js-inline-wizard-steps-wrapper");this.$node.find(".js-inline-wizard-label").addClass("g-hidden"),e.removeClass("g-hidden")
},getCurrentStep:function(){return parseInt(this.currentStep,10)},close:function(){ns.Model.get("settings").setSettingOn("inline-wizard-close");var e=this.$node.find(".js-inline-wizard-parent");e.css({height:e.outerHeight()});var t=this.$node.find(".js-inline-wizard-parent").offset().top-this.footerHeight;e.stop(),e.addClass("inline-wizard-wrapper-close mail-InlineWizard-Wrapper_close"),e.css({height:0,minHeight:0}),this.onTransitionEnd(e,this.afterCloseAnimation.bind(this,e,t))},afterCloseAnimation:function(e){this.$node.find(".js-inline-wizard-label").removeClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").addClass("g-hidden"),e.css({height:0,minHeight:0}),this.clearWizardView()
},forceClose:function(){var e=this.$node.find(".js-inline-wizard-parent");e.addClass("mail-InlineWizard-Steps_no-transition").css({height:0,minHeight:0}),Daria.forceNodeReflow(e[0]),e.removeClass("mail-InlineWizard-Steps_no-transition"),this.$node.find(".js-inline-wizard-label").removeClass("g-hidden"),this.$node.find(".js-inline-wizard-steps-wrapper").addClass("g-hidden"),ns.events.trigger("inline-wizard-close")},step:function(e){if(this.noScrollWhileIDo)return!1;this.noScrollWhileIDo=!0;var t=this.$node.find(".js-inline-wizard-parent"),n=t.outerWidth()+2,i=this.$node.find(".js-inline-wizard-scrolling-element");
switch(e){case"next":this.nextStep(t,i,n);break;case"prev":this.prevStep(t,i,n);break;case"check":this.checkStep(t,i,n)}},changeStep:function(e){this.currentStep=e,ns.Model.get("settings").setSettings({"inline-wizard-step":e}),ns.events.trigger("wizard-step-change",this.getCurrentStep())},nextStep:function(e,t,n){var i,o=this,s=parseInt(this.currentStep,10);return s===o.max?void o.step("check"):(i=parseInt(this.currentStep,10)+1,o.writeStepNumber(i),o.metrika(i-1,"Далее"),2===i?(o.$node.find(".b-notification_error").addClass("g-hidden"),ns.events.trigger("daria:vWizardLabels:addLabels")):i===this.max&&o.initStepFive(),t.css({marginLeft:parseInt(t.css("margin-left"),10)-n}),this.onTransitionEnd(e,this.onTransitionEndStep.bind(this,i)),o.changeStep(i),void this.metrika(i,"Показ"))
},prevStep:function(e,t,n){var i,o=this;i=parseInt(this.currentStep,10)-1,o.writeStepNumber(i),2===i?o.$node.find(".b-notification_error").addClass("g-hidden"):i===this.max&&o.initStepFive(),t.css({marginLeft:parseInt(t.css("margin-left"),10)+n}),this.onTransitionEnd(e,this.onTransitionEndStep.bind(this,i)),o.changeStep(i),this.metrika(i,"Показ")},onTransitionEndStep:function(e){this.$node.find(".js-inline-wizard-current").removeClass("js-inline-wizard-current"),this.$node.find(".js-inline-wizard-step-"+e).addClass("js-inline-wizard-current"),this.noScrollWhileIDo=!1
},checkStep:function(e,t,n){var i,o=this;i=parseInt(this.currentStep,10)||1,o.writeStepNumber(i),i===this.max&&o.initStepFive(),t.addClass("mail-InlineWizard-Steps_no-transition").css({marginLeft:-n*(i-1)}),Daria.forceNodeReflow(t[0]),t.removeClass("mail-InlineWizard-Steps_no-transition"),o.$node.find(".js-inline-wizard-current").removeClass("js-inline-wizard-current"),o.$node.find(".js-inline-wizard-step-"+i).addClass("js-inline-wizard-current"),o.noScrollWhileIDo=!1,o.changeStep(i)},clearWizardView:function(){this.wizardView&&this.wizardView.destroy(),this.wizardView=null
},initStepFive:function(){var e=this;Daria.Validator.getUserPhones(!0).done(function(t){var n=t.getAllValid();0!==n.length||Daria.Config.pddDomain?(e.writeStepNumber(6),e.$node.find(".js-inline-wizard-step-5").remove()):(e.$node.find(".g-error").addClass("g-hidden"),e.$node.find(".js-inline-wizard-step-6").remove(),Daria.phoneRegistrationInWizard(e.$node[0],e))})},metrika:function(e,t){if(("string"==typeof e||Array.isArray(e))&&(t=e,e=void 0),!this._metrikaCategory){var n,i=Daria.now()-ns.Model.get("account-information").getData().reg_date;
n=i<=3*Jane.Date.DAY?"Показы новым пользователям":"Показы старым пользователям",this._metrikaCategory=["Новый Визард",n]}var o=this._metrikaCategory;e===!0&&(e=this.getCurrentStep()),e&&(o=o.concat(this._metrikaSteps[e])),o=o.concat(t),"wizard-log"in Daria.urlParams&&console.log("WIZARD METRIKA:",o),Jane.c(o)},_metrikaSteps:["","Метки","Сборщики","Информация об отправителе","Темы","Валидация","Done"]},Daria.InlineWizard.hasAvailableSteps=function(e){return Object.keys(Daria.InlineWizard.getAvailableSteps(e)).length>0
},Daria.InlineWizard.getAvailableSteps=function(e){var t={};return this.stepsViewsNames.forEach(function(n){var i,o=ns.View.info(n);o.shouldShow(e)&&(i=o.getLayout(e),t[i.name]=i.childViews)}),t},Daria.InlineWizard.shouldShow=function(e){return Daria.is2pane()&&!Daria.IS_KCUF&&!Daria.IS_CORP&&this.hasAvailableSteps(e)},Daria.InlineWizard._renderWizard=function(){var e={_yateModule:"promo"};this.wizardView&&this.wizardView.destroy&&this.wizardView.destroy(),this.wizardView=ns.View.create("inline-wizard"),new ns.Update(this.wizardView,ns.layout.page("wizard-inline",e),e,{execFlag:ns.U.EXEC.PARALLEL}).render()
},Daria.InlineWizard._showWizard=function(){this.wizardView.showOnPage(),this.openBeforeRender()},Daria.InlineWizard.show=function(e){if(Daria.InlineWizard.shouldShow(e)){var t=this;Jane.Services.runModules(["jane.setup.js"],function(){t._renderWizard()})}},function(){var e="mail-WizardU2709",t={};t.data=[{title:"Какой может быть почта?",description:"Мы работаем над созданием новой Почты.<br>Узнайте первыми, какой она может быть.",button:"start"},{title:"Экономьте время",description:"Письма открываются прямо на той же странице, без&nbsp;лишних&nbsp;переходов."},{title:"Без чекбоксов",description:"Письма можно выбирать, кликая на портреты отправителей."},{title:"Закрепляйте важное",description:"Самые нужные и важные письма можно всегда держать на виду, закрепив их на самом верху списка."},{title:"Без границ",description:"Ширина почты будет такой, как вы захотите. Просто схватитесь за край списка писем и потяните.",button:"end"}],t.framesCount=t.data.length-1,t.frameWidth=612,t.currentFrame=0,t.duration=300,t.node=null,t.init=function(){return t.checkCondition()?(t.inited=!0,t.render(),t.bindEvents(),void t.setSetting()):!1
},t.checkCondition=function(){return!ns.Model.get("settings").getSetting("wizard-u2709")&&!Daria.IS_CORP&&!Daria.Config.first_login},t.render=function(){t.node=Jane.tt("promo:promo-wizard-u2709",{data:t.data}),t.$node=$(t.node),t.$slider=t.$node.find(".js-wizard-u2709-content"),t.$controls=t.$node.find(".js-wizard-u2709-controls"),t.dialog=Daria.Dialog.open({body:t.node,width:612,additionalClass:e+"_box",onclose:t.onClose})},t.bindEvents=function(){t.$node.on("click",".js-wizard-u2709-prev",this.prev),t.$node.on("click",".js-wizard-u2709-next",this.next),t.$node.on("click",".js-wizard-u2709-pic",this.onPicClick),t.$node.on("click",".js-wizard-u2709-controls li",this.onCircleClick),t.$node.on("click",".js-wizard-u2709-start-btn",this.onStartBtnClick),t.$node.on("click",".js-wizard-u2709-end-btn",this.onEndBtnClick)
},t.onEndBtnClick=function(){t.dialog.close()},t.onClose=function(){ns.Model.get("settings").isSet("promo-check-messag_s")||Jane.Promo.showPromo("promo-check-message")},t.onPicClick=function(){t.currentFrame===t.framesCount?t.dialog.close():t.next(0===t.currentFrame)},t.onStartBtnClick=function(){t.next(!0)},t.onCircleClick=function(){t.prevFrame=t.currentFrame,t.currentFrame=$(this).data("num"),t.move()},t.move=function(){t.$slider.removeClass("js-wizard-u2709-frame"+t.prevFrame).addClass("js-wizard-u2709-frame"+t.currentFrame),t.checkState()
},t.checkState=function(){var n=e+"_first",i=e+"_last",o=e+"_current";t.$node.removeClass(n),t.$node.removeClass(i),t.$controls.find("li").removeClass(o),t.$controls.find("[data-num="+t.currentFrame+"]").addClass(o),1===t.currentFrame&&t.$node.addClass(n),t.framesCount===t.currentFrame&&t.$node.addClass(i)},t.prev=function(){t.prevFrame=t.currentFrame,t.currentFrame--,t.move()},t.next=function(n){n&&t.$node.removeClass(e+"_closeControls"),t.prevFrame=t.currentFrame,t.currentFrame++,t.move()},t.setSetting=function(){ns.Model.get("settings").setSettings({"wizard-u2709":Daria.now()})
},Daria.wizardU2709=t}(),function(){var e="security-questions",t=Daria.States,n=Daria.SecurityQuestionsWizard=function(t){t=t||{},this.experiment=t.experiment,this.questionSelectValues=[null,null,null],this.$node=null,this.namespace=e};$.extend(n.prototype,Daria.PubSubMixin),n.getSettingName=function(t){var n={"select-as-link":"1"},i=n[t]||"";return e+i},n.saveSettings=function(e,t){ns.Model.get("settings").updateSetting(n.getSettingName(t),e)},n.updateTimestamp=function(e){n.saveSettings({timestamp:Daria.now()},e)
},n.isShown=function(e){return Boolean(ns.Model.get("settings").getSetting(n.getSettingName(e),"json").timestamp)},n.isLessThenAfterShow=function(e,t){var i=ns.Model.get("settings").getSetting(n.getSettingName(t),"json").timestamp||0;return i=Number(i),0===i?!1:Daria.now()-i<e},n.prototype.getMetrikaBase=function(){return"select-as-link"===this.experiment?"3КВО - эксперимент":"3КВО"},n.prototype.metrika=function(e,t){var n=[].concat(e,t);Jane.c(n),Daria.urlParams.logger===this.namespace&&console.info("@METRIKA:",n.join(" => "))
},n.prototype.motivationMetrika=function(e){this.metrika(this.getMetrikaBase(),["Мотивация"].concat(e))},n.prototype.init=function(){var e=this.fsm=new t({transitions:{next:{from:["first","second","third"],to:t.nextState({first:"second",second:"third",third:"done"})},previous:{from:["second","third"],to:t.nextState({second:"first",third:"second"})},"validate-error":{from:["first","second","third"],to:t.loopback()},"create-error":{from:["third"],to:t.loopback()},close:{from:"*",to:"close"}},initialState:"first",target:this}),n=this.getMetrikaBase();
return Daria.initializeMetrika(n,this,{openModal:["@once","Показ"],onTransitionValidateError:["Ошибки","Ошибка валидации"],onStateSecond:["@once","Первый шаг пройден"],onStateThird:["@once","Второй шаг пройден"],onTransitionCreateError:["Ошибки","Ошибка создания 3КВО"],onCreateSecurityQuestions:["@once","Пользователь завел 3КВО"],complete:["@once","Кнопка Готово!"],onClose:["@once","Клик по крестику"],previousQuestion:["Возрат на предыдущий шаг"]},this.metrika.bind(this)),e.run(this.beforeRun),this
},n.prototype.beforeRun=function(){this.questionList=ns.Model.get("security-questions-patterns").getAll().map(function(e,t){return{text:e,value:String(t)}}),this.$node=$(this.render({experiment:this.experiment})),this.openModal(this.$node).bindEvents(this.$node)},n.prototype.bindEvents=function(e){var t=this;return e.on("click keypress focusin",".js-security-questions[data-event]",function(e){var n=$(this),i=e.type;n.data("event").split(/\s*,\s*/).forEach(function(n){n=n.split(".");var o=n[0],s=n[1];
o===i&&t[s](e)})}),this},n.prototype.unbindEvents=function(e){return e.off(),nb.destroy(e),this},n.prototype.render=function(e){return Jane.tt("promo:promo-security-questions",e)},n.prototype.openModal=function(e){return nb.block(e.get(0)).open(),n.updateTimestamp(this.experiment),this},n.prototype.closeModal=function(e){return nb.block(e.get(0)).close(),this},n.prototype.get$Content=function(){return this.$content||(this.$content=this.$node.find(".js-security-questions-content")),this.$content},n.prototype.changeStep=function(e){return this.$content||(this.$content=this.$node.find(".js-security-questions-content")),this.$content.removeClass().addClass("jane-security-questions-content").addClass("jane-security-questions-content_at-step_"+e),this
},n.prototype.stateToStep=function(e){return{first:1,second:2,third:3}[e]||null},n.prototype.getEntities=function(){if(!this.nbEntities){var e=this.$node.find(".js-answer,.js-question");this.nbEntities=_.reduce(e,function(e,t){var n=nb.block(t),i=n.getName();return e[i]=n,e},{})}return this.nbEntities},n.prototype.getEntity=function(e,t){return t=_.isNumber(t)?t:this.stateToStep(t),this.getEntities()[e+t]||null},n.prototype.serializeAll=function(){var e=this.getEntities();return _.transform(e,function(e,t,n){var i,o=t.getType();
"select"===o?i=t.getState().text:"input"===o&&(i=t.getValue()),e[n]=i})},n.prototype.updateQuestionSelectValues=function(e){var t=this.getEntity("question",e);if(t){var n=t.getState().value,i=this.stateToStep(e)-1;this.questionSelectValues[i]=n||null}},n.prototype.onenterState=function(e){var t=e.from;t&&this.updateQuestionSelectValues(t);var n=this.stateToStep(e.to);if(n){var i=nb.block(this.$node.find(".js-questions-select-"+n).get(0)),o=n-1;this.updateQuestionsForSelect(o,i)}e.from!==e.to&&this.preventTabFocusOut(n)
},n.prototype.oneachState=function(e){var t=this.fsm.getCurrentStateName();if(this.isAnswerStep(t)){var n=["webkitTransitionEnd","oTransitionEnd","transitionend","mozTransitionEnd"].join(" "),i=this,o=this.stateToStep(t);if(e.from&&Modernizr.csstransitions){var s=this.get$Content();s.off(n).one(n,i.focusOnAnswer.bind(i,o))}else this.focusOnAnswer(o)}},n.prototype.focusOnAnswer=function(e){var t=this.getEntity("answer",e);return t&&t.focus(),this},n.prototype.preventTabFocusOut=function(e){return e=e||"done",nb.$bulk(this.$node,"disable"),nb.$bulk(".js-security-questions-step-"+e,this.$node,"enable"),this
},n.prototype.updateQuestionsForSelect=function(e,t){var n=t.getState().value;n&&(this.questionSelectValues[e]=n);var i=this.getQuestionsForSelect(e,this.questionList,this.questionSelectValues);if(t.setSource(i),n){var o=_.find(this.questionList,{value:n});t.setState(o)}return this},n.prototype.getQuestionsForSelect=function(e,t,n){var i=n.slice();return i[e]=null,_.reject(t,function(e){return _.contains(i,e.value)})},n.prototype.validateAnswer=function(e){return Boolean(e)},n.prototype.validateNext=function(e){var t=this.getEntity("answer",e);
return this.validateAnswer(t.getValue())},n.prototype.onkeypressAnswer=function(e){var t=e.keyCode?e.keyCode:e.which;t==Jane.Common.keyCode.ENTER?(this.nextQuestion(),e.preventDefault()):this.hideErrors()},n.prototype.onfocusAnswer=function(){this.hideErrors()},n.prototype.isAnswerStep=function(e){return _.contains(["first","second","third"],e)},n.prototype.nextQuestion=function(){var e=this.fsm.getCurrentStateName();if(this.isAnswerStep(e)&&!this.validateNext(e))return void this.fsm.transition("validate-error");
var t=this.fsm.getNextStateByTransition("next");"done"===t?ns.Model.get("security-questions").create(this.serializeAll()).done(this.onCreateSecurityQuestions.bind(this)).fail(this.fsm.transition.bind(this.fsm,"create-error")):this.fsm.transition("next")},n.prototype.onCreateSecurityQuestions=function(){this.fsm.transition("next")},n.prototype.onError=function(e){this.showError(e)},n.prototype.onTransitionValidateError=function(){this.onError("validate")},n.prototype.onTransitionCreateError=function(){this.onError("create")
},n.prototype.get$Error=function(e){var t="$error"+e[0].toUpperCase()+e.slice(1);return this[t]||(this[t]=this.$node.find(".js-"+e+"-error")),this[t]},n.prototype.showError=function(e){this.get$Error(e).removeClass("g-hidden")},n.prototype.hideErrors=function(){this.get$Error("validate").addClass("g-hidden"),this.get$Error("create").addClass("g-hidden")},n.prototype.previousQuestion=function(){this.hideErrors(),this.fsm.transition("previous")},n.prototype.onStateFirst=function(){this.changeStep(1)
},n.prototype.onStateSecond=function(){this.changeStep(2)},n.prototype.onStateThird=function(){this.changeStep(3)},n.prototype.onStateDone=function(){this.hideHeader().changeStep("4")},n.prototype.hideHeader=function(){return this.$node.find(".js-security-questions-header").css("visibility","hidden"),this},n.prototype.complete=function(){this.fsm.transition("close")},n.prototype.onClose=function(){this.fsm.transition("close")},n.prototype.onStateClose=function(e){this.trigger("done"===e.from?"create":"create"),this.unbindEvents(this.$node).closeModal(this.$node)
}}(),function(){var e,t=Daria.Validator.getUserPhones.bind(Daria.Validator),n=Daria.supplant,i=Daria.PromoBar,o=i.promoStates={START:"create-alias-init",CONFIRM:"create-alias-confirm",FINISH:"create-alias-finish",CLOSE:"close",EVERYTHING:"*"};i.modifications={base:{close:!0,header:"Ваш телефон@"+Jane.Config["yandex-domain"]+" — теперь это возможно!",rightPromoContent:"promo_video",name:"base"},done:{close:!1,header:"Ваш телефон@"+Jane.Config["yandex-domain"],rightPromoContent:"promo_image",name:"done",metrika:"done",closeTimeout:Daria.timify({seconds:5})}};
var s=i.prototype;$.extend(s,Daria.PubSubMixin);var r=Daria.PromoBar.namespace,a=function(e){Daria.DEBUG===r&&e()},c=function(e,t){var n={event:[r].concat(e).join("-"),uid:Daria.uid};return n=$.extend(n,t),a(function(){console.warn("@log %s",n.event)}),Jane.ErrorLog.send(n)},d=s.metrika=function(e){var t=["Цифровой логин"];Daria.is3pane()?t.push("3pane"):"base"!==this.modification.name&&t.push(this.modification.metrika);var n=t.concat(e);return a(function(){console.warn("@metrika",n.join(" -> "))
}),Jane.c(n)};s.init=function(t,n){var s=this;if(e=function(e){return function(t){s.transition(e,t)}},this.$location=$(n?n:"body"),!this.$location.length)throw new TypeError("Argument location must be node or non-empty jQuery object");this.modification=i.modifications[t],d=this.metrika.bind(this);var r=this.stateConfig={};r[o.START]={onenter:function(){ns.events.on("aliasify-submit",s.onAliasifySubmit),ns.events.on("aliasify-show-video",s.showVideo)},onchangestep:function(){s.getInputNumberNode().on("click",function(e){s.onClickInputNumber(e)
})},onleave:function(){s.getInputNumberNode().off("click")}},r[o.CONFIRM]={onenter:function(){ns.events.on("aliasify-show-video",s.showVideo),ns.events.on("aliasify-commit",s.onAliasifyCommit),ns.events.on("aliasify-resend-code",s.onResendCode),ns.events.on("aliasify-back",s.onBack)},onleave:function(){s.password.$password=null,s.$node.find(".js-alias-password").off("keyup")}},r[o.FINISH]={onenter:function(){ns.events.on("aliasify-show-video",s.showVideo)}},this.states=new Daria.States({transitions:{"start-error":{from:o.START,to:o.START},send:{from:o.START,to:o.CONFIRM},"send-error":{from:o.START,to:o.START},confirm:{from:o.CONFIRM,to:o.FINISH},"confirm-error":{from:o.CONFIRM,to:o.CONFIRM},"resend-code":{from:o.CONFIRM,to:o.CONFIRM},"resend-code-error":{from:o.CONFIRM,to:o.CONFIRM},back:{from:o.CONFIRM,to:o.START},close:{from:o.EVERYTHING,to:o.CLOSE}},states:r,onEachState:{onenter:function(){ns.events.on("aliasify-close",s.onAliasifyClose)
},onleave:function(){ns.events.off("aliasify-show-video",this.showVideo),ns.events.off("aliasify-submit",this.onAliasifySubmit),ns.events.off("aliasify-commit",this.onAliasifyCommit),ns.events.off("aliasify-resend-code",this.onResendCode),ns.events.off("aliasify-back",this.onBack),ns.events.off("aliasify-close",this.onAliasifyClose),clearTimeout(s._timerId)}}}),this.states.onState(o.START,this.onStateStart.bind(this)),this.states.onState(o.CONFIRM,this.onStateConfirm.bind(this)),this.states.onState(o.FINISH,this.onStateFinish.bind(this)),this.states.onState(o.CLOSE,this.onStateClose.bind(this));
var a=this.onError.bind(this),c=this.onSendingToSent.bind(this);this.states.onTransition("send",c),this.states.onTransition("send-error",a),this.states.onTransition("confirm-error",a),this.states.onTransition("resend-code-error",a),this.onAliasifyCommit=this.onAliasifyCommit.bind(this),this.onResendCode=this.onResendCode.bind(this),this.onBack=this.onBack.bind(this),this.onAliasifySubmit=this.onAliasifySubmit.bind(this),this.onAliasifyClose=this.onAliasifyClose.bind(this),this.onPasswordKeyup=this.onPasswordKeyup.bind(this),this.defineState().then(function(e){s.beforeAllStates(e).then(function(){e&&s.states.setCurrentState(e)
})}),this.hAliasifyBind=ns.Model.get("aliasify-bind"),this.hAliasifyBound=ns.Model.get("aliasify-bound"),this.hSettings=ns.Model.get("settings"),this.once("alias-promo.finish",function(){d("Альяс создан"),s.saveSettings({closeStatus:"alias-created",closeDate:Daria.now()}),Jane.Promo.setFirstStartSettingOff("alias-promo")}),this.once("alias-promo.closed-by-user",function(){s.saveSettings({closeStatus:"closed-by-user",closeDate:Daria.now()}),Jane.Promo.setFirstStartSettingOff("alias-promo")})},s.beforeAllStates=function(e){var t=this;
return e===o.FINISH&&this.isForceShow()?(c("stub"),this.metrika(["Заглушка","показ"]),d=c=_.noop):(c("show"),this.metrika("Показ плашки")),this.trigger(n("{namespace}.show",{namespace:r})),Daria.Validator.getUserPhones(!0).then(function(n){e===o.FINISH&&(t._number=n.getSecure().getNumber(),t.saveSettings({preventForceShow:!0}))})},s.onStateStart=function(n){var i=this,s=n.transitionName;s&&"back"!==s||t(!0).then(function(e){var t=e.getSecure(),n=i._number=t&&t.getNumber()||i._getNumber(),s={number:n,lock:Boolean(t)};
i.changeStep(o.START,s),t||i.unlockEdit(),i.$node.find('button[type="submit"]:eq(0)').focus();var r=e.getAll();i.autocompleteData=$.map(r,function(e){return e.getNumber()}),!t&&e.getPhoneCount()&&(i.$node.find("input:eq(0)").focus(),Daria.Autocompleter.getUserPhoneAutocompleter().bindField({field:$(".b-intruder_promo-alias input"),focus:1}))},e("start-error"))},s.getInputNumberNode=function(){return this.$node.find(".js-alias-number")},s.unlockEdit=function(){Jane.enableInput(this.getInputNumberNode())
},s.onAliasifySubmit=function(){d('Клик на "получить адрес"');var n=this,i=this.getInputNumberNode().val(),o=function(t,i){i&&(n._number=i),n._aliasifyHandlerName="aliasify-"+t,ns.Model.get(n._aliasifyHandlerName).submit(i).done(e("send")).fail(e("send-error"))};t(!0).then(function(e){var t=e.getPhone(i);t&&t.isSecure()&&t.isValid()?o("bound"):o("bind",i)},e("send-error"))},s.onSendingToSent=function(){this._saveNumber(this._number)},s.onStateConfirm=function(e){var t=this._number,n=e.transitionName,i=ns.Model.get(this._aliasifyHandlerName);
if(i.offTrackIdExpired(t,this.onBack),i.onTrackIdExpired(t,this.onBack),$.inArray(n,["send","resend-code"])>-1){var s={number:this._number,show_password:"aliasify-bind"===i.name};this.changeStep(o.CONFIRM,s),this.password.$password=this.$node.find(".js-alias-password"),this.password.$password.on("keyup",this.onPasswordKeyup)}this._timer()},s.onAliasifyCommit=function(){d('Клик на "потвердить"');var t=this.$node.find(".js-alias-code").val(),n=this.$node.find(".js-alias-password").val(),i=this._number;
ns.Model.get(this._aliasifyHandlerName).commit(i,t,n).done(e("confirm")).fail(e("confirm-error"))},s._timer=function(){var e=this,t=1e3,n=function(){return ns.Model.get(e._aliasifyHandlerName).getResendCodeTimeout(e._number)},i=n();i>0?(this._timerId||this._refreshResendTimeout(i),this._timerId=setTimeout(function(){e._refreshResendTimeout(n()),e._timer()},t)):(this._clearResendNotification(),Jane.enableButton(this.$node.find(".js-code-resend")))},s._refreshResendTimeout=function(e){var t=this.$node.find(".js-resend-timeout"),i=6e4,o=Math.floor(e/i),s=Math.floor((e-o*i)/1e3);
t.html(n("{minutes}:{seconds}",{minutes:Jane.Common.n(o),seconds:Jane.Common.n(s)}))},s._clearResendNotification=function(){this.$node.find(".js-resend-notification").html("")},s.onResendCode=function(){d('Клик на "Прислать код еще раз"'),ns.Model.get(this._aliasifyHandlerName).resend(this._number).done(e("resend-code")).fail(e("resend-code-error"))},s.onBack=function(e){d("track_expired"===e.name?"Возврат на первый шаг(по таймауту)":"Возврат на первый шаг"),this.transition("back")},s.isForceShow=function(){return Daria.urlParams.promo===r
},s.onStateFinish=function(){var t=this.modification.closeTimeout||Daria.timify({seconds:4});this.isForceShow()&&(t=Daria.timify({seconds:10}));var n={number:this._number,forceShow:this.isForceShow()};this.changeStep(o.FINISH,n),setTimeout(e("close"),t)},s.onAliasifyClose=function(){var e="done"==this.modification.name?"Уход со страницы":"Крестик плашки";d(e),this.transition("close")},s.onStateClose=function(e){var t=e.from;switch(t){case o.FINISH:this.trigger(n("{namespace}.finish",{namespace:r}));
break;case o.START:case o.CONFIRM:this.trigger(n("{namespace}.closed-by-user",{namespace:r}))}this.isForceShow&&this.saveSettings({preventForceShow:!0}),this.removeNode().reset3pane()},s.removeNode=function(){return this.$location.find(".b-intruder_promo-alias").remove(),this.$node=null,this},s.hide=function(){this.trigger(n("{namespace}.hide",{namespace:r})),this.$node.hide(),this.reset3pane()},s.show=function(){this.trigger(n("{namespace}.show",{namespace:r})),this.$node.show(),this.fix3pane()},s.changeStep=function(e,t){var i=this.renderStep(e,t);
this.removeNode(),this.$location.prepend(i),this.$node=i;var o=n("{namespace}.{step}.render",{namespace:r,step:e});this.trigger(o,this);var s=this.stateConfig[this.states.getCurrentStateName()].onchangestep;_.isFunction(s)&&s.call(this,this.$node),this.fix3pane()},s.onRenderStart=function(e){var t=n("{namespace}.{step}.render",{namespace:r,step:o.START});this.once(t,e)},s.renderStep=function(e,t){var n=this.getUserCountryPhoneCode();return t=t||{},t.step=e,t.modification=this.modification,c("country_phone_code",{user_country_phone_code:n}),t.placeholder=this.getPhonePlaceholder(n),$(Jane.tt("promo:promo-digital-alias",t))
},s.getPhonePlaceholder=function(e){return Daria.Validator.getLocalPhoneInfo(e,"placeholder")},s.getUserCountryPhoneCode=function(){return ns.Model.get("account-information").getDataKey("country_phone_code")},s.onError=function(e){var t,n=e.payload,i=n.errors,o=function(e){d(["Ошибка"].concat(e))};if(i&&i.length>0)switch(t=i.sort().join(":")){case"sms_limit.exceeded":this.showError("Исчерпан лимит отправки смс"),o("Исчерпан лимит отправки смс");break;case"phone_alias.exist":this.showError("Логин недоступен"),o("Альяс уже создан");
break;case"number.invalid":this.showError("Неправильный формат номера. Попробуйте еще раз."),o("Неверный номер");break;case"password.not_matched":this.showError("Неверный пароль. Попробуйте еще раз."),o("Неверный пароль");break;case"code.invalid":o("Неверный код"),this.showError("Неверный код. Попробуйте еще раз.");break;case"number.empty":this.setHighlight(".js-alias-number"),this.showError("Пожалуйста, заполните все поля"),o("Незаполнены все поля");break;case"code.empty":this.setHighlight(".js-alias-code"),this.showError("Пожалуйста, заполните все поля"),o("Незаполнены все поля");
break;case"password.empty":this.setHighlight(".js-alias-password"),this.showError("Пожалуйста, заполните все поля"),o("Незаполнены все поля");break;case"code.empty:password.empty":this.setHighlight(".js-alias-code"),this.setHighlight(".js-alias-password"),this.showError("Пожалуйста, заполните все поля"),o("Незаполнены все поля");break;default:a(function(){console.warn("%s: %s",r,t)}),this.showError("Пожалуйста, повторите попытку ещё раз"),o("Неизвестная ошибка"),c("unhandled_error",{response:JSON.stringify(n)})
}else"CONNECTION_ERROR"===e.payload.errorcode&&this.showError("Ошибка соединения");this.saveSettings({lastError:t||e.payload.errorcode})},s.setHighlight=function(e){var t=this,n=this.$node.find(e);n.addClass("b-input_error_highlight"),n.one("focus",function(){t.unsetHighlight("input")})},s.unsetHighlight=function(e){this.$node.find(e).removeClass("b-input_error_highlight")},s.showError=function(e){var t=this,n=this.$node.find(".b-field_error");n.text(e.charAt(0).toUpperCase()+e.slice(1)).removeClass("g-hidden"),t.fix3pane(),this.$node.find("input").one("focus",function(){t.hideError(),t.fix3pane()
})},s.hideError=function(){var e=this.$node.find(".b-field_error");e.addClass("g-hidden")},i.isAliasNotExist=function(){var e=$.Deferred(),t=Vow.promise();return ns.Model.get("userinfo").get().then(t.fulfill.bind(t),t.reject.bind(t)),Vow.all([Daria.Validator.getUserPhones(!0),t]).then(function(t){var n=t[0],i=t[1],o=n.getSecure();return i.hasPassword?o&&o.isValid()?ns.Model.get("alias-exist").check(o.getNumber()).done(function(t){t.aliasExist?e.reject():e.resolve()}).fail(function(){e.reject()}):e.resolve():e.reject()
},function(){e.reject()}),e.promise()},i.saveSettings=s.saveSettings=function(e){var t=ns.Model.get("settings"),n=t.getMultiSetting(r);return $.extend(n,e),t.saveMultiSetting(r,n)},i.isClosedByUser=s.isClosedByUser=function(){return"closed-by-user"===i.getSetting("closeStatus")},i.getLastUsageTime=s.getLastUsageTime=function(){return i.getSetting("closeDate")||0},s.getSetting=Daria.PromoBar.getSetting,i.flushSettings=function(){var e=ns.Model.get("settings");return e.saveMultiSetting(r,{})},s._saveNumber=function(e){this.saveSettings({number:e})
},s._getNumber=function(){return this.getSetting("number")},s._saveState=function(e){this._saveAnything("state",e)},s._getState=function(){return this.getSetting("state")},s.defineState=function(){var e=$.Deferred(),t=this._getState();switch(t){case o.START:case o.CONFIRM:return e.resolve(o.START).promise();case o.FINISH:case o.CLOSE:return e.resolve(o.CLOSE).promise()}var n=$.Deferred();return Daria.Validator.getUserPhones(!0).then(n.resolve,n.reject),$.when(n,ns.Model.get("userinfo").get()).then(this.getStateByPhones,function(){return null
})},i.getStateByPhones=s.getStateByPhones=function(e,t){var n=$.Deferred();if(!t.hasPassword)return n.resolve(null).promise();var i=e.getSecure();return i&&i.isValid()?ns.Model.get("alias-exist").check(i.getNumber()).then(function(e){return e.aliasExist?o.FINISH:o.START}):n.resolve(o.START).promise()},s.transition=function(){this.states.transition.apply(this.states,arguments)},s.showVideo=function(e){d("Клик на видео");var t=Daria.Dialog.open({width:"700",body:Jane.tt("promo:promo-alias-video",e),onopen:function(){d("Открытие попапа с видео")
},onclose:function(){d("Крестик видео");var e=t.$body.find("iframe");e.attr("src",""),e.addClass("g-hidden").appendTo(document.body),Daria.setZeroTimeout(function(){e.remove()})}});return t},s.validPasswordRegexp=/^[-a-z0-9.`!@#$%^&*()_=+\[\]\{\};:"\\|,<>\/?]*$/i,s.onPasswordKeyup=function(){this.validPasswordRegexp.test(this.$password.val())?(this.hideError(),this.unsetHighlight(this.$password.selector)):(this.showError("смените раскладку"),this.setHighlight(this.$password.selector))},s.password={$password:null,validPasswordRegexp:/^[-a-zA-Z0-9!@#$%^&*()+_:;.,]*$/,containsInvalidCharacters:function(e){return!this.validPasswordRegexp.test(e)
}},s.onPasswordKeyup=function(){this.password.containsInvalidCharacters(this.password.$password.val())?(this.showError("смените раскладку"),this.setHighlight(this.password.$password.selector)):(this.hideError(),this.unsetHighlight(this.password.$password.selector))},s.fix3pane=function(){if(!Daria.is2pane()){var e=this.pageContent=$(".b-page:eq(0)").find(".b-page__content"),t=this.$node.height();this._pageContentTop||(this._pageContentTop=e.css("top"),this.onResize3pane=function(){this.fix3pane()
}.bind(this),$(window).resize(this.onResize3pane)),e.css("top",t+1)}},s.onClickInputNumber=function(e){var t=this,n=$(e.currentTarget);Daria.Validator.predictInput(n,function(){var e=t.getUserCountryPhoneCode();return Daria.Validator.getLocalPhoneInfo(e,"code")}),Daria.Validator.moveCaretToEnd(n)},s.reset3pane=function(){Daria.is2pane()||(this.pageContent.css("top",this._pageContentTop),$(window).off("resize",this.onResize3pane))}}(),function(){var e=Daria.supplant,t=Daria.States=function(e){if(!e.transitions)throw new Error("Argument params.transitions is compulsory");
_.extend(this,Daria.PubSubMixin),this._transitions=e.transitions,this._states=e.states||{},this._onEachState=e.onEachState,this._currentState=null,this._initialState=e.initialState,this._target=e.target||null},n=t.camelize=function(e){var t=/(?:(\w)[-._]([^\W_]))/g;return e.replace(t,function(e,t,n){return t+n.toUpperCase()})};t.prototype.getCurrentStateName=function(){return this._currentState},t.prototype.setCurrentState=function(e,t){var i=this.getCurrentStateName(),o={from:i,to:e,transitionName:t||null,target:this._target},s=this._onEachState;
s&&(i&&_.isFunction(s.onleave)&&s.onleave.call(this,o),_.isFunction(s.onenter)&&s.onenter.call(this,o)),_.isObject(this._target)&&(i&&_.isFunction(this._target.onleaveState)&&this._target.onleaveState(o),_.isFunction(this._target.onenterState)&&this._target.onenterState(o));var r=this._getState(i);r&&_.isFunction(r.onleave)&&r.onleave.call(this,o);var a=this._getState(e);if(a&&_.isFunction(a.onenter)&&a.onenter.call(this,o),this._currentState=e,this.trigger("state."+e,o),_.isObject(this._target)){var c=this._target[n("on-state-"+e)];
_.isFunction(c)&&c.call(this._target,o),_.isFunction(this._target.oneachState)&&this._target.oneachState(o)}return this},t.prototype._getState=function(e){return this._states[e]},t.prototype._getTransition=function(e){return this._transitions[e]},t.prototype.getNextStateByTransition=function(e){var t=this.getCurrentStateName(),n=this._getTransition(e);return _.isFunction(n.to)?n.to(t):n.to},t.prototype.transition=function(e,t){t=t||null;var i=this.getCurrentStateName();if(_.isUndefined(i))throw new Error("Current state must not be undefined");
var o=this._getTransition(e);if(!o)throw new Error("No transition with name `"+e+"` found");var s=[o.from!==i,_.isArray(o.from)&&!_.contains(o.from,i),"*"!==o.from];if(_.all(s))throw new Error("Transition can not be completed - invalid `from` state");if(("*"===o.from||_.isArray(o.from))&&(o.from=this.getCurrentStateName()),o.payload=t,o.target=this._target,this.trigger("transition."+e,o),_.isObject(this._target)){var r=this._target[n("on-transition-"+e)];_.isFunction(r)&&r.call(this._target,o)}var a=this.getNextStateByTransition(e);
return this.setCurrentState(a,e),this},t.prototype.onState=function(t,n){return this.on(e("state.{stateName}",{stateName:t}),n),this},t.prototype.onTransition=function(t,n){return this.on(e("transition.{transitionName}",{transitionName:t}),n),this},t.prototype.verifyInitialState=function(e){return this._verifyInitialState||this._initialState&&e(this._initialState),_.isFunction(this._verifyInitialState)?this._verifyInitialState():void 0},t.prototype.run=function(e){var t=this;return this.verifyInitialState(function(n){e=e||_.noop;
var i=e.call(t._target||t,n)||{};i.done?i.done(t.setCurrentState.bind(t,n)):t.setCurrentState(n)}),this},t.nextState=function(e){return function(t){var n=e[t];if(n)return n;throw new Error("Transition can not be completed - no next state")}},t.loopback=function(){return function(e){return e}}}(),function(){var e={},t=".mail-MessageSnippet-Promo";e.userpic=null,e.popup=null,e.inited=!1,e.data={title:"Кликните, чтобы<br>выбрать",content:"и выполнить действия с письмами"},e.init=function(){if(!e.animation){e.popup||(e.promoPopupHTML=Jane.tt("promo:promo-check-message",e.data),document.body.appendChild(e.promoPopupHTML),e.$popup=$(e.promoPopupHTML),e.popup=nb.$block(t));
var n=e.getUserpic();n!=e.userpic&&(e.userpic=n)}},e.check=function(){return!Daria.wizardU2709.inited&&e.shouldShow()},e.shouldShow=function(){return Daria.UISettings.shouldShowCheckboxInsideUserpic()&&e.checkMessagesCount()},e.getUserpic=function(){var e,t=ns.Model.get("scroller-messages"),n=ns.Model.get("toolbar",{layout:ns.page.current.page}).get(".fixed")?t.FIXED_TOOLBAR_HEIGHT:0,i=t.getScrollTop()+n,o=".mail-MessageSnippet-Item_userpic_and_checkbox";return Jane.ADBLOCK&&(o+=":gt(1)"),$(o).each(function(){var n=t.getNodeTop(this);
return n>=i?(e=$(this),!1):void 0}),e||$()},e.checkMessagesCount=function(){var e=ns.Model.get("messages",ns.page.current.params),t=e.getCount();return t>0},e.checkConditionsAndOpenPopup=function(){if(!e.shouldShow())return!1;var t=e.getUserpic();t.length&&t.hasClass("ui-Animation-Pop")&&e.popup.open({where:e.userpic})},e.startAnimation=function(){e.animation||(e.animation=!0,new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop"),t()},0)}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Transition"),t()
},0)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop_step1"),t()},0)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.addClass("ui-Animation-Pop_step2"),t()},250)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.removeClass("ui-Animation-Pop_step2"),t()},250)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.userpic.removeClass("ui-Animation-Pop_step1"),t()
},350)})}).then(function(){return new vow.Promise(function(t){setTimeout(function(){e.checkConditionsAndOpenPopup(),e.userpic.removeClass("ui-Animation-Transition ui-Animation-Pop"),e.animation=!1,t()},250)})}))},e.show=function(){e.shouldShow()&&(Jane.c("промо новых чекбоксов","показ промо"),e.init(),e.startAnimation())},Daria.promoCheckMessage=e}(),Jane.Promo.add({name:"promo-check-message",priority:-200,params:{ignoreCORPfilter:!0,ignoreInboxMessages:!0,ignorePromoDelay:!0,ignoreShowPromoSetting:!0,ignoreStartPromoDelay:!0,showOnlyOnce:!0},check:Daria.promoCheckMessage.check,callback:Daria.promoCheckMessage.show}),function(){var e,t,n=300,i=300,o={};
o.init=function(){var e={};e.zIndex=899;var t=new window.Atom(e);this.stripe=t,this._onPageloadBinded=this._onPageload.bind(this),t.on("show",this._onShow.bind(this)),t.on("close",this._onClose.bind(this,"Закрытие промо")),t.on("click",this._onClick.bind(this)),t.on("install",this._onInstall.bind(this)),t.init()},o._onShow=function(){ns.events.on("ns-page-before-load",this._onPageloadBinded),this._asyncResizeNotifyOnShow(),this._setMetrics(["Показ"])},o._onClose=function(e){ns.events.off("ns-page-before-load",this._onPageloadBinded),this._cancelAsyncResizeNotifyOnShow(),this._asyncResizeNotifyOnHide(),this._setMetrics([e])
},o._onPageload=function(e,t){var n=t[1];"compose2"===n.page&&(this.stripe.hide(),this._onClose("Автоскрытие промо"))},o._onClick=function(){this._setMetrics(["Клик по промо-полоске"])},o._onInstall=function(){this._setMetrics(["Установка расширения"])},o._notifyAboutResize=function(){ns.events.trigger("daria:layout-changed"),$(window).trigger("resize"),Daria.Dialog.position()},o._setMetrics=function(e){var t=["Промо-полоска DAAS"];Jane.c(t.concat(e))},o._asyncResizeNotifyOnShow=function(){e=setTimeout(function(){o._notifyAboutResize(),e=null
},n)},o._cancelAsyncResizeNotifyOnShow=function(){e&&(clearTimeout(e),e=null)},o._asyncResizeNotifyOnHide=function(){t=setTimeout(function(){o._notifyAboutResize(),t=null},i)},Jane.Promo.add({name:"yabrowser-promoline",priority:Number.POSITIVE_INFINITY,params:{ignorePromoDelay:!0,ignoreInboxMessages:!0,ignoreShowPromoSetting:!0,ignoreKCUFfilter:!0},check:function(){var e=ns.Model.get("settings").isSet("u2709")&&"compose2"!==ns.page.current.page&&Daria.is2pane()&&["RUS","TUR"].indexOf(Daria.Config.product)>-1;
return e},callback:function(){Daria.Libs("Atom",o.init.bind(o))}})}(),function(){var e={"collectors-promo":{wrapper:".b-smart-collector",process:function(){return!0},success:function(e){e.removeClass("b-smart-collector_disabled"),e.find(".b-smart-collector__block_link").addClass("g-hidden")}}};ns.action.define("collector.on",function(t,n,i,o){var s=$(o.currentTarget),r=e[n.owner],a=s.closest(r.wrapper);r.process(a)&&ns.forcedRequest([{id:"do-collector-on",params:n},{model:ns.Model.get("collectors").getMasterRequest()}]).then(function(){r.success(a)
})})}(),function(){var e,t,n,i="Промо сборщиков";n={addbutton:"Добавить ящик",button:"Кнопка",button2:"Кнопка 2",settings:"Настройки",buttondirect:"Кнопка на второй шаг",start:"Вместо бабла",all:"На всех"},ns.action.define("collectors-promo.open",function(o,s,r,a){var c={event:a,params:s};return e=c.params.form?2:1,t=c.params.from,n[t]||Jane.ErrorLog.send({collectorspromo:t}),ns.request(["collector-texts"]).then(function(){var o=["collectors","collector-settings","collector-texts"],s={email:ns.Model.get("settings").getSetting("default_email")||Daria.login+"@"+ns.Model.get("settings").getSetting("default_mailbox")};
c.params.form&&(s.form="yes"),s.from=c.params.from;var r=$(Jane.tt("promo:collectors-promo-block",{"collectors-promo":$.extend({handlersKeys:{collectors:0,"collector-settings":0,"collector-texts":0}},s)},o,{})),a="onCollectorCreateSuccess.collectors-promo",d=new Daria.Collectors.Settings(r.find("form")),l=Daria.Dialog.open({body:r,width:600,additionalClass:"b-popup_collectors-promo",onopen:function(){"all"!==t&&ns.Model.get("settings").setSettings({collectors_promo_s:Daria.now()})},onclose:function(){var e={no_collectors_bubble:!0};
"all"==t&&(e.no_collect_bubbl_all=!0),ns.Model.get("settings").setSettings(e),d.destroy(),ns.events.off(a)},oncancel:function(){Jane.c.apply(null,[i,n[t],"Закрытие попапа на шаге "+e])}});d.onFill=function(){Daria.Collectors.Settings.prototype.onFill.apply(this,arguments),l.position(!0)},d.onEmpty=function(){Daria.Collectors.Settings.prototype.onEmpty.apply(this,arguments),l.position(!0)},Jane.c.apply(null,[i,n[t],"Открыт попап"]),"button"===t&&(Jane.c(71487,"addmailbox"),Jane.ErrorLog.send({collectors_promo:"button"})),ns.events.on(a,function(e,o){Jane.c.apply(null,[i,n[t],"Cборщик создан"]),ns.Model.get("settings").setSettingOn("collect_from_promo",function(){Daria.Dialog.close(),ns.events.trigger("daria:vCollectors:showPopupAboutCreate",o),ns.forcedRequest(["do-collector-run"],{popid:o.popid})
})})}),!1}),ns.action.define("collectors-promo.toggle",function(o,s,r,a){var c={event:a,params:s},d=e;e=1===e?2:1,$(c.event.target).closest(".js-collectors-toggle").children().toggleClass("g-hidden").find("input[name=email]").focus(),Jane.c.apply(null,[i,n[t],"Переход с шага "+d+" на шаг "+e])}),ns.action.define("collectors-promo.disable",function(e,o,s,r){var a={event:r,params:o},c={no_collectors_promo:!0};return"all"==t&&(c.no_collect_promo_all=!0),ns.Model.get("settings").setSettings(c,function(){ns.events.trigger("daria:vCollectors:update"),"wizard"!==a.params.from&&Daria.Dialog.close()
}),"letter"==a.params.from?(Jane.c("message-collector","Клик на нет других ящиков"),!0):void Jane.c.apply(null,[i,n[t]||"wizard","У меня нет других ящиков"])})}(),ns.action.define("phone.getAppLink",function(e,t,n,i){var o,s={event:i,params:t};return s.event&&(o=$(s.event.currentTarget).find("[name=number]").val()),o=o||s.params.phoneNumber,o=o&&$.trim(o.replace(/(?:\(|\)|\s+|\-)/g,"")),ns.events.trigger("phone-disable-buttons"),o?o.match(/\d{10}/)?void ns.forcedRequest(["get-link-app"],{phone_full:o}).then(function(e){var t=e[0].getData();
return t?void ns.events.trigger("phone.linkSent",{number:o}):void ns.events.trigger("phone.link-sent-failure",{status:"DONTKNOWYOU"})}):void ns.events.trigger("phone.link-sent-failure",{status:"BADNUMFORMAT"}):void ns.events.trigger("phone.link-sent-failure",{status:"NONUMBER"})}),ns.action.define("phone.close",function(){Daria.phoneValidation.close(),Jane.c(Daria.phoneValidation.metrika("Клик по крестику"))}),ns.action.define("phone.revalidate",function(e,t,n,i){var o={event:i,params:t};o.params.done&&$(o.event.target).closest(".b-done__box_phone").addClass("b-done__box_phone_revalidate"),ns.action.run("passport.phone-register",{number:o.params.number||ns.Model.get("phone-register").getNumber(),revalidate:"yes",force:!0},n,i)
}),ns.action.define("phone.goBack",function(e,t,n,i){return ns.events.trigger("phone-goBack",t,n,i),!0}),ns.action.define("phone.faq",function(e,t,n,i){var o={event:i,params:t},s=$(o.event.target),r=s.offset(),a={width:550,body:'Персональные данные вы можете посмотреть в <a href="//passport.'+Daria.Config["passport-domain"]+'/" target="_blank">своём Яндекс.Паспорте</a>. О привязке телефона можно прочитать <a href="http://help.yandex.ru/mail/?id=1116749" target="_blank">здесь</a>.',side:"left",onTarget:{y:r.top+22,x:r.left+15,side:"top",pos:"right"}};
o.params.confirm&&$.extend(a,{width:450,body:'Вы запросили код для подтверждения вашего мобильного номера. С помощью телефона можно будет восстанавливать доступ к Почте, если вы забудете или потеряете пароль.<br /><br /> Просмотреть или изменить свои данные вы можете в <a href="//passport.'+Daria.Config["passport-domain"]+'/" target="_blank">Паспорте</a>. Более подробно о привязке мобильного телефона можно узнать <a href="http://help.yandex.ru/mail/?id=1116749" target="_blank">здесь</a>.'}),Daria.Dialog.open(a)
}),ns.action.define("phone.register",function(e,t,n,i){var o={event:i,params:t},s=o.event?$(o.event.target):o.params.$node;if(!(s.is("form, button, input[type=submit], input[type=button]")||"force"in o.params))return!0;var r,a=o.event?$(o.event.currentTarget):o.params.$node,c=a.find("input[name=number]").val()||"",d=function(e){Jane.c({"отправить адресату SMS-уведомление после отправки письма":e})};return c=c&&c.replace(/(?:\(|\)|\s+|\-)/g,""),ns.events.trigger("phone-registered-begin"),ns.events.trigger("phone-disable-buttons"),c?c.match(/^\+|\d{10}/)?(r=c==ns.Model.get("settings").getSetting("phone-number")?"phone.revalidate":"passport.phone-register",void ns.action.run(r,{number:c},n,i)):(d({"ввод телефона":"ошибка"}),ns.events.trigger("phone-registered-failure","BADNUMFORMAT",t,n,i),void ns.events.trigger("phone-registered-end")):(d({"клик на подтвердить телефон":"ошибка"}),ns.events.trigger("phone-registered-failure","NONUMBER",t,n,i),void ns.events.trigger("phone-registered-end"))
}),ns.action.define("phone.confirm",function(e,t,n,i){var o={event:i,params:t},s=o.event?$(o.event.target):o.params.$node;if(!(s.is("form, button, input[type=submit], input[type=button]")||"force"in o.params))return!0;var r=o.event?$(o.event.currentTarget):o.params.$node,a=$.trim(r.find("input[name=code]").val()),c=o.params.number||ns.Model.get("settings").getSetting("phone-number")||ns.Model.get("userphones").getUnconfirmedNumber()||"",d=ns.Model.get("userphones").getUnconfirmedIdByNumber(c);if(ns.events.trigger("phone-confirmed-begin"),ns.events.trigger("phone-disable-buttons"),!a)return ns.events.trigger("phone-confirmed-failure","NOCODE"),ns.events.trigger("phone-enable-buttons"),void ns.events.trigger("phone-confirmed-end");
var l={number:c,code:a};d&&(l.phoneid=d),ns.action.run("passport.phone-confirm",l,n,i)}),ns.action.define("validation.security-motivation",function(e,t,n,i){var o={event:i,params:t},s={phones:"Переход в телефоны","auxilary-emails":"Переход в дополнительные адреса"}[o.params.goal],r=Daria.phoneValidation,a=Daria.SecurityQuestionsWizard,c=Daria.timify({weeks:1}),d=r.isLessThenOneWeekAfterShow(),l=a.isLessThenAfterShow(c),h=a.isLessThenAfterShow(c,"select-as-link");d?r.motivationMetrika(s):l?(new a).motivationMetrika(s):h&&new a({experiment:"select-as-link"}).motivationMetrika(s),o.event.preventDefault();
var u=$(o.event.currentTarget),p=u.attr("href"),m=u.attr("target"),f=window.open(p,m);f.focus()}),ns.action.define("promo.gb-present-bubble-click",function(e,t){Jane.c(["ГБ за ДР","Клик на кнопку",t.gb+" год"]);var n=Daria.Dialog.$dialog,i=n.find(".js-gb-present-preloader");i.removeClass("g-hidden");var o=n.find(".js-gb-present-error-div");o.addClass("g-hidden");var s=nb.$block(".js-gb-present-button-want-present",n);return s.disable(),ns.forcedRequest(["disk-gb-present-give"]).then(function(){ns.Model.get("settings").setSettings({"gb-present-second":Daria.now()}),Jane.ErrorLog.send({type:"GB_on_Birthday",event:"without_disk_get_gb",year:"year_"+t.gb,uid:Daria.uid}),window.location="http://disk."+Jane.Config["yandex-domain"],i.addClass("g-hidden"),Daria.Dialog.close()
},function(){i.addClass("g-hidden"),s.enable(),o.removeClass("g-hidden")}),!0}),ns.action.define("promo.gb-present-link-click",function(e,t){var n=t.yearsCount;Jane.c(["ГБ за ДР","Клик на ссылку"]),Daria.Dialog.close();var i=$("<div />"),o=Jane.tt("promo:gb-present-bubble-disk-link",{});return Jane.share({el:i,title:"Моему ящику в Яндекс.Почте "+Jane.i18n.convert([n+" год",n+" года",n+" лет"],n)+", и мне подарили "+n+" ГБ на Яндекс.Диске",description:"Яндекс желает мне оставаться с ним ещё долгие годы.",link:Jane.Config["mail-url"]+"/share/birthday_gb?mdb="+n,icon:"//yastatic.net/mail/_/PDEAvKKLxSgIpti_RfhNWHoccd0.png",size:"big",serviceSpecific:{twitter:{title:"Моему ящику в Яндекс.Почте "+Jane.i18n.convert([n+" год",n+" года",n+" лет"],n)+", и мне подарили "+n+" ГБ на Яндекс.Диске"}},onclick:function(){Jane.c(["ГБ за ДР","Клик на поделяшки","После клика на ссылку",n+" год"])
},onready:function(){Daria.Dialog.open({width:500,body:o,tailPos:{top:0,left:0},onopen:function(){$(this.body).find(".b-disk-presentation-socials").append(i),Jane.c(["ГБ за ДР","Показ","После клика на ссылку",n+" год"])},oncancel:function(){$(".b-share-popup-wrap_state_visibale").addClass("b-share-popup-wrap_state_hidden"),Jane.c(["ГБ за ДР","Клик на крестик","После клика на ссылку",n+" год"])}})}}),window.open("//disk."+Jane.Config["yandex-domain"]+"/tuning","_blank"),!0}),ns.action.define("promo.traktor-theme",function(){Jane.c(["промо-полоска Трактора",'клик на кнопку "установить"']),ns.action.run("settings.update-color-scheme",{color_scheme:"traktor"}),Daria.Statusline.hide("traktor-theme-promo")
}),ns.action.define("promo.torpedo-theme",function(){Jane.c(["промо-полоска Торпедо",'клик на кнопку "установить"']),ns.action.run("settings.update-color-scheme",{color_scheme:"khl"}),ns.action.run("khl.select-skin",{skin:24,mcounter:"Тема КХЛ:фон Торпедо (Нижний Новгород)"}),Daria.Statusline.hide("torpedo-theme-promo")}),ns.action.define("promo.volgograd-theme",function(){Jane.c(["промо-полоска Волгограда",'клик на кнопку "установить"']),ns.action.run("settings.update-color-scheme",{color_scheme:"region_volgograd"}),Daria.Statusline.hide("volgograd-theme-promo")
}),ns.action.define("promo.love.go",function(){Jane.c(["14 февраля","bubble","Клик на кнопку"]),ns.page.go("#islove")}),ns.action.define("promo.disk-bubble-click",function(e,t,n,i){var o={event:i,params:t};return Jane.ErrorLog.send({event:"disk-bubble-click",uid:Daria.uid,time:Daria.now(),exp:o.params.exp}),Daria.Dialog.close(),!0}),ns.action.define("promo.change-password-click",function(e,t,n,i){var o={event:i,params:t},s=o.params&&o.params.index;return Jane.c("Поменять пароль-2","клик на «сменить пароль» вариант "+s),ns.Model.get("settings").setSettings({password_change:"2"}),Jane.ErrorLog.send({event:"promo-password-change_2_"+s}),Daria.Importantline.remove(),!0
}),ns.action.define("promo.5days-enable-setting",function(){ns.Model.get("settings").setSettings({no_reply_notify:"on"}),$(".b-promo__5days-setting-enabled").removeClass("g-hidden"),setTimeout(function(){Daria.Dialog.close()},1e3)}),ns.action.define("promo.promo-yabrowser-close",function(){Jane.c("Установка браузера","Крестик");var e=$(".b-statusline_promo-yabrowser");e.find(".b-statusline_promo-yabrowser__content_wrap").off(".yabrowser-promoline"),e.remove()}),ns.action.define("promo.promo-yabrowser-download",function(){Jane.c("Установка браузера","Скачать");
var e=$(".b-statusline_promo-yabrowser");return e.find(".b-statusline_promo-yabrowser__content_wrap").off(".yabrowser-promoline"),Daria.setZeroTimeout(function(){e.remove()}),!0}),ns.action.define("wizard.start",function(e,t){Daria.Wizard.start(t.step?t:{step:"interface"}),ns.Model.get("settings").setLastActive()}),ns.action.define("wizard.userpic-remove",function(){Daria.upicUploader.upload(null,function(){ns.events.trigger("daria:vWizardSender:userpicRemove")})}),ns.action.define("wizard.colorPicker",function(e,t){var n=t.color;
Daria.Dropdown.getCurrent().find(".b-label").attr({style:"background:"+n,"data-params":"color="+n.replace("#","")}),$(document).trigger("b-mail-dropdown-closeall")}),ns.action.define("wizard.done",function(){Daria.Dialog.close(),ns.Model.get("settings").setLastActive(),Daria.Wizard.saveEndSetting()}),ns.action.define("wizard.changeStep",function(e,t){ns.events.trigger("daria:vWizardDone:changeStep",t.to)}),ns.action.define("wizard.open-inline-block",function(){Daria.InlineWizard.open(null,1)}),ns.action.define("wizard.close-inline-block",function(){Daria.InlineWizard.close()
}),ns.action.define("wizard.close-inline-wizard",function(){Daria.InlineWizard.close()}),ns.action.define("wizard.step-inline-block",function(e,t){Daria.InlineWizard.step(t.step)}),ns.action.define("wizard.end-inline-block",function(){Daria.InlineWizard.end()}),ns.action.define("user-feedback.send",function(){ns.events.trigger("daria:vUserFeedbackReport:send")}),ns.action.define("user-feedback.next",function(e,t,n,i){var o={event:i,params:t};ns.events.trigger("daria:vUserFeedbackReport:changeStep",Number(o.params.step)+1)
}),ns.action.define("user-feedback.prev",function(e,t,n,i){var o={event:i,params:t};ns.events.trigger("daria:vUserFeedbackReport:changeStep",Number(o.params.step)-1)}),ns.action.define("user-feedback.pseudo",function(e,t,n,i){var o={event:i,params:t};o.event.preventDefault()}),ns.layout.define("wizard",{wizard:{"wizard-intro":{},"wizard-interface":{},"wizard-sender":{},"wizard-labels":{},"wizard-collector":{},"wizard-collector-create":{},"wizard-done":{}}}),ns.layout.define("welcome-wizard-popup",{"welcome-wizard-popup":{"welcome-wizard":function(){var e=ns.Model.get("wizard-state",{wizard_name:"welcome"}),t=Daria.WelcomeWizard.getSteps(),n={"welcome-wizard-theme-step":{"welcome-wizard-themes-selector-wrapper":{"themes-selector-box@":function(){var e={},t=ns.Model.get("themes").get(".themes.*.settings");
return t.forEach(function(t){e[t]={}}),{"themes-selector":e}}}}};return e.setSteps(t),_.zipObject(t,t.map(function(e){return n[e]||{}}))}}}),ns.layout.define("wizard-inline",{"inline-wizard":function(e){return Daria.InlineWizard.getAvailableSteps(e)}}),ns.layout.define("user-feedback",{"user-feedback":{"user-feedback-box@":function(e){return e.report?{"user-feedback-report":{}}:void 0}}}),ns.layout.define("promo-mobile-app-popup",{"promo-mobile-app-popup":{"promo-mobile-app-popup-body":{}}}),ns.Model.define("disk-gb-present"),ns.Model.define("disk-gb-present-give"),function(){ns.Model.define("userinfo",{methods:no.extend({get:function(e){return this._exec(e||{},!0)
},hasHint:function(){return this.get().then(_.property("hasHint"))}},Jane.PromiseHandlerMixin)})}(),ns.Model.define("wizard-state",{params:{wizard_name:null},events:{"ns-model-init":"_onInit"},methods:{_activeStepIndex:-1,_onInit:function(){var e={activeStep:null,isTransitionLocked:!1,steps:[],stepShownFlags:{},firstLoad:!0};e.nonActiveSteps=["welcome-wizard-intro-step","welcome-wizard-done-step"],this.setData(e)},setSteps:function(e){this.set(".steps",e)},getSteps:function(){return this.get(".steps")
},reset:function(){var e=this.get(".steps");this.set(".stepShownFlags",_.zipObject(e,e.map(function(){return!1})),{silent:!0}),this._setActiveStep(this.get(".steps")[0])},setStep:function(e){return this.get(".isTransitionLocked")?!1:this._setActiveStep(e)},getStepWasShown:function(e){return this.get(".stepShownFlags."+e)},_setActiveStep:function(e){var t=this.get(".steps"),n=t.indexOf(e),i=this.getActiveStep();return 0>n?(Daria.DEBUG&&console.warn("WelcomWizard:","step not found "+e),!1):(this._activeStepIndex=n,this.set(".stepShownFlags."+e,!0,{silent:!0}),this.set(".prevActiveStep",i,{silent:!0}),this.set(".activeStep",e),!0)
},goToPrevStep:function(){var e=this.getPrevStep();return e?(this.setStep(e),e):null},goToNextStep:function(){var e=this.getNextStep();return e?(this.setStep(e),e):(this.complete(),null)},isLastStep:function(e){var t=this.get(".steps");return t.indexOf(e)===t.length-1},complete:function(){this.trigger("daria:wizard:complete")},getPrevStep:function(){var e=this.get(".steps");return e[this._activeStepIndex-1]},getNextStep:function(){var e=this.get(".steps");return e[this._activeStepIndex+1]},getActiveStep:function(){return this.get(".activeStep")
},getPrevActiveStep:function(){return this.get(".prevActiveStep")},isTransitionLocked:function(){return this.get(".isTransitionLocked")},lockTransition:function(){this.set(".isTransitionLocked",!0)},unlockTransition:function(){this.set(".isTransitionLocked",!1)},isFirstLoad:function(){return this.get(".firstLoad")},firstLoadDone:function(){this.set(".firstLoad",!1,{silent:!0})}}},ns.ModelStatic),function(){var e=Daria.supplant;Daria.HandlerTrackManagerMixin=function(e){this.eventNamespace=e,this.trackIds={}
};var t=24e5,n=/[^0-9]/g,i=Daria.HandlerTrackManagerMixin.prototype;i._validNumber=function(e){return String(e).replace(n,"")},i.getTrackId=function(e){return e=this._validNumber(e),this.trackIds[e].trackId},i.getTrackIdExpireDate=function(e){return e=this._validNumber(e),this.trackIds[e].expireDate},i.getResendCodeTimeout=function(e){return e=this._validNumber(e),1e3*this.trackIds[e].denyResendUntil-Daria.now()},i.setTrackId=function(n,i,o){n=this._validNumber(n);var s=this;this.trackIds[n]={trackId:i,expireDate:Daria.now()+t},o&&(this.trackIds[n].denyResendUntil=o),setTimeout(function(){var t=e("{eventNamespace}.{trackId}-expired",{eventNamespace:s.eventNamespace,trackId:i});
s.trigger(t,{name:"track_expired"})},t)},i.updateTrackId=function(e,t,n){e=this._validNumber(e),this.trackIds[e].denyResendUntil=n},i.isTrackExpired=function(e){return this.getTrackIdExpireDate(e)<Daria.now()},i.onTrackIdExpired=function(t,n){var i=e("{eventNamespace}.{trackId}-expired",{trackId:this.getTrackId(t),eventNamespace:this.eventNamespace});this.once(i,n)},i.offTrackIdExpired=function(t,n){var i=e("{eventNamespace}.{trackId}-expired",{trackId:this.getTrackId(t),eventNamespace:this.eventNamespace});
this.off(i,n)}}(),function(){var e={};$.extend(e,Jane.PromiseHandlerMixin),e.check=function(e){var t=e.replace("+","");return this._exec({login:t})},ns.Model.define("alias-exist",{methods:e})}(),function(){var e={};$.extend(e,Jane.PromiseHandlerMixin);var t=Daria.supplant,n=new Daria.HandlerTrackManagerMixin(e.name);$.extend(e,n),e._checkSuccessResult=function(e){return"ok"===e.status},e._parse=function(e){return e.deny_resend_until&&(e.deny_resend_until=parseInt(e.deny_resend_until,10)),e},e.submit=function(e){return this._exec({number:e,method:"submit"}).then(this.onsubmit.bind(this))
},e.onsubmit=function(e){var t=e.number.original,n=e.track_id,i=e.deny_resend_until;return this.setTrackId(t,n,i),e},e.resend=function(e){return this._exec({trackId:this.getTrackId(e),number:e,method:"submit"}).then(this.onresend.bind(this))},e.onresend=function(e){var t=e.number.original,n=e.track_id,i=e.deny_resend_until;return this.updateTrackId(t,n,i),e},e.commit=function(e,n,i){var o=this.getTrackId(e);if(!o){var s="No trackId for phone with number {number}";throw new Error(t(s,{number:e}))}var r={number:e,code:n,password:i,trackId:o,method:"commit"};
return this._exec(r)},ns.Model.define("aliasify-bind",{params:{number:null,method:null},methods:e})}(),function(){var e={};$.extend(e,Jane.PromiseHandlerMixin);var t=new Daria.HandlerTrackManagerMixin(e.name);$.extend(e,t),e._checkSuccessResult=function(e){return"ok"===e.status},e.submit=function(){return this._exec({method:"submit"}).then(this.onsubmit.bind(this))},e.onsubmit=function(e){var t=e.number.original,n=e.track_id,i=e.deny_resend_until;return this.setTrackId(t,n,i),e},e.resend=function(e){return this._exec({trackId:this.getTrackId(e),method:"submit"}).then(this.onresend.bind(this))
},e.onresend=function(e){var t=e.number.original,n=e.track_id,i=e.deny_resend_until;return this.updateTrackId(t,n,i),e},e.commit=function(e,t){var n=this.getTrackId(e);if(!n)throw new Error("No trackId found");var i={code:t,trackId:n,method:"commit"};return this._exec(i)},ns.Model.define("aliasify-bound",{params:{number:null,method:null},methods:e})}(),function(){var e={};$.extend(e,Jane.PromiseHandlerMixin),e.get=function(e){return this._exec({trackId:e})},ns.Model.define("track-info",{methods:e})
}(),function(){var e=Daria.supplant;Daria.HandlerTrackManagerMixin=function(e){this.eventNamespace=e,this.trackIds={}};var t=24e5,n=/[^0-9]/g,i=Daria.HandlerTrackManagerMixin.prototype;i._validNumber=function(e){return String(e).replace(n,"")},i.getTrackId=function(e){return e=this._validNumber(e),this.trackIds[e].trackId},i.getTrackIdExpireDate=function(e){return e=this._validNumber(e),this.trackIds[e].expireDate},i.getResendCodeTimeout=function(e){return e=this._validNumber(e),1e3*this.trackIds[e].denyResendUntil-Daria.now()
},i.setTrackId=function(n,i,o){n=this._validNumber(n);var s=this;this.trackIds[n]={trackId:i,expireDate:Daria.now()+t},o&&(this.trackIds[n].denyResendUntil=o),setTimeout(function(){var t=e("{eventNamespace}.{trackId}-expired",{eventNamespace:s.eventNamespace,trackId:i});s.trigger(t,{name:"track_expired"})},t)},i.updateTrackId=function(e,t,n){e=this._validNumber(e),this.trackIds[e].denyResendUntil=n},i.isTrackExpired=function(e){return this.getTrackIdExpireDate(e)<Daria.now()},i.onTrackIdExpired=function(t,n){var i=e("{eventNamespace}.{trackId}-expired",{trackId:this.getTrackId(t),eventNamespace:this.eventNamespace});
this.once(i,n)},i.offTrackIdExpired=function(t,n){var i=e("{eventNamespace}.{trackId}-expired",{trackId:this.getTrackId(t),eventNamespace:this.eventNamespace});this.off(i,n)}}(),function(){var e=["Фамилия вашего любимого учителя","Фамилия вашего первого молодого человека или девушки","Фамилия вашего любимого музыканта","Фамилия вашего любимого актёра","Имя вашей первой мягкой игрушки","Улица, на которой вы жили после того, как переехали от родителей","Модель вашей первой машины","Ваша любимая книга в детстве","Название вашей любимой спортивной команды","Название улицы, на которой вы выросли","Ваш любимый киногерой","Кодовая последовательность","Постер, который висел в вашей комнате","Ваша первая игровая приставка","Что вы коллекционировали в детстве","Ваш любимый мультфильм в детстве","Ваша любимая компьютерная игра","Ваш самый любимый предмет в школе","Ваш самый нелюбимый предмет в школе","Кем вы хотели стать в детстве","В каком классе вы впервые влюбились"];
ns.Model.define("security-questions-patterns",{events:{"ns-model-init":function(){this.setData({data:e})}},methods:{getAll:function(){return this.getCache()}}})}(),ns.View.define("user-feedback",{events:{"daria:vUserFeedback:update@show":"onUpdate"},yateModule:"promo",methods:{onUpdate:function(e,t){return this.updateWithParams(t)},updateWithParams:function(e){var t=no.extend({},this.params,e);return this.updateByLayout("user-feedback",t,{execFlag:ns.U.EXEC.PARALLEL})}}}),function(e,t){function n(e){var n=ns.Model.get("compose-message"),i=e.pgUser?"[NEWFORM-PG] ":"[NEWFORM] ",o={to:c,subj:i+e.selectValue};
o.send=e.message+"\n\n----\nLogin: "+t.login+"\nBrowser: "+navigator.userAgent+"\nAddress: "+t.Config.userIP+"\nReferer: new form",e.attachmentIds&&(o.att_ids=e.attachmentIds),e.messageId&&(o.ids=e.messageId),o["recipients-diff"]={added:[],removed:[]},n.setData(o)}function i(e,t,n){var i=document.createElement("canvas");return i.width=t,i.height=n,i.getContext("2d").drawImage(e,0,0,t,n),i}function o(){t.Dialog.$dialog&&6===t.Dialog.$dialog.data("step")&&t.Dialog.close()}function s(e,t){t=t||"";for(var n=1024,i=atob(e),o=i.length,s=Math.ceil(o/n),r=new Array(s),a=0;s>a;++a){for(var c=a*n,d=Math.min(c+n,o),l=new Array(d-c),h=c,u=0;d>h;++u,++h)l[u]=i[h].charCodeAt(0);
r[a]=new Uint8Array(l)}return new Blob(r,{type:t})}var r=26214400,a=15,c="mail@support.yandex.ru";ns.View.define("user-feedback-report",{events:{"ns-view-htmlinit":"onhtmlinit","ns-view-htmldestroy":"onhtmldestroy","daria:vUserFeedbackReport:changeStep":"onChangeStep","daria:vUserFeedbackReport:send":"send","keyup .js-kbd-report":"validationForm","change .js-feedback-file":"addFile","click .js-feedback-remove-file":"removeFile","click .js-feedback-take-screenshot":"takeScreenshot","click .js-feedback-remove-screenshot":"removeScreenshot"},"params+":{canAttachEml:null,canTakeScreenshot:null,text:null,pgUser:null,onlyReport:null},yateModule:"promo",methods:{onhtmlinit:function(){var e=this,t=this.$node;
this._attachments=[],this.$node=t,this.$form=t.find(".js-feedback-form"),this.$steps=t.find(".js-feedback-step"),this.$files=t.find(".js-feedback-attachments"),this.$filesView=t.find(".js-feedback-files"),this.$screenshotContainer=t.find(".js-feedback-screenshot"),this.$inputs=t.find(".js-kbd-report"),this.$screenshotView=t.find(".js-feedback-attach-screen"),this.$screenshotLoader=t.find(".js-feedback-screenshot-loader"),this.$select=t.find(".js-feedback-change-theme-select"),this.$fileInpTemplate=t.find(".js-feedback-file").clone(!0),nb.init(this.node),this.nbNextButtons=[],t.find(".js-feedback-next").each(function(){e.nbNextButtons.push(nb.block(this))
}),this.nbChangeThemesSelect=nb.$block(".js-feedback-change-theme-select",t),this.nbChangeThemesSelect.on("nb-changed",e.validationForm.bind(e))},onhtmldestroy:function(){nb.destroy(this.$select)},validationForm:function(e){var t=this.nbChangeThemesSelect.getState().value;"nb-changed"!==e&&(this._message=e.target.value,this.$inputs.not(e.target).val(this._message)),this._message&&"changethemes"!==t?(this.nbNextButtons[0].enable(),this.nbNextButtons[2].enable()):(this.nbNextButtons[0].disable(),this.nbNextButtons[2].disable())
},takeScreenshot:function(){e.c("ФОС","Шаг 5","Cнимок экрана"),this.$screenshotView.addClass("feedback-attach-not-empty"),this.$screenshotLoader.removeClass("g-hidden");var n=this;t.Libs("html2canvas",function(){var e=$("<div>").css({position:"absolute",top:0,left:0,width:"100%","min-height":"720px"}),t=$(".mail-App:visible");e.append(t.clone()),$(document.body).append(e),t.hide(),html2canvas(e[0],{onrendered:function(o){t.show(),e.remove();var s=i(o,100,100);n.$screenshotContainer.append($("<img>").addClass("feedback-screenshot-preview").attr("src",s.toDataURL())).append($("<span>").addClass("feedback-attach-item-del js-feedback-remove-screenshot")),n.screenshotDataURL=o.toDataURL("image/png"),n.$screenshotLoader.addClass("g-hidden")
}})})},removeScreenshot:function(){delete this.screenshotDataURL,this.$screenshotContainer.empty(),this.$screenshotView.removeClass("feedback-attach-not-empty")},redrawFiles:function(){for(var t=[],n=!1,i=0;i<this._attachments.length;++i){var o=this._attachments[i],s="";if(o.info.file)s=o.info.file.name;else{var r=$(o.info.input).val();s=/[^\\/]*$/.exec(r)[0]}var a="",c=/^(.*)(\.[^.]*)$/.exec(s);c&&(s=c[1],a=c[2]),t.push({name:s,ext:a,overlimit:o.isOverLimit,id:i}),n=o.isOverLimit||n}this.$filesView.html(e.tt("promo:user-feedback-report-attachments",{atts:t,"overlimit-mode":n})),$(".js-feedback-attach-files").toggleClass("feedback-attach-not-empty",this._attachments.length>0)
},addFile:function(n){var i=this;e.c("ФОС","Шаг 5","Загрузить файл"),e.Services.load("#compose",function(){var e=n.target,o=$(e).parent(),s=ns.Model.get("compose-message");if(Modernizr.filereader){$.each(e.files,function(){i._attachments.push(new t.Attachment2({file:this,type:"simple",mComposeMessage:s}))});var a=0;i._attachments.forEach(function(e){a+e.info.file.size>r?e.isOverLimit=!0:(e.isOverLimit=!1,a+=e.info.file.size)}),$(e).remove()}else{var c=new t.Attachment2({input:e,type:"simple",mComposeMessage:s});
c.isOverLimit=!1,i._attachments.push(c)}o.prepend(i.$fileInpTemplate.clone(!0)),i.redrawFiles()})},removeFile:function(e){var t=$(e.target).data("fileid");this._attachments.splice(t,1),this.redrawFiles()},send:function(){t.Dialog.$dialog.addClass("feedback-no-header"),this.setStep("sending");var e=[];this._attachments.forEach(function(t){t.isOverLimit||e.push(t.upload())}),this.screenshotDataURL&&e.push(this.uploadScreenshot()),$.when.apply(null,e).done(this._sendMessage.bind(this))},_sendMessage:function(){var i=this;
e.Services.load("#compose",function(){ns.request(["compose-message"]).then(function(){var e=ns.Model.get("compose-message");n({message:i._message,text:i.params.text,selectValue:i.nbChangeThemesSelect.getState().text,messageId:i.$node.find(".js-attach-eml input").is(":checked")?ns.page.current.params.ids:null,attachmentIds:$.map(i._attachments,function(e){return e.info.att_id}),pgUser:i.params.pgUser}),e.send({force:!0}).then(function(){i.setStep("done"),t.Statusline.hide(),setTimeout(o,1e3*a)})})
})},setStep:function(n){isNaN(n)||(t.Dialog.$dialog.data("step",n+3),e.c("ФОС","Шаг "+(n+3),"Показ шага")),"done"===n&&e.c("ФОС","Шаг 7","Показ шага"),this.$steps.addClass("g-hidden"),this.$node.find(".js-feedback-step-"+n).removeClass("g-hidden")},uploadScreenshot:function(){var n=this,i=$.Deferred();return e.Services.load("#compose",function(){var e=n.screenshotDataURL.split(","),o=new t.Attachment2({name:"screenshot.png",type:"simple",file:s(e[1],"image/png"),mComposeMessage:ns.Model.get("compose-message")});
n._attachments.push(o),o.upload().always(function(){i.resolve()})}),i},onChangeStep:function(e,t){this.setStep(t)}}})}(Jane,Daria),ns.View.define("wizard-step-mixin",{methods:{stepName:null,isShown:!1,_goToNextStepDelay:1e3,getWizardStateModel:function(){return ns.Model.get("wizard-state",this.params)},initWizardStep:function(){this.onStepAnimationStartBinded=this.onStepAnimationStart.bind(this),this.onStepAnimationEndBinded=this.onStepAnimationEnd.bind(this),this.onDotNavigationBinded=this.onDotNavigation.bind(this),this.onPopupClosedBinded=this.onPopupClosed.bind(this)
},startWizardStep:function(){this.getWizardStateModel().on("daria:WelcomeWizard:stepAnimationStart",this.onStepAnimationStartBinded),this.getWizardStateModel().on("daria:WelcomeWizard:stepAnimationEnd",this.onStepAnimationEndBinded),this.getWizardStateModel().on("daria:WelcomeWizard:dotNavigation",this.onDotNavigationBinded),ns.events.on("daria:WelcomeWizard:closed",this.onPopupClosedBinded)},stopWizardStep:function(){this._clearChangeStepTimer(),this.getWizardStateModel().off("daria:WelcomeWizard:stepAnimationStart",this.onStepAnimationStartBinded),this.getWizardStateModel().off("daria:WelcomeWizard:stepAnimationEnd",this.onStepAnimationEndBinded),this.getWizardStateModel().off("daria:WelcomeWizard:dotNavigation",this.onDotNavigationBinded),ns.events.off("daria:WelcomeWizard:closed",this.onPopupClosedBinded)
},onStepAnimationStart:function(e,t,n){if(this.stepName===t){if(!this.isShown)return;this.isShown=!1,this.onStepHideStart(!1)}if(this.stepName===n){if(this.isShown)return;this.isShown=!0,this.onStepShowStart()}},onStepAnimationEnd:function(e,t,n){this.stepName===t&&this.onStepHidden(!1),this.stepName===n&&this.onStepShown()},goToPrevStep:function(){this._clearChangeStepTimer(),this.getWizardStateModel().goToPrevStep()},goToNextStep:function(e){this._clearChangeStepTimer(),this._changeStepTimer=setTimeout(function(){this._clearChangeStepTimer(),this.getWizardStateModel().goToNextStep()
}.bind(this),e||0)},goToNextStepWithDelay:function(){this.goToNextStep(this._goToNextStepDelay)},disableStep:function(){this.$fieldset||(this.$fieldset=this.$node.closest("fieldset")),this.$fieldset.attr("disabled",!0);var e=nb.$block(this.$fieldset.find("button[type=submit]"));e&&e.disable()},enableStep:function(){this.$fieldset||(this.$fieldset=this.$node.closest("fieldset")),this.$fieldset.attr("disabled",!1);var e=nb.$block(this.$fieldset.find("button[type=submit]"));e&&e.enable()},onStepShowStart:function(){},onStepShown:function(){},onStepHideStart:function(){},onStepHidden:function(){},isLastStep:function(){return this.getWizardStateModel().isLastStep(this.stepName)
},isActive:function(){return this.isShown},onPopupClosed:function(){this.onStepHideStart(!0),this.onStepHidden(!0),this._clearChangeStepTimer()},onDotNavigation:function(e,t){this.stepName===t&&this.onStepSkipped()},onStepSkipped:function(){},getContinueButtonText:function(e){return this.isLastStep()?"Начать работу":e},toggleEnabled:function(e,t){t?e.enable():e.disable()},_clearChangeStepTimer:function(){this._changeStepTimer&&(clearTimeout(this._changeStepTimer),this._changeStepTimer=null)}}}),ns.View.define("welcome-wizard-intro-step",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-next-step":"onGoToNextStepClick"},params:function(){var e={wizard_name:"welcome"};
return e},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-intro-step",onShow:function(){this.startWizardStep()},onHide:function(){this.stopWizardStep()},onGoToNextStepClick:function(){this.goToNextStep()}}},"wizard-step-mixin"),ns.View.define("welcome-wizard-collectors-step",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-htmldestroy":"onHtmlDestroy","click .js-go-to-next-step":"onGoToNextStepClick","submit .js-collector-create-form":"onCollectorCreateFormSubmit","onCollectorCreateDidFail.welcome-wizard-collectors-step@show":"onCollectorCreateFail","onCollectorCreateSuccess.welcome-wizard-collectors-step@show":"onCollectorCreateSuccess","daria:CollectorSettings:form-type-changed@show":"onFormTypeChanged"},models:{"collector-texts":!1,"collector-create-form-state":{"ns-model-changed":"keepValid","ns-model-changed.state":"onCollectorCreateFormStateChangedState","ns-model-changed.advanced":"onChangedAdvanced"}},params:function(){var e={wizard_name:"welcome"};
return e},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-collectors-step",onHtmlInit:function(){this.$collectorCreateForm=this.$node.find(".js-collector-create-form"),this.$collectorCreateFormFieldset=this.$node.find(".js-collector-create-form-fieldset"),this.settings=new Daria.Collectors.Settings(this.$collectorCreateForm),this.$collectorCreateButtons=this.$node.find(".js-collector-create-buttons"),this.$collectorCreateStatusLoading=this.$node.find(".js-collector-create-status-loading"),this.$collectorCreateStatusDone=this.$node.find(".js-collector-create-status-done"),this.nbCollectorCreateButton=nb.$block(".js-collector-create",this.node)
},onHtmlDestroy:function(){this.settings&&this.settings.destroy()},onShow:function(){this.startWizardStep(),this.onCollectorCreateFormStateChangedState(),this.getModel("collector-create-form-state").resetState()},onHide:function(){this.stopWizardStep()},onStepShowStart:function(){this.setCollectorsMetrics(["Показ"]),this.onCollectorCreateFormStateChangedState()},onStepHidden:function(e){this.disableStep(),this.disableStepForm(),e&&this.isActive()&&this.setCollectorsMetrics(["Закрыть"])},onStepSkipped:function(){this.setCollectorsMetrics(["Пропустить"])
},disableStepForm:function(){this.$collectorCreateFormFieldset.attr("disabled",!0)},enableStepForm:function(){this.$collectorCreateFormFieldset.attr("disabled",!1)},onGoToNextStepClick:function(e){e.preventDefault();var t=this.getModel("collector-create-form-state"),n=Daria.EnumCollectorCreateFormState.SUCCESS;(!this.isLastStep()||t.getState()!==n&&t.canRetry())&&this.setCollectorsMetrics(["Пропустить"]),this.goToNextStep()},onCollectorCreateFormSubmit:function(e){e.preventDefault(),this.createCollector(this.$collectorCreateForm)
},createCollector:function(e){var t=this.id;if(e.data("settings").validate()){var n=this;ns.request(["collectors"]).then(function(i){var o=i[0];o.getCount()<10?(Daria.Collectors.Creator.run(e,t),n.setCollectorsMetrics(["Подключить ящик"]),n.onCollectorCreateSendRequest()):Daria.Dialog.notice({title:"Внимание",body:"<p>Можно создать не более 10 сборщиков почты. Чтобы создать новый сборщик, сначала удалите один из старых.</p>"})}).fail(this.onCollectorCreateFail,this)}},onCollectorCreateSendRequest:function(){this.getModel("collector-create-form-state").onRequesting()
},onCollectorCreateFail:function(){var e=this.getModel("collector-create-form-state");e.onFailure(),e.canRetry()||e.onTriesExceeded()},onCollectorCreateFormStateChangedState:function(){var e=this.getModel("collector-create-form-state"),t=e.getState(),n=Daria.EnumCollectorCreateFormState;switch(t){case n.INITIAL:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.enableStepForm();
break;case n.FAILURE:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.setCollectorsMetrics(["Ошибка при подключении"]),this.enableStep(),this.enableStepForm();break;case n.TRIES_EXCEEDED:this.$collectorCreateButtons.toggleClass("is-hidden",!1),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.disableStepForm(),this.toggleEnabled(this.nbCollectorCreateButton,!1),_.defer(Daria.Collectors.Checker.onCollectorCheckTriesExceeded,this.$collectorCreateForm[0],"create");
break;case n.REQUESTING:this.$collectorCreateButtons.toggleClass("is-hidden",!0),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!1),this.$collectorCreateStatusDone.toggleClass("is-hidden",!0),this.enableStep(),this.disableStepForm();break;case n.SUCCESS:this.$collectorCreateButtons.toggleClass("is-hidden",!0),this.$collectorCreateStatusLoading.toggleClass("is-hidden",!0),this.$collectorCreateStatusDone.toggleClass("is-hidden",!1),this.enableStep(),this.disableStepForm(),e.shouldGoNextWithDelay()&&!this.isLastStep()&&(e.unsetShouldGoNextWithDelay(),this.goToNextStepWithDelay())
}},onCollectorCreateSuccess:function(){this.getModel("collector-create-form-state").onSuccess(),this.setCollectorsMetrics(["Ящик успешно подключен"])},onFormTypeChanged:function(e,t){this.getModel("collector-create-form-state").setIfChanged(".advanced",t)},onChangedAdvanced:function(){this.setCollectorsMetrics(["Показ"])},setCollectorsMetrics:function(e){var t=["Приветственный визард","Сборщики"],n=this.getModel("collector-create-form-state");t.push(n.isAdvancedForm()?"Все письма вместе (не знаем домен)":"Все письма вместе (знаем домен)"),Jane.c(t.concat(e))
}}},"wizard-step-mixin"),ns.View.define("welcome-wizard-done-step",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-prev-step":"onGoToPrevStepClick"},params:function(){var e={wizard_name:"welcome"};return e},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-done-step",onShow:function(){this.startWizardStep()},onHide:function(){this.stopWizardStep()},onGoToPrevStepClick:function(){this.goToPrevStep()}}},"wizard-step-mixin"),ns.View.edefine("welcome-wizard-mobile-app-step",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-get-mobile-app-link-skip":"skipStep","click .js-get-mobile-app-link-continue":"continueWizard","click .js-close-wizard":"closeWizard"},params:function(){var e={wizard_name:"welcome",promo:"welcome-wizard"};
return e},yateModule:"promo",ctor:function(){this.initWizardStep()},methods:{stepName:"welcome-wizard-mobile-app-step",onHtmlInit:function(){this.initPromoMobileAppMixin()},onShow:function(){this.startWizardStep()},onStepShown:function(){this._loadState(),this.setMobileMetrics(["Показ"]),this.enableStep()},onStepHidden:function(e){this.getState().resetErrorMessages(),this._loadState(),this.disableStep(),e&&this.isActive()&&this.setMobileMetrics(["Закрыть"])},onStepSkipped:function(){this.setMobileMetrics(["Пропустить"])
},onHide:function(){this.stopWizardStep()},disableStepForm:function(){this.toggleEnabled(this.nbPhoneNumber,!1),this.toggleEnabled(this.nbGetAppLinkButton,!1)},enableStepForm:function(){this.toggleEnabled(this.nbPhoneNumber,!0),this.toggleEnabled(this.nbGetAppLinkButton,!0)},_loadState:function(){var e=this.getState(),t=e.isEnterPhoneState(),n=e.isInvalidPhoneNumberState(),i=e.isSendingState(),o=e.isSendFailedState(),s=e.isSendSuccessState(),r=t&&e.canRetry(),a=n,c=!a&&o&&e.canRetry(),d=o&&!e.canRetry();
this.$node.find(".js-buttons-send").toggleClass("is-hidden",!r),this.$node.find(".js-error-message-phone-number").toggleClass("is-invisible",!a),this.$node.find(".js-buttons-sending").toggleClass("is-hidden",!i),this.$node.find(".js-error-message-send-failed").toggleClass("is-invisible",!c),this.$node.find(".js-buttons-continue").toggleClass("is-hidden",!d),this.$node.find(".js-send-success").toggleClass("is-hidden",!s),r?this.enableStepForm():this.disableStepForm(),(t||n)&&!this.nbPhoneNumber.getValue()&&this.isActive()&&_.defer(function(){this.nbPhoneNumber.focus()
}.bind(this)),s&&(ns.Model.get("settings").setSettings({"promo-mobile_sms-send":!0,"promo-mobile_sms-send_date":Daria.now()}),e.shouldGoNextWithDelay()&&!this.isLastStep()&&(e.unsetShouldGoNextWithDelay(),this.goToNextStepWithDelay()))},sendMobileAppLink:function(){var e=this.getState();if(!e.canTrySendAppLink()||!e.canRetry())return void(e.isInvalidPhoneNumberState()&&this.nbPhoneNumber.focus());var t=this._getPhoneNumber();if(!t||!Jane.FormValidation.checkPhoneNumber(t))return e.setInvalidPhoneNumberState(),void this.nbPhoneNumber.focus();
this.setMobileMetrics(this.getActivePhoneNumber()?["Получить ссылку","Номер введен при регистрации (автозаполнение)"]:["Получить ссылку","Номер введен вручную успешно"]),e.startSending();var n={app:"mail-start-wizard-liza",phone_full:t},i=this;ns.forcedRequest(["get-link-app"],n).then(function(t){var n=t[0].getData();return n&&"ok"===n.result?(e.onSuccess(),void i.setMobileMetrics(["Получить ссылку","Сообщение отправлено"])):(e.onSendFailed(),void i.setMobileMetrics(["Получить ссылку","Ошибка при отправке"]))
}).fail(function(){e.onSendFailed(),i.setMobileMetrics(["Получить ссылку","Ошибка при отправке"])})},applyPhoneNumberFormat:function(e){return this.cleanPhoneNumber(e)},skipStep:function(e){e.preventDefault(),this.setMobileMetrics(["Пропустить"]),this.goToNextStep()},continueWizard:function(e){e.preventDefault(),this.isLastStep()||this.setMobileMetrics(["Пропустить"]),this.goToNextStep()},closeWizard:function(e){e.preventDefault(),this.goToNextStep()},setMobileMetrics:function(e){var t=["Приветственный визард","Мобильная почта"];
Jane.c(t.concat(e))}}},"wizard-step-mixin","promo-mobile-app-mixin",ns.View),ns.View.define("welcome-wizard-theme-step",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-submit":"onSubmitClick","click .js-skip":"onSkipClick","mousedown .js-theme-thumbnail":"onThemeThumbClick"},models:{settings:{"ns-model-changed":"onSettingsChanged"}},params:function(e){return _.extend({wizard_name:"welcome"},e)},yateModule:"promo",ctor:function(){this.initWizardStep()
},methods:{stepName:"welcome-wizard-theme-step",onHtmlInit:function(){this._defaults||(this._defaults=this._getCurrentSettings())},onShow:function(){this.startWizardStep()},onStepShown:function(){this.setThemeMetrics(["Показ"])},onThemeThumbClick:function(){this.setThemeMetrics(["Клик по теме"])},onHide:function(){this.stopWizardStep()},onStepSkipped:function(){this.setThemeMetrics(["Пропустить"])},onSubmitClick:function(e){e.preventDefault(),this._defaults=this._getCurrentSettings(),this.setThemeMetrics(["Продолжить"]),this.goToNextStep()
},onSkipClick:function(e){e.preventDefault(),this.setThemeMetrics(["Пропустить"]),this.goToNextStep()},onSettingsChanged:function(e,t){var n=this._getSettingsDiffInfo().diff,i=t.replace(/^\./,"");i in n?this._redraw():this.keepValid()},onStepHidden:function(e){var t=this;e&&this.isActive()&&this.setThemeMetrics(["Закрыть"]);var n=ns.Model.get("settings"),i=this._getSettingsDiffInfo(),o=i.diff;if(i.isDirty){n.setSettings(o,function(){t._defaults=t._getCurrentSettings(),t._redraw()}),o.color_scheme&&n.trigger("daria:vWelcomeWizardThemeStep:setTheme",this._defaults.color_scheme);
var s=ns.Model.get("theme-"+this._defaults.color_scheme);s.setCurrentSkin(s.getSkinParams()),ns.page.go()}},_getCurrentSettings:function(){var e=ns.Model.get("settings"),t=["color_scheme","colorful-theme-skin","seasons-modifier","geoid"];return t.reduce(function(t,n){return t[n]=e.getSetting(n),t},{})},_compareCurrentSettings:function(e){var t=this._getCurrentSettings();return Object.keys(e).reduce(function(n,i){return e[i]!==t[i]&&(n[i]=e[i]),n},{})},_getSettingsDiffInfo:function(){if(!this._defaults)return{isDirty:!1,diff:{}};
var e=this._compareCurrentSettings(this._defaults);return{isDirty:Object.keys(e).length>0,diff:e}},_redraw:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},isDirty:function(){return this._getSettingsDiffInfo().isDirty},getSubmitButtonText:function(){return this.isDirty()?"Сохранить":"Продолжить"},setThemeMetrics:function(e){var t=["Приветственный визард","Темы"];Jane.c(t.concat(e))}}},"wizard-step-mixin"),ns.View.define("welcome-wizard-themes-selector-wrapper",{events:{"daria:vThemesSelector:new-schema@show":"updateSubviews"},params:function(e){return e
},models:{settings:{"ns-model-changed":"filteredUpdateSubviews"}},yateModule:"promo",methods:{filteredUpdateSubviews:function(e,t){".color_scheme"!==t&&".geoid"!==t&&this.updateSubviews()},updateSubviews:function(){this.invalidate(),this.update(null,{execFlag:ns.U.EXEC.PARALLEL})}}}),ns.View.define("welcome-wizard",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click .js-go-to-step":"onGoToStepClick","daria:WelcomeWizard:closed":"onWizardPopupClosed"},params:function(){var e={wizard_name:"welcome"};
return e},models:{"wizard-state":{"ns-model-changed":"keepValid","ns-model-changed.activeStep":"onWizardStateActiveStepChanged"}},yateModule:"promo",methods:{_animationSpeed:400,onShow:function(){var e=this.getModel("wizard-state");e.reset(),$("html").addClass("with-WelcomeWizard")},onHide:function(){$("html").removeClass("with-WelcomeWizard")},onGoToStepClick:function(e){var t=e.currentTarget;if(t){var n=this.getModel("wizard-state");if(!n.isTransitionLocked()){var i=n.getActiveStep(),o=t.dataset.step;
n.setStep(o),n.trigger("daria:WelcomeWizard:dotNavigation",i,o)}}},onWizardStateActiveStepChanged:function(){this._animateStepChange(),this._updateStepToggler()},onWizardPopupClosed:function(){this._animationTimer&&(clearTimeout(this._animationTimer),this._animationTimer=null)},_animateStepChange:function(){var e=this,t=this.getModel("wizard-state"),n=t.getActiveStep(),i=t.getPrevActiveStep(),o=this.$node.find('*[data-step-id="'+n+'"]'),s=this.$node.find('*[data-step-id="'+i+'"]');return t.isFirstLoad()?(o.removeClass("is-hidden"),$(window).trigger("resize"),t.firstLoadDone(),t.trigger("daria:WelcomeWizard:stepAnimationStart",null,n),void t.trigger("daria:WelcomeWizard:stepAnimationEnd",null,n)):(t.lockTransition(),t.trigger("daria:WelcomeWizard:stepAnimationStart",i,n),s.addClass("will-be-hidden"),o.removeClass("is-hidden"),o.addClass("will-be-shown"),void(this._animationTimer=setTimeout(function(){s.removeClass("will-be-hidden"),s.addClass("is-hidden"),o.removeClass("will-be-shown"),e._animationTimer=setTimeout(function(){e._animationTimer=null,t.unlockTransition(),t.trigger("daria:WelcomeWizard:stepAnimationEnd",i,n),$(window).trigger("resize")
},e._animationSpeed)},this._animationSpeed)))},_updateStepToggler:function(){for(var e,t,n=this.getModel("wizard-state"),i="mail-WelcomeWizard-StepToggler-Item_active",o="mail-WelcomeWizard-StepToggler-Item_new",s="js-go-to-step",r=n.getActiveStep(),a=n.getSteps(),c=!1,d=0;d<a.length;d++)e=a[d],c=e===r,t=n.getStepWasShown(e),this.$node.find('[data-step="'+e+'"]').toggleClass(i,c).toggleClass(o,!t).toggleClass(s,!c)}}}),ns.View.edefine("welcome-wizard-popup",{yateModule:"promo",events:{"wheel window":"onWheel","keydown window":"onKeydown"},methods:{open:function(e){var t=this,n=_.extend({wizard:!0},this.params);
this.updateByLayout("welcome-wizard-popup",n,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node,{"click .js-welcome-wizard-close":function(e){e.preventDefault(),t.close()}}),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))},this)},close:function(){this.nbPopup&&(this.nbPopup.close(),ns.events.trigger("daria:WelcomeWizard:closed"))},onKeydown:function(e){e.keyCode===Jane.Common.keyCode.ESC&&(Daria.Dialog.isOpen()?Daria.Dialog.close():this.close())
},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},getScrollContent:function(e){return $(e.target).closest(".js-themes-list")[0]}}},"prevent-scroll-propagation-mixin",ns.View),ns.View.define("inline-wizard",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-hide":"onHide"},yateModule:"promo",methods:{onHtmlInit:function(){this.showOnPage(),Daria.InlineWizard.start(this.node),Daria.InlineWizard.openBeforeRender()},showOnPage:function(){$(".js-inline-wizard-dummy").append(this.$node)
},onHide:function(){this.$node.off(".inline-wizard")}}}),ns.View.define("inline-wizard-done",{yateModule:"promo"}),ns.View.define("wizard-collector",{}),ns.View.define("wizard-collector-create",{events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow"},yateModule:"promo",methods:{onhtmlinit:function(){var e=ns.Model.get("settings");new Daria.Collectors.Settings(this.$node.find("form"));var t=this;ns.events.on("onCollectorCreateSuccess."+this.id,function(n,i){ns.events.trigger("daria:vCollectors:update"),"messages"===ns.page.current.page&&0===t.$node.closest(".ns-view-wizard").length?(Daria.InlineWizard.metrika(2,["Подключить","Сборщик создан"]),ns.action.run("wizard.step-inline-block",{step:"next"})):ns.action.run("wizard.start",{step:"next"}),e.setSettingOn("no_collectors_bubble"),ns.forcedRequest(["do-collector-run"],{popid:i.popid})
})},onshow:function(){this.$node.find("input[name=email]").focus()}},models:{"collector-settings":!0,"collector-texts":!0}}),ns.View.define("wizard-done",{events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","daria:vWizardDone:changeStep":"onChangeStep","wizard-step-change@init":"_onWizardOpen","wizard-open@init":"_onWizardOpen","wizard-close@init":"_onWizardClose","phone-checked@init":"_onPhoneChecked"},yateModule:"promo",methods:{onhtmlinit:function(){ns.events.on("phone-checked",function(e,t){"no"===t&&(Daria.phoneRegistrationInWizard(this.node,this),this.$node.find(".b-form-layout").removeClass("g-vhidden"))
}.bind(this)),ns.action.run("passport.phone-check")},onshow:function(){window.setTimeout(function(){try{this.$node.find("input[name=number]").focus()}catch(e){}}.bind(this),1)},onChangeStep:function(e,t){this.changeStep(t)},_onWizardClose:function(){this._isCheckPhone=!1},_onWizardOpen:function(e,t){5!==t&&"done"!==t||!this.$node.is(":visible")||(this._isCheckPhone||(this._isCheckPhone=!0,Jane.Actions.run("passport.phone-check")),"wizard-step-change"===e&&_.defer(this._setFocus.bind(this)))},_onPhoneChecked:function(e,t){"no"===t&&(Daria.phoneRegistrationInWizard(this.$node[0]),this.$node.find(".b-form-layout").removeClass("g-vhidden"))
},_setFocus:function(){try{this.$node.find("input[name=number]").focus()}catch(e){}}},models:["userphones"]}),Daria.phoneRegistrationInWizard=function(e,t){function n(e){var n=t.$node;s||(s=$(".js-wizard-form:visible",n)),s.find(".g-error").addClass("g-hidden"),s.addClass("g-hidden"),s=n.find(e).removeClass("g-hidden")}function i(e,t){var n=s.find(".g-error");n.html(e),n.removeClass("g-hidden"),s.find("input:eq(0)").focus(function(){n.addClass("g-hidden"),t&&t()})}var o,s=$(".js-wizard-form:visible",e),r=function(e,t){var n=e,i=function(){n-=1e3;
var e=n/36e5,i=n/6e4,o=n/1e3,s="";e-=e%1,i=i-i%1-60*e,o=o-o%1-60*i,o-=3600*e,e&&(s+=e+":"),10>o&&(o="0"+o),s+=i+":",s+=o,t.find(".b-intruder__timer").html(s),n||clearInterval(r.revalidateTimerInterval)};r.revalidateTimerInterval&&(clearInterval(r.revalidateTimerInterval),t.find(".b-intruder__timer").html("")),r.revalidateTimerInterval=setInterval(i,1e3),i()},a=Daria.vCompose;a&&(a.hasUserPhone=!0),ns.events.on("phone-registered-success",function(t,i,a,c,d){var l=a.number||ns.Model.get("phone-register").getNumber(),h=ns.Model.get("userphones").getUnconfirmedIdByNumber(l),u="number="+l;
o=l,h&&(u+="&phoneid="+h),$(".js-phone-register-number-text",e).html(l),$(".js-phone-revalidate",e).attr("data-params",u),$('div[data-click-action="phone.confirm"]',e).attr("data-params","owned=wizard"),r.phoneid=l,n(".js-phone-confirm-form"),s.find(".js-confirm-hint").removeClass("g-hidden"),a&&a.revalidate||ns.events.trigger("phone-revalidate-success",i,a,c,d)}),ns.events.on("phone-confirmed-success",function(){var e=ns.Model.get("settings").getSetting("phone-number");ns.action.run("phone.getAppLink",{phoneNumber:e}),Jane.ErrorLog.send({event:"wizard-phone-metrika",uid:Daria.uid}),n(".js-phone-registration-success_myp")
}),ns.events.on("phone-revalidate-success",function(){var t=$(e),n=t.find(".js-revalidate-confirm"),i=r.phoneid,o=r[i]||0;i&&(r[i]=o+1);var s=[18e4,6e5,864e5][o]||864e5;r(s,t),t.find(".js-timer").removeClass("g-hidden"),t.find(".js-revalidate").addClass("g-hidden"),setTimeout(function(){t.find(".js-timer").addClass("g-hidden"),t.find(".js-revalidate").removeClass("g-hidden")},s),n.removeClass("g-hidden"),setTimeout(function(){n.addClass("g-hidden")},5e3)}),ns.events.on("phone-registered-failure",function(e,t,o,a,c){return"NUMEXISTS"===t?void ns.events.trigger("phone-registered-success",t,o,a,c):"TEMPORARYBLOCK"===t&&r.revalidateTimerInterval?(n(".js-phone-confirm-form"),void s.find(".js-confirm-hint").removeClass("g-hidden")):(s.find(".js-confirm-hint").addClass("g-hidden"),void i(ns.Model.get("phone-register").parseError(t)))
}),ns.events.on("phone-confirmed-failure",function(e,t,n){s.find(".js-confirm-hint").addClass("g-hidden"),i(ns.Model.get("phone-confirm").parseError(t,n),function(){s.find(".js-confirm-hint").removeClass("g-hidden")})}),t.changeStep=n},ns.View.define("wizard-interface",{models:["settings-color-schemes"],yateModule:"promo"}),ns.View.define("wizard-intro",{}),ns.View.define("wizard-labels",{events:{"ns-view-hide":"onhide","ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","daria:vWizardLabels:addLabels@show":"addLabels"},yateModule:"promo",methods:{onhtmlinit:function(){nb.init(this.node);
var e=5,t=function(n,i){var o=function(){return!$.trim(i.getValue())};i.on("focusin",function(){n.check()}),i.on("focusout",function(){setTimeout(function(){o()&&n.uncheck()})}),i.on("keyup",function(){if(!o()){var n=i.$node.closest(".js-label-new");if(!n.next().size()&&e){e--;var s=$(Jane.tt("promo:wizard-custom-labels",{},["labels-colors"]));nb.init(s.get(0)),n.after(s),t(nb.block(s.find(".js-label-checkbox").get(0)),nb.block(s.find(".js-label-input").get(0)))}}}),n.on("nb-checked",function(){i.focus()
})};t(nb.block(this.$node.find(".js-label-checkbox").get(0)),nb.block(this.$node.find(".js-label-input").get(0)))},deleteLabel:function(e){ns.forcedRequest(["do-labels-delete","labels"],{lids:e.lid}).then(function(){ns.events.trigger("daria:vLabels:update")})},onshow:function(){function e(){var e=this.$node.text()||this.$node.closest(".js-form-field").find(".js-label-input").val();if(e){var t=ns.Model.get("labels").getUserLabelByName(e);t&&n(t)}}function t(t){var n=nb.block(t);n&&n.on("nb-unchecked",e)
}var n=this.deleteLabel;$.each(this.$node.find(".js-inline-wizard-label-checkbox, .js-label-checkbox"),function(e,n){t(n)})},addLabels:function(){var e=this,t=this.getParams();t.length&&(ns.forcedRequest(t).then(function(){ns.events.trigger("daria:vLabels:update")}),ns.events.trigger("daria:vWizard:notifyMetriks","Добавление новой метки")),this.onshow(),this.$node.on("focus.wizard",".js-label-input",function(){var t=$(this).val(),n=ns.Model.get("labels").getUserLabelByName(t);n&&e.deleteLabel(n)})
},onFocusLabeleDeteteIt:function(){var e=$(this).val(),t=ns.Model.get("labels").getUserLabelByName(e);t&&this.deleteLabel(t)},onhide:function(){this.addLabels(),$(document).trigger("b-mail-dropdown-closeall")},getParams:function(){var e,t,n=this.$node.find("input:checked"),i=[],o={};return $.each(n,function(){var n=$(this).parents(".b-form-layout__line");e=$.trim(n.find("input[name=label_name]").val()),o[e]||(t=Daria.parseQuery(n.find(".b-label").attr("data-params")).color,ns.Model.get("labels").getUserLabelByName(e)||(i.push({id:"do-labels-add",params:{label_name:e,label_color:parseInt(t,16)}}),i.push({id:"labels"}),o[e]=!0))
}),i}},models:["labels","labels-colors"]}),ns.View.define("wizard-sender",{events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","daria:vWizardSender:userpicRemove@show":"userpicRemove"},yateModule:"promo",methods:{userSignatureTmp:"",initializeNanoislands:function(){nb.init(this.node)},onhtmlinit:function(){this.initializeNanoislands(),this.$upic=this.$node.find(".b-userpic-choose__pic-image__image"),this.$del=this.$node.find(".b-userpic-choose__pic-change"),this.saveSettingsTimeout=500,this.settingsParams={};
var e=Daria.signs.getPlain();e.length&&(this.userSignatureTmp=e.pop().convert,this.$node.find(".js-wizard-add-signature").text(this.userSignatureTmp))},onshow:function(){this.bindEvents()},bindEvents:function(){var e=this;this.$node.on("change",function(t){if("file"===t.target.name)return void Daria.upicUploader.upload(t.target,e.upicUpdate.bind(e));if("signature"===t.target.name){var n=e.$node.find(".js-wizard-add-signature").val();if(!n)return void(e.userSignatureTmp&&Daria.signs.removeByText(e.userSignatureTmp));
if(e.userSignatureTmp)return Daria.signs.changeByText(n,e.userSignatureTmp),void(e.userSignatureTmp=n);Daria.signs.addSignature({text:n},function(t,i){t?e.userSignatureTmp=n:-1!==$.inArray("signs.maxcount",i)?Daria.Dialog.notice({body:"<p>К сожалению, нельзя добавить более 20 подписей.</p>",width:350}):-1!==$.inArray("signs.maxlen",i)?Daria.Dialog.notice({body:"<p>Подпись должна быть не длиннее 10000 символов. Пожалуйста, сократите.</p>",width:350}):Daria.Statusline.showMsg({name:"signature.append.result",body:"Ошибка при добавлении подписи"})
})}e.settingsParams[t.target.name]=t.target.value,e.save()}),this.$node.find(".js-nb-select").each(function(){nb.block(this).on("nb-changed",function(){e.settingsParams[this.getName()]=this.getState().value,e.save()})})},save:function(){this.saveSettings&&clearTimeout(this.saveSettings),this.saveSettingsWithTimeout()},saveSettingsWithTimeout:function(){this.saveSettings=setTimeout(function(){ns.Model.get("settings").setSettings(this.settingsParams)}.bind(this),this.saveSettingsTimeout)},upicUpdate:function(){this.$upic.attr("src",this.$upic.data("src")+"?rnd="+Daria.now()),this.$del.removeClass("g-hidden")
},userpicRemove:function(){var e,t=Daria.Config.locale;e="en"===t?"//yastatic.net/mail/_/bbU36A0Wq327y4Djklp5QnULfNs.png":"tr"===t?"//yastatic.net/mail/_/x-lZHOiRrP2j6DTkGVMFMW7ZiNU.png":"//yastatic.net/mail/_/5OwlCMasPb-CWkj4ncvuYHaroZ4.png",this.$upic.attr("src",e),this.$del.addClass("g-hidden")}},models:["account-information","settings"]}),function(){var e=".js-mail-layout-content",t="promo-mobile-app-mixin",n=ns.View.infoLite(t);ns.View.define("inline-wizard-mobile-app-step",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-promo-mobile-app-close-button":"closeView","daria:vApp:changeRightColumSize@show":"onResize"},yateModule:"promo",isActive:!1,params:function(){return{promo:"mobile-app-inline-wizard"}
},shouldShow:function(){var e,t=ns.Model.get("settings").getSetting("inline-wizard-close");t||this.isActive||(e=Number(ns.Model.get("settings").getSetting("inline-wizard-mobile_show-date")||0));var i=Daria.getAccountAgeInDays()>=1,o=Daria.Config.first_login,s=ns.Model.get("settings").getSetting("promo-mobile_sms-send"),r=e&&Daria.now()-e>=30*Jane.Date.MINUTE,a=s&&!t;(r||a)&&(t=!0,ns.Model.get("settings").setSettings({"inline-wizard-close":t}));var c=n.methods.isMobileAppInstalled.apply(this),d=ns.Model.get("settings").getSetting("disable_promo");
return Daria.IS_CORP||!i||o||t||s||c||d?!1:(this.isActive=!0,!0)},getLayout:function(){return{name:"inline-wizard-mobile-app-step",childViews:{}}},methods:{PROMO_MOBILE_APP_NAME:"mail-promo-inbox-bottom",PICTURE_PREFIX:"mail-Promo-MailAppLink2",CUSTOM_CLASSES:"mail-PromoMobileApp_inlineWizard",VIEW_PREFIX_CLASS:"mail-PromoMobileApp",METRIKA_DATA:{prefix:"Визард внизу (под списком)",actions:{show:"Показы",enterPhone:"ввод телефона",sendClick:"клик на получить",sendSuccess:"сообщение отправлено",closeClick:"клик по закрыть"}},onShowAction:function(){this.$resizeNode=$(e),this.onResize();
var t=Number(ns.Model.get("settings").getSetting("inline-wizard-mobile_show-date")||0);t||ns.Model.get("settings").setSettings({"inline-wizard-mobile_show-date":Daria.now()})},onSendSuccess:function(){this.closeWithDelay()},onErrorCanNotRetry:function(){this.closeWithDelay()},closeWithDelay:function(e){var t=e||3e3,n=this;setTimeout(function(){n.isVisible()&&n.closeViewAction()},t)},closeViewAction:function(){ns.action.run("wizard.close-inline-wizard")}}},"promo-mobile-app-common")}(),ns.View.define("wizard",{events:{"ns-view-htmlinit":"onhtmlinit","daria:vWizard:notifyMetriks@show":"onNotifyMetriks"},methods:{onhtmlinit:function(){this.nav=this.$node.find("td:has(a[data-params^=step])"),this.prev=this.$node.find(".js-prev"),this.next=this.$node.find(".js-forward"),this.done=this.$node.find(".js-done"),this.start=this.$node.find(".js-start"),this.cancel=this.$node.find(".js-cancel"),this.pageNumber=this.$node.find(".b-wizard-step__number"),this.order=$.map(this.nav,function(e){return $(e).children("a").attr("data-params").split("=")[1]
}),this.nav.click(function(e){$(this).is(".b-wizard-menu__item_inactive")&&(e.preventDefault(),e.stopPropagation())}),this.$node.on("click",".js-hasnot-mailbox",function(){ns.action.run("collectors-promo.disable",{from:"wizard"})}),this.params["coollect-experiment"]&&this.metrika("Показ","",!0)},stepChanged:function(e){var t=e.step;"next"===t&&(e.step=this.order[this.currentIndex+1]||"done"),"prev"===t&&(e.step=this.order[this.currentIndex-1]),this.setCurrent(e),this.updateView(e),this.updatePager(e),this.updatePageNumber(),ns.events.trigger("wizard-step-change",t)
},setCurrent:function(e){var t=this.currentIndex=this.getIndex(e);this.nav.each(function(e){var n=$(this),i=t===e,o=t>e;n.toggleClass("b-wizard-menu__item_selected",i),n.next().toggleClass("b-wizard-menu__item_after-selected",i),(i||o)&&n.removeClass("b-wizard-menu__item_inactive")})},updatePageNumber:function(){var e=this.currentIndex+1,t=this.order.length,n="Шаг "+e+" из "+t;this.pageNumber.text(n)},updatePager:function(){var e=this.currentIndex-1,t=this.currentIndex+1;0===t?(this.start.show(),this.cancel.show()):(this.start.hide(),this.cancel.hide()),this.experiment&&1==t&&this.cancel.show(),e>=0?(this.prev.attr("data-params","step="+this.order[e]),this.prev.show()):this.prev.hide(),t&&t<this.order.length?(this.next.attr("data-params","step="+this.order[t]),this.next.show()):this.next.hide(),t===this.order.length?this.done.show():this.done.hide()
},getIndex:function(e){for(var t=-1,n=e.step.split("-")[0],i=0,o=this.order.length;o>i;i++)if(this.order[i]==n){t=i;break}return t},updateView:function(e){var t=this.prevStep,n=e.step;this.$node.find(".ns-view-wizard-"+(t||"intro")).find(".b-wizard-step").addClass("g-vhidden"),this.$node.find(".ns-view-wizard-"+n).find(".b-wizard-step").removeClass("g-vhidden"),this.views["wizard-"+t]&&this.views["wizard-"+t].trigger("ns-view-hide"),this.views["wizard-"+n]&&this.views["wizard-"+n].trigger("ns-view-show"),this.metrika("Показы"),this.prevStep=n
},onNotifyMetriks:function(e,t){this.metrika(t)},metrika:function(e,t){var n=[];if(this.params["coollect-experiment"]){var i=Daria.getUrlParams(),o=i.exp;o?("4"==o&&n.push("collect-coupons","Шаг 2"),"5"==o&&n.push("collect-tickets","Шаг 2"),"6"==o&&n.push("collect-events","Шаг 2")):n.push("Страница угона вариант №2","Шаг 2")}else n.push(this.experiment?"Визард (эксперимент)":"Визард");t!==!1&&n.push(t||this.order[this.currentIndex]||"intro"),n.push(e),"wizard-log"in Daria.urlParams&&console.log("WIZARD METRIKA:",n),Jane.c(n)
},unbindMetriks:function(){this._$elementToUnbind.off(".wizard")},bindMetriks:function(e,t){var n=$(e),i=this;this.experiment=t,this._$elementToUnbind=$(),_.forEach({".b-popup__close":"Клик на крестик закрытия",".js-start":"Клик на кнопку 'Настроить почту'",".js-cancel":"Клик на кнопку 'Позже'",".js-forward":"Клик на 'Далее'",".js-prev":"Клик на 'Назад'",".js-done":"Клик на 'Готово'",".js-add-upic":"Клик на 'Загрузить фотографию'",".js-make-upic":"Клик на 'Сфотографироваться'",".js-has-mailbox":"Клик на 'Да, есть'",".js-hasnot-mailbox":"Клик на 'Нет'",".js-collector-create":"Клик на 'Включить сборщик'",".js-phone-register-form .js-phone-register":"Клик на кнопку 'Сохранить'",".js-phone-confirm-form .js-phone-register":"Клик на 'Подтвердить'"},function(e,t){var o=n.find(t);
o.on("click.wizard",function(){i.metrika(e)}),i._$elementToUnbind=i._$elementToUnbind.add(o)})}},models:["settings-color-schemes"]}),borschik.addLinks({"mail-WelcomeWidget-Collectors.png":"//yastatic.net/mail/_/ZWnV3ZAj7nomG9dC7qwWWe5BqmI.png","mail-WelcomeWidget-Collectors@2x.png":"//yastatic.net/mail/_/bniOndC0vMZsFLVvnWlaspZC0ns.png"}),yr.externals["normalize-digital-login"]=function(e){return e.replace("+","")},yr.externals["get-default-email-address"]=function(){return ns.Model.get("settings").getSetting("default_email")
}});