Jane.module("jane.abook.js",function(){"use strict";yr.externals["color-picker"]=function(e){var o=Daria.abook.COLORS;return o[e%o.length]},function(e,o){o.abook={},o.abook.COLORS=["282879","d99148","d21f1f","8d2f8d","59b1b1","e4e400","996633","470000","d24b4b","9eb571","ca4275","0066cc","a54ba5","a51f1f","114f00","ff7db1","cc6633","8251b3","8fd700","e15900","3e007c","cccc33","781f1f","224300","418200","663399","ec6196","0099cc","e18700","6bab2c","ff925b","666600","a5a51f","78d2d2","95ff40","ff6600","ffcc33","663300","5b5bc9","333399"],function(){var t=new e.Loader(!1),n={errorType:"тип ошибки – ",comment:"комментарий – ",email:"эл. почта организации – ",login:"Логин – ",cardId:"номер карточки – ",subjects:{log:"Карточка организации – пользователь нажал на «Редактировать данные»",mail:"Ошибка в карточке организации, "},errors:{phone:"неправильный телефон",address:"неправильный адрес"}},a={params:{to:"mail-organization-cards@yandex-team.ru",nosave:"yes"}};
o.abook.report=function(e){this.AI=ns.Model.get("account-information").getData();var o=this;this.isOpen=!1,this.$form=e.$parent.find(".block-report"),this.$closer=e.$closer,this.$button=this.$form.find(".b-mail-button"),this.$form.on("click keydown",".b-report__link-edit",function(){o.log()}).on("submit",function(){return o.$button.hasClass("b-mail-button_disabled")||o.submit(),!1})},o.abook.report.prototype.open=function(){return this.isOpen?this:(this.isOpen=!0,this.$closer.addClass("b-report__hidden"),this.$form.slideDown("slow"),this)
},o.abook.report.prototype.close=function(o){if(!this.isOpen)return this;o=o||"slow";var t=this;return this.$closer.removeClass("b-report__hidden"),this.$form.slideUp(o,function(){t.isOpen=!1,this.reset(),e.enableButton(t.$button)}),this},o.abook.report.prototype.mail=function(e){var t,s=$.Deferred(),i=this.AI.login,r=n.login+i+",\n",l=$.extend({$form:this.$form,success:function(){s.resolve()},error:function(){s.resolve()}},a);return r+=t=n.errorType+n.errors[e.type],r+=",\n"+n.cardId+e.id,r+=e.email?",\n"+n.email+e.email:"",e.comment&&(r+=",\n\n"+n.comment+e.comment),l.params.send=r,l.params.subj=n.subjects.mail+(t+(e.email?", "+n.email+e.email:"")).replace(/\n/g,""),o.SendMail.sendForm(l),s
},o.abook.report.prototype.complain=function(e){var o=$.Deferred();return ns.forcedRequest(["send-report"],{company:e.id,type:e.type,uid:this.AI.uid,comment:e.comment}).then(function(){o.resolve()}),o},o.abook.report.prototype.log=function(){var e=this.$form[0]["card-id"].value,t=$.extend({$form:this.$form},a);return t.params.subj=n.subjects.log+", "+n.cardId.toLowerCase()+e,t.params.send=n.login+this.AI.login+",\n"+n.cardId+e,this.close(!0),o.SendMail.sendForm(t),this},o.abook.report.prototype.send=function(e){var n=this;
return t.start(),$.when(this.mail(e),this.complain(e)).done(function(){t.stop(),o.Statusline.showMsg({body:"Спасибо. Изменения появятся сразу после проверки данных."}),n.close()}),this},o.abook.report.prototype.submit=function(){var o=this.$form[0],t=nb.block(o.comment),n={type:o.type.value,email:o.email.value,id:o["card-id"].value,comment:t.getValue()};return e.disableButton(this.$button),this.send(n),this}}(),o.abook.openExportDialog=function(){function t(){n.submit(),o.Dialog.close()}var n=e.tt("abook:js-dialog-abook-export");
o.Dialog.open({title:"Сохранить контакты в файл",body:n,buttons:[{name:"submit",value:"Сохранить",onclick:t},{name:"cancel"}]})},o.abook.openImportDialog=function(){function t(){o.Dialog.disableButton("submit"),i.find(".b-load-message_abook-file-select").addClass("g-hidden"),i.find(".b-load-message_abook-import").removeClass("g-hidden"),i.ajaxSubmit({iframe:!0,dataType:"json",success:function(e){var t=!e||e.error||0===e.result.saved;t?a():o.loadPromoModule(function(){i.find(".b-load-message_abook-import").addClass("g-hidden"),i.find(".b-load-message_abook-success").removeClass("g-hidden");
var e="Книга <strong>"+_.escape(r)+"</strong> загружена";i.find(".b-load-message_abook-success-message").html(e),n(),["abook-contacts","abook-groups"].forEach(function(e){ns.Model.invalidate(e)}),o.Autocompleter.getContact().flushCache(),ns.page.go()})},error:a})}function n(){o.Dialog.toggleButton("submit",!1),o.Dialog.setButtonText("cancel","Вернуться")}function a(){i.find(".b-load-message_abook-import").addClass("g-hidden"),i.find(".b-load-message_abook-fail").removeClass("g-hidden"),n()}var s=e.tt("abook:js-dialog-abook-import"),i=$(s),r="";
o.Dialog.open({title:"Загрузить контакты из файла",body:s,buttons:[{name:"submit",value:"Сохранить",onclick:t},{name:"cancel"}],onopen:function(){var e=i.find(".b-message-attachments__file_deletable"),t=i.find(".b-input-file");i.append($("<input>").attr("type","hidden").attr("name","_ckey").val(o.Page.ckey)),i.on("change",'input[type="file"]',function(){r=$(this).val().replace(/C:\\fakepath\\/i,""),i.find(".b-message-attachments__file-name").text(r),e.removeClass("g-hidden"),t.addClass("g-hidden"),o.Dialog.enableButton("submit")
}),i.on("click",".b-message-attachments__file__delete",function(){i.resetForm();var n=i.find('input[type="file"]');n.replaceWith(n.clone()),e.addClass("g-hidden"),t.removeClass("g-hidden"),o.Dialog.disableButton("submit")}),o.Dialog.disableButton("submit")},onclose:function(){$('iframe[name^="jqFormIO"]').remove()}})},ns.action.define("abook.change-field",function(e,o){var t=o.field,n=o.mcid,a=ns.Model.get("abook-mcid-contact",{mcid:n}),s=ns.Model.get("abook-contact",{cid:a.get(".cid")});a.set(".field",t),s.trigger("ns-model-mcid-changed",a),$(document).trigger("b-mail-dropdown-closeall")
}),ns.action.define("abook.show-report",function(e,t,n){new o.abook.report({$parent:o.Dialog.$dialog,$closer:$(n)}).open()}),ns.action.define("mail-common.abook-popup",function(e,t){if(!o.abook.isPopupOpened()){var n={lang:"ru",q:null,tid:null,targetTid:null,type:t.popupType},a={emails:t.emails};t.resultDeferred&&(a.resultDeferred=t.resultDeferred);var s=ns.View.create("abook-popup",n);s.show(a)}}),ns.Model.define("do-abook-group-edit-contacts",{params:{tid:null,action:null,mcid:null}}),ns.Model.define("do-abook-person-update",{params:{person_id:null,first_name:null,middle_name:null,last_name:null,b_day:null,b_month1:null,b_year:null,tel_list:null,descr:null,rec_id:null,del:null,phone:null,mail_addr:null,shared:null}}),ns.Model.define("do-abook-person-delete",{params:{cid:null}}),ns.Model.define("abook-mcid-contact",{params:{mcid:null},methods:{canRequest:function(){return!1
},isValid:function(){return!0}}}),ns.Model.define("send-report",{params:{company:null,type:null,comment:null,uid:null}}),ns.Model.define("abook-backups-list",{methods:{extractData:function(e){if(e&&e.data){var o=new Date;o.setHours(23,59,59);var t=o.getTime(),n={};return n.backups=e.data.backups.map(this._mapBackups.bind(this,t)),n}},_mapBackups:function(o,t){var n=new Date(t.time),a=o-n,s=null,i=["Вчера","Сегодня","Завтра"];return a<e.Date.DAY?s=i[1]:a<2*e.Date.DAY&&(s=i[0]),{rev:t.rev,count:t.count||0,"smart-date":s,year:n.getFullYear(),month:n.getMonth(),date:n.getDate(),hours:n.getHours(),minutes:e.Common.n(n.getMinutes())}
}}}),ns.Model.define("do-abook-backups-restore",{params:{rev:null}}),ns.Model.define("abook-person-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({state:"view"})},isEdit:function(){return"edit"===this.get(".state")},isNew:function(){return this.isEdit()&&null==this.get(".cid")},setCurrentState:function(e,o){this.set(".data",o),this.set(".state",e)},isFormValid:function(){return this.get(".isEmailsValid")&&this.get(".isPhonesValid")},changeEmailsValid:function(e){this.set(".isEmailsValid",e)
},changePhonesValid:function(e){this.set(".isPhonesValid",e)}}},ns.ModelStatic),function(){function e(e){return e.value||e}function t(e){return e&&e.editable&&e.value}function n(e){return Boolean(e)}function a(){return this.saveInProgress=!1,o.Statusline.showMsg({body:"Адресная книга временно недоступна. Пожалуйста, повторите через несколько минут."}),vow.Promise.rejected()}ns.Model.define("abook-person-manager",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({})},_getParamsToSave:function(e){var o=e.get(".name")||{},t=e.get(".birthdate");
return{person_id:e.get(".cid"),first_name:o.first,middle_name:o.middle,last_name:o.last,b_day:t&&t.day,b_month:t&&t.month1,b_year:t&&t.year,descr:e.get(".description"),phone:e.get(".phone"),email:e.get(".email"),shared:e.get(".isShared")}},_checkParamsToSave:function(o){(o.b_day||o.b_month||o.b_year)&&(o.b_day=o.b_day||"1",o.b_month1=o.b_month||"1",delete o.b_month),o.mail_addr=[].concat(o.mail_addr),o.mail_addr=o.mail_addr.filter(n).map(e),o.email=o.mail_addr,o.phone=[].concat(o.phone),o.phone=o.phone.map(t).filter(n),o.tel_list=o.phone,o.timeout="yes",Object.keys(o).forEach(function(e){o[e]||delete o[e]
}),delete o.tagsToRemove,delete o.mainEmail,delete o.isNewMainEmail},addPerson:function(e){var t=no.jpath(".current.params.tid",ns.page);return t&&(e.tags=[t]),this._checkParamsToSave(e),ns.forcedRequest("do-abook-person-add",e).then(function(e){var t=e[0].get(".cid");return t?(o.Statusline.showMsg({body:"Изменения сохранены"}),ns.Model.invalidateAll("abook-contacts"),ns.forcedRequest("abook-contact",{cid:t})):a()},a)},updatePerson:function(e,t){t=_.extend(this._getParamsToSave(e),t);var n=ns.Model.get("abook-groups"),s=t.tagsToRemove,i=t.mainEmail,r=t.isNewMainEmail,l=e.isShared();
l&&(t.shared=!0),this._checkParamsToSave(t);var d=[{id:"do-abook-person-update",params:t}];if(r&&d.push({id:"abook-contact",params:{cid:t.cid}}),l||e.invalidate(),s&&s.length){var c=s.map(function(e){return e.tid});d.push({id:"do-abook-group-edit-contacts",params:{tid:c,mcid:t.cid,action:"rm"}}),n.invalidate()}return ns.forcedRequest(d).then(function(e){var t=e[0].get(".cid");return l&&(ns.Model.get("abook-contact",{email:i}).invalidate(),ns.Model.traverse("abook-contacts",function(e){Number(e.params.shared)||e.invalidate()
})),o.Statusline.showMsg({body:"Изменения сохранены"}),ns.forcedRequest("abook-contact",{cid:t})},a)}}},ns.ModelStatic)}(),ns.Model.define("abook-new-group-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.resetAll()},setHasError:function(){this.set(".error",!0)},unsetHasError:function(){this.set(".error",!1)},hasError:function(){return this.get(".error")},resetAll:function(){this.setData({name:"",error:!1})}}},ns.ModelStatic),ns.Model.define("abook-contacts-filters",{events:{"ns-model-init":"_onInit"},params:{type:null},methods:{_onInit:function(){this.setData({})
}}},ns.ModelStatic),ns.View.define("abook",{models:["abook-selected"],"params+":{tid:null},events:{"ns-view-htmlinit":"onInit","ns-view-touch":"onTouch","ns-view-hide":"onHide","ns-view-htmldestroy":"onDestroy","keydown .js-abook-head-search":"preventReturn","keyup .js-abook-head-search":"queryChanged","daria:vAbookHead.changeSymbolFilter":"onChangeSymbolFilter","daria:vAbookPerson.personInfoChanged":"update"},yateModule:"abook",methods:{onInit:function(){this.searchLazy=this.search.lazy(200),this.isPopup="select"===this.params.type||"new-group"===this.params.type||"add-to-group"===this.params.type,this.$input=this.$node.find(".js-abook-head-search")
},onTouch:function(e,o){this.params=o,this.params.q?""===this.$input.val()&&this.$input.val(this.params.q):this.$input.val("")},onHide:function(){this.searchLazy.reset()},onDestroy:function(){this.searchLazy.reset()},queryChanged:function(){var e=this.$input.val(),o=this.params.q?this.params.q:"";e.toLowerCase()!==o.toLowerCase()&&this.searchLazy(e)},onChangeSymbolFilter:function(e,o){this.$input.val(o),this.search(o)},search:function(t){var n=_.extend({},this.params,{q:t});if(this.isPopup)n.shared="0",this.update(n),"select"===this.params.type?e.c(["АК в саджесте композа","поискали"]):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК","поискали");
else{var a=ns.router.generateUrl("abook",n);ns.page.go(a)}},preventReturn:function(o){o.which===e.Common.keyCode.ENTER&&o.preventDefault()}}}),o.vAbook={makeDraggableParams:function(e){var o={appendTo:"body",delay:100,distance:10,cursor:"pointer",cursorAt:{top:0,left:0},revert:"invalid",revertDuration:200,scroll:!0,scrollSensitivity:10,zIndex:1500};return $.extend({},o,e)},makeDroppableParams:function(e){var o={tolerance:"pointer",activeClass:"g-drop-place",hoverClass:"g-drop-place_hover"};return $.extend({},o,e)
}},function(){function e(e,o){var t={};return t[o]=e,t}var t={inited:!1,instance:null,_bag:[],c:function(){for(var o=Array.prototype.slice.call(arguments),t=o.pop();o.length;)t=e(t,o.pop());if(this.inited)try{this.instance.params(t)}catch(n){}else this._bag.push(t)}};t.c=t.c.bind(t),o.Libs("Ya.Metrika",function(){var e={ut:"noindex",trackLinks:!0,trackHash:!0,id:22327510};try{t.instance=new Ya.Metrika(e)}catch(o){return}t.inited=!0,t._bag.forEach(function(e){t.instance.params(e)}),t._bag=[]}),o.vAbook.Metrika=t
}(),ns.View.define("abook-choose-email-popup",{events:{"click .js-assign-button":"onAssignButtonClick"},models:{"abook-contact":"keepValid"},"params+":{tid:null},yateModule:"abook",methods:{onAssignButtonClick:function(){var e=this.nbCheckboxGroup.getCheckedValues();e&&(ns.Model.get("abook-groups").addToGroup({tid:this.params.tid,mcids:e}).then(function(){ns.page.go()}),this.close())},open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbCheckboxGroup=nb.$block(".js-emails",this.node),this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null,e.nbCheckboxGroup=null),e.destroy()})}}}),ns.View.define("abook-contact",{models:{"abook-selected":{"ns-model-insert":"onSelected","ns-model-remove":"onDeselected"},"abook-contact":{"ns-model-mcid-changed":"onChangedContactState"},"abook-groups":!0},"params+":{type:null,tid:null,q:null,defaultField:null,shared:null},events:{"ns-view-htmlinit":"onInit","ns-view-show":"onShow","ns-view-hide":"unbindContactsDragAndDrop","click a":"_stopPropagation","click .js-abook-entry-person-popup":"showPersonPopup","click .js-abook-entry-remaining":"showEmailsDropdown","click .js-abook-entry-popup-remaining":"showMoreEmails","click .js-abook-label":"onClickAbookLabel","click .abook-entry-checkbox":"_stopPropagation","click .js-abook-entry-checkbox-controller":"onToggleContact","click .js-abook-entry-group-popup-checkbox-controller":"onToggleGroupCheckbox","click .js-abook-entry-popup-checkbox-controller":"onToggleMcidContact","click .js-abook-entry-single-popup-checkbox-controller":"onToggleMcidContact","click .js-abook-entry":"onContactClick","click .js-abook-entry-write":"onWriteToContactClick",drop:"initDrop"},yateModule:"abook",methods:{onInit:function(){this.isInited=!0
},onShow:function(){if(this.bindContactsDragAndDrop(),"normal"!==this.params.type){var e=this.getModel("abook-selected").models;this.onSelected("ns-model-insert",e)}},showPersonPopup:function(e){e.stopPropagation();var o=this,t=this.getModel("abook-contact"),n=t.get(".email")[0],a=t.isShared();a?ns.forcedRequest("abook-contact",{email:n.value}).then(function(e){var n=e[0];n.get(".cid")&&(n.isLocal()&&(n=t),o._showPersonPopup(n,{shared:!0}))}):this._showPersonPopup(t)},_showPersonPopup:function(e,t){var n=e.get(".email")[0]||{},a=_.extend({cid:e.get(".cid"),shared:!1,ref:n.ref,email:n.value,state:"view"},t);
ns.events.trigger("daria:vAbookContacts.showPersonPopup",a),o.vAbook.Metrika.c("Карточка контакта","В АК","показ карточки (клик на контакт)")},_stopPropagation:function(e){e.stopPropagation()},isSelected:function(){return _(this.getModel("abook-selected").models).contains(this.getModel("abook-contact"))},yateIsMcidSelected:function(){var e=this.getModel("abook-contact").get(".cid");return this.getModel("abook-selected").isMcidSelected(e)},onToggleContact:function(e){e.stopPropagation();var o=this.getModel("abook-selected"),t=this.getModel("abook-contact");
o.isSelected(t)?o.remove(t):o.insert(t),this.metrika("Клик по аватарке")},onToggleMcidContact:function(e){e.stopPropagation(),this.toggleMcidContact(e.currentTarget),this.metrikaForPopup("Клик по аватарке")},onToggleGroupCheckbox:function(e){e.stopPropagation();var o=this,t=$(e.currentTarget),n=this.$node.find(".abook-entry-email-container"),a=n.find(".js-abook-entry-popup-checkbox-controller");if(t.is(":checked")){var s=a.first();s.prop("checked",!0),this._showMoreEmails(!0),this.toggleMcidContact(s)
}else a.each(function(e,t){var n=$(t);n.is(":checked")&&(n.prop("checked",!1),o.toggleMcidContact(n))});this.metrikaForPopup("Клик по аватарке")},toggleMcidContact:function(e){var o=$(e),t=o.closest(".js-abook-entry"),n=t.data("mcid");o.is(":checked")?this.selectMcidContact(n):this.deselectMcidContact(n)},onContactClick:function(e){if("normal"!==this.params.type){var o=$(e.target),t="select"!==this.params.type||!o.hasClass("js-field-wrapper")&&!o.closest(".js-field-wrapper").length;t&&(e.preventDefault(),$(e.currentTarget).find("input").click())
}},getMcidContact:function(e){var o=this.getModel("abook-contact"),t=this.getModel("abook-selected");return t.abookContactToAbookMcidContact(o,e)},selectMcidContact:function(e){var o=this.getMcidContact(e);this.getModel("abook-selected").insert(o)},deselectMcidContact:function(e){var o=this.getMcidContact(e);this.getModel("abook-selected").remove(o)},getContactModelsFromSelected:function(e){var o=this.getModel("abook-contact"),t=o.get(".cid");return _.filter(e,function(e){return e.get(".cid")===t
})},onChangedContactState:function(e,o){var t=o.get(".mcid");if(t){var n=this.$node.find('[data-mcid="'+o.get(".mcid")+'"] input');this.toggleFieldChangeControl(!1,n,o)}},onSelected:function(e,o){var t=this.getContactModelsFromSelected(o);t.length&&("normal"===this.params.type?this.selectNormalContact():this.selectPopupContact(t))},selectNormalContact:function(){var e=this.$node.find(".js-abook-entry");e.addClass("is-selected")},selectPopupContact:function(e){_.each(e,function(e){var o=this.$node.find("> .js-abook-entry");
o.addClass("is-selected");var t=this.$node.find('[data-mcid="'+e.get(".mcid")+'"] input');t.prop("checked",!0),t.closest(".js-abook-entry").addClass("is-selected");var n=this.$node.find(".js-abook-entry-group-popup-checkbox-controller");n.prop("checked",!0),"group"===o.data("type")&&this._showMoreEmails(!0)},this)},onDeselected:function(e,o){var t=this.getContactModelsFromSelected(o);t.length&&("normal"===this.params.type?this.deselectNormalContact():this.deselectPopupContact(t))},deselectNormalContact:function(){var e=this.$node.find(".js-abook-entry"),o=e.find(".js-abook-entry-checkbox-controller");
o.prop("checked")&&o.prop("checked",!1),e.removeClass("is-selected")},deselectPopupContact:function(e){_.each(e,function(e){var o=this.$node.find('[data-mcid="'+e.get(".mcid")+'"] input');o.prop("checked",!1),o.closest(".js-abook-entry").removeClass("is-selected"),this.toggleFieldChangeControl(!0,o,e),this.uncheckMcidGroupCheckbox()},this)},uncheckMcidGroupCheckbox:function(){var e=this.$node.find(".js-abook-entry-group-popup-checkbox-controller"),o=this.$node.find(".js-abook-entry-popup-checkbox-controller").filter(":checked").length;
if(0===o){e.prop("checked",!1);var t=this.$node.find("> .js-abook-entry");t.removeClass("is-selected")}},showMoreEmails:function(e,o){e.stopPropagation(),this._showMoreEmails(o);var t=$(e.currentTarget);t.hasClass("js-remaining-expand")?this.metrikaForPopup("Клик по ещё N"):t.hasClass("js-remaining-collapse")&&this.metrikaForPopup("Клик по свернуть N")},_showMoreEmails:function(e){var o=this.$node.find(".js-abook-entry"),t=this.$node.find(".abook-entry-email-container");if(e=e||!o.hasClass("is-extended")){var n=0,a=t.children();
a.appendTo(document.body),a.each(function(){n+=$(this).outerHeight()}),a.appendTo(t),t.css("height",n)}else t.css("height",0);o.toggleClass("is-extended",e)},toggleFieldChangeControl:function(t,n,a){if("select"==this.params.type){o.Dropdown.closeAll();var s=a.get(".field"),i=n.closest(".js-abook-entry").find(".js-field-wrapper");if(t)return i.empty(),void a.set(".field",null);s||(s=this.params.defaultField||"to",a.set(".field",s));var r=e.tt("abook:abook-contact-email-field",{selected:s,mcid:a.get(".mcid")});
i.html(r)}},bindContactsDragAndDrop:function(){var e=this.getModel("abook-contact");if("normal"===this.params.type&&!e.isShared()){var t=this.$node.find(".js-abook-entry");if(t.length){var n=o.vAbook.makeDraggableParams({helper:this.initDragHelper.bind(this)}),a=o.vAbook.makeDroppableParams({accept:".js-abook-group"});t.draggable(n),t.droppable(a),this.$dragDropEntries=t}}},unbindContactsDragAndDrop:function(){if(this.$dragDropEntries){try{this.$dragDropEntries.droppable("destroy")}catch(e){}try{this.$dragDropEntries.draggable("destroy")
}catch(e){}}},initDragHelper:function(){var t=this.getModel("abook-selected"),n=this.getModel("abook-contact");o.Dialog.close();var a=t.models.length;return 0===a&&(a=1),t.insert(n),$(e.tt("abook:drag-helper",{contacts:a}))},initDrop:function(e,o){if(!o||!o.draggable)return!1;var t=$(e.target),n=o.draggable,a=t.data("cid"),s=n.data("tid"),i=this.getModel("abook-contact"),r=i.getMcids(this.params.tid);r.length>1?ns.events.trigger("daria:vAbook:showChooseEmailPopup",{cid:a,tid:s,target:this.node}):r.length>0&&this.getModel("abook-groups").addToGroup({tid:s,mcids:r}).then(function(){ns.page.go()
})},onScroll:function(){this.nbPopup&&this.nbPopup.destroy()},showEmailsDropdown:function(e){if(e.stopPropagation(),!this.nbPopup){var o=this;this.metrika("Клик по ещё N"),this.nbPopup=nb.block(this.$node.find(".js-emails-popup").get(0)),this.nbPopup.$node.on("click",".js-write-to-contact",function(e){o.metrika('Клик на имейл внутри "еще n"'),o.writeToContact(e)}),this.onScroll=this.onScroll.bind(this),ns.events.on("daria:vScrollerAbookContacts:scroll",this.onScroll),ns.events.on("daria:layout-changed",this.onScroll),this.nbPopup.on("nb-closed",function(){this.$node.off(),this.destroy()
}),this.nbPopup.on("nb-destroyed",function(){ns.events.off("daria:vScrollerAbookContacts:scroll",this.onScroll),ns.events.off("daria:layout-changed",this.onScroll),delete this.nbPopup}.bind(this)),this.nbPopup.open({autoclose:!0,where:e.currentTarget})}},writeToContact:function(e){var o=$(e.currentTarget).data("email");ns.Model.get("compose-predefined-data").set(".to",o),ns.page.go(ns.router.generateUrl("compose2"))},onClickAbookLabel:function(e){this.groupClickMetrika(),"select"===this.params.type&&(e.preventDefault(),this.getModel("abook-selected").trigger("daria:mAbookSelected:change-group",$(e.currentTarget).data("tid")))
},onWriteToContactClick:function(e){e.stopPropagation(),this.metrika("Клик по Написать");var t=ns.Model.get("abook-selected");t.clear(),t.insert(this.getModel("abook-contact")),o.COPS["abook.compose-go"](t)},metrika:function(e){o.vAbook.Metrika.c("Список контактов",e)},metrikaForPopup:function(t){"select"===this.params.type?e.c(["АК в саджесте композа",t]):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК",t)},groupClickMetrika:function(){this.metrika("Клик по группе")
}}}),ns.View.define("abook-selected-mixin",{yateModule:"abook",methods:{SELECT_ALL_CHECKED_CLASS:"mail-AbookHead-SelectAll_checked",onSelectAllStateRequested:function(e,o){o(this.getSelectAllTogglerState())},onToggleSelectAll:function(e,o){var t=this.getModel("abook-selected"),n=this.getModel("abook-contacts"),a=n.models;"normal"!==this.params.type&&(a=t.abookContactsToAbookMcidContacts(a,this.params.tid,null,!0)),o?t.insert(a):t.remove(a)},allContactsSelected:function(){var e=this.getModel("abook-selected"),o=this.getModel("abook-contacts"),t=o.models,n=!1;
return"normal"!==this.params.type&&(t=e.abookContactsToAbookMcidContacts(o.models,this.params.tid,null,!0)),_.each(t,function(o){return n=_.includes(e.models,o)}),n},getSelectAllTogglerState:function(){var e=this.getModel("abook-contacts"),o=!e.models.length,t=!o&&this.allContactsSelected();return{checked:t,enabled:!o}}}}),ns.ViewCollection.edefine("abook-contacts",{models:{"abook-groups":!0,"abook-contacts":{"ns-model-changed":!1,"ns-model-insert":"onAbookContactsUpdate","ns-model-remove":"onAbookContactsUpdate"},"abook-selected":{"ns-model-changed":!1,"ns-model-insert":"onSelected","ns-model-remove":"onDeselected"},"abook-contacts-filters":!1,"scroller-abook-contacts":!1},"params+":{targetTid:null},split:{byModel:"abook-contacts",intoViews:"abook-contact"},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","daria:vToolbarButton:onDrop@show":"onToolbarDrop","daria:vAbookContacts.showPersonPopup":"showPersonPopup"},yateModule:"abook",methods:{onAbookContactsUpdate:function(){"normal"===this.params.type?this.forceUpdate():ns.events.trigger("daria:vAbookContacts:onUpdate"),this.refreshToolbarButtons()
},onHtmlInit:function(){"normal"===this.params.type&&this.refreshToolbarButtons(),this.onSelectAllStateRequestedBound=this.onSelectAllStateRequested.bind(this),this.onToggleSelectAllBound=this.onToggleSelectAll.bind(this)},onShow:function(){return this.getModel("scroller-abook-contacts").init(),this.selectionChanged(),this.getModel("abook-contacts-filters").on("daria:mAbookContactsFilters:get-state",this.onSelectAllStateRequestedBound),this.getModel("abook-contacts-filters").on("daria:mAbookContactsFilters:toggle-select-all",this.onToggleSelectAllBound),"normal"!==this.params.type?void this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:actualizeToggler"):void(this.params.tid?ns.events.trigger("daria:vToolbarButton:droppableInit","abook-outofgroup"):ns.events.trigger("daria:vToolbarButton:droppableDestroy","abook-outofgroup"))
},onHide:function(){this.getModel("abook-contacts-filters").off("daria:mAbookContactsFilters:get-state",this.onSelectAllStateRequestedBound),this.getModel("abook-contacts-filters").off("daria:mAbookContactsFilters:toggle-select-all",this.onToggleSelectAllBound)},showPersonPopup:function(e,o){return this.vPopup&&this.vPopup.isValid()?(this.vPopup.close(),void(this.vPopup=null)):(this.vPopup=ns.View.create("abook-person-popup"),void this.vPopup.open({where:$(window),how:{my:"center",at:"center",of:window,fixed:!0}},o))
},onSelected:function(){this.isVisible()&&this.selectionChanged()},onDeselected:function(){this.isVisible()&&this.selectionChanged()},selectionChanged:function(){"normal"===this.params.type&&(this.refreshToolbarButtons(),this.checkMultiselect())},refreshToolbarButtons:function(){var e=this.getModel("abook-selected"),o=this.getModel("abook-contacts"),t=e.models.length,n=o.models.length,a=Boolean(t&&this.params.tid),s=0===t||e.containsEmail()&&50>=t;ns.events.trigger("daria:vAbookContacts:selectionChanged",{"abook-select-all":!n||t!==n,"abook-deselect-all":n&&t===n,"abook-remove":t,"abook-togroup":t,"abook-outofgroup":a,"compose-abook":s})
},onToolbarDrop:function(e,t){switch(t.id){case"abook-outofgroup":o.COPS["abook.remove-contacts-from-group"](this.getModel("abook-selected"),{toolbar:1});break;case"abook-togroup":o.COPS["abook.groups-dropdown"](this.getModel("abook-selected"),{toolbar:1,buttonView:{node:t.event.target}});break;case"abook-remove":o.COPS["abook.remove-contacts"](this.getModel("abook-selected"))}},checkMultiselect:function(){var e=this.getModel("abook-selected");this.$node.toggleClass("abook-contacts__multiselect",e.models.length>1)
}}},"abook-selected-mixin",ns.ViewCollection),ns.View.define("abook-contacts-pager",{models:{"abook-contacts":{"ns-model-changed":!1,"ns-model-insert":"forceUpdate","ns-model-remove":"forceUpdate"}},events:{"click@show .js-abook-load-more":"onLoadMoreClick","click@show .js-abook-load-all":"onLoadAllClick"},yateModule:"abook",methods:{onLoadMoreClick:function(){this.getModel("abook-contacts").loadMore(),"select"===this.params.type?e.c(["АК в саджесте композа","Клик по Ещё контакты"]):"new-group"===this.params.type?o.vAbook.Metrika.c("Попап создания групп в АК","Клик по Ещё контакты"):o.vAbook.Metrika.c("Список контактов","Клик по Ещё контакты")
},onLoadAllClick:function(){var t=!0;this.getModel("abook-contacts").loadMore(t),"select"===this.params.type?e.c(["АК в саджесте композа","Клик по Показать все контакты"]):"new-group"===this.params.type?o.vAbook.Metrika.c("Попап создания групп в АК","Клик по Показать все контакты"):o.vAbook.Metrika.c("Список контактов","Клик по Показать все контакты")}}}),ns.View.define("abook-dropzone",{models:["abook-groups"],events:{"ns-view-htmlinit":"onInit","ns-view-hide":"onHide","change .abook-file-adder-button":"fileUpload","change .abook-file-drop-mode":"fileUpload","dragover@show document":"onDocumentDragover","dragenter@show .abook-file-adder":"onDragenter","dragenter@show .abook-file-drop-mode":"onDragenterFileDropMode","dragleave@show .abook-file-drop-mode":"onDropFileDropMode","drop@show .abook-file-drop-mode":"onDropFileDropMode"},"params+":{type:null,tid:null},yateModule:"abook",methods:{onInit:function(){this.$node.find(".js-abook-dropzone").length&&(this.$node.find(".abook-file-adder-ckey").val(o.Page.ckey),this.metrika("Показ"))
},onHide:function(){clearTimeout(this._uploadErrorTimeout),clearTimeout(this._uploadSuccessTimeout)},fileUpload:function(e){this.metrika($(e.currentTarget).is(".abook-file-adder-button")?"Клик по кнопке Перенести":"Драг-н-дроп файла на страницу"),this.$form=this.$node.find(".abook-file-adder"),this.$form.find('input[type="file"]').not(e.target).prop("disabled",!0),this.$form.ajaxSubmit({iframe:!0,dataType:"json",success:this._submitSuccess.bind(this),error:this._submitError.bind(this)})},_submitError:function(){var e=this,o=this.$form.find(".abook-file-adder-misc"),t=this.$form.find(".abook-file-adder-error");
this.metrika("Показ ошибки"),this.$form.find('input[type="file"]').prop("disabled",!1),o.addClass("g-hidden"),t.removeClass("g-hidden"),this._uploadErrorTimeout=setTimeout(function(){o.removeClass("g-hidden"),t.addClass("g-hidden"),e.$form.resetForm()},2e3)},_submitSuccess:function(e){return this.$form.find('input[type="file"]').prop("disabled",!1),!e||e.error?void this._submitError():(this.metrika("Контакты успешно перенесены"),this.$form.addClass("g-hidden"),this.$node.find(".abook-file-success").removeClass("g-hidden"),ns.Model.invalidate("abook-contacts"),ns.Model.invalidate("abook-groups"),o.Autocompleter.getContact().flushCache(),void(this._uploadSuccessTimeout=setTimeout(function(){var e=ns.router.generateUrl("abook",{});
ns.page.go(e)},3e3)))},onDocumentDragover:function(e){e.preventDefault()},onDragenter:function(e){var o=$(e.currentTarget),t=o.find(".abook-file-adder-veil");t.removeClass("g-hidden"),o.addClass("abook-file-adder_hover")},onDragenterFileDropMode:function(e){e.stopPropagation()},onDropFileDropMode:function(e){var o=$(e.currentTarget),t=o.closest(".abook-file-adder-veil"),n=t.closest(".abook-file-adder");t.addClass("g-hidden"),n.removeClass("abook-file-adder_hover")},metrika:function(e){o.vAbook.Metrika.c("Перенос контактов","В пустой АК",e)
}}}),ns.View.define("abook-extra-actions",{events:{"ns-view-destroyed":"_onDestroyed"},yateModule:"abook",methods:{onScroll:function(){this._popup&&this._popup.destroy()},open:function(e){var t=o.COPS["abook.toolbar-more-actions"];return this._popup=nb.block(ns.renderNode({},"js-abook-extra-actions","abook")),this._popup.on("nb-closed",function(){t._openView&&t._openView.destroy(),this.destroy()}),this.onScroll=this.onScroll.bind(this),ns.events.on("daria:vScrollerAbookContacts:scroll",this.onScroll),ns.events.on("daria:layout-changed",this.onScroll),this._popup.on("nb-destroyed",function(){t._openView&&delete t._openView,ns.events.off("daria:vScrollerAbookContacts:scroll",this.onScroll),ns.events.off("daria:layout-changed",this.onScroll),delete this._popup
}.bind(this)),this._popup.on("nb-select",function(e,t){t.event.preventDefault();var n=t.ui.item.find("a").data("event");switch(this.close(),n){case"abook.import":o.vAbook.Metrika.c("Тулбар","Клик Ещё","Клик Добавить контакты из файла"),o.abook.openImportDialog();break;case"abook.export":o.vAbook.Metrika.c("Тулбар","Клик Ещё","Клик Сохранить контакты в файл"),o.abook.openExportDialog()}}),this._popup.open({withoutTail:!1,autofocus:!0,autoclose:!0,animation:!0,where:e.where}),this},_onDestroyed:function(){this._popup&&this._popup.close()
}}}),ns.View.define("abook-groups",{models:["abook-groups","abook-selected"],events:{"ns-view-htmlinit":"onInit","ns-view-show":"bindGroupsDragDrop","ns-view-hide":"unbindGroupsDragDrop","click@show .js-abook-write-group":"writeToGroup","click@show .js-abook-add-new-group":"onAddNewGroup","click@show .js-abook-groups-all":"allClickMetrika","click@show .js-abook-groups-shared":"sharedClickMetrika","click@show .js-abook-group":"groupClickMetrika","click@show .js-abook-group-settings":"settingsClickMetrika","daria:vAbookPerson.personInfoChanged":"update",dragstart:"dragStart",drop:"onDropContact"},"params+":{type:null,tid:null,q:null,shared:null},yateModule:"abook",methods:{onInit:function(){this.metrikaShow()
},metrikaShow:function(){if(!e.watcher.get("metrika:ak:showed")){var t=this.getModel("abook-groups").get(".contacts-total-count");o.vAbook.Metrika.c("Показы страницы",t>0?"Есть контакты":"Нет контактов"),e.watcher.set("metrika:ak:showed",!0)}},writeToGroup:function(e){e.preventDefault();var t=Number($(e.target).data("tid"));t&&ns.request("abook-contacts",{tid:t}).then(function(e){var t=e[0],n=ns.Model.get("abook-selected");n.clear();for(var a=0;a<t.models.length;a++)n.insert(t.models[a]);o.COPS["abook.compose-go"](n)
})},onAddNewGroup:function(e){var o,t=$(e.currentTarget);t.hasClass("js-is-new-group-button")?o="left-column:new-group-button":t.hasClass("js-is-teaser")&&(o="left-column:group-teaser-button"),ns.events.trigger("daria:vAbook.showGroupPopup",{type:"new-group",eventSource:o})},bindGroupsDragDrop:function(){var e=o.vAbook.makeDraggableParams({helper:this.createDragHelper.bind(this)}),t=o.vAbook.makeDroppableParams({accept:".js-abook-entry",activeClass:null});this.$dragDropGroups=this.$node.find(".js-abook-group").not(".js-abook-group_current").draggable(e).droppable(t),this.isDragDropInit=!0
},unbindGroupsDragDrop:function(){if(this.$dragDropGroups&&this.isDragDropInit){try{this.$dragDropGroups.draggable("destroy").droppable("destroy")}catch(e){}this.isDragDropInit=!1}},createDragHelper:function(o){var t=$(o.currentTarget).find(".js-abook-group-name").text();return e.tt("abook:drag-helper",{group:t})},dragStart:function(){this.getModel("abook-selected").clear(),o.Dialog.close()},onDropContact:function(e){var t,n=Number($(e.target).data("tid")),a=this.getModel("abook-selected");t=-10===n?o.COPS["abook.assign-contacts-from-phone-group"](a):o.COPS["abook.assign-contacts-from-group"](a,{tid:n,target:e.target}),t.then(function(){a.clear(),this.forceUpdate()
},this)},allClickMetrika:function(){var e=o.Config.workspace?"Клик Личные контакты":"Клик Все контакты";o.vAbook.Metrika.c("Левая колонка",e)},sharedClickMetrika:function(){o.vAbook.Metrika.c("Левая колонка","Клик Общие контакты")},groupClickMetrika:function(){o.vAbook.Metrika.c("Левая колонка","Группы","Клик по группе")},settingsClickMetrika:function(){o.vAbook.Metrika.c("Левая колонка","Группы","Клик по шестерёнке Настроек")}}}),ns.View.define("abook-groups-dropdown",{events:{"ns-view-destroyed":"_onDestroyed","daria:vScrollerAbookContacts:scroll":"onScroll","daria:layout-changed":"onScroll"},models:{"abook-groups":!1,"abook-selected":!1,"scroller-abook-contacts":!1},yateModule:"abook",methods:{onScroll:function(){this.destroy()
},open:function(e){return this.update().then(this._openPopup.bind(this,e)),this},_openPopup:function(e){var t=this,n=this.getModel("abook-groups").get(".tag")||[],a=o.COPS["abook.groups-dropdown"];n=n.filter(function(e){return e.tid>0||-10===e.tid}).map(function(e){return{tid:e.tid,title:_.escape(e.title),action:-10===e.tid?"add-to-phone":"assign-to-group"}}),this._popup=nb.block(ns.renderNode({items:n},"js-abook-groups-dropdown","abook")),this._popup.on("nb-closed",function(){a._openView&&a._openView.destroy(),this.destroy()
}),this._popup.on("nb-destroyed",function(){a._openView&&delete a._openView,delete this._popup}.bind(this)),this._popup.on("nb-select",function(e,n){n.event.preventDefault();var a=n.ui.item.find("a"),s=a.data("action"),i=Number(a.data("tid"));this.close();var r=t.getModel("abook-selected");switch(s){case"new-group":ns.events.trigger("daria:vAbook.showGroupPopup",{type:"new-group",eventSource:"toolbar:dropdown:new-group-button"});break;case"assign-to-group":o.COPS["abook.assign-contacts-from-group"](r,{tid:i}).then(function(){r.clear(),ns.page.go()
});break;case"add-to-phone":o.COPS["abook.assign-contacts-from-phone-group"](r).then(function(){r.clear(),ns.page.go()})}}),this._popup.open({maxHeight:200,withoutTail:!1,autofocus:!0,autoclose:!0,animation:!0,where:e.where})},_onDestroyed:function(){this._popup&&this._popup.close()}}}),ns.View.define("abook-head-filters",{models:{"abook-groups":!0,"abook-contacts-filters":{"ns-model-changed":!1,"daria:mAbookContactsFilters:change-group":"syncSelectedGroup","daria:mAbookContactsFilters:refresh":"onRefresh","daria:mAbookContactsFilters:actualizeToggler":"actualizeToggler"}},params:{type:null},events:{"ns-view-htmlinit":"onHtmlInit","click .js-abook-head-toggler":"onSelectAllClick","daria:vAbookHead.selectAll@show":"onSelectAll","daria:vAbookHead.deselectAll@show":"onDeselectAll"},yateModule:"abook",methods:{SELECT_ALL_CHECKED_CLASS:"mail-AbookHead-SelectAll_checked",onHtmlInit:function(){this.$selectAllControl=this.$node.find(".js-abook-head-toggler"),this.nbGroupSelect=nb.$block(".js-abook-head-box-group-select",this.$node),this.nbGroupSelect&&this.nbGroupSelect.on("nb-changed",this.onGroupSelectChange.bind(this)),this.actualizeToggler()
},onRefresh:function(){this.actualizeToggler()},actualizeToggler:function(){this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:get-state",this.updateTogglerState.bind(this))},updateTogglerState:function(e){"checked"in e&&this.$selectAllControl.toggleClass(this.SELECT_ALL_CHECKED_CLASS,e.checked),"enabled"in e&&this.$selectAllControl.toggleClass("is-disabled",!e.enabled)},onSelectAllClick:function(){var t=!this.$selectAllControl.hasClass(this.SELECT_ALL_CHECKED_CLASS);this.toggleAll(t),"select"===this.params.type?e.c(["АК в саджесте композа","Клик Выделить все"]):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК","Клик Выделить все")
},onSelectAll:function(){this.toggleAll(!0)},onDeselectAll:function(){this.toggleAll(!1)},toggleAll:function(e){this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:toggle-select-all",e),this.actualizeToggler()},onGroupSelectChange:function(t,n){var a,s=n.getState();a="shared"===s.value?"Клик Общие контакты":s.value?"Клик по группе":"Клик Все контакты / Личные контакты",this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:group-changed",s.value),"select"===this.params.type?e.c(["АК в саджесте композа","Выбор группы",a]):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК","Выбор группы",a)
},syncSelectedGroup:function(e,o){if(this.nbGroupSelect){var t=this.nbGroupSelect.getState();t.value!=o&&this.nbGroupSelect.setState({value:o})}}}}),ns.View.define("abook-head-title",{models:{"abook-groups":!0},"params+":{targetTid:null,type:null,q:null,tid:null},yateModule:"abook",methods:{}}),ns.View.define("abook-left",{"params+":{q:null,shared:null,tid:null},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},yateModule:"abook",methods:{onHide:function(){ns.events.trigger("daria:vApp:enableLeftColumnResize")
},onShow:function(){ns.events.trigger("daria:vApp:disableLeftColumnResize")}}}),ns.View.define("abook-new-group-name",{models:{"abook-new-group-state":{"ns-model-changed":"keepValid","daria:mAbookNewGroupState:check-and-set-name":"checkAndSetName"}},events:{"ns-view-htmldestroy":"onHtmlDestroy","keydown .js-group-name":"onGroupNameKeyDown","input .js-group-name":"onGroupNameChange","blur .js-group-name":"onGroupNameBlur"},yateModule:"abook",methods:{GROUP_NAME_MAX_LENGTH:40,ENTER_KEYCODE:13,_shouldCountNameChange:!1,onHtmlDestroy:function(){var e=this._getNbGroupName();
e.destroy()},onGroupNameChange:function(){var e=this._getNbGroupName(),o=this.getModel("abook-new-group-state"),t=e.getValue().trim();t.length<=this.GROUP_NAME_MAX_LENGTH?(o.unsetHasError(),e.error&&e.error.isOpen()&&e.hideError()):(o.setHasError(),e.showError()),this._shouldCountNameChange=!0},onGroupNameBlur:function(){var e=this._getNbGroupName().getValue().trim();this._shouldCountNameChange&&e&&o.vAbook.Metrika.c("Попап создания групп в АК","указали название группы"),this._shouldCountNameChange=!1
},onGroupNameKeyDown:function(e){e.which===this.ENTER_KEYCODE&&this.getModel("abook-new-group-state").trigger("daria:mAbookNewGroupState:create-group")},checkAndSetName:function(){var e=this._getNbGroupName(),o=this.getModel("abook-new-group-state"),t=e.getValue().trim();return!t||t.length>this.GROUP_NAME_MAX_LENGTH?(o.setHasError(),void e.focus()):(o.unsetHasError(),void o.set(".name",t))},_getNbGroupName:function(){return this._nbGroupName||(this._nbGroupName=nb.block(this.$node.find(".js-group-name").get(0)),this._nbGroupName.on("nb-destroyed",function(){this._nbGroupName=null
})),this._nbGroupName}}}),ns.View.define("abook-new-group-panel",{models:{"abook-selected":{"ns-model-insert":"onSelectionsChange","ns-model-remove":"onSelectionsChange"},"abook-new-group-state":{"ns-model-changed":"keepValid","daria:mAbookNewGroupState:create-group":"createGroup"}},events:{"ns-view-htmlinit":"onHtmlInit","click .js-group-create":"createGroup","click .js-group-cancel":"onCancelClick"},yateModule:"abook",methods:{onHtmlInit:function(){this.onSelectionsChange()},createGroup:function(){var e,t=this,n=this.getModel("abook-new-group-state");
if(n.trigger("daria:mAbookNewGroupState:check-and-set-name"),!n.hasError()){e=n.get(".name");var a=this.getModel("abook-selected").getSelectedMcids().map(function(e){var o=String(e).split(".");return"0"===o[1]?o[0]:e}),s={title:e,mcid:a},i=function(){o.Statusline.showMsg({body:"Адресная книга временно недоступна. Пожалуйста, повторите через несколько минут."})};ns.request(["do-abook-group-add"],s).then(function(e){var n=e[0].getData()[0].tid;if(!n)return void i();ns.Model.get("abook-groups").invalidate(),t.closeDialog(!0),o.Autocompleter.getContact().flushCache();
var a=ns.router.generateUrl("abook",{tid:n});ns.page.go(a).then(function(){ns.events.trigger("abook-add-new-group")})},i)}},onCancelClick:function(){this.closeDialog(!1)},closeDialog:function(e){this.getModel("abook-selected").trigger(e?"daria:mAbookSelected:popup-ok-click":"daria:mAbookSelected:popup-cancel-click")},onSelectionsChange:function(){var e=this.getModel("abook-selected").models.length;this.$node.find(".js-group-contacts-limit").toggleClass("is-hidden",50>=e),this.$node.find(".js-new-group-contacts").toggleClass("mail-AbookPopup-Selected-Contacts_Empty",0===e)
}}}),ns.View.define("abook-new-group-contact",{models:{"abook-mcid-contact":!0,"abook-selected":!0},events:{"click .js-remove-contact":"deselect"},yateModule:"abook",methods:{deselect:function(){this.getModel("abook-selected").remove(this.getModel("abook-mcid-contact")),o.vAbook.Metrika.c("Попап создания групп в АК","Удаление выбранного контакта через крестик")}}}),ns.ViewCollection.define("abook-new-group-contacts",{models:{"abook-selected":{"ns-model-changed":"keepValid"}},split:{byModel:"abook-selected",intoViews:"abook-new-group-contact"},yateModule:"abook"}),ns.View.edefine("abook-page",{events:{"daria:vAbook.showGroupPopup":"onShowGroupPopup","daria:vAbook:showChooseEmailPopup":"onShowChooseEmailPopup","daria:vMessageHead:mail-common.person-popup@show":"showPersonPopup","daria:vToolbarButton:abook.noactive-add-compose@show":"showNotActiveComposeDialog"},models:{"abook-selected":!1},params:{type:null},yateModule:"abook",methods:{onShowGroupPopup:function(e,t){if(!o.abook.isPopupOpened()){var n={lang:"ru",q:ns.page.current.params.q||null,tid:this.params.tid,targetTid:this.params.tid},a=_.extend(n,t),s=this.getModel("abook-selected").models,i=ns.View.create("abook-popup",a);
if(i.show({contacts:s}),"new-group"===a.type&&t.eventSource){var r={"left-column:new-group-button":"Клик Новая группа в Левой колонке","left-column:group-teaser-button":"Клик Новая группа в Тизере в Левой колонке","toolbar:dropdown:new-group-button":"Клик Новая группа в дропдауне в Тулбаре"},l=r[t.eventSource];ns.assert(l,"Daria.vAbookPage","new group popup opener unknown for metrika"),o.vAbook.Metrika.c("Попап создания групп в АК","показ попапа",l)}}},onShowChooseEmailPopup:function(e,o){this.vPopup=ns.View.create("abook-choose-email-popup",{cid:o.cid,tid:o.tid}),this.vPopup.open({where:o.target})
},showPersonPopup:function(){o.Abook.PersonPopup.open()},showNotActiveComposeDialog:function(){var e=ns.Model.get("abook-selected",{type:"normal"});e.models.length>50&&o.Statusline.showMsg({body:"Нельзя отправить письмо более чем 50&#160;адресатам одновременно."})}}},"abook"),function(){function t(e,o){return{value:e.value||e,editable:o}}function n(e){return t(e,!0)}function a(e){return t(e,!1)}var s={"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-abook-person-write":"onClickWriteButton","click .js-abook-person-all-messages-link":"onClickAllMessagesLink","click .js-abook-person-all-attachments-link":"onClickAllAttachmentsLink","click .js-abook-person-filter":"onClickFilterButton","click .js-abook-person-edit":"onClickEditButton","mousedown .js-abook-person-save":"onClickSaveButton","click .js-abook-person-remove":"onClickRemoveButton","click .js-abook-person-to-blacklist":"onClickAddToBlacklist","mousedown .js-abook-person-edit-save":"onClickSaveButton","mousedown .js-abook-person-edit-cancel":"onClickCancelButton","click .js-abook-person-edit-cancel":"onClickCancelButton","blur .js-abook-person-input":"onCommonInputBlur","submit .js-abook-person-form":"onClickSaveButton","daria:AbookPersonDataList.listUpdate":"onListUpdate"};
ns.View.define("abook-person-common",{models:{"abook-contact":"invalidate","email-info":"keepValid","abook-groups":"keepValid","abook-person-state":{"ns-model-changed":"invalidate","ns-model-changed.isEmailsValid@show":"onFormValidUpdate","ns-model-changed.isPhonesValid@show":"onFormValidUpdate"},settings:"keepValid"},events:s,yateModule:"abook",methods:{LOWER_BIRTH_YEAR:1900,onInit:function(){},onShow:function(){var e=this.getModel("abook-person-state");return e.set(".loaded",!0),this._onFormDirty=ns.noop,this._onFormNormal=ns.noop,e.isEdit()?void _.delay(function(){this.saveInProgress=!1,this.hasOtherChanges=!1,this.nbSelectBDay=nb.$block(".js-abook-birthday-select-day",this.$node),this.nbSelectBMonth=nb.$block(".js-abook-birthday-select-month",this.$node),this.nbSelectBYear=nb.$block(".js-abook-birthday-select-year",this.$node),this.nbSaveButton=nb.$block(".js-abook-person-edit-save, .js-abook-person-save",this.$node),this.nbSelectBDay&&this.nbSelectBMonth&&this.nbSelectBYear&&(this.nbSelectBDay.on("nb-changed",this.onBirthdayChange),this.nbSelectBMonth.on("nb-changed",this.onBirthdayChange),this.nbSelectBYear.on("nb-changed",this.onBirthdayChange),this._fillBDay(),this._fillBMonth(),this._fillBYear()),this.formCacher=new o.nbFormCacher(this.$node,"abook-person"),this.formCacher.dirtyStateClass="",this.formCacher.normalStateClass="";
var e=this;this._onFormDirty=function(){e.onFormDirty.apply(e,arguments)},this._onFormNormal=function(){e.onFormNormal.apply(e,arguments)},ns.events.on("form-cacher.changed",this._onFormDirty),ns.events.on("form-cacher.unchanged",this._onFormNormal),this.$node.find(".js-abook-person-input:first").focus()}.bind(this),100):(this.$node.find(".nb-button:first").focus(),void(this.nbSaveButton=nb.$block(".js-abook-person-save",this.$node)))},onHide:function(){ns.events.off("form-cacher.changed",this._onFormDirty),ns.events.off("form-cacher.unchanged",this._onFormNormal),this.nbSelectBDay&&this.nbSelectBMonth&&this.nbSelectBYear&&(this.nbSelectBDay.destroy(),this.nbSelectBMonth.destroy(),this.nbSelectBYear.destroy(),this.nbSelectBDay=null,this.nbSelectBMonth=null,this.nbSelectBYear=null)
},yateData:function(e){var o=this.getModel("abook-person-state"),t=o.get(".state"),n={};n[t]=!0;var a=o.get(".data");return a?_.extend(n,a):_.extend(n,this._yateData()),e&&(n.context=e[0].data),o.set(".data",n),n},_yateData:function(){var o=this.getModel("email-info"),t=this.getModel("settings"),s=this.getModel("abook-groups"),i=this.getModel("abook-contact"),r=this.getModel("abook-person-state"),l={},d="staff"==o.get(".type"),c=i.isShared(),h=i.isSharedLocal(),u=c||h,p=u&&["group","department"].indexOf(i.get(".ya_directory.type"))>-1,g=i.get(".birthdate"),b=null;
if(g){var m=g.year?"%Date_dBY":"%Date_dB",k=new Date(g.year||1900,g.month1-1,g.day+1);b=e.Date.format(m,k,!0)}var f=i.get(".name")||{},v=(i.get(".tags")||[]).map(function(e){return s.get(".tag[.tid == "+e+"]")[0]});return _.extend(l,{person_id:this.params.cid,first_name:f.first,middle_name:f.middle,last_name:f.last,b_day:g&&g.day,b_month:g&&g.month1,b_year:g&&g.year}),_.extend(l,{cid:this.params.cid,mid:r.get(".ids"),name:f.full,monogram:i.get(".monogram"),birthday:b,email:this.params.email,ref:this.params.ref,isStaff:d,isShared:c,isSharedLocal:h,isWorkspace:u,isGroup:p,descr:i.get(".description"),photo:i.get(".photo.partial_url"),phone:(i.get(".phone")||[]).map(c||h?a:n),tags:v,tagsToRemove:[],mail_addr:(i.get(".email")||[]).map(c||h?a:n),socials:t.get(".show_socnet_avatars")&&o.get(".social.profile")||[]}),l.photo&&(l.photo+=u?"islands-retina-50":"large"),d&&!o.get(".staff._error")?this._fillStaffData(l):u&&(l.summary=i.get(".summary"),l.group=i.get(".department"),l.title=i.get(".title")),l.isEmpty=this.isEmptyMainData(l),l
},_fillStaffData:function(e){var o=this.getModel("email-info");e.services=o.get(".staff.services"),e.group=o.get(".staff.group.name"),e.title=o.get(".staff.position");var t=[].concat(o.get(".staff.phones.mobile")||[]),n=o.get(".staff.phones.work");n&&t.push(n),e.phone=t.map(a).concat(e.phone)},_fillBDay:function(){var e=this.getModel("abook-person-state"),o=null;if(!e.isNew()){var t=this.getModel("abook-contact");o=t.get(".birthdate.day")}for(var n=[{value:1,text:1,selected:!o||1===o}],a=2;31>=a;++a)n.push({value:a,text:a,selected:a===o});
this.nbSelectBDay.setSource(n)},_fillBMonth:function(){var o=this.getModel("abook-person-state"),t=null;if(!o.isNew()){var n=this.getModel("abook-contact");t=n.get(".birthdate.month1")}for(var a=[{value:1,text:e.i18n.index(["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],0),selected:!t||1===t}],s=1;12>s;++s){var i=s+1;a.push({value:i,text:e.i18n.index(["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],s),selected:i===t})
}this.nbSelectBMonth.setSource(a)},_fillBYear:function(){var e=this.getModel("abook-person-state"),o=null;if(!e.isNew()){var t=this.getModel("abook-contact");o=t.get(".birthdate.year")}for(var n=[{value:1900,text:1900,selected:!o||1900===o}],a=(new Date).getFullYear(),s=1;s+this.LOWER_BIRTH_YEAR<=a;++s){var i=this.LOWER_BIRTH_YEAR+s;n.push({value:i,text:i,selected:i===o})}this.nbSelectBYear.setSource(n)},onBirthdayChange:function(e,o){var t="b_"+o.$node.data("target");ns.Model.get("abook-person-state").set(".data."+t,o.value)
},onClickEditButton:function(e){e.stopPropagation(),e.preventDefault(),this.sendMetric("изменить");var o=this.getModel("abook-person-state");o.setCurrentState("edit")},onClickCancelButton:function(e){e.stopPropagation(),e.preventDefault(),this.sendMetric("отмена"),_.delay(function(){var e=this.getModel("abook-person-state");e.setCurrentState("view")}.bind(this))},onClickRemoveButton:function(e){e.stopPropagation(),e.preventDefault();var t=this.getModel("abook-person-state"),n=t.get(".email"),a=this.getModel("abook-contact"),s=ns.Model.get("abook-contact",{email:n}),i=ns.Model.get("abook-selected");
i.clear(),i.insert(a),o.COPS["abook.remove-contacts"](i),a.invalidate(),s.invalidate()},onClickAddToBlacklist:function(t){t.stopPropagation(),t.preventDefault(),this.sendMetric("черный список");var n=this.getModel("abook-person-state"),a=n.get(".email");if(a){var s=ns.Model.get("account-information").getEmails();return _.includes(s,a)?void o.Statusline.showMsg({name:"setup.filters-blist-add-self-forbidden",body:"Произошла ошибка. Нельзя добавить свой адрес в чёрный список."}):void e.Services.load("#setup",function(){function e(){o.Statusline.showMsg({name:"setup.filters-lists-add-from-message",body:"Адрес "+a+' добавлен в <a href="#setup/filters">чёрный список</a>. Письма с него не будут больше приходить в ваш ящик.'})
}function t(){o.Statusline.showMsg({name:"setup.filters-lists-add-from-message",body:"Произошла ошибка. Мы уже в курсе случившегося и стараемся исправить её как можно скорее."})}ns.forcedRequest(["filters-blacklist","filters-whitelist"],{}).then(function(n){var s=n[0],i=n[1];s.hasEmail(a)?o.Statusline.showMsg({name:"setup.filters-lists-add-from-message",body:"Этот адрес уже есть в чёрном списке. Если вы продолжаете получать письма с него, сообщите об этом в службу поддержки."}):i.hasEmail(a)?o.Dialog.confirm({body:"<p>Вы хотите добавить в чёрный список адрес из белого списка. После добавления адрес "+a+" будет заблокирован, и вы перестанете получать с него письма. Продолжить?</p>",width:350,okValue:"Да",cancelValue:"Нет",okHandler:function(){var n=o.Filter.appendEmailBlackList(a);
n.progress(function(e){"already-in-anti"===e&&n.notify("ok")}).done(e).fail(t)}}):o.Filter.appendEmailBlackList(a).done(e).fail(t)})})}},onCommonInputBlur:function(e){var o=this.getModel("abook-person-state");if("edit"===o.get(".state")){var t=$(e.currentTarget),n=t.data("target"),a=t.val();o.set(".data."+n,a),this.formCacher.changeDisplayMode()}},onClickSaveButton:function(e){e.stopPropagation(),e.preventDefault(),this.nbSaveButton.focus(),_.delay(function(){var e=this.getModel("abook-person-state"),o=this.formCacher&&(this.formCacher.isFormDirty()||this.hasOtherChanges)||this.fromYabble,t=e.isEdit(),n=this.isEmptyEditData(e.get(".data")),a=e.isFormValid()&&!this.saveInProgress&&(!t||o&&!n);
return a?(this.saveInProgress=!0,void this._onClickSaveButton().then(this.saveSuccess,this).always(function(){this.saveInProgress=!1},this)):void this.nbSaveButton.blur()}.bind(this))},_onClickSaveButton:function(){this.sendMetric("сохранить изменения");var e=this.getModel("abook-contact"),o=this.getModel("abook-person-state"),t=o.get(".data");if(t){!e.get(".description")&&t.descr&&this.sendMetric("добавление комментария"),!e.get(".birthdate")&&(t.b_day||t.b_month||t.b_year)&&this.sendMetric("добавление даты рождения");
var n=this.params.email,a=t.email.length&&-1===t.email.indexOf(n);return t.mainEmail=n,t.isNewMainEmail=a,ns.Model.get("abook-person-manager").updatePerson(e,t).then(function(e){if(o.get(".ids")&&ns.Model.invalidateAll("abook-contacts"),a){var t=e[1],n=t.get(".email[0].value")[0],s=t.get(".email[0].ref")[0];o.set(".email",n),o.set(".ref",s)}return e})}},saveSuccess:function(e){var o=this.getModel("abook-person-state"),t=e[0].get(".cid");o.setIfChanged(".cid",t),ns.events.trigger("daria:vAbookPerson.personInfoChanged"),o.setCurrentState("view")
},onFormDirty:function(e,o){if("abook-person"===o.instance&&this.nbSaveButton){var t=ns.Model.get("abook-person-state"),n=t.get(".data");return!this.isEmptyEditData(n)&&t.isFormValid()||this.formCacher.hasFocusedControls?this.hasOtherChanges||o.listUpdate?(this.hasOtherChanges=!0,void this.nbSaveButton.enable()):void this.nbSaveButton.enable():void this.disableSaveButton()}},onFormNormal:function(e,o){"abook-person"===o.instance&&(this.hasOtherChanges||this.fromYabble||this.formCacher.hasFocusedControls||this.disableSaveButton())
},disableSaveButton:function(){this.nbSaveButton.$node.is(":focus")&&this.$node.find(".js-abook-person-edit-cancel").focus(),this.nbSaveButton.disable()},isEmptyMainData:function(e){return!(e.mail_addr.length||e.tags.length||e.phone.length||e.birthday||e.descr||e.socials.length||e.services&&e.services.length)},isEmptyEditData:function(e){return this.isEmptyHeadEditData(e)&&this.isEmptyMainEditData(e)},isEmptyMainEditData:function(e){return!e.mail_addr.length&&!e.tags.length&&!e.phone.length},isEmptyHeadEditData:function(e){return!e.first_name&&!e.middle_name&&!e.last_name
},onFormValidUpdate:function(){this.onFormDirty(null,{instance:"abook-person"})},onListUpdate:function(e,o){this.onFormDirty(null,o),this.formCacher.updateControls()},onClickWriteButton:function(){this.sendMetric('клик на "написать письмо"')},onClickAllMessagesLink:function(){this.sendMetric('клик на иконку "переписка"')},onClickAllAttachmentsLink:function(){this.sendMetric('клик на иконку "вложения"')},onClickFilterButton:function(){this.sendMetric("фильтр")},sendMetric:function(e){var t="abook"===ns.page.current.page?"В АК":"В Почте";
o.vAbook.Metrika.c("Карточка контакта",t,e)}}}),ns.View.define("abook-person-message",{models:{"message-body":"keepValid","email-info":"keepValid","abook-person-state":"invalidate",settings:"keepValid"},events:s,yateModule:"abook",methods:{_yateData:function(){var e=this.getModel("abook-person-state"),o=this.getModel("settings"),t=this.getModel("email-info"),n=this.getModel("message-body").getFieldsByType("from")[0],s="staff"==t.get(".type"),i=n.is_service,r={mid:e.get(".ids"),mail_addr:[n.email].map(a),name:n.name,monogram:n.monogram,email:n.email,ref:n.ref,socials:o.get(".show_socnet_avatars")&&t.get(".social.profile")||[],isStaff:s,isService:i,unknown:!0};
return s&&!t.get(".staff._error")&&this._fillStaffData(r),r},_onClickSaveButton:function(){this.sendMetric("добавить в адресную книгу");var e=this.getModel("message-body").getFieldsByType("from")[0],o={first_name:e.name,mail_addr:[e.email]};return ns.Model.get("abook-person-manager").addPerson(o)},saveSuccess:function(e){var o=this.getModel("abook-person-state"),t=e[0].get(".cid");o.set(".cid",t),o.setCurrentState("view")}}},"abook-person-common"),ns.View.define("abook-person-new",{models:{"abook-person-state":{"ns-model-changed":"invalidate","ns-model-changed.isEmailsValid@show":"onFormValidUpdate","ns-model-changed.isPhonesValid@show":"onFormValidUpdate"}},events:s,yateModule:"abook",methods:{onInit:function(){var e=this.getModel("abook-person-state");
this.fromYabble=Boolean(e.get(".yabbleId")),e.setCurrentState("edit")},_yateData:function(){var e=this.getModel("abook-person-state");return{"new":!0,edit:!0,first_name:e.get(".first_name")||"",mail_addr:(e.get(".email")||[]).map(n),phone:[],tags:[]}},_onClickSaveButton:function(){var e=this.getModel("abook-person-state"),o=e.get(".data");return ns.Model.get("abook-person-manager").addPerson(o)},saveSuccess:function(e){ns.Model.invalidate("abook-groups");var o=e[0],t=this.getModel("abook-person-state"),n=o.get(".cid");
if(this.fromYabble)return ns.events.trigger("yabble.add-to-abook",{id:t.get(".yabbleId"),cid:n}),t.set(".ref",no.jpath(".email[0].ref",o.getData())),t.set(".cid",n),void t.setCurrentState("view");var a=no.jpath(".current.params.tid",ns.page),s=o.get(".name.full"),i=no.jpath(".email[0].value",o.getData())||[],r=(s||i[0]||"").charAt(0).toUpperCase();t.setCurrentState("closed"),a||!r?ns.page.go():ns.events.trigger("daria:vAbookHead.changeSymbolFilter",r)}}},"abook-person-common")}(),ns.View.define("abook-person-popup",{models:{"abook-person-state":{"ns-model-changed":"keepValid","ns-model-changed.loaded":"updatePosition","ns-model-changed.state":"onUpdateState","ns-model-changed.cid":"onUpdateState"}},events:{"click ._nb-popup-close":"onClickCloseMetric"},yateModule:"abook",methods:{POPUP_MAX_WIDTH:640,POPUP_MIN_HEIGHT:140,POPUP_MAX_HEIGHT:440,onUpdateState:function(){var e=this.getModel("abook-person-state"),o=e.get(".state");
return"closed"===o?void this.close():void this.updateByLayout("abook-person-popup",e.getData(),{execFlag:ns.U.EXEC.PARALLEL})},updatePosition:function(){this.nbPopup&&this.nbPopup.$node.position(this.nbPopupPosition)},open:function(e,o){var t=this.getModel("abook-person-state");t.setData(o);var n=_.extend({width:this.POPUP_MAX_WIDTH,minHeight:this.POPUP_MIN_HEIGHT,maxHeight:this.POPUP_MAX_HEIGHT,withoutTail:!0},e);this.updateByLayout("abook-person-popup",o,{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopupPosition=n.how,this.nbPopup=nb.block(this.node),this.nbPopup.open(n),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},onClickCloseMetric:function(){var e="abook"===ns.page.current.page?"В АК":"В Почте";o.vAbook.Metrika.c("Карточка контакта",e,"крестик")}}}),function(){function t(e,o){return{value:e.value||e,editable:o}}function n(e){return t(e,!0)}ns.View.define("abook-person-data-list",{yateModule:"abook",methods:{onShow:function(){_.delay(this.updateFormValid.bind(this),100)
},onListInputBlur:function(e){var o=this.getModel("abook-person-state");if("edit"===o.get(".state")){var t=nb.$block(e.currentTarget,this.$node),n=t.$control.data("target"),a=t.$control.data("index"),s=[].concat(o.get(".data."+n)||[]),i=(t.getValue()||"").trim();i?this.validate(i)?(s[a].value=i,t.setValue(i),this.hideError(t)):this.showError(t):(s.splice(a,1),o.set(".data."+n,s),this.hideError(t))}},onAddInputBlur:function(e){var o=this.getModel("abook-person-state");if("edit"===o.get(".state")){var t=nb.$block(e.currentTarget,this.$node),a=t.$control.data("target"),s=[].concat(o.get(".data."+a)||[]),i=(t.getValue()||"").trim();
i?this.validate(i)?(s.push(n({value:i})),o.set(".data."+a,s),this.hideError(t),this.addFieldMetric()):this.showError(t):(t.setValue(i),this.hideError(t))}},onClickListItemRemove:function(e){var o=this.getModel("abook-person-state"),t=$(e.currentTarget),n=t.data("target"),a=t.data("index"),s=[].concat(o.get(".data."+n)||[]);s.splice(a,1),o.set(".data."+n,s)},listUpdate:function(){this.update().then(function(){ns.events.trigger("daria:AbookPersonDataList.listUpdate",{instance:"abook-person",listUpdate:!0})
}.bind(this))},showError:function(e){e.showError({appendTo:"#"+e.id}),this.updateFormValid()},hideError:function(e){e.hideError(),this.updateFormValid()},hasErrors:function(){return this.$node.find(".js-abook-person-list-item, .js-abook-person-list-item-add").toArray().some(function(e){var o=nb.block(e);return o.error&&o.error.isOpen()})},validate:function(){return!0},sendMetric:function(e){var t="abook"===ns.page.current.page?"В АК":"В Почте";o.vAbook.Metrika.c("Карточка контакта",t,e)},updateFormValid:ns.todo,addFieldMetric:ns.todo}}),ns.View.define("abook-person-email-list",{models:{"abook-person-state":{"ns-model-changed":"keepValid","ns-model-changed.data.mail_addr":"listUpdate"}},events:{"click .js-abook-person-list-item-remove":"onClickListItemRemove","blur .js-abook-person-list-item":"onListInputBlur","blur .js-abook-person-list-item-add":"onAddInputBlur","ns-view-show":"onShow"},yateModule:"abook",methods:{updateFormValid:function(){var e=!this.hasErrors();
this.getModel("abook-person-state").changeEmailsValid(e)},validate:function(o){return e.FormValidation.checkEmail(o)},addFieldMetric:function(){this.sendMetric("добавление адреса")}}},"abook-person-data-list"),ns.View.define("abook-person-phone-list",{models:{"abook-person-state":{"ns-model-changed":"keepValid","ns-model-changed.data.phone":"listUpdate"}},events:{"click .js-abook-person-list-item-remove":"onClickListItemRemove","blur .js-abook-person-list-item":"onListInputBlur","blur .js-abook-person-list-item-add":"onAddInputBlur","ns-view-show":"onShow"},yateModule:"abook",methods:{updateFormValid:function(){var e=!this.hasErrors();
this.getModel("abook-person-state").changePhonesValid(e)},validate:function(e){return/^[\d\s+#*()-]*$/.test(e)},addFieldMetric:function(){this.sendMetric("добавление телефона")}}},"abook-person-data-list"),ns.View.define("abook-person-tags-list",{models:{"abook-person-state":{"ns-model-changed":"keepValid","ns-model-changed.data.tags":"listUpdate"}},events:{"click .js-abook-person-list-item-remove":"onClickListItemRemove"},yateModule:"abook",methods:{onClickListItemRemove:function(e){var o=this.getModel("abook-person-state"),t=$(e.currentTarget),n=t.data("index"),a=[].concat(o.get(".data.tags")||[]),s=o.get(".data.tagsToRemove");
s.push(a.splice(n,1)[0]),o.set(".data.tags",a),o.set(".data.tagsToRemove",s)}}},"abook-person-data-list")}(),function(){var t=!1;o.abook.isPopupOpened=function(){return t},o.abook.setPopupOpenedState=function(e){t=e},ns.View.edefine("abook-popup",{models:{"abook-selected":{"ns-model-changed":!1,"ns-model-insert":"popupUpdate","ns-model-remove":"popupUpdate","daria:mAbookSelected:popup-ok-click":"onSelectedEmails","daria:mAbookSelected:popup-cancel-click":"onCancelDialog","daria:mAbookSelected:has-selected-emails":"onHasSelectedEmails","daria:mAbookSelected:change-group":"onChangeGroupRequested"},"abook-contacts":{"ns-model-changed":!1,"ns-model-insert":"popupUpdate","ns-model-remove":"popupUpdate"},"abook-contacts-filters":{"ns-model-changed":!1,"daria:mAbookContactsFilters:group-changed":"onGroupChanged"}},events:{"ns-view-init":"setStateAsOpened","ns-view-touch":"onTouch","click ._nb-popup-close":"onPopupCloserClick","daria:vAbookContacts:onUpdate@show":"popupUpdate","wheel window":"onWheel"},"params+":{q:null,tid:"",targetTid:null,type:null,defaultField:null,shared:0},yateModule:"abook",methods:{show:function(e){return e.resultDeferred&&(this.resultDeferred=e.resultDeferred),this.setSelectedEmails(e.emails),e.contacts&&this.setSelectedContacts(e.contacts),new ns.Update(this,ns.layout.page("abook-popup",this.params),this.params,{execFlag:ns.U.EXEC.PARALLEL}).render().then(this.openDialog.bind(this))
},setSelectedEmails:function(e){this.selectedEmails=_(e).map(function(e,o){return _.each(e,function(e){e.field=o})}).flatten().value()},setSelectedContacts:function(e){var o=this.getModel("abook-selected"),t=o.abookContactsToAbookMcidContacts(e,this.params.tid,0);if(o.insert(t),"add-to-group"===this.params.type){var n=this._getCurrentAbookContactsModel();n.clear(),n.insert(e)}},_getCurrentAbookContactsModel:function(){return ns.Model.get("abook-contacts",this.params)},openDialog:function(){var e={where:$(window),how:{my:"center",at:"center",of:window,fixed:!0},withoutTail:!0,autofocus:!0,autoclose:!1};
this.convertSelectedEmailsToModels(),this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.onClose.bind(this))},onCancelDialog:function(){this.closeDialog(),"select"===this.params.type?e.c(["АК в саджесте композа",'клик на "отменить"']):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК",'клик на "отменить"')},closeDialog:function(){this.nbPopup&&this.nbPopup.close()},convertSelectedEmailsToModels:function(){if(this.selectedEmails.length){var e=this._getCurrentAbookContactsModel(),o=this.getModel("abook-selected"),t=[];
_.each(e.models,function(e){_.each(this.selectedEmails,function(n,a){if(!n)return!1;var s=e.get('.email[.value == "'+n.email+'"]');if(s=_.flatten(s)[0]){var i=e.get(".cid")+"."+s.id,r=o.abookContactToAbookMcidContact(e,i);return this.selectedEmails[a]=null,r.set(".field",n.field),t.push(r),!1}},this),this.selectedEmails=_.remove(this.selectedEmails,null)},this),o.insert(t)}},onGroupChanged:function(e,o){var t;t="shared"===o?{tid:null,shared:1}:{tid:o,shared:0},this.update(t,{execFlag:ns.U.EXEC.PARALLEL}).then(this.onPopupUpdated,this)
},onChangeGroupRequested:function(e,o){this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:change-group",o)},onSelectedEmails:function(){switch(this.params.type){case"select":this._selectedNotify(),this.closeDialog(),e.c(["АК в саджесте композа",'клик на "добавить"']);break;case"add-to-group":this._addSelectedToGroup();break;case"new-group":this.closeDialog(),o.vAbook.Metrika.c("Попап создания групп в АК",'клик на "создать"')}},_addSelectedToGroup:function(){var e=this,o=this.params.targetTid,t=this.getModel("abook-selected").getSelectedMcids();
ns.Model.get("abook-groups").addToGroup({tid:o,mcids:t}).then(function(){e.closeDialog(),ns.page.go()})},_selectedNotify:function(){var e=this.getModel("abook-selected"),o=e.getData().items,t=[].concat(o,this.selectedEmails);this.resultDeferred&&this.resultDeferred.resolve(t)},onPopupCloserClick:function(){"select"===this.params.type?e.c(["АК в саджесте композа",'клик на "крестик"']):"new-group"===this.params.type&&o.vAbook.Metrika.c("Попап создания групп в АК",'клик на "крестик"')},onClose:function(){o.abook.setPopupOpenedState(!1),o.Dropdown.closeAll(),this.resultDeferred&&!this.resultDeferred.promise().isResolved()&&this.resultDeferred.reject(),setTimeout(function(){if(this.nbPopup){var e=this.getModel("abook-selected");
this.nbPopup.destroy(),delete this.nbPopup,this.invalidate(),this.destroy(),_.each(e.models,function(e){e.set(".field",null)}),e.clear(),ns.Model.destroy(e)}}.bind(this),0)},onHasSelectedEmails:function(e,o){var t=this.getModel("abook-selected"),n=this.selectedEmails&&this.selectedEmails.length||t.models.length;o(n)},popupUpdate:function(){this.update(null,{execFlag:ns.U.EXEC.PARALLEL}).then(this.onPopupUpdated,this)},onPopupUpdated:function(){this.getModel("abook-contacts-filters").trigger("daria:mAbookContactsFilters:refresh"),this.convertSelectedEmailsToModels()
},getScrollContent:function(e){var o=$(e.target),t=o.closest(".js-allow-scroll-in-popup");if(t.length)return t[0];var n=nb.$block(".js-abook-head-box-group-select");if(n){var a=n.$dropdown;if(o.closest(a).length)return a.children()[0]}return null},setStateAsOpened:function(){o.abook.isPopupOpened()||o.abook.setPopupOpenedState(!0)}}},"prevent-scroll-propagation-mixin","abook")}(),ns.View.define("abook-popup-footer",{models:{"abook-selected":{"ns-model-changed":"keepValid","ns-model-insert":"toggleOkButton","ns-model-remove":"toggleOkButton"}},events:{"ns-view-htmlinit":"onHtmlInit","click@show .js-abook-popup-ok":"onOk","click@show .js-abook-popup-cancel":"onCancel"},yateModule:"abook",methods:{onHtmlInit:function(){this.nbOkButton=nb.$block(".js-abook-popup-ok",this.$node),this.toggleOkButton()
},onOk:function(){this.getModel("abook-selected").trigger("daria:mAbookSelected:popup-ok-click")},onCancel:function(){this.getModel("abook-selected").trigger("daria:mAbookSelected:popup-cancel-click")},toggleOkButton:function(){var e=this;this.getModel("abook-selected").trigger("daria:mAbookSelected:has-selected-emails",function(o){o?e.nbOkButton.enable():e.nbOkButton.disable()})}}}),ns.View.define("abook-restore-dialog",{models:{"abook-backups-list":!0},ctor:function(){this._timeouts=[],this._onOpenDialog=this._onOpenDialog.bind(this),this._onCloseDialog=this._onCloseDialog.bind(this),this._onClickRestore=this._onClickRestore.bind(this)
},events:{"keydown@show document":"_onKeydown","click@show .js-item":"_onClickItem"},yateModule:"abook",methods:{METRIKA_ROOT:"Бэкап контактов",SELECTED_ITEM_CLASS:"abook-restore-item_selected",show:function(){var e=ns.layout.page("abook-restore-dialog",this.params);return new ns.Update(this,e,this.params,{execFlag:ns.U.EXEC.ASYNC}).render().then(this._openDialog,this)},_openDialog:function(){o.Dialog.open({title:"",width:580,additionalClass:"abook-restore-dialog",body:this.$node,onopen:this._onOpenDialog,onclose:this._onCloseDialog})
},_onOpenDialog:function(){e.c(this.METRIKA_ROOT,"Вызов попапа бэкапов"),nb.init(this.node),this._timeouts=[],this._nbRestore=nb.$block(".js-restore-button",this.$node),this._nbRestore.on("click",this._onClickRestore),this._toggleMouseScrollLock(!0,this.$node.find(".js-content"))},_onCloseDialog:function(){nb.destroy(this.node),this._clearSpinnerTimeouts(),this._nbRestore.off("click",this._onClickRestore),this._toggleMouseScrollLock(!1),this.invalidate(),this.destroy()},_onKeydown:function(o){var t=!1;
switch(o.which){case e.Common.keyCode.ENTER:this._nbRestore.isEnabled()&&(this._onClickRestore(),t=!0);break;case e.Common.keyCode.UP:case e.Common.keyCode.DOWN:if(this.$node.find(".js-list:visible").length){var n=o.which===e.Common.keyCode.DOWN?1:-1;this._shiftSelection(n),t=!0}break;case e.Common.keyCode.TAB:this._nbRestore.$node.is(":focus")||(this._nbRestore.focus(),t=!0)}t&&(o.preventDefault(),o.stopPropagation())},_shiftSelection:function(e){var o=this.$node.find("."+this.SELECTED_ITEM_CLASS);
if(o.length){var t=o[e>0?"next":"prev"](".js-item");t.length&&this._selectItem(t)}else e>0&&this._selectItem(this.$node.find(".js-item:first"))},_onClickItem:function(e){var o=$(e.currentTarget);this._selectItem(o)},_selectItem:function(e){e&&e.length&&(this.$node.find("."+this.SELECTED_ITEM_CLASS).removeClass(this.SELECTED_ITEM_CLASS),e.addClass(this.SELECTED_ITEM_CLASS),this._nbRestore.enable())},_onClickRestore:function(){e.c(this.METRIKA_ROOT,"Выбор одного из вариантов бэкапа"),this.$node.find(".js-error").addClass("g-hidden"),this._nbRestore.disable(),this._turnOnSpinnerAfter(150);
var o=this.$node.find("."+this.SELECTED_ITEM_CLASS),t=o.data("rev");this._lastRequestDateString=o.find(".js-date").attr("title"),ns.forcedRequest("do-abook-backups-restore",{rev:t}).then(this._onAbookBackupsRestoreSuccess,this._onAbookBackupsRestoreError,this)},_onAbookBackupsRestoreError:function(){e.c(this.METRIKA_ROOT,"Операция восстановления неудачна (попап остался)"),this._clearSpinnerTimeouts(),this._toggleSpinner(!1),this.$node.find(".js-error").removeClass("g-hidden"),this._nbRestore.enable()
},_onAbookBackupsRestoreSuccess:function(e){this._clearSpinnerTimeouts(),"OK"===e[0].get(".result")?(ns.Model.invalidate("abook-contact"),ns.Model.invalidate("abook-contacts"),ns.Model.invalidate("abook-backups-list"),o.Dialog.close(),ns.page.refresh().then(this._onRefreshAfterSuccess,this)):this._onAbookBackupsRestoreError()},_onRefreshAfterSuccess:function(){o.Statusline.showMsg({name:"abook.restore",body:"Контакты от "+this._lastRequestDateString+" восстановлены."}),e.c(this.METRIKA_ROOT,"Операция восстановления удачна (попап закрылся)")
},_toggleSpinner:function(e){this.$node.find(".js-content-container").toggleClass("g-hidden",e),this.$node.find(".js-spinner").toggleClass("g-hidden",!e)},_turnOnSpinnerAfter:function(e){this._timeouts.push(window.setTimeout(this._toggleSpinner.bind(this,!0),e))},_clearSpinnerTimeouts:function(){for(var e=0;e<this._timeouts.length;e++)window.clearTimeout(this._timeouts[e]);this._timeouts=[]},_toggleMouseScrollLock:function(e,o){function t(e){if(!$.contains(o[0],e.target))return!1;var t=e.wheelDeltaY,n=o.scrollTop();
return t>0&&0===n||0>t&&n+o.height()>=o.find(".js-list").outerHeight()?!1:void 0}e?(window.addEventListener("DOMMouseScroll",t),window.onmousewheel=document.onmousewheel=t):(window.removeEventListener("DOMMouseScroll",t),window.onmousewheel=document.onmousewheel=null)}}}),ns.View.edefine("abook-search",{yateModule:"abook",models:{"search-view":{"ns-model-changed":"keepValid","ns-model-changed.folded":"onChangeFolded"},settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"toggleSearch","ns-model-changed.liza_minified_header":"toggleSearch"}},events:{"mousedown ._nb-input-reset":"goToAllPageContacts"},params:{},ctor:function(){this.onSearchInputKeyPress=_.debounce(this.onSearchInputKeyPress,600),this._$searchOptionsToggle=null,this._$spinner=null,this._$clearButton=null,this._$searchButton=null,this.$input=null,this._$nbInput=null
},methods:{onSearchInputKeyPressProxy:function(){this.onSearchInputKeyPress()},onSearchInputButtonPress:function(){""!==this.$input.val()?this.openSearch():this.onSearchOpenFocus()},onSearchInputKeyPress:function(){var e=ns.page.current.params.q||"",t=this.$input.val().trim(),n=_.extend({},ns.page.current.params,{q:t});return this._$searchButton.removeClass("is-disabled"),t===e?!0:(this.params=_.extend(this.params,n),void(t?(delete n.shared,this.goToTheSearchUrl(ns.router.generateUrl("abook",n)),o.vAbook.Metrika.c("Поиск","поискали")):e&&this.goToAllPageContacts()))
},toggleSearch:function(){var e=ns.page.current.params;return this.params.folded?(this.unfoldSearch(),void delete this.params.folded):(this.foldSearch(),void(e.q&&this.unfoldSearch()))},onSearchOpenClick:function(e){e.preventDefault();var o=this.getModel("search-view");return o.isFolded()?(this.unfoldSearch(),!1):this.$input.val()?void 0:(this.$input.focus(),!1)},foldSearch:function(){var e=this.getModel("search-view");e.setFolded(!0),this._$searchButton&&("abook"===ns.page.current.page&&ns.page.current.params.q&&this.isCompactHeaderMode()?this._$searchButton.addClass("is-active"):this._$searchButton.removeClass("is-active")),this.headTabsRecalculate()
},onSearchOpenHotkey:function(){var e=this.getModel("search-view");return e.isFolded()?(o.vAbook.Metrika.c("Поиск","открыли"),void this.unfoldSearch()):void this.$input.focus()},openSearch:function(){var e=this.getInitialSearchParams(),o=ns.router.generateUrl("abook",e);this.goToTheSearchUrl(o)},goToTheSearchUrl:function(e){this.getModel("search-view").setFolded(!1),ns.page.go(e)},goToAllPageContacts:function(){var e=_.extend({},ns.page.current.params);this.params.shared&&!e.tid&&(e.shared=this.params.shared),e.q&&(this.params.folded="0"),delete e.q,delete this.params.shared,this.goToTheSearchUrl(ns.router.generateUrl("abook",e))
},getInitialSearchParams:function(){return ns.page.current.params},goToTheCorrectPageFromHistory:function(e){var o=ns.page.history.getFirstValidPrevious(function(o){return!e.test(o)});if(!o){var t=_.extend({},ns.page.current.params);return delete t.q,void this.goToTheSearchUrl(ns.router.generateUrl("abook",t))}ns.page.go(o,"replace")},closeSearch:function(){this.foldSearch(),this.params={},this.isCompactHeaderMode()||ns.page.current.params.q&&this.goToTheCorrectPageFromHistory(/^#(search(-options)?(\?|$)|contacts\/.*?\/.+)/),o.vAbook.Metrika.c("Поиск","закрыли")
},onSearchOpenFocus:function(){this._$nbInput.$node.hasClass("_nb-is-focused")||this.$input.focus();var e=this.getModel("search-view");e.isFolded()&&(o.vAbook.Metrika.c("Поиск","открыли"),this.unfoldSearch())},onrepaint:function(e,o){this._$nbInput.setValue(o.q?o.q:"")},onshow:function(e,o){this._bindEventListeners(),this._$nbInput.setValue(o.q)},_onKeyDown:function(o){var t=e.Common.keyCode;switch(o.which){case t.ESC:this.closeSearch()}}}},"search"),ns.layout.define("abook",{"app search-box@":{"abook-search":{}},"app left-box@":function(){var t={"abook-left-box@":{"abook-left":{"abook-groups":{}}}};
return o.is3pane()&&(t.footer={"footer-journal-link&":{},"footer-help-link":{}}),o.is3pane()||(e.Config.MAY_HAVE_ADV&&(t.banner={}),e.Config.MAY_HAVE_NEWS&&(t["informer-box@"]=function(){var o=ns.page.current.page,t=Boolean(!e.Config.pddDomain&&!window.opener&&"404"!==o&&"403"!==o&&-1===o.indexOf("setup"));return t?{"informer-news&":{}}:void 0})),t},"app right-box@":{"abook-page":{"abook-head-box@":{"abook-head-title":{}},"abook-contacts-box@":function(e){var t={"abook-contacts":{},"abook-contacts-pager":{},"abook-dropzone-box@":{}};
return e.tid||"normal"!=e.type||e.shared||(t["abook-dropzone-box@"]="abook-dropzone"),o.is2pane()&&(t.footer={"footer-journal-link&":{},"footer-help-link":{}}),t}}}},"common+left+toolbar"),ns.layout.define("abook-popup",{"abook-popup":function(e){var o={"abook-head-box@":function(e){var o={};return("select"===e.type||"new-group"===e.type)&&(o["abook-head-filters"]={}),"add-to-group"===e.type&&(o["abook-head-title"]={}),o},"abook-contacts-box@":{"abook-contacts":{},"abook-contacts-pager":{}}};return"new-group"===e.type&&(o["abook-new-group-name"]={},o["abook-new-group-panel"]={"abook-new-group-contacts-box@":{"abook-new-group-contacts":{}}}),("select"===e.type||"add-to-group"===e.type)&&(o["abook-popup-footer"]={}),o
}}),ns.layout.define("abook-restore-dialog",{"abook-restore-dialog":{}}),ns.layout.define("abook-person-popup",{"abook-person-popup":function(e){return{"abook-person-box@":function(){var o={},t={"abook-person-email-list":{},"abook-person-phone-list":{}};return e.shared||(t["abook-person-tags-list"]={}),null!=e.cid?o["abook-person-common&"]=t:null!=e.ids?o["abook-person-message&"]=t:o["abook-person-new&"]=t,o}}}}),function(){var e=ns.Model.get("all-toolbar-buttons"),o={accept:".js-abook-entry",tolerance:"pointer",activeClass:"g-drop-place",hoverClass:"g-drop-place_hover"},t=["abook-select-all","abook-deselect-all","compose-abook","abook-add",{id:"abook-remove",droppableParams:o},{id:"abook-togroup",droppableParams:o},{id:"abook-outofgroup",droppableParams:o},"abook-restore","abook-more"];
ns.Model.get("toolbar",{layout:"abook"}).setData({scroll:!0,settings:!0,buttons:e.getButtonsByDeclarations(t)})}()}(Jane,Daria)});