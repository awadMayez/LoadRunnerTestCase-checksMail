Jane.module("jane.mail.js",function(){"use strict";function e(e,t){Jane.Services.load("#setup",function(){var e=Daria.LabelCreatePopup(t);$.extend(e,{success:function(e){var i=ns.page.current.page;"setup"!==i&&"done"!==i&&("only-create"in t?ns.events.trigger("daria:vLabels:update"):_.isFunction(t.onLabelCreated)?t.onLabelCreated(e):ns.action.run("label",{current_label:e,"message-id":t["message-id"],contextMenu:t.contextMenu,isNeedDeselect:t.isNeedDeselect}))}}),"promo"in t&&ns.Model.get("settings").setSettingOn("no-labels-promo"),e.init()
})}Daria.indexer={},Daria.indexer.reindexUser=function(e){ns.Model.get("filters").isApplyAvailable()||ns.request("do-indexer",{fromSetupFilters:Boolean(e)})},Daria.initializeMetrika=function(e,t,i,n){if(!e)throw new Error("initializeMetrika: parameter `metrikaBase` is required");if(!t)throw new Error("initializeMetrika: parameter `objectToDecorate` is required");if(!_.isObject(i))throw new Error("initializeMetrika: parameter `metrikaConfig` is required and must be object");t._isMetrikaInitialized||(n=n||function(e,t){Jane.c([].concat(e,t))
},_.forEach(i,function(i,s){i=[].concat(i);var a=t[s];if(!_.isFunction(a))throw new ReferenceError("initializeMetrika: no method `"+s+"` found or it's not a function");var o=_.partial(n,e);"@once"===_.first(i)&&(i=_.rest(i),o=_.once(o)),t[s]=_.wrap(a,function(e){return o(i),e.apply(t,_.rest(arguments))})}),t._isMetrikaInitialized=!0)},Daria.Done={},Daria.Done.PromoManager={},Daria.Done.PromoManager._params={},Daria.Done.PromoManager.setParams=function(e){$.extend(this._params,e)},Daria.Done.PromoManager.getParams=function(){return $.extend({},this._params)
},Daria.Done.PromoManager.resetParams=function(){this._params={}},Daria.Abook={},Daria.Abook.formatContactInfo=function(e,t,i){if(i=i||{},!e)return{};var n=e.cid,s=e.name,a=$.map(e.email,function(e){return e.value});if(t.joinName&&(s=s.full||""),t.onlyFirstEmail){var o=i.email?$.inArray(i.email,a):0;a=a[o>-1?o:0]}1==a.length&&(a=a[0]);var r={cid:n,name:s,email:a};return t.shared&&(r.ya_directory=e.ya_directory),r},function(e){e.getUrlParams=function(){for(var e,t=/\+/g,i=/([^&=]+)=?([^&]*)/g,n=window.location.search.substring(1),s=function(e){return decodeURIComponent(e.replace(t," "))
},a={};e=i.exec(n);)a[s(e[1])]=s(e[2]);return a},e.getEmailLogin=function(t){return _.first(e.splitEmail(t))};var t=/^([^@]+)@(ya(?:ndex\-team|money)\.(?:ru|com(\.(tr|ua))?))$/;e.isCorpEmail=function(i){return e.IS_CORP&&t.test(i)},e.splitEmail=function(e){return e.split("@")}}(Daria),function(){Daria.DEBUG&&console.warn("Отпилить в пользу ns.events, там все тоже самое. Еще pubsub дублируется Daria.UI.IEvent");var e=Daria.PubSubMixin=function(){};e.on=function(e,t){var i=this,n=1;$(this).bind(e,function(){t.apply(i,Array.prototype.slice.call(arguments,n))
})},e.once=e.one=function(e,t){var i=this,n=1;$(this).bind(e,function(){t.apply(i,Array.prototype.slice.call(arguments,n)),i.off(e,t)})},e.off=function(e,t){$(this).unbind(e,t)},e.trigger=function(e,t){var i=$(this);return i.triggerHandler(e,t),this}}(Daria),Daria.formatContacts=function(e,t){var i;t&&(i=ns.Model.get("account-information").getEmails());var n=[];$.isArray(e)||(e=[e]);for(var s=0,a=e.length;a>s;s++){var o=e[s],r=o.email,l=o.name;!r||t&&$.inArray(r,i)>-1||"no_address"!==l&&"(адрес не указан)"!==l&&n.push(Jane.FormValidation.obj2contact(o))
}return n.join(", ")},Daria.showDoubleSizedContacts=function(){return Daria.Config.pddDomain||Daria.Config.workspace},Daria.getAccountAgeInDays=function(){var e=ns.Model.get("account-information");return(Daria.now()-e.getData().reg_date)/864e5},Daria.uidEnds=function(e){if($.isArray(e)&&e.length){var t=String(e[0]).length,i=parseInt(Daria.uid.slice(-t),10);return $.inArray(i,e)>-1}return!1},Daria.loadPromoModule=function(e){Jane.Services.runModules(["jane.promo.css","jane.promo.js","jane.promo.yate"],e)
},Daria.openCollectorPopup=function(e){Daria.loadPromoModule(function(){Jane.Services.runModules(["jane.setup.js"],function(){ns.action.run("collectors-promo.open",e)})})},Daria.hasExperiment=function(e){return Daria.Config["exp-test-ids"].indexOf(String(e))>-1},Daria.hasFeature=function(e){return Daria.Config.features[e]},Daria.Sound={soundsPath:Daria.Config.staticPath+"/sound/",preload:function(e){this._getPlayer(e)},play:function(e){this._getPlayer(e)()},_cache:{},_getPlayer:function(e){if(!this._cache[e]){var t=this.soundsPath+e;
if("src"in document.createElement("audio")){var i=this._createAudioEl(t);this._cache[e]=function(){i.play()}}else if("src"in document.createElement("bgsound")){var n=document.createElement("bgsound");document.getElementsByTagName("head")[0].appendChild(n),this._cache[e]=function(){n.src=t+".mp3"}}else this._cache[e]=function(){}}return this._cache[e]},_createAudioEl:function(e){var t=document.createElement("div");t.innerHTML='<audio preload="auto"><source src="'+e+'.ogg" type="audio/ogg"></source><source src="'+e+'.mp3" type="audio/mpeg"></source><source src="'+e+'.wav" type="audio/wav"></source></audio>';
var i=t.firstChild;return document.body.appendChild(i),i}},function(e){e.emailAutocompleterOpts={tpl:'<div class="b-mail-suggest b-mail-suggest_contacts"><div class="b-grid js-sections"></div></div>',activeClass:"b-grid-item_selected",width:"20em",multiple:!0,minChars:0,minClickCount:0,excludeSelected:!0,filterItem:function(e){var t,i=this.currentValue||this.prevVal;return e.data.title?(t=[].concat(e.data.contacts),t=$.grep(t,function(e){return-1===i.indexOf(e.email)}),t.length):e.data.email?-1===i.indexOf(e.data.email):void 0
},scroll:!0,scrollElem:".b-grid",item:".b-grid-item",sections:[{url:Daria.modelsApiURl+"?_model.0=abook-suggest",fakeRequestParams:!0,dataType:"json",param:"q",withCkey:!0,extraParams:{glimit:5,climit:35,useAbook:"on"},contextExtraParams:function(){var e,t=Daria.vCompose,i={};return t&&"compose"===ns.page.current.page?(e=$.map(["To","Cc","Bcc"],function(e){var i=t["get"+e]();return i?i.replace(/\s*/g,"").split(","):void 0}),e=e.join(","),e=$.map(Jane.FormValidation.splitContacts(e),function(e){return e.email
}),e=e.join(","),e&&(i.to=e),i):i},beforeRequest:function(e){return e.length>=1},parse:function(e,t){function i(e,i,n,a){for(var o=0,r=e.length;r>o&&o!==a;o+=1){var l=e[o];l&&(n[n.length]={data:l,$item:$(i.call(s,l,t))})}}e=jpath(e,".models[0].data")[0]||{};var n=[],s=this;return e.contacts&&e.contacts.length&&i(e.contacts,s.formatContact,n,s.extraParams.climit),e.groups&&e.groups.length&&i(e.groups,s.formatGroup,n,s.extraParams.glimit),n},groupTpl:'<div class="b-grid-item"><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__content__group">группа</span>&#160;{title}</span></span><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__misc">{emails}</span></span></span></div>',formatContact:function(e,t){var i='<div class="b-grid-item"><span class="b-grid-item__content"><span class="b-grid-item__content__i">'+_.escape(e.name||e.email)+'</span></span><span class="b-grid-item__content"><span class="b-grid-item__content__i"><span class="b-grid-item__misc">'+(e.name&&e.email?_.escape(e.email):" ")+'</span></span></span><span class="b-grid-item__right"><span class="b-userpic b-userpic_small'+(e.cid?" cid-"+e.cid:"")+'">'+(e.ref&&e.email&&e.id>-1&&!e.popdom?Daria.SocialAvatars2.register({name:e.name,ref:e.ref,email:e.email,href:!1,size:28}):"")+"</span></span>";
return i+="</div>",Daria.Autocompleter.utils.highlight(i,t)},formatGroup:function(e,t){for(var i=[],n=0,s=e.contacts.length;s>n;n++)i.push(e.contacts[n].email);return Daria.Autocompleter.utils.highlight(Daria.supplant(this.groupTpl,{title:e.title,emails:i.join(", ")}),t)},formatResult:function(e){function t(e){return e.name?'"'+e.name+'" <'+e.email+">":e.email}var i;if(e.contacts){for(var n=[],s=0,a=e.contacts.length;a>s;s++)n.push(t(e.contacts[s]));i=n.join(", ")}else i=t(e);return i}}]};var t=e.emailAutocompleterOpts.sections[0];
e.emailAutocompleterOpts.sections.push($.extend({},t,{url:Daria.modelsApiURl+"?_model.0=abook-suggest",fakeRequestParams:!0,extraParams:{popular:!0,climit:10,useAbook:"on"},parse:function(e,i){var n=jpath(e,".models[0].data")[0]||{};return n.contact&&!n.contacts&&(n.contacts=n.contact),t.parse.call(this,e,i)},formatContact:function(e,i){return e.name=e.name&&e.name.full,t.formatContact.call(this,e,i)},beforeRequest:function(e,t){if(e)return!1;if("compose"!==ns.page.current.page)return!1;var i=t&&t.keyPressed;
if(i)return!1;var n=ns.page.current.params,s=ns.Model.get("folders").getFolderBySymbol("template"),a=s&&s.fid,o=Daria.composeParams&&"template"===Daria.composeParams.save_symbol||"template"===n.save_symbol||n.ids&&ns.Model.get("message",{ids:n.ids}).inFolder(a);return!o},onshow:function(){Jane.c(["popular_suggest","Показы саджеста популярных контактов"])},onresult:function(e){Daria.composeParams=Daria.composeParams||{},Daria.composeParams["popular-suggest-general"]||(Daria.composeParams["popular-suggest-general"]=[]),Daria.composeParams["popular-suggest-general"].push(e.email),Jane.c(["popular_suggest","Клики в саджест популярных контактов"]);
var t=Jane.watcher.get("autocompleter.popularContacts")||[],i=this,n=function(){ns.events.off("ns-page-before-load",n),i.binded=!1,Jane.watcher.set("autocompleter.popularContacts",[])};t.push(e.email),Jane.watcher.set("autocompleter.popularContacts",t,{silent:!0}),this.binded||(this.binded=!0,ns.events.on("ns-page-before-load",n))}})),e.getEmailAutocompleter=function(){var t=new e(e.emailAutocompleterOpts),i=t.onChange;return t.onChange=function(){var e=this.$input.val();return this.keyPressed&&!e?void this.hide():i.apply(this,arguments)
},t},e.getContact=function(){return e.__contactInstance||(e.__contactInstance=e.getEmailAutocompleter()),e.__contactInstance},e.getContactEmail=function(){return e.__contactEmailInstance||(e.__contactEmailInstance=function(){var t=$.extend(!0,{},e.emailAutocompleterOpts,{multiple:!1,filterItem:null});t.sections=$.each(t.sections,function(e,t){$.extend(t,{formatResult:function(e){return e.email||""},parse:function(e,t){function i(e,i,n,a){for(var o=0,r=e.length;r>o&&o!==a;o+=1){var l=e[o];l&&(n[n.length]={data:l,$item:$(i.call(s,l,t))})
}}e=jpath(e,".models[0].data")[0]||{};var n=[],s=this;return e.contacts&&e.contacts.length&&i(e.contacts,s.formatContact,n,s.extraParams.climit),n}})});var i=new e(t),n=i.onChange;return i.onChange=function(){var e=this.$input.val();return this.keyPressed&&!e?void this.hide():n.apply(this,arguments)},i}()),e.__contactEmailInstance}}(Daria.Autocompleter),function(e){var t=null;e.Autocompleter.logSuggestInfo=function(t){t.uid=e.uid,t.searchid=Jane.watcher.get("search.next-id"),t.searchid||(t.searchid=e.MessagesSearch.generateId()),"suggest"===e.urlParams.logger&&(console.table?console.table([t]):console.log(t)),Jane.ErrorLog.send(t)
},e.Autocompleter.enumerate=function(e,t,i){return e.map(function(e,n){return e[i]=n+t,e})},e.Autocompleter.getSearch=function(){if(!t){var i=$(Jane.tt("mail:search-autocomplete"));if(!e.IS_CORP){var n=new e.SearchFilters({onSelect:function(t){e.Autocompleter.logSuggestInfo({event:"suggest_type_selection",source:"suggest",filter_type:t||0}),ns.events.trigger("search.start-search",{force:!0,metrika:"suggest"})}});i.find(".js-filters").removeClass("g-hidden").find(".js-filters-placeholder").replaceWith(n.getNode())
}t=new e.Autocompleter({tpl:i,activeClass:"b-grid-item_selected",item:".b-grid-item",blockSubmit:!1,selectFirst:!1,minChars:0,saveSelectionOnBlur:!1,position:{right:10},lastWord:!0,onrender:function(){},sections:[function(){return{url:e.modelsApiURl+"?_model.0=history-suggest",dataType:"json",param:"text",getParamFromTerm:function(e){return e},withCkey:!0,max:5,dontShow:ns.Model.get("settings").isSet("dont_save_history"),tpl:yr.run("mail",null,"search-autocomplete-suggest"),onshow:function(){Jane.c({Поиск:'Показы "прошлые запросы"'})
},onselect:function(t,i){e.Autocompleter.logSuggestInfo({event:"suggest_used",suggest_group:"history",user_input:this.prevVal,user_select_idx:i+1,idx:t.idx||1,suggest_text:t.text})},onfetch:function(t,i){e.Autocompleter.logSuggestInfo({event:"suggest_all",suggest_group:"history",user_input:this.prevVal,empty_suggest:i})},parse:function(t,i,n){t=jpath(t,".models[0].data")[0],t=e.Autocompleter.enumerate(t,1,"idx");var s=this.max;""===i&&(this.max=10);var a=n.parse(t,this,i);return this.max=s,a},formatItem:function(e){return yr.run("mail",e,"search-autocomplete-suggest-item")
},formatResult:function(e){return e.text}}}(),function(){var t={},i="";return e.IS_CORP||(Jane.Config.pddDomain||(t.mix_groups=e.uidEnds([4]),t.emails=ns.Model.get("account-information").getAllUserEmails().join(",")),i="&"+$.param(t)),{url:e.modelsApiURl+"?_model.0=abook-suggest"+i,dataType:"json",param:"q",withCkey:!0,max:10,tpl:yr.run("mail",null,"search-autocomplete-contacts"),parse:function(t,i){t=jpath(t,".models[0].data.contacts")[0];var n=[];if(t&&t.length){t=e.Autocompleter.enumerate(t,1,"idx");
for(var s=0,a=t.length;a>s&&s<this.max;s++){var o=t[s];o&&n.push({data:o,$item:$(this.formatItem(o,i))})}}return n},formatItem:function(e){return yr.run("mail",e,"search-autocomplete-contacts-item")},formatResult:function(e){return e.email},onshow:function(){Jane.c("Поиск",'Показы "переписка с адресами"')},onselect:function(i,n){e.Autocompleter.logSuggestInfo({event:"suggest_used",suggest_group:"address",user_input:this.prevVal,user_select_idx:n+1,idx:i.idx||1,suggest_text:i.email,mix_groups:t.mix_groups||!0})
},onfetch:function(i,n){e.Autocompleter.logSuggestInfo({event:"suggest_all",suggest_group:"address",user_input:this.prevVal,empty_suggest:n,mix_groups:t.mix_groups||!0})}}}(),function(){var t="//clck.yandex.ru/redir/dtype=stred/pid=2/cid=71675/",i={RUS:"ru",TUR:"com.tr"}[e.Config.product]||"com",n=t+"*http://yandex."+i+"/yandsearch?text=";return{isStatic:!0,tpl:yr.run("mail",null,"search-autocomplete-internet"),onfetch:function(t,i){e.Autocompleter.logSuggestInfo({event:"suggest_all",suggest_group:"internet",user_input:this.prevVal,empty_suggest:i})
},formatItem:function(t){var i=e.Autocompleter.getSearch().$input.val();return i?(t.term=i,t.url=n+encodeURIComponent(i),yr.run("mail",t,"search-autocomplete-internet-item")):null},onresult:function(t){return e.Autocompleter.logSuggestInfo({event:"suggest_used",suggest_group:"internet",user_input:this.prevVal,idx:0,user_select_idx:1,suggest_text:t.term}),window.open(t.url,"_blank"),Jane.c("Поиск","Клик по найти в интернете"),!0}}}()]})}return t}}(Daria),function(){function e(e){var n=e.data.obj;return Daria.MessagesPager.active=n,n.isDragging=!0,n.slider.addClass("b-mail-paginator_scrolling"),$(document).on("mousemove",{obj:n},i),$(document).on("mouseup",{obj:n},t),e.preventDefault(),!1
}function t(e){var n=e.data.obj;delete Daria.MessagesPager.active,n.isDragging=!1,n.slider.removeClass("b-mail-paginator_scrolling"),$(document).off("mousemove",{obj:n},i),$(document).off("mouseup",t)}function i(e){var t=e.data.obj;if(t.isDragging){t.dragged||(t.dragged=!0);var i=Math.floor(e.pageX-t.sliderWidth/2-t.$container.offset().left);return t._setSliderPosition(i),e.preventDefault(),!1}}function n(e){var t=e.data.obj;t.scrolling||t._setSliderPositionByScroll(t.$container.scrollLeft(),!1)}function s(e){var t=$(e.currentTarget),i=ns.action.getParams(t[0]);
return e.data.obj.updateScroll(i,!0),!0}ns.events.on("pageVisible.change",function(){Daria.MessagesPager.active&&t({data:{obj:Daria.MessagesPager.active}})}),Daria.MessagesPager=function(e,t,i){this._params=i||{},this.$node=$(e),this.isFloat=t,this.setPagerToDate=_.debounce(this.setPagerToDate,0),this.init()},Daria.MessagesPager.incDate=function(e,t){var i=Jane.Common.n;return e=Number(e),t=Number(t),12==t?(e++,t=1):t++,[String(e),String(i(t))]},Daria.MessagesPager.decDate=function(e,t){var i=Jane.Common.n;
return e=Number(e),t=Number(t),1==t?(e--,t=12):t--,[String(e),String(i(t))]},Daria.MessagesPager.prototype={init:function(){return this.slider=this.$node.find(".js-messages-pager-slider"),this.$scrollLeft=this.$node.find(".b-link_scroll-left"),this.$scrollRight=this.$node.find(".b-link_scroll-right"),0===this.slider.size()?(this.$scrollRight.add(this.$scrollLeft).addClass("b-link_disabled"),void this._showPager()):(this.$container=this.$node.find(".js-messages-pager-container"),this.scrollContainer=this.$node.find(".js-messages-pager-scroll"),this.tooltip=this.$node.find(".js-tooltip"),this.dragged=!1,this.$containerWidth=this.$container.width(),this.scrollWidth=this.scrollContainer.width(),this.sliderWidth=this.$containerWidth/this.scrollWidth*this.$containerWidth,this.dragged=!1,this.years=this.$node.find(".js-year").get().map(function(e){return{left:e.offsetLeft,year:ns.action.getParams(e).year}
}),this.$containerWidth>=this.scrollWidth?(this.slider.remove(),this.$scrollLeft.remove(),this.$scrollRight.remove(),void this._showPager()):(this.minSliderX=0,this.maxSliderX=Math.floor(this.$containerWidth-this.sliderWidth),this.minScroll=0,this.maxScroll=this.scrollWidth-this.$containerWidth,this.slider.css("width",Math.ceil(this.sliderWidth)),this.isDragging=!1,this.bindEvents(),void(this.isFloat||this.updateScroll())))},_showPager:function(){this._visible||(this.$node.css("visibility","visible"),this._visible=!0)
},_getItems:function(){if(!this._months){var e=this.$container.scrollLeft(),t=this._months=[];this.$node.find(".b-mail-paginator__item").each(function(){t.push($(this).position().left+e)})}return this._months},updateScroll:function(e,t){e||(e=this._params.dontUsePageParams?{}:ns.page.current.params);var i;e.datePager&&(i=e.datePager,i=i.replace(/\./g,"")),i&&this.setCurrentItem(i),this.$container&&(i?this.setPagerToDate(i,t):this._setSliderPosition(this.maxSliderX))},updateTooltip:function(e,t){if(this.years.length){for(var i=0;i<this.years.length&&this.years[i].left-t<e;)i++;
i--,0>i&&(i=0),this.tooltipYear!=this.years[i].year&&(this.tooltipYear=this.years[i].year,this.tooltip.html(this.tooltipYear))}},resetCurrentItem:function(e){this.$node.find(".b-mail-paginator__item_current, .b-mail-paginator__link_current").removeClass("b-mail-paginator__item_current b-mail-paginator__link_current");var t=this.scrollWidth-this.$containerWidth;this._setSliderPositionByScroll(t,e)},setCurrentItem:function(e){var t=this.$node.find(".item-"+e);0!==t.size()&&(t.closest(".js-messages-pager-container").find(".b-mail-paginator__item_current").removeClass("b-mail-paginator__item_current").find(".b-mail-paginator__link_current").removeClass("b-mail-paginator__link_current"),t.closest(".b-mail-paginator__item").addClass("b-mail-paginator__item_current").find(".b-mail-paginator__link").addClass("b-mail-paginator__link_current"))
},setPagerToDate:function(e,t){var i=this.$node.find(".item-"+e);if(0!==i.size()){var n=i.position().left+this.$container.scrollLeft(),s=n-this.$containerWidth/2+25;this._setSliderPositionByScroll(s,t)}},_setSliderPosition:function(e,t,i){var n=this;e=Math.floor(e),e>this.maxSliderX&&(e=this.maxSliderX),e<this.minSliderX&&(e=this.minSliderX),t=t||Math.floor(e/this.maxSliderX*(this.scrollWidth-this.$containerWidth));var s=54,a=e+this.sliderWidth/2;i&&document.documentMode&&document.documentMode<9&&(i=!1);
var o=e>this.minSliderX,r=e<this.maxSliderX,l=r&&a+s<this.$containerWidth,c=o&&a-s>0;i?this.slider.stop().animate({left:e},"fast"):this.slider.stop().css({left:e}),l!=this.showRightArrow&&(this.showRightArrow=l,this.slider.toggleClass("b-mail-paginator__slider_arrow_right",l)),c!=this.showLeftArrow&&(this.showLeftArrow=c,this.slider.toggleClass("b-mail-paginator__slider_arrow_left",c)),i?(this.scrolling=!0,this.$container.stop().animate({scrollLeft:t},"fast",function(){n.scrolling=!1})):this.$container.stop().scrollLeft(t),r!=this.allowRightArrow&&(this.$scrollRight.toggleClass("b-link_disabled",!r),this.allowRightArrow=r),o!=this.allowLeftArrow&&(this.$scrollLeft.toggleClass("b-link_disabled",!o),this.allowLeftArrow=o),this.updateTooltip(e+this.sliderWidth/2,t),this._showPager()
},_setSliderPositionByScroll:function(e,t){e<this.minScroll?e=this.minScroll:e>this.maxScroll&&(e=this.maxScroll);var i=e/(this.scrollWidth-this.$containerWidth)*(this.$containerWidth-this.sliderWidth);this._setSliderPosition(i,e,t)},_adjustSliderPosition:function(e){var t=this.$container.scrollLeft();e>0&&(t+=this.$containerWidth);for(var i,n=this._getItems(),s=0,a=n.length;a>s;s++)if(n[s]>=t){i=e>0?n[s-1]:n[s]-this.$containerWidth;break}i||(i=this.maxScroll),this._setSliderPositionByScroll(i,!0)
},_moveScroll:function(e){var t=e.currentTarget.className;return t.indexOf("b-link_disabled")>-1?!1:(this._adjustSliderPosition(t.indexOf("left")>-1?-1:1),!1)},bindEvents:function(){this.slider.on("mousedown",{obj:this},e),this.$container.on("scroll",{obj:this},n),this.isFloat&&this.$container.find(".b-mail-paginator__link").on("click",{obj:this},s),this.$scrollLeft.add(this.$scrollRight).on("click",this._moveScroll.bind(this))},unbindEvents:function(){this.slider.off("mousedown",e),this.isFloat&&this.$container&&this.$container.find(".b-mail-paginator__link").off("click",s),this.$container&&this.$container.off("scroll"),this.$scrollLeft&&this.$scrollLeft.add(this.$scrollRight).off("click")
}}}(),function(e,t){function i(e,t,i){if(t){var n=ns.Model.get("labels").getLabelByName(i).lid,s=ns.Model.get("message",{ids:t});s.hasLabel(n)&&(e='Снять метку "'+i+'"')}return e}var n=t.DragNDrop,s=function(){};s.prototype=new n.EmptyDrag,s.prototype.init=function(t,i){return this.is_active=!1,this.is_draggable=!0,this.area=n.getDragMessageArea(),this.draggable=i,this.label=this.getLabelText(i),this.evt=t,this.message_row=this.getMessageRow(t.target),this._messagesNode=e(".js-messages-list").get(0),this
},s.prototype.onDragStart=function(t){this.is_active=!0,this.area.show(),this.area.alignByEvent(t);var i=e(this.evt.target),n="is-draggable-labels";return i.parents(".js-labels").length&&(n+=" is-draggable-labels-from-labels"),this.standardMessage(),e("html").addClass(n),this},s.prototype.standardMessage=function(){this.area.setText('Укажите письмо, которое хотите пометить как "'+this.label+'"')},s.prototype.onDrag=function(e){this.area.alignByEvent(e)},s.prototype.getTargetData=function(t){var i=e(t),n=this,s=[{name:"message_many",test:function(){return"messages"!==ns.page.current.page?!1:e.contains(n._messagesNode,t)?e(n.getMessageRow(t)):!1
}},{name:"message_one",test:function(){return i.is(".js-message-subject-drop")?i:!1}},{name:"unlabel",test:function(){return(i.is(".js-toolbar-item-delete")||i.is(".js-labels")||i.is(".js-labels *"))&&0===e(n.evt.target).parents(".js-labels").length?i:!1}}];return this.testTarget(s,i)},s.prototype.onDragEnter=function(t,n){var s;if("unlabel"===n.name)s='Снять метку "'+this.label+'"';else{var a=e(n.target).closest(".js-message").data("id");s=i('Пометить письмо как "'+this.label+'"',a,this.label)}this.area.setText(s),this.hilite(n.target),this.area.evaluateDimensions()
},s.prototype.onDragLeave=function(e,t){this.standardMessage(),this.nohilite(t.target)},s.prototype.onDragEnd=function(){this.area.alignByEvent(this.evt,{animate:!0}),e("html").removeClass("is-draggable-labels is-draggable-labels-from-labels")},s.prototype.getMessageRow=function(t){var i=".js-message:eq(0)";return e(t).parents(i).addBack().filter(i)[0]},s.prototype.onDrop=function(t,i){this.area.hide();var n="label";"unlabel"===i.name&&(n="unlabel");var s;switch(n){case"label":s=i.target;break;case"unlabel":s=e(this.message_row?this.message_row:this.draggable)
}if(s&&i.target[0]!==this.message_row){var a=s.closest(".js-message").data("id"),o={};if(a){var r=ns.Model.get("message",{ids:a}),l=ns.Model.get("messages-checked",{mid:a});l.check(r,!0),o={mMessagesChecked:l}}var c={operation:n,params:_.extend(o,ns.action.getParams(this.draggable))};s.trigger("dragndrop.drop",c)}this.nohilite(i.target),e("html").removeClass("is-draggable-labels is-draggable-labels-from-labels")},Daria.DragLabel=s;var a=function(){};a.prototype=new n.EmptyDrag,a.prototype.init=function(t,i){this.is_active=!1,this.is_draggable=!0,this.area=n.getDragMessageArea(),this.draggable=i;
var s=i.find(".b-messages__message__checkbox__input");return this.checked=s.prop("checked"),this.evt=t,i.is(".js-message-subject-drop")&&(this.type="subject"),this.TARGET_BLOCK_LABELS=e(".ns-view-labels")[0],this},a.prototype.getTargetData=function(t){var i=e(t),n=this,s=function(e,t){if(t&&this.mMessagesChecked.isFolderSelected())return!1;var n=i.closest(e),s=n.length;return s?n:!1},a=function(e,t){return s.bind(n,e,t)},o=[{name:"mark",test:a(".js-toolbar-item-mark-as-read")},{name:"mark",test:a(".js-drop-area-read")},{name:"unmark",test:a(".js-toolbar-item-mark-as-unread")},{name:"unmark",test:a(".js-drop-area-unread")},{name:"remove",test:a(".js-toolbar-item-delete")},{name:"remove",test:a(".js-drop-area-delete")},{name:"reply-all",test:a(".js-toolbar-item-reply-all",!0)},{name:"reply",test:a(".js-toolbar-item-reply",!0)},{name:"reply",test:a(".js-reply",!0)},{name:"forward",test:a(".js-toolbar-item-forward",!0)},{name:"tospam",test:a(".js-toolbar-item-spam",!0)},{name:"tospam",test:a(".js-drop-area-spam",!0)},{name:"notspam",test:a(".js-toolbar-item-not-spam",!0)},{name:"messages.deselect",test:a(".js-deselect")},{name:"move",test:function(){if(!n.mMessagesChecked.isFolderSelected()){var e=ns.Model.get("ads"),t=i.closest(".js-folders")[0];
if(e.isAdNode(t))return!1;var s=i.parents(".js-valid-drag-target:eq(0)");if(s.length)return s}return!1}},{name:"label",test:function(){if(ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["trash","spam"]))return!1;var a=!i.hasClass("js-label-no-dnd")&&s(".js-labels-item")&&e.contains(n.TARGET_BLOCK_LABELS,t);if(a){if(!i.attr("data-title")){var o=i.closest("[data-title]");i=o.length?o:!1}return i}return!1}}],r=this.testTarget(o,i);return r.original_target=i,r},a.prototype.hiliteAll=function(){var t="mail-Page_draggingMessage";
ns.Model.get("folders").isFolder(ns.page.current.params.current_folder,["trash","spam"])&&(t=t.concat(" mail-Page_draggingSpamMessage")),this.mMessagesChecked.isFolderSelected()&&(t+=" mail-Page_draggingMessageAll"),e("html").addClass(t)},a.prototype.nohiliteAll=function(){e("html").removeClass("mail-Page_draggingMessage mail-Page_draggingSpamMessage mail-Page_DraggingMessageAll")},a.prototype.check=function(t,i){if("messages"===ns.page.current.page){var n=e(i.target).closest(".js-cbt-item");if(n.length||t){if(n.length){var s=n.attr("data-id"),a=ns.Model.get("message",{ids:s});
this.mMessagesChecked.check(a,t)}}else this.mMessagesChecked.resetChecked()}},a.prototype.showHiddenFolders=function(){var e=ns.Model.get("settings");e.isSet("hide_empty_folders")&&!this._showingHiddenFolders&&(this._showingHiddenFolders=!0,e.setIfChanged(".hide_empty_folders",!1))},a.prototype.hideHiddenFolders=function(){if(this._showingHiddenFolders){var e=ns.Model.get("settings");this._showingHiddenFolders=!1,e.setIfChanged(".hide_empty_folders",!0)}},a.prototype.onDragStart=function(e){if(1==e.which&&2!=e.buttons){this.showHiddenFolders(),this.mMessagesChecked=ns.Model.get("messages-checked",ns.page.current.params),this.check(!0,this.evt);
var t=1;this.mMessagesChecked.touch({silent:!0}),"messages"===ns.page.current.page&&(t=this.mMessagesChecked.getCount(),0===t&&(t=1)),this.count=t,this.is_active=!0,this.area.show(),this.area.alignByEvent(e),this.hiliteAll(),5>t?this.area.$control.addClass("b-drag-helper_few"):1!==t&&this.area.$control.addClass("b-drag-helper_many"),this.standardMessage(),ns.events.trigger("daria:dragndrop:message:start",this.mMessagesChecked)}},a.prototype.standardMessage=function(){this.area.setText("Укажите, куда перенести "+t.i18n.convert(["выбранное письмо",this.count+" выбранное письмо",this.count+" выбранных письма",this.count+" выбранных писем"],this.count)),this.area.evaluateDimensions()
},a.prototype.onDrag=function(e){ns.events.trigger("daria:dragndrop:message:update",e),this.area.alignByEvent(e)},a.prototype.onDragEnd=function(e){this.hideHiddenFolders(),this.area.alignByEvent(this.evt,{animate:!0}),this.mMessagesChecked.isOnlyMessageChecked()&&this.check(this.checked,e),this.nohiliteAll(),ns.events.trigger("daria:dragndrop:message:dragend")},a.prototype.onDragEnter=function(n,s){var a=this.count,o={remove:"Удалить "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),mark:"Пометить "+t.i18n.plural(a,"как прочитанные","как прочитанное")+" "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),unmark:"Пометить "+t.i18n.plural(a,"как непрочитанные","как непрочитанное")+" "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),tospam:"Пометить "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a)+" как спам",notspam:"Пометить "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a)+" как не спам","reply-all":"Ответить на "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),reply:"Ответить на "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),forward:"Переслать "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),"messages.deselect":"Снять выделение с "+t.i18n.plural(a,"выбранных писем","выбранного письма")},r="",l="";
switch(this.hilite(s.target),s.name){case"move":var c=s.original_target;l=c.data("foldername")||c.text(),r="Перенести "+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a)+' в папку "'+l+'"',this.lazyAction(function(){var t=e(c).closest(".js-valid-drag-target").attr("data-params");t=ns.parseQuery(t),ns.Model.get("folder",{fid:t.fid}).switchFolded(!1)},300);break;case"label":l=this.getLabelText(s.target[0]);var d=this.draggable,u=d.data("id");r=i('Пометить как "'+l+'" '+t.i18n.convert(["выбранное письмо",a+" выбранное письмо",a+" выбранных письма",a+" выбранных писем"],a),u,l);
break;default:s.name in o&&(r=o[s.name])}this.area.setText(r),this.area.evaluateDimensions()},a.prototype.lazyAction=function(e,t){this.lazyActionTimeout&&(clearTimeout(this.lazyActionTimeout),this.lazyActionTimeout=null),e&&(this.lazyActionTimeout=setTimeout(e,t))},a.prototype.onDragLeave=function(e,t){this.lazyAction(!1),this.standardMessage(),this.nohilite(t.target)},a.prototype.onDrop=function(e,t){this.lazyAction(!1),this.hideHiddenFolders();var i={operation:t.name,params:ns.action.getParams(t.target[0])},n=this.draggable;
Daria.is3pane()&&"subject"===this.type&&t.target.closest(".js-inplace-message-toolbar").length&&(n=t.target),n.trigger("dragndrop.drop",i),this.area.hide(),this.nohilite(t.target),this.nohiliteAll(),ns.events.trigger("daria:dragndrop:message:dragend")},n.add([{test:function(t,i){var n=ns.page.current;if(ns.Model.get("folders").isFolder(n.params.current_folder,["trash","spam"]))return!1;var s=i.closest(".js-labels-item");if(!s.length||s.hasClass("js-label-no-dnd"))return!1;var a=s[0];if("messages"===n.page)return a;
if("message"===n.page){var o=ns.Model.get("message",n.params);if(!o.inFolderBySymbol("spam")&&!o.inFolderBySymbol("trash")&&e(".ns-view-labels").find(a).length)return a}return!1},result:function(e,t){return(new s).init(e,t)}},{test:function(e,t){if(t.is(".js-invalid-drag-target"))return!1;var i=ns.Model.get("ads"),n=t.closest(".js-message-snippet-wrap")[0];if(i.isAdNode(n))return!1;var s=t.closest(".js-message-subject-drop");if(s.length)return s;var a=t.closest(".js-message");return 0!==a.length&&0===t.closest(".js-cbt-item-target").length?a:!1
},result:function(e,t){return(new a).init(e,t)}}]),Daria.DragMessage=a}(jQuery,Jane),function(){var e=function(e){this.$el=$(".b-drag-helper_folder"),this.$source=$(e);var i=t.getFidByElement(e),n=ns.Model.get("folders").getFolderById(i);return this.folderName=n&&n.name||"",this.$el&&0!==this.$el.length||(this.$el=$('<div class="b-drag-helper_folder"><div class="b-drag-helper_folder__content"></div></div>').appendTo($("body"))),this.$el.css({opacity:1}),this};e.prototype.ret=function(){var e=this.$source.offset();
this.$el.animate({left:e.left,top:e.top,opacity:0},$.proxy(function(){this.hide()},this))},e.prototype.move=function(e){var t=document.documentElement,i=document.body,n=e.clientX+(t&&t.scrollLeft||i&&i.scrollLeft||0)-(t.clientLeft||0),s=e.clientY+(t&&t.scrollTop||i&&i.scrollTop||0)-(t.clientTop||0);return this.$el.offset({top:s+5,left:n+5}),this},e.prototype.show=function(){return this.$el.show(),this},e.prototype.hide=function(){return this.$el.hide(),this},e.prototype.setDefaultText=function(){return this.$el.find(".b-drag-helper_folder__content").text('Укажите, куда перенести папку "'+this.folderName+'"'),this
},e.prototype.setText=function(e){return this.$el.find(".b-drag-helper_folder__content").text(e),this};var t=function(){};t.getFidByElement=function(e){var t=$(e);if(!t.length)return!1;var i=Daria.parseQuery(t.data("params"));switch(ns.page.current.page){case"setup":return i.id;default:return i.fid}},t.getOffsetY=function(e){var t=document.documentElement,i=document.body,n=e.clientY+(t&&t.scrollTop||i&&i.scrollTop||0)-(t.clientTop||0);return n},t.isOffsetTop=function(e,i){var n=t.getOffsetY(e),s=n-i.offset().top;
return s>=-1&&5>=s},t.isOffsetBottom=function(e,i){var n=t.getOffsetY(e),s=i.height()+i.offset().top-n;return s>=0&&5>=s},t.isOffsetIn=function(e,i){var n=t.getOffsetY(e),s=i.offset().top,a=n-s,o=i.height()+s-n;return a>5&&o>5},t.isAdNode=function(e){var t=ns.Model.get("ads"),i=e.closest(".js-folders")[0];return t.isAdNode(i)},t.prototype=new Jane.DragNDrop.EmptyDrag,t.prototype.CLASS_MOVEIN="mail-FolderList-Item_movein",t.prototype.CLASS_MOVEBT="mail-FolderList-Item_movebt",t.prototype.CLASS_MOVETOP="mail-FolderList-Item_movetop",t.prototype.CLASS_DROPHOVER="mail-FolderList-Item_drophover",t.prototype.init=function(e,t){this.is_active=!1,this.is_draggable=!0,this.evt=e,this.draggable=t;
var i,n=ns.Model.get("folders").getMoveFoldersFid(this.getDragFid());switch(ns.page.current.page){case"setup":i=".js-setup-folders-list";break;default:i=".js-folders"}return i&&(this.$targets=$(".js-folders-item",i).filter(".fid-"+n.join(",.fid-"))),this._onPageAfterLoad=function(){this.$targets=$(".js-folders-item",i).filter(".fid-"+n.join(",.fid-"))}.bind(this),ns.events.on("ns-page-after-load",this._onPageAfterLoad),this},t.prototype.lazyAction=function(e,t){this.lazyActionTimeout&&(clearTimeout(this.lazyActionTimeout),this.lazyActionTimeout=null),e&&(this.lazyActionTimeout=setTimeout(e,t))
},t.prototype.getTargetData=function(e){var i=this,n=$(e),s=[{name:"folder",test:function(e){var n=e.closest(".js-folders-item");return t.isAdNode(e)?!1:n.length&&i.$targets.filter(n[0]).length?n:!1}}];return this.testTarget(s,n)},t.prototype.onDragStart=function(t){return this.is_active=!0,ns.events.trigger("dragndrop.dragstart"),this.hiliteAll(),this.area=new e(this.draggable).setDefaultText().show().move(t),Jane.c("Драгндроп папок","Перенос папки"),this},t.prototype.onDrag=function(e,i){this.area.move(e);
var n=i&&i.target;if(n){var s=t.getFidByElement(n),a=ns.Model.get("folders").getFolderById(s),o=a&&a.name;t.isOffsetTop(e,n)?"inbox"!==a.symbol&&(this.area.setText('Расположить выбранную папку перед папкой "'+o+'"'),n.removeClass(this.CLASS_MOVEIN+" "+this.CLASS_MOVEBT).addClass(this.CLASS_MOVETOP)):t.isOffsetBottom(e,n)?(this.area.setText('Расположить выбранную папку после папки "'+o+'"'),n.removeClass(this.CLASS_MOVEIN+" "+this.CLASS_MOVETOP).addClass(this.CLASS_MOVEBT)):t.isOffsetIn(e,n)?(this.area.setText('Перенести выбранную папку в папку "'+o+'"'),n.removeClass(this.CLASS_MOVEBT+" "+this.CLASS_MOVETOP).addClass(this.CLASS_MOVEIN)):(this.area.setDefaultText(),n.removeClass(this.CLASS_MOVEBT+" "+this.CLASS_MOVETOP+" "+this.CLASS_MOVEIN))
}},t.prototype.onDragEnd=function(e){this.nohiliteAll(),this.area.ret(e),ns.events.off("ns-page-after-load",this._onPageAfterLoad)},t.prototype.onDragEnter=function(e,i){var n=i.target,s=ns.Model.get("folders"),a=t.getFidByElement(n),o=s.getFolderById(a);this.area.setText('Перенести выбранную папку в папку "'+(o&&o.name)+'"'),ns.events.trigger("dragndrop.dragenter",_.extend(e,{currentTarget:n[0],fid:a}))},t.prototype.onDragLeave=function(e,t){var i=t.target;this.area.setDefaultText(),this.lazyAction(!1),this.nohilite(i),i.removeClass(this.CLASS_MOVEIN+" "+this.CLASS_MOVETOP+" "+this.CLASS_MOVEBT)
},t.prototype.onDrop=function(e,i){ns.events.off("ns-page-after-load",this._onPageAfterLoad),ns.events.trigger("dragndrop.drop"),this.lazyAction(!1),this.area.hide(),this.nohilite(i.target),this.nohiliteAll();var n,s=this.getDragFid(),a=i.target,o=t.getFidByElement(a),r=ns.Model.get("folders").getFolderById(o);t.isOffsetTop(e,a)?n="inbox"===r.symbol?"putin":"putbefore":t.isOffsetBottom(e,a)?n="putnext":t.isOffsetIn(e,a)&&(n="putin"),a.removeClass(this.CLASS_MOVEBT+" "+this.CLASS_MOVETOP+" "+this.CLASS_MOVEIN),n&&ns.events.trigger("daria:folders.move",{fid:s,overFid:o,action:n})
},t.prototype.hiliteAll=function(){this.$targets.addClass(this.CLASS_DROPHOVER)},t.prototype.nohiliteAll=function(){this.$targets.removeClass(this.CLASS_DROPHOVER)},t.prototype.getDragFid=function(){return t.getFidByElement(this.draggable)},Jane.DragNDrop.add({test:function(e,i){var n=i.closest(".js-folders-item");if(!n.length)return!1;var s=t.getFidByElement(n);return s&&ns.Model.get("folders").isDraggable(s)?t.isAdNode(i)?!1:n[0]:!1},result:function(e,i){var n=new t;return n.init(e,i)}})}(),ns.events.on("daria:folders.move",function(e,t){function i(e){switch(e){case"nameduplicate":return void Daria.Statusline.showMsg({name:"folders-move-error",speed:"fast",body:"Папка с таким названием уже есть"});
case"actionerror":return void Jane.ErrorLog.send({event:"folders.move.action",status:e,action:o})}ns.events.trigger("daria:folders.move:done")}var n=ns.Model.get("folders"),s=t.fid,a=t.overFid,o=t.action,r=$.Deferred();switch(o){case"putin":n.moveIn(s,a).always(r.resolve);break;case"putnext":n.moveAfter(s,a).always(r.resolve);break;case"putbefore":n.moveBefore(s,a).always(r.resolve)}r.always(i)}),ns.events.on("daria:folders.move",function(e,t){function i(e){switch(e){case"nameduplicate":return void Daria.Statusline.showMsg({name:"folders-move-error",speed:"fast",body:"Папка с таким названием уже есть"});
case"actionerror":return void Jane.ErrorLog.send({event:"folders.move.action",status:e,action:o})}ns.events.trigger("daria:folders.move:done")}var n=ns.Model.get("folders"),s=t.fid,a=t.overFid,o=t.action,r=$.Deferred();switch(o){case"putin":n.moveIn(s,a).always(r.resolve);break;case"putnext":n.moveAfter(s,a).always(r.resolve);break;case"putbefore":n.moveBefore(s,a).always(r.resolve)}r.always(i)}),function(e){var t=null,i=!1,n=[4,18,5,14,35],s=$(),a=function o(e){this._$node=$(Jane.tt("mail:search-filters-types",{"filter-id":n},["messages-types"])),this._onSelect=e.onSelect,this._$node.on("mousedown.searchfilter",".js-search-apply-filter",this._onMouseDown.bind(this)),s=s.add(this._$node),o._updateFilterTypeState()
};a.prototype.getNode=function(){return this._$node},a.prototype.destroy=function(){s=s.not(this._$node),this._$node.off(".searchfilter"),this._$node.remove()},a.prototype._onMouseDown=function(e){e.preventDefault(),e.stopPropagation();var n=$(e.currentTarget),s=String(n.data("filter-id"));t=a.getFilterId()===s?null:s,i=!0,a._updateFilterTypeState(),this._onSelect(t)},a._updateFilterTypeState=function(){var e=s.find(".js-search-apply-filter");e.removeClass("g-active");var t=a.getFilterId();t&&e.filter('[data-filter-id="'+t+'"]').addClass("g-active")
},a.getFilterId=function(){return t?t:i||-1===n.indexOf(Number(ns.page.current.params.type))?void 0:ns.page.current.params.type},a.setCurrentFilterIdAsUser=function(){t=a.getFilterId(),i=!0},a.resetUserSelect=function(){t=null,i=!1,a._updateFilterTypeState()},e.SearchFilters=a}(Daria),function(){function e(e){if(e.from&&e.to&&/01$/.test(e.from)){var t=e.from.substr(0,4),i=e.to.substr(0,4);if(i!==t)return;var n=e.from.substr(4,2),s=e.to.substr(4,2),a=e.to.substr(6,2);if(Number(a)===new Date(Number(t),Number(s),0).getDate()){if(n===s)return n+"."+t;
if("01"===n&&"12"===s)return t}}}function t(e){return e&&e.date&&e.year&&e.year.length}function i(e){var t=n(e);return t?c(t.getDate())+"."+c(t.getMonth()+1)+"."+t.getFullYear():""}function n(e){if(e){var t=e.match(/^(\d{4})(\d{2})(\d{2})$/);if(t)return new Date(t[1],Number(t[2])-1,t[3],12)}return null}function s(e){return e&&e!==r&&e!==l}function a(e){return!e||e===r}function o(e){return e===l}var r="all",l="invalid",c=Jane.Common.n,d=_.memoize(function(e){var t=e.split("."),i=t.pop(),n=t.pop();
if(Number(i)<Daria.Config.messagesMaxDate)return{from:"all",to:String(Daria.Config.messagesMaxDate-1)+"1231"};var s=n||"01",a=n||"12",o=new Date(Number(i),Number(a),0),r=c(o.getDate());return{from:i+s+"01",to:i+a+r}});Daria.SearchOptions={DEFAULT_VALUE:r,_isOpened:!1,_isDatesValid:!0,_inputsEnabled:!1,mSearchView:null,open:function(){function e(e){return e.value}if(!this._isOpened){var t=Jane.tt("mail:search-options",null,["folders","labels"]);this.$dialog=$(t),this.$pager=this.$dialog.find(".js-pager"),this.$range=this.$dialog.find(".js-range"),this._$pagerComponent=this.$pager.find(".js-pager-component"),this._$dateInputsError=this.$range.find(".js-range-invalid"),this.nbScope=nb.$block(".js-option-scope",this.$dialog),this.nbFolder=nb.$block(".js-option-folder",this.$dialog),this.nbLabel=nb.$block(".js-option-label",this.$dialog),this.nbAttach=nb.$block(".js-option-attach",this.$dialog),this.nbFrom=nb.$block(".js-range-from",this.$dialog),this.nbTo=nb.$block(".js-range-to",this.$dialog),this._scopeIds=_.compact(this.nbScope.getSource().map(e)),this._folderIds=_.compact(this.nbFolder.getSource().map(e)),this._labelIds=_.compact(this.nbLabel.getSource().map(e)),this.mSearchView=ns.Model.get("search-view"),this._setControlsFilterValues(),this._bindEventListeners();
var i=ns.Model.get("search-view").get(".maxWidth");Daria.Dialog.open({body:t,onTarget:{target:this.$anchor,side:"top",pos:"center",needTail:!1,x:12},width:i,additionalClass:"search-options-dialog",hideCrossClose:!0,dontCloseOnPageGo:!0,onopen:this._onDialogOpen.bind(this),onclose:this._onDialogClose.bind(this)}),this._isOpened=!0,ns.events.trigger("search-options:opened")}},_onDialogOpen:function(e){var t=this.$dialog.find(".js-search-filters"),i=t.length?t.width()+1:e.params.width-30;e.$body.find(".search-options").width(i),e.position(),ns.events.trigger("search.update-active-input-width",e.$dialog.outerWidth()+2),this._updateDatePager()
},_onDialogClose:function(){this._isOpened=!1,this._debouncedUpdateErrorNodes.cancel(),this._unbindEventListeners(),this._isDatesValid=!0,this.mSearchView=null,this._destroyControls(),$(document).trigger("hide-calendar"),ns.events.trigger("search-options:closed")},_destroyControls:function(){this.$dialog.remove(),this.$dialog=null,this.$pager.remove(),this.$pager=null,this.$range.remove(),this.$range=null,this._$pagerComponent.remove(),this._$pagerComponent=null,this._$dateInputsError.remove(),this._$dateInputsError=null,this.nbScope.destroy(),this.nbScope=null,this.nbFolder.destroy(),this.nbFolder=null,this.nbLabel.destroy(),this.nbLabel=null,this.nbAttach.destroy(),this.nbAttach=null,this.nbFrom.destroy(),this.nbFrom=null,this.nbTo.destroy(),this.nbTo=null
},close:function(){this._isOpened&&Daria.Dialog.close()},isOpened:function(){return this._isOpened},setAnchor:function(e){this.$anchor=e},setFocus:function(){this.nbScope.focus()},_updateDatePager:function(e){var t=this,i=!1,n={current_folder:e||r};n.current_folder===r&&(i=!0,n.current_folder=ns.Model.get("folders").getFolderBySymbol("inbox").fid),ns.request("messages-pager",n).then(function(){t._renderDatePager(n,i)})},_renderDatePager:function(e,i){this._pager&&(this._pager.unbindEvents(),this._pager=null,this._$pagerComponent.html(null));
var n=ns.Model.get("messages-pager",e),s=e.current_folder;if(i){var a=ns.Model.get("messages-pager",{current_folder:r}),o=!1;if(t(a))if(t(n)){var l=a.getData(),c=n.getData();l=new Date(Number(l.year),Number(l.month)-1,Number(l.day)),c=new Date(Number(c.year),Number(c.month)-1,Number(c.day)),c>l&&(o=!0)}else o=!0;o&&(n=a,s=r)}if(t(n)){var d=Jane.tt("mail:messages-date-pager-search",{"has-slider":!0},["messages-pager"],{current_folder:s});this._$pagerComponent.html(d),$(d).width(Math.max(this.$dialog.find(".js-range:not(.g-invisible)").width()||0,this.$dialog.find(".js-pager:not(.g-invisible)").width()||0)),this._pager=new Daria.MessagesPager(d,!1,{dontUsePageParams:!0}),this._setControlPager()
}},_setControlPager:function(){if(this._pager){var t="";this.mSearchView.get(".searchOptions.from")&&this.mSearchView.get(".searchOptions.to")?(t=e(this.mSearchView.get(".searchOptions")),t&&(t=t.replace(".",""))):this.mSearchView.get(".searchOptions.from")||this.mSearchView.get(".searchOptions.to")||(t="all"),t?(this._pager.setCurrentItem(t),this._pager.setPagerToDate(t,!0)):this._pager.resetCurrentItem(!0)}},_setControlsFilterValues:function(){if(this.nbScope){this.nbScope.setState({value:this.mSearchView.get(".searchOptions.scope")||r}),this.nbFolder.setState({value:this.mSearchView.get(".searchOptions.fid")||r});
var e=r;"yes"===this.mSearchView.get(".searchOptions.unread")?e="unread":this.mSearchView.get(".searchOptions.lid")&&(e=this.mSearchView.get(".searchOptions.lid")),this.nbLabel.setState({value:e}),this._setControlPager(),this.nbFrom.setValue(i(this.mSearchView.get(".searchOptions.from"))),this.nbTo.setValue(i(this.mSearchView.get(".searchOptions.to"))),"yes"===this.mSearchView.get(".searchOptions.attaches")?this.nbAttach.check():this.nbAttach.uncheck(),this._updateDatesSection(),this._updateDateInputsError()
}},_onSelectDateFrom:function(){this._dateInputs.from.hide(),this._onChangeDateInput(this.nbFrom,"from"),this.nbTo.getValue()||_.defer(function(){this.nbTo.focus()}.bind(this))},_onSelectDateTo:function(){this._dateInputs.to.hide(),this._onChangeDateInput(this.nbTo,"to"),this.nbFrom.getValue()||_.defer(function(){this.nbFrom.focus()}.bind(this))},_bindEventListeners:function(){var e=this;this.nbScope.on("nb-changed",function(){e.mSearchView.setIfChanged(".searchOptions.scope",this.getState().value)&&e._search()
}),this.nbFolder.on("nb-changed",function(){e.mSearchView.setIfChanged(".searchOptions.fid",this.getState().value)&&(e._updateDatePager(e.mSearchView.get(".searchOptions.fid")),e._search())}),this.nbLabel.on("nb-changed",function(){var t=this.getState().value;"unread"===t?(e.mSearchView.setIfChanged(".searchOptions.unread","yes"),e.mSearchView.setIfChanged(".searchOptions.lid",r)):(e.mSearchView.setIfChanged(".searchOptions.unread","all"),e.mSearchView.setIfChanged(".searchOptions.lid",t)),e._search()
}),this.nbAttach.on("nb-changed",function(){e.mSearchView.setIfChanged(".searchOptions.attaches",this.isChecked()?"yes":null)&&e._search()});var t=this._onChangeDateInput.bind(this,e.nbFrom,"from"),i=this._onChangeDateInput.bind(this,e.nbTo,"to");this.nbFrom.on("focusin",t),this.nbFrom.on("nb-changed",t),this.nbFrom.on("focusout",t),this.nbFrom.$control.on("keydown",function(t){13===t.keyCode&&e._onSelectDateFrom()}),this.nbTo.on("focusin",i),this.nbTo.on("nb-changed",i),this.nbTo.on("focusout",i),this.nbTo.$control.on("keydown",function(t){13===t.keyCode&&e._onSelectDateTo()
}),this.$dialog.on("click",".b-mail-paginator__link",function(){var t=$(this),i=t.attr("data-pager");if("all"===i)e.mSearchView.setIfChanged(".searchOptions.from","all"),e.mSearchView.setIfChanged(".searchOptions.to","all");else{var n=d(i);e.mSearchView.setIfChanged(".searchOptions.from",n.from),e.mSearchView.setIfChanged(".searchOptions.to",n.to)}e._pager.setCurrentItem(i.replace(".","")),e._search()}),this.$dialog.on("click",".js-toggle-inputs",function(t){e._toggleInputs(Boolean($(this).data("enable"))),t.preventDefault(),t.stopPropagation()
}),this.$dialog.on("submit",".search-options",function(t){t.preventDefault(),e._search()}),$(".b-page").on("mousedown.search-options",function(t){$.contains(e.$dialog[0],t.target)||$.contains($(".js-search-submit")[0],t.target)||(e._onChangeDateInputCheck(e.nbFrom,"from"),e._onChangeDateInputCheck(e.nbTo,"to"),e.close())}),$(window).on("keydown.search-options",function(e){e.which===Jane.Common.keyCode.SPACE_CHAR&&$(e.target).hasClass("nb-select")&&e.preventDefault()}),$(window).on("resize.search-options",_.debounce(function(){Daria.SearchOptions.close()
},5))},_unbindEventListeners:function(){$(window).off(".search-options"),$(".b-page").off(".search-options")},_search:function(){this._validateDates()&&ns.events.trigger("search.start-search",{force:!0,metrika:"advanced",hideOptions:!1})},_onChangeDateInputCheck:function(e,t){var i,n=e.getValue().trim(),s={from:".searchOptions.from",to:".searchOptions.to"}[t];if(ns.assert(s,"Daria.SearchOptions","jpath not set for field %s",t),n)if(i=n.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/))try{$.datepicker.parseDate("dd.mm.yy",n),this.mSearchView.set(s,i[3]+c(i[2])+c(i[1]))
}catch(a){this.mSearchView.set(s,l)}else this.mSearchView.set(s,l);else this.mSearchView.set(s,r);if(this._dateInputs){var o=null;n&&i&&(o=new Date(i[3],Number(i[2])-1,i[1],12)),"from"===t?this._dateInputs.to.updateOptions({minDate:o}):this._dateInputs.from.updateOptions({maxDate:o||new Date})}this._updateDateInputsError()},_onChangeDateInput:function(e,t){this._onChangeDateInputCheck(e,t),this._search()},_toggleInputs:function(e){e||(this.mSearchView.setIfChanged(".searchOptions.from",null),this.mSearchView.setIfChanged(".searchOptions.to",null)),this._dateInputs&&(this._dateInputs.from.hide(),this._dateInputs.to.hide()),this._inputsEnabled=e,this._setControlsFilterValues()
},_updateDatesSection:function(){this._inputsEnabled&&this._initDateInputs(),this.$pager.toggleClass("g-invisible",this._inputsEnabled),this.$range.toggleClass("g-invisible",!this._inputsEnabled)},_initDateInputs:function(){var e={zIndex:1e3};this._dateInputs={from:new Jane.DateInput(this.nbFrom,{isSimpleDateFormat:!0,addStyle:e,maxDate:new Date,onSelect:this._onSelectDateFrom.bind(this)}),to:new Jane.DateInput(this.nbTo,{isSimpleDateFormat:!0,addStyle:e,maxDate:new Date,onSelect:this._onSelectDateTo.bind(this)})}
},_updateDateInputsError:function(){this._reversedDates=!1;var e=this.mSearchView.get(".searchOptions.from"),t=this.mSearchView.get(".searchOptions.to"),i=!o(e)&&!o(t)&&(s(e)||a(e))&&(s(t)||a(t));i&&s(e)&&s(t)&&n(e)>n(t)&&(i=!1,this._reversedDates=!0),this._isDatesValid=i,Jane.watcher.set("daria:vSearchOptions:suppressClosing",!this._isDatesValid),this._debouncedUpdateErrorNodes()},_updateErrorNodes:function(){var e=!1,t=this.mSearchView.get(".searchOptions.from"),i=this.mSearchView.get(".searchOptions.to");
if(this.nbFrom.$node.removeClass("_nb-is-wrong"),this.nbTo.$node.removeClass("_nb-is-wrong"),!this._isDatesValid){var n=this._reversedDates||!s(t),a=this._reversedDates||!s(i);e=n||a,n&&this.nbFrom.$node.addClass("_nb-is-wrong"),a&&this.nbTo.$node.addClass("_nb-is-wrong")}var o;o=this._reversedDates?"Укажите правильную дату":"Неверный формат даты",this._$dateInputsError.text(o).toggleClass("g-hidden",!e)},_validateDates:function(){return this._isDatesValid}},Daria.SearchOptions._debouncedUpdateErrorNodes=_.debounce(Daria.SearchOptions._updateErrorNodes,10)
}(),Daria.composeGo=function(e,t){t=t||{},e=e||{};var i=Vow.promise(),n=ns.router.generateUrl("compose2",e);if(ns.page.block.clearByCondition(function(e){return Boolean(e.compose)}),!t.force&&Daria.vCompose&&"compose"===ns.page.current.page){var s=Daria.vCompose.checkChanges.bind(Daria.vCompose,i);s.compose=!0,ns.page.block.add(s)}return ns.page.go(n).then(i.fulfill,function(e){"block"!==e&&i.reject(e)},i),i},function(e,t){t.Geolocation={getData:function(){var e=$.Deferred();return navigator.geolocation.getCurrentPosition(function(t){e.resolve(t)
},function(t){e.reject(t)}),e.promise()},checkUserRelevance:function(){return Modernizr.geolocation&&Modernizr.mozilla?t.uidEnds([39,94,92,44,55]):!1},monitoring:function(){this.checkUserRelevance()&&this.getData().done(function(t){var i=$.extend({event:"geolocation",result:"success"},t.coords);e.ErrorLog.send(i)}).fail(function(t){var i=$.extend({event:"geolocation",result:"failure"},t);e.ErrorLog.send(i)})}}}(Jane,Daria),Daria.ContactActions={},Daria.ContactActions.openMessageMenu=function(e,t){var i=ns.View.create("contact-actions",t);
i.update().then(function(){var t=nb.block(i.node.firstChild);t.on("nb-closed",function(){this.destroy()}),t.on("nb-select",function(e,i){var n=i.ui.item.children(),s=n.data("action");s&&ns.events.trigger("daria:ContactActions:"+s,i.ui.item),n.data("noclose")||t.close()}),t.open({where:e,how:{autoclose:!0,at:"center bottom",my:"center top"}})})},function(e,t){var i=function(e,i){var n=ns.Model.get("messages",i);if(e.filter.type="search",e.filter.param={},$.each(["request","fid","scope","from","to","unread","lid"],function(t,n){i[n]&&(e.filter.param[n]=i[n])
}),e.filter.param.reqid=t.Config.ensureSearchSessionId(),e.message&&e.message.mid){n.isSearchTopResult(e.message.mid)&&(e.filter.param.tophits="yes");var s=n.getMessageByMid(e.message.mid),a=(n.models||[]).indexOf(s);a>-1&&(e.message.index=a+1)}e.filter.param=$.param(e.filter.param)},n=function(t,i,n,s){if(1===i.ids.length^1===i.tids.length){var a=i.ids.shift(),o=i.tids.shift(),r=a||o,l=ns.Model.get("message",{ids:r}),c=l.getData()||n.messageInfo;if(c&&c.date){if(t.message={thread:o?c.count:0,timestamp:c.date.timestamp,type:c.type,from:jpath(c,'.field[.type=="from"].email')[0],index:c.idx,subject:c.subject},l.isNew()&&(t.message.isnew=1),_.forEach(["widget","widget-type","widget-controls"],function(e){n[e]&&(t.message[e]=n[e])
}),c.fid){var d=ns.Model.get("folders").getFolderById(c.fid);d&&(t.message.folder={fid:d.fid},d.symbol&&(t.message.folder.symbol=d.symbol))}a?t.message.mid=a:o&&(t.message.tid=o),"show"===s&&e.watcher.get("message.may-unsubscribe")&&(t.message.actions=["unsubscribe"])}else t.message=null}else t.messages={count:i.ids.length,threads:i.tids.length}};t.actionLog=function(e,s){var a=$.extend({},ns.page.current.params),o=s.originalAction||s.action,r=ns.page.current.page,l=s.mMessagesChecked?s.mMessagesChecked.getIds():{},c=$.extend(!0,{},{ids:[],tids:[]},s.ids||{},l),d=t.getPrevPageSearchContext();
if(s.islog!==!1){c.tids.length||c.ids.length||!a.ids||c.ids.push(a.ids);var u=new Date,h={timestamp:u.getTime()+60*u.getTimezoneOffset()*1e3,action:o,platform:navigator.platform,filter:{page:r,type:null,param:null}};n(h,c,s,o),"search"===a.search?i(h,a):"message"===r&&d?i(h,d.page.params):a.thread_id?(h.filter.type="thread",h.filter.param=a.thread_id):a.current_label?(h.filter.type="label",h.filter.param=a.current_label):a.current_folder?(h.filter.type="folder",h.filter.param=a.current_folder):a.extra_cond&&(h.filter.type=a.extra_cond),s.btn&&(h.btn=s.btn);
var m={data:JSON.stringify(h)};"search"===h.filter.type&&(m.isSearch=!0),ns.request.addRequestParams(m),$.post(t.handlersPrefix+"/action-log.jsx",m)}};var s;ns.events.on("user.action.log",t.actionLog),ns.events.on("message.action.complete",t.actionLog),ns.events.on("ns-page-after-load",function(){var e=ns.page.current,i=ns.page.current;if(s&&"message"===s.page&&"messages"===i){var n=e.current_folder;if(n){var a=ns.Model.get("folders").getFolderBySymbol("inbox");a&&a.fid===n&&t.actionLog("pageload",{action:"gotoinbox",eventObject:{params:$.extend({islog:!0},e)}})
}}s=$.extend(!0,{},ns.page.current)})}(Jane,Daria),function(){var e=function(){var e=/^([^@]+)@(ya(?:ndex\-team|money)\.(?:ru|com(\.(tr|ua))?))$/;return{isCorp:function(t){return e.test(t)},getDomain:function(e,t){t=Array.isArray(t)?t:[];var i=e.replace(/^[^@]+@/,""),n=i.split(".");return n.length>2&&(n=n.slice(-1!==t.indexOf(n.slice(-2).join("."))?-3:-2)),n.join(".")},isServiceEmail:function(e,t){if("object"!=typeof t)return!0;var i=e.split("@"),n=i[0],s=i[1];return Array.isArray(t.login)&&-1!==t.login.indexOf(n)?!0:Array.isArray(t.domain)&&-1!==t.domain.indexOf(s)?!0:Array.isArray(t.full)&&-1!==t.full.indexOf(e)?!0:!1
}}}();Daria.email={},Daria.email.isCA=function(e,t){var i=e.match(/^(\+?\d+)@ya(?:ndex)?\./);return i?(t&&(t.phone=i[1]),!0):!1},Daria.email.isCorp=function(t){return Daria.IS_CORP&&e.isCorp(t)},Daria.email.isSupport=function(e){var t=/^(?:[^@]+)@(?:support\.yandex\.(?:ru|ua|com|com\.tr|com\.ua))$/;return t.test(e)},Daria.email.getDomain=function(t,i){return e.getDomain(t,i)}}(),function(e){var t={doc:"doc",docx:"doc",htm:"doc/text",html:"doc/text",mht:"doc",odt:"doc",rtf:"doc",txt:"doc/txt",pdf:"pdf",odp:"ppt",ppt:"ppt",pptx:"ppt",csv:"xls/xls",ods:"xls",ots:"xls",xls:"xls",xlsx:"xls",eml:"mail/eml",vcf:"mail/eml",exe:"application/exe",aac:"audio/audio",mka:"audio",mp3:"audio/mp3",ogg:"audio/audio",wav:"audio",wma:"audio/wma",ai:"image/ai",bmp:"image/bmp",cdr:"image/cdr",djvu:"image",eps:"image",gif:"image/gif",ico:"image",jpe:"image",jpeg:"image/jpg",jpg:"image/jpg",pcx:"image/pcx",pjpeg:"image",png:"image/png",ps:"image",psd:"image/psd",tga:"image",tif:"image/tiff",tiff:"image/tiff","3gp":"video",avi:"video/avi",flv:"video/video",m2v:"video",mkv:"video",mov:"video/mov",mp4:"video/mp4",mpe:"video",mpeg:"video",mpg:"video",qt:"video",vob:"video",wmv:"video/wmv","7z":"zip/zip",arj:"zip/zip",bz2:"zip",lzh:"zip/zip",uc2:"zip/zip",zip:"zip",rar:"rar"},i=["bmp","gif","jpg","jpeg","pjpeg","pcx","png","tif","tiff"],n=["apk","cab","dmg","docb","docm","gz","js","msi","phps","pptb","pptm","sea","sit","tar","torrent","xlsb","xlsm","xpi"];
$.each(n,function(e,i){t[i]="general/general"}),e.getExtensionInfo=function(n){var s=e.getExtension(n),a=(t[s]||"").split("/"),o={"class":a[0]||"general",preview:$.inArray(s,i)>-1};return a.length>1&&(o.icon=a[1]),o},e.getExtension=function(t){return e.splitName(t)[1].toLowerCase()},e.splitName=function(e){e=e||"";var t=e.split(".");if(1==t.length)return[e,""];var i=t.pop();return[t.join("."),i]}}(Daria),Daria.MessageAction={},Daria.MessageTime={getFormattedTime:function(e){var t={attach:void 0,title:void 0,message:void 0,list:void 0,full:void 0,isRelative:!1},i=this._getUserTZ(),n=new Date(Daria.now()-i),s=new Date(e-i);
return n.getUTCDate()===s.getUTCDate()&&n.getUTCMonth()===s.getUTCMonth()&&n.getUTCFullYear()===s.getUTCFullYear()?(t.message=Jane.Date.format("%Date_today_at_HM",s,!0),t.list=Jane.Date.format("%Date_HM__colon",s,!0),t.attach=t.list,t.full=Jane.Date.format("%Date_dB_in_HM",s,!0),t.isRelative=!0):n.getUTCFullYear()!==s.getUTCFullYear()?(t.message=Jane.Date.format("%Date_dmy__dot",s,!0),t.list=t.message,t.attach=Jane.Date.format("%Date_db",s,!0),t.title=Jane.Date.format("%Date_dmy_at_HM",s,!0),t.full=Jane.Date.format("%Date_dBY_year_in_HM",s,!0)):(t.message=Jane.Date.format("%Date_db_in_HM",s,!0),t.list=Jane.Date.format("%Date_db",s,!0),t.attach=t.list,t.title=t.message,t.full=Jane.Date.format("%Date_dB_in_HM",s,!0)),t
},_getUserTZ:function(){return ns.Model.get("account-information").get(".tz_offset")*Jane.Date.MINUTE}},Daria.getPageTitle=function(e,t){var i,n,s="",a=t.ids;switch(e){case"message":i=ns.Model.get("message",{ids:a}),n=i.getSubject();var o=i.getFromName();n&&o&&(s+="Письмо «"+n+"» — "+o);break;case"messages":var r=t.current_folder;if(r){var l=ns.Model.get("folders").getFolderById(r);if(l){var c=l.name,d=l["new"];s+=d>0?d+" · "+c:c}}break;case"compose":if(i=ns.Model.get("message",{ids:a}),!(a&&/^\d+$/.test(a)&&i.isValid())){s+="Новое письмо";
break}n=i.getSubject();var u=t.oper;switch(u){case"reply":case"reply-all":s+="Ответ на письмо «"+n+"»";break;case"forward":s+="Пересылка письма «"+n+"»";break;default:s+="Сохраненное письмо «"+n+"»"}}return s&&(s+=" — "),s+="Яндекс.Почта"},Daria.updateTitle=function(){var e=ns.page.current.params,t=ns.page.current.page,i=Daria.getPageTitle(t,e),n=Jane.watcher.get("pageVisible"),s=n?0:Math.min(Daria.gotNewMail,10);"compose"===t&&(s=t);var a=Daria.IS_CORP?"ya-team-favicon":"blue-favicon",o="favicon/"+a+"/"+s+".ico";
jQuery("#favicon, #png16favicon, #png32favicon").remove();var r='<link id="favicon" href="/u2709/'+o+'" type="image/x-icon" rel="shortcut icon"><link id="png16favicon" rel="icon" href="/u2709/favicon/16/'+a+"/"+s+'.png" sizes="16x16"></link><link id="png32favicon" rel="icon" href="/u2709/favicon/32/'+a+"/"+s+'.png" sizes="32x32"></link>';jQuery("head").append(r),Daria.gotNewMail&&!n&&(i="* "+i),document.title=i},ns.events.on("pageVisible.change",function(){Daria.gotNewMail=0,Daria.updateTitle()}),ns.events.on("ns-page-after-load",function(){Daria.updateTitle()
}),function(){function e(e){return o(e.text)||n(e.text)?!0:!1}function t(e){e.convert=n(e.text),e.convert=e.convert.replace("--\n","-- \n"),e.preview=e.convert.trim();var t=e.preview.split("\n");return t.length>3&&(e.spreview=t.slice(0,3).join("\n")),e}function i(e){e.convert=s(e.text),e.convert=Daria.Html2Text.flatDOMHtml(e.convert),e.convert=e.convert.replace("-- ","--&nbsp;").replace(">--<",">--&nbsp;<"),e.preview=Daria.Html2Text.html2text(e.convert).trim(),!e.preview&&o(e.text)&&(e.preview="< Изображение >");
var t=e.preview.split("\n");return t.length>3&&(e.spreview=t.slice(0,3).join("\n")),e}function n(e){return e=Daria.Html2Text.text2html(e),e=_.unescape(e),Daria.Html2Text.html2text(e)}function s(e){return e=Daria.Html2Text.text2html(e),e=_.unescape(e),"<div>"+e+"</div>"}function a(e){return/<[^>]+>/.test(e)}function o(e){return/<img[^>]*>/i.test(e)}Daria.signs={mSettings:function(){return this._mSettings||(this._mSettings=ns.Model.get("settings")),this._mSettings},sort:function(e,t){return function(i,n){var s=$.map(arguments,function(i){var n=0;
return i.isDefault&&(n+=1),t&&i.lang===t&&(n+=2),e&&-1!==$.inArray(e,i.emails)&&(n+=4),n});return s[0]<s[1]?1:s[0]>s[1]?-1:i._idx<n._idx?-1:i._idx>n._idx?1:0}},getHtml:function(){var t=$.makeArray(this.mSettings().getSetting("signs"));return $.map($.grep(t,e),i)},getPlain:function(){var i=$.makeArray(this.mSettings().getSetting("signs"));return $.map($.grep(i,e),t)},addSignature:function(t,i){var n=$.makeArray(this.mSettings().getSetting("signs"));n=$.grep(n,e),n.push(t),this.mSettings().setSettings({signs:n},function(e,t){i(e,t)
})},changeByText:function(e,t){var i=this,n=$.makeArray(this.mSettings().getSetting("signs")),s=n.length;n=$.grep(n,function(e){return!i.compare(e.text,t)}),s!==n.length&&(n.push({text:e}),ns.Model.get("settings").setSettings({signs:n},function(e,t){e||(-1!==$.inArray("signs.maxcount",t)?Daria.Dialog.notice({body:"<p>К сожалению, нельзя добавить более 20 подписей.</p>",width:350}):-1!==$.inArray("signs.maxlen",t)?Daria.Dialog.notice({body:"<p>Подпись должна быть не длиннее 10000 символов. Пожалуйста, сократите.</p>",width:350}):Daria.Statusline.showMsg({name:"signature.append.result",body:"Ошибка при добавлении подписи"}))
}))},removeByText:function(e){var t=$.makeArray(this.mSettings().getSetting("signs")),i=t.length;t=$.grep(t,function(t){return t.text!==e}),i!==t.length&&this.mSettings().setSettings({signs:t})},appendSeperator:function(e){function t(e){return e.replace(/[\u0020\u00a0]+/g,"").replace(/&nbsp;/g,"")}var i=!1;if(a(e)){var n=$(s(e)),o=n.find("*").filter(function(){if(i)return!1;var e=$(this);if(e.children().length)return!1;var n=t(e.text());return"--"===n?(i=!0,!1):n||"IMG"===this.tagName?(i=!0,!0):!1
});return o.length&&$("<div>--&nbsp;</div>").insertBefore(o),Daria.Html2Text.flatDOMHtml(n.html())}return e.replace(/.*/gm,function(e){if(i)return e;var n=t(e);return"--"===n?(i=!0,e):n?(i=!0,"-- \n"+e):e})},getSignatureMatch:function(e){var t;return e&&(e=n(e),t=e.replace(/^\s*$/gm,"").replace(/^[\n\r]+/g,"").match(/^.+$/m),t&&(this.__firstLineMatch=Daria.regexpEscape(t[0]).replace(/\s/g,"\\s"))),this.__firstLineMatch||""},appendToBody:function(e,t,i,n,s){var a,o,r=[],l="html"===t&&!Modernizr.ios;
if(l?(r=this.getHtml(),a="<div><br/></div><div><br/></div>",o="<div><br/></div>"):(r=this.getPlain(),a="\n\n",o="\n"),!r.length)return e;n=n||this.mSettings().getSetting("default_email"),s=s||Daria.Config.locale,r.sort(this.sort(n,s));var c=r.shift();return l&&(c.convert=Daria.Html2Text.flatDOMHtml(c.convert)),this.getSignatureMatch(c.convert),!i&&this.mSettings().isSet("signature_top")?a+c.convert+o+e:e+a+c.convert+o},isEmpty:function(e){return!o(e)&&!n(e)},isExistSignature:function(e){for(var t=this.getHtml(),i=t.length;i--;)if(this.compare(t[i].convert,e))return!0;
return!1},count:function(){var t=$.makeArray(this.mSettings().getSetting("signs"));return $.grep(t,e).length},sample:function(){var e=this.mSettings().getSetting("from_name");if(!e)return!1;var t=(ns.Model.get("userphones").getActivePhone()||{}).number;if(!t)for(var i=this.mSettings().getSetting("emails"),n={},s=0;s<i.length;s++){var a=i[s];if(a["native"]&&a.validated&&Daria.email.isCA(a.address,n)){t=n.phone;break}}if(!t)return!1;var o=this.mSettings().getSetting("default_email"),r={name:e,phone:t,email:o};
r.content=Daria.supplant("<div>--&nbsp;</div><div>{prefix}</div>{phone}",{prefix:"С уважением,<br> "+_.escape(e),phone:t?"<div>"+_.escape(t)+"</div>":""},!0);var l=$.grep(this.getHtml(),function(e){return this.compare(e.convert,r.content)}.bind(this));return l.length?!1:r},compare:function(e,t){return e=e.replace(/<\/?[^>]+>/gi,"").replace(/[\s\n]/g,"").replace(/&nbsp;/g,""),t=t.replace(/<\/?[^>]+>/gi,"").replace(/[\s\n]/g,"").replace(/&nbsp;/g,""),e===t},reset:function(){delete this._mSettings}}
}(),function(e){e.UISettings={},e.UISettings.shouldShowCheckboxInsideUserpic=function(){var t=ns.Model.get("settings"),i=t.getSetting("show_checkbox_inside_userpic"),n=e.is3pane();return n||i}}(Daria),Daria.url={_checkAttachmentHasHid:function(e){if(!this._notEmptyString(e.hid))throw new Error("Attachment should have a hid")},_checkMid:function(e){if(!this._notEmptyString(e))throw new Error("Invalid message id passed")},_getAttachmentName:function(e){return e["name-uri-encoded"]||e.name||""},_notEmptyString:function(e){return e&&"string"==typeof e
},docviewer:function(e,t){this._checkMid(t),this._checkAttachmentHasHid(e);var i=Daria.Config;return i["docviewer-frontend-host"]+"/?url="+encodeURIComponent("ya-mail://"+t+"/"+e.hid)+"&name="+this._getAttachmentName(e)+"&uid="+Daria.uid},isEMLSuffixMissing:function(e,t,i){if(!i)return!1;var n=decodeURIComponent(i),s=n.split("."),a="message/rfc822"===[e,t].join("/"),o=_.all([s.length>1&&"eml"!==_.last(s)||1===s.length,a]);return o},attachment:function(e,t,i){var n;if(e.url)return n=$.url(e.url),n.replaceParams({uid:Daria.uid}),n.toString();
if("string"==typeof t){this._checkMid(t),this._checkAttachmentHasHid(e);var s=this._getAttachmentName(e);this.isEMLSuffixMissing(e.type,e.subtype,s)&&(s=encodeURIComponent(decodeURIComponent(s)+".eml")),n="../message_part/"+s+"?_uid="+Daria.uid+"&name="+s+"&hid="+e.hid+"&ids="+t;var a=["no_disposition","exif_rotate","thumb","preview"],o=["thumb_size","fallback_url"];i=i||{};for(var r in i)i.hasOwnProperty(r)&&(a.indexOf(r)>-1&&Boolean(i[r])?n+="&"+r+"=y":o.indexOf(r)>-1&&(n+="&"+r+"="+i[r]));return n
}},archive:function(e,t){var i="../message_part/",n=_.flatten(jpath(e,".attachment")),s=_.filter(n,function(e){return!e.inline&&(e.name||e.message)&&!e.narod}).map(function(e){return e.hid});if(0===s.length)return!1;var a=1===s.length;s=s.join(",");var o=jpath(e,'.info.field[.type == "from"].email')[0],r=new Date(Number(e.info.date.timestamp)),l=Jane.Common.n,c=r.getFullYear()+"-"+l(r.getMonth()+1)+"-"+l(r.getDate())+"_"+l(r.getHours())+"-"+l(r.getMinutes())+"-"+l(r.getSeconds()),d=a?jpath(e,".attachment.name")[0]:"Attachments_"+o+"_"+c+".zip",u=encodeURIComponent(d),h={_uid:Daria.uid,hid:s,ids:t,name:d};
a||(h.archive="zip");var m=ns.params2query(h);return i+u+"?"+m},getAttachmentsArchiveLink:function(e){var t={ids:e},i=$.Deferred();return ns.request("message-body",t).then(function(e){var t=e[0].getData();i.resolve(this.archive(t))}),i.promise()},upload:function(e){var t=$.url(Daria.Config.mailUploadServiceUrl),i=Daria.parseQuery(t.query());return _.isPlainObject(e)&&_.assign(i,e),ns.request.addRequestParams(i),t.query(i),t.toString()}},function(){Daria.COPS={},Daria.COPS["abook.select-all"]=function(e){e.selectAll()
},Daria.COPS["abook.deselect-all"]=function(e){e.unselectAll()},Daria.COPS["mail-common.person-popup"]=function(){return ns.events.trigger("daria:vAbookContacts.showPersonPopup",{}),Vow.fulfill()},Daria.COPS["abook.open-backups-dialog"]=function(){return ns.View.create("abook-restore-dialog").show()},Daria.COPS["abook.remove-contacts"]=function(e){var t=e.getCids(),i=ns.Model.get("abook-contacts");return i.removeContacts(t).then(function(){ns.Model.invalidateAll(["abook-contacts","abook-selected"]),ns.page.go()
})},Daria.COPS["abook.toolbar-more-actions"]=function(e,t){var i=Daria.COPS["abook.toolbar-more-actions"];return i._openView?(i._openView.destroy(),delete i._openView):i._openView=ns.View.create("abook-extra-actions").open({where:t.buttonView.node}),Vow.fulfill()},Daria.COPS["abook.groups-dropdown"]=function(e,t){var i=Daria.COPS["abook.groups-dropdown"];return i._openView?(i._openView.destroy(),delete i._openView):i._openView=ns.View.create("abook-groups-dropdown",e.params).open({where:t.buttonView.node}),Vow.fulfill()
},Daria.COPS["abook.remove-contacts-from-group"]=function(e){var t=Number(ns.page.current.params.tid||0);if(0>=t)return Vow.fulfill();Daria.Dialog.close();var i=e.getCids();return ns.Model.get("abook-groups").removeFromGroup({tids:[t],mcids:i}).then(function(){e.clear(),ns.page.go()})},Daria.COPS["abook.compose-go"]=function(e){ns.Model.get("compose-predefined-data").set(".to",e.emailsToString()),ns.Model.get("settings").isSet("compose-in-window")?ns.Model.get("compose-sidebar-fsm").setState("edit"):ns.page.go(ns.router.generateUrl("compose2"))
},Daria.COPS["abook.assign-contacts-from-group"]=function(e,t){var i=Number(t.tid),n=$(t.target),s=no.jpath(".current.params.tid",ns.page),a=e.getCids(),o=e.getContactsMcids(s),r=!0,l=[];if(_.each(o,function(e){e.length>1&&(r=!1),l.push(e)}),0===a.length)return Vow.reject();if(r)return new vow.Promise(function(e,t){ns.Model.get("abook-groups").addToGroup({tid:i,mcids:l}).then(e,t)});if(n.length&&1===a.length){var c=a[0];ns.events.trigger("daria:vAbook:showChooseEmailPopup",{cid:c,tid:i,target:t.target})
}else ns.events.trigger("daria:vAbook.showGroupPopup",{type:"add-to-group",targetTid:i});return Vow.reject()},Daria.COPS["abook.assign-contacts-from-phone-group"]=function(e){var t=e.getCids();return new vow.Promise(function(e,i){ns.Model.get("abook-groups").addToGroup({tid:-10,mcids:t}).then(e,i)})}}(),function(){function e(e){ns.events.trigger("daria:MOPS:action-complete",{action:e}),ns.events.trigger("daria:MOPS:"+e,{})}function t(e,t,i,n){Daria.messages.clearCacheByLID(i),Jane.watcher.set("actions-message-label",e,{force:!0}),ns.events.trigger("message.action.complete",{action:e,eventObject:{ids:t,params:n},skipFocus:!0})
}function i(e){return e&&"object"==typeof e?e.ids.length>0||e.tids.length>0:!1}function n(e){var t=e.ids.concat(e.tids),i=t.filter(function(e){return!ns.Model.get("state-message-thread-item",{ids:e}).isOpen()});if(Daria.Page.isParamsForMessage(ns.page.current.params)){var n=Daria.Page.getMessageId(ns.page.current.params);i=_.without(i,n)}if(i.length){var s={type:"mark_read_from_list",mids:i};Jane.ErrorLog.send(s)}}function s(e,t,n){n=d(e,n);var s=n.current_folder,o=t.getCount(),r=n["message-id"];
e=Daria.MOPS.fixMoveAction(e,s);var l=t.getIds(e,n);r&&(l.ids=$.grep(l.ids,function(e){return e===r}));var c=_.extend({},n,{ids:l,count:o,action:e}),u=Daria.messages.whereToGoAfterMove(e,t,c);c.whereToGo=u,ns.events.trigger("daria:MOPS:action-start",c);var h=[];if("delete"===e&&t.isFolderSelected()){var m=t.getSelectedFolder();if(!m)return Daria.DEBUG&&console.error("Promise rejected because of no fid"),Vow.reject("no-selection");var g={fid:m};g.method=ns.Model.get("folders").isFolder(s,["trash"])?"purge":"clear",h.push({id:"do-folder-clear",params:g})
}else{if(!i(l))return Daria.DEBUG&&console.error("Promise rejected because of no selection"),Vow.reject();"move"==e&&ns.action.run("trigger-hotkeys-promo-bubble",{eventName:"Folders_dialog"}),h.push({id:"do-messages",params:_.extend({movefile:s,action:e},l)})}h.push({id:"folders"},{id:"labels"});var p=ns.page.current.params,f=Daria.is3pane(),v=!1;if(f)if(p.thread_id&&p.current_folder){var b=ns.Model.get("messages",{thread_id:p.thread_id}),y=b.getCountThreadMessageInFolder();y===!1?(Daria.lom.deleteFid(p.current_folder),v=!0):(l.ids.forEach(function(e){ns.Model.get("message",{ids:e}).getFolderId()===p.current_folder&&y--
}),1>y&&(Daria.lom.deleteFid(p.current_folder),v=!0))}else Daria.lom.deleteFid(p.current_folder);if(v){var M=ns.router(c.whereToGo.where);"messages"===M.page&&M.params.thread_id&&(delete M.params.thread_id,c.whereToGo.where=ns.router.generateUrl(M.page,M.params),c.whereToGo.updateRequired=!0)}Daria.MOPS.invalidateModelsOnMove(e,n,p);var S=t.getOnlyCheckedMidOrTid(l),D=ns.Model.get("message",{ids:S}),w=D.isSpam(),C=!(!ns.page.current.params.ids&&!ns.page.current.params.thread_id),k=Boolean("messages"===ns.page.current.page&&C&&Daria.is2pane()&&(ns.page.current.params.ids||ns.page.current.params.thread_id&&_.lte(D.getThreadMessage().getThreadCount()||0,1)||D.isThreadModel())&&"delete"===e);
if("delete"===e||e.indexOf("spam")>=0||"move"===e&&w){n.hasCouponMessage=!1,c.hasCouponMessage=!1;var T=Daria.array2obj(l.ids);1===l.ids.length^1===l.tids.length&&(c.messageInfo=_.cloneDeep(ns.Model.get("message",{ids:S})),n.messageInfo=c.messageInfo),ns.Model.invalidate("message-body",function(e){return T[e.params.ids]})}return Array.isArray(n.requestModels)&&(h=h.concat(n.requestModels.map(function(e){return{id:e,params:n.requestParams}}))),Daria.MOPS.doActionInModelsByIds(l,"move",s),Daria.MOPS.invalidateMessagesCheckedModels(l,e),n.ignoreUnsavedDraft&&ns.page.block.clear(),ns.forcedRequest(h).then(function(){o>(parseInt(ns.Model.get("settings").getSetting("messages_per_page"),10)||30)&&a(e,l,o,n),k&&ns.page.go(Jane.Page.generateUrl.closeMessage()),ns.events.trigger("daria:MOPS:action-complete",c),ns.events.trigger("daria:MOPS:"+e,c),ns.events.trigger("message.action.complete",c)
})}function a(e,t,i,n){var s=Jane.i18n.convert([i+" сообщение удалено",i+" сообщения удалены",i+" сообщений удалено"],i)+".";if("tospam"==e)s=Jane.i18n.convert([i+" сообщение помечено",i+" сообщения помечены",i+" сообщений помечено"],i)+" как спам.";else if("notspam"==e)s=Jane.i18n.convert([i+" сообщение перемещено",i+" сообщения перемещены",i+" сообщений перемещено"],i)+' в папку «<a href="#inbox">Входящие</a>».';else if("move"==e){var a=_.escape(ns.Model.get("message",{ids:t.ids.length?t.ids[0]:t.tids[0]}).getSubject());
s="archive"===n.originalAction?1===i?"Письмо «"+a+"» перемещено в папку «Архив».":Jane.i18n.convert([i+" сообщение перемещено",i+" сообщения перемещены",i+" сообщений перемещено"],i)+" в папку «Архив».":1===i?"Письмо «"+a+"» перемещено.":Jane.i18n.convert([i+" сообщение перемещено",i+" сообщения перемещены",i+" сообщений перемещено"],i)+"."}Daria.Statusline.showMsg({name:"message-"+("move"==e?"moved":"removed"),speed:"fast",body:s})}function o(t,s,a){a=a||{};var o,r,l=s.isFolderSelected(),c=s.getSelectedFolder();
if(l){if(!c)return Daria.DEBUG&&console.error("Promise rejected because of no fid"),Vow.reject("no-selection");o=Daria.MOPS.markByFid(t,c),o.hasAdjust()&&(r=o.getIds())}else{var d=s.getIds();if(o=Daria.MOPS.doActionInModelsByIds(d,t,{fid:c}),r=o.getIds(),!i(r)&&i(d))return Vow.reject("no-item-to-operation")}var u=o.hasAdjust(),h=[];if(l&&!u)h.push({id:"do-folder-mark-read",params:{fid:c}});else{if(!i(r))return Daria.DEBUG&&console.error("Promise rejected because of no selection"),Vow.reject("no-selection");
h.push({id:"do-messages",params:{ids:r.ids,tids:r.tids,action:t}}),"mark"===t&&n(r)}if((Daria.IS_CORP||!u)&&h.push({id:"folders"}),u)return e(t),ns.forcedRequest(h),Vow.resolve();var m=ns.forcedRequest(h);return m.then(function(){e(t)}),m}function r(e,n,s){var a;if("object"==typeof s?(s.actionParams&&(s=s.actionParams),a=s.lid||s.label||s.current_label):a=s,!a)return Vow.reject(new Error("No lid passed"));var o=s["message-id"];s={lid:a};var r;r=o?{ids:[o],tids:[]}:n.getIds();var l=_.any([].concat(r.ids,r.tids),function(e){return!ns.Model.get("message",{ids:e}).hasLabel(a)
});l||(e="unlabel");var c=Daria.MOPS.doActionInModelsByIds(r,e,s);if(r=c.getIds(),!i(r))return Daria.DEBUG&&console.error("Promise rejected because of no selection"),Vow.reject("no-selection");ns.events.trigger("label.update-message-labels");var d=[{id:"do-"+e,params:{lid:a,ids:r.ids,tids:r.tids}}];if(c.hasAdjust())return ns.Model.get("labels").adjustCounters(c.getAdjust()),t(e,r,a,s),ns.forcedRequest(d),Vow.resolve();d.push({id:"labels"});var u=ns.forcedRequest(d);return u.then(function(i){var n=i[0],o=n.getAffectedTids();
o.forEach(function(t){ns.Model.get("message",{ids:t})[e](s)}),t(e,r,a,s)}),u}function l(e,t){var i=ns.Model.get("labels"),n=t.tids;Array.isArray(n)||(n=[n]);var s,a,o,r,l=i.getMuteThreadLabel();_.contains(["ignore","disableIgnore"],e)?(a="label","ignore"===e?(o="Игнорировать",s=l&&l.lid):(o="Не предлагать",r=i.getLIDByName(m),s=r&&r.lid)):(a="unlabel",s=l&&l.lid,o="Отменить");var c=Vow.promise();if(s)c.fulfill(s);else{var d=[{id:"do-labels-add-by-symbol",params:{symbol:"mute_label"}},{id:"labels"}];
"disableIgnore"===e&&(d=[{id:"do-labels-add",params:{label_name:m,label_type:"threadWide"}},{id:"labels"}]),c=ns.forcedRequest(d).then(function(t){if(t[0].get(".body.updated")){var i;return i=_.contains(["ignore","unignore"],e)?t[1].getMuteThreadLabel():t[1].getLabelByName(m),Vow.fulfill(i&&i.lid)}return Vow.reject()})}return Jane.c(h,o),c.then(function(e){return _.each(n,function(t){var i=ns.Model.get("message",{ids:t});i[a]({lid:e})}),d=[{id:"do-"+a,params:{lid:e,tids:n}}],ns.forcedRequest(d)})
}function c(e,t){var i=ns.Model.get("folders");return i.createArchiveFolder().then(function(){var n=i.getFidBySymbol("archive");return n?(t=_.extend({originalAction:"archive",fid:n},t),o("mark",e,t).fail(function(e){if("no-item-to-operation"!==e)throw e}).then(function(){return s("move",e,t)})):Vow.reject("No folder with archive symbol found!")})}var d=function(e,t){return t=t||{},t.folder&&(t.fid=t.folder,delete t.folder),t.current_folder=u(e,t.fid||ns.page.current.params.current_folder),t},u=function(e,t){var i={"delete":"trash",tospam:"spam",notspam:"inbox"};
return _.has(i,e)&&(t=ns.Model.get("folders").getFidBySymbol(i[e])),t},h="Статуслайн игнорирования треда",m="ignore_thisthread:disable",g=function(e){if(e=e.split("mailto:")[1]){e=e.split("?")||[e];var t=e[0],i=e[1];if(i=i?Daria.parseQuery(i):{},!t&&i.to)t=i.to;else if(!t)return;var n=$('<form style="position:absolute;left:-9999em;top:-9999em;"></form>');n.appendTo("body");var s={$form:n,params:{to:t,ttype:"plain",nosave:"yes",feed_address_db:"no"}};i.body&&(s.params.send=i.body),i.subject&&(s.params.subj=i.subject),Daria.SendMail.sendForm(s),setTimeout(function(){n.remove()
},1e3)}};Daria.MOPS={MOVE_ACTIONS:["archive","move","notspam","remove","tospam","infolder"],mark:function(e,t){return o("mark",e,t)},unmark:function(e){return o("unmark",e)},remove:function(e,t){return s("delete",e,t)},"remove.draft":function(e,t){var i=_.extend({},t,{originalAction:"remove.draft"});return s("delete",e,i)},move:function(e,t){return ns.Model.get("folders").isArchive(t.fid)?c(e,t):s("move",e,t)},infolder:function(e,t){return s("move",e,_.extend({originalAction:"infolder"},t))},archive:function(e,t){return c(e,t)
},tospam:function(e,t){return s("tospam",e,t)},notspam:function(e,t){return s("notspam",e,t)},label:function(e,t){return r("label",e,t)},unlabel:function(e,t){return r("unlabel",e,t)},ignore:function(e){return l("ignore",e)},disableIgnore:function(e){return l("disableIgnore",e)},unignore:function(e){return l("unignore",e)},unsubscribe:function(e){var t=e.getOnlyMessageCheckedMid();if(!t)return Vow.reject();for(var i,n,s=ns.Model.get("message-body",{ids:t}),a=s.getUnsubscribeOptions(),o=["mailto-header","https-header","http-header","https-body","http-body"],r=0;r<o.length;r++)if(i=a[o[r]]){n=o[r];
break}if(i){var l=["Отписаться от рассылки"];if(n.indexOf("mailto")>-1)g(i),l.push("mailto","заголовок письма");else{window.open(i,"_blank");var c=n.split("-");switch(l.push(c[0]),c[1]){case"header":l.push("заголовок письма");break;case"body":l.push("тело письма")}}Jane.c(l)}return ns.forcedRequest(["do-unsubscribe"],{ids:t}).then(function(){var i=Daria.is3pane()?{"message-id":t}:{};return i.action="delete",i.originalAction="unsubscribe",Daria.MOPS.remove(e,i)}).then(function(){Daria.Statusline.showMsg({body:"Вы отписались от этой рассылки"})
})},pin:function(e){return Daria.MOPS._pinHelper(e,!0)},unpin:function(e){return Daria.MOPS._pinHelper(e,!1)},"compose-edit":function(){ns.page.go(ns.router.generateUrl("compose2",{ids:ns.page.current.params.ids}))}},Daria.MOPS.markByFid=function(e,t){var i=ns.Model.get("folders"),n=i.getUnreadCount(t);ns.Model.traverse("message",function(i){i.isThread()||i.getFolderId()!==t||i[e]()});var s={};return s[t]=-n,i.adjustUnreadCounters(s),new Daria.MOPS.Opinfo},Daria.MOPS.doActionInModelsByIds=function(e,t,i){var n=[].concat(e.ids,e.tids);
return Daria.MOPS.doActionInMessages(n,t,i)},Daria.MOPS.doActionInMessages=function(e,t,i){var n=new Daria.MOPS.Opinfo;return e.forEach(function(e){var s=ns.Model.get("message",{ids:e});if(s.getData()){var a=s[t](i);n.merge(a)}}),n.hasAdjust()&&"object"==typeof i&&"fid"in i&&ns.Model.get("folders").adjustUnreadCounters(n.getAdjust()),n},Daria.MOPS.fixMoveAction=function(e,t){var i=ns.Model.get("folders");return"move"==e&&(i.isFolder(t,["trash"])?e="delete":i.isFolder(t,["spam"])&&(e="tospam")),e},Daria.MOPS.invalidateModelsOnMove=function(e,t,i){if(ns.Model.destroyAll(["message-nearest"]),["delete","tospam","notspam"].indexOf(e)>-1&&ns.Model.destroyAll(["message-thread-nearest"]),ns.Model.isDefined("messages-pager")){ns.Model.get("messages-pager",i).destroy();
var n=t.current_folder;n&&ns.Model.get("messages-pager",{current_folder:n}).destroy()}},Daria.MOPS.invalidateMessagesCheckedModels=function(e,t){"delete"===t&&(e=[].concat(e.ids,e.tids),ns.Model.traverse("messages-checked",function(t){var i=t.getIds(),n=_(i).chain().values().flattenDeep().compact().map(function(e){return"t"===e.charAt(0)?e.substr(1):e}).value();n.length&&n.some(function(t){return _.include(e,t)})&&t.resetChecked()}))},Daria.MOPS.updateHelper=function(e,t,i,n){var s=function(){ns.events.trigger("daria:vToolbarButton:loader:end")
},a=Daria.MOPS[e](t,i);if(a.then(s,s),n){var o=function(){return a};return n.update(ns.page.current.params).then(o,o)}return a},Daria.MOPS.getFakeMessagesChecked=function(e){var t=ns.Model.get("message",{ids:e}),i=ns.Model.get("messages-checked",{mid:"mops-fake-checked"});return i.check(t,!0),i},Daria.MOPS.doActionWithMessage=function(e,t,i){var n=Daria.MOPS.getFakeMessagesChecked(e);Daria.MOPS[t](n,i).always(function(){n.destroy()})},Daria.MOPS._pinHelper=function(e,t){var i=ns.Model.get("labels").getPinnedLabel().lid,n=t?"label":"unlabel";
return r(n,e,{lid:i}),Daria.MOPS._updateModelsAfterPin(e,t)},Daria.MOPS._getReplacementTreeAfterPin=function(e,t){var i=ns.Model.get("settings"),n=i.isThreaded(),s=e.getData(),a={};return s.forEach(function(e){var i=ns.Model.get("message",{ids:e});if(i.isIntoThread()&&!i.isThread()&&n){var s=ns.Model.get("message",{ids:i.getThreadId()}),o=ns.Model.get("messages",{thread_id:i.getThreadId()}),r=o.getPinned();t||0===r.length?(a[s.get(".mid")]=s,delete a[i.get(".mid")]):!t&&r>0&&delete a[i.get(".mid")]
}else a[i.get(".mid")]=i}),a},Daria.MOPS._updateModelsAfterPin=function(e,t){var i=Daria.MOPS._getReplacementTreeAfterPin(e,t),n=Object.keys(i).map(function(e){return ns.Model.get("message",{ids:e})});return ns.Model.traverse("messages",function(e){"yes"===e.params.with_pins&&e.recalculateIndexesAfterPin(n,t)}),Vow.fulfill()}}(),Daria.MOPS.Opinfo=function(){this._adjust={},this._mid=[],this._tid=[],this._modelsCount=0},Daria.MOPS.Opinfo.prototype.addAdjust=function(e,t){this.hasAdjust()&&(this._adjust[e]=t)
},Daria.MOPS.Opinfo.prototype.addMid=function(e){this._mid.push(e)},Daria.MOPS.Opinfo.prototype.addTid=function(e){this._tid.push(e)},Daria.MOPS.Opinfo.prototype.checkFidAdjust=function(e,t){return this.hasAdjust()?this._adjust[t]!==e?(this.resetAdjust(),!1):!0:!1},Daria.MOPS.Opinfo.prototype.checkTidAdjust=function(e,t){if(!this.hasAdjust())return this._tid.push(t),!1;var i=0;for(var n in this._adjust)i+=this._adjust[n];return i!==e?(this.resetAdjust(),this._tid.push(t),this._mid=[],!1):!0},Daria.MOPS.Opinfo.prototype.getAdjust=function(){return this._adjust
},Daria.MOPS.Opinfo.prototype.getIds=function(){return{ids:this._mid,tids:this._tid}},Daria.MOPS.Opinfo.prototype.getModelsCount=function(){return this._modelsCount},Daria.MOPS.Opinfo.prototype.hasAdjust=function(){return Boolean(this._adjust)},Daria.MOPS.Opinfo.prototype.merge=function(e){if(this.hasAdjust())if(e.hasAdjust()){var t=e.getAdjust(),i=this.getAdjust();for(var n in t)n in i?i[n]+=t[n]:i[n]=t[n]}else this.resetAdjust();this._mid=this._mid.concat(e._mid),this._tid=this._tid.concat(e._tid)
},Daria.MOPS.Opinfo.prototype.resetAdjust=function(){this._adjust=null},Daria.MOPS.Opinfo.prototype.setModelsCount=function(e){this._modelsCount=e},Daria.MOPS.onMove=function(e,t){var i=t.current_folder,n=ns.Model.get("folders"),s=ns.Model.get("filters");1!==t.count||n.isFolder(i,"trash")||0!==s.getForFolder(i).length||_.contains(["archive","infolder"],t.originalAction)||ns.action.run("message.filter-move.show",{mid:t.ids.ids[0]||t.ids.tids[0],fid:i})},ns.events.on("daria:MOPS:move",Daria.MOPS.onMove),Daria.hkMOPS={},Daria.hkMOPS.doAction=function(e,t,i){return Daria.MOPS.updateHelper(e,t,i).then(function(){t.resetChecked()
})},Daria.hkMOPS.doUserDefinedAction=function(e,t){var i=ns.Model.get("messages-checked");if(i.getCount()>0)return void Daria.hkMOPS.doAction(e,i,t);var n,s=ns.Model.get("focus");if(s.isCurrentFocusOnMessage()){var a=s.getFocus();n=a.params.ids}else"message"===ns.page.current.page&&(n=ns.page.current.params.ids);n&&Daria.MOPS.doActionWithMessage(n,e,t)},Daria.hkMOPS.runReplyAction=function(e,t){t=_.extend({toolbar:!0},t);var i=ns.Model.get("messages-checked");if(i.getCount()>0)return t.mMessagesChecked=i,void ns.action.run(e,t);
var n;if("message"===ns.page.current.page&&(n=ns.page.current.params.ids))return t["message-id"]=n,void ns.action.run(e,t);var s=ns.Model.get("focus");if(s.isCurrentFocusOnMessage())if(n=s.getFocus().params.ids,"t"===n[0]){var a=Daria.MOPS.getFakeMessagesChecked(n);t.mMessagesChecked=a,ns.action.run(e,t),a.destroy()}else t["message-id"]=n,ns.action.run(e,t)},Daria.hkMOPS.toggleImportance=function(){var e=ns.Model.get("messages-checked"),t=ns.Model.get("labels").getImportantLID();e.getCount()>0?Daria.MOPS.updateHelper("label",e,{lid:t}):ns.page.go(ns.router.generateUrl("messages",{current_label:t}))
},Daria.hkMOPS.mark=function(){var e=ns.Model.get("messages-checked");if(e.getCount()>0)return void Daria.hkMOPS.doAction("mark",e);var t=ns.Model.get("focus");if(t.isCurrentFocusOnMessage()){var i=t.getFocus();Daria.MOPS.doActionWithMessage(i.params.ids,"mark")}},Daria.hkMOPS.unmark=function(){var e=ns.Model.get("messages-checked");e.getCount()>0?Daria.hkMOPS.doAction("unmark",e):"only_new"===ns.page.current.params.extra_cond?ns.events.trigger("daria:vMessages:recalculate"):ns.page.go("#unread")
},Daria.hkMOPS.remove=function(){var e=ns.Model.get("messages-checked");if(e.getCount()>0)return void Daria.hkMOPS.doAction("remove",e);var t=ns.Model.get("focus");t.isCurrentFocusOnMessage()&&Daria.MOPS.doActionWithMessage(t.getFocus().params.ids,"remove")},Daria.hkMOPS.triggerToolbarEvent=function(e,t){var i=0,n=ns.Model.get("messages-checked");if(0===n.getCount()&&t){i=200;var s=ns.Model.get("focus");if(s.isCurrentFocusOnMessage()){var a=s.getFocus().getModel("message");n.check(a,!0)}}setTimeout(function(){ns.events.trigger(e)
},i)},Daria.Printer={},Daria.Printer.PRINT_URL="/u2709/print.jsx",Daria.Printer.printMessage=function(e){var t=Daria.uid,i=window.location.origin+Daria.Printer.PRINT_URL+"?mid="+e+"&_uid="+t;window.open(i,"_blank")},Daria.Printer.printThread=function(e){var t=Daria.uid,i=window.location.origin+Daria.Printer.PRINT_URL+"?tid="+e+"&_uid="+t;window.open(i,"_blank")},Daria.bubblingQuote=function(e){e=e.replace(/^<meta[^>]*>/,"");var t=e.match(/<!--StartFragment-->(.*?)<!--EndFragment-->/);t&&(e=t[1]);
var i=document.createElement("div");i.innerHTML=e;for(var n,s=i;s;){if(1!==s.childNodes.length||!Jane.DOM.isBlockquote(s.firstChild)){if(s===i)break;if(s.getElementsByTagName("blockquote").length)break;for(n=i.firstChild.cloneNode(!1),n.removeAttribute("style");s.firstChild;)n.appendChild(s.firstChild);break}s=s.firstChild}return i=null,n?n.outerHTML:!1},function(){function e(e){return"only_new"==e.params.extra_cond}function t(e){return"yes"===e.params.search}Daria.messages={},Daria.messages.toCreateThread=function(e){return e.isThread()?!1:e.isDraftLike()?!1:Daria.Widgets.getWidgetName(e)?!1:!0
},Daria.messages.clearCacheByFID=function(e){ns.Model.invalidate("messages",function(t){return t.params.current_folder===e})},Daria.messages.clearCacheBodyByThread=function(e){$.makeArray(e).forEach(function(e){var t=ns.Model.get("messages",{thread_id:e});t&&t.models.length&&t.models.forEach(function(e){ns.Model.get("message-body",{ids:e.get(".mid")}).invalidate()})})},Daria.messages.clearCacheByLID=function(e){ns.Model.invalidate("messages",function(t){return t.params.current_label===e})},Daria.messages.clearSearchCache=function(){ns.Model.invalidate("messages",t)
},Daria.messages.preload=function(e){return},Daria.messages.everHadMessages=function(){var e=ns.Model.get("settings");if(e.getSetting("has_inbox_message"))return!0;var t=ns.Model.get("messages",ns.page.current.params);return t.isValid()?t.select('/.message[.type != "12" && .dlid != "yadisk"]').length?(e.setSettingOn("has_inbox_message"),!0):(Jane.c("Не показываем рекламу так как в инбоксе нет писем кроме приветственных"),!1):!1},Daria.messages.clearUnreadsList=function(){ns.Model.invalidate("messages",e)
},Daria.messages.whereToGoAfterMove=function(e,t,i){i=i||{};var n,s,a=i.ids||t.getIds(),o=a.ids.length?a.ids[0]:a.tids[0],r=ns.Model.get("message",{ids:o}),l=ns.Model.get("settings"),c=ns.Model.get("folders");switch(e){case"move":case"infolder":n=i.fid||i.folder;break;case"archive":s="archive";break;case"delete":case"remove":s="trash";break;case"tospam":s="spam";break;case"notspam":s="inbox"}var d="move";_.includes(["remove","delete","tospam","notspam"],e)&&(d="delete"),!n&&s&&(n=c.getFidBySymbol(s));
var u,h=[],m={},g=l.getSetting("page_after_"+d),p="";"compose"===ns.page.current.page&&"next_message"===g&&(g="source_folder"),Daria.is2pane()&&Daria.isMessagePage()&&(_.contains(["unmark"],e)?(g="dest_folder",n=r.getFolderId()||c.getFidBySymbol("inbox")):_.contains(["move"],e)&&i.fid&&"trash"===c.getFolderById(i.fid).symbol&&(d="delete")),Daria.is3pane()&&(g="current_list");var f;switch(g){case"current_list":if(Daria.is3pane()){var v=$.extend({},ns.page.current.params);i.ids&&(_.contains(i.ids.tids,v.thread_id)&&delete v.thread_id,_.contains(i.ids.ids,v.ids)&&delete v.ids),"delete"===d&&delete v.ids,v.current_folder=v.current_folder||c.getFidBySymbol("inbox"),p=ns.router.generateUrl("messages",v)
}else if("move"===d)p=ns.page.currentUrl,h.push("message","message-thread-nearest"),m.ids=o;else{var b=ns.page.history.getPrevious(),y=b&&ns.router(b);if(y&&"messages"===y.page){p=b;var M=ns.Model.info("messages").pNames,S=_.pick(y.params,function(e,t){return M.indexOf(t)>-1});_.extend(m,S),h.push("messages")}else f=r.getFolderId(),f||(f=c.getFidBySymbol("inbox")),p=ns.router.generateUrl("messages",{current_folder:f})}break;case"next_message":var D=ns.Model.get("message-nearest",{ids:o}).getNearestMessages(),w=D.prev&&D.prev.mid?D.prev:D.next;
w&&w.mid&&(p=ns.Model.get("message",{ids:w.mid}).getUrl()),p||(f=r.getFolderId(),f||(f=c.getFidBySymbol("inbox")),p=ns.router.generateUrl("messages",{current_folder:f}));break;case"inbox":u=c.getFidBySymbol("inbox");break;case"deleted_list":u=c.getFidBySymbol("tospam"===e||"notspam"===e?"spam":"trash");break;case"source_folder":u=r.getFolderId(),u||(u=c.getFidBySymbol("inbox"));break;case"dest_folder":u=n}return!p&&u&&(m.current_folder=u,h.push("messages"),p=ns.router.generateUrl("messages",{current_folder:u})),{where:p,requestParams:m,requestModels:h}
},Daria.messages.doActionInThreads=function(e,t,i){for(var n=0,s=t.length;s>n;n++)for(var a=t[n],o=ns.Model.get("messages",{thread_id:a}),r=0,l=o.models.length;l>r;r++)o.models[r][e](i)},Daria.messages._pinsBadFolders=["trash","draft","spam","template"],Daria.messages.checkUsePinsByParams=function(e){if("search"===e.search)return!1;if(e.current_label)return!1;if(e.extra_cond)return!1;if("rpopinfo"===e.scope)return!1;if(e.thread_id&&!e.current_folder)return!1;if(e.current_folder){var t=ns.Model.get("folders");
if(t.isFolder(e.current_folder,Daria.messages._pinsBadFolders))return!1}return!0},Daria.messages.canShowPinControlsByParams=function(e){if(e=e||ns.page.current.params,e.current_folder){var t=ns.Model.get("folders");if(t.isFolder(e.current_folder,Daria.messages._pinsBadFolders))return!1}return!0},Daria.messages.createMessagesItemLayout=function(e){e=e||{};var t="layout-messages-item";return e.threadFull?t+="-thread-full":e.threadInner&&(t+="-thread-inner"),e.widget&&(t+="-"+e.widget),t}}(),Daria.nsTreeWalker={},Daria.nsTreeWalker.findView=function(e,t){var i=e.info.isBox,n=null;
n=i?e.active:e.views;var s=t[0];for(var a in n)if(_.isString(s)&&a===s||_.isRegExp(s)&&s.test(a)){var o;if(i){var r=n[a];o=e.views[r]}else o=n[a];var l=t.slice(1);return l.length?Daria.nsTreeWalker.findView(o,l):o}return null},Daria.nsTreeWalker.getViewsChildren=function(e){var t=[];return e.forEachValidItem(function(e){t.push(e)}),t},Daria.nsTreeWalker.getTreeForFocus=function(){var e=Daria.nsTreeWalker._buildColumnTree([["left-box","folders"],["left-box","folders-setup"],["left-box","messages-filters","messages-filters-box","messages-filters-wait"],["left-box","messages-filters","messages-filters-box","messages-filters-important"],["left-box","messages-filters","messages-filters-box","messages-filters-unread"],["left-box","messages-filters","messages-filters-box","messages-filters-attachments"],["left-box","labels"],["left-box","labels-setup"],["left-box","collectors"],["left-box","collectors-setup"]]),t=Daria.nsTreeWalker._buildColumnTree([["right-box","messages-list","messages-list-box","messages-wrap","messages"],["right-box","message"],["right-box","search-suggest-box","search-suggest","search-suggest-items-box","history-suggest"],["right-box","search-suggest-box","search-suggest","search-suggest-items-box","abook-suggest"],["right-box","search-suggest-box","search-suggest","search-suggest-items-box","search-filters"]]),i=Daria.nsTreeWalker._buildColumnTree([["right-box","messages-box","message-thread","message-thread-list"],["right-box","messages-box","message"]]);
return[e,t,i]},Daria.nsTreeWalker._buildColumnTree=function(e){var t=e.map(Daria.nsTreeWalker._findViewByPath).map(Daria.nsTreeWalker._getViewFocusableChildren);return _.flatten(t)},Daria.nsTreeWalker._findViewByPath=function(e){return Daria.nsTreeWalker.findView(ns.MAIN_VIEW,e)},Daria.nsTreeWalker._getViewFocusableChildren=function(e){return e?(ns.assert(e.getFocusableChildren,"View: "+e.id,"Не реализован метод #getFocusableChildren()"),e.getFocusableChildren()):[]},function(){var e=/^[a-z]{2}$/,t={};
Daria.Translate={MAX_BLOCK_LEN:1e3,getCache:function(e){return t[e]},setCache:function(e,i){t[e]=i},clearCache:function(e){delete t[e]},langs:{ru:{s:["en","uk","tr","pl","de","fr","es","it"],name:"русский"},uk:{s:["ru"],name:"украинский"},en:{s:"RUS"==Daria.Config.product?["ru","tr"]:["tr","ru"],name:"английский"},tr:{s:"RUS"==Daria.Config.product?["ru","en"]:["en","ru"],name:"турецкий"},pl:{s:["ru"],name:"польский"},de:{s:["ru"],name:"немецкий"},fr:{s:["ru"],name:"французский"},es:{s:["ru"],name:"испанский"},it:{s:["ru"],name:"итальянский"},all:{s:["ru","uk","en","tr","pl","de","fr","es","it"],name:""}},id2lang:{1:"ru",2:"en",3:"pl",5:"uk",6:"de",7:"fr",12:"es",13:"it",39:"fi",40:"et",44:"tr"},getDefaultLangTo:function(e){return _.get(this.langs,e+".s.0",Daria.Config.locale)
},getLangByMid:function(t){var i=ns.Model.get("message-body",{ids:t}),n=_.get(i.getData(),"body.0.lang");return n?this.id2lang[n]?this.id2lang[n]:e.test(n)?n:void 0:void 0},defineLanguage:function(e){var t={uk:/[\u0491\u0457\u0456]/gi,ru:/[\u0430-\u044f\u0451]/gi,pl:/[\u0105\u0119\u0142]/gi,tr:/[\xe7\u011f\u015f]/gi,de:/[\xe4\xfc\xdf]/gi,es:/[\u0148\xf1]/gi,fr:/[\xe2\xe0\xe9\xea\xee\xf4\xf9\xfb\xff]/gi};if(/^(\d|\s)*$/.test(e))return Daria.Config.locale;for(var i in t)if(t[i].test(e))return i;return"en"
},translate:function(e,t,i){var n=Array.isArray(i)?i:[i],s={format:"html",lang:e+"-"+t},a=_.map(n,function(e){return"string"==typeof e&&(e={text:e}),{id:"do-translate",params:_.assign({},s,e)}});return new vow.Promise(function(e,t){ns.forcedRequest(a).then(function(i){var s=i.map(function(e){return e.get(".text")});s.length&&s.length==n.length?e(_.flatten(s)):t()}).fail(t)})}}}(),Daria.Shortcuts=function(e,t){var i={eventsBound:!1,altOS:0===navigator.platform.toLowerCase().indexOf("mac"),pageType:"",hotkeysEnabled:!1};
i.shortcuts=[{global:!0,name:"global",shortcuts:{Check_new_mail:{mask:"F9",altMask:"Shift+o",enableInInput:!i.altOS,action:"mailbox.check"},New_mail:{mask:"w, c",disableAt:["compose2"],handler:function(){ns.Model.get("settings").isSet("compose-in-window")?ns.Model.get("compose-sidebar-fsm").setState("edit"):ns.page.go(ns.router.generateUrl("compose2"))}},Goto_inbox:{mask:"Ctrl+i",altMask:"Meta+i",type:"hold",enableInInput:!0,handler:function(){ns.Model.get("focus").goInbox()}},Find:{mask:"/,?",type:"hold",handler:function(){ns.events.trigger("hotkeys.to-search-input")
}},Hotkeys_help:{mask:"Shift+?,Shift+comma,Shift+7,7",type:"hold",handler:function(){i.showShortcutsHelp()}},Column_left:{mask:"Left",type:"hold",disableAt:["compose2"],handler:function(){ns.Model.get("focus").changeColumn(!1)}},Column_right:{mask:"Right",type:"hold",disableAt:["compose2"],handler:function(){ns.Model.get("focus").changeColumn(!0)}},Goto_previous:{mask:"Up",type:"hold",handler:function(){e.Focus.moveItem(!1)},enableInInput:!0,namedInput:"js-allow-shortcuts"},Goto_next:{mask:"Down",type:"hold",handler:function(){e.Focus.moveItem(!0)
},enableInInput:!0,namedInput:"js-allow-shortcuts"},Print:{mask:"Shift+p",type:"hold",handler:function(){"message"===ns.page.current.page?ns.events.trigger("hotkeys.print"):ns.Model.get("focus").pubEvent("print")}},Set_mark:{mask:"Space",type:"down",handler:function(){ns.Model.get("focus").pubEvent("space")}},Collapse_folder:{type:"up",mask:"Enter",handler:function(){ns.Model.get("focus").pubEvent("enter")},enableInInput:!0,namedInput:"js-allow-shortcuts"},AlignBottom_Open_Message:{mask:"Ctrl+down",altMask:"Meta+down",type:"hold",handler:function(){var t=e.Shortcuts.verticalAlignOpenMessage({alignToTop:!1});
return!t}},AlignTop_Open_Message:{mask:"Ctrl+up",altMask:"Meta+up",type:"hold",handler:function(){var t=e.Shortcuts.verticalAlignOpenMessage({alignToTop:!0});return!t}}}},{name:"messages",shortcuts:{Labels_dialog:{mask:"l",handler:function(){e.hkMOPS.triggerToolbarEvent("daria:vLabelsActions:open",!0)}},Folders_dialog:{mask:"m",handler:function(){e.hkMOPS.triggerToolbarEvent("daria:vFoldersActions:open",!0)}},Label_important:{mask:"i",handler:function(){e.hkMOPS.toggleImportance()}},Label_read:{mask:"q",handler:function(){e.hkMOPS.mark()
}},Label_unread:{mask:"u",handler:function(){e.hkMOPS.unmark()}},Reply_all:{mask:"Shift+r",type:"hold",handler:function(){ns.page.current.params.thread_id?ns.events.trigger("daria:vMessageThreadReplyAll:replyAll"):ns.events.trigger("daria:vMessageToolbar:reply",{replyAll:!0,compose:"qr"})}},Select_all:{mask:"Ctrl+a",altMask:"Meta+a",type:"hold",handler:function(){ns.Model.get("messages-checked",ns.page.current.params).toggleSelectAll()}},Select_modifier:{mask:"Shift",handler:function(){ns.Model.get("focus").startKeyboardSelect()
}},Select_previous:{mask:"Shift+Up",type:"hold",handler:function(){ns.Model.get("focus").changeItem(!1,!0)}},Select_next:{mask:"Shift+Down",type:"hold",handler:function(){ns.Model.get("focus").changeItem(!0,!0)}},Goto_first:{mask:"Home",handler:function(){ns.Model.get("focus").focusToFirstMessage()}},Select_till_first:{mask:"Shift+Home",handler:function(){ns.Model.get("focus").focusToFirstMessage(!0)}},Goto_end:{mask:"End",handler:function(){ns.Model.get("focus").focusToLastMessage()}},Select_till_last:{mask:"Shift+End",handler:function(){ns.Model.get("focus").focusToLastMessage(!0)
}},Forward:{mask:"f",handler:function(){e.hkMOPS.runReplyAction("forward")}},Delete_selected:{mask:"Delete",altMask:"Meta+Backspace",type:"hold",handler:function(){e.hkMOPS.remove()}},Deselect:{mask:"Esc",enableInInput:!0,handler:function(t){var i="true"===t.target.getAttribute("contenteditable"),n="TEXTAREA"===t.target.nodeName,s=t.target===document.activeElement;return(i||n)&&s?void document.activeElement.blur():void(ns.Model.get("messages-checked").getCount()>0?ns.events.trigger("daria:vMessages:deselect"):e.is2pane()&&(ns.events.trigger("Daria:vMessages:closeWithShortcut"),ns.page.go(Jane.Page.generateUrl.closeMessage())))
}}}},{name:"message",shortcuts:{Goto_next:{mask:"n,k",handler:function(){ns.events.trigger("daria:vMessagePrevNextInMessage:changeMessage",{direction:"next"})}},Goto_previous:{mask:"p,j",handler:function(){ns.events.trigger("daria:vMessagePrevNextInMessage:changeMessage",{direction:"prev"})}},Delete:{mask:"Delete",altMask:"Meta+Backspace",handler:function(){var t=ns.page.current.params.ids;t&&e.MOPS.doActionWithMessage(t,"remove")}},Deselect:{mask:"Esc",enableInInput:!0,handler:function(e){var t="true"===e.target.getAttribute("contenteditable"),i="TEXTAREA"===e.target.nodeName,n=e.target===document.activeElement;
return(t||i)&&n?void document.activeElement.blur():void 0}},Reply_all_quick:{mask:"r",handler:function(){ns.events.trigger("daria:vMessageToolbar:reply",{compose:"qr",replyAll:!0})}},Reply_all:{mask:"Shift+r",type:"hold",handler:function(){ns.events.trigger("daria:vMessageToolbar:reply",{compose:"full",replyAll:!0}),ns.events.trigger("daria:shortcuts:replyall")}},Reply_quick:{mask:"e",handler:function(){ns.events.trigger("daria:vMessageToolbar:reply",{compose:"qr"})}},Reply:{mask:"Shift+e",handler:function(){ns.events.trigger("daria:vMessageToolbar:reply",{compose:"full"})
}},Forward:{mask:"Shift+f",handler:function(){e.hkMOPS.runReplyAction("forward")}},Labels_dialog:{mask:"Shift+l",handler:function(){e.hkMOPS.triggerToolbarEvent("daria:vLabelsActions:open")}},Folders_dialog:{mask:"Shift+m",handler:function(){e.hkMOPS.triggerToolbarEvent("daria:vFoldersActions:open")}},Label_unread:{mask:"Shift+u",handler:function(){var t=ns.page.current.params.ids;t&&e.MOPS.doActionWithMessage(t,"unmark")}},Label_spam:{mask:"Shift+s",handler:function(){var t=ns.page.current.params.ids;
if(t){var i=ns.Model.get("message",{ids:t}),n=i.isSpam()?"notspam":"tospam";e.MOPS.doActionWithMessage(t,n)}}},Label_important:{mask:"Shift+i",handler:function(){var t=ns.page.current.params.ids;if(t){var i=ns.Model.get("labels").getImportantLID();e.MOPS.doActionWithMessage(t,"label",{lid:i})}}},Attachments_save:{mask:"Ctrl+s",altMask:"Meta+s",type:"hold",handler:function(){ns.events.trigger("daria:vAttachmentsWidgetBody:downloadAttachments")}}}},{name:"compose2",shortcuts:{Save_draft:{mask:"Ctrl+s",altMask:"Meta+s",type:"hold",enableInInput:!0,handler:function(){ns.events.trigger("daria:vCompose2:save")
}},Send:{mask:"Ctrl+Enter",altMask:"Meta+Enter",type:"hold",enableInInput:!0,handler:function(){ns.events.trigger("daria:vCompose2:send")}}}},{name:"context-menu",shortcuts:{Context_menu_cancel:{mask:"Esc",enableInInput:!0,handler:function(){e.ContextMenu.close()}}}},{name:"dialog",shortcuts:{Dialog_cancel:{mask:"Esc",enableInInput:!0,handler:function(){e.Dialog.cancel()}}}},{name:"finder",shortcuts:{Finder_close:{mask:"Esc",handler:function(){ns.events.trigger("daria:vBrowseDisk:close")}}}},{name:"video-player",shortcuts:{Videoplayer_cancel:{mask:"Esc",handler:function(){e.VideoPlayer.close()
}}}},{name:"image-viewer",shortcuts:{Image_viewer_close:{mask:"Esc",enableInInput:!0,handler:function(){e.Layer.close()}},Image_viewer_next:{mask:"Right",handler:function(){var t=e.ImageViewer;t.isGalleryOpen()?t.scrollGallery(1):t.next()}},Image_viewer_prev:{mask:"Left",handler:function(){var t=e.ImageViewer;t.isGalleryOpen()?t.scrollGallery(-1):t.prev()}}}},{name:"themes-selector",shortcuts:{Themes_selector_close:{mask:"Esc",enableInInput:!0,handler:function(e){var t="INPUT"===e.target.nodeName.toUpperCase();
t||ns.events.trigger("Daria:vThemesSelector:close")}}}},{name:"abook",shortcuts:{Abook_select_all:{mask:"Ctrl+a",altMask:"Meta+a",type:"hold",handler:function(){ns.events.trigger("daria:vAbookHead.selectAll")}},Abook_deselect_all:{mask:"Esc",enableInInput:!0,handler:function(){ns.events.trigger("daria:vAbookHead.deselectAll")}}}}];for(var n,s={Archive:{mask:"a",handler:function(){e.userToolbar.isButtonActivated("archive")&&e.hkMOPS.doUserDefinedAction("archive")}},Sendon:{mask:"Alt+f",handler:function(){if(e.userToolbar.isButtonActivated("sendon")){var t=e.userToolbar.get("sendon").settings;
e.hkMOPS.runReplyAction("sendon",t)}}},Infolder:{mask:"Alt+m",handler:function(){if(e.userToolbar.isButtonActivated("infolder")){var t=e.userToolbar.get("infolder").settings;e.hkMOPS.doUserDefinedAction("infolder",t)}}},Defined_label:{mask:"Alt+l",handler:function(){if(e.userToolbar.isButtonActivated("label")){var t=e.userToolbar.get("label").settings;e.hkMOPS.doUserDefinedAction("label",t)}}},Defined_reply:{mask:"Alt+r",handler:function(){var t=ns.Model.get("folders").isIncoming(ns.page.current.params.current_folder);
if(t&&e.userToolbar.isButtonActivated("template")){var i=e.userToolbar.get("template").settings;e.hkMOPS.runReplyAction("reply-tmpl",i)}}}},a=i.shortcuts.length-1;a>=0;a--)n=i.shortcuts[a],("messages"==n.name||"message"==n.name)&&t.extend(n.shortcuts,s);return i.help=[{title:"Общие",id:"global",hotkeys:[{title:"Проверить почту",id:"Check_new_mail"},{title:"Написать письмо",id:"New_mail"},{title:"Перейти во «Входящие»",id:"Goto_inbox"},{title:"Распечатать",id:"Print"},{title:"Поиск",key:"/"},{title:"Помощь по горячим клавишам",key:"?"},{title:"Перемещение между колонками",key:"←|→"},{title:"Перемещение по папкам и меткам",key:"↑|↓"},{title:"Свернуть/развернуть список папок",key:"Space"}]},{title:"Список писем",id:"messages",hotkeys:[{title:"Предыдущее/следующее письмо",key:"↑|↓"},{title:"Открыть/закрыть письмо/обсуждение",key:"Enter"},{title:"Выделить письмо/снять выделение",key:"Space"},{title:"Выделить письма/снять выделение",key:"Shift + ↑|↓"},{title:"Выделить все письма",id:"Select_all"},{title:"Пометить выбранные письма",id:"Labels_dialog"},{title:"Переложить в папку выбранные письма",id:"Folders_dialog"},{title:"Пометить выбранные письма прочитанными",id:"Label_read"},{title:"Пометить выбранные письма непрочитанными",id:"Label_unread"},{title:"Переслать выбранные письма",id:"Forward"},{title:"Пометить выбранные письма как важные",id:"Label_important"},{title:"Удалить выбранные письма",id:"Delete_selected"},{title:"Показать важные",id:"Label_important"},{title:"Показать непрочитанные",id:"Label_unread"}]},{title:"Чтение письма",id:"message",hotkeys:[{title:"Пометить письмо непрочитанным",id:"Label_unread"},{title:"Пометить письмо как спам/не спам",id:"Label_spam"},{title:"Пометить письмо как важное/не важное",id:"Label_important"},{title:"Пометить письмо",id:"Labels_dialog"},{title:"Переложить письмо в папку",id:"Folders_dialog"},{title:"Переслать письмо",id:"Forward"},{title:"Ответить",id:"Reply"},{title:"Ответить всем",id:"Reply_all"},{title:"Удалить",id:"Delete"},{title:"Сохранить вложения в виде архива",id:"Attachments_save"},{title:"Предыдущее/следующее письмо",key:"p/n | j/k"}]},{title:"Написание письма",id:"compose2",hotkeys:[{title:"Отправить письмо",id:"Send"},{title:"Сохранить как черновик",id:"Save_draft"}]},{title:"Персональные кнопки",id:"personal",hotkeys:[{title:"Архивировать",key:"a"},{title:"Переслать указанному получателю",key:"Alt + f"},{title:"Переложить в папку, выбранную заранее",key:"Alt + m"},{title:"Поставить метку",key:"Alt + l"},{title:"Ответить на письмо заданным текстом",key:"Alt + r"}]}],e.Focus={},e.Focus.VALUE_LAZY_SCROLL=100,e.Focus.getScroller=function(){var e,t=ns.Model.get("focus").getIndexCurrentColumn();
switch(t){case 0:e=ns.Model.get("scroller-left");break;case 1:e=ns.Model.get("scroller-messages");break;case 2:e=ns.Model.get("scroller-message")}return e},e.Focus.scrollIntoView=function(t){var i=ns.Model.get("skin-saver-state");if(!i.isPreviewMode()){var n=e.Focus.getScroller(),s=n.getScrollOffset()+2,a=n.getScrollTop(),o=n.getNodeTop(t[0]),r=o-s,l=a-r;if(l>0)return e.DEBUG&&console.log("[Focus.scrollIntoView]","nodeTop behind scrollnodeTop"),void n.setScrollTop(a-l);var c=n.getHeight(),d=a+c,u=o+t.height(),h=u+s,m=h-d;
if(m>0){e.DEBUG&&console.log("[Focus.scrollIntoView]","nodeBottom behind scrollBottom");var g=a+m;g>=o?(e.DEBUG&&console.log("[Focus.scrollIntoView]","collision, nodeTop behind scrollTop, scroll to nodeTop"),n.setScrollTop(o-s)):n.setScrollTop(a+m)}}},e.Focus.needLazyScroll=function(t,i){switch(t.id){case"message-thread-item-wrap":if(!t.getModel("state-message-thread-item").isOpen())return!1;break;case"message-thread":if(t.getModel("messages").getCount()>1)return!1;break;case"message":break;default:return!1
}var n=e.Focus.getScroller(),s=n.getNodeTop(t.node),a=s+t.$node.height(),o=n.getScrollTop(),r=o+n.getHeight();return i?a>r:o>s},e.Focus.lazyScroll=function(t){var i=e.Focus.getScroller(),n=i.getScrollTop();t?n+=e.Focus.VALUE_LAZY_SCROLL:n-=e.Focus.VALUE_LAZY_SCROLL,i.setScrollTop(n)},e.Focus.moveItem=function(t){var i=ns.Model.get("focus"),n=i.getIndexCurrentColumn();"message"===ns.page.current.page&&n!==i.indexColumns.LEFT?e.Focus.lazyScroll(t):i.changeItem(t)},ns.events.on("toggleShortcuts",function(e,t){i.toggleHotkeys(t)
}),ns.events.on("pageinit",function(){i.toggleHotkeys(ns.Model.get("settings").getSetting("enable_hotkeys")),ns.events.trigger("daria:hotkeys:inited")}),ns.events.on("ns-page-after-load",function(){return i.pageType!=ns.page.current.page?(i.pageType=ns.page.current.page,i.eventsBound?void(i.hotkeysEnabled&&(t.Shortcuts.switchList(i.pageType),t.Shortcuts.refresh(i.pageType))):!1):void 0}),i.toggleHotkeys=function(n){e.Shortcuts.hotkeysEnabled=i.hotkeysEnabled={on:!0,off:!1,"true":!0,"false":!1}[n],i.hotkeysEnabled?(i.eventsBound||i.bindLists(i.pageType),t.Shortcuts.start()):t.Shortcuts.stop()
},i.bindLists=function(e){for(var n=i.shortcuts.length-1;n>=0;n--)t.Shortcuts.loadList(i.shortcuts[n],i.altOS);t.Shortcuts.enableList(e),i.eventsBound=!0},i._getShortcutMask=function(e,t){for(var n=i.shortcuts.length-1;n>=0;n--)if(i.shortcuts[n].name===t){var s=i.shortcuts[n];if(s.shortcuts.hasOwnProperty(e))return i.altOS&&s.shortcuts[e].altMask?s.shortcuts[e].altMask:s.shortcuts[e].mask}return""},i.showShortcutsHelp=function(){for(var n=i.help.length-1;n>=0;n--)for(var s=i.help[n],a=s.hotkeys.length-1;a>=0;a--)if("undefined"!=typeof s.hotkeys[a].id){var o=i._getShortcutMask(s.hotkeys[a].id,s.id);
o&&(s.hotkeys[a].key=o.replace(/Meta/g,"Cmd").replace(/\+/g," + "))}e.Dialog.open({title:"Список горячих клавиш всегда можно посмотреть, нажав «<b>?</b>» на клавиатуре",additionalClass:"b-shortcuts-list__popup",width:900,body:Jane.tt("mail:shortcuts-list",{columns:i.help}),onopen:function(){t(document).on("keydown.shortcutsPopup",function(e){if(9===e.which){"undefined"==typeof i.popupActiveTab&&(i.popupActiveTab=0);var n=t(".b-shortcuts-list__item"),s=i.popupActiveTab+1;return s>=n.length&&(s=0),t(".b-shortcuts__list-id-"+i.popupActiveTab).addClass("g-hidden"),t(".b-shortcuts__list-id-"+s).removeClass("g-hidden"),t(n[i.popupActiveTab]).removeClass("b-shortcuts-list__item_current"),t(n[s]).addClass("b-shortcuts-list__item_current"),i.popupActiveTab=s,!1
}})},onclose:function(){t(document).off("keydown.shortcutsPopup"),i.popupActiveTab=0}})},i.switchTab=function(e){"undefined"==typeof i.popupActiveTab&&(i.popupActiveTab=0),t(".b-shortcuts__list-id-"+i.popupActiveTab).addClass("g-hidden"),t(".b-shortcuts__list-id-"+e.params.tab).removeClass("g-hidden"),t(".b-shortcuts-list__item").removeClass("b-shortcuts-list__item_current"),t(e.event.currentTarget).addClass("b-shortcuts-list__item_current"),i.popupActiveTab=parseInt(e.params.tab,10)},i.getShortcutLabelFor=function(e,t,n){var s=i._getShortcutMask(e,t).replace(/Meta/g,"Cmd").replace(/\+/g," + ");
return n?" ("+s+")":s},i.verticalAlignOpenMessage=function(t){var i=ns.page.current.params.thread_id||ns.page.current.params.ids,n="message"===ns.page.current.page;if(!i||n)return!1;var s,a=e.is2pane();s=ns.Model.get(a?"scroller-messages":"scroller-message");var o={alignToTop:t.alignToTop,relative:s.isRelativeOffset()};return t.alignToTop?o.viewTopOffset=a?-s.FIXED_TOOLBAR_HEIGHT:-s.getScrollOffset():o.viewBottomOffset=a?-ns.Model.get("timeline-state").get(".height"):0,ns.events.trigger("hotkeys.alignOpenMessage",{scroller:s,alignOptions:o}),!0
},e.ShortcutsPromo=function(e,t){var i={params:{},promoActive:!1,sentWithShortcuts:!1,altOS:0===navigator.platform.toLowerCase().indexOf("mac")};i.promoBubbleParams={Label_unread:{hotkey1:"U",hotkey2:"",title:"чтобы быстро перейти к непрочитанным письмам",promoTitleStart:"В следующий раз нажмите",code:"b"},Label_important:{hotkey1:"I",hotkey2:"",title:"чтобы быстро перейти к важным письмам",promoTitleStart:"В следующий раз нажмите",code:"c"},Save_draft:{hotkey1:"Ctrl",hotkey2:"S",code:"a",title:"чтобы сохранить письмо в процессе написания",promoTitleStart:"В следующий раз нажмите"},Folders_dialog:{hotkey1:"M",hotkey2:"",code:"d",title:"чтобы переместить письма между папками",promoTitleStart:"В следующий раз нажмите"},Labels_dialog:{hotkey1:"L",hotkey2:"",code:"e",title:"чтобы пометить",promoTitleStart:"В следующий раз нажмите"},Mark_read:{hotkey1:"Q",hotkey2:"",code:"f",title:"чтобы отметить письмо прочитанным",promoTitleStart:"В следующий раз нажмите"},Mark_unread:{hotkey1:"U",hotkey2:"",code:"g",title:"чтобы отметить письмо непрочитанным",promoTitleStart:"В следующий раз нажмите"},Goto_next:{hotkey1:"N / K",title:"чтобы перейти к следующему письму",promoTitleStart:"В следующий раз нажмите",code:"h"},Goto_previous:{hotkey1:"P / J",title:"чтобы перейти к предыдущему письму",promoTitleStart:"В следующий раз нажмите",code:"i"},"reply-all":{hotkey1:"Shift",hotkey2:"R",code:"o",title:"чтобы ответить на письмо сразу всем получателям",promoTitleStart:"В следующий раз нажмите"},reply:{hotkey1:"Shift",hotkey2:"E",code:"j",title:"чтобы ответить на письмо",promoTitleStart:"В следующий раз нажмите"},"quick-reply.reply":{hotkey1:"Shift",hotkey2:"E",code:"m",title:"чтобы ответить на письмо",promoTitleStart:"В следующий раз нажмите"},"quick-reply.reply-all":{hotkey1:"Shift",hotkey2:"R",code:"l",title:"чтобы ответить на письмо сразу всем получателям",promoTitleStart:"В следующий раз нажмите"},"quick-reply.save":{hotkey1:"Ctrl",hotkey2:"S",code:"k",title:"чтобы сохранить письмо в процессе написания",promoTitleStart:"В следующий раз нажмите"},"messages-check":{hotkey1:"Shift",hotkey2:"&#8595;",code:"n",title:"чтобы выделить несколько писем",promoTitleStart:"В следующий раз нажмите",notimeout:!0}},i.metrika=function(){var i=["hot-keys"];
t.merge(i,arguments),e.DEBUG&&console.log("@metrika promotion hotkeys -> ",i),Jane.c(i)},i.readPromoData=function(){i.params={done:i.parseUrlParams(ns.Model.get("settings").getSetting("hk_promo_done")),bubble:i.parseUrlParams(ns.Model.get("settings").getSetting("hk_promo_bubble")),stickyline:i.parseUrlParams(ns.Model.get("settings").getSetting("hk_promo_stickyline"))},i.params.bubble.lastTS+3*Jane.Date.MONTH<13955184e5&&(i.params.bubble={count:0,lastTS:1})},i.parseUrlParams=function(e){var t={};if("undefined"==typeof e||""===e)return{};
e=e.replace(/&amp;/g,"&").split("&");for(var i,n,s,a=0;a<e.length;a+=1)i=e[a].split("="),n=i[0],s=i[1],t[n]=isNaN(s)?s:parseInt(s,10);return t};var n=i.nDaysPassed=function(t,i){return i="undefined"!=typeof i?i:1,"undefined"==typeof t?!0:t+864e5*i<e.now()||!1};return i.nWeeksPassed=function(e,t){return t="undefined"!=typeof t?t:1,"undefined"==typeof e?!0:n(e,7*t)},i.isShowed=function(e){var t=i.params.bubble.codes||"";return e?t.indexOf(e)>-1:!0},i.isLess=function(e,t){return"undefined"!=typeof e&&t>e||!1
},i.doWeNeedToShowPromo=function(t,n){if("done"!==t)return!1;if(i.readPromoData(),"undefined"==typeof i.params[t])return!0;var s,a;if(i.promoActive&&i.promoActive!==t||e.IS_KCUF||!e.Shortcuts.hotkeysEnabled)return!1;switch(t){case"done":return"done"===i.promoActive?!0:(s=i.isLess(i.params.done.count||0,7),a=i.nDaysPassed(i.params.done.lastTS),!0);case"bubble":return i.setBubbleHowUnshown(),a=i.nDaysPassed(i.params.bubble.lastTS),s=!i.isShowed(n&&n.code),"done"===ns.page.current.page?!1:s&&a;case"stickyline":return e.getCookie("hide-browser-updater")?i.params.bubble.lastTS?!1:(s=i.isLess(i.params.stickyline.count||0,1),a=i.nWeeksPassed(i.params.stickyline.lastTS),s&&a):!1
}return!1},i.setBubbleHowUnshown=function(){i.params&&i.params.bubble&&(i.params.bubble.codes=String(i.params.bubble.codes||""),i.params.bubble.count=Number(i.params.bubble.count||0),t.each(i.params.bubble,function(t,n){1===t.length&&n<e.now()&&(delete i.params.bubble[t],i.params.bubble.codes=i.params.bubble.codes.replace(t,""),i.params.bubble.count>0&&(i.params.bubble.count-=1))}))},i.showStatuslineAfterBubble=function(){var t=Jane.tt("mail:shortcuts-stickyline-after-bubble",{}),n="Статус-лайн после баблов";
i.promoActive=!0,i.metrika(n,"показ"),e.Statusline.showMsg({name:"hotkeysPromoStatusline",body:t,blocker:!0,blockerCanBeClosed:!0,hideOnTimeout:0,onclose:function(){i.metrika(n,"клик по крестику"),i.removeStickyPromo()},onclick:function(){return i.metrika(n,"клик"),!1}}),ns.events.trigger("hotkeys-promo-save",{type:"bubble",code:"p"})},i.showStatuslinePromo=function(){var n=Jane.tt("mail:shortcuts-stickyline",{}),s="Статус-лайн";i.promoActive=!0,i.metrika(s,"показ"),e.Statusline.showMsg({name:"hotkeysPromoStatusline",body:n,blocker:!0,blockerCanBeClosed:!0,hideOnTimeout:0,onclose:function(){i.metrika(s,"клик по крестику"),i.removeStickyPromo()
},onclick:function(){return!1}}),t.Shortcuts.modalListOff("promo"),ns.events.trigger("hotkeys-promo-save",{type:"stickyline"})},i.removeStickyPromo=function(){e.Statusline.hide("hotkeysPromoStickyline"),t.Shortcuts.modalListOff("promo")},i.addRestartBubblesTime=function(e,n){var s=i.params.bubble;s[e]=n,ns.Model.get("settings").setSettings({hk_promo_bubble:t.param(s)})},i.showBubblePromo=function(n){var s,a=n.promoTitleStart||"В следующий раз нажмите",o={promoTitleStart:a,promoKey1:n.hotkey1,promoKey2:n.hotkey2,promoTitleEnd:n.title?n.title:"чтобы выделить несколько писем"},r="Бабл";
i.altOS&&(o.promoKey1=o.promoKey1.replace(/Ctrl/g,"Cmd"),o.promoTitleEnd=o.promoTitleEnd.replace(/Ctrl/g,"Cmd")),i.promoActive=!0,s=e.Dialog.open({additionalClass:"b-shortcuts-promo__popup",body:Jane.tt("mail:shortcuts-bubble",{params:o}),noPosition:!0,noShortcuts:!0,onTarget:{noTail:!0},onopen:function(){var s=i.params.bubble.codes||"";s=s.length+1,i.metrika(r,"показ",s?"Номер "+s:s),this._bind(),t(".b-shortcuts-promo__popup").css({position:"fixed",bottom:0,right:400,top:"auto",left:"auto",width:"300px"}),i.addRestartBubblesTime(n.code,e.now()+3*Jane.Date.MONTH)
},oncancel:function(){i.addRestartBubblesTime(n.code,e.now()+6*Jane.Date.MONTH),i.metrika(r,"клик по крестику")},onclose:function(){s&&s.params&&s.params._unbind&&s.params._unbind()},onHelpLinkClick:function(){i.metrika(r,"клик по ссылке")},_onDialogClick:function(e){var i=e.target,n=t(i).attr("data-dialog-event");return s&&s.params&&s.params[n]&&s.params[n](e),!0},_bind:function(){var t=e.Dialog.$dialog;t.on("click",this._onDialogClick)},_unbind:function(){s.$dialog.off("click",this._onDialogClick)
}}),ns.events.trigger("hotkeys-promo-save",{type:"bubble",code:n.code})},i.showDonePromo=function(){i.metrika("Done","показ"),i.sentWithShortcuts=!1,ns.events.trigger("hotkeys-promo-save",{type:"done"}),i.promoActive="done"},i.hideDonePromo=function(){i.promoActive=!1},ns.action.define("trigger-hotkeys-promo-bubble",function(e,n,s,a){var o,r={event:a,params:n},l=i.promoBubbleParams[r.params.eventName]||{};i.doWeNeedToShowPromo("bubble",l)&&(t.Shortcuts.modalListOff("promo"),l.notimeout?i.showBubblePromo(l):setTimeout(function(){i.showBubblePromo(l)
},10)),o=i.params&&i.params.bubble&&i.params.bubble.codes,o&&o.length>11&&-1===o.indexOf("p")&&i.showStatuslineAfterBubble()}),ns.action.define("trigger-hotkeys-stickyline",function(){i.doWeNeedToShowPromo("stickyline")&&i.showStatuslinePromo()}),ns.events.on("hotkeys-promo-save",function(n,s){var a=s.type||"done";"undefined"==typeof i.params[a]&&(i.params[a]={});var o=i.params[a].codes||"",r={};"bubble"===a&&t.each(i.params.bubble,function(e,t){1===e.length&&(r[e]=t)});var l=i.params[a]={count:"undefined"!=typeof i.params[a].count?parseInt(i.params[a].count,10)+1:1,lastTS:e.now()};
"bubble"===a&&(l.codes=o,s.code&&(l.codes+=s.code),t.extend(l,r));var c={};c["hk_promo_"+a]=t.param(l),ns.Model.get("settings").setSettings(c)}),ns.action.define("hotkeys-promo-reset",function(){ns.Model.get("settings").setSettings({hk_promo_stickyline:"count=0&lastTS=1",hk_promo_bubble:"count=0&lastTS=1",hk_promo_done:"count=0&lastTS=1"})}),ns.action.define("show-hotkeys-list",function(t){t.params&&"stickyline"===t.params.type&&i.metrika("Статус-лайн","клик по ссылке"),t.params&&"done"===t.params.type&&i.metrika("Done","клик на вопрос"),i.removeStickyPromo(),e.Shortcuts.showShortcutsHelp()
}),ns.action.define("trigger-hotkey-pressed",function(e){var t=["Использовали хоткей"];i.hotkeyWasPressed||(i.hotkeyWasPressed=!0,e.params&&e.params.shortcut&&e.params.shortcut.mask&&t.push(e.params.shortcut.mask),Jane.ErrorLog.send({event:"hotkey-promo",data:t.join("|")}))}),ns.action.define("hotkeys-promo-sent-with-shortcuts",function(){i.sentWithShortcuts=!0}),{doWeNeedToShowPromo:i.doWeNeedToShowPromo,removePromos:i.removeStickyPromo,showDonePromo:i.showDonePromo,hideDonePromo:i.hideDonePromo}
}(e,jQuery),{showShortcutsHelp:i.showShortcutsHelp,switchTab:i.switchTab,hotkeysEnabled:i.hotkeysEnabled,getShortcutLabelFor:i.getShortcutLabelFor,verticalAlignOpenMessage:i.verticalAlignOpenMessage}}(Daria,jQuery),Daria.Sticky=function(e){this._$node=e,this._$target=e.children(),this._init()},Daria.Sticky.prototype._init=function(){$(window).on("scroll.daria-sticky",_.debounce(this._recalcOnScroll.bind(this),10)),$(window).on("resize.daria-sticky",_.debounce(this._recalcOnResize.bind(this),10)),this._$window=$(window),this._$document=$(document),this._lazyRecalcLayout=_.debounce(this._recalcOnResize.bind(this),1e3,{leading:!0,trailing:!1}),this._recalcOnScroll()
},Daria.Sticky.prototype.destroy=function(){$(window).off(".daria-sticky"),this._$target.css({top:"",bottom:"",left:"",width:""})},Daria.Sticky.prototype._recalcOnScroll=function(){this._lazyRecalcLayout(),this._recalcSticky()},Daria.Sticky.prototype._recalcOnResize=function(){this._recalcLayout(),this._recalcSticky()},Daria.Sticky.prototype._recalcLayout=function(){console.log("Daria.Sticky","_recalcLayout"),this._windowWidth=this._$window.width()},Daria.Sticky.prototype._recalcSticky=function(){var e=this._$node,t=this._$target,i=this._$window.scrollTop(),n=Math.max(this._$window.scrollLeft(),0),s=e.offset(),a=s.top,o=Math.min(Math.max(a-i,0),a),r=s.left-n,l=e.width();
e.addClass("is-fixed"),t.css({top:o,bottom:0,left:r,width:l})},Daria.upicUploader={upload:function(e,t){var i=$(e);this.$upicUploadForm?this.$upicUploadForm.empty():this.$upicUploadForm=$('<form class="g-hidden" method="post" enctype="multipart/form-data" action="/"></form>').appendTo(document.body);var n={service:"mail",token:Daria.Config["avatar-token"]};ns.request.addRequestParams(n);var s=Daria.handlersPrefix+"/upload.jsx";if(e){var a=i.clone().change(function(){Daria.upicUploader.upload(this,t)
}).val("");i.replaceWith(a),this.$upicUploadForm.append(i),i.unbind()}else s+="?clear=yes";Daria.Libs("jQuery.Form",function(){this.$upicUploadForm.ajaxSubmit({iframe:!0,data:n,dataType:"text",url:s,complete:function(e,i){return"success"!==i?void Daria.Statusline.showMsg({body:"Произошла ошибка"}):(ns.forcedRequest("social-profiles-reset",{emails:ns.Model.get("settings").getSetting("default_email")}),void t.apply(null,arguments))}})}.bind(this))}},Daria.Widgets={},Daria.Widgets.getWidgetName=function(e){return Daria.Widgets._commonChecks(e)?Daria.Widgets.shouldShowTaksaWidgets(e)?"widget":Daria.Widgets.shouldShowEvents(e)?"events":"":""
},Daria.Widgets._commonChecks=function(e){var t=ns.Model.get("settings");if(t.isCompactMode())return!1;var i=ns.Model.get("folders");return i.spamOrTrash(e.getFolderId())?!1:!0},Daria.Widgets.shouldShowTaksaWidgets=function(e){if(!Boolean(e.get(".widget")))return!1;var t="ru"===Daria.Config.locale&&!Daria.is3pane()&&!Daria.IS_CORP,i=_.includes(["avia","hotels","pkpass"],e.get(".widget.info.type")),n=!ns.Model.get("settings").getSetting("disable_etickets");return i?t&&n:t},Daria.Widgets.shouldShowEvents=function(e){return Daria.IS_CORP&&!Daria.is3pane()&&!ns.Model.get("settings").isSet("disable_events")&&e.hasType(42)
},Daria.Widgets.shouldShowAttachments=function(e,t){if(t=t||{},Daria.is2pane()&&e.hasAttachment()){var i="only_atta"===t.extra_cond||t.search&&"yes"===t.attaches,n=ns.Model.get("settings");if(n.isCompactMode()&&!i)return!1;if(!n.isSet("disable_inboxattachs")||i){var s;if(s=i||e.isIntoThread()?["spam","template","trash"]:["draft","sent","spam","template","trash"],e.inFolderBySymbol(s))return!1;if(i)return!0;if("yacal"===e.getSocialLabel())return!1;if(Daria.IS_CORP)return!0;var a=e.getSOLabels();if(_.contains(a,4)||_.contains(a,24))return!0
}}return!1},Daria.PromoBar=function(e,t,i){e&&Daria.loadPromoModule(function(){this.init(t||"base",i)}.bind(this))},Daria.PromoBar.namespace="alias-promo",Daria.PromoBar.getSetting=function(e){return ns.Model.get("settings").getMultiSetting(Daria.PromoBar.namespace)[e]},Daria.queueCommon={},Daria.queueCommon.CONNECTIONS_MAX=2,Daria.queueCommon.MODELS_MAX=5,Daria.queueCommon.TIMEOUT_BETWEEN_REQUESTS=0,Daria.queueCommon._queue=null,Daria.queueCommon._poolCnt=0,Daria.queueCommon.reset=function(){this._poolCnt=0,this._queue=[]
},Daria.queueCommon.add=function(e){this._queue=this._queue.concat(e),this.run()},Daria.queueCommon.run=function(){if(!(this._poolCnt>=this.CONNECTIONS_MAX)){var e=this._queue.splice(0,this.MODELS_MAX);e.length&&(this.request(e).always(function(){this._poolCnt--,setTimeout(this.run.bind(this),this.TIMEOUT_BETWEEN_REQUESTS)}.bind(this)),this._poolCnt++,this.run())}},Daria.queueCommon.request=function(e){return ns.request(e)},Daria.preloadQueue={},no.extend(Daria.preloadQueue,Daria.queueCommon),Daria.preloadQueue.CONNECTIONS_MAX=1,Daria.preloadQueue.MODELS_MAX=5,Daria.preloadQueue.TIMEOUT_BETWEEN_REQUESTS=500,Daria.preloadQueue.reset(),Daria.MessagesSearch={},Daria.MessagesSearch.generateId=function(){var e=Math.random().toString().substr(2);
return Jane.watcher.set("search.next-id",e),e},Daria.MessagesSearch.search=function(e,t){Daria.MessagesSearch.generateId();var i,n=ns.Model.get("settings"),s=ns.Model.get("search-view");t=t||{},e=_.clone(e),Jane.watcher.set("search.state",!0),s.setIfChanged(".simplifiedRequest",""),n.trigger("search.state:changed"),Daria.MessagesSearch._logSuggest(e.request),""===e.request&&delete e.request,_.isEmpty(e)?(i=t.searchOptionsOpened?ns.router.generateUrl("search"):ns.page.HOME_HASH,Jane.watcher.set("search.is-empty-search",!0)):(e.search="search",i=ns.router.generateUrl("messages",e));
var a,o=e&&e.request&&("from"in e||"fid"in e||"lid"in e||"scope"in e||"unread"in e||"attaches"in e||"type"in e);if(o){var r=ns.Model.get("messages",e);a=ns.request([r]).then(function(){return 0===r.get(".message").length&&(i=ns.router.generateUrl("messages",{search:"search",request:e.request}),s.setIfChanged(".simplifiedRequest",e.request)),ns.page.go(i)})}else a=ns.page.go(i);a.then(this._onSuccess.bind(this,t,e),this._onError.bind(this,t)).always(function(){Jane.watcher.set("search.state",!1),n.trigger("search.state:changed"),n.isSet("dont_save_history")||Daria.Autocompleter.getSearch().flushCache(),Jane.watcher.set("search.is-empty-search",!1)
})},Daria.MessagesSearch._logSuggest=function(e){var t=Boolean(ns.Model.get("abook-suggest-proxy").models.length||ns.Model.get("history-suggest-proxy").models.length);Jane.ErrorLog.send({event:"suggest_show",user_input:e,empty_suggest:t?0:1,reqid:Daria.Config.searchSessionId,exp:Daria.Config["exp-test-ids"].join(",")})},Daria.MessagesSearch._onSuccess=function(e,t){if(e.onCorrecting){var i=ns.Model.get("messages",ns.page.current.params).getData(),n=jpath(i,".details.search-options.request")[0];n&&n.trim()!==(t.request||"").trim()&&e.onCorrecting(n)
}e.onSuccess&&e.onSuccess()},Daria.MessagesSearch._onError=function(e){e.onError&&e.onError()},Daria.Xiva={},Daria.Xiva.createThreadFromMessage=function(e,t,i,n){var s=_.cloneDeep(e.getData());s.count=i,s.mid=e.getThreadId(),s.last_mid=e.get(".mid"),s["new"]=n;var a=ns.Model.get("messages",{thread_id:s.mid});return a.isValid()&&(s.lid=_(a.models).map(function(e){return e.get(".lid")}).concat(s.lid).flatten().uniq().value()),t.setData(s)},Daria.Xiva.messageLabel=function(e){var t="mark mails"===e.operation?"label":"unlabel",i=ns.Model.get("labels"),n=!1,s=[];
e.tids&&(s=_.uniq(JSON.parse(e.tids)).map(function(e){return"t"+e}));var a=[];if(e.mids&&(a=JSON.parse(e.mids)),"all_labels"in e){var o=JSON.parse(e.all_labels),r=new Daria.MOPS.Opinfo;return a.forEach(function(e,t){var i=ns.Model.get("message",{ids:e});if(i.isValid()){var n=o[t],s=i.get(".lid"),a=[];s.forEach(function(e){var t=n.indexOf(e);-1===t?a.push(e):n.splice(t,1)});var l=n;l.forEach(function(e){var t=i.label({lid:e});r.merge(t)}),a.forEach(function(e){var t=i.unlabel({lid:e});r.merge(t)})
}}),r.hasAdjust()?(ns.Model.get("labels").adjustCounters(r.getAdjust()),vow.resolve()):ns.forcedRequest(["labels"])}var l,c;e.t_lids&&(l=JSON.parse(e.t_lids)[0],l&&!i.getLabelById(l)&&(n=!0)),e.m_lids&&(c=JSON.parse(e.m_lids)[0],c&&!i.getLabelById(c)&&(n=!0));var d;return d=n?ns.forcedRequest(["labels"]):vow.resolve(),d.then(function(){if(l&&s.length&&Daria.MOPS.doActionInMessages(s,t,{lid:l,onlyAdd:!0}),c&&a.length){var e=Daria.MOPS.doActionInMessages(a,t,{lid:c});if(!n){if(!e.hasAdjust())return ns.forcedRequest(["labels"]);
ns.Model.get("labels").adjustCounters(e.getAdjust())}}return vow.resolve()})},Daria.Xiva.messageMove=function(e){var t=e.fid,i=JSON.parse(e.mids);if("-1"===t)return i.forEach(function(e){ns.Model.get("message",{ids:e}).remove()}),ns.forcedRequest(["folders","labels"]);var n=i.filter(function(e){return!ns.Model.get("message",{ids:e}).isValid()}),s=[ns.Model.get("folders"),ns.Model.get("labels")];return n.length&&s.unshift(ns.Model.get("messages",{filter_ids:n})),ns.forcedRequest(s).then(function(){Daria.MOPS.doActionInMessages(i,"doMove",t)
})},Daria.Xiva.messageStatusChange=function(e){var t=e.status,i="";switch(t){case"New":i="unmark";break;case"PL":i="markForwarded";break;case"OQ":i="markAnswered";break;case"RO":i="mark";break;default:return""===t&&"0"===e.is_mixed_add&&"32"===e.is_mixed_del?vow.resolve():vow.reject()}var n=JSON.parse(e.mids);if("markForwarded"===i||"markAnswered"===i)return Daria.MOPS.doActionInMessages(n,i),vow.resolve();var s=n.filter(function(e){return!ns.Model.get("message",{ids:e}).isValid()});Daria.MOPS.doActionInMessages(n,i);
var a=[];return s.length&&a.unshift(ns.Model.get("messages",{filter_ids:s})),ns.request(a).then(function(){var e="mark"===i?-1:1,t={};n.map(function(e){return ns.Model.get("message",{ids:e})}).forEach(function(i){var n=i.getFolderId();n in t?t[n]+=e:t[n]=e}),ns.Model.get("folders").adjustUnreadCounters(t)})},Daria.Xiva.processUnsupported=function(e){var t=e.operation;switch(t){case"delayed_message":case"reset fresh":return vow.resolve();case"mark mails":case"unmark mails":return Daria.Xiva.messageLabel(e);
case"move mails":return Daria.Xiva.messageMove(e);case"status change":return Daria.Xiva.messageStatusChange(e);case"transfer":return Daria.Xiva.handlers.transfer()}return vow.reject()},Daria.Xiva.updateFoldersCounters=function(e){var t=e.getFolderId(),i=ns.Model.get("folder",{fid:t}),n=ns.page.current.params;e.isNew()?(i.updateCounts({"new":1,count:1}),t!==n.current_folder&&i.setRecent(t)):i.updateCounts({count:1})},Daria.Xiva.updateLabelsCounters=function(e){var t=ns.Model.get("labels"),i={},n=e.get(".lid");
Array.isArray(n)&&n.forEach(function(e){i[e]=1}),t.adjustCounters(i)},Daria.Xiva.handlers={},Daria.Xiva.handlers.commonChecker=function(e){var t=parseInt(e.lcn,10);return Daria.Xiva.handlers.processNewLcn(t)?"insert"===e.operation||Daria.Config.connection_id!==e.session_key:!1},Daria.Xiva.handlers.processNewLcn=function(e){var t=Daria.lcn;return t&&e-t>10?(Jane.ErrorLog.send({event:"xiva.invalid_lcn",diff:e-t,newLcn:e,oldLcn:t}),Daria.lcn=e,Daria.invalidateMailHandlers(!1,"xiva.invalid_lcn"),!1):((!t||e>t)&&(Daria.lcn=e),!0)
},Daria.Xiva.handlers.insert=function(e){return Daria.Xiva.handlers.commonChecker(e)?(ns.events.trigger("xiva.mail.insert",e),Daria.Xiva.NewMsgQueue.process(e.message)):vow.reject()},Daria.Xiva.handlers.transfer=function(){return Daria.goHomePage(),vow.resolve()},Daria.Xiva.handlers.unsupported=function(e){if(!Daria.Xiva.handlers.commonChecker(e))return vow.reject();Daria.gotNewMail=0,Daria.updateTitle();var t;t=e.raw_data&&"transfer"===e.raw_data.operation?e.raw_data:e.message;var i=Daria.Xiva.processUnsupported(t);
return i.then(null,function(){Jane.ErrorLog.send({event:"xiva.mail.unsupported.unhandled",data:JSON.stringify(e)})}),i},function(e,t){t.Xiva.NewMsgQueue={},t.Xiva.NewMsgQueue.process=function(e){return t.Xiva.NewMsgQueue.processData(e).then(t.Xiva.NewMsgQueue.insertMessage)},t.Xiva.NewMsgQueue.processData=function(t){return new vow.Promise(function(i,n){var s=t.mid,a="t"+t.thread_id,o=ns.Model.get("message",{ids:s});if(o.isValid())return void n("KNOWN_MESSAGE");var r=o;if(ns.Model.get("settings").isThreaded()){var l=ns.Model.get("message",{ids:a});
l.hasRealData()||(r=ns.Model.get("messages",{thread_id:a}))}ns.forcedRequest([r]).then(function(){o.getData()?i(o):(e.ErrorLog.send({mid:s,tid:a},"empty_msg_data_after_request_thread"),n("REQUEST_DATA_ERROR"))},function(){n("REQUEST_ERROR")})})},t.Xiva.NewMsgQueue.insertMessage=function(e){t.Xiva.updateFoldersCounters(e),t.Xiva.updateLabelsCounters(e);var i=t.Xiva.NewMsgQueue.updateLists(e);return t.Xiva.NewMsgQueue.notify(e,i),t.Xiva.NewMsgQueue.clearMessagesCache(),t.updateTitle(),vow.resolve()
},t.Xiva.NewMsgQueue.clearMessagesCache=function(){t.messages.clearSearchCache(),ns.Model.invalidateAll(["message-nearest","message-thread-nearest"])},t.Xiva.NewMsgQueue.updateLists=function(e){var i=[],n=e.getFolderId();if(e.inFolderBySymbol(["archive","draft","spam","template","trash"]))return i.push(t.Xiva.NewMsgQueue._updateList({current_folder:n},e)),i;var s=t.Xiva.NewMsgQueue.updateThreadModels(e);return i.push(t.Xiva.NewMsgQueue._updateList({current_folder:n,threaded:"yes"},s.insert,s.replace)),i.push(t.Xiva.NewMsgQueue._updateList({current_folder:n},e)),e.get(".lid").forEach(function(n){i.push(t.Xiva.NewMsgQueue._updateList({current_label:n},e))
}),e.hasAttachment()&&i.push(t.Xiva.NewMsgQueue._updateList({"goto":"all",extra_cond:"only_atta"},e)),e.isNew()&&i.push(t.Xiva.NewMsgQueue._updateList({current_folder:n,extra_cond:"only_new"},e),t.Xiva.NewMsgQueue._updateList({"goto":"all",extra_cond:"only_new",unread:"unread"},e)),i},t.Xiva.NewMsgQueue.updateThreadModels=function(i){var n=i.getThreadId(),s=ns.Model.get("message",{ids:n}),a=ns.Model.get("messages",{thread_id:n});if(s.hasRealData())return s.updateThreadInfo(i),a.insertMessage(i),{insert:s,replace:s};
if(ns.Model.get("settings").isThreaded()){a.insertMessage(i);var o=t.messages.toCreateThread(i);if(o){var r=a.getCount(),l=a.models.indexOf(i),c=a.models[l+1]||i,d=a.models[l+1];c.getData()||!d||d.getData()||e.ErrorLog.send({tid:n,mid:i.get(".mid")},"empty_msg_data_in_messages_thread_model");var u=a.getUnreadCount();return i.isNew()&&(u-=1),t.Xiva.createThreadFromMessage(c,s,r-1,u),s.updateThreadInfo(i),{insert:s,replace:s}}}return{insert:i,replace:i}},t.Xiva.NewMsgQueue._updateList=function(e,t,i){var n=ns.Model.get("messages",e);
return n.insertMessage(t,i),n},t.Xiva.NewMsgQueue.notify=function(e,i){t.Xiva.NewMsgQueue.checkCommonNotificationRules(e,i)&&(t.Xiva.NewMsgQueue.updateFaviconCounter(e.getFolderId()),t.Xiva.NewMsgQueue.playSound(),t.Xiva.NewMsgQueue.preloadMessage(e.get(".mid")),t.Xiva.NewMsgQueue.toShowNotification(i)&&t.Xiva.NewMsgQueue.showNotification(e))},t.Xiva.NewMsgQueue.checkCommonNotificationRules=function(e){return!e.isNew()||"compose2"===ns.page.current.page||ns.Model.get("quick-reply-state").existOpenQR()||ns.Model.get("compose-sidebar-fsm").isCurrentState("edit")?!1:e.inFolderBySymbol(["draft","outbox","sent","spam","template","trash"])?!1:!0
},t.Xiva.NewMsgQueue.updateFaviconCounter=function(e){var i=ns.page.current.params,n=ns.page.current.page,s=ns.Model.get("folders");t.gotNewMail+=t.IS_CORP&&"messages"==n?e==i.current_folder||s.isFolder(e,"inbox")?1:0:t.IS_CORP&&"message"==n?e==ns.Model.get("message",{ids:i.ids}).getData()||s.isFolder(e,"inbox")?1:0:1,t.gotNewMail+=ns.Model.get("user-dropdown-data").getSumOfFresh()},t.Xiva.NewMsgQueue.playSound=function(){var e=ns.Model.get("settings");e.getSetting("sound_message")&&"1"!=t.getCookie("sound_message_playing")&&(t.setCookie("sound_message_playing","1"),ns.action.run("sound.message"),setTimeout(function(){t.delCookie("sound_message_playing")
},1e3))},t.Xiva.NewMsgQueue.preloadMessage=function(e){t.messages.preload([{mid:e}])},t.Xiva.NewMsgQueue.toShowNotification=function(e){if(!ns.Model.get("settings").getSign("notify_message"))return!1;var i=ns.page.current.page;if("messages"!==i)return!0;var n=t.Xiva.NewMsgQueue._getCurrentMessages(),s=_.includes(e,n);return!s},t.Xiva.NewMsgQueue._getCurrentMessages=function(){var e,t=ns.page.current.params;return t.current_folder&&t.thread_id&&(e=_.clone(t),delete t.thread_id),ns.Model.get("messages",e||t)
},t.Xiva.NewMsgQueue.showNotification=function(e){t.Xiva.NewMsgQueue.showNotificationMessage(e)},t.Xiva.NewMsgQueue.showNotificationCalendarEvent=function(e){var i=e.get(".mid");return ns.request("message-widget-events",{ids:i}).then(function(e){var t=e[0],i=t.get(".eventInfo"),n={type:"calendar",name:i.name,location:i.location,start:i.start,end:i.end};"event_update"===i.calendarMailType?n.label="updated":i.isCancelled&&(n.label="canceled"),ns.Model.get("notifications").addNotification(n)},function(){t.Xiva.NewMsgQueue.showNotificationMessage(e)
})},t.Xiva.NewMsgQueue.showNotificationMessage=function(e){var t=e.get(".mid"),i=e.getFolderId(),n=e.getFromEmail(),s=ns.router.generateUrl("message",{current_folder:i,ids:t,fromNotification:1});ns.Model.get("notifications").addNotification({type:"message",subject:e.getSubject(),email:n,firstline:e.getFirstline(),name:e.getFromName(),ref:e.getEmailRef(n),url:s})}}(Jane,Daria),function(e,t){function i(e,i){if(_.has(e,"message.fresh_count")){var n=Number(e.message.fresh_count||0);i?n&&ns.Model.get("head-user-state").setNewLettersInMA(!0):n&&ns.Model.get("head-user-state").setNewLettersInMA(!1);
var s=ns.Model.get("user-dropdown-data");s.setNewCountById(e.uid,n),t.gotNewMail+=s.getSumOfFresh(),t.updateTitle()}}ns.events.on("xiva.mail.multi.insert",function(e,t){i(t,!0)}),ns.events.on("xiva.mail.multi.update",function(e,t){i(t)}),t.IS_CORP&&ns.events.on("xiva.calendar.meeting-reminder",function(e,t){ns.Model.get("settings").isSet("i_can_care_of_myself")||ns.Model.get("notifications").addNotification({type:"calendar",label:"reminder",name:t.message.subject,location:t.message.location,vip:!0})
})}(Jane,Daria),ns.action.define("attachments.image-preview",function(e,t,i,n){n.preventDefault(),n.stopPropagation(),Jane.c("Просмотрщик картинок","Открытие"),ns.request(["module-message"]).then(function(){Daria.ImageViewer.open(t.mode,t.mid,t.hid,t["message-hid"])})}),ns.action.define("attachments.count-click",function(){var e=-1!==$.inArray("59",Daria.SIDS)&&!Daria.IS_CORP;return Jane.c("Кнопка Прикрепить",e?"Клик по Прикрепить с Диском":"Клик по Прикрепить без Диска"),!0}),function(){var e="Статуслайн для фильтров",t="disable_move_filter",i="message-filter-move",n="statusline-create-filter-on-message-move";
ns.action.define("message.filter-move.show",function(s,a){var o=ns.Model.get("folders"),r=ns.Model.get("settings"),l=ns.Model.get("message",{ids:a.mid});if(!r.isSet(t)){var c=o.getFolderById(a.fid).name,d=l.getFromEmail(),u={mid:a.mid,fid:a.fid,from:d,folder:c};Daria.Statusline.hide(),Daria.Statusline.showMsg({name:i,body:Jane.tt("mail:"+n,u),onclose:function(){Jane.c(e,"Шаг 1","Крестик")}}),Jane.c(e,"Шаг 1","Показ")}}),ns.action.define("message.filter-move.create",function(t,s){Jane.Services.runModules(["jane.setup.js"],function(){var t=ns.Model.get("message",{ids:s.mid}),a=ns.Model.get("filters"),o=t.getFromEmail(),r=Daria.FilterSimpleCreate({validate:no.True,params:{letter:"all",name:"Моё правило",logic:1,field1:"from",field2:1,field3:o,clicker:"move",move_folder:s.fid},success:function(t){var r={mid:s.mid,from:o,filid:t,newsearch:a.isApplyAvailable()};
Daria.Statusline.showMsg({name:i,body:Jane.tt("mail:"+n+"-done",r),onclose:function(){Jane.c(e,"Шаг 2","Крестик")}}),Jane.c(e,"Шаг 2","Показ")}});r.create(),Jane.c(e,"Шаг 1","Перекладывать")})}),ns.action.define("message.filter-move.apply",function(t,i){Jane.Services.runModules(["jane.setup.js"],function(){ns.forcedRequest(["filters-apply"],{id:i.filid}).then(function(t){t[0].error||(Daria.Statusline.showMsg({body:"Письма будут перемещены в течение нескольких минут.",onclose:function(){Jane.c(e,"Шаг 3","Крестик")
}}),Jane.c(e,"Шаг 3","Показ"))}),Jane.c(e,"Шаг 2","Переложить")})}),ns.action.define("message.filter-move.edit",function(t,i){ns.page.go("#setup/filters-create?id="+i.filid),Jane.c(e,"Шаг 2","Изменить правило")}),ns.action.define("message.filter-move.disable",function(){ns.Model.get("settings").setSettingOn(t),Daria.Statusline.hide(i),Jane.c(e,"Шаг 1","Не предлагать")})}(),ns.action.define("folder.remove",function(e,t){Jane.Services.load("#setup",function(){Daria.Folder.remove(t.id)})}),ns.action.define("folder.edit",function(e,t){Jane.Services.load("#setup",function(){var e=Daria.FolderEditPopup({id:t.id});
$.extend(e,{success:function(){t["only-edit"]&&ns.page.go()}}),e.init()})}),ns.action.define("folder.clear",function(e,t,i,n){var s=t.fid;t.onTarget&&n.currentTarget&&(t.targetOffset=$(n.currentTarget).offset().top+$(n.currentTarget).height()/2-$(window).scrollTop()),t.template="extended"!=t.type||ns.Model.get("folders").isFolder(s,["trash"])?"<p>Письма из папки будут удалены навсегда и их нельзя будет восстановить.</p>":$(Jane.tt("setup:js-setup-folders-dialog-folder-exclear")),Jane.Services.runModules(["jane.setup.js"],function(){var e=Daria.FolderClearPopup(t);
_.extend(e,{onsuccess:function(){var e=ns.page.refresh();Daria.is3pane()&&t.fid===ns.page.current.params.current_folder&&(e=e.then(function(){ns.events.trigger("mail:splitter:toggleOnePaneMode",0===ns.Model.get("messages",ns.page.current.params).getCount())})),e.then(function(){ns.events.trigger("folder.cleared",t.fid)})}}),e.init()})}),ns.action.define("folders.add",function(e,t,i,n){Jane.Services.load("#setup",function(){var e=Daria.FolderCreatePopup(t);$.extend(e,{success:function(e){return t["only-create"]?void ns.page.go():void(t.mMessagesChecked?(t.fid=e,t.mMessagesChecked.runAction("move",t)):ns.action.run("move",{fid:e,toolbar:t.toolbar},null,n))
}}),e.init()})}),ns.action.define("label.remove",function(e,t){Jane.Services.load("#setup",function(){Daria.Label.remove(t.id)})}),ns.action.define("label.edit",function(e,t){Jane.Services.load("#setup",function(){var e=Daria.LabelEditPopup({id:t.id});$.extend(e,{success:function(){t["only-edit"]&&ns.page.go()}}),e.init()})}),ns.action.define("labels.add",e),ns.action.define("label",function(e,t,i){t.current_label=t.current_label||t.lid,t.hotkeysUsed||ns.action.run("trigger-hotkeys-promo-bubble",{eventName:"Labels_dialog"}),t._viewKey=$(i).closest(".ns-view-message").attr("data-key"),ns.events.trigger("daria:vToolbarButton:"+e,t)
}),ns.action.copy("label","unlabel"),ns.action.define("move",function(e,t){t.refreshImmediately=!0,ns.events.trigger("daria:vToolbarButton:move",t)}),function(){function e(){return parseInt(ns.Model.get("settings").getSetting("reply-promo-cnt"),10)||0}function t(){["messages","message-nearest","message-thread-nearest","abook-contacts","abook-contact","folders"].forEach(function(e){ns.Model.invalidate(e)});var e=ns.page.current.params,t=ns.Model.get("folders");ns.Model.isDefined("messages-pager")&&(ns.Model.get("messages-pager",e).invalidate(),ns.Model.get("messages-pager",{current_folder:t.getFidBySymbol("sent")}).invalidate())
}function i(e){var i=e.match(/<error.*code=\"(\d*)\".*>/);if(i)return void this.reject(parseInt(i[1],10));if(i=e.match(/<status>(.+)<\/status>/),!i)return void this.reject();switch(i[1]){case"ok":t(),this.resolve();break;case"attachment_too_big":this.reject(31);break;default:this.reject()}}function n(e,t){var n=$.Deferred(),s=[{id:"folders"},{id:"message",params:{ids:e}},{id:"message",params:{ids:t}},{id:"message-body",params:{ids:e}},{id:"message-body",params:{ids:t}}];return ns.request(s).then(function(e){var s=e[0],a=e[1],o=e[2],r=e[3],l=e[4];
if(!a.getData()||!r.getData())return void n.reject(-1);if(!o||!l)return void n.reject();var c=s.getFidBySymbol("template"),d=a.getFolderId();if(!c||!d||d!==c)return void n.reject(-1);var u=o.getFolderId(),h=u?s.getFolderById(u):null;if(!u||!h||!s.isFolder(u,"inbox")&&!h.user)return void n.reject();var m=ns.Model.get("settings"),g=r.getComposeHTML(),p=l.getSubtype(),f=l.getReplyBody(p),_=l.getRecipients(!0),v=l.getMessageId(),b=l.getInReplyTo(),y=l.getReferences();"plain"==p&&(g=Daria.Html2Text.html2text(g)),f=g+f;
var M={mark_ids:t,overwrite:t,ign_overwrite:"yes",mark_as:"replied",references:$.trim((y||b)+" "+v),inreplyto:v,ttype:p,from_mailbox:o.getToEmail()||m.getSetting("default_email"),from_name:m.getSetting("from_name"),to:_.to,cc:_.cc,bcc:"",subj:"Re: "+o.getSubject(!0),send:f};Daria.SendMail.sendForm({$form:$("<form></form>"),params:M,success:function(e){i.call(n,e),n.then(function(){ns.page.go()})},error:function(){n.reject()}})}).fail(function(){var t=ns.Model.get("message",{ids:e}),i=ns.Model.get("message-body",{ids:e});
return t.getData()&&i.getData()?void n.reject():void n.reject(-1)}),n.promise()}function s(e,t){var n=$.Deferred();return ns.request(["message","message-body"],{ids:t}).then(function(s){if(2!==s.length)return void n.reject();var a=s[0],o=s[1],r=ns.Model.get("settings"),l=o.getComposeHTML(),c=o.getSubtype();"plain"==c&&(l=Daria.Html2Text.html2text(l));var d=$.map(o.getAttachments(t),function(e){return"message"==e.type?e.hid:null}),u={ids:t,ttype:c,overwrite:t,ign_overwrite:"yes",from_mailbox:a.getToEmail(t)||r.getSetting("default_email"),from_name:r.getSetting("from_name"),to:e,cc:"",bcc:"",subj:"Fwd: "+a.getSubject(!0),send:l,inreplyto:o.getMessageId(t),references:"",mark_as:"forwarded",mark_ids:t,parts:d};
Daria.SendMail.sendForm({$form:$("<form></form>"),params:u,success:function(e){i.call(n,e),n.then(function(){ns.page.go().then(function(){ns.events.trigger("daria:Message:check",t)})})},error:function(){n.reject()}})}),n.promise()}var a=function(e){Jane.c(["Ответить всем","Паранжа"].concat(e))};ns.action.define("reply",function(t,i,a,o){i.action=t;var r,l=ns.Model.get("settings"),c="";if(i["message-id"])r={ids:[i["message-id"]],tids:[]};else{var d=i.mMessagesChecked;ns.assert(d,"params.mMessagesChecked","%s not passed to ns.action reply");
var u=d.getCount();if(!u)return;r=d.getIds()}if(0===r.ids.length&&1===r.tids.length){var h=r.tids[0],m=ns.Model.get("message",{ids:h});if(m.isMessageThread())r.tids=[],r.ids=[m.getMessageThreadMid()];else if("forward"!==t){var g=m.getThreadMessages().getLastReplyMessage();g&&(r.tids=[],r.ids=[g.get(".mid")])}}var p=1===r.ids.length&&0===r.tids.length?r.ids[0]:null;if(p){var f=ns.Model.get("message-body",{ids:p});if(f.isCollectorMessage())return;if("reply"===t&&i.toolbar&&f.allowedReplyAll()&&!$("html").hasClass("b-page_reply-promo")&&Daria.is2pane()&&!l.getSetting("force-reply"))return void ns.action.run("reply.confirm",i,a,o)
}var v=e();"reply"===t&&!i.toolbar&&2>v&&(v+=1,l.setSettings({"reply-promo-cnt":v})),"reply-all"===t&&!i.toolbar&&2>v&&l.setSettings({"reply-promo-cnt":0});var b;if("sendon"===t&&i.toolbar){if(b=i.email,!b)return void Daria.Statusline.showMsg({name:"message-sendon",speed:"fast",body:"Не указан адрес для пересылки"});if(p)return Daria.Statusline.showMsg({name:"message-sending",hideOnTimeout:!1,body:"Письмо отправляется…"}),void s(b,p).done(function(){Daria.Statusline.showMsg({body:"Письмо отправлено"})
}).fail(function(e){var t={body:"Произошла ошибка"};switch(e){case 31:var i="Письмо не&#160;может быть отправлено: превышено количество пересылаемых писем. Вы&#160;можете одновременно пересылать не&#160;более 200&#160;писем суммарным объёмом до "+(Daria.IS_CORP?100:24)+" МБ.";t={body:i}}Daria.Statusline.showMsg(t)}).always(function(){Daria.Statusline.hide("message-sending"),ns.events.trigger("daria:MOPS:action-complete",i),ns.events.trigger("daria:MOPS:"+t,i),ns.events.trigger("message.action.complete",i),ns.events.trigger("daria:vToolbarButton:loader:end")
});t="forward"}if("reply-tmpl"==t&&i.toolbar){var y=i.tmpl;return y?p?(Daria.Statusline.showMsg({name:"message-sending",hideOnTimeout:!1,body:"Письмо отправляется…"}),void n(y,p).done(function(){Daria.Statusline.showMsg({body:"Письмо отправлено"})}).fail(function(e){var t={body:"Произошла ошибка"};switch(e){case-1:t={body:'Шаблон не найден. <a class="daria-action" href="#" data-action="toolbar.settings.button.remove" data-params="button=template">Удалите кнопку</a> или <a class="daria-action" href="#" data-action="compose.go" data-params="save_symbol=template&old_tmpl='+y+'">создайте новый шаблон</a>.'};
break;case 31:var i="Письмо не&#160;может быть отправлено: превышено количество пересылаемых писем. Вы&#160;можете одновременно пересылать не&#160;более 200&#160;писем суммарным объёмом до "+(Daria.IS_CORP?100:24)+" МБ.";t={body:i}}Daria.Statusline.showMsg(t)}).always(function(){Daria.Statusline.hide("message-sending"),ns.events.trigger("daria:MOPS:action-complete",i),ns.events.trigger("daria:MOPS:"+t,i),ns.events.trigger("message.action.complete",i),ns.events.trigger("daria:vToolbarButton:loader:end")
})):void Daria.Statusline.showMsg({name:"message-reply-tmpl",speed:"fast",body:"Можно ответить только на одно письмо"}):void Daria.Statusline.showMsg({name:"message-reply-tmpl",speed:"fast",body:"Шаблон не найден"})}var M=ns.Model.get("account-information").getDataKey("uid"),S={oper:t};c&&(S.tab=c),r.ids.length&&(S.ids=r.ids),r.tids.length&&(S.tids=r.tids),i.translate&&(Jane.c({"Compose-Translate":"Клик по "+(M%2?"зеленой":"серой")+" кнопке 'ответить с переводчиком'"}),S.translate=i.translate);var D=function(e){var t=["reply","reply-all"];
return i.hotkeysUsed?void(D=$.noop):void(_.contains(t,e)&&ns.action.run("trigger-hotkeys-promo-bubble",{eventName:e}))};b&&ns.Model.get("compose-predefined-data").set(".to",b),Daria.composeGo(S).then(function(){D(t),b&&ns.Model.get("compose-state",ns.View.info("compose2").params()).setFocusField("subj")}),ns.events.trigger("daria:MOPS:action-complete",i),ns.events.trigger("daria:MOPS:"+t,i),ns.events.trigger("message.action.complete",i),ns.events.trigger("daria:vToolbarButton:loader:end")}),ns.action.copy("reply","forward"),ns.action.copy("reply","reply-all"),ns.action.copy("reply","sendon"),ns.action.copy("reply","reply-tmpl"),ns.action.define("reply-all.warning",function(){Daria.MessageAction.warning("У письма должно быть больше одного получателя")
}),ns.action.define("reply.confirm",function(t,i){var n=ns.Model.get("settings"),s=e(),o=i.mMessagesChecked.getIds(),r=i.mMessagesChecked.isOnlyMessageChecked()?o.ids[0]:null;if(r){var l,c,d=function(){this.close()},u={body:Jane.tt("message:reply-confirm-dialog",{mid:r,participants:ns.Model.get("message-body",{ids:r}).participantsCount()+1,prevent:s>=2}),additionalClass:"b-toolbar__popup",onopen:function(e){d=d.bind(e),ns.events.on("ns-page-before-changed",d)},oncancel:function(){n.setSettings({"reply-promo-cnt":s+1})
},onclose:function(){ns.events.off("ns-page-before-changed",d),h.$paranja.addClass("g-hidden").removeClass("b-paranja_fadeout"),c&&$("HTML").removeClass("b-page_reply-promo")},width:400,hideOnScroll:!0};i.buttonView&&(c=i.buttonView.$node,l=c.offset(),l.top+=c.height()-$(window).scrollTop(),l.left+=c.outerWidth()+1,$.extend(u,{onTarget:{x:l.left,y:l.top,side:"top",pos:"bottom"}}));var h=Daria.Dialog.open(u);n.setSettings({"hk-reply-promo":"on"}),a("Показы"),c&&$("HTML").addClass("b-page_reply-promo"),h.$paranja.removeClass("g-hidden b-paranja_transparent").addClass("b-paranja_fadeout")
}}),ns.action.define("reply.not-ask",function(e,t,i,n){var s={event:n,params:t},o=nb.block(s.event.currentTarget);return window.setTimeout(function(){ns.Model.get("settings").setSettings({"force-reply":o.isChecked()}),a("Проставлено галочек")},1),!0})}(),function(e){function t(e){var t=new Vow.Promise;return Daria.loadPromoModule(function(){var i=ns.View.create("user-feedback");i.updateWithParams(e).then(function(){t.fulfill(i)})}),t}ns.action.define("user-feedback.show",function(i,n,s,a){var o={event:a,params:n};
o.event&&o.event.preventDefault();var r=$.extend({canAttachEml:!!ns.page.current.params.ids,canTakeScreenshot:Modernizr.blobconsructor},o.params);r.onlyReport&&(r.report=!0),r.report?e.c("ФОС","Шаг 4","Показ шага"):e.c("ФОС",'Клик по ссылке "Обратная связь"'),t(r).then(function(t){Daria.Dialog.open({body:t.node,title:"Задать вопрос службе поддержки",additionalClass:"feedback-form"+(r.report?" feedback-form_report":""),width:570,onopen:function(t){r.report||e.c("ФОС","Шаг 1","Показ блока"),r.report?t.$dialog.data("step",4):t.$dialog.data("step",1)
},oncancel:function(t){e.c("ФОС","Шаг "+t.$dialog.data("step"),"Клик на крестик ")},onclose:function(){Daria.Dialog.$dialog.removeClass("feedback-no-header"),t.destroy()}})})}),ns.action.copy("user-feedback.show","translate.feedback")}(Jane),ns.action.define("passport.phone-check",function(){ns.forcedRequest("userphones").then(function(e){var t=e[0],i="no";t.getActivePhone()&&(i="yes"),ns.events.trigger("phone-checked",i)})}),ns.action.define("passport.phone-register",function(e,t,i,n){t.lang=t.lang||Daria.Config.locale,i&&$.extend(t,Daria.parseQuery($(i).data("params"))),ns.forcedRequest("phone-register",t).then(function(e){var s=e[0],a=s.get(".errorcode")||"ok";
"ok"===a?ns.Model.get("settings").setSettings({"phone-number":s.getNumber()},function(){ns.events.trigger("phone-registered-success",a,t,i,n),t.revalidate&&ns.events.trigger("phone-revalidate-success",a,t,i,n)}):ns.events.trigger("phone-registered-failure",a,t,i,n),ns.events.trigger("phone-registered-end")},function(){ns.events.trigger("phone-registered-failure","error",t,i,n),ns.events.trigger("phone-registered-end")})}),ns.action.define("passport.phone-confirm",function(e,t,i,n){ns.forcedRequest("phone-confirm",t).then(function(e){var s=e[0],a=s.get(".errorcode")||(Number(s.get(".phone.valid"))?"ok":"NOVALIDCODE"),o=s.get(".phone.left");
a="0"==o?"VALEXEEDED":a,"ok"==a?ns.Model.get("settings").setSettings({"phone-number":ns.Model.get("phone-register").getNumber()},function(){ns.events.trigger("phone-confirmed-success",a,t,i,n)}):ns.events.trigger("phone-confirmed-failure",a,Number(o),t,i,n),ns.events.trigger("phone-confirmed-end")},function(){ns.events.trigger("phone-confirmed-end")})}),borschik.addLinks({"b-mail-icon_ai-48.png":"//yastatic.net/mail/_/JKRBXAenL1HsMNdiknQqvIubnUw.png","b-mail-icon_application-48.png":"//yastatic.net/mail/_/LD06f5RBVDmzG1dSbf_RiUFB1bE.png","b-mail-icon_archive-48.png":"//yastatic.net/mail/_/wvBPL2e00mmsBd1b_PoqbzkttxI.png","b-mail-icon_audio-48.png":"//yastatic.net/mail/_/UzSld-JbWX2TdOPgnTSJ2cFkbyc.png","b-mail-icon_avi-48.png":"//yastatic.net/mail/_/48qtwlquyWRbOW1vmnnIcu6UBrE.png","b-mail-icon_bmp-48.png":"//yastatic.net/mail/_/DxjVFmmkIlb9MhNnaWm8xsfPTQw.png","b-mail-icon_cdr-48.png":"//yastatic.net/mail/_/bQVL79_fmDQpYMU-mWWdPxAawWU.png","b-mail-icon_csv-48.png":"//yastatic.net/mail/_/u5ho7BFnyWsBib1_bRNntV7T6qs.png","b-mail-icon_development-48.png":"//yastatic.net/mail/_/t3mUATt_wINZX2B3Q8r1daOQHnA.png","b-mail-icon_djvu-48.png":"//yastatic.net/mail/_/LkzV4jcv2oSvKR71vp3a6OZMfSQ.png","b-mail-icon_doc-48.png":"//yastatic.net/mail/_/lB9ngsW3FVY_5WpGVOFEVfkjS1s.png","b-mail-icon_eml-48.png":"//yastatic.net/mail/_/7ODPByrSLgo8pACkFVn0ysledbU.png","b-mail-icon_exe-48.png":"//yastatic.net/mail/_/nvnOwfnODUS6Ci94vfrOcACaxvU.png","b-mail-icon_executable-48.png":"//yastatic.net/mail/_/LD06f5RBVDmzG1dSbf_RiUFB1bE.png","b-mail-icon_flash-48.png":"//yastatic.net/mail/_/Q3Gj-WcC82hKwbswmjnOJL_E_kc.png","b-mail-icon_font-48.png":"//yastatic.net/mail/_/XNNwiuZS0b_aLGheQFhqG9b72FU.png","b-mail-icon_general-48.png":"//yastatic.net/mail/_/DHyRC0V2g3g_Dawpj_8ISXN9cL0.png","b-mail-icon_gif-48.png":"//yastatic.net/mail/_/BjteJtIMqZ0LaRNRDFPg4sQptJQ.png","b-mail-icon_image-48.png":"//yastatic.net/mail/_/CMMaXT95Jy9Sa2NDDGp6pSLQBfg.png","b-mail-icon_jpg-48.png":"//yastatic.net/mail/_/OuAIl9Y9V8jR2jOzDSxmXeFMPRg.png","b-mail-icon_mail-48.png":"//yastatic.net/mail/_/7ODPByrSLgo8pACkFVn0ysledbU.png","b-mail-icon_mov-48.png":"//yastatic.net/mail/_/Q2NMl1rjIzxGXUh5qNwrElpdHTc.png","b-mail-icon_mp3-48.png":"//yastatic.net/mail/_/SmQjhX5vyO1AlC25rRhlLHcrs4g.png","b-mail-icon_mp4-48.png":"//yastatic.net/mail/_/HrhciQrBF8H0OqGClbkVMrHCZ8U.png","b-mail-icon_none-48.png":"//yastatic.net/mail/_/s6m7MjTLcKpvV11Tr-X0eKrd5QM.png","b-mail-icon_odp-48.png":"//yastatic.net/mail/_/afpJL8Q1eHWgBvAKHl6KknYJ5Pk.png","b-mail-icon_ods-48.png":"//yastatic.net/mail/_/6wl_1Fir2kjegpFVgizLnOwQMV4.png","b-mail-icon_odt-48.png":"//yastatic.net/mail/_/nNRRE2Fzr6NHzqCyI8HUsmXcFNM.png","b-mail-icon_pcx-48.png":"//yastatic.net/mail/_/J-onc5I_FTgFjqLlvXbYmUI1XtQ.png","b-mail-icon_pdf-48.png":"//yastatic.net/mail/_/I6ZgqTSIPTmVUuZ-m8s51CDstDA.png","b-mail-icon_pls-48.png":"//yastatic.net/mail/_/YdPupdP-rup6vn8ZiaXAqE6R1tw.png","b-mail-icon_png-48.png":"//yastatic.net/mail/_/Dw-LKA2E1AaMcD35kbFjIPGryEY.png","b-mail-icon_ppt-48.png":"//yastatic.net/mail/_/qi86rT3KPVLuxs_JFv-jAgLpnec.png","b-mail-icon_psd-48.png":"//yastatic.net/mail/_/VH-5nkxUfFt7a-o4nSfPID34Aa4.png","b-mail-icon_rar-48.png":"//yastatic.net/mail/_/xtIL4yIILJYINXkSeHKSuNusTWQ.png","b-mail-icon_rtf-48.png":"//yastatic.net/mail/_/TA5W7PfLqEmf1WQsHkjMpI1HaOQ.png","b-mail-icon_script-48.png":"//yastatic.net/mail/_/t3mUATt_wINZX2B3Q8r1daOQHnA.png","b-mail-icon_text-48.png":"//yastatic.net/mail/_/8OH08nlWEXPwUbxJxAN3u9T_77o.png","b-mail-icon_tiff-48.png":"//yastatic.net/mail/_/plB_9LOqfofgSoc2UT1zD8QUgxE.png","b-mail-icon_txt-48.png":"//yastatic.net/mail/_/3COarqqN8rsZv8C6q8vjarl2tfE.png","b-mail-icon_video-48.png":"//yastatic.net/mail/_/UjrV7tfPYi17QqEbVF-CdRq2xVc.png","b-mail-icon_virus-48.png":"//yastatic.net/mail/_/F5eixWTN6OAqE7Pji_xluzeMcpw.png","b-mail-icon_wav-48.png":"//yastatic.net/mail/_/GUM_UpxaU6N3WqeNwA6PAMiiUaE.png","b-mail-icon_wma-48.png":"//yastatic.net/mail/_/SqNS3G75KpOe52RvGGXr7OjGe_0.png","b-mail-icon_wmv-48.png":"//yastatic.net/mail/_/akXkYKRYpTkyFKVPlVMfCpC9CJs.png","b-mail-icon_xls-48.png":"//yastatic.net/mail/_/ht_fd-xc6xMf86whqmhl-QqPj4A.png","b-mail-icon_zip-48.png":"//yastatic.net/mail/_/8ejVnAbivgAsh9zzkChXaSV3viE.png"}),borschik.addLinks({"b-mail-icon_ai-54.png":"//yastatic.net/mail/_/w4em61NX-DNYZ-MVbv4dES-TZCU.png","b-mail-icon_application-54.png":"//yastatic.net/mail/_/RsFQl_oqEB1CI09DgQpZTXEmMSY.png","b-mail-icon_archive-54.png":"//yastatic.net/mail/_/wBiI-wd2YrNb58LhlQiVd7-OdkU.png","b-mail-icon_audio-54.png":"//yastatic.net/mail/_/Cmy8BMbaPncD6LwQfpFYxgXP1rs.png","b-mail-icon_avi-54.png":"//yastatic.net/mail/_/NMu496gmRASzg-pAPIxKaK7Rndk.png","b-mail-icon_bmp-54.png":"//yastatic.net/mail/_/NSF7oadHX8jhh94jDiqhPGjGXCE.png","b-mail-icon_cdr-54.png":"//yastatic.net/mail/_/bx-y-ygevp6wT-vb3CNDIYfWHtM.png","b-mail-icon_csv-54.png":"//yastatic.net/mail/_/dYG3ioZUoU_stajWxfOnb2FVff4.png","b-mail-icon_development-54.png":"//yastatic.net/mail/_/_Q7ZO9dhaev8Q4LSV3qxEkOW564.png","b-mail-icon_djvu-54.png":"//yastatic.net/mail/_/VC_lw8nv9Eo9oDjpKo75EfyMLk.png","b-mail-icon_doc-54.png":"//yastatic.net/mail/_/MeucJj_4MZTlQSihvYa2k0qT6bw.png","b-mail-icon_eml-54.png":"//yastatic.net/mail/_/jKDDi017-bxf-vYIM7Cw1WKFb2k.png","b-mail-icon_exe-54.png":"//yastatic.net/mail/_/Uy31Il9AF0kd3nGls23a3Ftun0s.png","b-mail-icon_executable-54.png":"//yastatic.net/mail/_/pJsIBgPyrBGNuSlqppL0CFYKuYI.png","b-mail-icon_flash-54.png":"//yastatic.net/mail/_/UT24byTVrt4g0OCnFqwlq6GM0vU.png","b-mail-icon_font-54.png":"//yastatic.net/mail/_/3ZiAGBIaehOVG-oqfTL6T4weYwY.png","b-mail-icon_general-54.png":"//yastatic.net/mail/_/d3Xa4WMYe7ftWkajLUaw7njok0Y.png","b-mail-icon_gif-54.png":"//yastatic.net/mail/_/x6tj3XtYr9Q_ZVnDlmxrW5vHqIM.png","b-mail-icon_image-54.png":"//yastatic.net/mail/_/UWPs6iOh07tCpsmzyEzXW-URdrE.png","b-mail-icon_jpg-54.png":"//yastatic.net/mail/_/RSIp0cdSg8P9eWHOQxUGCUAmU1s.png","b-mail-icon_mail-54.png":"//yastatic.net/mail/_/jKDDi017-bxf-vYIM7Cw1WKFb2k.png","b-mail-icon_mov-54.png":"//yastatic.net/mail/_/DYhotDfWnppWWEF2sdlTfzNPLWk.png","b-mail-icon_mp3-54.png":"//yastatic.net/mail/_/I4_tAzF7TSABHgGLNOI300df6no.png","b-mail-icon_mp4-54.png":"//yastatic.net/mail/_/7_DhD3AtU0MFmyKX7uvDgq20fgs.png","b-mail-icon_none-54.png":"//yastatic.net/mail/_/5dJf6AwlN9iOUzePrd6yKPMtaTY.png","b-mail-icon_odp-54.png":"//yastatic.net/mail/_/pFC7Y38Pp5wGJRfcO_U1Y0nDr5k.png","b-mail-icon_ods-54.png":"//yastatic.net/mail/_/A44JSdcmr9BUOWOsbU3NquK0Mn0.png","b-mail-icon_odt-54.png":"//yastatic.net/mail/_/UONcESPz8NRpGWUlXZ3u_gcGvHQ.png","b-mail-icon_pcx-54.png":"//yastatic.net/mail/_/3Tw8leVXiz_KyhzFP7d6IkqS5uE.png","b-mail-icon_pdf-54.png":"//yastatic.net/mail/_/7N2dlNNiF8p4ayDr3jSzMDM5CBQ.png","b-mail-icon_pls-54.png":"//yastatic.net/mail/_/Cmy8BMbaPncD6LwQfpFYxgXP1rs.png","b-mail-icon_png-54.png":"//yastatic.net/mail/_/oXzyWSG52XrWZajFU0MCFyRjPvw.png","b-mail-icon_ppt-54.png":"//yastatic.net/mail/_/FFuZD1VfaJFBOtBN1Gl5WVJxj8.png","b-mail-icon_psd-54.png":"//yastatic.net/mail/_/v-Umi6x-UtKFg6aQihEUCLEWk94.png","b-mail-icon_rar-54.png":"//yastatic.net/mail/_/cB1bf1oOswHq5KFvVJV038iiJ-Q.png","b-mail-icon_rtf-54.png":"//yastatic.net/mail/_/vLfzI784hLiRVOxAbXxO7Ub-eW0.png","b-mail-icon_script-54.png":"//yastatic.net/mail/_/_Q7ZO9dhaev8Q4LSV3qxEkOW564.png","b-mail-icon_text-54.png":"//yastatic.net/mail/_/pstvyPA_ig5El9TlPpoFrbJSkUk.png","b-mail-icon_tiff-54.png":"//yastatic.net/mail/_/ALsAHRHFeCTbPHTD_Io2wWZdsA4.png","b-mail-icon_txt-54.png":"//yastatic.net/mail/_/VhW_nCKXS0rRsByC8Fvj7Zz6VvA.png","b-mail-icon_video-54.png":"//yastatic.net/mail/_/wSQ52hE1GPgHqtESP4NXWpNExgw.png","b-mail-icon_virus-54.png":"//yastatic.net/mail/_/Gm6YlxyKh69ySPtX9cjJDnCTJwk.png","b-mail-icon_wav-54.png":"//yastatic.net/mail/_/uYQwk20fEfBPorKERPgbZ6-RXfs.png","b-mail-icon_wma-54.png":"//yastatic.net/mail/_/SodyQkYvr30HgQgP4OSkhpDum5o.png","b-mail-icon_wmv-54.png":"//yastatic.net/mail/_/bCWxkWJGtqHs7dngPkPjekp0nCU.png","b-mail-icon_xls-54.png":"//yastatic.net/mail/_/8vM-JUa73BZOnBq1wAzC1oNeqek.png","b-mail-icon_zip-54.png":"//yastatic.net/mail/_/vxAUUHB7RZHEJUlnioY5FTdd--M.png"}),borschik.addLinks({"b-mail-icon_ai-96.png":"//yastatic.net/mail/_/ULDyCsjOJk4d8yrwKml3xH4PTUQ.png","b-mail-icon_application-96.png":"//yastatic.net/mail/_/dLMDWYftnV7lRpJFAyh8u6t3gb4.png","b-mail-icon_archive-96.png":"//yastatic.net/mail/_/ooIQ-54MumBrdqPWCA9f_gp43u8.png","b-mail-icon_audio-96.png":"//yastatic.net/mail/_/nPylKi3fNn-aYeK9q8zSpejL9yk.png","b-mail-icon_avi-96.png":"//yastatic.net/mail/_/dm2EJrr4xd1ygXuz-nK-RoGLybA.png","b-mail-icon_bmp-96.png":"//yastatic.net/mail/_/23yCPmSNtD2nbgpl2qBy-PYSu-4.png","b-mail-icon_cdr-96.png":"//yastatic.net/mail/_/4lFulnzniAxM6gH4LOp509ieLZs.png","b-mail-icon_csv-96.png":"//yastatic.net/mail/_/BMTfIjxxnZ7Xg16A6l-UJmyr3Q0.png","b-mail-icon_development-96.png":"//yastatic.net/mail/_/1gQVRZ9DQkWoySBo1oRCZc600aI.png","b-mail-icon_djvu-96.png":"//yastatic.net/mail/_/_Y7pQRTkIOy2p490KlaBWyMn-gw.png","b-mail-icon_doc-96.png":"//yastatic.net/mail/_/MmVWGiyhdxRqO8Z2yMCrEgMjhLc.png","b-mail-icon_eml-96.png":"//yastatic.net/mail/_/NN6LEmN-jiaKOrwvIN2k6P2csPc.png","b-mail-icon_exe-96.png":"//yastatic.net/mail/_/LnLA2LZu4769nHxuT-qTxijezh4.png","b-mail-icon_executable-96.png":"//yastatic.net/mail/_/dLMDWYftnV7lRpJFAyh8u6t3gb4.png","b-mail-icon_flash-96.png":"//yastatic.net/mail/_/VvWp3m7ZqBbE1PIi9vMY2SDBsCk.png","b-mail-icon_font-96.png":"//yastatic.net/mail/_/4rfu4cIRcqdBP9-bGQaA_LR0scc.png","b-mail-icon_general-96.png":"//yastatic.net/mail/_/ECPG4RvkPtyjp8aKLpXB70eeB6U.png","b-mail-icon_gif-96.png":"//yastatic.net/mail/_/Krn7gnzx3YzMXNQAmQOqKITUz18.png","b-mail-icon_image-96.png":"//yastatic.net/mail/_/c-LQdW39w0-hD0E0-Rcw5MoBT7k.png","b-mail-icon_jpg-96.png":"//yastatic.net/mail/_/DdjJ7PoDdfyTKGcpE9FBck_yxsg.png","b-mail-icon_mail-96.png":"//yastatic.net/mail/_/NN6LEmN-jiaKOrwvIN2k6P2csPc.png","b-mail-icon_mov-96.png":"//yastatic.net/mail/_/dxwBs5guhGbByqQgbIoXKUGT6aY.png","b-mail-icon_mp3-96.png":"//yastatic.net/mail/_/g6nW9EmoZY7wisIQaVtAUty0VYQ.png","b-mail-icon_mp4-96.png":"//yastatic.net/mail/_/K7XvwVL14eunyaHZ2p56eKIvW3E.png","b-mail-icon_none-96.png":"//yastatic.net/mail/_/PFOgrEZX5V2A0RsTSqkdcoeo670.png","b-mail-icon_odp-96.png":"//yastatic.net/mail/_/_lHAD_37eVdgTh2khTaXtOwVgEg.png","b-mail-icon_ods-96.png":"//yastatic.net/mail/_/Bov3jt9uN9tWzfgHM5_CxoywoCw.png","b-mail-icon_odt-96.png":"//yastatic.net/mail/_/J6I9O8ic_b3nuTRNbqzV1qdudD8.png","b-mail-icon_pcx-96.png":"//yastatic.net/mail/_/dY5_tHfB_y9G0q8ybRWKTIjxAZ8.png","b-mail-icon_pdf-96.png":"//yastatic.net/mail/_/B1qaywAytA6KMXP3Z30j4rkY7_I.png","b-mail-icon_pls-96.png":"//yastatic.net/mail/_/EPQd_R8mMZqquwMLBgheBn5s-Dc.png","b-mail-icon_png-96.png":"//yastatic.net/mail/_/EZKmXJlUZGVE3LpmMgzb-aK0A5Q.png","b-mail-icon_ppt-96.png":"//yastatic.net/mail/_/7BFtxWAdXsiSdAcNM3BQFp01Gdg.png","b-mail-icon_psd-96.png":"//yastatic.net/mail/_/L-QT7zuFJ8OYB1fiXz_GQfuFOPw.png","b-mail-icon_rar-96.png":"//yastatic.net/mail/_/pART8QEvHDzREEotsMMaokUDoJQ.png","b-mail-icon_rtf-96.png":"//yastatic.net/mail/_/FTN8El3g7kGm1ua3ulqNLktQmbY.png","b-mail-icon_script-96.png":"//yastatic.net/mail/_/1gQVRZ9DQkWoySBo1oRCZc600aI.png","b-mail-icon_text-96.png":"//yastatic.net/mail/_/pul9J8TXAtaw3TwlvXtzAJFKtFM.png","b-mail-icon_tiff-96.png":"//yastatic.net/mail/_/hI3nzvO38LUhgYD6UTbCQ67gUs.png","b-mail-icon_txt-96.png":"//yastatic.net/mail/_/kPI-yM9sDFPmXC1mjAGFjZg64tQ.png","b-mail-icon_video-96.png":"//yastatic.net/mail/_/T9qiSjBnpup4XIS_9VPNrxxA7gE.png","b-mail-icon_virus-96.png":"//yastatic.net/mail/_/c7-7LIHDn9gn35VLs53nrYeEoVo.png","b-mail-icon_wav-96.png":"//yastatic.net/mail/_/dBbkuXUO90t18quw9kImESDa4U0.png","b-mail-icon_wma-96.png":"//yastatic.net/mail/_/JbDJGtCjr6VPfxmbpRRR2mp0Dpw.png","b-mail-icon_wmv-96.png":"//yastatic.net/mail/_/2ugzLLZgJkfInLi0LylqfNY3cOE.png","b-mail-icon_xls-96.png":"//yastatic.net/mail/_/mAgAE3qireaXknZhZsjImoi-yTk.png","b-mail-icon_zip-96.png":"//yastatic.net/mail/_/pTHgrxWG3uAnHhiLUR5NkrqktFo.png"}),borschik.addLinks({"b-mail-icon_lang-az.gif":"//yastatic.net/mail/_/E5axKlv9j2MvIGHrlTIOBJO9LHs.gif","b-mail-icon_lang-be.gif":"//yastatic.net/mail/_/ftG_g5PBLY3vNpbeycqToQ3F5y8.gif","b-mail-icon_lang-en.gif":"//yastatic.net/mail/_/aa15bRU_q6CoaClAAXU30jTI2R4.gif","b-mail-icon_lang-hy.gif":"//yastatic.net/mail/_/QH9l_KzKNMxmSxRhAz1w1fZ8W1M.gif","b-mail-icon_lang-ka.gif":"//yastatic.net/mail/_/esPrIWqs1JEdi7k41PWvIUeYWLw.gif","b-mail-icon_lang-kk.gif":"//yastatic.net/mail/_/ve196YKlcLJiZ0CECrlNXgKPGSc.gif","b-mail-icon_lang-ro.gif":"//yastatic.net/mail/_/p7vfW6tT5FxXKzQJr5fHFjr8_ls.gif","b-mail-icon_lang-ru.gif":"//yastatic.net/mail/_/FOhHIssLFPx0QqXY9ZyqFHTBaIE.gif","b-mail-icon_lang-tr.gif":"//yastatic.net/mail/_/lVCP1HwuzWTozmjWaas1Govbdpw.gif","b-mail-icon_lang-tt.gif":"//yastatic.net/mail/_/vFhWcwbqbozYzd_hUpysx_-4kPs.gif","b-mail-icon_lang-uk.gif":"//yastatic.net/mail/_/N8TqB6Xn1FnD_lrrQqBbwB1lkI0.gif"}),borschik.addLinks({"starwars.large":"//yastatic.net/mail/_/jH3VxWAbSSs-EE-OQpzHBWeZ_AQ.jpg","starwars.medium":"//yastatic.net/mail/_/uJKg83WkWJipMdsn95Lu_OdObHc.jpg",starwars:"//yastatic.net/mail/_/opwXBCbJze0z14mm7d0KiK-FIdw.jpg","starwars.promo":"//yastatic.net/mail/_/XijQPXsNnw7l9tRcyLt7Xh1wnw.jpg","starwars.promo.en":"//yastatic.net/mail/_/pzBQDsjzLvfuzHgMBECEuoPpPjI.jpg","foxes.large":"//yastatic.net/mail/_/YvZ_FknACq8zT-bOCYxeBEigfb0.jpg","foxes.medium":"//yastatic.net/mail/_/JBNOQj6yKsoRJ1YeiXnghTL29a8.jpg",foxes:"//yastatic.net/mail/_/EnG3cR6c9xGgw29RsrrrPKOvQO0.jpg","galatasaray-net.large":"//yastatic.net/mail/_/GeHKF8gXNJae8QPe7UO8IyiX0e0.jpg","galatasaray-net.medium":"//yastatic.net/mail/_/V29OVdmDubQZSeVU9hgchKFyw8Y.jpg","galatasaray-net":"//yastatic.net/mail/_/bP2FIfcg1s1-jyO7rcatgN0-XCQ.jpg","galatasaray.large":"//yastatic.net/mail/_/ii8PiPTPfkFEl6qP1ybHd75uvwY.jpg","galatasaray.medium":"//yastatic.net/mail/_/K-ArUFsC4r6eDyQ7mKzC94Kr5Y0.jpg",galatasaray:"//yastatic.net/mail/_/lG_5EWqQAcKy-ahbwfE9dMKXYc0.jpg","fenerbahce.large":"//yastatic.net/mail/_/KuM16d70ulKZ5NFl7vbF3cVd_20.jpg","fenerbahce.medium":"//yastatic.net/mail/_/Re1Tmdc6zC7EfBagO4WKpMBMuCw.jpg",fenerbahce:"//yastatic.net/mail/_/e7zohU8lN5FrT43-zKgAhMERSCo.jpg","besiktas.large":"//yastatic.net/mail/_/3E9EaMdaIIXYi0_cJjUmGAUsrZ4.jpg","besiktas.medium":"//yastatic.net/mail/_/FpeY8nKmM7oyqKRo0msgZKbou5k.jpg",besiktas:"//yastatic.net/mail/_/ntQWVQLe53J0k_Zs2xxeDYIzRwY.jpg","belarus.large":"//yastatic.net/mail/_/gwXDlsPba5XtKXPDkEWCz1U6NQI.jpg","belarus.medium":"//yastatic.net/mail/_/9bgd9m46LnkBk42CVUQSmIv9i8Y.jpg",belarus:"//yastatic.net/mail/_/N9-VlobjpXgtSqtq5YEtjnwFlnM.jpg","region_tomsk.large":"//yastatic.net/mail/_/OxEfgmdnnBBn7fmAKhwWifi6Fts.jpg","region_tomsk.medium":"//yastatic.net/mail/_/FQ2aii0nPdFJNyCue0yZDbe94X4.jpg",region_tomsk:"//yastatic.net/mail/_/SbTXrie3V-xwVGpnkwRn8iBzkSs.jpg","region_bashkir.large":"//yastatic.net/mail/_/rGSdyeoyaL3B0u9NS1N7ePYobXo.png","region_bashkir.medium":"//yastatic.net/mail/_/7hD7MKEW4wX0YfRRMWuRob4bNhQ.png",region_bashkir:"//yastatic.net/mail/_/pFPJQgfhHCfpFqYJeCESArjyNNU.png","region_ekb.large":"//yastatic.net/mail/_/MORvGF6NsIwDDkMTZRwKAONwm-4.png","region_ekb.medium":"//yastatic.net/mail/_/U102bnS5FEfoF0g7mu_u7S4MVCo.png",region_ekb:"//yastatic.net/mail/_/XwxOrKOhxaBj42wEq_Esylr-H0.png","region_krasnoyarsk.large":"//yastatic.net/mail/_/i3Y9gOEEMhWCg5SBSGVZvr-RBa4.png","region_krasnoyarsk.medium":"//yastatic.net/mail/_/k-1JvootewfQlzFcCNnc4Y0orRE.png",region_krasnoyarsk:"//yastatic.net/mail/_/rURYSnsn762dgh87tCMkhMG-I8M.png","region_nn.large":"//yastatic.net/mail/_/v73vKaR5yEvebpUwXG-2xC8NGo0.png","region_nn.medium":"//yastatic.net/mail/_/Y5UttajoidNKReewfzm6XY-GSWA.png",region_nn:"//yastatic.net/mail/_/ma4CDMu0QCYCMEESKXZAl_0xZsM.png","region_novosibirsk.large":"//yastatic.net/mail/_/Uao1jc6NOrk1gl-SOcFNK6bXhjs.png","region_novosibirsk.medium":"//yastatic.net/mail/_/vq51lN7YI77kOPzcvCenzVa-sD4.png",region_novosibirsk:"//yastatic.net/mail/_/YN1OdPsIW3ewZingclKNK0Y1dOs.png","region_perm.large":"//yastatic.net/mail/_/6iqr6LYLaekdpodrJiKzMeL1AGs.png","region_perm.medium":"//yastatic.net/mail/_/tzBFJFQa568GHdQfeBm_xCoomnE.png",region_perm:"//yastatic.net/mail/_/M3Yo6rS-k9-1nH2o-SeH3k3SAfg.png","region_primorie.large":"//yastatic.net/mail/_/3bSNWtkb22jGW6GhzJXs5iFmhvA.png","region_primorie.medium":"//yastatic.net/mail/_/rARLL3jgwwiRZ38wmd2gMI48XxE.png",region_primorie:"//yastatic.net/mail/_/nDY2e4nFkU-41a1if7pevpXPCBo.png","region_samara.large":"//yastatic.net/mail/_/0n9Gh-sf7_9FKuLIkhpnK4LCOak.png","region_samara.medium":"//yastatic.net/mail/_/LrTJG2QwISVrLZfZUXVBs_swDu0.png",region_samara:"//yastatic.net/mail/_/ZM5i0VTPLT8vjdWXCEI0BVoJpMg.png","region_tatarstan.large":"//yastatic.net/mail/_/LLPv4H--0LHJfEEYrkM3hq7uK8o.png","region_tatarstan.medium":"//yastatic.net/mail/_/bM920ld0ahc92omMhB_ymfjnRnA.png",region_tatarstan:"//yastatic.net/mail/_/Mj-vZ-Q5IFVB6fbT99pB6yR2RLc.png","region_chelly.large":"//yastatic.net/mail/_/cpBJlPeCAepWvzaG1xYoozw3lwY.png","region_chelly.medium":"//yastatic.net/mail/_/5F5CzGGeMyJNuxEnmWTHS5WBKzI.png",region_chelly:"//yastatic.net/mail/_/lRLC3dABFQMxjn0waWLmT--k8PE.png","region_volgograd.large":"//yastatic.net/mail/_/I5yDR6aLRm36pYa5xEX7bvolQIo.jpg","region_volgograd.medium":"//yastatic.net/mail/_/M9HbQc_aJK534QkwfzyewN4DBWA.jpg",region_volgograd:"//yastatic.net/mail/_/NMY3sOHMhum_EBXjvao-yIyeT1Y.jpg","dreams.large":"//yastatic.net/mail/_/ymbR1IsUnKTHMzcrIpeZbSVu_OY.jpg","dreams.medium":"//yastatic.net/mail/_/yv8gwSDZw_clHshkE3HPSuyC6b8.jpg",dreams:"//yastatic.net/mail/_/ceI2KordFiv7gIdGzsw9qb5IydU.jpg","love_is.large":"//yastatic.net/mail/_/vvMxz3nL6BTBQQQgljczEAIGt5Y.jpg","love_is.medium":"//yastatic.net/mail/_/zu22gxLJX-rRy6f1SmM3QNqNGBg.jpg",love_is:"//yastatic.net/mail/_/Ykt7yD0sj4osvC4lO8FkWxHQ1MM.jpg","nemo.large":"//yastatic.net/mail/_/GSmIevw_CYklIjgB0EngxPZGUck.jpg","nemo.medium":"//yastatic.net/mail/_/_w-_kkFs4PdvUKyA_f2EAoDZHJg.jpg",nemo:"//yastatic.net/mail/_/SIxyID78aU9-FcTVtSvM94v9y9M.jpg","khl.large":"//yastatic.net/mail/_/MGbwTuBDU05LAKD7mYDNknX60gs.jpg","khl.medium":"//yastatic.net/mail/_/FAuGzJyC-HaOT2P5IxU7kuNmTUc.jpg",khl:"//yastatic.net/mail/_/8sTARUuU0rupFd1v5uWM0__ov7c.jpg","traktor.large":"//yastatic.net/mail/_/bvRv52_eh9wxFKTrY8Pqx6wqhVU.jpg","traktor.medium":"//yastatic.net/mail/_/hKnT59uWl2pIJDlXnppoVDAaD8M.jpg",traktor:"//yastatic.net/mail/_/DGVzXaRcd8wTKADJlBqZMCytIwQ.jpg","owls.large":"//yastatic.net/mail/_/AvObsj69_R84ZCk43LnO9pDYpnI.jpg","owls.medium":"//yastatic.net/mail/_/xel50ISiD6MAK9B_nbVEqsp-ISI.jpg",owls:"//yastatic.net/mail/_/FrhperYIx13yBPEgxc80uf-Exbs.jpg","seasons.winter.large":"//yastatic.net/mail/_/Pg6StjeyIWcBje9bCgpVznTKyIc.jpg","seasons.winter.medium":"//yastatic.net/mail/_/ELYtigtpdVNnmxoQ9Nd95saz-W4.jpg","seasons.winter":"//yastatic.net/mail/_/DIuRPTP0q3LeWdX-sttDCeWSCmc.jpg","seasons.newyear.large":"//yastatic.net/mail/_/wvOPNwumHhDA43yNjGUbFsPuyx4.jpg","seasons.newyear.medium":"//yastatic.net/mail/_/9vrmiQPLD6BNxU1h4qhVzwXAvcI.jpg","seasons.newyear":"//yastatic.net/mail/_/o2dgnAq66QMDXyKBTlHftPzciI.jpg","seasons.spring.large":"//yastatic.net/mail/_/netCCBP7uzQshp2qlthK6MlkwWs.jpg","seasons.spring.medium":"//yastatic.net/mail/_/dEho9j95oOOZ58IxJXZIiKB7UYo.jpg","seasons.spring":"//yastatic.net/mail/_/cHB2WV1w-bU_lqkxeLbsRwvVu7M.jpg","seasons.summer.large":"//yastatic.net/mail/_/UV9XhcmUrXFMaVHQmlk_OswD8ao.jpg","seasons.summer.medium":"//yastatic.net/mail/_/6zWLxZ43n9XXbRdEUnylje4XUF4.jpg","seasons.summer":"//yastatic.net/mail/_/8UljBjGEi_dK5eXVcNn3mSg1Z7U.jpg","seasons.autumn.large":"//yastatic.net/mail/_/ZYWiai-kJtJShsPccZzbrUwDynA.jpg","seasons.autumn.medium":"//yastatic.net/mail/_/oxiAWJU1D0yqmr7GzVshsJbXo_A.jpg","seasons.autumn":"//yastatic.net/mail/_/lKiP--MRglu3ajQgJgPJb02WpGg.jpg","zverushki.large":"//yastatic.net/mail/_/FXKvvKXD2GjAutkyHjmeyCHrEfE.jpg","zverushki.medium":"//yastatic.net/mail/_/xGT4e_VqHuk6mllwRdTqTCipBUw.jpg",zverushki:"//yastatic.net/mail/_/P7Q2H7KXYyphsUQbHvnSmeYSgXc.jpg","bears.large":"//yastatic.net/mail/_/1OrH5DH1koKh75Z_TXJv3Jmh1eQ.jpg","bears.medium":"//yastatic.net/mail/_/k1LbbSIWxY41AdrbHCIKjiS0fNk.jpg",bears:"//yastatic.net/mail/_/Wh4KUNSqmk16bFUL6jm37mQvxOA.jpg","weather.large":"//yastatic.net/mail/_/A21s9LTC-XyIQstP9mHUJsItlrM.jpg","weather.medium":"//yastatic.net/mail/_/677tWYJ6MDkocn35Qy81zUfJvjA.jpg",weather:"//yastatic.net/mail/_/NqszcgQED3Wv727MKlrza0XeZzE.jpg","plasticine.large":"//yastatic.net/mail/_/86Dtpcem1IZYbmUzaFS30aMVm3s.jpg","plasticine.medium":"//yastatic.net/mail/_/00z4ZG7a9G4GbeDbx-Fh6ITaqFk.jpg",plasticine:"//yastatic.net/mail/_/DLDgoPvE_vUMM4nPuYGx7LHQGSk.jpg","relax.large":"//yastatic.net/mail/_/JpJ0d7DmV7p1pSGC_07axNWj5-s.jpg","relax.medium":"//yastatic.net/mail/_/GKWFpsguD_CXkRmFvY39_ccJMc4.jpg",relax:"//yastatic.net/mail/_/CGTZDv-gWiE-dr7JW9PPBd6AZws.jpg","newspaper.large":"//yastatic.net/mail/_/OtH4nqPf3mcdyMkDQP2nmD5HhcM.jpg","newspaper.medium":"//yastatic.net/mail/_/BOGN1hDwIDpT4f-BhXNjCLEtt4Q.jpg",newspaper:"//yastatic.net/mail/_/A_bV5AhlZ8ZvgsggguFtc75sBkI.jpg","cosmos.large":"//yastatic.net/mail/_/0T_zbbBpl-AmIMRnbdAXnaANfS0.jpg","cosmos.medium":"//yastatic.net/mail/_/T-RfRRr4qZpITUf3eOOXFjDoEnA.jpg",cosmos:"//yastatic.net/mail/_/x0N25CGfpeZjpw68iIypujvE2Oc.jpg","sea.large":"//yastatic.net/mail/_/EfLq6l2LdG2TIDogIwbSRFRQoBw.jpg","sea.medium":"//yastatic.net/mail/_/qHx10cb8M9-mwn5neV1XUHgmzcw.jpg",sea:"//yastatic.net/mail/_/y0iXzXy0PrMH4avOfoU4et0BnMs.jpg","colorful.large":"//yastatic.net/mail/_/qk055qpQWL5aFqRQKEC4f1GuKyc.jpg","colorful.medium":"//yastatic.net/mail/_/EK-9Lx0x6JuI4Z22ArJbKdDydSM.jpg",colorful:"//yastatic.net/mail/_/cVHCgtBe-LbQl5NIcClwTHXpqNI.jpg","mac.large":"//yastatic.net/mail/_/k3uYwy274EKp13eaaUZuBdPBmbA.jpg","mac.medium":"//yastatic.net/mail/_/YvHKWQrtHm2IgJZoRRTYBjFo5iE.jpg",mac:"//yastatic.net/mail/_/M-EHPjBG6QK_Cwy2TcjJ61nN-_U.jpg","mac.large.en":"//yastatic.net/mail/_/XZLuzWSeMubw8o5C8CIFPXsx_M.jpg","mac.medium.en":"//yastatic.net/mail/_/xt6YiiyLBiLEhx0pD0VmOPUnwq8.jpg","mac.en":"//yastatic.net/mail/_/3JOTF9LnXP8GeJG9DX3vSWdrp_M.jpg","white.large":"//yastatic.net/mail/_/TnN-oMtFjcZwRH-fELlawVSHKP0.jpg","white.medium":"//yastatic.net/mail/_/AmM9x1aoLqeaaaZpjZtFPrcPRIs.jpg",white:"//yastatic.net/mail/_/123wICEa8PBvgkevwVj4Zu_Qbgs.jpg","white.large.en":"//yastatic.net/mail/_/4c47TAGmlFL51pw079R-C0XRS2o.jpg","white.medium.en":"//yastatic.net/mail/_/A4uMcbNnJ9z6m2v1ky3tsR2AvZk.jpg","white.en":"//yastatic.net/mail/_/L7h6NgTc4zzlDaJqQK8jhDF8TSk.jpg","big.large":"//yastatic.net/mail/_/PTfBDk2xTr8jcKNf2_z5k_v-U_o.jpg","big.medium":"//yastatic.net/mail/_/5fCRrT5XEB6btAJrR9naSgzJtaA.jpg",big:"//yastatic.net/mail/_/gu6oYNqVt7dG6l_oh2ERyWmwQWY.jpg","big.large.en":"//yastatic.net/mail/_/K0enCYgoXZifSNN4npHc34AvlH0.jpg","big.medium.en":"//yastatic.net/mail/_/8NKnh-S5D8vEzJPHVCYa7UoO6kQ.jpg","big.en":"//yastatic.net/mail/_/_ZA8pAZscdCi3wVKsdrYmn7JRDI.jpg","grass.large":"//yastatic.net/mail/_/y8uAJA4qNjRDJo6PuUW-es5mdmc.jpg","grass.medium":"//yastatic.net/mail/_/J4ev_lTedOL3Zp4XIU21l8ET0G0.jpg",grass:"//yastatic.net/mail/_/vPtyLounC7yEfFxWYwRgAb7jo_o.jpg","orangetree.large":"//yastatic.net/mail/_/mJBkGwqJ2I0WvOvjt2EZaKZZTxY.jpg","orangetree.medium":"//yastatic.net/mail/_/5WpdcapVodLwwVQR5rBKA-u-yNg.jpg",orangetree:"//yastatic.net/mail/_/aR6cjbcnkf6jZSMppr3f4laUVd4.jpg","lamp.large":"//yastatic.net/mail/_/vAmzUh5XZvZIXFCJicSbGeQYK0c.jpg","lamp.medium":"//yastatic.net/mail/_/n7mM0nPcMrvWGX-EkfMi4luXgCI.jpg",lamp:"//yastatic.net/mail/_/mRkARLH2FethwbAdrdes1QxvWOQ.jpg","stitch.large":"//yastatic.net/mail/_/SWCgePbkdj2BrabPKKHratq038I.jpg","stitch.medium":"//yastatic.net/mail/_/2P_bZWUAG_NU-i9IM2zd8GlTKZc.jpg",stitch:"//yastatic.net/mail/_/41clYJowVYwlNBlseMFO5YFoFho.jpg","pinkbear.large":"//yastatic.net/mail/_/NTcocUaYi5OpTABbWnLhpdahvEE.jpg","pinkbear.medium":"//yastatic.net/mail/_/jacHHe6eLuiHKsXuQBN4BoLruvE.jpg",pinkbear:"//yastatic.net/mail/_/KzccXmrSYQjmlg2Pb3JitPjWHFM.jpg","cat.large":"//yastatic.net/mail/_/kocQp7ZKzjAIkI9XvslysU5WjA0.jpg","cat.medium":"//yastatic.net/mail/_/KhhVuFPSFM6ApIOXBrxmLi3QKfo.jpg",cat:"//yastatic.net/mail/_/F5Y2BcGUfX6vsRNUCUJ4-32IG0k.jpg","soccer.large":"//yastatic.net/mail/_/yew5wni_vy9SDA8TcLAh497MA3M.jpg","soccer.medium":"//yastatic.net/mail/_/jXT9vsBIyAUd65-boy1LmOlVZMM.jpg",soccer:"//yastatic.net/mail/_/6WErmpP2iTrKpnUtLCTQsXuHpYo.jpg","capitals.large":"//yastatic.net/mail/_/JuDHsH-Qm8dk8dVtAWfbDXmiqG8.jpg","capitals.medium":"//yastatic.net/mail/_/A6bRaXmOO0JKP334AB4WoXVriY4.jpg",capitals:"//yastatic.net/mail/_/bYiHGpcVpij5-06ywVD0xAdj9_A.jpg","dandelions.large":"//yastatic.net/mail/_/T1ZG-ZGvMIk8qijBZJGDb3cMJ4A.jpg","dandelions.medium":"//yastatic.net/mail/_/uzzJCTe7Ht4-wBdWUWC-hNLQH8U.jpg",dandelions:"//yastatic.net/mail/_/vvxIPajo9LUo92pafAfUivr-LPE.jpg","red-list.large":"//yastatic.net/mail/_/J7-PcH648QVBJpVf6L8CvAWzUHQ.jpg","red-list.medium":"//yastatic.net/mail/_/7R7X1bzuFj7_hZ55Lgdu72DvG2I.jpg","red-list":"//yastatic.net/mail/_/0kxG3n8l7udPvP6VVECjJ4HjAM4.jpg","art.large":"//yastatic.net/mail/_/0HkPwC00aaPEdqChxR3iHK4c4ts.jpg","art.medium":"//yastatic.net/mail/_/xJJconuP2pMh6d-9Wnr5qfHn_dM.jpg",art:"//yastatic.net/mail/_/8CEr0tQvbwFBqEUv-fnV0dn5RPg.jpg","anime.large":"//yastatic.net/mail/_/QC09XCCU2N6_7v6L5lDNTrLHUrA.jpg","anime.medium":"//yastatic.net/mail/_/RL9ZASW7xc4tr0xu7iyozXbOuSk.jpg",anime:"//yastatic.net/mail/_/1sHg5hujveslIOUzH3NneL4xhUw.jpg","ice-cream.large":"//yastatic.net/mail/_/GD3y-c-R_2_UehsLhzDfbHRMlM0.jpg","ice-cream.medium":"//yastatic.net/mail/_/5cydvzuwAo7TuJPgG_plBuDzYoE.jpg","ice-cream":"//yastatic.net/mail/_/rQmtY2xPuqS_-GCo13SuQ8NDZEo.jpg","pushkin.large":"//yastatic.net/mail/_/wNQo3EC6MpH6YGDws_PcmtrP7Q4.jpg","pushkin.medium":"//yastatic.net/mail/_/dHcyS2ylEcIn4wo9XHiV9pi6vmM.jpg",pushkin:"//yastatic.net/mail/_/jBmb0KBVsWrB1Ybc6kZ1urPWqAQ.jpg","kitekat.large":"//yastatic.net/mail/_/ZiMMdfoxNOB2RbwTAHDtDUb8LGw.jpg","kitekat.medium":"//yastatic.net/mail/_/Wp9n38q8Yz7IfOSxxKCnBRY20LY.jpg",kitekat:"//yastatic.net/mail/_/cDhm38WcH15JgWEmXUeLw1_106U.jpg","kindergarten.large":"//yastatic.net/mail/_/WzYFIJpCK7sEqld3NvVstAUDReM.jpg","kindergarten.medium":"//yastatic.net/mail/_/RQ18MaZczmMMFCQ_ruaAcTCE4CI.jpg",kindergarten:"//yastatic.net/mail/_/rb39OVKJn3f5YcmjfeOOLSzP-f8.jpg","origami.large":"//yastatic.net/mail/_/DFXJNoswHPCv0CeDRxMV8CPJnFA.jpg","origami.medium":"//yastatic.net/mail/_/WlpmuW7RSvfQ3z0NxWufG3KDlNE.jpg",origami:"//yastatic.net/mail/_/k7IiuUuY1mLKD5obMOSTXbpyxgk.jpg","newyear2010.large":"//yastatic.net/mail/_/v0FjNY2nD5oScWgK_ST5JkgiYNo.jpg","newyear2010.medium":"//yastatic.net/mail/_/JbcHtsMx-Z2JlN8HFsbZr3duUJw.jpg",newyear2010:"//yastatic.net/mail/_/rpQsarnxfKXr_lyfxjTgMbJvvQo.jpg","olympics.large":"//yastatic.net/mail/_/sEat8Z2kv9AYk6YqLUKrvCVw1x4.jpg","olympics.medium":"//yastatic.net/mail/_/nl95vmn6JEJOQOGAiqgD_oLJjBY.jpg",olympics:"//yastatic.net/mail/_/_eQ1XRo_rT09YitC-Z3Sbxmfe8.jpg"}),borschik.addLinks({icon_file_ai:"//yastatic.net/mail/_/xuM49Ob1OFijOGr4FMTI_ch8Xts.svg",icon_file_ai_small:"//yastatic.net/mail/_/_EMw12WbSt_3PpHBA7PySpv8E6s.svg",icon_file_application:"//yastatic.net/mail/_/FHZRES1zl-BUpOgzKuwXVGdEFeI.svg",icon_file_application_small:"//yastatic.net/mail/_/muKiyM98GidgJS-kSNuXR0XfO30.svg",icon_file_archive:"//yastatic.net/mail/_/O0WyhfOBKKFm9TOOyD7peNZ_HeI.svg",icon_file_archive_small:"//yastatic.net/mail/_/PhlYOEx62Rms4bIQNLv0nl4VguE.svg",icon_file_audio:"//yastatic.net/mail/_/rvKm4E-f-TOxzNkIVgr6KNkfJ_w.svg",icon_file_audio_small:"//yastatic.net/mail/_/j_AKosZLbwe8rHSiGNqB5Xcgfhc.svg",icon_file_avi:"//yastatic.net/mail/_/FfjJ7D0FlePtBWn3shij4NnArrs.svg",icon_file_avi_small:"//yastatic.net/mail/_/neY95k5-jgygwaXHjEvuP5Qsv0U.svg",icon_file_bmp:"//yastatic.net/mail/_/wprNkaEDrcn7R9k5LlLbYFCQFaY.svg",icon_file_bmp_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_book:"//yastatic.net/mail/_/Si9TTC3wT4glCXZGDJsBrYl13TU.svg",icon_file_book_small:"//yastatic.net/mail/_/nGTCJ3k_jgw3FlE_O5fq1GcUvU.svg",icon_file_cdr:"//yastatic.net/mail/_/PZQKI4jqyDxpP8fVmW71KRYSmvM.svg",icon_file_cdr_small:"//yastatic.net/mail/_/mXeUMig1HtUAjJSgMbLrit6sFTc.svg",icon_file_csv:"//yastatic.net/mail/_/s4cU5TSyBhkZx65uA9pD2Dca0OM.svg",icon_file_csv_small:"//yastatic.net/mail/_/sJVf9D-u4vwfz1yWZtmrzkCxQPE.svg",icon_file_development:"//yastatic.net/mail/_/jq0gq0B_S8h8vFIMol7Q9X_gc38.svg",icon_file_development_small:"//yastatic.net/mail/_/AX-QbSVKIKWbEPiedI7AGnwQbzA.svg",icon_file_djvu:"//yastatic.net/mail/_/kzwzeB1k3L55u7wlF7TmDfJWiyI.svg",icon_file_djvu_small:"//yastatic.net/mail/_/CapmvxxHIyi78bjDxn1fbLDMI98.svg",icon_file_doc:"//yastatic.net/mail/_/xvZAn760kAKCV-TDm7ChvbAABUg.svg",icon_file_doc_small:"//yastatic.net/mail/_/EnBD-6MA6g8wyeMByaLUl2VwLL8.svg",icon_file_eml:"//yastatic.net/mail/_/gpITbcvNNvoR1tXt0uYuYhLT3DE.svg",icon_file_eml_small:"//yastatic.net/mail/_/QiNEAjB6s76z7PPdL2KjD2BqPdE.svg",icon_file_exe:"//yastatic.net/mail/_/_zfH2EqlM5qhI8EbQqVfU-MznVQ.svg",icon_file_exe_small:"//yastatic.net/mail/_/muKiyM98GidgJS-kSNuXR0XfO30.svg",icon_file_executable:"//yastatic.net/mail/_/LJ6-RTbnJPJMGXJR-1ggBzrNiQ.svg",icon_file_executable_small:"//yastatic.net/mail/_/muKiyM98GidgJS-kSNuXR0XfO30.svg",icon_file_flash:"//yastatic.net/mail/_/cLJcBqH7qjxGAXt8r8I_bC0Hqvc.svg",icon_file_flash_small:"//yastatic.net/mail/_/FaJ-LCItG2D9-cYjaZQMQUlGbN0.svg",icon_file_font:"//yastatic.net/mail/_/_IVnUkXDnmqz-YY5DJIWE_SDxYY.svg",icon_file_font_small:"//yastatic.net/mail/_/aaueN-_f27Ab64dkJQfr8TMgnnc.svg",icon_file_general:"//yastatic.net/mail/_/bmH1X4bL2FRG6kAohh8B2eXWMzc.svg",icon_file_general_small:"//yastatic.net/mail/_/utdE8wevFvJREoPI26mNiq0dvC0.svg",icon_file_gif:"//yastatic.net/mail/_/Os4LV6NCI47HIePzqi3TcilqFYE.svg",icon_file_gif_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_image:"//yastatic.net/mail/_/TLXPeAl-NY6u6asXLd2YbpN_mPU.svg",icon_file_image_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_jpg:"//yastatic.net/mail/_/RJa879VEtYPN5vzDIOC4fHjXLd4.svg",icon_file_jpg_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_mail:"//yastatic.net/mail/_/TeX8yF0F4DRHC3tZS4rbFuxD5O0.svg",icon_file_mail_small:"//yastatic.net/mail/_/QiNEAjB6s76z7PPdL2KjD2BqPdE.svg",icon_file_mov:"//yastatic.net/mail/_/xrDlNrpKygN9sbE5aA9MVeMNpY0.svg",icon_file_mov_small:"//yastatic.net/mail/_/j2p0ifrgBnLwOsqYoafyGSJHXfY.svg",icon_file_mp3:"//yastatic.net/mail/_/e0UJNhMHwoAiTYKLde3uWc-7ruM.svg",icon_file_mp3_small:"//yastatic.net/mail/_/j_AKosZLbwe8rHSiGNqB5Xcgfhc.svg",icon_file_mp4:"//yastatic.net/mail/_/if8yd3m2912qBSJl_95Vt-q28i4.svg",icon_file_mp4_small:"//yastatic.net/mail/_/neY95k5-jgygwaXHjEvuP5Qsv0U.svg",icon_file_none:"//yastatic.net/mail/_/jAwgghigJ6Z3UzCAM17DWtaImXE.svg",icon_file_none_small:"//yastatic.net/mail/_/mcN6NmveKTREEKdtAidV7kb4UVs.svg",icon_file_odp:"//yastatic.net/mail/_/l3RH9FMGg55AFfrHwKRw1eZ3NPI.svg",icon_file_odp_small:"//yastatic.net/mail/_/5fIdPYKsVrP8tugd19YicF2yRas.svg",icon_file_ods:"//yastatic.net/mail/_/MTf3xtQqChhioDyVfL8G1He5ny4.svg",icon_file_ods_small:"//yastatic.net/mail/_/V30c85YUSnWBG8ZcxKmvk0Zhweg.svg",icon_file_odt:"//yastatic.net/mail/_/laVH8rsJBaDiC3ElR3q_WKF6OgQ.svg",icon_file_odt_small:"//yastatic.net/mail/_/MnM0bZUWD28FPffNjWfd2IzSu-Y.svg",icon_file_pcx:"//yastatic.net/mail/_/mOKlqfG60xcCb_t0Zi408jz79LU.svg",icon_file_pcx_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_pdf:"//yastatic.net/mail/_/96okHSl596D1NwCm7vrdpAtvb2E.svg",icon_file_pdf_small:"//yastatic.net/mail/_/BDUGuHHwzPmD05hevDqVedgzGHQ.svg",icon_file_pls:"//yastatic.net/mail/_/JvTSc2X4tQev85Xxio3uGM6g8ws.svg",icon_file_pls_small:"//yastatic.net/mail/_/j_AKosZLbwe8rHSiGNqB5Xcgfhc.svg",icon_file_png:"//yastatic.net/mail/_/BX94Nsfhksezv1LAq8T15wuzyLU.svg",icon_file_png_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_ppt:"//yastatic.net/mail/_/4-vjwhvcZ5QeulZmsa8_RaRdULA.svg",icon_file_ppt_small:"//yastatic.net/mail/_/rwwVa0rBKc1erjM5AhtREWCM-hE.svg",icon_file_psd:"//yastatic.net/mail/_/3snRmKEye_d3CVlODxVDuRUERBU.svg",icon_file_psd_small:"//yastatic.net/mail/_/sfj30x7Kd6hDsoDNbt7jq4XHQrg.svg",icon_file_rar:"//yastatic.net/mail/_/RpQ_FPyzUPc9gfjc8ep6DQ_wnUA.svg",icon_file_rar_small:"//yastatic.net/mail/_/PhlYOEx62Rms4bIQNLv0nl4VguE.svg",icon_file_rtf:"//yastatic.net/mail/_/mNZs1N2dsrkPFywuwjyusUm3KOc.svg",icon_file_rtf_small:"//yastatic.net/mail/_/MnM0bZUWD28FPffNjWfd2IzSu-Y.svg",icon_file_script:"//yastatic.net/mail/_/jq0gq0B_S8h8vFIMol7Q9X_gc38.svg",icon_file_script_small:"//yastatic.net/mail/_/AX-QbSVKIKWbEPiedI7AGnwQbzA.svg",icon_file_srt:"//yastatic.net/mail/_/969-i_IbV7y3XZMRJeK7euefcbQ.svg",icon_file_srt_small:"//yastatic.net/mail/_/neY95k5-jgygwaXHjEvuP5Qsv0U.svg",icon_file_text:"//yastatic.net/mail/_/SSMsqiRwIfN6ypU66CxZetMHGUI.svg",icon_file_text_small:"//yastatic.net/mail/_/MnM0bZUWD28FPffNjWfd2IzSu-Y.svg",icon_file_tiff:"//yastatic.net/mail/_/lGVJ7WhggtkNUVmMYGv6TV_eSNE.svg",icon_file_tiff_small:"//yastatic.net/mail/_/fgtDk2SCScJPiPVBbVZ8oCJWXmw.svg",icon_file_txt:"//yastatic.net/mail/_/wBKh8gmg_Ttuz8h8xk0r2n32ni4.svg",icon_file_txt_small:"//yastatic.net/mail/_/MnM0bZUWD28FPffNjWfd2IzSu-Y.svg",icon_file_video:"//yastatic.net/mail/_/NaPlXI5ED4CXO5yGiBXrt_70D3k.svg",icon_file_video_small:"//yastatic.net/mail/_/neY95k5-jgygwaXHjEvuP5Qsv0U.svg",icon_file_virus:"//yastatic.net/mail/_/ipkRBrZC0cFCInHkhXjTbImKFk.svg",icon_file_virus_small:"//yastatic.net/mail/_/T1vi8FrHVIZpJ8DJoDkgXWLJjoM.svg",icon_file_wav:"//yastatic.net/mail/_/GT4I5wfeuQKc9wQfyqycz5Kb-rM.svg",icon_file_wav_small:"//yastatic.net/mail/_/j_AKosZLbwe8rHSiGNqB5Xcgfhc.svg",icon_file_wma:"//yastatic.net/mail/_/JexD_hX7c_FPgQXbGC_erjFn3xA.svg",icon_file_wma_small:"//yastatic.net/mail/_/j_AKosZLbwe8rHSiGNqB5Xcgfhc.svg",icon_file_wmv:"//yastatic.net/mail/_/He3QpXXZNfut4-lrjRcj0uoGKWo.svg",icon_file_wmv_small:"//yastatic.net/mail/_/neY95k5-jgygwaXHjEvuP5Qsv0U.svg",icon_file_xls:"//yastatic.net/mail/_/Dbsn83E9wfWU0gqYwK16FACKG4A.svg",icon_file_xls_small:"//yastatic.net/mail/_/JXH6jEkIO7-5ZGy76TveqG-9EAY.svg",icon_file_zip:"//yastatic.net/mail/_/uUd-b_fBiuienA1KjQd6Q4PTE7k.svg",icon_file_zip_small:"//yastatic.net/mail/_/PhlYOEx62Rms4bIQNLv0nl4VguE.svg"}),borschik.addLinks({"theme-thumb-anime":"//yastatic.net/mail/neo2/_themes/QC09XCCU2N6_7v6L5lDNTrLHUrA.jpg","theme-thumb-art":"//yastatic.net/mail/neo2/_themes/0HkPwC00aaPEdqChxR3iHK4c4ts.jpg","theme-thumb-bears":"//yastatic.net/mail/neo2/_themes/1OrH5DH1koKh75Z_TXJv3Jmh1eQ.jpg","theme-thumb-belarus":"//yastatic.net/mail/neo2/_themes/gwXDlsPba5XtKXPDkEWCz1U6NQI.jpg","theme-thumb-besiktas":"//yastatic.net/mail/neo2/_themes/NblNgDpCJNlb3cCZf608mDmG2d8.jpg","theme-thumb-big":"//yastatic.net/mail/neo2/_themes/PTfBDk2xTr8jcKNf2_z5k_v-U_o.jpg","theme-thumb-capitals":"//yastatic.net/mail/neo2/_themes/JuDHsH-Qm8dk8dVtAWfbDXmiqG8.jpg","theme-thumb-cat":"//yastatic.net/mail/neo2/_themes/kocQp7ZKzjAIkI9XvslysU5WjA0.jpg","theme-thumb-colorful":"//yastatic.net/mail/neo2/_themes/qk055qpQWL5aFqRQKEC4f1GuKyc.jpg","theme-thumb-cosmos":"//yastatic.net/mail/neo2/_themes/0T_zbbBpl-AmIMRnbdAXnaANfS0.jpg","theme-thumb-dandelions":"//yastatic.net/mail/neo2/_themes/kCdjXu9RL5Mcv5286yaylEu5ho8.jpg","theme-thumb-dreams":"//yastatic.net/mail/neo2/_themes/ymbR1IsUnKTHMzcrIpeZbSVu_OY.jpg","theme-thumb-fenerbahce":"//yastatic.net/mail/neo2/_themes/BGwTt8KeMY0vOce3924Gyt1dJog.jpg","theme-thumb-foxes":"//yastatic.net/mail/neo2/_themes/YvZ_FknACq8zT-bOCYxeBEigfb0.jpg","theme-thumb-galatasaray":"//yastatic.net/mail/neo2/_themes/ii8PiPTPfkFEl6qP1ybHd75uvwY.jpg","theme-thumb-galatasaray-net":"//yastatic.net/mail/neo2/_themes/HEgMS9u_nXGHz_mm3mxItt3b0cs.jpg","theme-thumb-grass":"//yastatic.net/mail/neo2/_themes/y8uAJA4qNjRDJo6PuUW-es5mdmc.jpg","theme-thumb-ice-cream":"//yastatic.net/mail/neo2/_themes/GD3y-c-R_2_UehsLhzDfbHRMlM0.jpg","theme-thumb-khl":"//yastatic.net/mail/neo2/_themes/MGbwTuBDU05LAKD7mYDNknX60gs.jpg","theme-thumb-kindergarten":"//yastatic.net/mail/neo2/_themes/WzYFIJpCK7sEqld3NvVstAUDReM.jpg","theme-thumb-kitekat":"//yastatic.net/mail/neo2/_themes/ZiMMdfoxNOB2RbwTAHDtDUb8LGw.jpg","theme-thumb-lamp":"//yastatic.net/mail/neo2/_themes/vAmzUh5XZvZIXFCJicSbGeQYK0c.jpg","theme-thumb-love_is":"//yastatic.net/mail/neo2/_themes/vvMxz3nL6BTBQQQgljczEAIGt5Y.jpg","theme-thumb-mac":"//yastatic.net/mail/neo2/_themes/k3uYwy274EKp13eaaUZuBdPBmbA.jpg","theme-thumb-nemo":"//yastatic.net/mail/neo2/_themes/GSmIevw_CYklIjgB0EngxPZGUck.jpg","theme-thumb-newspaper":"//yastatic.net/mail/neo2/_themes/OtH4nqPf3mcdyMkDQP2nmD5HhcM.jpg","theme-thumb-newyear2010":"//yastatic.net/mail/neo2/_themes/v0FjNY2nD5oScWgK_ST5JkgiYNo.jpg","theme-thumb-olympics":"//yastatic.net/mail/neo2/_themes/83cpji0x6vqEm88ed3xvRdZOFSM.jpg","theme-thumb-orangetree":"//yastatic.net/mail/neo2/_themes/mJBkGwqJ2I0WvOvjt2EZaKZZTxY.jpg","theme-thumb-origami":"//yastatic.net/mail/neo2/_themes/DFXJNoswHPCv0CeDRxMV8CPJnFA.jpg","theme-thumb-owls":"//yastatic.net/mail/neo2/_themes/AvObsj69_R84ZCk43LnO9pDYpnI.jpg","theme-thumb-pinkbear":"//yastatic.net/mail/neo2/_themes/NTcocUaYi5OpTABbWnLhpdahvEE.jpg","theme-thumb-plasticine":"//yastatic.net/mail/neo2/_themes/86Dtpcem1IZYbmUzaFS30aMVm3s.jpg","theme-thumb-pushkin":"//yastatic.net/mail/neo2/_themes/wNQo3EC6MpH6YGDws_PcmtrP7Q4.jpg","theme-thumb-red-list":"//yastatic.net/mail/neo2/_themes/J7-PcH648QVBJpVf6L8CvAWzUHQ.jpg","theme-thumb-region_bashkir":"//yastatic.net/mail/neo2/_themes/LIae4Nre3Usu-JtCEKsivz9bcVo.jpg","theme-thumb-region_chelly":"//yastatic.net/mail/neo2/_themes/61CLD8cZkkeLK0lLtPEGBc4GHA0.jpg","theme-thumb-region_ekb":"//yastatic.net/mail/neo2/_themes/xViB3zYspTgAR93f_0tk3_l1p6o.jpg","theme-thumb-region_krasnoyarsk":"//yastatic.net/mail/neo2/_themes/JC11eJC1CbXWYR6jlK8AVQYPBOM.jpg","theme-thumb-region_nn":"//yastatic.net/mail/neo2/_themes/Q1sG1zFjvpT4jLrVesqrRKdbI9Q.jpg","theme-thumb-region_novosibirsk":"//yastatic.net/mail/neo2/_themes/B2fnZDK4-4OgM4sawnhcon_Pq2I.jpg","theme-thumb-region_perm":"//yastatic.net/mail/neo2/_themes/O3Q5GgQdGI8YZRXF0zGYf9nbERo.jpg","theme-thumb-region_primorie":"//yastatic.net/mail/neo2/_themes/_74yH2a6qfHEkUxyLooWCpZwy28.jpg","theme-thumb-region_samara":"//yastatic.net/mail/neo2/_themes/ITlA-e2XNRqLJYa4ArZXr-XlLKQ.jpg","theme-thumb-region_tatarstan":"//yastatic.net/mail/neo2/_themes/WWyBCL5wilfwgyieg1t84sCGtiU.jpg","theme-thumb-region_tomsk":"//yastatic.net/mail/neo2/_themes/OxEfgmdnnBBn7fmAKhwWifi6Fts.jpg","theme-thumb-region_volgograd":"//yastatic.net/mail/neo2/_themes/I5yDR6aLRm36pYa5xEX7bvolQIo.jpg","theme-thumb-relax":"//yastatic.net/mail/neo2/_themes/JpJ0d7DmV7p1pSGC_07axNWj5-s.jpg","theme-thumb-sea":"//yastatic.net/mail/neo2/_themes/EfLq6l2LdG2TIDogIwbSRFRQoBw.jpg","theme-thumb-seasons-winter":"//yastatic.net/mail/neo2/_themes/5OnPbgCW966K5vMD13rEntNBwoE.jpg","theme-thumb-seasons-spring":"//yastatic.net/mail/neo2/_themes/GPkdNPOWxkKxvfj1KYA7agk5Nf8.jpg","theme-thumb-seasons-summer":"//yastatic.net/mail/neo2/_themes/DO6_4e7mUoTCUHchzBAE-PahpCA.jpg","theme-thumb-seasons-autumn":"//yastatic.net/mail/neo2/_themes/jCeRxcS1gj2NPWmcwxrkYFYTFRg.jpg","theme-thumb-seasons-newyear":"//yastatic.net/mail/neo2/_themes/L_3y6qaKtRBKVL1Rgo-H8flthE4.jpg","theme-thumb-soccer":"//yastatic.net/mail/neo2/_themes/yew5wni_vy9SDA8TcLAh497MA3M.jpg","theme-thumb-starwars":"//yastatic.net/mail/neo2/_themes/jH3VxWAbSSs-EE-OQpzHBWeZ_AQ.jpg","theme-thumb-stitch":"//yastatic.net/mail/neo2/_themes/SWCgePbkdj2BrabPKKHratq038I.jpg","theme-thumb-tanks":"//yastatic.net/mail/neo2/_themes/2uibop__fS9819D7D9Vg2uX6sQc.png","theme-thumb-traktor":"//yastatic.net/mail/neo2/_themes/bvRv52_eh9wxFKTrY8Pqx6wqhVU.jpg","theme-thumb-u2709":"//yastatic.net/mail/neo2/_themes/JObtpaxjMizjEwz8wN5E1heK5Pc.jpg","theme-thumb-weather":"//yastatic.net/mail/neo2/_themes/A21s9LTC-XyIQstP9mHUJsItlrM.jpg","theme-thumb-white":"//yastatic.net/mail/neo2/_themes/TnN-oMtFjcZwRH-fELlawVSHKP0.jpg","theme-thumb-zverushki":"//yastatic.net/mail/neo2/_themes/FXKvvKXD2GjAutkyHjmeyCHrEfE.jpg"}),borschik.addLinks({"mail-Promo-MailAppLink-ru.png":"//yastatic.net/mail/_/qczBVMJThQKeNnrH8JBIvtqGzCA.png","mail-Promo-MailAppLink-ru@2x.png":"//yastatic.net/mail/_/SRYedCJopG2X42eIDKtId0wOe68.png","mail-Promo-MailAppLink-en.png":"//yastatic.net/mail/_/2EGSmPblCwEJs0fzdFx_UXTg25A.png","mail-Promo-MailAppLink-en@2x.png":"//yastatic.net/mail/_/neXFHMMlDRpVedISvk08Yy4kwfQ.png","mail-Promo-MailAppLink-uk.png":"//yastatic.net/mail/_/9gpHK4XV0pwUmOnX3aD9RizIuKE.png","mail-Promo-MailAppLink-uk@2x.png":"//yastatic.net/mail/_/EFlNyIP4Qw9KLLb49X_UoIUoSPw.png","mail-Promo-MailAppLink-tr.png":"//yastatic.net/mail/_/ajcHhAwk97evCGZ2x3x9dmkqfKM.png","mail-Promo-MailAppLink-tr@2x.png":"//yastatic.net/mail/_/_-k-JIt4H2jIfkJyj0zxF2NH6UQ.png","mail-Promo-MailAppLink2-ru.png":"//yastatic.net/mail/_/GrzJFC8itwRND0mNwKBOJxhWM8.png","mail-Promo-MailAppLink2-ru@2x.png":"//yastatic.net/mail/_/C2Hg9EhBhd5W0tRLz3gtSK07ZUM.png","mail-Promo-MailAppLink2-en.png":"//yastatic.net/mail/_/GrzJFC8itwRND0mNwKBOJxhWM8.png","mail-Promo-MailAppLink2-en@2x.png":"//yastatic.net/mail/_/C2Hg9EhBhd5W0tRLz3gtSK07ZUM.png","mail-Promo-MailAppLink2-uk.png":"//yastatic.net/mail/_/GrzJFC8itwRND0mNwKBOJxhWM8.png","mail-Promo-MailAppLink2-uk@2x.png":"//yastatic.net/mail/_/C2Hg9EhBhd5W0tRLz3gtSK07ZUM.png","mail-Promo-MailAppLink2-tr.png":"//yastatic.net/mail/_/GrzJFC8itwRND0mNwKBOJxhWM8.png","mail-Promo-MailAppLink2-tr@2x.png":"//yastatic.net/mail/_/C2Hg9EhBhd5W0tRLz3gtSK07ZUM.png"}),function(){var e=function(e){return e=e||ns.page.current.page,"404"===e||"not-found"===e||"no-message"===e
},t={logo:{},"promo-default-mail-box@":function(){var e=ns.Model.get("settings").isSet("u2709");return e?null:{"promo-default-mail":{}}},"bug-report-box@":function(){return Daria.IS_CORP?{"bug-report":{}}:{}},notifications:{},"left-box@":{},"right-box@":{},"infoline-box@":{infoline:{}},"toolbar-box@":{},"service-box@":{},"more-services-box@":function(){var e=ns.Model.get("settings");return e.isCompactHeaderMode()&&Daria.isSettingsPage()?{"more-services":{}}:{}},"search-box@":{search:{}},loader:{},"head-tabs":{},"head-user":{},"timeline-wrap&":{},"compose-sidebar-wrap":{"compose-sidebar-popup":{}},"themes-skin-rotater-box@":function(){var e={};
return e["skin-rotater-"+Daria.themeId]={},e},"themes-header-box@":function(){var t=Daria.themes.headers;return e()?t._default:t[Daria.themeId]||t._default},"themes-footer-wrapper@":function(){var t=ns.Model.get("settings");return t.isCompactMode()||t.isCompactHeaderMode()||Daria.is3pane()?!1:{"themes-footer-box@":function(){var t=Daria.themes.footers;return e()?t._default:t[Daria.themeId]||t._default}}},"themes-selector-box@":function(){if(ns.Model.get("themes-selector").isOpened()){var e={},t=ns.Model.get("themes").get(".themes.*.settings");
return t.forEach(function(t){e[t]={}}),{"themes-selector":e}}return{}},"messages-time-updater":{}};Daria.Config["inline-icons"]||_.extend(t,{"boot-icons":{},"mail-icons":{}}),ns.layout.define("common",{app:_.extend({},t,{"messages-direct-box@":function(){var e=ns.Model.get("settings").getSetting("show_advertisement");return Daria.is2pane()&&e?{"messages-direct":{}}:{}}})}),ns.layout.define("common-d",{app:t})}(),function(){var e={folders:{},"folders-setup":{},"messages-filters":{"messages-filters-box@":function(){var e={"messages-filters-wait":{},"messages-filters-important":{},"messages-filters-unread":{},"messages-filters-attachments":{}},t=ns.Model.get("labels"),i=t.getWaitingForReplyLabel();
return i&&0!==i.count||delete e["messages-filters-wait"],e}},labels:{},"labels-setup":{},"collectors&":{},"collectors-setup&":{},"left-col-toolbar":{}};Jane.Config.MAY_HAVE_ADV&&(e.banner={}),Jane.Config.MAY_HAVE_NEWS&&(e["informer-box@"]=function(){var e=ns.page.current.page,t=Boolean(!window.opener&&"404"!==e&&"403"!==e&&-1===e.indexOf("setup"));return t?{"informer-news&":{}}:void 0}),e["skin-saver-box@"]=function(){var e=ns.Model.get("themes").getCurrentTheme().hasSkinSaver(),t={};return e&&(t["skin-saver"]={}),t
},e["copyright-box@"]=function(){var e={},t=ns.Model.get("theme-"+Daria.getThemeId()).get(".copyright");return t&&(e["copyright-"+t]={}),e},Daria.is3pane()&&(e.footer={"footer-journal-link&":{},"footer-help-link":{}}),ns.layout.define("common+left+toolbar-compose",{"app toolbar-box@":{toolbar:{"search-box@":{search:{}},"toolbar-buttons-box@":"toolbar-buttons-compose"}}},"common+left+toolbar"),_.each(["common","common-d"],function(t){var i=t+"+left+toolbar";ns.layout.define(i,{"app left-box@":e,"app toolbar-box@":{toolbar:function(){var e={"toolbar-buttons-box@":"toolbar-buttons"};
return"message"!==ns.page.current.page&&(e["toolbar-aside-box@"]=function(){var e=ns.Model.get("settings"),t=ns.page.current.page,i={};return"abook"!==t&&(i["inbox-filter&"]={},Jane.Config.NO_SETTINGS||(i["layout-switch"]={})),e.isCompactHeaderMode()&&(i["more-services"]={}),i}),e}}},t)}),ns.layout.define("common+left",{"app left-box@":e},"common"),ns.layout.define("not-found",{"app messages-direct-box@":{},"app service-box@":{404:{}}},"common"),ns.layout.define("user-dropdown",{"user-dropdown":{"user-dropdown-help-link":{}}}),ns.layout.define("layout-timeline",{"timeline-box@":{"timeline-ng":{"timeline-date":{},"timeline-back":{},"timeline-forward":{},"timeline-newevent":{},"timeline-toggle":{},"timeline-list&":{}}}}),ns.layout.define("layout-timeline-collapsed",{"timeline-box@":{"timeline-collapsed":{"timeline-newevent":{},"timeline-toggle":{}}}}),ns.layout.define("layout-timeline-promo",{"timeline-box@":{"timeline-promo":{"timeline-toggle":{}}}}),ns.layout.define("layout-timeline-empty",{"timeline-box@":{}}),ns.layout.define("layout-timeline-item",{"timeline-list-item":{"timeline-events&":{}}})
}(),ns.Model.define("captcha",{params:{type:null},methods:{preprocessData:function(e){return e.url&&(e.url=e.url.replace(/^https?:/,"")),e}}}),ns.Model.define("captcha-check",{params:{type:null,captcha_key:null,captcha_entered:null}}),ns.Model.define("app-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({asideSizeKind:"",mailLayoutClientRect:{top:0,left:0,width:window.screen.width,right:window.screen.width,bottom:window.screen.height}})}}},ns.ModelStatic),ns.Model.define("user-dropdown-data",{methods:{getData:function(){var e=this.data||{};
e.services=[];var t=ns.Model.get("settings");if(!t.isCompactHeaderMode())return e;if(Daria.IS_CORP)e.services.unshift({id:"calendar",title:"Календарь",url:"//calendar.yandex-team.ru/"}),e.services.unshift({id:"invite",title:"Переговорки",url:"//calendar.yandex-team.ru/invite/"}),e.services.unshift("abook"===ns.page.current.page?{id:"inbox",title:"Письма",url:"#inbox"}:{id:"contacts",title:"Контакты",url:"#contacts"});else{var i=ns.Model.get("index-data").get(".tabs.head").map(function(e){return{url:e.href,title:e.content}
});e.services=i.concat(e.services)}return e},getFreshCountByUid:function(e){var t=this.get(".accounts"),i=0;return t&&t.some(function(t){return t.uid==e?(i=Number(t["fresh-count"]||0),!0):!1}),i},setNewCountById:function(e,t){var i=this.getData();i&&Array.isArray(i.accounts)&&i.accounts.length&&(i.accounts.forEach(function(n,s){n.uid==e&&(i.accounts[s]["fresh-count"]=t)}),this.data=i)},getSumOfFresh:function(){var e=this.getData(),t=0;return e&&Array.isArray(e.accounts)&&e.accounts.length&&e.accounts.forEach(function(e){t+=Number(e["fresh-count"]||0)
}),t}}}),ns.Model.define("abook-band-info",{params:{email:null}}),ns.Model.define("do-abook-person-add",{params:{first_name:null,middle_name:null,last_name:null,b_day:null,b_month1:null,b_year:null,tel_list:null,descr:null,mail_addr:null,tags:null}}),ns.Model.define("abook-groups",{events:{"ns-model-changed":function(){var e=this.getData(),t=jpath(e,'.tag[.tid == "-10"]')[0];t&&(t.title="Контакты с телефона"),this.data=e}},methods:{getGroupByTitle:function(e){return jpath(this.data,'.tag[.title == "'+e+'"]')[0]
},getGroupByTid:function(e){return jpath(this.data,'.tag[.tid == "'+e+'"]')[0]},getContactsCount:function(e){var t=e.mcids.map(this._getCid);return _.uniq(t).length},addToGroup:function(e){var t=this,i={tids:[e.tid],mcids:e.mcids,action:"add"};return-10===i.tid&&(i.mcids=_.uniq(i.mcids.map(this._getCid))),this._doGroupAction(i).then(function(){var n=_.escape(t.getGroupByTid(e.tid).title);n=t.getContactsCount(i)>1?"Контакты добавлены в группу "+n:"Контакт добавлен в группу "+n,n=_.escape(n),Daria.Statusline.showMsg({body:n})
})},removeFromGroup:function(e){return this._doGroupAction({tids:e.tids,mcids:e.mcids,action:"rm"})},_getCid:function(e){return String(e).split(".")[0]},_doGroupAction:function(e){var t=$.Deferred(),i=e.tids,n=e.mcids;if(i.length&&n.length){var s={tid:i,mcid:n,action:e.action};return ns.forcedRequest("do-abook-group-edit-contacts",s).then(function(){Daria.Autocompleter.getContact().flushCache(),Daria.Dropdown.closeAll(),["abook-groups","abook-contact","abook-contacts"].forEach(function(e){ns.Model.invalidate(e)
}),t.resolve()}),t.promise()}}}}),ns.Model.define("do-abook-group-add",{params:{title:null,mcid:null}}),ns.Model.define("abook-contact",{params:{email:null,cid:null},paramsRewrite:function(e){return null!=e.cid?{cid:e.cid}:e},methods:{getContactInfo:function(e,t){e=e||{};var i=this.getData();return i?Daria.Abook.formatContactInfo(i,e,t):{}},getMcids:function(e){var t=this.getData(),i=[];return this.eachEmailsByTid(e,function(e){i.push(t.cid+"."+e.id)}),i.length||(i=[String(t.cid)]),i},eachEmailsByTid:function(e,t){var i=this.get(".email");
_.isFunction(e)&&(t=e),e=Number(e),_.isFunction(t)&&_.each(i,function(i){var n=-10===e;return!e||n||_(i.tags).contains(e)?t(i):void 0})},filterEmailsByTid:function(e){var t=this.get(".email");return e=Number(e),e&&-10!==e?_(t).filter(function(t){return _(t.tags).contains(e)?t:void 0}).value():t},yateFilterEmailsByTid:function(e){return e=yr.nodeset2scalar(e),this.filterEmailsByTid(e)},yateGetMcidContacts:function(e){var t=this.yateFilterEmailsByTid(e),i=this.getData();return _.map(t,function(e){var t=_.clone(i);
return t.email=[e],t})},getRefByEmail:function(e){var t=_.find(this.get(".email"),{value:e});return t?t.ref:void 0},getEmailByMcid:function(e){e=String(e);var t=Number(e.split(".")[1]),i=_.find(this.getData().email,{id:t});return i?i.value:null},getName:function(){return this.get(".name.full")||this.get(".email")[0].value.split("@")[0]},isShared:function(){return this.get(".isShared")},isSharedLocal:function(){return this.get(".isSharedLocal")},isLocal:function(){return this.get(".isLocal")}}}),ns.Model.define("abook-contacts",{params:{q:null,extended:null,tid:null,emails:null,skip:null,pagesize:30,shared:null,type:null,mode:null},paramsRewrite:function(e){var t=_.extend({},e);
return"shared"in t&&(t.shared=Daria.toIntFlag(e.shared)),t},split:{items:".contact",params:{cid:".cid"},model_id:"abook-contact"},methods:{getContactDataByEmail:function(e){var t=null;return ns.Model.traverse(this.id,function(i){if(!t)for(var n=0;n<i.models.length;n++){var s=i.models[n],a=_.some(s.get(".email"),{value:e});if(a){t=s.getData();break}}}),t},getContactsInfoByEmails:function(e,t){var i=[],n=this;return t=t||{},_.each(e,function(e){var s=_.find(n.models,function(t){return _.find(t.get(".email"),{value:e})
});s&&i.push(s.getContactInfo(t,{email:e}))}),i},getContactsEmails:function(e,t){function i(e){var i=e.get(".cid"),a=!1,o=e.get(".email");o instanceof Array?o.forEach(function(e){if(!t||!a){var o=e.value;o&&(s&&-10!==s&&-1===e.tags.indexOf(s)||(n[i]=n[i]||{},n[i][o]=e.ref,a=!0))}}):n[i]={email:o}}var n={},s=Number(e.tid)||0;return _.each(this.models,i),n},removeContacts:function(e){var t=Vow.promise();return e.forEach(function(e){var t=ns.Model.get("abook-contact",{cid:e}),i=t.get(".email");i.forEach(function(e){ns.Model.get("abook-contact",{email:e.value}).invalidate()
}),t.invalidate()}),ns.forcedRequest(["do-abook-person-delete","abook-groups"],{cid:e}).then(function(e){var i=e[0],n=i.getError(),s=i.get(".deleted-items").length;n?(Daria.Statusline.showMsg({body:"Адресная книга временно недоступна. Пожалуйста, повторите через несколько минут."}),t.reject(n)):(Daria.Statusline.showMsg({body:Jane.i18n.convert([s+" контакт удалён",s+" контакта удалено",s+" контактов  удалено"],s)}),t.fulfill(e))}),t},loadMore:function(e){var t=this.models.length,i=_.extend({},this.params,{skip:t});
if(e){var n=this.get(".pager.items-count");i.pagesize=n-t}return ns.request("abook-contacts",i).then(this._addModels,this)},_addModels:function(e){var t=e[0];this.data&&this.isValid()||(this.data={},this.status=this.STATUS.OK);var i=t.get(".pager"),n=this.get(".pager");this.set(".pager",_.extend({},n,i),{silent:!0});var s=t.models;return this.insert(s),ns.Model.destroy(t),s},getCount:function(){return this.models.length},isEmptyList:function(){return this.isValid()&&0===this.getCount()}}}),ns.Model.define("abook-suggest",{params:{popup:null,domain:null,all:null,q:null,mcid:null,climit:null,glimit:null,phone:null,popular:null},type:"js",ckey:!0,methods:{getRequestParams:function(){var e=this.super_.getRequestParams.apply(this,arguments);
return e.reqid=Daria.Config.ensureSearchSessionId(),e}}}),ns.Model.define("abook-suggest-report",{params:{uid:null,q:null,section:null,title:null,id:null}}),ns.Model.define("abook-selected",{isCollection:!0,params:function(e){if("normal"!==e.type)return{};var t=ns.Model.getKeyAndParams("abook-contacts",e).params;return delete t.pagesize,t},events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({})},isFolderSelected:no.False,runOps:function(e,t){return Daria.COPS[e](this,t)},getCids:function(){return _.map(this.models,function(e){return Number(e.get(".cid"))
})},containsEmail:function(){return _.some(this.models,function(e){var t=e.get(".email");return Array.isArray(t)&&t.length})},containsShared:function(){return _.some(this.models,function(e){return e.isShared()})},getContactsMcids:function(e){var t={};return _.each(this.models,function(i){t[i.get(".cid")]=i.getMcids(e)}),t},emailsToString:function(e){e=Number(e||0);var t=_(this.models).filter(function(e){return Array.isArray(e.get(".email"))}).map(function(t){var i={},n=function(e){return i=e,!1};
return e?t.eachEmailsByTid(e,n):t.eachEmailsByTid(n),Jane.FormValidation.obj2contact({email:i.value,name:t.get(".name.full")})});return t.join(", ")},abookContactsToAbookMcidContacts:function(e,t,i,n){return _(e).map(function(e){var s=e.getMcids(t);return"number"==typeof i&&(s=[s[i]]),n?[this.abookContactToAbookMcidContact(e,s[0])]:_.map(s,function(t){return this.abookContactToAbookMcidContact(e,t)},this)},this).flatten().value()},abookContactToAbookMcidContact:function(e,t){var i=ns.Model.get("abook-mcid-contact",{mcid:t});
return i.getData()||i.setData({cid:e.get(".cid"),mcid:t,name:e.getName(),email:e.getEmailByMcid(t)}),i},isEmptyContactsList:function(){var e=ns.Model.get("abook-contacts",ns.page.current.params);return e.isEmptyList()},isMcidSelected:function(e){return _.some(this.models,function(t){return t.get(".cid")===e})},isSelected:function(e){return _.some(this.models,function(t){return t===e})},selectAll:function(){this.clear();var e=ns.Model.get("abook-contacts",this.params);this.insert(e.models)},unselectAll:function(){this.clear()
},getSelectedMcids:function(){return _.map(this.models,function(e){return e.get(".mcid")})}}},ns.ModelCollectionStatic),ns.Model.define("history-suggest",{params:{text:null},ckey:!0}),function(){ns.Model.define("account-information",{methods:{MAXAGE:72e5,preprocessData:function(e){return delete this._emails,Daria.Page.ckey=e.ckey,this.refreshData(.8*this.MAXAGE),e},setError:function(){this.refreshData(30*Jane.Date.SECOND)},refreshData:function(e){window.clearTimeout(this._timer),this._timer=setTimeout(function(){ns.forcedRequest(["account-information"])
},e)},getDataKey:function(e){return this.get("."+e)},getSids:function(){return this.get(".sids")},addSid:function(e){this.getSids().push(String(e))},hasSid:function(e){return $.inArray(String(e),this.getSids())>-1},getFromEmails:function(){var e=this.getAllUserEmails();return $.grep(e,function(e){return"narod.ru"!==e.split("@")[1]})},getFromDefaultEmail:function(){var e=this.getFromEmails(),t=this.get(".yandex_account")+"@"+Jane.Config["yandex-domain"];return t&&_.contains(e,t)||(t=e[0]||""),t},getAllUserEmails:function(){var e;
try{e=this.getEmails().concat(ns.Model.get("settings").getValidatedEmails())}catch(t){Jane.ErrorLog.sendException("User doesn't have email",t,{modelData:typeof this.data,modelEmail:this.getDataKey("email"),modelKey:this.key,modelStatus:this.status})}return e=this.sortEmails(_.uniq(e))},sortEmails:function(e){var t=/@/,i=/(yandex|ya)\.(ru|by|ua|kz|com|com\.tr|com.ua|\u0440\u0444|xn--p1ai)/,n={RUS:{1:/^ya\.ru$/,2:/^yandex\.ru$/},INT:{1:/^yandex\.com$/},TUR:{1:/^yandex\.com\.tr$/}},s=function(e){var t=n[Daria.Config.product];
for(var s in t)if(t.hasOwnProperty(s)&&t[s].test(e))return Number(s);return i.test(e)?10:5},a=ns.Model.get("settings").getSetting("default_email"),o=function(e,i){if(e===a)return-1;if(i===a)return 1;var n=e.split(t).pop(),o=i.split(t).pop(),r=s(n),l=s(o);return r!==l?r-l:i>e?-1:1};return e.sort(o),e},getEmails:function(){if(!this._emails){for(var e=this.getDataKey("email"),t=[],i=0,n=e.length;n>i;i++){var s=e[i],a=s.login,o=null;t.push(a+"@"+s.domain),Jane.Config.pddDomain||(a.indexOf(".")>-1&&-1==a.indexOf("-")?o=a.replace(/\./g,"-"):a.indexOf("-")>-1&&-1==a.indexOf(".")?o=a.replace(/-/g,"."):a.indexOf("-")>-1&&a.indexOf(".")>-1&&(a=a.replace(/\./g,"-"),o=a.replace(/-/g,"."),t.push(a+"@"+s.domain))),o&&t.push(o+"@"+s.domain)
}this._emails=t}return this._emails},isMyEmail:function(e){return this.getAllUserEmails().indexOf(e.toLowerCase())>-1},getDigitalAlias:function(){return this.getDataKey("digital_login")},getTimezoneInHours:function(){return-(this.getDataKey("tz_offset")*Jane.Date.MINUTE/Jane.Date.HOUR)},getMA:function(){return this.get(".users")||[]},hasMA:function(){return this.getMA().length>0},isPG:function(){return"pg"===this.get(".db")}}})}(),ns.Model.define("ads",{methods:{adNodes:[],getMessageListAds:function(){return this.get(".messageList.direct.ads")
},getLeftColAds:function(){return this.get(".leftCol.direct.ads")},addAdNodes:function(e){this.adNodes=Array.prototype.concat(this.adNodes,e)},removeAdNodes:function(e){this.adNodes=_.difference(this.adNodes,e)},isAdNode:function(e){return-1!==this.adNodes.indexOf(e)}}}),ns.Model.define("do-admsubscribe-calendar"),ns.Model.define("base-calendar-event",{methods:{getError:function(e){e.error&&(e.data={error:e.error},delete e.error)},preprocessData:function(e){var t=no.jpath(".eventInfo.attendees",e);
if(t&&t.length){var i=[],n=[],s=jpath(e,".eventInfo.organizer.email")[0];return _.forEach(t,function(e){"yandexUser"==e.type||"externalUser"==e.type?e.email!==s&&i.push(e):"resource"==e.type&&n.push(e)}),e.eventInfo.organizer&&(e.eventInfo.organizer.isOrganizer=!0,i.unshift(e.eventInfo.organizer)),e.rooms=n,e.eventInfo.attendees=i,e.isNotPast=!e.eventInfo.isPast,e.toCollapsedMessage="declined"!=e.eventInfo.decision&&!e.refusal,e.isNotOperate="undecided"==e.eventInfo.decision&&!e.eventInfo.isNoRsvp,e.showWidgetInMessageHead=!e.refusal&&Daria.IS_CORP&&!e.eventInfo.isPast,e.showRightPartOfWidget=!e.eventInfo.isCancelled||e.eventInfo.isCancelled&&e.eventInfo.repetitionDescription&&e.eventInfo.isPast,e.eventInfo.eventTime=e.eventInfo.repetitionDescription?this.getTimeForRepeatEvents(e.eventInfo):this.convertEventDates(e.eventInfo.start,e.eventInfo.end),e
}},convertEventDates:function(e,t){var i=36e5;return 24>=(t-e)/i?Jane.Date.format("%Date_dB",e)+", "+Jane.i18n.index(["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"],new Date(e).getDay())+", "+("с "+Jane.Date.format("%Date_HM__colon",e)+" по "+Jane.Date.format("%Date_HM__colon",t)):"с "+(Jane.Date.format("%Date_dBY_year",e)+" "+Jane.Date.format("%Date_HM__colon",e))+" по "+(Jane.Date.format("%Date_dBY_year",t)+" "+Jane.Date.format("%Date_HM__colon",t))},getTimeForRepeatEvents:function(e){return"с "+Jane.Date.format("%Date_HM__colon",e.start)+" по "+Jane.Date.format("%Date_HM__colon",e.end)+" "+e.repetitionDescription
},getEventInfo:function(){return this.get(".eventInfo")}}}),function(){ns.Model.define("db-ro-status",{events:{"ns-model-changed":function(){var e=6e5,t=this.getData(),i=t.db_status;if("ro"==i||this._force_RO){this._force_RO=!1;var n='<img class="b-mail-icon b-mail-icon_what-is-it" src="//yastatic.net/mail/_/zFwCeBJty5lvxGAfubkhFffMPZc.png"/>';Daria.Statusline.showMsg({name:"db-ro-status",body:'Ведутся технические работы. Доступны только чтение и отправка писем <a href="http://help.yandex.ru/mail/?id=1115135" target="_blank" class="daria-action" action="common.show-hint" params="statusline=true&hide-on-scroll=true&text=Сейчас Яндекс делает кое-что на сервере, поэтому временно нельзя перемещать письма между папками и менять настройки почтового ящика. Можно просматривать полученные письма и отвечать на них. Все новые письма, которые придут во время проведения работ, появятся во входящих после завершения. Отправленные вами письма появятся в папке «Отправленные».">'+n+"</a>",hideOnTimeout:!1,blocker:!0,"class":"mail-Notification_warning"}),Daria.IS_CORP&&(e/=10,this.roTimeout&&clearTimeout(this.roTimeout))
}else Daria.Statusline.hide("db-ro-status");Daria.Config["db-status"]=i,this.roTimeout=setTimeout(function(){ns.forcedRequest("db-ro-status")},e)}},methods:{_check:function(e){this._force_RO=e,ns.forcedRequest(this.name)}}}),ns.events.on("pageinit",function(){ns.forcedRequest("db-ro-status")})}(),ns.Model.define("dimensions",{events:{"ns-model-init":"_onInit"},methods:{DOC_HEIGHT_KEY:".document-height",DOC_WIDTH_KEY:".document-width",WIN_HEIGHT_KEY:".window-height",WIN_WIDTH_KEY:".window-width",_$document:null,_$window:null,_onInit:function(){this._$document=$(document),this._$window=$(window),this._$window.on("resize",_.throttle(this._onResize.bind(this),20)),this.clean()
},getWindowScrollTop:function(){return this._$window.prop("pageYOffset")},getDocumentHeight:function(){var e=this.get(this.DOC_HEIGHT_KEY);return e||(e=this._$document.height(),this._setDimension(this.DOC_HEIGHT_KEY,e)),e},getDocumentWidth:function(){var e=this.get(this.DOC_WIDTH_KEY);return e||(e=this._$document.width(),this._setDimension(this.DOC_WIDTH_KEY,e)),e},getWindowHeight:function(){var e=this.get(this.WIN_HEIGHT_KEY);return e||(e=this._$window.height(),this._setDimension(this.WIN_HEIGHT_KEY,e)),e
},getWindowWidth:function(){var e=this.get(this.WIN_WIDTH_KEY);return e||(e=this._$window.width(),this._setDimension(this.WIN_WIDTH_KEY,e)),e},clean:function(){this.setData({},{silent:!0})},_onResize:function(e){e.originalEvent&&e.originalEvent.data&&e.originalEvent.data.custom||(this.clean(),this.trigger("resize",e))},_setDimension:function(e,t){this.set(e,t,{silent:!0})}}}),ns.Model.define("do-journal-log",{params:{params:null}}),ns.Model.define("do-mail-reset-recent-counter"),ns.Model.define("do-messages",{params:{ids:null,tids:null,movefile:null,action:null},methods:{preprocessData:function(e){if("notspam"===this.params.action&&Array.isArray(this.params.ids)){var t=this.params.ids.map(function(e){return ns.Model.get("message",{ids:e})
});ns.forcedRequest(t)}return e}}}),ns.Model.define("do-sanitize",{params:{content:null}}),ns.Model.define("do-settings",{params:{params:null}}),ns.Model.define("do-staff-settings",{params:{lang_ui:null,tz:null}}),ns.Model.define("index-data",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this._state="inbox",Daria.IS_CORP||ns.events.on("ns-page-before-load",this._fixTabs.bind(this))},preprocessData:function(e){var t=Daria.Config;if(t["is-corp"])return e;var i=_.findIndex(e.tabs.head,{id:"calendar"}),n=-1!==i,s="RUS"===t.product&&(t.pddDomain||ns.Model.get("account-information").hasSid(31));
return!n&&s?e.tabs.head.splice(1,0,{content:"Календарь",href:"//calendar.yandex.ru/",id:"calendar"}):n&&!s&&e.tabs.head.splice(i,1),this._fixTabs(e),e},_getTabsIds:function(e){return Array.isArray(e)?e.map(function(e){return e.id}).filter(function(e){return e}):[]},getAllTabsIds:function(){return{head:this._getTabsIds(this.get(".tabs.head")),more:this._getTabsIds(this.get(".tabs.more"))}},_fixTabs:function(e,t){if(this.isValid()){var i=t[1];if("abook"===i.page&&"inbox"===this._state){this._state="abook";
var n=this.get(".tabs.head"),s=_.findIndex(n,{href:"#contacts"});n.splice(s,1,{href:"#inbox",content:"Письма",id:"inbox"}),this.set(".tabs.head",n)}else if("abook"!==i.page&&"abook"===this._state){this._state="inbox";var a=this.get(".tabs.head"),o=_.findIndex(a,{href:"#inbox"});a.splice(o,1,{href:"#contacts",content:"Контакты",id:"contacts"}),this.set(".tabs.head",a)}}}}}),ns.Model.define("filters",{params:{master:null},methods:{getMasterRequest:function(){var e=this,t=ns.Model.get(this.id,_.assign({},this.params,{master:1}));
return t.destroy(),t.once("ns-model-changed",function(){e.setData(this.getData())}),t},getFilters:function(){return this.get(".action")||[]},getById:function(e){return jpath(this.getFilters(),'.[.filid == "'+e+'"]')[0]},getForLabel:function(e){return jpath(this.getFilters(),'.[.actions.type == "movel" && .actions.parameter == "'+e+'"]')},getForFolder:function(e){return jpath(this.getFilters(),'.[.actions.type == "move" && .actions.parameter == "'+e+'"]')},getForCollector:function(e){return jpath(this.getFilters(),'.[.condition.div == "X-yandex-rpop-id" && .condition.pattern == "'+e+'"]')
},getCountEnableFilters:function(){return jpath(this.getFilters(),'.action[.enable == "yes"]').length},isApplyAvailable:function(){var e=!1,t=ns.Model.get("settings").getSetting("search-version");return _.isString(t)&&!_.isUndefined(Jane.Config.applyFilterMinSearchVersionTime)&&this._parseSearchVersionDate(t)>=this._parseSearchVersionDate(Jane.Config.applyFilterMinSearchVersionTime)&&(e=!0),e},_parseSearchVersionDate:function(e){var t=e.split(".");return new Date(t[0],t[1],t[2]).getTime()}}}),function(){function e(e){if(Daria.is3pane()){e=e||ns.page.current.params;
var t=e.ids||e.thread_id;t&&ns.Model.get("focus").setFocusByMid(t,!0)}}ns.events.on("pageinit",function(){e()}),ns.Model.define("focus",{events:{"ns-model-init":"_onInit"},methods:{DEFAULT_COLUMN:1,DEFAULT_ITEM:0,indexColumns:{LEFT:0,MESSAGES:1,MESSAGE:2},_onInit:function(){_.bindAll(this,["_onPageAfterLoad","_onPageBeforeLoad","_rebuild"]),this.setData({tree:[[],[],[]],itemIndex:null,columnIndex:null,currentFocus:null,lastFocus:[],lastActionFocus:{},pageParams:JSON.stringify(ns.Model.getKeyAndParams("messages",ns.page.current.params).params)}),this._buildTree(),this._setDefaultCoordinates(),ns.events.on("ns-page-before-load",this._onPageBeforeLoad),ns.events.on("ns-page-after-load",this._onPageAfterLoad),ns.events.on("ns-page-error-load",this._onPageAfterLoad),ns.events.on("ns-page-after-load",this._rebuild),ns.events.on("daria:mFocus:buildTree",this._rebuild)
},_onPageBeforeLoad:function(t,i,n){if(Daria.is3pane()&&ns.page.currentUrl!==n&&"messages"===i[1].page){var s=_.pick(i[0].params,["thread_id","ids"]),a=_.pick(i[1].params,["thread_id","ids"]);_.isEmpty(a)||_.isEqual(s,a)||(e(a),this._setFocusOnMessage=_.once(e))}},_onPageAfterLoad:function(){_.method("_setFocusOnMessage")(this)},_rebuild:function(){this._buildTree(),this._updateFocus()},_updateFocus:function(){var e=JSON.stringify(ns.Model.getKeyAndParams("messages",ns.page.current.params).params),t=this.get(".pageParams"),i=this.get(".columnIndex");
this.set(".pageParams",e),i!==this.indexColumns.LEFT&&e!==t?this.resetFocus():this._recalculateFocus()},_buildTree:function(){Daria.DEBUG&&console.time("mFocus buildTree");var e=Daria.nsTreeWalker.getTreeForFocus();this.set(".tree",e),Daria.DEBUG&&(console.timeEnd("mFocus buildTree"),console.log("mFocus tree",e))},_recalculateFocus:function(){if(this.hasFocus()){var e=this.get(".columnIndex"),t=this.get(".itemIndex"),i=this.get(".tree")[e],n=this.getFocus();if(-1===i.indexOf(n)){var s,a,o;if(Daria.is3pane()&&e===this.indexColumns.MESSAGE&&0===i.length&&this.get(".tree")[this.indexColumns.MESSAGES].length>0)i=this.get(".tree")[this.indexColumns.MESSAGES],s=this._getLastFocusedItemIndex(this.indexColumns.MESSAGES,!0),a=this.indexColumns.MESSAGES;
else if(s=t,a=e,o=_.method("getParentReferenceParams")(n)){var r=_.findIndex(i,o);-1!==r&&(s=r)}s=Math.min(i.length-1,s),s=Math.max(s,0),this.set(".itemIndex",s),this.set(".columnIndex",a);var l={preventOpenOnFocus:a===e&&t>=s};this._setCurrentFocus(a,s,l)}}},_setDefaultCoordinates:function(){this.set(".itemIndex",this.DEFAULT_ITEM);var e=this.get(".tree"),t=this.DEFAULT_COLUMN;0===e[t].length&&(t=this.indexColumns.LEFT),this.set(".columnIndex",t)},setLastActionFocus:function(){var e=_.clone(this.get(".lastActionFocus"));
_.isEmpty(e)||e.focusView&&e.focusView.isVisible()&&(this.pubEvent("blur"),this.set(".columnIndex",e.columnIndex),this.set(".itemIndex",e.itemIndex),this.set(".currentFocus",e.focusView),this._updateFocus(),this.pubEvent("focus"))},resetFocus:function(e){this.pubEvent("blur"),this.set(".currentFocus",null),this.set(".itemIndex",this.DEFAULT_ITEM),e&&this.set(".columnIndex",this.DEFAULT_COLUMN);var t=_.clone(this.get(".lastFocus"));t[this.indexColumns.MESSAGES]=null,t[this.indexColumns.MESSAGE]=null,this.set(".lastFocus",t),this.set(".lastActionFocus",{})
},changeItem:function(e,t){var i=this.get(".columnIndex"),n=this.get(".itemIndex"),s=this.get(".tree")[i];if(!this.hasFocus()){if(i===this.indexColumns.MESSAGES){var a=this._getFirstIndexForViews(s);a>=0&&(n=a)}return void this._changeFocus(i,n,{select:t})}var o=this.get(".currentFocus");if(Daria.Focus.needLazyScroll(o,e))return void Daria.Focus.lazyScroll(e);var r=s.length,l=s.indexOf(o);return e?l++:l--,i===this.indexColumns.MESSAGES&&l===r?void this._loadMoreMessages():void(l>=0&&r>l&&this._changeFocus(i,l,{select:t}))
},_loadMoreMessages:function(){ns.events.trigger("daria:vMessagesPager:messages-load")},changeColumn:function(e){var t;t=e?this._getNextColumnIndex():this._getPrevColumnIndex(),this.setColumn(t)},setColumn:function(e){var t=this.get(".columnIndex"),i=this.get(".tree").length;if((t!==e||!this.hasFocus())&&e>=0&&i>e){var n=this._getLastFocusedItemIndex(e);this._changeFocus(e,n)}},_getNextColumnIndex:function(){for(var e=this.get(".columnIndex"),t=this.get(".tree"),i=t.length,n=e,s=e+1;i>s;s++){var a=t[s];
if(a.length>0){n=s;break}}return n},_getPrevColumnIndex:function(){for(var e=this.get(".columnIndex"),t=this.get(".tree"),i=e,n=e-1;n>=0;n--){var s=t[n];if(s.length>0){i=n;break}}return i},_getLastFocusedItemIndex:function(e,t){var i=this.get(".tree")[e],n=this.get(".lastFocus")[e],s=null;if(n&&(s=i.indexOf(n.focusView),-1!==s||t?t&&(s=n.itemIndex):s=null),null===s&&e===this.indexColumns.MESSAGE){var a=i[0];if(a&&"message-thread-item-wrap"===a.id)return this._getFirstVisibleMessageInThread(i)}if(null===s&&e===this.indexColumns.MESSAGES){var o=this._getFirstIndexForViews(i);
if(o>=0)return o}return s||0},_getFirstIndexForViews:function(e){var t=this._getOpenMessageIndex(e);if(t>=0)return t;var i=this._getFirstUnpinnedMessage(e);return i>=0?i:-1},_getFirstVisibleMessageInThread:function(e){for(var t=ns.Model.get("scroller-message").getVDimensions(),i=e.length,n={},s=0;i>s;s++){var a=e[s];if(a.isOpen()){var o=a.isVisibleInScroller(t,!1);if(o)return s;n[a.key]=o}}for(var r=0;i>r;r++){var l=e[r],c=n[l.key];if(_.isBoolean(c)){if(c)return r}else if(c=l.isVisibleInScroller(t,!1))return r
}return 0},_getOpenMessageIndex:function(e){var t=-1;if(Daria.is3pane())return t;for(var i=ns.page.current.params,n=i.ids||i.thread_id,s=0,a=e.length;a>s;s++){var o=e[s],r=o.getModel("message");if(r&&r.params.ids===n)return s}return t},_getFirstUnpinnedMessage:function(e){for(var t=-1,i=0,n=e.length;n>i;i++){var s=e[i],a=s.getModel("message");if(a&&!a.isPinned())return i}return t},_saveFocus:function(e,t){var i=_.clone(this.get(".lastFocus")),n=this.get(".currentFocus");n&&(i[e]={focusView:n,itemIndex:t},this.set(".lastFocus",i))
},_saveLastActionFocus:function(e,t){var i=_.clone(this.get(".lastActionFocus")),n=this.get(".currentFocus");n&&(i={columnIndex:e,focusView:n,itemIndex:t},this.set(".lastActionFocus",i))},_changeFocus:function(e,t,i){var n={scroll:!0,select:!1},s=_.extend(n,i),a=this.get(".columnIndex"),o=this.get(".itemIndex");a!==e&&this._saveFocus(a,o),this._saveLastActionFocus(a,o),this.set(".itemIndex",t),this.set(".columnIndex",e);var r=this._setCurrentFocus(e,t);r&&(s.scroll&&(Daria.Focus.needLazyScroll(r,!1)?Daria.Focus.lazyScroll(!1):Daria.Focus.scrollIntoView(r.$node)),s.select&&this.keyboardSelection(r.params.ids))
},_setCurrentFocus:function(e,t,i){var n=_.get(this.get(".currentFocus"),".key"),s=this.get(".tree")[e][t],a=_.get(s,".key");return n!==a?(this.pubEvent("blur"),this.set(".currentFocus",s),this.pubEvent("focus",i),s):void 0},pubEvent:function(e,t){var i=this.getFocus();i&&(ns.assert(i.onFocusEvent,"View: "+i.id,"Не реализован метод #onFocusEvent()"),Daria.DEBUG&&console.log("mFocus","pubEvent",e,i),i.isValid()?i.onFocusEvent(_.extend({},t,{type:e})):Daria.DEBUG&&console.warn("mFocus",i.id+" невалиден","Событие "+e+" проигнорировано",i))
},hasFocus:function(){return Boolean(this.get(".currentFocus"))},getFocus:function(){return this.get(".currentFocus")},getFocusOrDefault:function(){var e=this.getFocus();if(e)return e;var t=this.get(".itemIndex"),i=this.get(".columnIndex");return this.get(".tree")[i][t]},goInbox:function(){var e=this;ns.page.go("#inbox").then(function(){e._changeFocus(e.indexColumns.LEFT,e.DEFAULT_ITEM)})},_focusToMessage:function(e,t){var i=this.get(".tree")[this.indexColumns.MESSAGES].length;i>0&&this._changeFocus(this.indexColumns.MESSAGES,e,{select:t})
},focusToFirstMessage:function(e){this._focusToMessage(0,e)},focusToLastMessage:function(e){var t=this.get(".tree")[this.indexColumns.MESSAGES].length;this._focusToMessage(t-1,e)},setFocusByMid:function(e,t){var i=this.get(".tree")[this.indexColumns.MESSAGES];if(i.length>0)for(var n=0,s=i.length;s>n;n++)if(i[n].params.ids===e){this._changeFocus(this.indexColumns.MESSAGES,n,{scroll:t});break}},keyboardSelection:function(e){var t=this.get(".keyboardSelection");t.select(e)},startKeyboardSelect:function(){var e=this.getFocusOrDefault();
if(e){var t=e.getModel("message");if(t){var i=new Daria.CBS;i.start(t.params.ids),this.set(".keyboardSelection",i)}}},getRange:function(e,t){for(var i=ns.Model.get("message",{ids:e}),n=ns.Model.get("message",{ids:t}),s=this.get(".tree")[this.indexColumns.MESSAGES],a=-1,o=-1,r=0,l=s.length;l>r;r++){var c=s[r],d=c.getModel("message");if(!d)throw new Error("Something goes wrong");if(-1===a&&d===i&&(a=r),-1===o&&d===n&&(o=r),-1!==o&&-1!==a)break}return o>=a?s.slice(a,o+1):s.slice(o,a+1).reverse()},getIndexCurrentColumn:function(){return this.get(".columnIndex")
},isCurrentFocusOnMessage:function(){if(!this.hasFocus())return!1;var e=this.getFocus();return Boolean(e.getModel("message")&&e.getModel("messages-checked"))},findIndex:function(e){var t=-1;return _.forEach(this.get(".tree"),function(i){return t=i.indexOf(e),t>-1?!1:void 0}),t}}},ns.ModelStatic),ns.events.on("pageinit",function(){_.defer(function(){var e=ns.Model.get("focus");"message"===ns.page.current.page&&e.setColumn(e.DEFAULT_COLUMN)})})}(),ns.Model.define("footer-data",{events:{"ns-model-init":function(){var e=Daria.Config;
this.setData({"full-year":new Date(Daria.now()).getFullYear(),"link-advert":this._linkAdvert(),"link-feedback":this._linkFeedback(),"link-lite":"/u2709/go2lite.jsx","link-mobile-apps":this._linkMobileApps(),"link-yandex":Daria.IS_CORP?"//company.yandex.ru":"//www."+e["yandex-domain"],version:"jane="+Jane.Services.getProjectVersion("jane")+"|mail="+Jane.Services.getProjectVersion("mail"),yafeedback:Daria.IS_CORP||Daria.SIDS.indexOf("669")>-1})}},methods:{_linkAdvert:function(){var e=Daria.Config;return"TUR"===e.product?!1:"https://yandex.ru/adv"
},_linkFeedback:function(){var e,t=Daria.Config;switch(t.product){case"INT":e="//feedback.yandex.com/mail/";break;case"TUR":e="//contact.yandex.com.tr/?from=mail";break;default:e="//feedback2."+t["yandex-domain"]+"/mail/"}return e},_linkMobileApps:function(){var e=Daria.Config,t=!1;return"RUS"===e.product&&(t="uk"===e.locale||"yandex.ua"===e["yandex-domain"]?"//mobile.yandex.ua/apps/mail/":"//mobile.yandex.ru/apps/mail/"),t}}},ns.ModelStatic),function(){ns.Model.define("get_user_activity",{events:{"ns-model-changed":"_onModelChanged"},methods:{_onModelChanged:function(){this._lastLcnCheck=!0;
var e=this.get(".lcn");e&&(this._lastLcnCheck=Daria.Xiva.handlers.processNewLcn(e))},syncLcn:function(){return ns.forcedRequest([this]).then(function(){return vow.resolve(this._lastLcnCheck)},this)}}},ns.ModelArmour)}(),ns.Model.define("get-group-user-events",{ctor:function(){this._lazyRequestDebounce=_.debounce(this._lazyRequest.bind(this),50),this._models={},this._promise=null},methods:{request:function(){return this.isValid()||(this._promise=Vow.promise()),this._lazyRequestDebounce(),this._promise
},addModel:function(e){this._models[e.key]=e},isValid:function(){return _.isEmpty(this._models)},canRequest:function(){return!_.isEmpty(this._models)},_lazyRequest:function(){if(!this.canRequest())return void this._promise.fulfill();var e,t,i,n,s=_.assign({},this._models);_.forEach(s,function(s){(!e||e.getTime()>s.dateFrom.getTime())&&(e=s.dateFrom,i=s.params.from),(!t||t.getTime()<s.dateTo.getTime())&&(t=s.dateTo,n=s.params.to)});var a=ns.Model.get("get-user-events",{from:i,to:n,group:!0});a.destroy();
var o=this;ns.request.models([a]).then(function(){_.forEach(s,function(e){e.setDataFromEvents(a),delete o._models[e.key]})}).always(function(){o._promise.fulfill(),a.destroy()})}}}),ns.Model.define("get-user-events",{events:{"ns-model-init":"_onInit"},params:{from:"",to:"",group:!1},maxage:24*Jane.Date.HOUR,ctor:function(){this.dateInit=Daria.now(),this._minimalViewTime=15,this._minimalViewInterval=Daria.timify({minutes:15},"hours"),this._mapEventsIterator=this._mapEventsIterator.bind(this),this._sortEvents=this._sortEvents.bind(this),this._reduceGroupsIterator=this._reduceGroupsIterator.bind(this)
},methods:{_onInit:function(){this.params.from&&(this.dateFrom=Jane.Date.LocalDate.parseDate(this.params.from)),this.params.to&&(this.dateTo=Jane.Date.LocalDate.parseDate(this.params.to),this.dateTo.setHours(23,59,59))},getRequest:function(){if(this.isValid())return this;if(this.params.group)return this;if(!this.dateFrom||!this.dateTo)return this;var e=ns.Model.get("get-group-user-events");return e.addModel(this),e},extractData:function(e){this.dateInit=Daria.now();var t=this._extractData(e);return!t&&this.data&&(t=this.data,t._lastData=!0),t||{events:[]}
},hasDataChanged:function(e){return e&&e._lastData?!1:!!e},preprocessData:function(e){return e._lastData?e:this.params.group?(e.events=_.map(e.events,this._mapEventsCommonIterator),e):(Array.isArray(e.events)?e.ranges=this.createGroupsOfEvents(e.events):Jane.ErrorLog.send({errorType:"HandlerError",name:"get-user-events",reason:"calendar_get-user-events_failed"}),e)},getEventsFromRange:function(e,t){var i=e.getTime(),n=t.getTime();return _.filter(this.get(".events"),function(e){var t=e.startDate.getTime(),s=e.endDate.getTime();
return!(i>s||t>n)})},setDataFromEvents:function(e){var t=e.getEventsFromRange(this.dateFrom,this.dateTo);return this.setData({events:t})},isLastData:function(){return Boolean(this.get("._lastData"))},createGroupsOfEvents:function(e){return _(e).chain().map(this._mapEventsCommonIterator).map(this._mapEventsIterator).sortBy(this._sortEvents).reduce(this._reduceGroupsIterator,[]).value()},_getSizeOfRange:function(e,t){var i=(t.getTime()-e.getTime())/Jane.Date.HOUR;return Number(i.toFixed(2))},_sortEvents:function(e){return e.startDate.getTime()
},_findGroupIndex:function(e,t){var i=e.startDate.getTime(),n=e.viewEndDate.getTime(),s=t.startDate.getTime(),a=t.viewEndDate.getTime();return s>=n||i>=a?!1:!0},_reduceGroupsIterator:function(e,t){var i=_.findIndex(e,this._findGroupIndex.bind(this,t)),n=e[i];return n||(n={events:[]},e.push(n)),n.events.push(t),n.startDate=n.startDate?n.startDate.getTime()>t.startDate.getTime()?t.startDate:n.startDate:t.startDate,n.endDate=n.endDate&&n.endDate.getTime()>t.endDate.getTime()?n.endDate:t.endDate,_.assign(n,this._createIntervalOptions(n.startDate,n.endDate)),e
},_mapEventsCommonIterator:function(e){var t=Jane.Date.LocalDate.parseISOTime(e.startTs),i=Jane.Date.LocalDate.parseISOTime(e.endTs);return _.assign({},e,{startDate:t,endDate:i})},_mapEventsIterator:function(e){return _.assign({},e,this._createIntervalOptions(e.startDate,e.endDate))},_createIntervalOptions:function(e,t){var i,n,s=this._getSizeOfRange(e,t);s<this._minimalViewInterval?(n=this._minimalViewInterval,i=Jane.Date.clone(e),i.setMinutes(e.getMinutes()+this._minimalViewTime)):(n=s,i=Jane.Date.clone(t));
var a=Jane.Date.getHours(e),o=a,r=Jane.Date.clone(e),l=Jane.Date.clone(i),c=!0,d=!0;this.dateTo&&this.dateTo.getTime()<i.getTime()&&(l=Jane.Date.clone(this.dateTo),c=!1),this.dateFrom&&this.dateFrom.getTime()>e.getTime()&&(r=Jane.Date.clone(this.dateFrom),d=!1,o=0);var u=this._getSizeOfRange(r,l);return{intervalInHours:s,viewEndDate:i,viewIntervalInHours:n,startInHours:a,startInRange:o,viewIntervalInRange:u,isFinishedInRange:c,isStartedInRange:d,stringDate:Jane.Date.getDaysInterval(e,t),startStringHour:Jane.Date.format("%Date_HM__colon",e),endStringHour:Jane.Date.format("%Date_HM__colon",t),startDay:Jane.Date.format("%F",e)}
}}},ns.ModelArmour),ns.Model.define("head-user-state",{events:{"ns-model-init":"_onInit"},methods:{LS_ITEM_NAME:"newLettersInMA",_onInit:function(){this.setData({newLettersInMA:Boolean(Jane.LS&&Jane.LS.getItem("newLettersInMA"))}),window.addEventListener("storage",function(e){if(e&&"newLettersInMA"===e.key){var t=Jane.LS.getItem(this.LS_ITEM_NAME);this.setNewLettersInMA(t)}}.bind(this),!1)},hasNewLettersInMA:function(){return this.get(".newLettersInMA")},setNewLettersInMA:function(e){this.setIfChanged(".newLettersInMA",e),Jane.LS&&(e?Jane.LS.setItem(this.LS_ITEM_NAME,"true"):Jane.LS.removeItem(this.LS_ITEM_NAME))
}}},ns.ModelStatic),function(){ns.Model.define("header-news",{methods:{getLastNews:function(){var e=this.getData();return e&&e["last-news"]}}})}(),ns.Model.define("is-yandex-user",{params:{email:null}}),function(e){for(var t={ru:{abbr:"ru","short":"Ru",name:"Русский","date-format":"%d %h. %Y в %H:%M",locale:"ru_RU.UTF-8",locale_short:"ru_RU"},uk:{abbr:"uk","short":"Ua",name:"Українська","date-format":"%d %h. %Y о %H:%M",locale:"uk_UA.UTF-8",locale_short:"uk_UA"},az:{abbr:"az","short":"Az",name:"Azərbaycan","date-format":"%d %h. %Y в %H:%M",locale:"az_AZ.UTF-8",locale_short:"az_AZ"},tt:{abbr:"tt","short":"Tat",name:"Татарча","date-format":"%d %h. %Y %H:%M",locale:"tt_RU.UTF-8",locale_short:"tt_RU"},en:{abbr:"en","short":"En",name:"English","date-format":"%h %d, %Y at %H:%M",locale:"en_US.UTF-8",locale_short:"en_US"},tr:{abbr:"tr","short":"Tr",name:"Türkçe","date-format":"%d %h. %Y о %H:%M",locale:"tr_TR.UTF-8",locale_short:"tr_TR"},be:{abbr:"be","short":"By",name:"Беларуская","date-format":"%d %h. %Y о %H:%M",locale:"be_BE.UTF-8",locale_short:"be_BE"},kk:{abbr:"kk","short":"Kz",name:"Қазақ","date-format":"%d %h. %Y о %H:%M",locale:"kk_KK.UTF-8",locale_short:"kk_KK"},ka:{abbr:"ka","short":"Geo",name:"ქართული","date-format":"%d %h. %Y о %H:%M",locale:"ka_KA.UTF-8",locale_short:"ka_KA"},ro:{abbr:"ro","short":"Ro",name:"Română","date-format":"%d %h. %Y о %H:%M",locale:"ro_RO.UTF-8",locale_short:"ro_RO"},hy:{abbr:"hy","short":"Arm",name:"Հայերեն","date-format":"%d %h. %Y о %H:%M",locale:"hy_HY.UTF-8",locale_short:"hy_HY"}},i=[],n=0,s=0;n<e.length;n++){var a=t[e[n]];
a&&(i[s++]=a)}ns.Model.define("languages",{events:{"ns-model-init":function(){this.setData({languages:{lang:i}})}}},ns.ModelStatic)}(Daria.locales),ns.Model.define("last-login"),function(){ns.Model.define("last-checked-message",{events:{"ns-model-init":"_onInitialize","ns-model-destroyed":"_onDestroy"},methods:{_onInitialize:function(){this._onMessageChecked=this._onMessageChecked.bind(this),this.setData({mMessage:null}),ns.events.on("daria:vMessagesItem:checked",this._onMessageChecked)},_onDestroy:function(){ns.events.off("daria:vMessagesItem:checked",this._onMessageChecked)
},_onMessageChecked:function(e,t,i,n){i&&this.set(n)},set:function(e){this.setData({mMessage:e})},clean:function(){this.setData({mMessage:null})},getData:function(){return this.data.mMessage}}},ns.ModelStatic),Daria.lastCheckedMessage=ns.Model.get("last-checked-message")}(),ns.Model.define("letter-templates",{events:{"ns-model-init":function(){this.setData({"done-keys":["резюме","?:^| )(отч[ёе]ты?)(?: |$","реквизиты?","прайсы?","коммерческ[ио]е предложени[ея]","анкет[ыа]","?:^| )(сотрудничество)(?: |$","предложени[ея]","приглашени[ея] на собеседовани[ея]","?:^| )(сч[ёе]та?)(?: |$","?:^| )(договор[аы]?)(?: |$","?:^| )(запросы?)(?: |$","приглашени[ея]"],"done-texts":["резюме","отчёты","реквизиты","прайсы","коммерческие предложения","анкеты","предложения о сотрудничестве","предложения","приглашения на собеседование","счета","договоры","запросы","приглашения"]})
}}}),ns.Model.define("message-failed",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({})},hasMid:function(e){return this.data.hasOwnProperty(e)},setMid:function(e){e&&(this.data[e]=!0)},removeMid:function(e){delete this.data[e]}}},ns.ModelStatic),function(){ns.Model.define("message-body",{params:{ids:null,is_spam:!1,hid:null,stid:null,raw:!1,draft:!1},paramsRewrite:function(e){return e.ids?_.extend({stid:ns.Model.get("message",{ids:e.ids}).get(".stid")},e):e},calculateParamsForMessageBody:function(e){return e.ids?_.extend({},e,{draft:Boolean(!e.oper&&e.ids)}):null
},methods:{exists:function(){if(this.status===this.STATUS.ERROR){var e=this.getError(),t=e&&String(e.code)===Daria.WMI.ERROR_CODES.NO_SUCH_MESSAGE;return!t}return!0},extractError:function(e){if(e){var t=no.jpath(".error.code",e);return String(t)===Daria.WMI.ERROR_CODES.NO_SUCH_MESSAGE&&(this.canRequest=no.False),e.error}},canRequest:function(){return!ns.Model.get("message-failed").hasMid(this.params.ids)},preprocessData:function(e){var t=this.params;this.setIconInfo(e);var i=ns.Model.get("message",{ids:t.ids});
e["is-spam"]=i.isSpam(),e["is-support"]=i.isYaSupport(),e["is-noreply-notification"]=i.isNoreplyNotification(),(e["is-spam"]||e.phishing)&&(e["hide-imgs"]=!0);var n,s,a=jpath(e,".info.livemail")[0];if(a)try{e.livemail=$.parseJSON(a)}catch(o){}var r=e.attachment;if(r)for(n=0,s=r.length;s>n;n++){var l=r[n];if(l.narod){var c=l.name,d=Daria.splitName(c);l.filename=d[0],l.fileext=d[1]?"."+d[1]:"",l["name-uri-encoded"]=encodeURIComponent(c),l["preview-src"]=l.preview}else".wdp"==l.fileext&&delete l["preview-supported"]
}return e.info&&e.info.date&&(e.info.date.view=Daria.MessageTime.getFormattedTime(e.info.date.timestamp)),e},hasRelativeTime:function(){return this.get(".info.date.view.isRelative")},updateTime:function(){var e=Daria.MessageTime.getFormattedTime(this.get(".info.date.timestamp"));this.set(".info.date.view",e)},setIconInfo:function(e){var t=jpath(e,".attachment")[0]||[];t.forEach(function(e){var t=Daria.getExtensionInfo(e.name);t.icon&&(e.icon=t.icon)})},getEmailInfoParams:function(){var e=this.select('.info.field[.type=="from"]')[0],t=e&&e.email&&e.email.toLowerCase();
return t&&Jane.FormValidation.checkEmail(t)?{ref:e.ref,email:t}:null},getEmailRef:function(e){return this.select('.info.field[.email=="'+e+'"].ref')[0]},parseDate:function(e){var t=String(e).match(/^(\d+)-(\d+)-(\d+) (\d+):(\d+):(\d+)$/);return t?new Date(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[4],10),parseInt(t[5],10),parseInt(t[6],10)).getTime():null},getSubtype:function(){var e=this.get(".body.subtype");return e&&e[0]},getAddressField:function(e,t){return Daria.formatContacts(this.select('.info.field[.type == "'+e+'"]'),t)
},filterRecipients:function(e,t){t=t||ns.Model.get("account-information").getAllUserEmails(),t=$.map(t,function(e){return e.replace(/-/g,".").toLowerCase()});var i=function(e){return-1===$.inArray(e.email.replace(/-/g,".").toLowerCase(),t)?e:null};return $.map(this.getFieldsByType(e),i)},getRecipients:function(e,t){var i,n=this;i=t?function(e){return e}:function(e){return Daria.formatContacts(e,!1)};var s=function(e,t){return n.filterRecipients(e,t)},a=s("reply-to");a.length||(a=s("from")),(!a.length||e)&&(a=a.concat(s("to"))),a.length||(a=s("from",[])),a=_.uniq(a,"email");
var o=e?s("cc"):[];return{to:i(a),cc:i(o)}},allowedReplyAll:function(){var e=this.getRecipients(!0,!0),t=_(e).chain().values().flatten().filter("email").uniq("email").value(),i=this.getFieldsByType("to").pop();return i&&Daria.email.isCA(i.email)&&_.remove(t,function(e){return e.email==i.email}),t.length>1},participantsCount:function(){return this.filterRecipients("to").length+this.filterRecipients("cc").length},getFieldsByType:function(e){return this.select('.info.field[.type == "'+e+'"]')},recipientsCount:function(){return this.getFieldsByType("to").length+this.getFieldsByType("cc").length+this.getFieldsByType("bcc").length
},hasTooManyRecipients:function(){return this.recipientsCount()>=10},getInfo:function(e){return this.select(".info."+e)},getMessageId:function(){return this.get(".info.message-id")||null},getInReplyTo:function(){return this.get(".info.in-reply-to")||null},getReferences:function(){return this.get(".info.references")||null},getAttachments:function(){return this.get(".attachment")||[]},hasVideoLinks:function(e){var t=this.getData();if(!t)return!1;var i=jpath(t,".body.video_link");return e?$.map(i,function(t){var i=($(t).attr("hosting_name")||"").toLowerCase();
return-1!=$.inArray(i,e)||null}).length:i.length>0},hasInlineAttachments:function(){var e=this.getData();return e?jpath(e,".attachment[!.narod]")>0:!1},_htmlCache:{},_COLLECTOR_MSG_STIDS:["102.66466005.241046198820547232969001058","102.66466005.157526963565013225811429732","102.66466005.134090406637961488505874094","102.66466005.776572722362711757375188712","102.66466005.856799731918248093078980991"],getComposeHTML:function(){var e=this.get(".body"),t=[];if(Array.isArray(e))for(var i=0,n=e.length;n>i;i++)t.push(e[i].content);
return t},getHTML:function(e){e=e||{},e.ids=this.params.ids;var t=this.getData();if(!t||t.error)return Jane.ErrorLog.send({errorType:"message-body.error",params:JSON.stringify(e),msgBodyError:t&&t.error}),[Jane.tt("message:message-body-error")];if(this.isCollectorMessage())return[Jane.tt("message:message-body-collector-msg",{lang:this.getDefaultLangId()})];var i=[],n=document.createElement("div"),s=["mail-Message-Body-Content"],a=t.body||[],o=a[0];o&&"plain"==o.subtype&&(s.push("mail-Message-Body-Content_plain"),ns.Model.get("settings").isSet("use_monospace_in_text")&&s.push("mail-Message-Body-Content_monospace")),s=s.join(" "),s&&(n.className=s);
for(var r,l,c,d=0,u=a.length;u>d;d++)for(r=this._processBody(a[d],e),l=0,c=r.length;c>l;l++)n.appendChild(r[l]);return i.push(n),i},getDefaultLangId:function(){switch(Daria.Config.locale){case"ru":case"be":return 1;case"en":return 2;case"uk":return 5;case"tr":return 44;default:return 0}},_processBody:function(e,t){var i=t.ids,n=Daria.MessageProcess.processBody(e.content,t),s=$(n).contents().get(),a="";"message"==e.type&&"delivery-status"==e.subtype&&(a="<p>Статус доставки:</p>");var o=$(a).get();
if(e.lattach&&e.lattach.length){var r=Jane.tt("mail:attached-message-inline",{hids:e.lattach,mid:i},["message-body"],{ids:i});s.unshift.apply(s,$(r).get())}if(e.rattach&&e.rattach.length){var l=Jane.tt("mail:attached-message-inline",{hids:e.rattach,mid:i},["message-body"],{ids:i});s.push.apply(s,$(l).get())}return o.concat(s)},isCollectorMessage:function(){var e=this.getSTID();return e?this._COLLECTOR_MSG_STIDS.indexOf(e)>-1:!1},getSTID:function(){return this.get(".info.stid")},getRawFirstBody:function(){return this.get(".body[0].content")||""
},getReplyBody:function(e,t,i){var n=ns.Model.get("settings"),s="";if(n.isSet("enable_quoting")&&(s=this.getQuoteContent(e)),!i){var a=Daria.Translate.getLangByMid(this.params.ids);a||(a=Daria.Translate.defineLanguage(this.getComposeHTML())),s=Daria.signs.appendToBody(s,e,null,t,a)}return s},getQuoteContent:function(e){var t=ns.Model.get("message",{ids:this.params.ids}),i=t.getDateTime(),n=t.getAddressField("from").replace(/\\"/g,'"'),s=this.getComposeHTML();return"html"===e?(s=Daria.Html2Text.quoteHtml(s),"<div><br/></div><div><br/></div><div>"+i+", "+_.escape(n)+":</div>"+s):(s=Daria.Html2Text.html2text(s),s=Daria.Html2Text.quoteText(s),"\n\n"+i+", "+n+":\n"+s)
},getForwardBody:function(e,t){var i=ns.Model.get("message",{ids:this.params.ids}),n="",s=i.getDateTime(),a=i.getAddressField("from").replace(/\\"/g,'"'),o=this.getComposeHTML(),r=Daria.Translate.getLangByMid(this.params.ids)||Daria.Translate.defineLanguage(o);return o='<div class="normalize">'+o+"</div>","html"===e?(n+="<div><br/></div><div><br/></div><div>-------- Пересылаемое сообщение--------</div>",n+="<div>"+s+", "+_.escape(a)+":</div><div><br/></div>",n+=o,n+="<div><br/></div><div>-------- Конец пересылаемого сообщения --------</div>"):(n+="\n\n-------- Пересылаемое сообщение  --------",n+="\n"+s+", "+a+":\n\n",n+=Daria.Html2Text.html2text(o),n+="\n-------- Конец пересылаемого сообщения --------"),Daria.signs.appendToBody(n,e,!0,t,r)
},getDraftBody:function(e){var t;if(e&&(t=$.makeArray(this.get('.body[.subtype == "'+e+'" && .name == ""]')||[])[0]),t||(t=this.getFirstBody()),!t)return"";var i=t.content,n=t.subtype;return"plain"===e&&"html"===n?i=Daria.Html2Text.html2text(i):"html"===e&&"plain"===n&&(i=i.replace(/\u0020\u0020/g,"  "),i=_.unescape(i),i=Daria.Html2Text.text2html(i)),"plain"===e&&(i=_.unescape(i)),i},_getLocationsData:function(){var e=this.get(".facts.addr");return _.flatten(e).filter(function(e){return Boolean(e)
})},getInvalidLocations:function(){return _.difference(this._getLocationsData(),this.getLocations())},getLocations:function(){return _(this._getLocationsData()).filter(function(e){return"string"==typeof e.geo_addr&&_.isPlainObject(e.addr)}).filter(function(e){return"string"==typeof e.addr.street?!0:_.keys(e.addr).length>1}).valueOf()},hasPGP:function(){if(!this.isValid())return!1;var e=this.getFirstNonEmptyBodyContent()||"";return e.indexOf("wmi-pgp")>-1||e.indexOf("-----BEGIN PGP MESSAGE-----")>-1
},getPGP:function(){var e={ids:this.params.ids,raw:!0},t=$.Deferred();return ns.request("message-body",e).then(function(e){var i=e[0],n=i.getFirstNonEmptyBodyContent()||"",s=i.getFieldsByType("from")[0],a=i.getFieldsByType("to")[0];t.resolve({from:{email:s.email,name:s.name},message:n.trim(),to:{email:a.email,name:a.name}})},function(){t.reject()}),t},getCalendarEvent:function(){return this.select(".facts.events.CalendarEvent")[0]},getCalendarICS:function(){return this.select(".calendars.calendar.hid")[0]
},fetch:function(e){return e=no.extend(this.params,e||{}),ns.forcedRequest(this.id,e)},isLoaded:function(){return Boolean(this.get(".body"))},hasListUnsubscribe:function(){return!!this.getInfo("list-unsubscribe")[0]},hasFactUnsubscribe:function(){return!!jpath(this.getData(),".body[0].facts.unsubscribe.url")[0]},getUnsubscribeOptions:function(){function e(e,t){if(e){var i=$.url(e);i.Proto.match(/^https?$/gi)&&i.host&&(a[i.Proto+(t?"-"+t:"")]=e)}}var t,i=this.getInfo("list-unsubscribe")[0],n=this.get(".body.facts.unsubscribe"),s="<((mailto|https?):[^>]+)>",a={},o=i.match(new RegExp(s,"gi"));
if(o)for(var r=0;r<o.length;r++){t=new RegExp(s,"i").exec(o[r]);var l=t[2]+"-header";a[l]||(a[l]=t[1])}else Jane.FormValidation.reEmail.test(i)?a["mailto-header"]="mailto:"+i:e(i,"header");if(n&&n.length){var c=jpath(n[0],".url");c.length&&e(c[0],"body")}return a},fromComposeMessage:function(e,t){if(this.isValid())return this;var i=ns.Model.get("message",{ids:t}),n=ns.Model.get("message-body",{ids:t}),s=e.get(".sentMessageId"),a=e.get(".from_mailbox"),o=[{email:a,name:e.get(".from_name"),ref:n.getEmailRef(a),type:"from"}];
o=o.concat(e.formatContacts("to",n),e.formatContacts("cc",n),e.formatContacts("bcc",n));var r=e.getSendMessage();return e.isHtmlType()||(r=Daria.Html2Text.text2html(r)),this.setData({fake:!0,body:[{type:"text",subtype:e.get(".ttype"),content:r}],info:{date:i.createMessageCurrentDate(),field:o,"message-id":s}})},isRecipient:function(){var e=ns.Model.get("account-information"),t=this.getFieldsByType("to").concat(this.getFieldsByType("cc"),this.getFieldsByType("bcc"));return _.some(t,function(t){return e.isMyEmail(t.email)
})},hasPhishingBody:function(){return(this.get(".body")||[]).some(function(e){return Boolean(e.phishing)})},getFirstBody:function(){return(this.get(".body")||[])[0]},getFirstNonEmptyBodyContent:function(){var e=this.get(".body.content")||[];return e[0]}}})}(),ns.Model.define("message",{events:{"ns-model-init":"_onInit"},params:{ids:null,hid:null},methods:{_threadKeyPrefix:"t",_readInfo:{},_countInfo:{},INVALID_FOLDERS_SYMBOLS_FOR_PIN:["spam","trash"],_onInit:function(){this._checkIds(),this.params.ids&&this.params.ids[0]===this._threadKeyPrefix&&this.setData({FAKE_THREAD_DATA:!0})
},_checkIds:function(){if(!this.params.ids)throw new Error("Can't create Daria.mMessage without ids")},preprocessData:function(e){if(e.date&&e.date.chunks){var t=e.date.chunks;e.date.ts=new Date(t.year,t.month,t.date,t.hours,t.minutes).getTime(),e.date.view=Daria.MessageTime.getFormattedTime(e.date.timestamp)}var i=e.subject;return i&&"No subject"!==i||(e.subject="(Без темы)"),e},hasRelativeTime:function(){return this.get(".date.view.isRelative")},updateTime:function(){var e=Daria.MessageTime.getFormattedTime(this.get(".date.timestamp"));
this.set(".date.view",e)},hasDataChanged:function(e){var t=this.data;if(!t||!this.hasRealData())return!0;var i=[];return t.count!==e.count&&i.push({jpath:".count",value:e.count}),t.fid!==e.fid&&i.push({jpath:".fid",value:e.fid}),t.firstline!==e.firstline&&i.push({jpath:".firstline",value:e.firstline}),t["new"]!==e["new"]&&i.push({jpath:".new",value:e["new"]}),_.isEqual(t.flags,e.flags)||i.push({jpath:".flags",value:e.flags}),_.isEqual(t.lid,e.lid)||i.push({jpath:".lid",value:e.lid}),_.isEqual(t.field,e.field)||i.push({jpath:".field",value:e.field}),e.date&&!_.isEqual(t.date,e.date)&&i.push({jpath:".date",value:_.extend({},e.date,{view:Daria.MessageTime.getFormattedTime(e.date.timestamp)})}),i.forEach(function(e){this.set(e.jpath,e.value)
},this),this.isThread()&&(i.length||t.thread_scn!==e.thread_scn)&&ns.forcedRequest([{id:"messages",params:{thread_id:t.tid}}]),!1},exists:function(){if(this.status===this.STATUS.ERROR){var e=this.getError(),t=e&&String(e.code)===Daria.WMI.ERROR_CODES.NO_SUCH_MESSAGE;return!t}return!0},extractError:function(e){if(e){var t=no.jpath(".error.code",e);return String(t)===Daria.WMI.ERROR_CODES.NO_SUCH_MESSAGE&&(this.canRequest=no.False),e.error}},canRequest:function(){return!ns.Model.get("message-failed").hasMid(this.params.ids)
},isDraftLike:function(){return!this.isThread()&&this.inFolderBySymbol(["outbox","draft","template"])},isExternalLike:function(){return!this.inFolderBySymbol(["draft","outbox","sent","template"])},isOutcomeMessage:function(){return this.inFolderBySymbol(["sent","outbox"])},canReply:function(){return!this.inFolderBySymbol(["spam","trash","draft","sent"])},canReplyQR:function(){return!this.inFolderBySymbol(["spam","trash","draft"])},isTemplate:function(){return!this.isThread()&&this.inFolderBySymbol("template")
},isThread:function(){return this.isThreadModel()},isMessageThread:function(){return this.isThreadModel()&&1===this.getThreadCount()},getMessageThreadMid:function(){if(!this.isMessageThread())return this.params.ids;var e=this.getThreadMessages(),t=e.models[0];return t?t.params.ids:this.params.ids.slice(1)},isThreadModel:function(){return this.params.ids[0]===this._threadKeyPrefix},getSocialLabel:function(){var e=this.get(".dlid");return e||(e=this.get(".dtype.name")),e},getFolderId:function(){return this.get(".fid")||null
},getMessageFieldName:function(){var e="from",t=ns.Model.get("folders"),i=["sent","draft","outbox","template"];return t.isFolder(ns.page.current.params.current_folder,i)&&(e="to"),ns.page.current.params.search&&t.isFolder(ns.page.current.params.fid,["sent"])&&(e="to"),e},isNew:function(){return Boolean(this.get(".new"))},isSpam:function(){var e=this.getFolderId();return ns.Model.get("folders").isFolder(e,"spam")},isNoreplyNotification:function(){var e=ns.Model.get("labels").getLabelByName("SystMetkaWJDT:NOTIFY");
return e&&this.hasLabel(e.lid)},hasAttachment:function(){return Boolean(this.get(".flags.attachment"))},hasLabel:function(e){var t=this.getData();return Boolean(t&&Array.isArray(t.lid)&&t.lid.indexOf(e)>-1)},hasLabelWithSymbolicName:function(e){var t=ns.Model.get("labels").getLabelBySymbolicName(e);return Boolean(t&&this.hasLabel(t.lid))},inFolder:function(e){var t=this.get(".fid");return e&&t&&t===e?!0:!1},inFolderBySymbol:function(e){var t=this.getFolderId();return ns.Model.get("folders").isFolder(t,e)
},isIntoThread:function(){return this.getThreadMessage().hasRealData()},getThreadId:function(){return this.get(".tid")},getUrl:function(){var e=this.inFolder(ns.Model.get("folders").getFidBySymbol("draft"));return Daria.isMessagePage()&&Daria.is2pane()&&(e=!1),ns.router.generateUrl(e?"compose2":"message",{ids:this.get(".mid")})},getSOLabels:function(){return this.get(".type")},toMove:function(e){return this.isThread()||this.getFolderId()!==e.current_folder},toDelete:function(e){return this.inFolderBySymbol("trash")||this.toMove(e)
},toSpam:function(e){return this.toMove(e)},toNotspam:function(e){return this.toMove(e)},_grep:function(e,t,i,n){var s=[];if($.isArray(e))for(var a=0,o=e.length;o>a;a++)this[n](t+e[a],i)&&s.push(e[a]);return s},grep:function(e,t,i){var n=this._grep(e.mids,"",t,i),s=this._grep(e.tids,this._threadKeyPrefix,t,i);return n[0]||s[0]?{mids:n,tids:s}:!1},label:function(e,t){var i=new Daria.MOPS.Opinfo,n=e.lid,s=_.clone(this.get(".lid"));if(n&&s&&-1===s.indexOf(n))if(s.push(n),this.set(".lid",s),this.isThreadModel()){if(!t&&!e.onlyAdd)return this._correctThreadListLabel("label",e)
}else{var a=this.getThreadId();ns.Model.get("message",{ids:a}).label(e,!0),i.addAdjust(n,1),i.addMid(this.get(".mid"))}return i},toTemplate:function(){var e=ns.Model.get("folders"),t=this.getFolderId(),i=e.getFolderById(t);return i&&(i.user||e.isFolder(t,["inbox"]))?!0:!1},unlabel:function(e,t){var i=new Daria.MOPS.Opinfo,n=e.lid,s=_.clone(this.get(".lid"));if(n&&s){var a=Jane.Array.remove(s,n);if(a>-1)if(this.set(".lid",s),this.isThread()){if(!t)return this._correctThreadListLabel("unlabel",e)}else{var o=this.getThreadId(),r=ns.Model.get("message",{ids:o}),l=r.getThreadCount(),c=this.getThreadMessages(o).hasMessageWithLabel(n,l);
c===!1&&r.unlabel(e,!0),i.addAdjust(n,-1),i.addMid(this.get(".mid"))}}return i},mark:function(){var e=new Daria.MOPS.Opinfo,t=this.get(".new");if(t>0){if(this.set(".new",0),this.isThread())return this._correctThreadListMark("mark",-t);this._correctThreadMark("mark"),e.addAdjust(this.getFolderId(),-t),e.addMid(this.get(".mid"))}return e},unmark:function(){var e=new Daria.MOPS.Opinfo,t=this.getThreadCount(),i=t-this.get(".new");if(i>0){if(this.set(".new",t),this.isThread())return this._correctThreadListMark("unmark",i);
this._correctThreadMark("unmark"),e.addAdjust(this.getFolderId(),i),e.addMid(this.get(".mid"))}return e},toggleMark:function(){var e,t=this.isNew()?"mark":"unmark";return e=this.isThread()?this.getThreadMessagesCheckedModel(!0):this.getMessagesCheckedModel(!0),Daria.MOPS[t](e)},toggleMute:function(){var e=this.isMuted()?"unignore":"ignore";return Daria.MOPS[e]({tids:this.getThreadId()})},_correctThreadMark:function(e){var t=this.getThreadId(),i=ns.Model.get("message",{ids:t});if(i.data){var n=i.get(".new")||0,s=i.getThreadCount();
"mark"===e?n--:n++,n=Math.max(n,0),n=Math.min(n,s),i.setIfChanged(".new",n)}},getThreadMessages:function(e){return _.isUndefined(e)&&(e=this.getThreadId()),ns.Model.get("messages",{thread_id:e})},getThreadMessage:function(e){return _.isUndefined(e)&&(e=this.getThreadId()),e?ns.Model.get("message",{ids:e}):void 0},_correctThreadListMark:function(e,t){var i=this.getThreadId(),n=this.getThreadMessages(i)[e]();return n.checkTidAdjust(t,i),n},_correctThreadListLabel:function(e,t){var i=this.getThreadId(),n=this.getThreadMessages(i)[e](t);
return n.getModelsCount()!==this.getThreadCount()&&n.checkTidAdjust(0/0,i),n},getAddressField:function(e,t){var i=this.getFieldsByType(e);return Daria.formatContacts(i,t)},getToEmail:function(){if(!this.getData())return"";var e="",t=this.getFieldsByType("to"),i=ns.Model.get("account-information").getAllUserEmails();return $.each(t,function(n){var s=t[n].email;if(!s)return!0;for(var a=0;a<i.length;a++)if(i[a].toLowerCase()===s.toLowerCase())return e=i[a],!1}),e},getReplyToEmail:function(){return this.getFieldsByType("reply-to")[0].email||""
},getReplyToName:function(){return this.getFieldsByType("reply-to")[0].name||""},getToEmails:function(){var e=this.getFieldsByType("to");return $.map(e,function(e){return e.email||null})},getToNames:function(){var e=this.getFieldsByType("to");return $.map(e,function(e){return e.name||null})},getFromName:function(){var e=this.getFieldsByType("from")[0];return e&&e.name?e.name:""},getFromEmail:function(){var e=this.getFieldsByType("from")[0];return e&&e.email?e.email:""},getSubject:function(e){var t=this.getData();
if(!t)return"";var i="";return!e&&t.subject_prefix&&(i=t.subject_prefix+" "),i+t.subject},getDate:function(){var e=this.get(".date.iso");return e?e.replace(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})$/,"$3.$2.$1"):""},getTime:function(){var e=this.get(".date.iso");return e?e.replace(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})$/,"$4:$5"):""},getDateTime:function(){return this.getDate()+", "+this.getTime()},getEmailRef:function(e){return this.select('.field[.email=="'+e+'"].ref')[0]},getSelectedInfo:function(e){var t,i,n,s,a=this._readInfo,o=this._countInfo,r=0,l=0;
if(e.mids)for(t=0,i=e.mids.length;i>t;t++)n=e.mids[t],s=o[n],a[n]&&(r+=s),l+=s;if(e.tids)for(t=0,i=e.tids.length;i>t;t++)n=this._threadKeyPrefix+e.tids[t],s=o[n],a[n]&&(r+=s),l+=s;return{read:r,all:l}},isForward:function(){return/^Fwd:/.test(this.getSubject())},hasSocialLabels:function(){return Boolean(this.getSocialLID())},getSocialLID:function(){var e=_.flatten($.makeArray(this.select(".lid"))),t=e.length;if(t)for(var i=ns.Model.get("labels"),n=0;t>n;n++)if(i.isSocial(e[n]))return e[n];return null
},COUPON_SERVICE_TYPES:[13,14],isCouponService:function(){var e=this.COUPON_SERVICE_TYPES;return _.intersection(e,this.get(".type")).length==e.length},CALENDAR_SERVICE_TYPE:42,isCalendarService:function(){return this.hasType(this.CALENDAR_SERVICE_TYPE)},isNews:function(){return this.hasType(13)},isHuman:function(){return this.hasType(4)},hasType:function(e,t){var i=this.get(".type");_.isArray(e)||(e=[e]);var n="all";return t&&(n="any"),i&&_[n](e,function(e){return _.contains(i,e)})},updateThreadsUnreadCount:function(e,t){var i=[];
for(var n in t){var s=this._threadKeyPrefix+n,a=this.getCache(s);if(a){var o,r=a["new"]||0;o="mark"==e?r-t[n].length:r+t[n].length,o=Math.max(0,o),this._readInfo[s]=0===o,o?a["new"]=o:delete a["new"],("mark"==e&&0===o||"unmark"==e&&o>0)&&i.push(n)}}return i},getThreadCount:function(){return this.get(".count")},updateThreadCount:function(e){var t=this.getThreadCount();this.set(".count",t+e)},updateThreadInfo:function(e){if(!this.hasRealData())return!1;if(e.isNew()){var t=this.get(".new");this.set(".new",t+1)
}var i=e.isExternalLike();i&&this.updateThreadContextInfo(e),this.updateThreadCount(1);var n=e.get(".lid"),s=this.get(".lid");s=_.uniq(s.concat(n)),this.set(".lid",s);var a=_.extend({},this.params,{fid:e.get(".fid")}),o=ns.Model.get("message-presentation",a);return o.fill(e),o.ensureOnDestroyBinded(this),!0},updateThreadContextInfo:function(e){this.set(".date",e.get(".date")),this.set(".fid",e.get(".fid")),this.set(".field",e.get(".field")),this.set(".firstline",e.getFirstline()),this.set(".last_mid",e.get(".mid")),this.set(".subject",e.getSubject(!0)),this.set(".subject_prefix",e.get(".subject_prefix")),this.set(".flags.attachment",e.hasAttachment())
},uncheckThreadMessages:function(e){if(e=e||ns.Model.get("messages-checked"),this.isThread()){var t=this.getThreadMessages();_.forEach(t.models,function(t){e.isChecked(t)&&e.check(t,!1)})}},getEmails:function(){var e={},t=this.getData();if(t){var i=t.field;$.each(i,function(t,i){var n=e[i.type]={},s=i.name,a=i.email;a&&(n.ref=i.ref,n.email=a),s&&(n.name=s)})}return e},isYaSupport:function(){var e=ns.Model.get("labels").getLabelByName("yasupport");return e?this.hasLabel(e.lid):!1},isBodyAutoExpand:function(){var e=this.getData();
if(!e)return!1;var t=e.lid;if(!t||!t.length)return!1;for(var i,n=ns.Model.get("labels"),s=0,a=t.length,o=/^(vtnrf0roemru|vtnrf0habrahabr|vtnrf0livejournal)$/;a>s;s++)if(i=n.getLabelById(t[s]),i&&o.test(i.name))return!0;return!1},getFieldsByType:function(e){return this.select('.field[.type == "'+e+'"]')},getFirstline:function(){return this.get(".firstline")||""},getMessageLink:function(){return ns.router.generateUrl("message",{ids:this.get(".mid")})},getMessagesCheckedModel:function(){var e="messages-checked",t=ns.Model.get(e,{mid:this.get(".mid")});
return t.check(this,!0,{silent:!0}),t},getThreadMessagesCheckedModel:function(){var e="messages-checked";if(this.isThread()){var t="all_"+this.get(".mid"),i=ns.Model.get(e,{mid:t}),n=this.getThreadMessages();return i.check(this,!0),_.each(n.models,function(e){i.check(e,!0)}),i}return ns.Model.get(e)},isImportant:function(){var e=ns.Model.get("labels").getImportantLID();return this.hasLabel(e)},isPriority:function(){var e=ns.Model.get("labels").getPriorityLID();return Boolean(e&&this.hasLabel(e))},isPinned:function(){var e=ns.Model.get("labels").getPinnedLabel();
return e?this.hasLabel(e.lid):!1},isDelayed:function(){if(!this.inFolderBySymbol("outbox"))return!1;var e=ns.Model.get("labels").getDelayedMessageLabel();return e&&this.hasLabel(e.lid)?this.get(".date.ts")<Daria.now()?!1:!0:!1},getDelayedTime:function(){return this.isDelayed()?Jane.Date.format("%Date_FT",this.get(".date.ts")):void 0},move:function(e){var t={current_folder:e};this.toMove(t)?this.doMove(e):this.toDelete(t)&&this.remove();var i=new Daria.MOPS.Opinfo;return i.resetAdjust(),i},doMove:function(e){var t,i=this,n=this.getThreadId(),s=this.get(".fid"),a=this.inFolderBySymbol(["trash"]),o=new Daria.MOPS.Opinfo;
s===e?s="":this.set(".fid",e);var r=this.inFolderBySymbol(["trash"]),l=this.inFolderBySymbol(["spam"]),c=this.getThreadMessages(),d=this.isThread();if(d?t=null||this:(t=ns.Model.get("message",{ids:n}),t.hasRealData()||(t=null||this)),r&&this.isNew()&&!d&&this.isIntoThread()&&t._correctThreadMark("mark"),c.isValid())if(d)c.models.forEach(function(t){t.inFolderBySymbol("sent")||t.set(".fid",e)});else if(s){var u=_.findIndex(c.models,function(e){return e.getFolderId()===s});if(-1===u){var h=ns.Model.get("messages",{current_folder:s,threaded:"yes"});
h.isValid()&&h.remove(t),(l||r)&&t.isPinned()&&ns.Model.traverse("messages",function(e){"yes"===e.params.with_pins&&e.remove(t)})}}var m=ns.page.current.params.current_folder;return ns.Model.traverse("messages",function(o){i.isPinned()?(l||r)&&o.remove(i):o.params.current_folder===s||m&&o.params.current_folder===m&&e!==m?o.remove(i):o.params.current_folder===e&&o.insertMessageBySort("yes"===o.params.threaded?t:i);var c=o.params.thread_id;if(r&&!d&&c===n){var u=o.remove(i);if(u){var h=ns.Model.get("message",{ids:c});
h.hasRealData()&&h.updateThreadCount(-1)}}r&&o.isUnreadMessagesCollection()&&o.remove(i),!a||r||d||c!==n||o.insertMessageBySort("yes"===o.params.threaded?t:i)}),ns.Model.invalidateAll("messages-from"),o.resetAdjust(),o},remove:function(){var e=this;ns.Model.traverse("messages",function(t){t.remove(e)}),this._cleaningModelsAfterAction(),ns.Model.get("message-body",{ids:this.params.ids}).destroy(),this.destroy()},getEmailInfoParams:function(){var e=this.getEmails().from,t=e&&e.email&&e.email.toLowerCase();
return t&&Jane.FormValidation.checkEmail(t)?{ref:e.ref,email:t}:null},createMessageCurrentDate:function(){var e=Daria.now(),t=new Date(e),i=Jane.Date.format("%Date_db",e),n=Jane.Date.format("%Date_db_in_HM",e);return{chunks:{date:t.getDate(),hours:t.getHours(),minutes:t.getMinutes(),month:t.getMonth(),year:t.getFullYear()},timestamp:e,user_timestamp:e,view:{attach:i,list:i,message:n,title:n}}},fromComposeMessage:function(e,t){if(this.isValid())return this;var i=ns.Model.get("message",{ids:t}),n=ns.Model.get("message-body",{ids:t}),s=e.get(".from_mailbox"),a=[{email:s,name:e.get(".from_name"),ref:n.getEmailRef(s),type:"from"}];
return a=a.concat(e.formatContacts("to",n),e.formatContacts("cc",n),e.formatContacts("bcc",n)),this.setData({fake:!0,mid:this.params.ids,tid:i.getThreadId()||"t"+this.params.ids,lid:e.get(".lids"),field:a,subject:e.get(".subj"),date:i.createMessageCurrentDate(),types:"4",type:[4],flags:{human:!0},count:1,"new":0})},hasRealData:function(){return this.isValid()&&!this.get(".FAKE_THREAD_DATA")},isCheckedInList:function(){return ns.Model.get("messages-checked").isChecked(this)},isInSharedFolder:function(){return ns.Model.get("folders").isShared(this.getFolderId())
},isMuted:function(){if(!this.isThread())return!1;var e=jpath(ns.Model.get("labels").getMuteThreadLabel(),".lid")[0];return this.hasLabel(e)},isMutable:function(){return this.isThread()&&!this.isMuted()&&!this.isInSharedFolder()},isValidForPin:function(){var e=ns.Model.get("folders"),t=this.getFolderId();return!e.isFolder(t,this.INVALID_FOLDERS_SYMBOLS_FOR_PIN)},hasUserLabel:function(){var e=this.get(".lid");if(!Array.isArray(e)||!e.length)return!1;for(var t=ns.Model.get("labels"),i=0,n=e.length;n>i;i++){var s=t.getLabelById(e[i]);
if(s&&s.user)return!0}return!1},getData4Prediction:function(){var e=this.isMessageThread();if(!e&&this.isThread())return null;if(!this.isValid())return null;var t=this.getData(),i=e?this.getMessageThreadMid():t.mid,n=this.getFolderId(),s=ns.Model.get("folders"),a=s.ids(),o={fid:n,folder_symbol:a[n]||"user",hasattach:this.hasAttachment()?"1":"0",haslabel:this.hasUserLabel()?"1":"0",haspin:this.isPinned()?"1":"0",hasflag:this.isImportant()?"1":"0",isnew:this.isNew()?"1":"0",message_type:t.type.join(",")||"none",mid:i},r=this.getFieldsByType("from");
return o.message_from=r[0]?r[0].email:"",o},hasLabelInDiff:function(e,t){var i=this.get(".lid");return _().xor(i,t).contains(e)},markAnswered:function(){return this.isValid()&&this.set(".flags.replied",!0),new Daria.MOPS.Opinfo},markForwarded:function(){return this.isValid()&&this.set(".flags.forwarded",!0),new Daria.MOPS.Opinfo},isRecipient:function(){var e=ns.Model.get("account-information"),t=this.getFieldsByType("to").concat(this.getFieldsByType("cc"),this.getFieldsByType("bcc"));return _.some(t,function(t){return e.isMyEmail(t.email)
})},_cleaningModelsAfterAction:function(){var e=ns.Model.get("messages-from-item",this.params);e.isValid()&&ns.Model.traverse("messages-from",function(t){t.remove(e)})}}}),ns.Model.define("message-presentation",{params:{ids:null,hid:null,fid:null},methods:{fill:function(e){this.setData({field:e.get(".field"),firstline:e.get(".firstline")})},ensureOnDestroyBinded:function(e){if(this._isBindedOnDestroy){if(e.key!==this._bindedOnDestroyMessageKey){var t="ensureOnDestroyBinded called more then once: was binded to "+this._bindedOnDestroyMessageKey+", now binding to "+e.key;
Jane.ErrorLog.send({errorType:"message-presentation.error",params:JSON.stringify(this.params),errorMessage:t})}}else this._isBindedOnDestroy=!0,this._bindedOnDestroyMessageKey=e.key,this.destroyWith([e])}}},ns.ModelStatic),ns.Model.define("message-widget-events",{params:{ids:null},methods:{request:function(){return ns.request("message-body",this.params).then(this._onRequestSuccess,this._onRequestError,this)},_onRequestSuccess:function(){var e=ns.Model.get("message-body",this.params);return this.params.inc_hid=e.getCalendarICS(),this.params.stid=e.get(".info.stid"),ns.request("get-event-ics",this.params).then(this._onRequestSuccessEventData,function(e){return this.setData({error:e}),Vow.reject(e)
},this)},_onRequestSuccessEventData:function(e){var t=e&&e[0]&&e[0].data;t=t||{},this.setData(t),this.updateEventsData()},updateEventsData:function(){var e=this.getEventKey();e&&(this.hasOutdatedLabelOnMessage()&&this.markOutdated(),ns.Model.traverse("message-widget-events",this._onUpdateEventData.bind(this)))},_onUpdateEventData:function(e){if(e.isValid()){var t=this.getEventKey(),i=ns.Model.get("message-body",this.params),n=i.get(".info.date.timestamp"),s=ns.Model.get("message-body",e.params),a=s.get(".info.date.timestamp");
this!==e&&t===e.getEventKey()&&(n>=a||e.hasOutdatedLabelOnMessage()?e.markOutdated():this.markOutdated())}},getEventKey:function(){var e=this.get(".eventInfo.instanceKey");return e&&e[0]},markOutdated:function(){var e=this.getOutdatedLID();e&&!this.hasOutdatedLabelOnMessage()&&this.setOutdatedLabel(),this.set(".isOutdated",!0)},hasOutdatedLabelOnMessage:function(){var e=this.getOutdatedLID();if(!e)return!1;var t=ns.Model.get("message",this.params);return t.hasLabel(e)},getOutdatedLID:function(){return ns.Model.get("labels").getLIDByName("not_show_widget_event")
},setOutdatedLabel:function(){Daria.MOPS.doActionWithMessage(this.params.ids,"label",{lid:this.getOutdatedLID()})},setEventInfo:function(e){this.set(".eventInfo",e),this.set(".isNotOperate",!1)},_onRequestError:function(e){return this.setData({error:e}),Vow.reject(e)}}}),ns.Model.define("messages-checked",{params:Daria.params.messagesChecked,ctor:function(){this.touch=_.throttle(this.touch,100),this.bTouch=this.touch.bind(this),this.bOnMessagesInserted=this.onMessageInserted.bind(this),this.bOnMessagesRemoved=this.onMessageRemoved.bind(this)
},events:{"ns-model-init":"_onInit","ns-model-destroyed":"_onDestroy"},methods:{INFOLINE_MESSAGES_COUNT:2,_mMessages:null,_onDestroy:function(){this._resetChecked(),this._mMessages.off("ns-model-insert",this.bOnMessagesInserted).off("ns-model-remove",this.bOnMessagesRemoved)},_onInit:function(){this._resetChecked(),this._mMessages=ns.Model.get("messages",this.params),this._mMessages.on("ns-model-insert",this.bOnMessagesInserted).on("ns-model-remove",this.bOnMessagesRemoved)},_resetChecked:function(){var e=this;
_.forIn(this._checked,function(t){t.off("ns-model-touched",e.bTouch)}),this._checked={},this._folderSelected=!1,this._listSelected=!1,this._lastCheckedMessage=null,this.trigger("ns-model-reset-checked"),this._resetMemoize(),this.touch()},_resetMemoize:function(){this.getCount.cache?this.getCount.cache=new _.memoize.Cache:this.getCount=_.memoize(this.getCount),this.getData.cache?this.getData.cache=new _.memoize.Cache:this.getData=_.memoize(this.getData)},isValid:no.True,onMessageInserted:function(e,t){this.isListSelected()&&_.forEach(t,function(e){this.check(e,!0,{silent:!0})
}.bind(this)),this.touch()},onMessageRemoved:function(e,t){_.forEach(t,function(e){this.check(e,!1,{silent:!0})}.bind(this)),this.touch()},resetChecked:function(){this._resetChecked()},getData:function(){return Object.keys(this._checked)},isChecked:function(e){return!!this._checked[e.get(".mid")]},isCheckedByMid:function(e){return Boolean(this._checked[e])},isSearchTopResultByMid:function(e){return this._mMessages.isSearchTopResult(e)},isCheckedByMidFromYate:function(e){var t=yr.nodeset2scalar(e);
return this.isCheckedByMid(t)},toggleCheck:function(e){this.check(e,!this.isChecked(e)),this.setLastChecked(e)},check:function(e,t,i){var n=e.get(".mid"),s=!1;i=_.extend({silent:!1},i),t?this._checked.hasOwnProperty(n)||(this._checked[n]=e,e.on("ns-model-touched",this.bTouch),s=!0):(this._checked.hasOwnProperty(n)&&(delete this._checked[n],e.off("ns-model-touched",this.bTouch),s=!0),this._listSelected=!1,this._folderSelected=!1),s&&(this._resetMemoize(),i.silent||(this.touch(),this.triggerToggleCheckedOnMessage(e,i)))
},triggerToggleCheckedOnMessage:function(e,t){e.trigger("ns-model-checked-toggle",t,this.key)},checkByMidInParams:function(){if(this.params.mid){var e=ns.Model.get("message",{ids:this.params.mid});this.check(e,!0)}return this},isOnlyMessageChecked:function(){var e=this.getIds();return 1===e.ids.length&&0===e.tids.length},isEmptyMessagesList:function(){return this._mMessages.isEmptyList()},isPinnedMessagesList:function(){return this._mMessages.hasOnlyPinnedMessages()},isOnlyMessageOrThreadChecked:function(){var e=this.getIds();
return 1===e.ids.length&&0===e.tids.length||0===e.ids.length&&1===e.tids.length},getOnlyMessageCheckedMid:function(){var e=this.getIds();return 1===e.ids.length&&0===e.tids.length?e.ids[0]:null},getOnlyCheckedMidOrTid:function(e){return e=e||this.getIds(),_.isEmpty(e.tids)?_.isEmpty(e.ids)?null:_.first(e.ids):_.first(e.tids)},getLabels:function(){var e=ns.Model.get("labels").getLabelsHash();return _(this.getCheckedMessages()).forEach(function(t){var i=t.get(".count"),n=t.get(".lid"),s=t.get(".lid_cnt");
_(n).forEach(function(t){e[t]+=i>1?s[t]||0:i}).value()}).value(),e},getFolders:function(){var e=this,t=ns.Model.get("folders").getFoldersHash(),i=this.getIds();return i.ids.concat(i.tids).forEach(function(i){var n=e._checked[i];t[n.getFolderId()]+=n.get(".count")}),t},getCount:function(){var e=this,t=0;if(this.isFolderSelected())t=ns.Model.get("folders").getCount(this.params.current_folder);else{var i=this.getIds();t=i.ids.length,i.tids.forEach(function(i){t+=e._checked[i].get(".count")})}return t
},getPinnedCount:function(){var e=this.getData(),t=0;return e.forEach(function(e){var i=ns.Model.get("message",{ids:e});i.isPinned()&&(t+=1)}),t},getCheckedMessages:function(){var e=this.getIds();return _.map(e.tids.concat(e.ids),function(e){return ns.Model.get("message",{ids:e})})},isFolderSelected:function(){return this._folderSelected},selectFolder:function(){!this._folderSelected&&Boolean(this.params.current_folder)&&(this._folderSelected=!0,this._checkAllFromCollection(),this._resetMemoize(),this.touch())
},getSelectedFolder:function(){return this._folderSelected?this.params.current_folder:null},selectList:function(){this._listSelected=!0,this._checkAllFromCollection(),this._resetMemoize(),this.touch()},isListSelected:function(){return this._listSelected},canShowInfoline:function(){var e=this.getCheckedMessages();return this.getCount()>0&&e.length>=this.INFOLINE_MESSAGES_COUNT},shouldSelectAll:function(){return!this.isListSelected()},toggleSelectAll:function(){this.shouldSelectAll()?this.selectList():this.resetChecked()
},_checkAllFromCollection:function(){var e=this._mMessages.isSearch();this._mMessages.models.forEach(function(t){(!t.isPinned()||e)&&this.check(t,!0)},this)},_areAllCheckedWithSameState:function(e){return this.isFolderSelected()?!1:$.isEmptyObject(this._checked)?!1:_.every(this._checked,function(t){var i=t.isNew();return e?!i:i})},areAllCheckedRead:function(){return this._areAllCheckedWithSameState(!0)},areAllCheckedPinned:function(){var e=this._mMessages.getPinned();if(0===e.length)return!1;var t=this.getCheckedMessages().filter(function(e){return e.isPinned()
});return!_.difference(e,t).length},hasPinnedCheckedMessage:function(){return this.getCheckedMessages().some(function(e){return e.isPinned()})},areAllCheckedNotPinned:function(){var e=this._mMessages.getPinned();if(0===e.length)return!1;var t=this._mMessages.models;if(e.length===t.length)return!1;var i=this.getCheckedMessages(),n=_.difference(t,i);return 0===_.difference(n,e).length},hasMorePages:function(){return this._mMessages.canLoadMore()},getIds:function(e,t){var i={threads:[],messages:[]};
for(var n in this._checked){var s=this._checked[n];if(e){var a="to"+Daria.capitalize(e);if(s[a]&&!s[a](t))continue}i[s.isThreadModel()?"threads":"messages"].push(s)}var o={ids:[],tids:[]};return i.threads.forEach(function(e){var t=e.get(".mid");i.messages=i.messages.filter(function(e){return e.get(".tid")!==t}),o.tids.push(t)}),i.messages.length&&(o.ids=o.ids.concat(i.messages.map(function(e){return e.params.ids}))),o},runAction:function(e,t){var i={action:e,params:t};this.trigger("run-action",i)
},runOps:function(e,t){return Daria.MOPS[e](this,t)},runLabelAction:function(e){return this.runAction("label",{lid:e})},getLastChecked:function(){if(Daria.is2pane())return this._lastCheckedMessage||this._mMessages.models[0];var e=ns.page.current.params.thread_id||ns.page.current.params.ids;return this._lastCheckedMessage||this._mMessages.getMessageByMid(e)||this._mMessages.models[0]},setLastChecked:function(e){this._debugLastCheckedMessage(!1);var t=this.isChecked(e);if(t)return this._lastCheckedMessage=e,void this._debugLastCheckedMessage(!0);
if(t||this._lastCheckedMessage!==e||(this._debugLastCheckedMessage(!1),this._lastCheckedMessage=null),!this._lastCheckedMessage){var i=this._mMessages.models,n=i.indexOf(e);if(-1===n)return void(this._lastCheckedMessage=null);var s,a,o=null,r=1;do{if(s=i[n+r],a=i[n-r],s&&this.isChecked(s)){o=s;break}if(a&&this.isChecked(a)){o=a;break}r++}while(s||a);this._lastCheckedMessage=o,this._debugLastCheckedMessage(!0)}},_debugLastCheckedMessage:function(e){Daria.DEBUG&&this._lastCheckedMessage&&this._lastCheckedMessage.trigger("debug-last-checked-message",e)
}}},ns.ModelStatic),function(){function e(e,i,n){n=n||Number.POSITIVE_INFINITY;for(var s=[],a=ns.Model.get("folders"),o=0,r=e.length;r>o;o++){var l=e[o].getData(),c=e[o].isThread();if((c||a.isIncoming(l.fid)&&t(l,i))&&(s.push(c?{tid:l.tid}:{mid:l.mid}),s.length>=n))break}return s}function t(e,t){return parseInt(e.size,10)<t}ns.Model.define("messages",{events:{"ns-model-before-destroyed":"_setRefreshCount","ns-model-insert":"_arrangeTopResultsFirst","ns-model-remove":"_onModelRemove"},params:{threaded:null,"goto":null,filter_ids:null,current_folder:null,current_label:null,thread_id:null,extra_cond:null,page_number:null,sort_type:"date",request:null,scope:null,unread:null,datePager:null,mrange:null,from:null,to:null,fid:null,lid:null,excluded:null,search:null,force:null,type:null,attaches:null,first:null,count:null,with_pins:"yes"},split:{items:".message",model_id:function(){return"message"
},params:{ids:".mid"}},paramsRewrite:function(e){return e.thread_id&&e.current_folder&&delete e.thread_id,Daria.messages.checkUsePinsByParams(e)?e.with_pins="yes":delete e.with_pins,e},methods:{SEARCH_PARAMS:["request","scope","unread","from","to","excluded","search","type","attaches"],_splitModels:function(){var e=this.super_._splitModels.apply(this,arguments),t=this.params.current_folder;return t&&e.forEach(function(e){if(e.isValid()){var i=_.extend({},e.params,{fid:t}),n=ns.Model.get("message-presentation",i);
n.fill(e),n.ensureOnDestroyBinded(e)}}),e},preprocessData:function(e){return"yes"===this.params.threaded&&(e=this._createThreadsFromMessages(e)),_.defer(this.preloadAllMessages.bind(this)),e},getRequestParams:function(){var e=this.super_.getRequestParams.apply(this,arguments);return this.params.search&&(e.reqid=Daria.Config.ensureSearchSessionId(),this.isSearchNotFilter()&&"count"in e&&(e.count=Math.max(e.count,10))),e},_setRefreshCount:function(){this._refreshCount=this.models.length},_unsetRefreshCount:function(){delete this._refreshCount
},getRequest:function(){var e=this;if(this.isValid())return this;var t=this.getCount()||this._refreshCount;if(!t)return this;var i=this._getCountForRequest(t),n=ns.Model.get(this.id,$.extend({},this.params,{first:this.params.first||0,count:i}));return n.destroy(),n.once("ns-model-changed",function(){e.setData(this.getData()),e._unsetRefreshCount()}),n},_arrangeTopResultsFirst:function(){var e=this;this.isSearchNotFilter()&&Daria.arrangeMatchingFirstInline(this.models,function(t){return e.isSearchTopResult(t.get(".mid"))
})},_onModelRemove:function(e,t){this._updateTheadMetaOnRemove(t),this._updateDetailsForSearch(t)},_updateTheadMetaOnRemove:function(e){var t=this.params.thread_id;if(t){var i=ns.Model.get("message",{ids:t});if(i.hasRealData()){var n=i.get(".last_mid"),s=_.findIndex(e,function(e){return e.params.ids===n&&e.get(".date.timestamp")===i.get(".date.timestamp")});-1!==s&&this.updateThreadMeta(i)}}},_updateDetailsForSearch:function(e){if("undefined"!=typeof this.get(".details.total-found")){var t=this.get(".details.total-found")||0,i=e.length;
this.set(".details.total-found",Math.max(t-i,0));var n=this.get(".details.top-relevant")||0,s=this.get(".details.topResultsMids"),a=0;s&&(e.forEach(function(e){var t=e.get(".mid"),i=s.indexOf(t);i>-1&&(a++,s.splice(i,1))}),a>0&&(this.set(".details.top-relevant",Math.max(n-a,0)),this.set(".details.topResultsMids",s)))}},_createThreadsFromMessages:function(e){return e.message=e.message.map(this._createThreadFromMessage),e},_createThreadFromMessage:function(e){var t=ns.Model.get("message",{ids:e.mid}).setData(e),i=Daria.messages.toCreateThread(t);
if(!i)return e;var n=_.cloneDeep(e);n.last_mid=e.mid,n.mid=n.tid;var s=ns.Model.get("messages",{thread_id:n.tid});return s.isValid()||s.setData({details:{"has-more":!1},message:[e]}),n},loadMore:function(e){var t;e&&!this.isValid()?(t=0,this.clear()):t=this.models.length;var i=ns.Model.get("settings").getSetting("messages_per_page"),n=$.extend({},this.params,{first:t,count:i});return ns.request("messages",n).then(function(e){var t=e[0];this.data&&this.isValid()||(this.data={},this.status=this.STATUS.OK);
var i,n=t.get(".details")||{},s=this.get(".details")||{};("topResultsMids"in n||"topResultsMids"in s)&&(i=_.union(s.topResultsMids,n.topResultsMids));var a=$.extend(s,n);i&&(a.topResultsMids=i),this.set(".details",a,{silent:!0});var o=t.models;return this.insert(o),ns.Model.destroy(t),o},this)},refresh:function(){var e=_.assign({},this.params,{first:0,count:this._getCountForRequest(this.getCount())}),t=ns.Model.get(this.id,e),i=this;return t.once("ns-model-changed",function(){i.setData(this.getData())
}),ns.request.models([t],{forced:!0}).then(function(){ns.Model.destroy(t)})},_getCountForRequest:function(e){var t=ns.Model.get("settings").getSetting("messages_per_page"),i=e?e:t;return i=Math.ceil(i/t)*t,i=Math.min(i,200)},canLoadMore:function(){return Boolean(this.get(".details.has-more"))},getCount:function(){return this.models.length},getUnreads:function(){return this.models.filter(function(e){return e.isNew()})},getUnreadCount:function(){return this.getUnreads().length},getPinned:function(){return this.models.filter(function(e){return e.isPinned()
})},getTotal:function(){for(var e=0,t=0,i=this.models.length;i>t;t++)e+=this.models[t].get(".count");return e},preloadAllMessages:function(){var e=this.params,t=ns.Model.get("folders"),i=e.current_folder;if(!i||!t.spamOrTrash(i)){var n=this.models.map(function(e){var t=e.get(".mid");return e.isThread()?{tid:t}:{mid:t}});Daria.messages.preload(n)}},preloadMessages:function(){var t,i=this.params,n=ns.Model.get("folders"),s=i.current_folder;if(s==n.getFidBySymbol("inbox"))t="inbox";else{if(s in n.ids())return!1;
t="user_folder"}i.thread_id&&(t="thread");var a=this.getUnreads(),o=a.length;if(0===o)return!1;var r=this.getCount(),l=Math.round(o/r*100),c=[],d=10;switch(t){case"user_folder":(d>=r||80>=l)&&(c=e(a,20,d));break;case"thread":default:d>=r||30>=l?c=e(a,50):80>=l&&(c=e(a,50,10))}return Daria.messages.preload(c),!0},getNextPage:function(){return jpath(this.data,".details.pager.next")[0]||null},getPrevPage:function(){return jpath(this.data,".details.pager.prev")[0]||null},deleteMessage:function(e){var t=ns.Model.get("message",{ids:e});
return this.remove(t)},getCountThreadMessageInFolder:function(){var e=!this.canLoadMore();if(e){var t=this.select('.message[.fid == "'+ns.page.current.params.current_folder+'"]');return t.length}return!1},getEmails:function(){var e={};return this.models.forEach(function(t){var i=t.getData(),n={};n.social=t.hasSocialLabels(),n.type=i.type,i.field.forEach(function(e){n[e.type]={ref:e.ref,email:e.email}}),e[i.mid]=n}),e},insertMessage:function(e,t){if(!this.isValid())return!1;ns.events.trigger("daria:vContextMenu:close"),t&&this.remove(t);
var i=0;return"yes"!==this.params.with_pins||e.isPinned()||(i=this.getPinned().length),this.insert(e,i),!0},insertMessageBySort:function(e){if(!this.isValid())return!1;if(this.isEmptyList())this.insert(e);else{var t=i[this.params.sort_type];ns.assert(t,"mMessages","invalid sort type");var n,s,a=this.models.length,o=this.getPinned(),r=o.length;e.isPinned()?(s=this.models.slice(0,r),n=_.findIndex(s,t,e),-1===n&&(n=r)):(s=this.models.slice(r),n=_.findIndex(s,t,e),-1===n?n=a:n+=r),n>=0?this.insert(e,n):this.insert(e)
}},updateThreadMeta:function(e){var t=_.findIndex(this.models,function(e){return e.isExternalLike()});-1===t&&(t=0);var i=this.models[t];i&&e.updateThreadContextInfo(i)},isEmptyList:function(){return this.isValid()&&0===this.getCount()},isSearch:function(){return Object.keys(this.params).some(function(e){return _.include(this.SEARCH_PARAMS,e)},this)},isSearchNotFilter:function(){return Boolean(this.params.search)&&Boolean(this.params.request)&&"rpopinfo"!==this.params.scope},isSearchTopResult:function(e){return(this.get(".details.topResultsMids")||[]).indexOf(e)>-1
},isUnreadMessagesCollection:function(){return"only_new"===this.params.extra_cond||"yes"===this.params.unread},_doOper:function(e,t){var i=new Daria.MOPS.Opinfo,n=this.models.length;if(!n)return i.resetAdjust(),i;i.setModelsCount(n);for(var s=0;n>s;s++){var a=this.models[s][e](t);i.merge(a)}return i},mark:function(){return this._doOper("mark")},unmark:function(){return this._doOper("unmark")},label:function(e){return this._doOper("label",e)},unlabel:function(e){return this._doOper("unlabel",e)},hasOnlyPinnedMessages:function(){return!this.hasUnpinned()&&!this.canLoadMore()
},hasMessageWithLabel:function(e,t){var i=this.models.length;if(!i||i!==t)return null;for(var n=0;i>n;n++)if(this.models[n].hasLabel(e))return!0;return!1},getPrevMessageByMid:function(e){return this.getNearestMessageByMid(e,"prev")},getNextMessageByMid:function(e){return this.getNearestMessageByMid(e,"next")},getNearestMessageByMid:function(e,t){if(!e)return!1;var i=ns.Model.get("message",{ids:e}),n=this.models,s=n.indexOf(i),a=-1;switch(t){case"prev":a=s-1;break;case"next":a=s+1}return n[a]||!1},getMessageByMid:function(e){return _.find(this.models,"params.ids",e)||null
},recalculateIndexesAfterPin:function(e,t){var i=this.params.current_folder;this.remove(e),e.forEach(function(e){(t||!t&&i===e.getFolderId())&&this.insertMessageBySort(e)},this)},getLastReplyMessage:function(){for(var e,t=0,i=this.models.length;i>t&&(e=this.models[t],!e.canReply());t++);return e},getLastReplyMessageQR:function(){return _.find(this.models,function(e){return e.canReplyQR()})},hasUnpinned:function(){return this.models.some(function(e){return!e.isPinned()})}}});var i={from:function(e){return e.getFromName().toLowerCase()>this.getFromName().toLowerCase()
},from1:function(e){return e.getFromName().toLowerCase()<this.getFromName().toLowerCase()},date:function(e){return e.get(".date.ts")<this.get(".date.ts")},date1:function(e){return e.get(".date.ts")>this.get(".date.ts")},size:function(e){return e.get(".length")<this.get(".length")},size1:function(e){return e.get(".length")>this.get(".length")},subject:function(e){return e.getSubject().toLowerCase()>this.getSubject().toLowerCase()},subject1:function(e){return e.getSubject().toLowerCase()<this.getSubject().toLowerCase()
}}}(),ns.Model.define("message-head-state",{params:{ids:null,hid:null},events:{"ns-model-init":function(){var e=ns.Model.get("settings"),t=Boolean(e.hasSetting(this.SETTING_MSG_HEAD_SENDER_CLOSE)&&e.isSet(this.SETTING_MSG_HEAD_SENDER_CLOSE)),i=Boolean(e.hasSetting(this.SETTING_MSG_HEAD_RECIEVERS_OPEN)&&e.isSet(this.SETTING_MSG_HEAD_RECIEVERS_OPEN));this.setData({"sender-closed":t,"recievers-opened":i})}},methods:{SETTING_MSG_HEAD_SENDER_CLOSE:"m_head_folded_sender",SETTING_MSG_HEAD_RECIEVERS_OPEN:"m_head_full_edition",toggleSenderOpened:function(){var e=this.get(".sender-closed");
return this._lockToggleMessageHead||(this._lockToggleMessageHead=!0,ns.Model.get("settings")[e?"setSettingOff":"setSettingOn"](this.SETTING_MSG_HEAD_SENDER_CLOSE,this._onSettingsChangeSuccess.bind(this))),this.set(".sender-closed",!e),!e},setRecieversOpened:function(e){this.set(".recievers-opened",e)},getRecieversOpened:function(){return this.get(".recievers-opened")},toggleRecieversOpened:function(){var e=this.get(".recievers-opened");return this._lockToggleMessageHead||(this._lockToggleMessageHead=!0,ns.Model.get("settings")[e?"setSettingOff":"setSettingOn"](this.SETTING_MSG_HEAD_RECIEVERS_OPEN,this._onSettingsChangeSuccess.bind(this))),this.set(".recievers-opened",!e),!e
},_onSettingsChangeSuccess:function(){this._lockToggleMessageHead=!1}}},ns.ModelStatic),ns.Model.define("module-common",{methods:{MODULES:[],request:function(){var e=this;return new vow.Promise(function(t){Jane.Services.runModules(e.MODULES,function(){e.setData(!0),t()})})}}}),ns.Model.define("module-abook",{methods:{MODULES:["jane.abook.css","jane.abook.js","jane.abook.yate"]}},"module-common"),ns.Model.define("module-compose",{methods:{MODULES:["jane.compose.css","jane.compose2.js","jane.compose2.yate"]}},"module-common"),ns.Model.define("module-editor",{methods:{MODULES:["jane.ckeditor.js","jane.ckeditor.yate","jane.editor.css"]}},"module-common"),ns.Model.define("module-message",{methods:{MODULES:["jane.message.css","jane.message.js","jane.message.yate"]}},"module-common"),ns.Model.define("module-messages",{methods:{MODULES:["jane.messages.css","jane.messages.js","jane.messages.yate"]}},"module-common"),ns.Model.define("module-setup",{methods:{MODULES:["jane.messages.css","jane.setup.css","jane.setup.js","jane.setup.yate"]}},"module-common"),ns.Model.define("module-todo",{methods:{MODULES:["jane.todo.css","jane.todo.js","jane.todo.yate"]}},"module-common"),function(){ns.Model.define("phone-check",{methods:{isValidated:function(e){var t=this.getData();
return e=this.normalize(e),jpath(t,'.[.number == "'+e+'"]').length},normalize:function(e){return e=(e||"").replace(/^8/,"+7")}}})}(),function(){ns.Model.define("phone-unconfirmed",{methods:{hasUnconfirmed:function(){return jpath(this.getData(),'.phone[.valid != "valid"]').length>0},getNumber:function(){var e=this.getData();return e?jpath(e,".phone.number")[0]:""},getIdByNumber:function(e){var t=this.getData();return e&&t?jpath(t,'.phone[.number == "'+e+'"].id')[0]:""}}})}(),ns.Model.define("phone-confirm",{params:{number:null,code:null,phoneid:null},methods:no.extend({_errorsStatus:{DONTKNOWYOU:"Произошла ошибка. Попробуйте позже.",NOCODE:"Вы не ввели код подтверждения.",BADCODEFORMAT:"Неверный формат кода подтверждения.",NOVALIDCODE:function(e){return"Введён неверный код. "+Jane.i18n.convert(["Осталась","Осталось","Осталось"],e)+"&#160;"+e+"&#160;"+Jane.i18n.convert(["попытка","попытки","попыток"],e)+"."
},VALEXEEDED:"Исчерпано предельное число попыток ввести код",TEMPORARYBLOCK:"Пожалуйста, попробуйте ещё раз позже."},parseError:function(e){var t="function"==typeof this._errorsStatus[e]?this._errorsStatus[e].apply(this,[].slice.call(arguments,1)):this._errorsStatus[e];return t||(t=this._errorsStatus.DONTKNOWYOU),t},confirm:function(e,t){if(!e)throw new ReferenceError("Required parameter phoneNumber is undefined");if(!t)throw new ReferenceError("Required parameter code is undefined");var i={code:t,number:e},n=function(){return ns.Model.get("userphones").getPhone(e)
};return this._exec(i).then(n)},_checkSuccessResult:function(e){return e?e.valid?!0:void 0:!1},_parse:function(e){return e=e.phone,e.current=Boolean(parseInt(e.current,10)),e.valid=Boolean(parseInt(e.valid,10)),e}},Jane.PromiseHandlerMixin)},ns.ModelArmour),ns.Model.define("phone-register",{params:{number:null,revalidate:null,secure:null,lang:null,owned:null},methods:$.extend({passportErrors:{DONTKNOWYOU:"Произошла ошибка. Попробуйте позже.",NONUMBER:"Пожалуйста, введите номер телефона",NOROUTE:"Неверный формат номера телефона. Пожалуйста, введите номер в формате +7 916 123 45 67",BADNUMFORMAT:"Неверный формат номера телефона. Пожалуйста, введите номер в формате +7 916 123 45 67",VALEXEEDED:"Каждый пользователь может настроить только три привязки в сутки. Пожалуйста, продолжите завтра",TEMPORARYBLOCK:"Пожалуйста, попробуйте ещё раз позже.",NUMEXISTS:'Указанный номер уже <a href="https://phone-passport.yandex.ru/phones" target="_blank">зарегистрирован</a>, но не был подтверждён',CONFIRMED_NUMBER_EXISTS:'Изменить основной номер телефона можно в <a href="https://phone-passport.yandex.ru/phones" target="_blank">Паспорте</a>',UNFINISHED_OP_EXISTS:'Изменить основной номер телефона можно в <a href="https://phone-passport.yandex.ru/phones" target="_blank">Паспорте</a>',NUMBINDLIMIT:'Этот номер уже привязан к трём почтовым ящикам. Пожалуйста, введите другой номер телефона или <a href="http://help.yandex.ru/mail/security.xml#number-confirmation" target="_blank">отмените предыдущие привязки</a>.'},parseError:function(e){var t=this.passportErrors[e];
return t||(t=this.passportErrors.DONTKNOWYOU),t},register:function(e,t){if(!e)throw new ReferenceError("Required parameter phoneNumber is missing");var i={number:e};i.secure=t?"yes":"no";var n=function(){return ns.Model.get("userphones").getPhone(e)};return this._exec(i).then(n)},resendCode:function(e){if(!e)throw new ReferenceError("Required parameter phoneNumber is missing");var t={number:e},i=function(){return ns.Model.get("userphones").getPhone(e)};return this._exec(t).then(i)},_checkSuccessResult:function(e){return e.added||e.revalidated?!0:void 0
},_parse:function(e){return e.phone.added=Boolean(e.phone.added),e.phone},getNumber:function(){var e=this.getData();return jpath(e,".phone.number")[0]||ns.Model.get("settings").getSetting("phone-number")||""},getFormattedNumber:function(e){var t;return(e=e||this.getNumber())?(t=e.match(/^(\+?7)(\d{3})(\d{3})(\d{2})(\d{2})$/),t?"{1} ({2}) {3}-{4}-{5}".replace(/{(\d)}/g,function(e,i){return i&&t[i]}):e):""}},Jane.PromiseHandlerMixin)},ns.ModelArmour),ns.Model.define("scroller-common",{methods:{EVENT_NAME:"MUST_BE_DEFINED",HEIGHT_KEY:".height",SCROLL_HEIGHT_KEY:".scroll-height",SCROLL_BOTTOM_KEY:".scroll-bottom",SCROLL_TOP_KEY:".scroll-top",_rafTimer:0,_$area:null,init:function(){this.getScroller(),this._onResizeBinded||(this._onResizeBinded=!0,ns.Model.get("dimensions").on("resize",this._onScroll.bind(this)))
},_initScroller:function(){var e="scroll."+this.id;this._$area&&(this._$area.off(e),this._$area=null),this._$area=this._getScroller(),this._$animatedArea=this._$area[0]===window?$("body, html"):this._$area,this._$area.on(e,this._onScroll.bind(this))},_getScroller:ns.todo,_onScroll:function(){this._rafTimer||(this.clean(),ns.events.trigger(this.EVENT_NAME))},clean:function(){this.setData({},{silent:!0}),this._rafTimer=0},getScrollOffset:function(){return 0},getNodeTop:function(e){var t=this.getScroller()[0];
if(t===window)return e.getBoundingClientRect().top+this.getScrollTop();var i=0,n=e;do if(i+=n.offsetTop,n=n.offsetParent,n&&n===t)break;while(n);return i},getScroller:function(){var e=this._$area&&this._$area[0];return e&&($.isWindow(e)||document.body.contains(e))||this._initScroller(),this._$area},getHeight:function(){var e=this.get(this.HEIGHT_KEY);return"number"!=typeof e&&(e=this.getScroller().height(),this._setDimension(this.HEIGHT_KEY,e)),e},getScrollHeight:function(){var e=this.get(this.SCROLL_HEIGHT_KEY);
return"number"!=typeof e&&(e=this.getScroller().prop("scrollHeight"),this._setDimension(this.SCROLL_HEIGHT_KEY,e)),e},getScrollBottom:function(){var e=this.get(this.SCROLL_BOTTOM_KEY);return"number"!=typeof e&&(e=this.getScrollHeight()-this.getHeight()-this.getScrollTop(),this._setDimension(this.SCROLL_BOTTOM_KEY,e)),e},getScrollTop:function(){var e=this.get(this.SCROLL_TOP_KEY);return"number"!=typeof e&&(e=this.getScroller().scrollTop(),this._setDimension(this.SCROLL_TOP_KEY,e)),e},getVDimensions:function(){var e=this.getScrollTop()+this.getScrollOffset(),t=this.getHeight();
return{bottom:e+t,top:e}},setScrollTop:function(e,t){if(this._$animatedArea.stop(),t){var i=this;this._rafTimer="ANIMATED",this._$animatedArea.animate({scrollTop:e},{duration:"fast",always:function(){i._rafTimer=null,i._onScroll()}})}else this._$animatedArea.scrollTop(e)},scrollIntoView:function(e,t){t=t||{};var i,n="boolean"==typeof t.alignToTop,s=Number(t.viewTopOffset)||0,a=Number(t.viewBottomOffset)||0,o=$(e),r=t.relative?e.offsetTop:o.offset().top,l=r+o.outerHeight(),c=this.getScrollTop()+Math.abs(s),d=c+this.getHeight()+a;
return l>d&&(t.alignToTop===!1||!n)?i=c+(l-d):c>r&&(t.alignToTop===!0||!n)&&(i=r+s),"undefined"!=typeof i?(i=Math.max(Math.floor(i),0),this.setScrollTop(i,Boolean(t.animate)),!0):!1},isRelativeOffset:function(){return!1},_setDimension:function(e,t){this.set(e,t,{silent:!0})}}},ns.ModelStatic),ns.Model.define("scroller-message",{events:{"ns-model-init":"clean"},methods:{THREAD_HEAD_HEIGHT:51,EVENT_NAME:"daria:vScrollerMessage:scroll",getScrollOffset:function(){return this.THREAD_HEAD_HEIGHT},isRelativeOffset:function(){return Daria.is3pane()
},_getScroller:function(){return $(Daria.is2pane()?window:".js-message-scroll-area")}}},"scroller-common"),ns.Model.define("scroller-messages",{events:{"ns-model-init":"clean"},methods:{EVENT_NAME:"daria:vScrollerMessages:scroll",FIXED_HEAD_HEIGHT:60,FIXED_TOOLBAR_HEIGHT:36,_getScroller:function(){return $(Daria.is2pane()?window:".js-messages-scroll-area")},getScrollOffset:function(){var e=this.FIXED_HEAD_HEIGHT;return Daria.is2pane()&&(e+=this.FIXED_TOOLBAR_HEIGHT),e}}},"scroller-common"),ns.Model.define("scroller-compose",{events:{"ns-model-init":"clean"},methods:{EVENT_NAME:"daria:vScrollerCompose:scroll",getScrollOffset:function(){return 0
},isRelativeOffset:function(){return!1},_getScroller:function(){return $(Daria.is2pane()?window:".js-compose-scroller")}}},"scroller-common"),ns.Model.define("scroller-abook-contacts",{events:{"ns-model-init":"clean"},methods:{EVENT_NAME:"daria:vScrollerAbookContacts:scroll",FIXED_HEAD_HEIGHT:60,FIXED_TOOLBAR_HEIGHT:36,_getScroller:function(){return $(Daria.is2pane()?window:".js-entries-container")},getScrollOffset:function(){var e=this.FIXED_HEAD_HEIGHT;return Daria.is2pane()&&(e+=this.FIXED_TOOLBAR_HEIGHT),e
}}},"scroller-common"),ns.Model.define("search-session-state",{params:{},events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({searchResultsReceivedTs:null})},getSearchResultsReceivedTs:function(){return this.get(".searchResultsReceivedTs")},onSearchResultsReceived:function(){var e=Date.now();this.set(".searchResultsReceivedTs",e)}}},ns.ModelStatic),ns.Model.define("search-view",{params:{},events:{"ns-model-init":"onInit"},methods:{onInit:function(){this.setData({folded:!0,focused:!1,simplifiedRequest:"",maxWidth:340,searchOptions:{}})
},getClearSearchOptions:function(){return _.omit(this.get(".searchOptions"),function(e){return null==e||"all"===e})},setSearchOptions:function(e){this.set(".searchOptions",e)},setFolded:function(e){return this.setIfChanged(".folded",e)},isFolded:function(){return this.get(".folded")},wasSimplified:function(){return this.get(".simplifiedRequest")===ns.page.current.params.request}}},ns.ModelStatic),ns.Model.define("secret-key"),function(){ns.Model.define("service-emails",{methods:{is:function(e){var t=e.split("@"),i={login:t[0],domain:t[1],full:e},n=this.getData();
if(!n)return!0;for(var s in i)if(-1!==$.inArray(i[s],n[s]))return!0;return!1}}},ns.ModelArmour)}(),ns.Model.define("email-info",{events:{"ns-model-init":"_onInit"},params:{email:null,ref:null},methods:{_onInit:function(){this.params.email||this.setData({})}}}),ns.Model.define("informer-afisha",{params:{slug:null}}),ns.Model.define("informer-afisha-code",{params:{city:null}}),ns.Model.define("informer-khl-personstats",{maxage:1e3}),function(){var e=14;ns.Model.define("informer-khl-events",{maxage:1800,methods:{preprocessData:function(e){var t=e.events,i=$.now(),n=this.getDaysBounds(i);
_.mixin({filterMatchesInTwoDaysWindow:this.filterMatchesInTwoDaysWindow.bind(this)}),_.mixin({truncateMatchesToFitInMaxCount:this.truncateMatchesToFitInMaxCount.bind(this)}),_.mixin({groupMatchesByDays:this.groupMatchesByDays.bind(this)});var s=null,a=_(t).chain().sortBy("id").filterMatchesInTwoDaysWindow(i).tap(function(e){s=this.getClosestMatchToNow(e,i)}.bind(this)).truncateMatchesToFitInMaxCount(s).groupMatchesByDays(n).value();return e.yesterday={matches:a.yesterday},e.today={matches:a.today},e.tomorrow={matches:a.tomorrow},e.timeBound={yesterday:n.yesterdayStart,tomorrow:n.tomorrowEnd},delete _.prototype.filterMatchesInTwoDaysWindow,delete _.prototype.truncateMatchesToFitInMaxCount,delete _.prototype.groupMatchesByDays,e
},getMaxMatchesInTableCount:function(){return e},filterMatchesInTwoDaysWindow:function(e,t){var i=Daria.timify({days:1}),n=t-i,s=t+i;return _.filter(e,_.partial(this.isMatchInRange,n,s))},isMatchInRange:function(e,t,i){return i.timestamp>=e&&i.timestamp<t},getClosestMatchToNow:function(e,t){return _.min(e,function(e){return Math.abs(e.timestamp-t)})},getDaysBounds:function(e){var t=new Date(e),i=t.getDate(),n=t.getMonth(),s=t.getFullYear(),a=new Date(s,n,i-1,0,0,0,0).getTime(),o=new Date(s,n,i,0,0,0,0).getTime(),r=new Date(s,n,i,23,59,59,0).getTime(),l=new Date(s,n,i+1,23,59,59,0).getTime();
return{yesterdayStart:a,todayStart:o,todayEnd:r,tomorrowEnd:l}},groupMatchesByDays:function(e,t){var i=this,n=t.yesterdayStart,s=t.todayStart,a=t.todayEnd,o=t.tomorrowEnd;return _(e).groupBy(function(e){return i.isMatchInRange(n,s,e)?"yesterday":i.isMatchInRange(s,a,e)?"today":i.isMatchInRange(a,o,e)?"tomorrow":void 0}).value()},truncateMatchesToFitInMaxCount:function(e,t){var i=_.findIndex(e,{id:t.id}),n=e.splice(0,i+1);return e=_(n).chain().reverse().zip(e).flatten().compact().slice(0,this.getMaxMatchesInTableCount()).sortBy("id").value()
}}})}(),ns.Model.define("informer-tanks-news",{events:{"ns-model-init":"onInit"},methods:{onInit:function(){setInterval(function(){ns.Model.invalidate("informer-tanks-news")},18e5)},preprocessData:function(e){return _.isEmpty(e)?void 0:(e.forEach(function(e){e.date&&(e.date.view=Daria.MessageTime.getFormattedTime(e.date.timestamp)),e.firstline&&(e.firstline=$(e.firstline)[0].innerText.trim())}),e)}}}),function(){var e=149,t=1e3,i=5e4,n=1e5,s=3*Jane.Date.MONTH,a={};a._processKhl=function(){var e=this.getData(),t=jpath(e,'.color-theme[.id == "khl" ]');
if(!t.length)return null;t=t[0];var i=jpath(e,'.color-theme[.id == "khl" ].skins')[0].filter(function(e){return 213!=e.areaCode&&1!=e.areaCode&&22!=e.areaCode}).map(function(e){return e.areaCode});return!this._regionThemeExists&&Daria.isRegion(i)&&this._setMaxPopularity(t),t},a._setMaxPopularity=function(e){return this._maxPopularitySet||(e.popularityPriority=-1,this._maxPopularitySet=!0),e},a._setNew=function(e){e["new"]=this._now-(e.timestamp||0)<s},a._postProcess=function(e){var t=Daria.isRegion(e.region);
return this._setNew(e),"region"in e&&(e.hidden=!t,t&&(this._regionThemeExists=!0,this._setMaxPopularity(e))),this._isGalatasaray&&["galatasaray","besiktas","fenerbahce"].indexOf(e.id)>-1?e["disabled-in"]="TUR RUS INT":this._isGalatasaray&&"galatasaray-net"===e.id&&(e["disabled-in"]="RUS INT",this._setMaxPopularity(e)),"seasons"===e.id&&"TUR"===Daria.Config.product&&(e["new"]=!1),"belarus"===e.id&&this._isBelarus&&this._setMaxPopularity(e),e},a._popularityComparator=function(e){return e.popularityPriority?e.popularityPriority>=t?t-1:e.popularityPriority:e.timestamp?t+Math.floor((this._now-e.timestamp)/Jane.Date.DAY):e.priority?i+e.priority>=n?n-1:i+e.priority:n
},a._timestampComparator=function(e){return e.timestamp?t+Math.floor((this._now-e.timestamp)/Jane.Date.DAY):e.priority?i+e.priority>=n?n-1:i+e.priority:n},a._getPromoTheme=function(){var e=this.getData(),t=jpath(e,".color-theme[.promo]");return t=_.find(t,function(e){return!e["disabled-in"]||-1===e["disabled-in"].indexOf(Daria.Config.product)}),t||null},a._isPromoExpired=function(){var e=this.getData();return e.promo?this._now-e.promo.timestamp>Jane.Date.MONTH:!0},a._userHasNewTheme=function(){var e=this.getSchemeById(Daria.themeId);
return e?e["new"]:!1},a.isPromoNeeded=function(){var e=this.getData();if(!e.promo)return!1;var t=ns.Model.get("settings"),i=t.getSetting(t.getPromoThemeSettingName(!0));return!this._isPromoExpired()&&!this._userHasNewTheme()&&!Daria.IS_CORP&&i!==e.promo.id},a.getSchemeById=function(e){for(var t=this.getData(),i=t["color-theme"].length;i--;)if(t["color-theme"][i].id===e)return t["color-theme"][i];return null},a.getSchemeByRegion=function(e){var t=this.getData(),i=t["color-theme"].length;e=$.isArray(e)?e:[e];
for(var n=0;n<e.length;n++)e[n]=String(e[n]);for(;i--;){var s=String(t["color-theme"][i].region);if($.inArray(s,e)>-1)return t["color-theme"][i]}return null},a._limitPopularThemes=function(){var e=this.getData(),t=_(e["color-theme"]).filter(function(e){return!!e.popularityPriority}).sortBy("popularityPriority").value();if(t.length>5)for(var i=5;i<t.length;i++)delete t[i].popularityPriority;return e},a.init=function(){var t=this.getData();this._now=Daria.now(),this._isGalatasaray=$.inArray("61",Daria.SIDS)>=0,this._isBelarus=Daria.isRegion(e),this._maxPopularitySet=!1,this._regionThemeExists=!1;
var i=this;t["color-theme"]=$.map(t["color-theme"],function(e){var t=i._postProcess(e);return t["disabled-in"]&&t["disabled-in"].indexOf(Daria.Config.product)>-1?null:t}),this._processKhl(),this._limitPopularThemes(t),t["popularity-sorted"]={},t["popularity-sorted"]["color-theme"]=_.sortBy(t["color-theme"],this._popularityComparator.bind(this)),t["timestamp-sorted"]={},t["timestamp-sorted"]["color-theme"]=_.sortBy(t["color-theme"],this._timestampComparator.bind(this)),t.promo=this._getPromoTheme()
},ns.Model.define("settings-color-schemes",{events:{"ns-model-init":function(){var e=function(){var e=["blue","green","grass_green","orange","yellow","pink","red","lightblue","turquoise","violet","gray","pink-navy-sand","plum-navy","teal-orange","terra-salad"],t={lite:{color_scheme:"colorful","colorful-theme-skin":"gray"},blue:{color_scheme:"colorful","colorful-theme-skin":"blue"},violet:{color_scheme:"colorful","colorful-theme-skin":"violet"},red:{color_scheme:"colorful","colorful-theme-skin":"red"},green:{color_scheme:"colorful","colorful-theme-skin":"green"},orange:{color_scheme:"colorful","colorful-theme-skin":"orange"},turquoise:{color_scheme:"colorful","colorful-theme-skin":"lightblue"},pink:{color_scheme:"colorful","colorful-theme-skin":"pink"}},i={"colorful-theme-skins":e,"colorful-theme-rewrites":t,"color-theme":[{id:"starwars",name:"Звёздные войны",theme:"nice",priority:0,modifiers:20,"disabled-in":"INT TUR",timestamp:14004432e5,favicon:"black-favicon",promo:!0,share:{link:"promo-themes/starwars/?shareSide=mail",title:"Звёздные войны в Яндекс.Почте",description:"Джедаи и ситхи, клоны и дроиды. Пришло время выбрать свою сторону Силы в новой теме оформления Яндекс.Почты.",twitter:"Звёздные войны в Яндекс.Почте — выберите свою сторону Силы",image:"b-color-scheme__theme.large.jpg",twitterLink:"ya.cc/m/xYeGfXtpCTwL"}},{id:"foxes",name:"Лисички",theme:"nice",favicon:null,timestamp:13962096e5,modifiers:6,priority:1,share:{link:"promo-themes/foxes/",title:"Лесная почта",description:"Пришла весна, хочется на природу. На полях появляются рисунки про лес и лис. Поселите добрых зверей в своей Почте, и природа станет ближе.",twitter:"В моей Яндекс.Почте появились лисы",image:"b-color-scheme__theme.large.jpg",twitterLink:"clck.ru/98LrB"}},{id:"galatasaray-net",name:"Galatasaray.net",theme:"nice",favicon:null,priority:1,modifiers:1,"disabled-in":"INT RUS TUR",share:{link:"http://mail.yandex.com.tr/promo-themes/galatasaray/",twitterLink:"http://ya.cc/m/6tU6syJb0Nfm",title:"Специальная тема для пользователей GSYandex!",description:"Раскрась свою почту в цвета любимой команды. Специальная тема только для пользователей Galatasaray.net!",twitter:"Специальная почтовая тема для пользователей Galatasaray.net!",image:"galatasaray-net.jpg"}},{id:"galatasaray",name:"Galatasaray",theme:"nice",favicon:null,priority:7,modifiers:1,"disabled-in":"INT RUS",share:{link:"http://mail.yandex.com.tr/promo-themes/galatasaray/",title:"Тема оформления Галатасарай в Яндекс.Почте",description:"Галатасарай! Яндекс.Почта в жёлто-красных цветах",twitter:"Галатасарай! Яндекс.Почта в жёлто-красных цветах @YandexComTr",image:"galatasaray.jpg"}},{id:"fenerbahce",name:"Fenerbahce",theme:"nice",favicon:null,priority:8,modifiers:1,"disabled-in":"INT RUS",share:{link:"http://mail.yandex.com.tr/promo-themes/fenerbahce/",title:"Тема оформления Фенербахче в Яндекс.Почте",description:"Фенербахче! Яндекс.Почта в жёлто-синих цветах.",twitter:"Фенербахче! Яндекс.Почта в жёлто-синих цветах @YandexComTr",image:"fenerbahce.jpg"}},{id:"besiktas",name:"Besiktas",theme:"nice",favicon:null,priority:9,modifiers:1,"disabled-in":"INT RUS",share:{link:"http://mail.yandex.com.tr/promo-themes/besiktas/",title:"Тема оформления Бешикташ в Яндекс.Почте",description:"Бешикташ! Яндекс.Почта в чёрно-белых цветах.",twitter:"Бешикташ! Яндекс.Почта в чёрно-белых цветах @YandexComTr",image:"besiktas.jpg"}},{id:"belarus",name:"Беларусь","disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"10",share:{link:"promo-themes/belarus/",title:"Белорусская Яндекс.Почта",description:"Новая тема оформления в Яндекс.Почте специально для Беларуси",twitter:"Новая тема оформления в Яндекс.Почте специально для Беларуси",image:"b-color-scheme__theme.large.jpg"}},{id:"region_tomsk",name:"Томск",region:67,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"3",share:{link:"region_tomsk/?1",title:"Специально для Томска",description:"Оформление Яндекс.Почты с фотографиями города, погодой и афишей.",twitter:"Оформление Яндекс.Почты с фотографиями города, погодой и афишей.",image:"b-color-scheme__theme.medium.jpg"},bubble:{img:"region_tomsk.large",name:"Томск",title:"Специально для Томска",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Дом с драконами","Спасская башня Томского кремля","Богоявленский кафедральный собор"]},{id:"region_bashkir",name:"Башкортостан",region:11111,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"10",share:{link:"region_bashkir/?1",title:"Заведите почту с видами республики, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Башкортостана.",twitter:"Новая тема оформления в Яндекс.Почте специально для Башкортостана.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_bashkir.large",name:"Башкортостан",title:"Специально для Башкортостана",description:"Новая тема оформления с видами республики, погодой и афишей."},texts:["Инзерские зубчатки","Гора Малый Иремель","Горное ущелье, Абзаково","Конгресс-холл, Уфа","Тыгынский курум","Ахуновские менгиры","Город Бирск","Озеро Аслыкуль","Арский камень","Мечеть Ляля-Тюльпан, Уфа"]},{id:"region_ekb",name:"Свердловская",region:11162,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"8",share:{link:"region_ekb/?1",title:"Заведите почту с видами области, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Свердловской области.",twitter:"Новая тема оформления в Яндекс.Почте специально для Свердловской области.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_ekb.large",name:"Свердловская",title:"Специально для Свердловской области",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Вид с плотинки","Ночной Екатеринбург","Нижний Тагил","Осень на Новомариинском водохранилище","Храм-на-Крови, Екатеринбург","Сельский пейзаж на закате, Свердловская область","Природный парк Оленьи Ручьи","Крестовоздвиженский собор, Верхотурье"]},{id:"region_krasnoyarsk",name:"Красноярская",region:11309,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"10",share:{link:"region_krasnoyarsk/?1",title:"Заведите почту с видами края, погодой и афишей",description:"'Новая тема оформления в Яндекс.Почте специально для Красноярского края.",twitter:"'Новая тема оформления в Яндекс.Почте специально для Красноярского края.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_krasnoyarsk.large",name:"Красноярская",title:"Специально для Красноярского края",description:"Новая тема оформления с видами края, погодой и афишей."},texts:["Норильск","Озеро Лама","Собор Спаса Нерукотворного Образа, Минусинск","Часовня, Красноярск","Красноярская гидроэлектростанция","Гало, Таймыр","Пешеходный мост в Красноярске","Озеро Художников, хребет Ергаки, Западные Саяны","Заповедник Столбы","Смотровая площадка, Красноярск"]},{id:"region_nn",name:"Нижегородская",region:11079,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"7",share:{link:"region_nn/?1",title:"Заведите почту с видами области, погодой и афишей",description:"Новая тема оформления с видами области, погодой и афишей.",twitter:"Новая тема оформления с видами области, погодой и афишей.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_nn.large",name:"Нижегородская",title:"Специально для Нижегородской области",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Городец","Церковь Успения Пресвятой Богородицы, Большое Болдино","Кафедральный собор, Арзамас","Шуховская башня под Нижним Новгородом","Мост через Оку в Нижнем Новгороде","Дивеевский монастырь","Макарьевский монастырь"]},{id:"region_novosibirsk",name:"Новосибирская",region:11316,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"8",share:{link:"region_novosibirsk/?1",title:"Заведите почту с видами области, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Новосибирской области.",twitter:"Новая тема оформления в Яндекс.Почте специально для Новосибирской области.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_novosibirsk.large",name:"Новосибирская",title:"Специально для Новосибирской области",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Вид с горы Пихтовый Гребень","Новосибирск","Степной пейзаж у озера Чаны","Обское море","Новосибирский вокзал","Преображенский собор, Бердск","Река Бердь осенью","Железнодорожный мост через Обь"]},{id:"region_perm",name:"Пермский край",region:11108,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"11",share:{link:"region_perm/?1",title:"Заведите почту с видами края, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Пермского края.",twitter:"Новая тема оформления в Яндекс.Почте специально для Пермского края.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_perm.large",name:"Пермский край",title:"Специально для Пермского края",description:"Новая тема оформления с видами края, погодой и афишей."},texts:["Река Кама","Река Сылва","Церковь Преображения, Хохловка","Набережная, вид с реки Кама, Пермь","Вознесенско-Феодосиевская церковь, Пермь","Троицкий собор, Соликамск","Белогорский монастырь","Каменный город, Гремячинский район","Кунгурская ледяная пещера, грот Полярный","Воскресенский собор в Чердыни","Ветлан, вид на Вишеру"]},{id:"region_primorie",name:"Приморье",region:11409,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"7",share:{link:"region_primorie/?1",title:"Заведите почту с видами края, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Приморского края.",twitter:"Новая тема оформления в Яндекс.Почте специально для Приморского края.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_primorie.large",name:"Приморье",title:"Специально для Приморского края",description:"Новая тема оформления с видами края, погодой и афишей."},texts:["Полет над Находкой","Владивосток","Маяк Токаревская кошка","Храм Покрова в Уссурийске","Полуостров Гамова","Скала Два брата","Город Драконов"]},{id:"region_samara",name:"Самарская",region:11131,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"8",share:{link:"region_samara/?1",title:"Заведите почту с видами области, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Самарской области.",twitter:"Новая тема оформления в Яндекс.Почте специально для Самарской области.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_samara.large",name:"Самарская",title:"Специально для Самарской области",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Туман на реке, Самарская область","Федоровские луга","Колокольня на источнике, Сызрань","Жигули, Молодецкий курган","Здание заводоуправления, Тольятти","Иверский женский монастырь","Площадь Славы","Ладья, набережная Волги, Самара"]},{id:"region_tatarstan",name:"Татарстан",region:11119,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"6",share:{link:"region_tatarstan/?1",title:"Заведите почту с видами республики, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Татарстана.",twitter:"Новая тема оформления в Яндекс.Почте специально для Татарстана.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_tatarstan.large",name:"Татарстан",title:"Специально для Татарстана",description:"Новая тема оформления с видами республики, погодой и афишей."},texts:["Устье реки Свияга","Свияжск","Зимняя природа, Татарстан","Грузовой порт в Набережных Челнах","Соборная мечеть, Нижнекамск","Зилант, Казань"]},{id:"region_chelly",name:"Челябинская",region:11225,"disabled-in":"TUR",theme:"nice",favicon:null,priority:600,modifiers:"9",share:{link:"region_chelly/?1",title:"Заведите почту с видами области, погодой и афишей",description:"Новая тема оформления в Яндекс.Почте специально для Челябинской области.",twitter:"Новая тема оформления в Яндекс.Почте специально для Челябинской области.",image:"b-color-scheme__theme.medium.png"},bubble:{img:"region_chelly.large",name:"Челябинская",title:"Специально для Челябинской области",description:"Новая тема оформления с видами области, погодой и афишей."},texts:["Озеро Зюраткуль","Озеро Аракуль","Аракульские Шиханы","Южно-Уральский Государственный университет","Храм Вознесения Господня, Магнитогорск","«Эйфелева башня» в селе Париж","закат над Таганаем","Магнитогорский Металлургический комбинат","Озеро Зюраткуль"]},{id:"region_volgograd",name:"Волгоград",region:10950,hidden:!1,"disabled-in":"TUR INT",theme:"nice",favicon:null,priority:599,modifiers:"6",timestamp:13922352e5,share:{link:"promo-themes/volgograd/",title:"Яндекс.Почта для Волгограда",description:"Фотографии любимого города в вашей почте.",twitter:"Фотографии любимого города в вашей почте.",image:"b-color-scheme__theme.large.jpg"},bubble:{img:"b-color-scheme__theme.large",name:"Волгоград",title:"Яндекс.Почта для Волгограда",description:"Фотографии любимого города в вашей почте."},texts:["Показать фон","Показать фон","Показать фон","Показать фон","Показать фон","Показать фон"]},{id:"dreams",name:"Сны",theme:"nice",favicon:null,priority:6,modifiers:1,share:{link:"promo-themes/dreams/",title:"Сны в Яндекс.Почте",description:"Новая сонная тема оформления.",twitter:"Новая сонная тема оформления в Яндекс.Почте",image:"b-color-scheme__theme.large.jpg"}},{id:"love_is",name:"Любовь это...",theme:"nice",favicon:null,priority:1,modifiers:3,timestamp:13923216e5,share:{link:"promo-themes/loveis/",title:"Яндекс.Почта знает, что любовь это...",description:"Завтрак в постель, записки на зеркале и когда молоко убежало. Больше — в новой теме оформления.",twitter:"Яндекс.Почта знает, что любовь это...",image:"b-color-scheme__theme.large.jpg"},texts:[["Любовь — это наш секрет","Любовь — это приятные мелочи","Любовь — это то, что нуждается в заботе"],["Любовь — это всегда быть плечом к плечу","Любовь — это оставаться детьми в душе","Любовь — это когда невозможно устоять"],["Любовь — это надеяться, что дождь не закончится","Любовь — это вместе радоваться любой погоде","Любовь — это когда звук дождя становится музыкой"]]},{id:"nemo",name:"В поисках Немо",theme:"nice",favicon:null,priority:2,modifiers:3,share:{link:"promo-themes/nemo/",title:"Герои «В поисках Немо» в Яндекс.Почте",description:"Запустите в почтовый ящик рыбку-клоуна и других обитателей морских глубин.",twitter:"Герои «В поисках Немо» в Яндекс.Почте",image:"nemo-social.jpg"}},{id:"khl",name:"Хоккей",theme:"nice",favicon:null,priority:7,modifiers:"31","disabled-in":"TUR INT",share:{link:"promo-themes/khl/",title:"Новый хоккейный сезон",description:"Следите за новостями Континентальной хоккейной лиги прямо в Яндекс.Почте",twitter:"Следите за новостями Континентальной хоккейной лиги прямо в Яндекс.Почте",image:"b-color-scheme__theme.large.jpg"},skins:[{team:"Авангард",skin:1,area:"Омская область",areaCode:11318,group:"b",flag:"ru"},{team:"Автомобилист",skin:2,area:"Екатеринбург",areaCode:54,group:"b",flag:"ru"},{team:"Ак барс",skin:3,area:"Казань",areaCode:43,group:"b",flag:"ru"},{team:"Амур",skin:4,area:"Хабаровск",areaCode:76,group:"b",flag:"ru"},{team:"Атлант",skin:5,area:"Московская область",areaCode:1,group:"a",flag:"ru"},{team:"Адмирал",skin:29,area:"Владивосток",areaCode:75,group:"b",flag:"ru"},{team:"Барыс",skin:6,area:"Астана",areaCode:163,group:"b",flag:"kz"},{team:"Витязь",skin:7,area:"Чехов",areaCode:10761,group:"a",flag:"ru"},{team:"Динамо",skin:8,area:"Минск",areaCode:157,group:"a",flag:"by"},{team:"Динамо",skin:9,area:"Москва",areaCode:213,group:"a",flag:"ru"},{team:"Динамо",skin:10,area:"Рига",areaCode:11474,group:"a",flag:"lv"},{team:"Йокерит",skin:30,area:"Хельсинки",areaCode:10493,group:"a",flag:"fi"},{team:"Локомотив",skin:13,area:"Ярославль",areaCode:16,group:"a",flag:"ru"},{team:"Медвешчак",skin:14,area:"Загреб",areaCode:10507,group:"a",flag:"hr"},{team:"Лада",skin:31,area:"Тольятти",areaCode:240,group:"b",flag:"ru"},{team:"Металлург",skin:15,area:"Новокузнецк",areaCode:237,group:"b",flag:"ru"},{team:"Металлург",skin:16,area:"Магнитогорск",areaCode:235,group:"b",flag:"ru"},{team:"Нефтехимик",skin:17,area:"Нижнекамск",areaCode:11127,group:"b",flag:"ru"},{team:"Салават Юлаев",skin:18,area:"Уфа",areaCode:172,group:"b",flag:"ru"},{team:"Северсталь",skin:19,area:"Череповец",areaCode:968,group:"a",flag:"ru"},{team:"Сибирь",skin:20,area:"Новосибирская область",areaCode:11316,group:"b",flag:"ru"},{team:"СКА",skin:21,area:"Санкт-Петербург",areaCode:2,group:"a",flag:"ru"},{team:"Слован",skin:22,area:"Братислава",areaCode:10489,group:"a",flag:"sk"},{team:"Торпедо",skin:24,area:"Нижний Новгород",areaCode:47,group:"a",flag:"ru"},{team:"Трактор",skin:27,area:"Челябинск",areaCode:56,group:"b",flag:"ru"},{team:"ХК Сочи",skin:32,area:"Сочи",areaCode:239,group:"a",flag:"ru"},{team:"ЦСКА",skin:25,area:"Москва",areaCode:213,group:"a",flag:"ru"},{team:"Югра",skin:26,area:"Ханты-Мансийск",areaCode:57,group:"b",flag:"ru"}]},{id:"traktor",name:"Трактор",theme:"nice",favicon:null,hidden:!1,priority:500,region:11225,modifiers:"6","disabled-in":"TUR INT",timestamp:13922352e5,share:{link:"promo-themes/traktor/",title:"Яндекс.Почта для болельщиков «Трактора»",description:"Фотографии любимой команды и последние новости чемпионата КХЛ — в новой теме оформления.",twitter:"Фотографии любимой команды и последние новости чемпионата КХЛ — в новой теме оформления.",image:"b-color-scheme__theme.large.jpg"}},{id:"owls",name:"Совы",theme:"nice",favicon:null,priority:5,modifiers:"9",share:{link:"promo-themes/owls/",title:"Совы в Яндекс.Почте",description:"Совы — не то, чем кажутся. В вашем почтовом ящике.",twitter:"Совы в вашей Яндекс.Почте",image:"b-color-scheme__theme.large.jpg"}},{id:"seasons",name:"Настроение",theme:"nice",type:["winter","newyear","spring","summer","autumn"],favicon:null,priority:4,popularityPriority:1,modifiers:"1",texts:{title:{winter:"Настоящая снежная зима в Яндекс.Почте",newyear:"Яндекс.Почта дарит новогоднее настроение",spring:"Весеннее настроение в Яндекс.Почте",summer:"Летнее настроение в моей Яндекс.Почте",autumn:"Осенняя Яндекс.Почта"},description:{winter:"И ещё более тридцати вариантов оформления на любой вкус.",newyear:"И ещё более тридцати вариантов оформления на любой вкус.",spring:"И ещё более тридцати вариантов оформления на любой вкус.",summer:"И ещё более тридцати вариантов оформления на любой вкус.",autumn:"Украсьте свой почтовый ящик по сезону."},twitter:{winter:"Мою Яндекс.Почту засыпало снегом",newyear:"Яндекс.Почта дарит новогоднее настроение",spring:"В моей Яндекс.Почте наступила весна",summer:"Лето пришло в мою Яндекс.Почту",autumn:"Осень пришла в мою Яндекс.Почту"}}},{id:"zverushki",name:"Фантазия",theme:"nice",favicon:null,priority:20,popularityPriority:5,modifiers:17},{id:"bears",name:"Me to You",theme:"nice",modifiers:"1",favicon:"gray-favicon",priority:30,popularityPriority:3},{id:"weather",name:"Погодная",theme:"blue-based",favicon:null,modifiers:"18",priority:50,popularityPriority:2},{id:"plasticine",name:"Пластилиновая",theme:"blue-based",favicon:null,modifiers:"8",priority:60},{id:"relax",name:"Природа",theme:"default",modifiers:"44",favicon:"gray-favicon",priority:70},{id:"newspaper",name:"Газетная",theme:"default",modifiers:"252",favicon:"newspaper-favicon","disabled-in":"TUR INT",priority:80},{id:"cosmos",name:"Космос",theme:"default",favicon:"black-favicon",modifiers:"24","disabled-in":"TUR",priority:90},{id:"sea",name:"Морская",theme:"default",favicon:"turquoise-favicon",priority:100},{id:"colorful",name:"Цветная",theme:"nice",group:"simple",skins:e,favicon:null,priority:110,modifiers:1},{id:"mac",name:"Легкая",theme:"default",favicon:"gray-favicon",group:"simple",localize:!0,priority:120,hidden:!0},{id:"white",name:"Белая",theme:"nice",favicon:"white-favicon",group:"simple",localize:!0,priority:130,hidden:!0},{id:"big",name:"Заметная",group:"simple",theme:"nice",favicon:null,localize:!0,priority:135},{id:"grass",name:"Трава",theme:"default",favicon:"green-favicon",priority:140},{id:"orangetree",name:"Апельсин",theme:"default",favicon:"orange-favicon",priority:150},{id:"lamp",name:"Ночная",theme:"default",favicon:"black-favicon",priority:160,popularityPriority:4},{id:"stitch",name:"Вышивка",theme:"default",modifiers:"2",favicon:"gray-favicon",priority:170},{id:"pinkbear",name:"Медвежонок",theme:"default",favicon:"pink-favicon",priority:180},{id:"cat",name:"Комната",theme:"default",favicon:"violet-favicon",priority:190},{id:"soccer",name:"Футбольная",theme:"default",favicon:"green-favicon",modifiers:"12",priority:200},{id:"capitals",name:"Столицы",theme:"blue-based",favicon:null,modifiers:"39",priority:210},{id:"dandelions",name:"Одуванчики",theme:"blue-based",favicon:null,priority:220},{id:"red-list",name:"Красная книга",theme:"blue-based",modifiers:"20","disabled-in":"TUR",favicon:null,priority:230},{id:"art",name:"Художники",theme:"default",favicon:null,modifiers:"25",priority:240},{id:"anime",name:"Аниме",theme:"blue-based",favicon:null,priority:250},{id:"ice-cream",name:"Мороженое",theme:"blue-based",favicon:null,priority:260},{id:"pushkin",name:"Пушкин",theme:"blue-based",modifiers:"7","disabled-in":"TUR",favicon:null,priority:270},{id:"kitekat",name:"Кот",theme:"nice",favicon:null,priority:275,modifiers:4,"disabled-in":"TUR INT",hidden:!0,"hidden-in-setup":!0},{id:"kindergarten",name:"Детская",theme:"blue-based",modifiers:"4",favicon:null,priority:280},{id:"origami",name:"Оригами",theme:"default",favicon:"red-favicon",priority:290},{id:"newyear2010",name:"Снеговики",theme:"blue-based",modifiers:"3",favicon:null,priority:300},{id:"olympics",name:"Зимние игры",theme:"nice","disabled-in":"INT TUR","hidden-in-setup":!0,hidden:!0,favicon:null,priority:10100,modifiers:"1"}]};
return i}();this.setData(e),this.init()}},methods:a},ns.ModelStatic)}(),ns.Model.define("settings-sign",{methods:{SETTINGS_SIGN:{contextmenu_disable:"_invert",dont_save_history:"_invert",disable_etickets:"_invert",disable_promo:"_invert",disable_inboxattachs:"_invert",disable_events:"_invert",disable_yabbles:"_invert",no_definition_types:"_invert",notify_message:"_signNotifyMessage",no_signature_select:"_invert",timeline_enable:"_signTimelineEnable",right_column_expanded:"_defaultTrue",show_priority_label:"_defaultTrue",show_priority_popup:"_defaultTrue"},getSign:function(e,t){var i=this.getSetting(e,t),n=this.SETTINGS_SIGN[e];
return n&&(i=_.method(n,i,e)(this)),i},signToSetting:function(e,t){var i=this.SETTINGS_SIGN[e];return"_invert"===i&&(t=_.method(i,t,e)(this)),t},_invert:function(e){return!e},_defaultTrue:function(e,t){return e=this.hasSetting(t)?this.getSetting(t):!0,Boolean(e)},_defaultFalse:function(e,t){return e=this.hasSetting(t)?this.getSetting(t):!1,Boolean(e)},_signNotifyMessage:function(e,t){return this.hasSetting(t)||(e=!Daria.IS_CORP),Boolean(e)},_signTimelineEnable:function(){return ns.Model.get("timeline-state").checkEnable()
}}}),function(){var e=function(e,t){_.isString(e)&&(e=e.split("."));var i=_.size(e)-1;return e.reduce(function(e,n,s){var a=s===i?t:{},o=_.last(e)[n]=a;return e.push(o),e},[{}])[0]},t=30,i=[{name:"enable_hotkeys",trueValue:!0},{name:"dnd_enabled",trueValue:!0}],n={};n.POPULAR_CONTACTS_SETTING_NAME="compose_samples",n.getSetting=function(e,t){if(Jane.Config.NO_SETTINGS){var n=_.find(i,"name",e);if(n)return n.trueValue}var s=this.get("."+e);if("json"===t)try{return JSON.parse(decodeURIComponent(s))
}catch(a){return{}}if("signs"===e&&Array.isArray(s)&&s.length>0){var o=ns.Model.get("account-information").getAllUserEmails();s=s.map(function(e){return e.emails=e.emails.filter(function(e){return-1!==o.indexOf(e)}),e})}return s},n.hasSetting=function(e){var t=this.getData()||{};return t.hasOwnProperty(e)},n.isSet=function(e){return Jane.Config.NO_SETTINGS&&_.find(i,"name",e)?!0:Boolean(this.get("."+e))},n.setSettingOn=function(e,t){if(t=t||Jane.Common.nop,this.isSet(e))t(!0);else{var i={};i[e]=!0,this.setSettings(i,function(e,i){t(e,i)
})}},n.setSettingOff=function(e,t){if(t=t||Jane.Common.nop,this.isSet(e)){var i={};i[e]=!1,this.setSettings(i,function(e,i){t(e,i)})}else t(!0)},n.toggleSetting=function(e,t){this.isSet(e)?this.setSettingOff(e,t):this.setSettingOn(e,t)},n.setSettings=function(e,t){if(Jane.Config.NO_SETTINGS||$.isEmptyObject(e))return vow.reject();t=t||Jane.Common.nop;var i=this._makeSaveRequest(e);if(null===i)return t(!0,[]),vow.resolve();if(i.error)return t(!1,i.error),vow.reject();for(var n in e)this.setIfChanged("."+n,e[n]);
return ns.forcedRequest([{id:"do-settings",params:i},{id:"settings",params:{actual:!0,list:i.list}}]).then(function(e){var i=ns.Model.get("settings"),n=e[1].getData();for(var s in n)n.hasOwnProperty(s)&&i.setIfChanged("."+s,n[s]);ns.Model.destroy(e[1]),t(!0,[])},function(){t(!1,[])})},n.getMultiSetting=function(e){return this.getSetting(e,"json")||{}},n.saveMultiSetting=function(e,t){if("object"!=typeof t||null===t)throw new TypeError("Parameter value must be not empty object");var i=$.Deferred(),n={};
n[e]=t;var s=this;return this.setSettings(n,function(){i.resolve(s.getData())}),i.promise()},n.updateSetting=function(t,i,n){if(arguments.length<2)throw new Error(Daria.supplant("updateSettings takes exactly 2 arguments - {argc} given",{argc:arguments.length}));if(!t)throw new Error("Argument `name` must be specified");var s=t.split(".");t=s[0],s.length>1&&(i=e(s.slice(1),i));var a,o=this.getSetting(t,"json");return a=$.isPlainObject(i)?_.merge({},o,i):i,this.setSettings(_.zipObject([t],[a]),n)},n.setOpenedFolders=function(e){var t=e.join(",");
this.setSettings({folders_open:t})},n.setLastActive=function(e){this.setSettings({last_active:Daria.now()},e)},n.recordAttemptToRegisterMAILTOProtocolHandler=function(e,t){if(t=!!t,!e)return!1;var i=this.getSetting("rph")||"mozilla=0&opera=0&webkit=0",n=e+"="+Number(t);return _(i).contains(n)?!1:(i=i.replace(e+"="+Number(!t),n),this.setSettings({rph:i}),!0)},n.isThreaded=function(){return this.isSet("folder_thread_view")},n.threadedOn=function(){this.isThreaded()||this.setSettingOn("folder_thread_view")
},n.threadedOff=function(){this.isThreaded()&&this.setSettingOff("folder_thread_view")},n.threadedToggle=function(){this.isThreaded()?this.threadedOff():this.threadedOn()},n.getValidatedEmails=function(){return this.get(".reply_to")||[]},n._checkSName=function(e){if(!e)throw new Error("Parameter namespace is compulsory");if(e=String(e),e.length>t)throw new RangeError('Namespace "'+e+'" can not be over than '+t+" chars");return{name:e}},n._checkSValue=function(e,t){var i=$.type(t),n=!1;switch(i){case"boolean":case"object":case"array":case"string":case"null":case"undefined":case"number":break;
default:throw new TypeError('Invalid type setting "'+e+'" value: '+i)}switch(e){case"signs":if("array"!==i)throw new TypeError('Invalid type setting "'+e+'" value: '+i);t=$.map(t,function(t){if("object"!==$.type(t))throw new TypeError('Invalid type setting "'+e+'"');if("string"===$.type(t.text)){t.text.length>1e4&&(n="signs.maxlen");var i={text:t.text,isDefault:!!t.isDefault,emails:$.isArray(t.emails)?t.emails:[]};return t.userLang&&(i.lang=t.userLang),i}}),this.getSetting("signs").length<=t.length&&t.length>20&&(n="signs.maxcount")
}return{value:t,error:n}},n._makeSaveRequest=function(e){var t={},i=[],n=[];for(var s in e){var a=this._checkSName(s),o=this._checkSValue(s,e[s]);o.error===!1?(t[a.name]=o.value,i.push(a.name)):n.push(o.error)}return n.length?{error:n}:{actual:!0,list:i.join(","),params:JSON.stringify(t)}},ns.Model.define("settings",{params:{list:null,actual:null},methods:no.extend(n,{COMPACT_MODE_SETTING:"liza_minified",COMPACT_HEADER_MODE_SETTING:"liza_minified_header",preprocessData:function(e){["from_name"].forEach(function(t){e.hasOwnProperty(t)&&(e[t]=_.unescape(e[t]))
}),e.show_news||ns.Model.get("informer-news").turnOffCacheInvalidating(),Modernizr.ios&&(e.enable_richedit=!1),ns.events.trigger("settings-updated");var t=e.messages_per_page;return(!t&&!this.params.list||Daria.is3pane())&&(e.messages_per_page=30),e},getPromoThemeSettingName:function(e){var t="_shown";return e&&(t="_set"),"promo_theme"+t},isCompactMode:function(){return this.isSet(this.COMPACT_MODE_SETTING)},isCompactHeaderMode:function(){return this.isSet(this.COMPACT_HEADER_MODE_SETTING)},switchCompactModeSettings:function(e){if(e){var t={};
switch(e){case"compact-mode":t[this.COMPACT_MODE_SETTING]=!this.isCompactMode();break;case"compact-header-mode":t[this.COMPACT_HEADER_MODE_SETTING]=!this.isCompactHeaderMode()}(this.COMPACT_HEADER_MODE_SETTING in t&&!t[this.COMPACT_HEADER_MODE_SETTING]||this.COMPACT_MODE_SETTING in t&&!t[this.COMPACT_MODE_SETTING])&&(t["size-view-app2"]="0"),this.setSettings(t)}},withBiggerText:function(){return this.isSet("with_bigger_text")}})},"settings-sign")}(),ns.Model.define("social-avatars",{params:{refs:null},methods:{extractData:function(e){var t=$.makeArray(this.params.refs),i={},n=[];
return Array.isArray(e.data.avatar)&&e.data.avatar.length&&e.data.avatar.forEach(function(e){var t=e.ref+":"+e.email;n.push(t),i=e,ns.Model.get("social-avatars",{refs:t}).setData(e,{silent:!0})}),_.difference(t,n).forEach(function(e){var t=e.split(":");i={ref:t.shift(),email:t.join(":"),url:"noavatar"},ns.Model.get("social-avatars",{refs:e}).setData(i,{silent:!0})}),t.length>1?{}:i}}}),ns.Model.define("social-profiles-reset",{params:{emails:null}}),function(){ns.Model.define("social-profiles",{methods:{getCacheByEmail:function(e){var t=null;
return _.forEach(this.getData()||{},function(i,n){n.split(":").pop()===e&&(t=i.data)}),t}},params:{refs:null}},ns.ModelArmour)}(),ns.Model.define("do-translate",{params:{text:null,lang:null,format:null},methods:{_canRequest:function(){return!this.retries||this.retries<this.RETRY_LIMIT}}}),ns.Model.define("translate-langs",{methods:{getName:function(e){return _.get(this.data,"langs."+e,"")},getLangs:function(){return _(this.get(".langs")).chain().map(this._getLangsMapIterate).sortBy("name").value()
},getRecent:function(){return _(ns.Model.get("settings").getSetting("translateRecent")||"").chain().split(",").uniq().map(this._getRecentMapIterate.bind(this)).compact().slice(0,5).value()},hasRecent:function(){return!_.isEmpty(this.getRecent())},setRecent:function(e){var t=_(this.getRecent()).chain().map(this._setRecentMapIterate).unshift(e).uniq().slice(0,5).join(",").value();ns.Model.get("settings").setSettings({translateRecent:t})},_getLangsMapIterate:function(e,t){return{name:e,lang:t}},_setRecentMapIterate:function(e){return e.lang
},_getRecentMapIterate:function(e){var t=e&&this.getName(e);if(t)return{name:t,lang:e}}}}),ns.Model.define("themes-selector",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({opened:!1})},isOpened:function(){return this.get(".opened")},open:function(){this.set(".opened",!0)},close:function(){this.set(".opened",!1)}}},ns.ModelStatic),function(){var e={};e.getActivePhone=function(){var e=this.getData()||{};return jpath(e,'.phone[.active == "1" && .valid == "valid"]')[0]},e.getUnconfirmedPhone=function(){if(!this.getActivePhone()){var e=this.getData()||{},t=jpath(e,'.phone[.valid != "valid"]');
if(t.length)return t.sort(function(e,t){return e.validation_date<t.validation_date?1:e.validation_date>t.validation_date?-1:0}),t[0]}},e.getActiveNumber=function(){var e=this.getActivePhone();return e&&e.number},e.getUnconfirmedNumber=function(){var e=this.getUnconfirmedPhone();return e&&e.number},e.getUnconfirmedIdByNumber=function(e){if(!this.getActivePhone()){var t=this.getData()||{};return jpath(t,'.phone[.valid != "valid" && .number == "'+e+'"].id')[0]}},e.hasActiveNumber=function(){var e=this.getData(),t=Boolean(jpath(e,'.phone[.active == "1" && .valid == "valid"]').length);
return t},e.isValidated=function(t){var i=this.getData();return t=e.normalize(t),Boolean(jpath(i,'.phone[.number == "'+t+'" && .valid == "valid"]').length)},e.normalize=function(e){return e=(e||"").replace(/^8/,"+7")},e.getPhone=function(e){if(!e)throw new ReferenceError("Required parameter phoneNumber is missing");return ns.forcedRequest("userphones").then(function(t){var i=t[0],n=$.makeArray(i.get(".phone")).filter(function(t){return t.number===e});return n.length?n[0]:null})},e.getAll=function(e){return ns.request.models([this],{forced:!e})
},e._parse=function(e){var t=36e5,i=4*t,n=/^(\d{4})-(\d{2})-(\d{2})/;return e.phone||(e=[]),$.makeArray(no.jpath(".phone",e)).forEach(function(e){var t=new Date(e.validation_date.replace(n,"$2/$3/$1")).getTime();e.validation_date=t-i,e.active=Boolean(parseInt(e.active,10)),e.autoblocked=Boolean(parseInt(e.autoblocked,10)),e.cyrillic=Boolean(parseInt(e.cyrillic,10)),e.secure&&(e.secure=Boolean(parseInt(e.secure,10)))}),e},ns.Model.define("userphones",{methods:e})}(),ns.Model.define("weather",{params:{geoid:null,date:null}}),ns.Model.define("help-link",{events:{"ns-model-init":"_onInit"},methods:{_hrefSuffixMap:{inbox:"zout_context/context-inbox.xml",folder:"zout_context/context-folder.xml",archive:"zout_context/context-archive.xml",sent:"zout_context/context-sent.xml",trash:"zout_context/context-trash.xml",spam:"zout_context/context-spam.xml",draft:"zout_context/context-draft.xml",template:"zout_context/context-template.xml",outbox:"zout_context/context-outbox.xml",search:"zout_context/context-search.xml",compose2:"zout_context/context-compose.xml",message:"zout_context/context-message.xml",abook:"zout_context/context-contacts.xml",unread:"zout_context/context-unread.xml",attachments:"zout_context/context-attachments.xml",important:"zout_context/context-important.xml",label:"zout_context/context-label.xml",setup:"zout_context/context-setup.xml","setup/sender":"zout_context/context-setup-sender.xml","setup/collectors":"zout_context/context-setup-collectors.xml","setup/security":"zout_context/context-setup-security.xml","setup/folders":"zout_context/context-setup-folders.xml","setup/abook":"zout_context/context-setup-abook.xml","setup/client":"zout_context/context-setup-client.xml","setup/journal":"zout_context/context-setup-journal.xml","setup/todo":"zout_context/context-setup-todo.xml","setup/other":"zout_context/context-setup-other.xml","setup/filters":"zout_context/context-setup-filters.xml","setup/filters-create":"zout_context/context-setup-filters-create.xml","setup/filters-create-simple":"zout_context/context-setup-filters-create-simple.xml","setup/filters-create-simple/label":"zout_context/context-setup-filters-create-simple-label.xml","setup/filters-create-simple/delete":"zout_context/context-setup-filters-create-simple-delete.xml"},_onInit:function(){return Daria.hasExperiment(28384)?(this._hrefSuffixMap.inbox+="?origin=28384",this._hrefSuffixMap["setup/collectors"]+="?origin=28384"):Daria.hasExperiment(28383)&&(this._hrefSuffixMap.inbox="zout_context/context-inbox_2.xml?origin=28383",this._hrefSuffixMap["setup/collectors"]="zout_context/context-setup-collectors_2.xml?origin=28383"),"INT"===Daria.Config.product||"TUR"===Daria.Config.product||"yandex.ua"===Daria.Config["yandex-domain"]?void this.setData({href:Daria.Config["help-url"]}):(this.setData({href:this._getHref(ns.page.current)}),void ns.events.on("ns-page-before-load",this._onPageBeforeLoad.bind(this)))
},_onPageBeforeLoad:function(e,t){_.isEqual(t[0],t[1])||this.updateHref(t[1])},updateHref:function(e){this.set(".href",this._getHref(e))},_getHref:function(e){return Daria.Config["help-url"]+this._getHrefSuffix(e.page,e.params)||""},_getHrefSuffix:function(e,t){if(t.ids||t.thread_id)return this._hrefSuffixMap.message;if("messages"===e){if(t.search)return this._hrefSuffixMap.search;if(t.important)return this._hrefSuffixMap.important;if("only_new"===t.extra_cond)return this._hrefSuffixMap.unread;if("only_atta"===t.extra_cond)return this._hrefSuffixMap.attachments
}if(t.current_folder){var i=ns.Model.get("folders"),n=i.getFolderById(t.current_folder);if(n.symbol)return this._hrefSuffixMap[n.symbol];if(n.user)return this._hrefSuffixMap.folder}return t.current_label?this._hrefSuffixMap.label:"setup"===e||"setup-sender"===e?t.tab&&t.action?this._hrefSuffixMap["setup/"+t.tab+"/"+t.action]:t.tab?this._hrefSuffixMap["setup/"+t.tab]:this._hrefSuffixMap.setup:this._hrefSuffixMap[e]?this._hrefSuffixMap[e]:""}}},ns.ModelStatic),ns.Model.define("skin-saver-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({previewMode:!1})
},isPreviewMode:function(){return this.get(".previewMode")},togglePreviewMode:function(e){return this.set(".previewMode",e)}}},ns.ModelStatic),ns.Model.define("current-day",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({}),_.delay(function(){this.set(".date",Daria.passportNow(),{silent:!0}),this.setNextDayTimeout()}.bind(this),Jane.Date.SECOND)},setNextDayTimeout:function(){var e=new Date(Daria.passportNow()),t=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1),i=t-e;
setTimeout(this.updateDate.bind(this),i+1)},updateDate:function(){this.setIfChanged(".date",Daria.passportNow()),this.setNextDayTimeout()}}},ns.ModelStatic),ns.Model.define("filter-search",{params:{mids:null},methods:{preprocessData:function(e){if(Array.isArray(e.envelopes))for(var t=ns.Model.get("labels").get(".label"),i=e.envelopes.length;i--;){var n=e.envelopes[i];if(!n.processed){for(var s=0;s<n.labels.length;s++){var a=_.find(t,{lid:n.labels[s]});if(a&&a.social){n.dlid=a.name.replace(/^vtnrf0/,"");
break}}n.processed=!0;var o=ns.Model.get("filter-search",{mids:n.mid});o.select(".envelopes.processed")[0]||o.setData({envelopes:[n]})}}return e},hasSocialLabels:function(){return Boolean(this.getSocialLID())},getSocialLID:function(){var e=_.flatten($.makeArray(this.select(".envelopes.labels"))),t=e.length;if(t)for(var i=ns.Model.get("labels"),n=0;t>n;n++)if(i.isSocial(e[n]))return e[n];return null}}}),function(){ns.Model.define("messages-pager",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){if("all"==this.params.current_folder){var e;
if(Daria.IS_CORP)e={year:"2000",month:"1",day:"1"};else{var t=ns.Model.get("account-information").getDataKey("reg_date");t=new Date(t),e={year:String(t.getFullYear()),month:String(t.getMonth()+1),day:"1"}}this.setData(e)}},preprocessData:function(e){var t=Jane.Common.n,i=e.year,n=e.month,s=e.day,a=new Date,o=new Date(i,n-1,s);if(!i||o>=a)return{};for(var r=a.getFullYear(),l=o.getFullYear(),c=a.getMonth()+1,d=o.getMonth()+1,u=[],h=l,m=d,g={id:h,datePager:h,year:h,from:"01.01."+h,to:"01.01."+(h+1),month:[],isYear:!0},p=0,f=h>=Daria.Config.messagesMaxDate;r>h||h==r&&c>=m;)if(f&&g.month.push({datePager:t(m)+"."+h,month:m-1,year:h,from:"01."+t(m)+"."+h,to:"01."+t(12>m?m+1:1)+"."+(12>m?h:h+1),id:t(m)+String(h)}),m++,13==m&&(m=1,f?u.push(g):0===u.length&&u.push({id:h,datePager:h,year:h,old:1}),h++,f=h>=Daria.Config.messagesMaxDate,f&&(g={id:h,datePager:h,year:h,from:"01.01."+h,to:"01.01."+(h+1),month:[],isYear:!0})),p++,p>1e3)return Jane.ErrorLog.send({errorType:"messages-pager.infinity",dataYear:i,dataMonth:n,dataDay:s,nowDate:a.toString()}),{};
return g.month.length&&u.push(g),{year:u}},getCountMonth:function(){return this.select(".year.month.datePager").length}},params:{current_folder:null}})}(),function(){var e=[{type:"#inbox",isInbox:!0,name:"Входящие",label:"Входящие",icon:"MailTypes-Inbox"},{type:"4",name:"Люди",label:"Люди",icon:"MailTypes-People"},{type:"5",name:"Билеты",label:"Билеты",icon:"MailTypes-Ticket"},{type:"35",name:"Гостиницы",label:"Гостиницы",icon:"MailTypes-Hotels"},{type:"14",name:"Скидки",label:"Скидки",icon:"MailTypes-Sale"},{type:"18",name:"Социальные сети",label:"Социальные сети",shortLabel:"Соцсети",icon:"MailTypes-Social"}];
ns.Model.define("messages-types",{methods:{preprocessData:function(t){var i,n=[];for(i in t)0!==t[i].freq&&n.push(i);var s={notEmptyTypes:n,typesInFilter:e};return $.extend(s,this.filterByArrayOfTypes(n,e)),s},getTypeById:function(t){return _(e).findWhere({type:String(t)})},filterByArrayOfTypes:function(e,t){var i={};return i.typesAfterFilter=[],i.typesAfterFilterDiscarded=[],t.forEach(function(t){t.canNotBeDeleted||"#inbox"===t.type||e.indexOf(t.type)>-1?i.typesAfterFilter.push(t):i.typesAfterFilterDiscarded.push(t)
}),i}}})}(),function(){ns.Model.define("compose-sidebar-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({popupRect:null})}}},ns.ModelStatic)}(),ns.Model.define("compose-sidebar-fsm",{methods:{start:"cancel",transitions:{cancel:["edit"],edit:["done","cancel"],done:["edit","cancel"]}}},ns.ModelFsm),function(){ns.Model.define("message-read-mute-fsm",{params:{ids:null,type:null},methods:{start:"",transitions:{toRead:["toMute","toUnread"],toMute:["toUnmute","toUnread","toRead"],toUnmute:["toUnread","toRead"],toUnread:["toRead","toUnmute"]}}},ns.ModelFsm)
}(),ns.Model.define("state-message-thread-item",{params:{ids:null},events:{"ns-model-init":"_onNsModelInit"},methods:{_onNsModelInit:function(){this.setData({isOpened:!1,isFocused:!1,isIgnoreMarkRead:!1,promiseWillBeLoaded:!1,isVisible:!1,shouldBeInViewport:!1,forceMark:!1})},_setChangedData:function(e,t,i){e="."+e;var n=this.get(e);if(n!==t){var s=i?{silent:!0}:{};return this.set(e,t,s),!0}return!1},isOpen:function(){return this.get(".isOpened")},setOpen:function(e,t){return this._setChangedData("isOpened",e,t)
},setVisible:function(e,t){return this._setChangedData("isVisible",e,t)},setFocus:function(e,t){return this._setChangedData("isFocused",e,t)},setIgnore:function(e,t){return this._setChangedData("isIgnoreMarkRead",e,t)}}},ns.ModelStatic),ns.Model.define("get-maillists",{params:{emails:null}}),ns.Model.define("get-maillists-static",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({emails:null},{silent:!0})},getMaillists:function(e){var t=this,i=this.get(".emails")||{},n=_.difference(e,Object.keys(i)),s=vow.fulfill();
if(n.length>0){var a=ns.Model.get("get-maillists",{emails:n.join(",")});s=ns.request.models([a]).then(function(n){var s=n[0].get(".maillists");s.forEach(function(e){i[e]||(i[e]=!0)});var a=_.difference(e,s);a.forEach(function(e){i[e]||(i[e]=!1)}),t.set(".emails",i),vow.fulfill()})}return s.then(function(){var t=[];return e.forEach(function(e){i[e]===!0&&t.push(e)}),vow.fulfill(t)})}}},ns.ModelStatic),ns.Model.define("reset-unvisited",{params:{fid:null},methods:{resetUnvisited:function(){return ns.Model.get("folder",{fid:this.params.fid}).get(".recent")?ns.forcedRequest([this]).then(function(e){return vow.fulfill(e[0].get(".is_reset"))
}):vow.fulfill(!0)}}}),ns.Model.define("ws-dropdown-data",{params:{},events:{"ns-model-init":function(){this.setData({}),Daria.Config.workspace&&this._addWSDropdownServices()}},methods:{_addWSDropdownServices:function(){var e,t=[],i=Daria.Config["yandex-domain"].split(".").pop();e=_.contains(["ru","kz","by","ua"],i)?"ru":"com",t.push({href:"https://connect.yandex."+e+"/home",content:"Главная",icon:"mail--ConnectService_main"},{href:"https://yamb.yandex."+e,content:"Ямб",icon:"mail--ConnectService_yamb"},{href:Daria.Config["mail-url"],content:"Почта",icon:"mail--ConnectService_mail"},{href:"https://disk."+Daria.Config["yandex-domain"],content:"Диск",icon:"mail--ConnectService_yadisk"},{href:"https://connect.yandex."+e+"/staff",content:"Люди",icon:"mail--ConnectService_people"},{href:"https://wiki.yandex."+e,content:"Вики",icon:"mail--ConnectService_wiki"},{href:Daria.Config["mail-url"]+ns.router.generateUrl("abook"),content:"Контакты",icon:"mail--ConnectService_contacts"},{href:"https://calendar.yandex."+e,content:"Календарь",icon:"mail--ConnectService_calendar"}),Daria.Config.isWsAdmin&&t.push({href:"https://connect.yandex."+e+"/portal",content:"Админка",icon:"mail--ConnectService_admin"}),this.set(".services",t)
}}},ns.ModelStatic),ns.Model.define("notifications",{isCollection:!0,events:{"ns-model-init":"_onInit"},methods:{_uniqueId:0,DELAY_BEFORE_DELETE:600,MAX_NOTIFICATION_COUNT:10,_onInit:function(){this.setData({queue:[]})},hasNotifications:function(){return 0!==this.models.length},hasNotificationsInQueue:function(){return 0!==this.get(".queue").length},addNotification:function(e){if(ns.Model.get("notifications-state").isExpanded()){var t=this.get(".queue");t=t.concat(e),this.set(".queue",t)}else{var i=this.models[0];
if(i&&i.isVIP()&&!e.vip)return;this._addNotification(e),this._tryRemoveLastNotification()}},_addNotification:function(e){var t=ns.Model.get("notifications-item",{id:this._uniqueId++}).setData(e);this.insert(t,0)},_tryRemoveLastNotification:function(){if(this.models.length>this.MAX_NOTIFICATION_COUNT){var e=this;_.delay(function(){e.remove(e.models.length-1)},this.DELAY_BEFORE_DELETE)}},insertFromQueue:function(){var e=this.get(".queue");e.length&&(this._moveVIPtoEndOfQueue(),this._insertFromQueue())
},_moveVIPtoEndOfQueue:function(){var e=this.get(".queue");e=e.sort(function(e,t){return e.vip&&!t.vip?1:0}),this.set(".queue",e)},_insertFromQueue:function(){var e=this.get(".queue"),t=this;e.forEach(function(e){t._addNotification(e),t._tryRemoveLastNotification()}),this.set(".queue",[])}}},ns.ModelCollectionStatic),ns.Model.define("notifications-item",{params:{id:null},methods:{isVIP:function(){return Boolean(this.get(".vip"))},isCalendarEvent:function(){return Boolean("calendar"===this.get(".type"))
}}},ns.ModelStatic),ns.Model.define("notifications-state",{events:{"ns-model-init":"_onInit"},methods:{_onInit:function(){this.setData({expanded:!1})},expand:function(){this.set(".expanded",!0)},collapse:function(){this.set(".expanded",!1)},isExpanded:function(){return this.get(".expanded")}}},ns.ModelStatic),ns.Model.define("timeline-state",{events:{"ns-model-init":"_onInit","ns-model-changed.startDate":"_onChangedStartDate","ns-model-changed.startOffset":"_onChangedStartOffsetDebounce","ns-model-changed.currentDate":"_onChangedCurrentDate"},ctor:function(){this._onXivaCalendarChangedDebounce=_.debounce(this._onXivaCalendarChanged.bind(this),2*Jane.Date.MINUTE,{maxWait:5*Jane.Date.MINUTE,leading:!0,trailing:!0}),this.currentDateTick=this.currentDateTick.bind(this),this._onChangedStartOffsetDebounce=_.debounce(this._onChangedStartOffset.bind(this),500),this._lockStartDateSet=!1,this._lockStartDateAutoSet=!1
},methods:{TIMELINE_COLLAPSED_HEIGHT:31,TIMELINE_START_HOUR_OFFSET:2,TIMELINE_HOUR_PIXEL_STEP:48,MAX_LAG_START_DATE:6*Jane.Date.HOUR,SLEEP_TIME:5*Jane.Date.MINUTE,CALENDAR_SID:31,SHOW_EMPTY:0,SHOW_COLLAPSED:1,SHOW_PROMO:2,SHOW_TIMELINE:3,_onInit:function(){var e=Math.floor(window.screen.width/this.TIMELINE_HOUR_PIXEL_STEP),t=this._getCurrentDate(),i=Jane.Date.clone(t);i=this._adjustHours(i,-this.TIMELINE_START_HOUR_OFFSET),this.setData({calendarSpeed:Number($.url(window.location.href).getParam("calendar_speed")||0),showState:this.SHOW_EMPTY,timerTick:0,height:0,currentDate:{get:_.constant(t)},startDate:i,startOffset:{get:_.constant(0)},showedHours:e,countOfDays:Math.ceil(e/24)}),ns.events.on("xiva.calendar.user-events-changed",this._onXivaCalendarChangedDebounce)
},_onChangedStartDate:function(){this._lockStartDateSet=!0},_onChangedStartOffset:function(){this._lockStartDateSet=!1},_onChangedCurrentDate:function(e,t,i,n,s){var a=s.get().getTime(),o=this.getCurrentDate().getTime(),r=!1,l={};if(Math.abs(o-a)>this.SLEEP_TIME?(this._lockStartDateAutoSet=!1,ns.Model.invalidate("get-user-events",no.True),r=!0):ns.Model.invalidate("get-user-events",this._invalidateUserEvents.bind(this,Daria.now(),l)),l.invalidate&&(r=!0),!this._lockStartDateAutoSet){var c=this.get(".startDate").getTime();
Math.abs(o-c)>this.MAX_LAG_START_DATE&&this.shiftCurrentStartDate()}if(r){var d=Daria.Transport.getInstance(!1);!d||d.onLine()?this.atrigger("daria:mTimelineState:update"):d.once("online",this.atrigger.bind(this,"daria:mTimelineState:update"))}},set:function(e){return".startDate"===e&&this._lockStartDateSet?void 0:this.super_.set.apply(this,arguments)},recalcShowedHours:function(e){var t=Math.floor(e/this.TIMELINE_HOUR_PIXEL_STEP);this.setIfChanged(".showedHours",t),this.setIfChanged(".countOfDays",Math.ceil(t/24))
},shiftForwardStartDate:function(){var e=Jane.Date.clone(this.get(".startDate"));e=this._adjustHours(e,this.get(".showedHours")),e=this._adjustHours(e,-this.TIMELINE_START_HOUR_OFFSET),this._lockStartDateAutoSet=!0,this.setIfChanged(".startDate",e)},shiftBackStartDate:function(){var e=Jane.Date.clone(this.get(".startDate"));e=this._adjustHours(e,-this.get(".showedHours")),e=this._adjustHours(e,this.TIMELINE_START_HOUR_OFFSET),this._lockStartDateAutoSet=!0,this.setIfChanged(".startDate",e)},shiftCurrentStartDate:function(){var e=Jane.Date.clone(this.getCurrentDate());
e=this._adjustHours(e,-this.TIMELINE_START_HOUR_OFFSET),this._lockStartDateAutoSet=!1,this.setIfChanged(".startDate",e)},getCurrentDate:function(){return this.get(".currentDate.get")()},setStartOffset:function(e){this.set(".startOffset",{get:e})},checkShow:function(){return this.checkUnavailable()?!1:this.checkEnable()},checkEnable:function(){var e=ns.Model.get("settings");if(this.checkAvailable())return!e.hasSetting("timeline_enable")||e.isSet("timeline_enable");var t=ns.Model.get("account-information");
return e.isSet("timeline_enable")&&t.hasSid(this.CALENDAR_SID)},checkShowPromo:function(){return!1},checkShowCollapsed:function(){return this.checkShow()||this.checkShowPromo()?!this.checkSettingTimelineIsOpen():!1},checkAvailable:function(){return Boolean(Daria.IS_CORP||Daria.Config.pddDomain||Daria.Config.workspace)},checkUnavailable:function(){var e=ns.page.current.page;return Boolean(Jane.Config.NO_SETTINGS||"not-found"===e||"no-message"===e||!Daria.Config["is-timeline"])},checkSettingTimelineIsOpen:function(){var e=ns.Model.get("settings");
return Daria.Config.pddDomain||Daria.Config.workspace?e.isSet("timeline-is-open"):!e.hasSetting("timeline-is-open")||e.isSet("timeline-is-open")},subscribeCalendar:function(){if(this.checkAvailable())return Vow.resolve();var e=ns.Model.get("settings");if(!e.isSet("timeline_enable"))return Vow.resolve();var t=ns.Model.get("account-information");return t.hasSid(this.CALENDAR_SID)?Vow.resolve():ns.forcedRequest("do-admsubscribe-calendar").then(this._checkSubscribeResponse,this).then(this._onSuccessSubscribeCalendar,this).fail(this._onErrorSubscribeCalendar,this)
},metrika:function(){var e=Array.prototype.slice.call(arguments);e.unshift("Календарный таймлайн"),Jane.c.apply(Jane,e)},currentDateTick:function(){this._updateCurrentDate(),this.set(".timerTick",setTimeout(this.currentDateTick,this._getTickTime()),{silent:!0})},currentDateTickStop:function(){clearTimeout(this.get(".timerTick"))},_updateCurrentDate:function(){var e=this._getCurrentDate();this._isCustomCalendarSpeed()&&e.setMinutes(e.getMinutes()+1),this.set(".currentDate",{get:_.constant(e)})},_getTickTime:function(){var e=Jane.Date.MINUTE-Daria.now()%Jane.Date.MINUTE+1;
return this._isCustomCalendarSpeed()&&(e=this.get(".calendarSpeed")),e},_checkSubscribeResponse:function(e){var t=e[0].getData();return"ok"===t.status?Vow.resolve():Vow.reject()},_onSuccessSubscribeCalendar:function(){var e=ns.Model.get("account-information"),t=e.get(".sids")||[];return t.push(String(this.CALENDAR_SID)),e.set(".sids",t),Vow.resolve()},_onErrorSubscribeCalendar:function(){return new vow.Promise(function(e,t){ns.Model.get("settings").setSettingOff("timeline_enable",t)})},_getCurrentDate:function(){var e;
if(this._isCustomCalendarSpeed())e=Jane.Date.clone(this.getCurrentDate());else{var t=ns.Model.get("account-information").getTimezoneInHours();e=Daria.now(!0),e=Jane.Date.dateWithCustomTimeZone(e.getTime(),t),e=Jane.Date.LocalDate.convertDate(e),e.setSeconds(0,0)}return e},_adjustHours:function(e,t){return t=Math.floor(t||0),e.setHours(e.getHours()+t),e},_roundAwayFromZero:function(e){return 0>e?Math.floor(e):Math.ceil(e)},_invalidateUserEvents:function(e,t,i){return i.isLastData()?(t.invalidate=!0,!0):i.isValid()&&i.info.maxage&&i.dateInit&&e-i.dateInit>i.info.maxage?(t.invalidate=!0,!0):!1
},_isCustomCalendarSpeed:function(){return this.get(".calendarSpeed")>0},_onXivaCalendarChanged:function(){ns.Model.invalidate("get-user-events",no.True),this.atrigger("daria:mTimelineState:update")}}},ns.ModelStatic),ns.Model.define("timeline-list",{events:{"ns-model-destroyed":"_onDestroyed"},params:{},split:{items:".items",params:{df:".df",dt:".dt"},model_id:"timeline-list-item"},ctor:function(){this._mapDaysToModelsIterator=this._mapDaysToModelsIterator.bind(this),this._filterRemovedIterator=this._filterRemovedIterator.bind(this),this._sortRangesByDateFrom=this._sortRangesByDateFrom.bind(this),this._mapModelsToDateIterator=this._mapModelsToDateIterator.bind(this),this._onChangedStartDateDebounce=_.debounce(this._onChangedStartDate.bind(this),50)
},methods:{PRELOADED_VISIBLE_RANGES:3,request:function(){return ns.request("timeline-state").then(this._initFromModels,this)},loadMore:function(){var e=_.last(this.models),t=_.method(".get",".dateTo")(e);if(t||(t=this.mTimelineState.get(".startDate")),!t)return Vow.reject();var i=_.range(1,this._getVisibleDaysCount()).map(this._mapDaysIterator.bind(this,t)).map(this._mapDaysToModelsIterator);return this.setData({items:this._listModification(i)}),Vow.resolve()},_initFromModels:function(e){this.mTimelineState=_.find(e,"id","timeline-state"),this.mTimelineState.on("ns-model-changed.startDate",this._onChangedStartDateDebounce),this.setData({items:this._getStartingDays()})
},_onDestroyed:function(){this._onChangedStartDateDebounce.cancel(),this.mTimelineState.off("ns-model-changed.startDate",this._onChangedStartDateDebounce),this.mTimelineState=null},_onChangedStartDate:function(){this._reinitialize()},_mapDaysIterator:function(e,t){var i=Jane.Date.clone(e);i.setDate(i.getDate()+t),i.setHours(0,0,0,0);var n=Jane.Date.clone(i);return n.setHours(23,59,0,0),{df:Jane.Date.format("%Date_iso",i),dt:Jane.Date.format("%Date_iso",n),dateFrom:i,dateTo:n}},_getStartingDays:function(){var e=this.mTimelineState.get(".startDate"),t=this._getVisibleDaysCount();
return _.range(t).map(this._mapDaysIterator.bind(this,e))},_reinitialize:function(){var e=this._getStartingDays().map(this._mapDaysToModelsIterator),t=this.models.filter(this._filterRemovedIterator);this.setData({items:this._listModification(e,t)})},_listModification:function(e,t){return _(this.models).chain().difference(t).concat(e).uniq().sortBy(this._sortRangesByDateFrom).map(this._mapModelsToDateIterator).value()},_filterRemovedIterator:function(e){var t=this.mTimelineState.get(".startDate"),i=e.getOffsetRange(t),n=Jane.Date.DAY*this._getVisibleDaysCount();
return i>n||-n>i},_getVisibleDaysCount:function(){return this.mTimelineState.get(".countOfDays")*this.PRELOADED_VISIBLE_RANGES},_mapDaysToModelsIterator:function(e){return ns.Model.get("timeline-list-item",e).setData(e)},_mapModelsToDateIterator:function(e){return e.getData()},_sortRangesByDateFrom:function(e){return e.get(".dateFrom").getTime()}}}),ns.Model.define("timeline-list-item",{events:{"ns-model-init":"_onInit"},params:{df:null,dt:null},methods:{_onInit:function(){this.setData({})},checkDateInRange:function(e){return e=e.getTime(),e>=this.get(".dateFrom").getTime()&&e<=this.get(".dateTo").getTime()
},checkDateGtRange:function(e){return e.getTime()>this.get(".dateTo").getTime()},checkDateLtRange:function(e){return e.getTime()<this.get(".dateFrom").getTime()},getOffsetRange:function(e){e=e.getTime();var t=this.get(".dateFrom").getTime(),i=this.get(".dateTo").getTime();return e>i?e-i:t>e?e-t:0}}},ns.ModelStatic),ns.Model.define("disk-secret-key",{methods:{isValid:function(){return this.get(".expirationDate")>=Date.now()}}}),ns.Model.define("promo-mobile-app-state",{events:{"ns-model-init":"resetState"},params:{promo:null},methods:{STATE:{DEFAULT:"default",ENTER_PHONE:"enter-phone",ENTER_PHONE_INVALID:"enter-phone-invalid",SENDING:"sending",SEND_SUCCESS:"send-success",SEND_FAILED:"send-failed"},resetState:function(){this.setData({state:this.STATE.DEFAULT,retriesLeft:3,shouldGoNextWithDelay:!0})
},resetErrorMessages:function(){var e=this.STATE;this.get(".state")===e.ENTER_PHONE_INVALID&&this.set(".state",e.DEFAULT),this.get(".state")===e.SEND_FAILED&&(this.canRetry()?this.set(".state",e.DEFAULT):this.resetState())},setDefaultState:function(){this.setIfChanged(".state",this.STATE.DEFAULT)},setEnterPhoneState:function(){this.setIfChanged(".state",this.STATE.ENTER_PHONE)},canTrySendAppLink:function(){var e=this.STATE,t=this.get(".state");return t===e.DEFAULT||t===e.ENTER_PHONE||t===e.SEND_FAILED
},canRetry:function(){return this.get(".retriesLeft")>0},setInvalidPhoneNumberState:function(){this.set(".state",this.STATE.ENTER_PHONE_INVALID)},startSending:function(){this.set(".retriesLeft",this.get(".retriesLeft")-1,{silent:!0}),this.set(".state",this.STATE.SENDING)},isEnterPhoneState:function(){var e=this.STATE,t=this.get(".state");return t===e.DEFAULT||t===e.ENTER_PHONE||t===e.ENTER_PHONE_INVALID||t===e.SEND_FAILED},isStrictEnterPhoneState:function(){var e=this.STATE,t=this.get(".state");return t===e.ENTER_PHONE
},isInvalidPhoneNumberState:function(){return this.get(".state")===this.STATE.ENTER_PHONE_INVALID},isSendingState:function(){return this.get(".state")===this.STATE.SENDING},isSendFailedState:function(){return this.get(".state")===this.STATE.SEND_FAILED},isSendSuccessState:function(){return this.get(".state")===this.STATE.SEND_SUCCESS},shouldGoNextWithDelay:function(){return this.get(".shouldGoNextWithDelay")},unsetShouldGoNextWithDelay:function(){this.set(".shouldGoNextWithDelay",!1,{silent:!0})},onSuccess:function(){this.set(".state",this.STATE.SEND_SUCCESS)
},onSendFailed:function(){this.set(".state",this.STATE.SEND_FAILED)}}},ns.ModelStatic),ns.events.on("pageinit",function(){ns.request(["filters"]),ns.request(["userphones"]),ns.request(["module-compose","module-message"])}),ns.events.on("pageinit",function(){ns.forcedRequest(["do-mail-reset-recent-counter"]),ns.events.on("pageVisible.change",function(){Jane.watcher.get("pageVisible")&&ns.forcedRequest(["do-mail-reset-recent-counter"])})}),ns.events.on("pageinit",function(){ns.events.on("ns-page-before-changed",function(){nb.trigger("popup-close")
})}),ns.events.on("pageinit",function(){Daria.Sound.preload("message")}),ns.events.on("pageinit",function(){Daria.Geolocation.monitoring()}),ns.events.on("pageinit",function(){var e=ns.Model.get("settings");if(e.isSet("show_todo")){var t=["jane.todo.js","jane.todo.yate","jane.todo.css"];Jane.Services.runModules(t,function(){Daria.Todo.init()})}}),Daria.IS_CORP&&ns.events.on("ns-page-after-load",function(){$.ajax({url:"//center.yandex-team.ru/whistlah",dataType:"jsonp"})}),ns.events.on("ns-page-before-load",function(e,t){var i=t[0],n=t[1];
"messages"===i.page&&(i.params.ids||i.params.thread_id)&&(i.params.ids!==n.params.ids||i.params.thread_id!==n.params.thread_id)&&ns.events.trigger("daria:message-will-close")});var t=220,i="Меню по правому клику",n="context-menu-item_active",s=function(e,t){return e.call(this,t)},a=_.throttle(s,100,{leading:!1});Daria.ContextMenu=function(e){if(!e.items||!e.items.length)throw new Error('Parameter "items" must contain at least 1 element');e.items=_.sortBy(e.items,"index"),this._params=e,this._parentMenu=e.parentMenu,this._scrollItervalIds={},this._menuInfo=this._transformItems(e.items),this._$container=$(Jane.tt("mail:context-menu",{items:this._menuInfo.items,"is-main-menu":!this._parentMenu})),this._$menu=this._$container.find(".js-context-menu"),this._$menuWrapper=this._$container.find(".js-context-menu-wrapper"),this._$menuContent=this._$container.find(".js-context-menu-items"),this._$menu.on("contextmenu",function(){return!1
}).on("mouseenter",".js-item",a.bind(this,this._onItemHover)).on("click",".js-item:not(.is-inactive):not(.js-submenu)",this._onItemClick.bind(this))},ns.events.on("dropdowns-closed",function(){Daria.ContextMenu.close()}),ns.events.on("daria:dropdown:close",function(){Daria.ContextMenu.close()}),Daria.ContextMenu.Helpers={},Daria.ContextMenu._$menuContainer=null,Daria.ContextMenu._isOpened=!1,Daria.ContextMenu.isOpened=function(){return this._isOpened},Daria.ContextMenu.close=function(e){e=e||{},ns.events.trigger("daria:vContextMenu:close",{success:Boolean(e.success),staySelection:Boolean(e.staySelection)}),$(".js-layout-left").off("scroll.context-menu-close")
},Daria.ContextMenu.prototype._isVisible=!1,Daria.ContextMenu.prototype.show=function(e){var t=this,i=this._isTopLevelMenu=!this._parentMenu,n=!i,s=$(window),a=$("BODY"),o=$(document);i&&(Daria.Dropdown.closeAll(),Daria.ContextMenu.close(),Daria.ContextMenu._isOpened=!0,ns.events.once("daria:vContextMenu:close",function(e,i){i=i||{},i.menuId&&i.menuId!==t._menuId||t._onCloseMenu(e,i)}),a[0].addEventListener("mousedown",this._closeMenuIfOut),a[0].addEventListener("contextmenu",this._closeMenuIfOut),this._$scrollContainer=e.$scrollContainer||s,this._$scrollContainer.on("scroll.context-menu-show",Daria.ContextMenu.close),s.on("resize.context-menu-show",Daria.ContextMenu.close),$.Shortcuts.modalListOn("context-menu"));
var r=Daria.ContextMenu._$menuContainer;r||(r=Daria.ContextMenu._$menuContainer=$("<div>"),r.appendTo("body")),r.append(this._$container),this._isVisible=!0;var l=a.outerWidth(),c=a.outerHeight(),d=o.scrollLeft(),u=o.scrollTop(),h=!1,m={top:e.y,left:e.x},g=this._$menu.find(".js-item:first"),p=this._itemHeight=g.outerHeight(),f=this._$menu.outerWidth(),_=this._$menu.outerHeight();n&&_>c/2&&(_=c/2,_=Math.floor(_/p)*p,this._$menuWrapper.css({"max-height":_}),this._addScrollControls(),h=!0);var v=!1,b=e.x-d,y=e.y-u;
if(b+f>l&&(m.left-=f,n&&(m.left-=this._parentMenu._$menu.outerWidth()+2)),y+_>c&&(m.top-=_,n&&(m.top+=p),v=!0),n){var M=g.offset().top-this._$menu.offset().top;v&&!h?m.top+=M:m.top-=M}this._$menu.css(m);var S=this._$menuWrapper.width(),D=this._$menuContent.width();S>D&&this._$menu.css({width:2*S-D}),i&&this._log("Показ")},Daria.ContextMenu.prototype._log=function(e){Jane.c(i,this._params.metrika,e)},Daria.ContextMenu.prototype._closeMenuIfOut=function(e){$(e.target).closest(".js-context-menu").length||Daria.ContextMenu.close({staySelection:!0})
},Daria.ContextMenu.prototype._addScrollControls=function(){this._$menu.addClass("context-menu_scroll"),this._$menu.addClass("context-menu_scroll_allow-down"),this._contentHeight=this._$menuContent.outerHeight(),this._contentWrapperHeight=this._$menuWrapper.outerHeight(),this._$menuWrapper.on("scroll",_.throttle(this._updateArrowsState.bind(this),50,{leading:!1})),this._$menu.on("mouseenter",".js-context-menu-scroll-up",this._toggleScrolling.bind(this,"up",!0)).on("mouseleave",".js-context-menu-scroll-up",this._toggleScrolling.bind(this,"up",!1)).on("mouseenter",".js-context-menu-scroll-down",this._toggleScrolling.bind(this,"down",!0)).on("mouseleave",".js-context-menu-scroll-down",this._toggleScrolling.bind(this,"down",!1))
},Daria.ContextMenu.prototype._onItemHover=function(e){if(this._isVisible){var t=$(e.currentTarget);if(this._$activeItem&&(this._$activeItem.removeClass(n),this._$activeItem=null),t.hasClass("js-submenu")){this._$activeItem=t,t.addClass(n);var i=t.data("id"),s=this._menuInfo.subMenusHash[i];if(s.subMenu&&s.subMenu.isShown())return;this._closeAllSubMenus(),s.subMenu=new Daria.ContextMenu({items:s.items,parentMenu:this,metrika:this._params.metrika}),s.subMenu.show({x:t.offset().left+t.outerWidth()+1,y:t.offset().top})
}else this._closeAllSubMenus()}},Daria.ContextMenu.prototype._onItemClick=function(e){var t=$(e.currentTarget),i=this._params.items[t.data("id")];this.closeMenu({success:!0}),this._log(i.metrika||"Неизвестная строка"),i.onClick&&i.onClick()},Daria.ContextMenu.prototype._closeAllSubMenus=function(){for(var e in this._menuInfo.subMenusHash){var t=this._menuInfo.subMenusHash[e];t.subMenu&&t.subMenu.close()}},Daria.ContextMenu.prototype.isShown=function(){return this._isVisible},Daria.ContextMenu.prototype.close=function(){for(var e in this._scrollItervalIds)clearInterval(this._scrollItervalIds[e]);
if(this._isTopLevelMenu){var t=$("BODY");t[0].removeEventListener("mousedown",this._closeMenuIfOut),t[0].removeEventListener("contextmenu",this._closeMenuIfOut),this._$scrollContainer.off(".context-menu-show"),$(window).off(".context-menu-show"),$.Shortcuts.modalListOff()}this._isVisible=!1,this._closeAllSubMenus(),this._$container&&this._$container.remove()},Daria.ContextMenu.prototype._transformItems=function(e){for(var t={},i=e.map(function(e,i){return e.items&&(t[i]={items:e.items}),{id:i,type:e.type,text:e.text,alt:e.alt,icon:e.icon,"inline-css":e.style,"add-class":e.addClass,"custom-icon":e.customIcon,"sub-menu":Boolean(e.items),inactive:e.hasOwnProperty("isActive")&&!e.isActive}
}),n=[],s=0;s<i.length;++s){var a=i[s];("separator"!==a.type||0!==n.length&&s!==i.length-1&&"separator"!==i[s+1].type)&&n.push(a)}return{items:n,subMenusHash:t}},Daria.ContextMenu.prototype._onCloseMenu=function(e,t){Daria.ContextMenu._isOpened&&(t=t||{},this.close(),Daria.ContextMenu._$menuContainer.remove(),Daria.ContextMenu._$menuContainer=null,Daria.ContextMenu._isOpened=!1,!t.success&&this._params.onCancel&&this._params.onCancel(t),this._params.onClose&&this._params.onClose())},Daria.ContextMenu.prototype._updateArrowsState=function(){var e=this._$menuWrapper.scrollTop();
this._$menu.toggleClass("context-menu_scroll_allow-up",e>0).toggleClass("context-menu_scroll_allow-down",this._contentHeight-this._contentWrapperHeight>e)},Daria.ContextMenu.prototype._toggleScrolling=function(e,i){i?this._scrollItervalIds[e]=setInterval(this._scroll.bind(this,e),t):clearInterval(this._scrollItervalIds[e])},Daria.ContextMenu.prototype._scroll=function(e){var t=this._$menuWrapper.scrollTop(),i="up"===e?Math.ceil:Math.floor,n=i(t/this._itemHeight)*this._itemHeight,s=n+("up"===e?-this._itemHeight:this._itemHeight);
s=Math.min(Math.max(s,0),this._contentHeight-this._contentWrapperHeight),this._$menuWrapper.scrollTop(s),this._updateArrowsState()},Daria.ContextMenu.prototype.closeMenu=Daria.ContextMenu.close.bind(Daria.ContextMenu),ns.View.define("prevent-scroll-propagation-mixin",{yateModule:"mail",methods:{getScrollContent:function(){throw new Error("Must be overwritten")},onWheel:function(e){var t=this.getScrollContent(e);if(!t)return e.preventDefault(),void e.stopImmediatePropagation();var i=e.originalEvent.deltaY,n=t.scrollTop,s=t.offsetHeight,a=t.scrollHeight;
(0>i&&0===n||i>0&&n+s>=a||s===a)&&(e.preventDefault(),e.stopImmediatePropagation())}}}),ns.View.define("kbd-dropdown-actions",{methods:{moveKbdCursor:function(e){var t=this,i=function(e){var t=e[0],i=e.closest(".js-filter-list-wrap")[0];if(!t||!i)return!1;var n=0,s=i.getBoundingClientRect(),a=t.getBoundingClientRect(),o=a.height;a.top+a.height+o>=s.bottom&&(n=s.bottom-a.top-a.height-o),a.top<s.top+o&&(n=s.top-a.top+o),0!==n&&(i.scrollTop+=n>0?-n:Math.abs(n))},n=function(){return null===t.kbdSelected?0:t.kbdSelected+1<t.visibleList.length?t.kbdSelected+1:-2
},s=function(){return t.kbdSelected<0?-1:null===t.kbdSelected?0:t.kbdSelected-1>-1?t.kbdSelected-1:-1},a=function(e){var n=t.visibleList[t.kbdSelected],s=t.visibleList[e];n?n.$node.removeClass(t.selectedClass):t.newListElementActive&&($(t.newListSelector).removeClass(t.selectedClass),t.newListElementActive=!1),s?(i(s.$node),s.$node.addClass(t.selectedClass),t.kbdSelected=e):(-2===e&&(t.newListElementActive=!0,$(t.newListSelector).addClass(t.selectedClass),t.kbdSelected=t.visibleList.length),-1===e&&(t.kbdSelected=-1))
};a("down"===e?n():s())},getOpenOptions:function(e){var t={width:200,autoclose:!0,how:{my:"center top",at:"center bottom"}};return jpath(e,".isInMore")[0]?t=_.extend(t,{how:{my:"left center",at:"right center",collision:"flipfit fit",within:".mail-App"},"class":"is-in-more-button"}):jpath(e,".isInDropdown")[0]&&(t=_.extend(t,{"class":"is-in-dropdown"})),t},_preventDefaultAndStopPropagation:function(e){e.preventDefault(),e.stopPropagation()}}}),ns.View.define("404",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},methods:{onShow:function(){$("html").addClass("mail-Page_404")
},onHide:function(){$("html").removeClass("mail-Page_404")}},yateModule:"mail"}),ns.View.define("app",{models:{"app-state":!1,"settings-color-schemes":!1,"account-information":!1,settings:!1,"index-data":!1,"skin-saver-state":{"ns-model-changed":!1,"ns-model-changed.previewMode":"toggleSkinPreviewMode"},"timeline-state":{"ns-model-changed":!1,"ns-model-changed.height":"onChangedTimelineHeight","ns-model-changed.showState":"onChangedTimelineShowState"}},events:{"ns-view-htmlinit":"onHtmlinit","ns-view-show":"onShow","ns-view-hide":"onHide","click .mail-App-Content":"closeMessageOnExternalClick","scroll .js-messages-scroll-area":"_onPaneScroll","click .js-layout-left-toggler":"_onToggleLeftColumWidth","click .js-header-themes-selector":"_onThemesSelectorClick","click .js-NewYear-button":"_onNewYearButtonClick","resize window":"onWindowResize","message.sending":"_onMessageSending","message.sent":"_onMessageSent","message.error":"_onMessageSentError","daria:vMail:resizer:initialized":"_onMailResizerInitialized","daria:vApp:changeLeftColumWidth@show":"_onChangeLeftColumWidth","daria:vApp:enableLeftColumnResize@show":"_onEnableLeftColumnResize","daria:vApp:disableLeftColumnResize@show":"_onDisableLeftColumnResize","daria:vApp:changeAppWidth@show":"onChangeAppWidth"},ctor:function(){this._onPaneScroll=_.throttle(this._onPaneScroll.bind(this),50),this._onThemesSelectorClick=_.throttle(this._onThemesSelectorClick.bind(this),300,{leading:!1}),this.onWindowResize=_.throttle(this.onWindowResize.bind(this),50),this.boundOnButtonKeyPress=this.onButtonKeyPress.bind(this),this._onTransitionEndDebounce=_.debounce(this._onTransitionEnd.bind(this),20)
},yateModule:"mail",methods:{MIN_WIDTH_HEADER_LEFT:220,MIN_LOGO_GAP:20,_resizerCommon:{_vMailPane2Width:0,_vMailFixBeforeCssUpdate:_.noop,_vMailFixAfterCssUpdate:_.noop,_setActualRatio:_.once(function(){var e,t=this.getFromSettings();e=this.unitsToRatio(_.isFinite(t)?t:this.sizes.pane1),this.setRatio(e,!0,!0)})},onHtmlinit:function(){this.MIN_WIDTH_LOGO=this.$node.find(".js-mail-Logo").width(),this._loader=new Jane.Loader(0),Daria.resize.init(),this.$node.transitionEnd(this._onTransitionEndDebounce)
},onShow:function(){this.splitter&&this.splitter.initialized&&this.splitter.options.splitter.show(),this._onChangeLeftColumWidth(),$("body").on("keydown","button",this.boundOnButtonKeyPress),"themes"===Daria.urlParams.startWithPromo&&this._openThemesSelector(),this.getLayoutConstraints(),this.onChangedTimelineShowState()},onHide:function(){$("body").off("keydown","button",this.boundOnButtonKeyPress)},onChangedTimelineHeight:function(){var e=this.getModel("timeline-state"),t=e.get(".height"),i=ns.Model.get("scroller-message").getScroller(),n=i.scrollTop()+i.height()+t,s=Daria.is2pane?this.$node.height():this.$node.find(".js-message-inner").height();
n>s&&(this._needScrollMessage=!0)},onChangedTimelineShowState:function(){var e=$(".js-page"),t=this.getModel("timeline-state");switch(e.removeClass("mail-Page_with_Timeline_collapsed mail-Page_with_Timeline"),t.get(".showState")){case t.SHOW_COLLAPSED:e.addClass("mail-Page_with_Timeline_collapsed");break;case t.SHOW_PROMO:case t.SHOW_TIMELINE:e.addClass("mail-Page_with_Timeline")}},_onTransitionEnd:function(){this._needScrollMessage&&(this._needScrollMessage=!1,this.onScrollOutTimeline())},onScrollOutTimeline:function(){var e=this.getModel("timeline-state").get(".height");
if(e>0){var t=ns.Model.get("scroller-message").getScroller(),i=t.scrollTop();t.scrollTop(i+e)}},getLayoutConstraints:function(){var e=this.$node.find(".js-mail-layout")[0];this.getModel("app-state").set(".mailLayoutClientRect",e.getBoundingClientRect())},_onChangeLeftColumWidth:function(){if(Daria.isPageWithResizableLeftColumn()){var e=[{min:250,max:Number.MAX_VALUE,nameOfClass:"mail-Layout-Aside_maximum",sizeKind:"maximum"},{min:180,max:250,nameOfClass:"mail-Layout-Aside_middle",sizeKind:"middle"},{min:80,max:180,nameOfClass:"mail-Layout-Aside_minimum",sizeKind:"minimum"},{min:0,max:80,nameOfClass:"mail-Layout-Aside_minimum mail-Layout-Aside_compact",sizeKind:"compact"}],t=this.$node.find(".js-layout-left"),i=t.width(),n=_.find(e,function(e){return i>=e.min&&i<e.max
});if(n.sizeKind!==this._prevAsideSizeKind){var s=ns.Model.get("settings");t.removeClass("mail-Layout-Aside_maximum mail-Layout-Aside_middle mail-Layout-Aside_minimum mail-Layout-Aside_compact"),t.addClass(n.nameOfClass),Daria.resize.isWithCompactLeftColumn="compact"===n.sizeKind,"compact"===this._prevAsideSizeKind?(Jane.c("Левая колонка",Daria.is2pane()?"2pane":"3pane","Выбран","Полный режим"),s.setSettings({hide_empty_folders:!1})):void 0!==this._prevAsideSizeKind&&"compact"===n.sizeKind&&(Jane.c("Левая колонка",Daria.is2pane()?"2pane":"3pane","Выбран","Компактный режим"),s.setSettings({hide_empty_folders:!0}))
}$(window).trigger("resize.daria-sticky"),ns.events.trigger("shortcuts.update-labels-list"),this.getModel("app-state").setIfChanged(".asideSizeKind",n.sizeKind),this.resizeHeaderLeftColumn({size:{width:i}}),this._prevAsideSizeKind=n.sizeKind}},_onToggleLeftColumWidth:function(){var e,t=ns.Model.get("settings"),i=this.$node.find(".js-layout-left"),n=i.width();Daria.resize.isWithCompactLeftColumn?(Jane.c("Левая колонка",Daria.is2pane()?"2pane":"3pane","Клик","Развернуть"),t.setSettings({"size-aside-minified":n}),e=Math.max(this.MIN_WIDTH_HEADER_LEFT,parseInt(t.getSetting("size-aside-expanded"),10))||this.MIN_WIDTH_HEADER_LEFT):(Jane.c("Левая колонка",Daria.is2pane()?"2pane":"3pane","Клик","Свернуть"),t.setSettings({"size-aside-expanded":n}),e=Math.min(79,parseInt(t.getSetting("size-aside-minified"),10))||60),i.width(e),Daria.resize.saveSizeOnSettings({settingName:"size-layout-left",type:"h"},i),ns.events.trigger("daria:vApp:changeAppWidth"),ns.events.trigger("daria:vApp:changeLeftColumWidth"),this.resizeHeaderLeftColumn({size:{width:e}})
},_onDisableLeftColumnResize:function(){if(!Daria.isPageWithResizableLeftColumn()){var e=this.$node.find(".js-layout-left");e.addClass("with-disabled-resize"),this.resizeHeaderLeftColumn({size:{width:e.width()}})}},_onEnableLeftColumnResize:function(){if(Daria.isPageWithResizableLeftColumn()){var e=this.$node.find(".js-layout-left");e.hasClass("with-disabled-resize")&&(e.removeClass("with-disabled-resize"),ns.events.trigger("daria:vApp:changeAppWidth"),ns.events.trigger("daria:vApp:changeLeftColumWidth"))
}},resizeHeaderLeftColumn:function(e){var t,i=ns.Model.get("settings");t=e?e.size.width:this.WIDTH_LAYOUT_LEFT?this.WIDTH_LAYOUT_LEFT:parseInt(i.getSetting("size-layout-left"),10)||this.MIN_WIDTH_HEADER_LEFT,this.WIDTH_LAYOUT_LEFT=t,i.isCompactHeaderMode()||(t=Math.max(t,this.MIN_WIDTH_LOGO),t-=Math.max(0,this.MIN_LOGO_GAP-this.getModel("app-state").get(".mailLayoutClientRect.left"))),this.$node.find(".js-header-left-column").css("min-width",t+"px")},_onThemesSelectorClick:function(){this._openThemesSelector()
},_openThemesSelector:function(){ns.Model.get("themes-selector").open(),ns.page.go()},_onPaneScroll:function(e){var t=$(e.target),i=t.find(".ui-resizable-s");i.length&&i.css({top:t.scrollTop()+t.height()-i.height()})},onWindowResize:function(){this.getLayoutConstraints()},onChangeAppWidth:function(){this.getLayoutConstraints()},onButtonKeyPress:function(e){var t=$(e.currentTarget);if(e.keyCode===Jane.Common.keyCode.ENTER){var i=jQuery.Event("click");return t.trigger(i),!0}},closeMessageOnExternalClick:function(e){if(Daria.is2pane()){var t=e.target===e.currentTarget;
if(t){var i="messages"===ns.page.current.page&&Jane.Page.isParamsForMessage(ns.page.current.params);i&&(Jane.c("Закрытие писем кликом в сторону"),ns.page.go(Jane.Page.generateUrl.closeMessage()))}}},toggleSkinPreviewMode:function(){var e=this.getModel("skin-saver-state");$(".js-page").toggleClass("mail-Page_skin_preview",e.isPreviewMode())},_onNewYearButtonClick:function(){Jane.c("Залогиновая шапка. Правая часть",'Кнопка "Новогоднее"',"Клик")},canShowNewYearButton:function(){var e=Date.now(),t=-1!==["ru","uk","be","kk"].indexOf(Daria.locale),i="yandex.com"===Daria.Config["yandex-domain"];
return e>=14821812e5&&1483909199e3>=e&&t&&!i},getNewYearPromoLink:function(){return Daria.Config["promos-path"]["newyear-2017"]},_onMailResizerInitialized:function(e,t){"h"===t.options.direction&&(this._resizerCommon._vMailFixBeforeCssUpdate=function(){t&&t.initialized&&(t.updateSizes(),this._vMailPane2Width=t.sizes.pane2)},this._resizerCommon._vMailFixAfterCssUpdate=function(){if(t&&t.initialized){t.updateSizes();var e=t.totalSize-this._vMailPane2Width,i=t.unitsToRatio(e);t.setRatio(i)}})},_onMessageSending:function(e,t){t=t||{},t.body&&Daria.Statusline.showMsg(t),this._loader.start()
},_onMessageSent:function(e,t){t=t||{},t.body&&Daria.Statusline.showMsg(t),this._loader.stop(),Daria.setCookie("msgsent","1",{duration:Daria.timify({minutes:5})})},_onMessageSentError:function(){Daria.Statusline.hide(),this._loader.stop()}}}),ns.View.define("ads-mixin",{methods:{_adsModel:null,adNodes:null,adStyleNode:null,getAdsModel:function(){return this._adsModel||(this._adsModel=ns.Model.get("ads")),this._adsModel},initAds:function(){this.onAdsModelChangedBound=_.debounce(this.onAdsModelChanged.bind(this),10)
},startAds:function(){var e=this.getAdsModel();e.on("ns-model-changed",this.onAdsModelChangedBound),this.renderAds()},stopAds:function(){var e=ns.Model.get("ads");e.off("ns-model-changed",this.onAdsModelChangedBound),this.removeAdNodes()},onAdsModelChanged:function(){this.renderAds()},renderAds:function(){var e=this.getAds(),t=ns.Model.get("skin-saver-state");if(e&&!t.isPreviewMode()){this.removeAdNodes(),this.adNodes=this.getAdNodes(e);var i=this.getAdsModel();i.addAdNodes(this.adNodes),this.adStyleNode=this.getAdStyleNode(e),this.attachAdStyleNode(this.adStyleNode),this.attachAdNodes(this.adNodes)
}},getAds:function(){throw new Error("Should be overwritten")},getAdNodes:function(){throw new Error("Should be overwritten")},getAdStyleNode:function(){throw new Error("Should be overwritten")},attachAdNodes:function(){throw new Error("Should be overwritten")},attachAdStyleNode:function(e){document.head.appendChild(e)},removeAdNodes:function(){var e,t=this.getAdsModel();if(this.adNodes)for(t.removeAdNodes(this.adNodes);this.adNodes.length;)e=this.adNodes.pop(),Jane.DOM.removeNode(e);this.adStyleNode&&(Jane.DOM.removeNode(this.adStyleNode),this.adStyleNode=null)
}}}),ns.View.define("journal-log-mixin",{methods:{getUserBehaviorId:function(){return this._readingId||(this._readingId=Daria.Config.yandexuid+(this.params.tid||"")+Math.random().toString(16).slice(2)),this._readingId},getUserBehaviorParams:function(){var e=this.params,t={target:e.tid?"thread":"message",isSearch:Jane.Page.isParamsForSearch(e),readingId:this.getUserBehaviorId()};return e.ids&&(t.mid=e.ids),e.tid&&(t.tid=e.tid),t},writeToUserJournal:function(e){ns.request("do-journal-log",{params:JSON.stringify(_.assign({operation:e},this.getUserBehaviorParams()))})
},writeLogForWidgets:function(e,t){ns.request("do-journal-log",{params:JSON.stringify(_.assign({target:"message",operation:e},t))})}}}),ns.View.define("messages-search-logger-mixin",{methods:{SEARCH_FILTER_PARAMS:["scope","fid","lid","unread","from","to","attaches","type"],logClickMessageFromSearch:function(e){var t=ns.page.current.params;if(Jane.Page.isParamsForSearch(t)){var i=ns.Model.get("search-session-state").getSearchResultsReceivedTs(),n=Date.now()-i,s="WEB";Jane.Config.pddDomain?s="WEBPDD":Daria.IS_CORP&&(s="YT");
var a=ns.Model.get("messages",t),o=a.params,r=this.getModel("message")||ns.Model.get("message",this.params),l=a.models.indexOf(r),c=["r="+encodeURIComponent(o.request),"pos="+(l>-1?l+1:-1),"project=search_mail","product="+s,"reqid="+Daria.Config.searchSessionId,"user="+Daria.uid,"mid="+this.params.ids,"time="+n,"clicktype="+e];a.isSearchTopResult(r.get(".mid"))&&c.push("tophits=yes");var d=this._getSearchFilterParams(o);d&&c.push("filter="+d);var u=(Daria.Config["exp-test-ids"]||[]).join(",");u&&c.push("exp="+u),Daria.searchClickCounter(c)
}},_getSearchFilterParams:function(e){var t=[];return this.SEARCH_FILTER_PARAMS.forEach(function(i){e.hasOwnProperty(i)&&t.push(i+":"+e[i])}),t.join(",")}}}),ns.View.define("preview-eml-mixin",{methods:{_getParamsFromNode:function(e){var t=Daria.parseQuery($(e).data("params")),i=t.mid||this.params.ids,n=t.hid,s=t.subj;return s&&"No subject"!==s||(s="(Без темы)"),{ids:i,hid:n,subj:s}},_getPopupWidth:function(){var e=Daria.is3pane()?$(".js-layout-second-pane").width():$(".js-layout-first-pane").width();
return e||(e=this.$node.width()),e},previewEml:function(e){e.preventDefault();var t=this._getParamsFromNode(e.currentTarget);if(this.vPopup&&(this.popupIsLoading||this.vPopup.isValid()))return this.vPopup.close(),this.vPopup.destroy(),void(this.vPopup=null);var i=$(window).height(),n=this._getPopupWidth();this.vPopup=ns.View.create("attached-message-popup",t),this.vPopup.appendToNode=this.node,this.popupIsLoading=!0,ns.request(["message","message-body"],{ids:t.ids,hid:t.hid}).then(function(){this.vPopup.open({width:n,maxHeight:i,where:window}),this.popupIsLoading=!1
},this),this.countAttachmentPreview()}}}),function(){function e(e){return"m"+e.replace(/(^[a-z])|(?:-([a-z]))/gi,function(e,t,i){var n=i||t;return n.toUpperCase()})}var t=[201,203],i=[202,204];ns.View.define("promo-mobile-app-mixin",{methods:{initPromoMobileAppMixin:function(){this._checkModels();var e=this.nbPhoneNumber=nb.$block(".js-phone-number",this.node);this.nbGetAppLinkButton=nb.$block(".js-get-mobile-app-link",this.node);var t=this.getState();e.$control.trigger("input"),e.on("input",this.onPhoneNumberInput.bind(this)),e.$control.on("blur",function(){t.isStrictEnterPhoneState()&&t.setDefaultState()
}),this._loadState()},isMobileAppInstalled:function(){return t.some(Daria.hasSid)&&i.some(Daria.hasSid)},_checkModels:function(){var t=["promo-mobile-app-state","userphones"],i=this,n="vPromoMobileAppMixin";t.forEach(function(t){ns.assert(i.getModel(t),"Daria."+n,"требует наличия модели "+e(t)+" в зависимостях")})},onPhoneNumberInput:function(){this.getState().setEnterPhoneState();var e=this.nbPhoneNumber.getValue(),t=this.applyPhoneNumberFormat(e);e.length===t.length&&this.checkPhoneNumberFormat(e)||this.nbPhoneNumber.setValue(t)
},applyPhoneNumberFormat:function(e){return e},checkPhoneNumberFormat:function(){return!0},_loadState:function(){throw new Error("Метод #_loadState не определён")},sendMobileAppLink:function(){throw new Error("Метод #_sendMobileAppLink не определён")},getActivePhoneNumber:function(){var e=this.getModel("userphones");return this.applyPhoneNumberFormat(e.getActiveNumber()||e.getUnconfirmedNumber()||"")},cleanPhoneNumber:function(e){return e.replace(/\D/g,"")},_getPhoneNumber:function(){var e=this.nbPhoneNumber.getValue();
return this.cleanPhoneNumber(e)},getState:function(){return this.getModel("promo-mobile-app-state")},onStateChanged:function(){this.keepValid(),this._loadState()}}})}(),ns.View.define("save-to-disk-mixin",{events:{"click .js-show-save-popup":"showSavePopup"},yateModule:"mail",methods:{_deferred:null,showSavePopup:function(e){ns.assert(this.getCountLocationName,"Daria.vSaveToDiskMixin","method getCountLocationName should be declared");var t=e.currentTarget,i=$(t),n=i.closest(".js-mail-file");e.preventDefault(),this._deferred||(this._deferred=ns.View.create("disk-widget-save-popup").open({mid:t.getAttribute("data-mid"),hid:t.getAttribute("data-hid"),diskDownloadUrl:t.getAttribute("data-disk-download-url"),countLocationName:this.getCountLocationName(),popup:{where:t,withTail:!1}}),i.toggleClass("is-disabled",!0),n.toggleClass("is-active",!0),this._deferred.promise().then(function(){i.removeClass("is-disabled"),n.removeClass("is-active"),this._deferred=null
},this),this.countSaveToDisk())},countSaveToDisk:function(){Jane.c(["Вложения",'клик "сохранить на диск"',this.getCountLocationName()])}}}),ns.View.defineNg("attachments-widget",{models:{"message-body":!0},events:{"ns-view-show":"onShow","click .js-attachment-actions-item":"onAttachmentActionsItemClick","click .js-image-preview":"previewImage","click .js-download-attachment":"countDownloadAttachment","click .js-eml-preview":"previewEml","click .js-show-info":"showInfoPopup","click .js-download-all-attachments":"countDownloadAllAttachments","click .js-preview-attachment":"countAttachmentPreview","daria:vScrollerMessages:scroll":"_updateItemsVisibility","daria:vScrollerMessage:scroll":"_updateItemsVisibility"},params:function(e){var t=ns.Model.get("message",{ids:e.ids}),i={ids:t.get(".last_mid")||t.get(".mid")};
return e.hid&&(i.hid=e.hid),i},yateModule:"mail",methods:{onShow:function(){this._updateItemsVisibility(),this.hasVisibleAttachments()&&this.countAttachmentsShow()},hasVisibleAttachments:function(){return this.$node.find(".js-mail-file").length>0},_updateItemsVisibility:function(e){var t=Daria.is3pane()?"scroller-message":"scroller-messages";if("daria:vScrollerMessages:scroll"!==e||!Daria.is3pane()){var i=this.$node.find(".js-mail-file-icon").toArray(),n=ns.Model.get(t),s=n.getHeight()+n.getScrollTop();
i.forEach(function(e){var t=$(e),i="none"!==t.css("background-image"),a=n.getNodeTop(e)<s;!i&&a&&t.attr("style",t.attr("_style"))})}},previewImage:function(e){var t=Daria.parseQuery($(e.currentTarget).data("params")),i=t.mid||this.params.ids,n=t.hid,s=this.params.hid;Daria.ImageViewer.open("",i,n,s),e.preventDefault()},onAttachmentActionsItemClick:function(){this.logClickMessageFromSearch("attach")},showInfoPopup:function(e){"attachments-widget"===this.id&&(e.preventDefault(),ns.View.create("attachments-widget-popup",this.params).showAt(e.currentTarget),this.countAttachmentsNumberClick())
},countAttachmentsShow:function(){Jane.c(["Вложения","показ вложений",this.getCountLocationName()])},countAttachmentPreview:function(){Jane.c(["Вложения",'клик "просмотреть"',this.getCountLocationName()])},countDownloadAttachment:function(){Jane.c(["Вложения",'клик "скачать одно"',this.getCountLocationName()])},countDownloadAllAttachments:function(){Jane.c(["Вложения",'клик "скачать все"',this.getCountLocationName()])},countAttachmentsNumberClick:function(){Jane.c(["Вложения","клик в число вложений",this.getCountLocationName()])
},_locationNames:{"attachments-widget":"в списке писем","attachments-widget-body":"в письме","attachments-widget-popup":"в попапе в списке писем"},getCountLocationName:function(){var e=this._locationNames[this.id];return ns.assert(e,"Daria.vAttachmentsWidget","no name specified for %s to count in metrika",this.id),e}}},"preview-eml-mixin","messages-search-logger-mixin","save-to-disk-mixin",ns.View),ns.View.defineNg("attachments-widget-body",{models:{"message-body":!0},events:{"ns-view-htmlinit":"onHtmlInit","click .js-image-preview":"previewImage","click .js-eml-preview":"previewEml","click .js-show-info":"onShowInfoClick","daria:vApp:changeAppWidth@show":"updateBlockState","daria:vApp:changeRightColumSize@show":"updateBlockState","daria:vAttachmentsWidgetBody:downloadAttachments@show":"downloadAttachments"},methods:{CLASS_DISABLED_INFO_BUTTON:"disabled",CLASS_BLOCK_WITH_MASK:"mail-MessageSnippet-Item_attachments_closed",CLASS_ACTION_ALIGN_RIGHT:"mail-MessageSnippet-Item_actionRight",MIN_INDENT_ACTION_BLOCK:32,onHtmlInit:function(){this.$infoButton=this.$node.find(".js-show-info"),this.$filesBlock=this.$node.find(".js-attachments-files"),this.$actionBlock=this.$node.find(".js-attachments-action"),this.heightFilesBlockOnFirstLoad=this.$filesBlock.height(),this.updateBlockState(),this._openedManually&&this.showAllAttach(!0)
},onShowInfoClick:function(){this.showAllAttach()},logClickMessageFromSearch:function(){},updateBlockState:function(){var e=this.$filesBlock[0].scrollHeight,t=this.$filesBlock.height();t===e?this.markOpened():this.markClosed(),e>this.heightFilesBlockOnFirstLoad?this.enableInfoButton():this.disableInfoButton(),this.updateAlignActionButton()},updateAlignActionButton:function(){var e=this.$node.width()-this.$filesBlock.width()-this.$actionBlock.width()<this.MIN_INDENT_ACTION_BLOCK;this.$node.toggleClass(this.CLASS_ACTION_ALIGN_RIGHT,e)
},showAllAttach:function(e){if(!this.isDisabledInfoButton()){if(e)this.$filesBlock.css("max-height","none"),this.$filesBlock.css("max-height",this.$filesBlock[0].scrollHeight),this.markOpened(),this._openedManually=!0;else{var t=this.$filesBlock[0].scrollHeight,i=this.$filesBlock.height();t>i?(this.$filesBlock.css("max-height",t),this.markOpened(),this._openedManually=!0):i>this.heightFilesBlockOnFirstLoad&&(this.$filesBlock.css("max-height","").afterTransition(this.markClosed.bind(this)),this._openedManually=!1)
}this.countAttachmentsNumberClick()}},markClosed:function(){this.$node.addClass(this.CLASS_BLOCK_WITH_MASK)},markOpened:function(){this.$node.removeClass(this.CLASS_BLOCK_WITH_MASK)},isDisabledInfoButton:function(){return this.$infoButton.hasClass(this.CLASS_DISABLED_INFO_BUTTON)},disableInfoButton:function(){this.$infoButton.toggleClass("is-hidden",!0),this.$infoButton.addClass(this.CLASS_DISABLED_INFO_BUTTON)},enableInfoButton:function(){this.$infoButton.removeClass(this.CLASS_DISABLED_INFO_BUTTON)
},downloadAttachments:function(){var e=Daria.url.archive(this.getModel("message-body").getData(),this.params.ids);e&&(window.location.href=e)}},yateModule:"mail"},"attachments-widget"),ns.View.edefine("attachments-widget-popup",{models:{"message-body":!0,message:!0,dimensions:{"ns-model-changed":!1,resize:"_onResize"}},events:{"click .js-show-info":"onClickInfo"},yateModule:"mail",methods:{showAt:function(e){this.update(this.params).then(this._initNbPopup.bind(this,e))},onClickInfo:function(e){e.stopPropagation(),nb.block(this.node).close()
},getScrollContent:function(e){return $(e.target).parents("._nb-popup")[0]},_initNbPopup:function(e){var t=this;$(e).closest(":focusable").focus();var i=nb.block(this.node);i.on("nb-closed",function(){t.destroy(),this.destroy(),t._nbPopup=null}),i.open({where:e,how:{my:"right+20 top-16",at:"right top",collision:"fit fit"},animation:!1,autoclose:!0}),this._nbPopup=i,this._onResize()},_onResize:function(){this._nbPopup&&this.$node.contextDialog("option",{maxHeight:this._$window.height()})}}},"attachments-widget","prevent-scroll-propagation-mixin",ns.View),ns.View.define("footer",{models:["footer-data","languages"],yateModule:"mail"}),ns.View.define("footer-journal-link",{models:{"last-login":!0},yateModule:"mail"}),ns.View.define("services-list-mixin",{methods:{METRIKA_TABS_NAMES:{search:"Поиск",search_more:"Поиск",contacts:"Контакты",disk:"Диск",money:"Деньги",images:"Картинки",news:"Новости",maps:"Карты",metrika:"Метрика",pogoda:"Погода",tv:"Телепрограмма",music:"Музыка",afisha:"Афиша",browser:"Браузер",market:"Маркет",direct:"Директ",fotki:"Фотки",yamb:"Ямб",all_services:"Все сервисы",calendar:"Календарь",translate:"Переводчик",inbox:"Письма",portal:"Коннект"},isShowMetrikaSend:!1,_getShowMetrikaData:function(){var e=ns.Model.get("index-data"),t=e.getAllTabsIds(),i=t.head,n=t.more,s=this.getHiddenTabsMetrikaId();
return i=i.filter(function(e){return-1===s.indexOf(e)}),n=n.concat(s),{head:i,more:n}},getHiddenTabsMetrikaId:function(){return this.getHiddenTabs().map(function(e){return e.node.getAttribute("data-metrika-id")}).filter(function(e){return e})},_tabsMetrikaIdToObj:function(e,t){if(!Array.isArray(e))return[];var i=this;return e.map(function(e){var n=i._getMetrikaTabName(e);if(!n)return!1;if(t){var s={};return s[n]=t,s}return n}).filter(function(e){return e})},registerShowTabs:function(e){this._registerShowTabs(e)
},_registerShowTabs:function(e){if(ns.assert(e,"Daria.vServicesListMixin",'parameter "mode" is obligatory'),!Daria.IS_CORP&&!(-1!==["navigation-visible-tabs","navigation-hidden-tabs"].indexOf(e)&&ns.Model.get("settings").isSet("liza_minified_header")||"navigation-visible-tabs"===e&&this.isShowMetrikaSend)){var t=[];if("services"===e){var i=ns.Model.get("index-data").getAllTabsIds();t=[].concat(i.head,i.more)}else t=this._getShowMetrikaData()["navigation-visible-tabs"===e?"head":"more"];if(t.length){var n={},s={"Залогиновая шапка.Левая часть":{"Портальная навигация/Сервисы":n}},a=this._tabsMetrikaIdToObj(t,"Показ");
-1!==["services","navigation-hidden-tabs"].indexOf(e)?(n[Daria.Config["yandex-domain"]]={},n[Daria.Config["yandex-domain"]]["services"===e?"Сервисы":"Ещё"]=a):n[Daria.Config["yandex-domain"]]=a,Jane.c(s),this.isShowMetrikaSend=!0}}},registerTabClick:function(e,t){this._registerTabClick(e,t)},_registerTabClick:function(e,t){if(!Daria.IS_CORP){var i=["Залогиновая шапка.Левая часть","Портальная навигация/Сервисы",Daria.Config["yandex-domain"]],n=this._getMetrikaTabName(e);n&&("navigation-hidden-tabs"===t?i.push("Ещё"):"services"===t&&i.push("Сервисы"),Jane.c(i.concat([n,"Клик"])))
}},_getMetrikaTabName:function(e){return e&&"string"==typeof e?this.METRIKA_TABS_NAMES[e]:!1}}}),ns.View.define("head-tabs",{events:{"ns-view-htmlinit":"onHtmlinit","click@show .js-more-services":"showDropdown","mousedown .js-services-tab":"onServicesTabClick","ns-page-before-load":"onPageBeforeLoad","head-tabs-recalculate":"recalculateTabs","resize window":"onResize"},models:{"index-data":"invalidate",settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified_header":"onLizaMinifiedHeaderChanged"}},yateModule:"mail",ctor:function(){this.nbPopup=null,this.onPopupClosed=this.onPopupClosed.bind(this),this.onResize=_.throttle(this.onResize.bind(this),50),this.onHtmlinitDebounce=_.debounce(this._onHtmlinitDebounce.bind(this),0)
},methods:{onHtmlinit:function(){this.onHtmlinitDebounce()},_onHtmlinitDebounce:function(){this.recalculateTabs(),this.registerShowTabs("navigation-visible-tabs")},onLizaMinifiedHeaderChanged:function(){this.registerShowTabs("navigation-visible-tabs")},recalculateTabs:function(){this.calculateTabs(),this.onResize()},calculateTabs:function(){var e=_.toArray(this.node.children),t=e.slice(-1)[0].clientWidth;$(e[0]).removeClass("g-invisible");var i=e[0].offsetLeft;this.tab=e.slice(0,-1).map(function(e,n){return 1===n&&(t+=i),t+=e.clientWidth,{node:e,minWidth:t}
}),i>0&&this.tab.push({name:"leftImage",minWidth:i+this.tab[0].minWidth});var n=this.getHiddenTabsId();n.length>5&&Jane.ErrorLog.send({errorType:"header-tabs.infinity"})},onPageBeforeLoad:function(){this.popupClose()},onResize:function(){var e=this.node.clientWidth;this.tab&&this.tab.forEach(function(t){t.minWidth>=e?t.node?t.node.classList.add("g-invisible"):this.$node.addClass("without-"+t.name):t.node?t.node.classList.remove("g-invisible"):this.$node.removeClass("without-"+t.name)}.bind(this))
},getHiddenTabs:function(){return _.isArray(this.tab)?this.tab.filter(function(e){return e.node&&e.node.classList.contains("g-invisible")}):[]},getHiddenTabsId:function(){return this.getHiddenTabs().map(function(e){return e.node.getAttribute("data-id")})},showDropdown:function(){if(!this.popupClose()){var e=this.getModel("index-data"),t=this.getHiddenTabsId(),i=e.get(".tabs.more"),n=e.get(".tabs.head").filter(function(e){return _(t).includes(e.id)}),s=[].concat(n,i);s=s.map(function(e){var t=_.omit(e,["id"]);
return t["class"]="js-more-services-tab js-services-tab",e.id&&"string"==typeof e.id&&(t.attrs={"data-metrika-id":e.id}),t}),this.nbPopup=nb.block(ns.renderNode({tabs:s},"head-tabs-popup","mail")),this.nbPopup.on("nb-opened",this.onPopupOpened.bind(this)),this.nbPopup.on("nb-closed",this.onPopupClosed.bind(this)),this.nbPopup.open({where:this.$node.find(".js-more-services-target")}),this.registerShowTabs("navigation-hidden-tabs")}},onPopupOpened:function(){this.nbPopup.$node.on("mousedown",".js-services-tab",this.onServicesTabClick.bind(this))
},onPopupClosed:function(){this.nbPopup&&(this.nbPopup.$node.off(),this.nbPopup.destroy(),this.nbPopup=null)},popupClose:function(){return this.nbPopup?(this.nbPopup.close(),!0):!1},onServicesTabClick:function(e){if(e&&"mousedown"===e.type&&(0===e.button||1===e.button)){var t=e.currentTarget;this.registerTabClick(t.getAttribute("data-metrika-id"),t.classList.contains("js-more-services-tab")?"navigation-hidden-tabs":"navigation-visible-tabs")}}}},"services-list-mixin"),ns.View.define("head-user",{events:{"ns-view-show":"onShow",click:"toggleDropdown"},models:{"index-data":"keepValid","head-user-state":{"ns-model-changed":"keepValid","ns-model-changed.newLettersInMA":"onNewLettersInMA"}},yateModule:"mail",methods:{onShow:function(){this.onNewLettersInMA(),this.metriksForAddMultiUser(),_.delay(function(){ns.request(["user-dropdown-data"])
},1e3)},toggleDropdown:function(){if(this.vPopup&&this.vPopup.isValid())return this.vPopup.close(),void(this.vPopup=null);var e=$(window).innerHeight()-120;this.vPopup=ns.View.create("user-dropdown"),this.vPopup.open({maxHeight:e,where:this.node,withoutTail:!0})},onNewLettersInMA:function(){var e=this.getModel("head-user-state").hasNewLettersInMA();this.$node.find(".mail-User-Picture").toggleClass("is-updated",e)},metriksForAddMultiUser:function(){var e=["Залогиновая шапка. Правая часть","Меню за логином","Клик"],t=!1;
Daria.urlParams.addMultiUserFromDropdownLink?(t=!0,e.push("Пользователь добавлен по ссылке Добавить пользователя под Выходом")):Daria.urlParams.addMultiUserFromDropdownButton?(t=!0,e.push("Пользователь добавлен по ссылке добавить (вариант для МА пользователя)")):Daria.urlParams.addMultiUserFromDropdownPromo&&(t=!0,e.push("Пользователь добавлен по кнопке «Добавить аккаунт»")),t&&(Jane.c(e),ns.Model.get("settings").setSettingOn("user_dropdown_promo"))}}}),ns.View.define("loader",{events:{"ns-page-before-load":"start","ns-page-after-load":"stop","ns-page-error-load":"stop","fake-loader":"fake"},ctor:function(){this.start=_.debounce(this.start.bind(this),300)
},yateModule:"mail",methods:{start:function(){this.$node.addClass("is-active"),this.locked=!1},stop:function(){this.locked||(this.start.cancel(),this.$node.removeClass("is-active"))},fake:function(){this.locked=!0,this.$node.addClass("is-active"),setTimeout(this.unlock.bind(this),1500)},unlock:function(){this.locked=!1,this.stop()}}}),ns.View.define("logo",{models:{"index-data":!1,"ws-dropdown-data":!1},events:{"ns-view-htmlinit":"onInit","daria:vApp:changeRightColumSize":"onResizeRightColumn"},ctor:function(){this.onResizeRightColumn=_.once(this.onResizeRightColumn)
},yateModule:"mail",methods:{onInit:function(){if(Daria.hasFeature("workspace-header")&&Daria.Config.workspace){var e=$("#logo-dropdown");if(e&&e.length){this.popup=nb.block(e[0]);var t=$(".js-mail-logo-yandex");this.popup.on("nb-opened",function(){t.addClass("is-active")}),this.popup.on("nb-closed",function(){t.removeClass("is-active")})}}},onResizeRightColumn:function(){this.popup&&this.popup.close()}}}),ns.View.define("search",{models:{"search-view":{"ns-model-changed":"keepValid","ns-model-changed.folded":"onChangeFolded"},settings:{"ns-model-changed":"keepValid","ns-model-changed.liza_minified":"toggleSearch","ns-model-changed.liza_minified_header":"toggleSearch","search.state:changed":"_updateSearchSpinner"}},events:{"ns-view-htmlinit":"onhtmlinit","ns-view-show":"onshow","ns-view-touch":"onrepaint","ns-view-hide":"onhide","search-options:opened":"_onSearchOptionsOpen","search-options:closed":"_onSearchOptionsClose","search.toggle-search-options":"_onToggleSearchOptions","search.start-search":"_onStartSearch","search.blur-input":"_blurInput","daria:cbt:mousedown":"_blurInput","hotkeys.to-search-input":"onSearchOpenHotkey","search:need-correcting-request":"_onCorrectingRequest","daria:search:autocomplete-search-started@show":"onAutocompleteSearchStarted","daria:vToolbarAside:changeCheckedCount@show":"onChangeCheckedCount","mousedown .js-search-options-toggle":"_preventAndStop","click .js-search-options-toggle":"_onToggleOptionsClick","submit FORM.jane-search":"_preventAndStop","click .js-search-open":"onSearchOpenClick","focus .js-search-input":"onSearchOpenFocus","click .js-search-close":"closeSearch","ns-page-after-load":"toggleSearch","click .js-search-button":"onSearchInputButtonPress","keyup .js-search-input":"onSearchInputKeyPressProxy"},ctor:function(){this.onSearchInputKeyPress=_.throttle(this.onSearchInputKeyPress,600),this.oldValue="",this._$searchOptionsToggle=null,this._$spinner=null,this._$searchButton=null,this.$input=null,this._$nbInput=null
},yateModule:"mail",methods:{onAutocompleteSearchStarted:function(e,t){t&&t.request&&(this._$nbInput.setValue(t.request),this.oldValue=t.request)},onSearchNbInputChanged:function(e,t){this.isSearchPage()&&!this.isCollectorSearch()&&""!==this.oldValue&&""===t.getValue()&&(this.oldValue="",this.showSuggest(""))},onSearchInputKeyPressProxy:function(e){13===e.keyCode?(this.onSearchInputKeyPress.cancel(),this.onSearchInputEnterPress()):this.onSearchInputKeyPress()},onSearchInputEnterPress:function(){var e=ns.Model.get("focus"),t=e.getFocus()&&1===e.getIndexCurrentColumn();
t||this._startSearch({force:!0,metrika:"enter"})},onSearchInputButtonPress:function(){""!==this.$input.val()?this._startSearch({force:!0,metrika:"button"}):this.onSearchOpenFocus()},onSearchInputKeyPress:function(){var e=this.$node.find(".js-search-input").val();return this._$searchButton.removeClass("is-disabled"),e&&this.oldValue&&e===this.oldValue||!e.trim()?!0:(this.oldValue=e,void this.showSuggest(e))},showSuggest:function(e){var t=e?{request:e}:{};ns.page.current.params.fid&&(t.fid=ns.page.current.params.fid);
var i=ns.router.generateUrl("search",t);ns.page.go(i)},toggleSearch:function(){var e=ns.page.current;if("search"===e.page)return void this.unfoldSearch();if("messages"!==e.page||"search"!==e.params.search||this.isCollectorSearch(e.params))this.foldSearch();else{if(e.params.ids)return;this.unfoldSearch()}},unfoldSearch:function(){var e=this.getModel("search-view");e.setFolded(!1)},headTabsRecalculate:function(){ns.events.trigger("head-tabs-recalculate"),setTimeout(function(){ns.events.trigger("head-tabs-recalculate")
},300)},foldSearch:function(){var e=this.getModel("search-view"),t=e.setFolded(!0);if(this._$searchButton){var i=this.isSearchPage()&&this.isCompactHeaderMode()&&!this.isCollectorSearch();this._$searchButton.toggleClass("is-active",i)}t&&this.headTabsRecalculate()},onChangeFolded:function(){var e=this.getModel("search-view");e.isFolded()?(this.$node.find(".js-search-input").blur(),this.$node.addClass("is-folded"),$(".mail-App-Header").removeClass("with-Search"),$(".js-mail-App").removeClass("mail-App-Search"),this._$searchButton.removeClass("is-disabled")):(this.$node.removeClass("is-folded"),$(".mail-App-Header").addClass("with-Search"),$(".js-mail-App").addClass("mail-App-Search"),this.$input.val()?this._$searchButton.removeClass("is-disabled"):this._$searchButton.addClass("is-disabled"),this._$searchButton.removeClass("is-active"),this.$node.find(".js-search-input").focus())
},onChangeCheckedCount:function(e,t){this.isCompactHeaderMode()&&t>0&&this.foldSearch()},onSearchOpenClick:function(e){if(e.preventDefault(),this.isSearchPage()&&!this.isCollectorSearch()){var t=this.getModel("search-view");if(t.isFolded())return this.unfoldSearch(),!1;if(Jane.c("Поиск","'Клик по 'найти'"),!this.$input.val())return this.$input.focus(),!1;this._startSearchLazy({force:!0,metrika:"btn"})}else this.openSearch()},onSearchOpenHotkey:function(){if(this.isSearchPage()){var e=this.getModel("search-view");
if(e.isFolded())return void this.unfoldSearch();this.$input.focus()}else this.openSearch()},onSearchOpenFocus:function(){if(this.isSearchPage()&&!this.isCollectorSearch()){this._$nbInput.$node.hasClass("_nb-is-focused")||this.$input.focus();var e=this.getModel("search-view");if(e.isFolded())return void this.unfoldSearch()}else this.openSearch()},openSearch:function(){var e=this.getInitialSearchParams();ns.Model.get("search-view").setSearchOptions(e);var t=ns.router.generateUrl("search",e);ns.page.go(t)
},getInitialSearchParams:function(){var e=ns.page.current.params;if("only_atta"===e.extra_cond&&"all"===e.goto)return{attaches:"yes"};if(Daria.messages.params4SimpleLabel(e))return{lid:e.current_label};var t=Daria.messages.params4SimplePath(e);if(t){var i=e.current_folder;if(Daria.IS_CORP)return{fid:i};var n=ns.Model.get("folders");if(!n.isFolder(i,["inbox"]))return{fid:i}}return{}},goToTheCorrectPageFromHistory:function(e){var t=ns.page.history.getFirstValidPrevious(function(t){return!e.test(t)}),i=t||ns.page.getDefaultUrl();
ns.page.go(i,"replace")},closeSearch:function(){return"search"!==ns.page.current.page&&this.isCompactHeaderMode()?void this.foldSearch():(this.goToTheCorrectPageFromHistory(/^#(search(-options)?(\?|$)|(contacts))/),void this.foldSearch())},onhtmlinit:function(){nb.init(this.$node),this._startSearchLazy=this._startSearch.lazy(10),this._$searchOptionsToggle=this.$node.find(".js-search-options-toggle"),this._$spinner=this.$node.find(".b-mail-icon_ajax-loader"),this._$searchButton=this.$node.find(".js-search-open"),this.$input=this.$node.find(".js-search-input:eq(0)"),this._$nbInput=nb.block(this.$node.find(".js-search-nb-input")[0]),this._onFocusBinded=this._onFocus.bind(this),this._onBlurBinded=this._onBlur.bind(this),this._onKeyDownBinded=this._onKeyDown.bind(this),this.onSearchNbInputChangedBinded=this.onSearchNbInputChanged.bind(this)
},onshow:function(e,t){this._bindEventListeners(),this._$nbInput.setValue(t.request),this._updateSearchSpinner(),Daria.SearchOptions.setAnchor(this._$searchOptionsToggle)},onrepaint:function(e,t){this.isCollectorSearch(t)||!t.request?this._$nbInput.setValue(""):""===this.$input.val().trim()&&this._$nbInput.setValue(t.request)},onhide:function(){this._unbindEventListeners(),this._startSearchLazy.reset(),clearTimeout(this.deferToggleActiveTimer),this._toggleSearchOptions(!1)},_startSearch:function(e){e=e||{},this._startSearchLazy.reset(),ns.Model.invalidate("history-suggest");
var t;e.hideOptions===!1?t=!0:(this._toggleSearchOptions(!1),t=!1);var i=this.$input.val();if(i||e.force){var n=this.getModel("search-view").getClearSearchOptions();n.request=i,Daria.MessagesSearch.search(n,{searchOptionsOpened:t,onCorrecting:function(e){ns.events.trigger("search:need-correcting-request",{corrected:e,old:n.request})}}),this._logSearch(i,e,n)}},_onStartSearch:function(e,t){this._startSearch(t)},_toggleSearchOptions:function(e,t){var i=Daria.SearchOptions;arguments.length||(e=!i.isOpened()),e?i.open():i.close(),e&&(arguments.length<2||t)&&this.$input.focus()
},_blurInput:function(){this.$input.blur()},_bindEventListeners:function(){this.$input.on("nb-focused",this._onFocusBinded),this.$input.on("focusin",this._onFocusBinded),this.$input.on("nb-blured",this._onBlurBinded),this.$input.on("focusout",this._onBlurBinded),this.$input.on("keydown",this._onKeyDownBinded),this._$nbInput.on("nb-changed",this.onSearchNbInputChangedBinded)},_unbindEventListeners:function(){this.$input.off("keydown"),this.$input.off("nb-focused",this._onFocusBinded),this.$input.off("focusin",this._onFocusBinded),this.$input.off("nb-blured",this._onBlurBinded),this.$input.off("focusout",this._onBlurBinded),this._$nbInput.off("nb-changed",this.onSearchNbInputChangedBinded)
},_onToggleSearchOptions:function(e,t){this._toggleSearchOptions(t)},_onToggleOptionsClick:function(e){nb.trigger("popup-close"),e.preventDefault(),e.stopPropagation(),this._toggleSearchOptions(),Jane.ErrorLog.send({type:"search.toggle-advanced",suid:Daria.suid,text:this.$input.val().trim(),action:Daria.SearchOptions.isOpened()?"open":"close",mail_type:this._getLogMailType()}),Jane.c("Поиск","Клик по расширенному поиску")},_preventAndStop:function(e){e.preventDefault(),e.stopPropagation()},_updateSearchSpinner:function(){this._$spinner.toggleClass("g-hidden",!Jane.watcher.get("search.state"))
},_onSearchOptionsOpen:function(){this._$searchOptionsToggle.addClass("is-active")},_onSearchOptionsClose:function(){this._$searchOptionsToggle.removeClass("is-active")},_onFocus:function(){ns.Model.get("focus").resetFocus(!0)},_onBlur:function(){},_onKeyDown:function(e){var t=Jane.Common.keyCode;switch(e.which){case t.TAB:Daria.SearchOptions.isOpened()&&(Daria.SearchOptions.setFocus(),e.preventDefault());break;case t.ESC:"search"===ns.page.current.params.search?this.$input.blur():this.closeSearch()
}},_getInputRightOffset:function(){if(!this.rightOffset){var e=this.$input;this.rightOffset=$("body").width()-e.offset().left-e.outerWidth()}return this.rightOffset},_onCorrectingRequest:function(e,t){var i=this.$input.val(),n=t.old||"";n.trim()===i.trim()&&this._$nbInput.setValue(t.corrected+(/\s$/.test(i)?" ":""))},_logSearch:function(e,t,i){var n;if(i.from){var s=i.from.substr(0,6),a=(i.to||"").substr(0,6);n=s!==a?s.substr(0,4):s}var o={type:"search.start-search",suid:Daria.suid,advanced:Daria.SearchOptions.isOpened(),action:t.metrika,text:e||"",message_type:i.type||"",folder:i.fid||"",label:i.lid||"",date:n||"",mail_type:this._getLogMailType(),searchid:Jane.watcher.get("search.next-id")};
o.searchid||(o.searchid=Daria.MessagesSearch.generateId()),isNaN(t.metrikaSlovo)||(o.slovo=t.metrikaSlovo),Jane.ErrorLog.send(o)},_getLogMailType:function(){var e;return e=Daria.Config.pddDomain?"pdd":Daria.email.isCorp()?"corp":"big"},isCompactMode:function(){var e=ns.Model.get("settings");return e.isCompactMode()},isCompactHeaderMode:function(){var e=ns.Model.get("settings");return e.isCompactHeaderMode()},isSearchPage:function(){var e=ns.page.current;return"search"===e.page||"search-options"===e.page||"search"===e.params.search
},isCollectorSearch:function(e){return e=e||ns.page.current.params,"rpopinfo"===e.scope}}}),ns.View.define("promo-default-mail",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-promo-default-mail-confirm":"onClickConfirm","click@show .js-promo-default-mail-refuse":"onClickRefuse"},ctor:function(){this.closeDebounce=_.debounce(this.close.bind(this),1e3),this.onCloseComplete=this.onCloseComplete.bind(this),this.onClickFeedbackSend=this.onClickFeedbackSend.bind(this)},yateModule:"mail",methods:{onShow:function(){Jane.Config.NO_SETTINGS||(nb.init(this.node),this.$node.removeClass("is-hidden"),this.modifyMailApp(!0))
},onHide:function(){nb.destroy(this.node)},modifyMailApp:function(e){$(".js-mail-App").toggleClass("mail-App_with_Promo-DefaultMail",e),ns.events.trigger("daria:vApp:changeRightColumSize")},onClickConfirm:function(){ns.Model.get("settings").setSettingOn("u2709"),this.$node.addClass("is-hidden"),this.modifyMailApp(!1),_.defer(function(){ns.events.trigger("daria:layout-changed"),$(window).trigger("resize")})},onClickRefuse:function(){this.onCloseComplete()},onClickFeedbackSend:function(e){var t=this.popup.$node.find(".js-promo-default-mail-textarea"),i=t.val();
i=i.trim(),i.length&&($(e.currentTarget).addClass("is-disabled"),t.addClass("is-disabled"),Jane.Services.load("#compose").then(this.onLoadDependSuccess.bind(this,i)))},onLoadDependSuccess:function(e){if(this.isVisible()){e=e+"\n\n----\nLogin: "+Daria.login+"\nBrowser: "+navigator.userAgent+"\nAddress: "+Daria.Config.userIP;var t=ns.Model.get("compose-message");t.setData({to:"mail@support.yandex.ru",subj:"[U2709] Причина отказа",send:e}),t.send({force:!0}).then(this.onFeedbackSendSuccess,this)}},onFeedbackSendSuccess:function(){this.isVisible()&&(this.popup.$node.addClass("is-send"),this.popup.setContent("Спасибо!"),Daria.Statusline.hide("message-sending"),this.closeDebounce())
},close:function(){this.$node.slideUp({complete:this.onCloseComplete})},onCloseComplete:function(){this.popup&&this.popup.destroy(),this.destroy(),window.location.href="/neo2/"}}}),ns.View.define("timeline-wrap",{events:{"ns-view-show":"onShow","ns-page-before-load@show":"onPageBeforeLoad","ns-page-after-load@show":"onPageAfterLoad"},models:{"timeline-state":!1,settings:{"ns-model-changed":!1,"ns-model-changed.timeline_enable":"onChangedTimelineEnableDebounce","ns-model-changed.timeline-is-open":"updateTimeline"}},yateModule:"mail",ctor:function(){this.onChangedTimelineEnableDebounce=_.debounce(this.onChangedTimelineEnable.bind(this),100)
},methods:{patchLayout:function(){var e=this.getModel("timeline-state"),t="layout-timeline-empty";return e.checkShowCollapsed()?(e.setIfChanged(".showState",e.SHOW_COLLAPSED),t="layout-timeline-collapsed"):e.checkShowPromo()?(e.setIfChanged(".showState",e.SHOW_PROMO),t="layout-timeline-promo"):e.checkShow()?(e.setIfChanged(".showState",e.SHOW_TIMELINE),t="layout-timeline"):e.setIfChanged(".showState",e.SHOW_EMPTY),t},onShow:function(){var e=this.getModel("timeline-state");this.prevCheckShow=_.constant(e.checkShow()||e.checkShowPromo())
},onPageBeforeLoad:function(){var e=this.getModel("timeline-state");this.prevCheckShow=_.constant(e.checkShow()||e.checkShowPromo())},onPageAfterLoad:function(){var e=this.getModel("timeline-state"),t=e.checkShow()||e.checkShowPromo();this.prevCheckShow()!==t&&this.updateTimeline()},updateTimeline:function(){this.update(null,{execFlag:ns.U.EXEC.PARALLEL})},onChangedTimelineEnable:function(){this.getModel("timeline-state").subscribeCalendar().fail(this.onErrorSubscribeCalendar,this).always(this.updateTimeline,this)
},onErrorSubscribeCalendar:function(){Daria.Statusline.showMsg({hideOnTimeout:!0,body:'Произошла ошибка в работе <a href="'+Daria.Config["timeline-yandex-host"]+'" target="_blank">Календаря</a>. Пожалуйста, воспользуйтесь <a href="'+Daria.Config["timeline-yandex-host"]+'" target="_blank">полной версией</a>.'})}}}),ns.View.define("timeline-common",{yateModule:"mail",ctor:function(){this._onChangedAsideSizeKind=this._onChangedAsideSizeKind.bind(this),this._onChangedMailLayoutClientRect=this._onChangedMailLayoutClientRect.bind(this)
},methods:{_commonInit:function(){var e=this.getModel("app-state"),t=this.getModel("timeline-state");this._onChangedMailLayoutClientRect(),this._onChangedAsideSizeKind(),t.setIfChanged(".height",this.$node.height()),e.on("ns-model-changed.asideSizeKind",this._onChangedAsideSizeKind),e.on("ns-model-changed.mailLayoutClientRect",this._onChangedMailLayoutClientRect)},_commonDestroy:function(){var e=this.getModel("app-state"),t=this.getModel("timeline-state");t.setIfChanged(".height",0),e.off("ns-model-changed.asideSizeKind",this._onChangedAsideSizeKind),e.off("ns-model-changed.mailLayoutClientRect",this._onChangedMailLayoutClientRect)
},_onChangedMailLayoutClientRect:function(){var e=this.getModel("app-state").get(".mailLayoutClientRect");this.$node.css({left:e.left,width:e.width})},_onChangedAsideSizeKind:function(){this.$node.removeClass("is-maximum is-middle is-minimum");var e=this.getModel("app-state").get(".asideSizeKind");switch(e){case"maximum":case"middle":case"minimum":this.$node.addClass("is-"+e)}}}}),ns.View.edefine("timeline-ng",{models:{"app-state":!1,"timeline-state":{"ns-model-changed":!1,"daria:mTimelineState:update":"onTimelineStateUpdate"}},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},yateModule:"mail",ctor:function(){this.super_.constructor.call(this),this.showMetrikaOnce=_.once(this.showMetrika.bind(this))
},methods:{onShow:function(){this._commonInit();var e=this.getModel("timeline-state");e.currentDateTick(),this.showMetrikaOnce()},onHide:function(){this._commonDestroy();var e=this.getModel("timeline-state");e.currentDateTickStop()},onTimelineStateUpdate:function(){this.isVisible()&&ns.page.lazyRefresh()},showMetrika:function(){this.getModel("timeline-state").metrika("Показ","полоска")}}},"timeline-common"),ns.View.edefine("timeline-promo",{models:{"app-state":!1,"timeline-state":!1},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-timeline-subscribe":"onClickSubscribe","click@show .js-timeline-promo-close":"onClickClose"},yateModule:"mail",ctor:function(){this.super_.constructor.call(this)
},methods:{onShow:function(){this.getModel("timeline-state").metrika("Показ","промка"),this._commonInit()},onHide:function(){this._commonDestroy()},onClickSubscribe:function(){this.getModel("timeline-state").metrika("Действия","включили через промку"),ns.Model.get("settings").setSettings({timeline_enable:!0})},onClickClose:function(){this.getModel("timeline-state").metrika("Действия","выключили через промку"),ns.Model.get("settings").setSettings({timeline_enable:!1})}}},"timeline-common"),function(){var e="mail-PromoMobileApp",t="promo-mobile-app-mixin",i=ns.View.infoLite(t);
ns.View.edefine("promo-mobile-app-common",{models:{"promo-mobile-app-state":"onStateChanged",userphones:!1},events:{"ns-view-show":"onShow","ns-view-htmlinit":"onHtmlInit","click .js-get-mobile-app-link":"sendMobileAppLink","click .js-promo-mobile-app-close-button":"closeView"},yateModule:"mail",params:function(){return{promo:"mobile-app-common"}},methods:{PROMO_MOBILE_APP_NAME:"mail-promo-inbox-popup-liza",PICTURE_PREFIX:"mail-Promo-MailAppLink",SHOW_CLOSE_BUTTON:!0,SHOW_FORM_FIELDS:!0,SHOW_IN_POPUP:!1,PROMO_TITLE:"Установите Яндекс.Почту <br/> в свой смартфон или планшет",PROMO_DESCRIPTION:"Или найдите Яндекс.Почту в Google Play или AppStore <br/> cо своего устройства.",SEND_BUTTON_TEXT:"Получить ссылку",SENDING_BUTTON_TEXT:"Отправляем",CUSTOM_CLASSES:"",METRIKA_DATA:null,SIZE_INTERVALS:[{className:e+"_big",from:890,to:Number.MAX_VALUE},{className:e+"_medium",from:796,to:890},{className:e+"_small",from:730,to:796},{className:e+"_extra-small",from:0,to:730}],onHtmlInit:function(){this.initPromoMobileAppMixin()
},onStateChanged:function(){i.methods.onStateChanged.apply(this,arguments),this.getState().isStrictEnterPhoneState()&&this.metrikaMarkAction("enterPhone")},applyPhoneNumberFormat:function(e){return this.cleanPhoneNumber(e)},metrikaMarkAction:function(e){if(!this.METRIKA_DATA||!this.METRIKA_DATA.prefix||!this.METRIKA_DATA.actions)throw new Error("Не правильно инициализированы данные для метрики");if(this.METRIKA_DATA.actions[e]!==!1&&void 0!==this.METRIKA_DATA.actions[e]){var t=[this.METRIKA_DATA.prefix,this.METRIKA_DATA.actions[e]].reduce(function(e,t){return _.isArray(t)?e.concat(t):(e.push(t),e)
},[]);Jane.c.apply(Jane,t)}},onShow:function(){this.metrikaMarkAction("show"),this.onShowAction()},onShowAction:function(){},closeView:function(){this.metrikaMarkAction("closeClick"),this.closeViewAction()},closeViewAction:function(){},_loadState:function(){var e=this.getState(),t=e.isEnterPhoneState(),i=e.isInvalidPhoneNumberState(),n=e.isSendingState(),s=e.isSendFailedState(),a=e.isSendSuccessState(),o=t&&e.canRetry(),r=i,l=s&&!e.canRetry(),c=!r&&s&&!l,d=r||c||l;this.$node.find(".js-buttons-send").toggleClass("is-hidden",!o),this.$node.find(".js-error-message-phone-number").toggleClass("is-hidden",!r),this.$node.find(".js-promo-mobile-app-desc").toggleClass("is-hidden",d),this.$node.find(".js-buttons-sending").toggleClass("is-hidden",!n),this.$node.find(".js-error-message-send-failed").toggleClass("is-hidden",!c),this.$node.find(".js-error-message-try-failed").toggleClass("is-hidden",!l),this.$node.find(".js-content-wrapper").toggleClass("is-hidden",a);
var u=this.$node.find(".js-send-success");u.toggleClass("is-hidden",!a),setTimeout(function(){u.toggleClass("is-invisible",!a)},100),(t||i)&&!this.nbPhoneNumber.getValue()&&this.SHOW_IN_POPUP&&_.defer(function(){this.nbPhoneNumber.focus()}.bind(this)),l&&this.onErrorCanNotRetry(),a&&(ns.Model.get("settings").setSettings({"promo-mobile_sms-send":!0,"promo-mobile_sms-send_date":Daria.now()}),this.metrikaMarkAction("sendSuccess"),this.onSendSuccess())},onSendSuccess:function(){},onErrorCanNotRetry:function(){},sendMobileAppLink:function(){this.metrikaMarkAction("sendClick");
var e=this.getState();if(!e.canTrySendAppLink()||!e.canRetry())return void(e.isInvalidPhoneNumberState()&&this.nbPhoneNumber.focus());var t=this._getPhoneNumber();if(!t||!Jane.FormValidation.checkPhoneNumber(t))return e.setInvalidPhoneNumberState(),void this.nbPhoneNumber.focus();e.startSending();var i={app:this.PROMO_MOBILE_APP_NAME,phone_full:t};ns.forcedRequest(["get-link-app"],i).then(function(t){setTimeout(function(){var i=t[0].getData();return i&&"ok"===i.result?void e.onSuccess():void e.onSendFailed()
},1e3)}).fail(function(){setTimeout(function(){e.onSendFailed()},1e3)})},onResize:function(){if(!this.$resizeNode)throw new Error("Не определена this.$resizeNode");var e=this.getSizeClass(this.$resizeNode);this.$resizeNode.hasClass(e)||(this.$node.removeClass(this.getAllSizeClasses().join(" ")),this.$node.addClass(e))},getAllSizeClasses:function(){return this.SIZE_INTERVALS.map(function(e){return e.className})},getSizeClass:function(e){var t=Number(e.outerWidth()||0);if("number"!=typeof t)return"";
var i="";return this.SIZE_INTERVALS.some(function(e){return e.from<t&&t<=e.to?(i=e.className,!0):!1}),i},getPicturePrefixName:function(){return this.PICTURE_PREFIX},canShowCloseButton:function(){return this.SHOW_CLOSE_BUTTON},inPopup:function(){return this.SHOW_IN_POPUP},canShowFormFields:function(){return this.SHOW_FORM_FIELDS},getPromoTitle:function(){return this.PROMO_TITLE},getPromoDescription:function(){return this.PROMO_DESCRIPTION},getSendButtonText:function(){return this.SEND_BUTTON_TEXT},getSendingButtonText:function(){return this.SENDING_BUTTON_TEXT
},getCustomClasses:function(){return this.CUSTOM_CLASSES}}},t,ns.View)}(),ns.View.define("timeline-collapsed",{models:{"app-state":{"ns-model-changed":!1,"ns-model-changed.mailLayoutClientRect":"onChangedMailLayoutClientRect"}},events:{"ns-view-show":"onShow"},yateModule:"mail",methods:{onShow:function(){this.onChangedMailLayoutClientRect()},onChangedMailLayoutClientRect:function(){if(this.isVisible()){var e=this.getModel("app-state").get(".mailLayoutClientRect");this.$node.css({left:e.left})}}}}),ns.View.define("timeline-date",{models:{"timeline-state":{"ns-model-changed":!1,"ns-model-changed.currentDate":"onChangedCurrentDate"}},events:{"click@show":"onClick"},yateModule:"mail",methods:{onClick:function(){var e=this.getModel("timeline-state");
e.metrika("Действия","клик на текущую дату"),e.shiftCurrentStartDate()},onChangedCurrentDate:function(){this.isVisible()&&this.$node.text(this.getLabel())},getLabel:function(){return Jane.Date.format("%Date_dm__dot",this.getModel("timeline-state").getCurrentDate())}}}),ns.View.define("timeline-back",{models:{"timeline-state":!1},events:{"click@show":"onClick"},yateModule:"mail",methods:{onClick:function(){this.getModel("timeline-state").shiftBackStartDate()}}}),ns.View.define("timeline-toggle",{models:{"timeline-state":!1,settings:{"ns-model-changed":!1,"ns-model-changed.timeline-is-open":"invalidate"}},events:{"click@show":"onClick"},yateModule:"mail",ctor:function(){this.onSuccessToggleSetting=this.onSuccessToggleSetting.bind(this)
},methods:{onClick:function(){var e=this.getModel("timeline-state").checkSettingTimelineIsOpen();this.getModel("settings").setSettings({"timeline-is-open":!e},this.onSuccessToggleSetting)},onSuccessToggleSetting:function(){var e=this.getModel("timeline-state");this.getModel("settings").isSet("timeline-is-open")?e.metrika("Действия","развернули полоску"):e.metrika("Действия","свернули полоску")}}}),ns.View.define("timeline-forward",{models:{"timeline-state":!1},events:{"click@show":"onClick"},yateModule:"mail",methods:{onClick:function(){this.getModel("timeline-state").shiftForwardStartDate()
}}}),ns.View.define("timeline-newevent",{models:{"timeline-state":!1},events:{"click@show":"onClick"},yateModule:"mail",methods:{onClick:function(){var e=this.getModel("timeline-state");e.metrika("Действия","клик на создать событие")}}}),ns.ViewCollection.define("timeline-list",{models:{"timeline-list":{"ns-model-changed":"forceUpdate","ns-model-remove":"onRemoveTimelineList","ns-model-insert":"keepValid"},"timeline-state":{"ns-model-changed":!1,"ns-model-changed.startOffset":"onChangedStartOffset"}},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-touch":"onTouch","daria:vApp:changeLeftColumWidth@show":"onResizeDebounce"},split:{byModel:"timeline-list",intoLayouts:_.constant("layout-timeline-item")},yateModule:"mail",ctor:function(){this.offsetCorrection=this.offsetCorrection.bind(this),this.offsetCorrectionOnce=_.once(this.offsetCorrection),this.onResizeDebounce=_.debounce(this.onResize.bind(this),50),this.toLoadMoreDebounce=_.debounce(this.toLoadMore.bind(this),50),this.onChangedStartOffsetDebounce=_.debounce(this.onChangedStartOffset.bind(this),50)
},methods:{onHtmlInit:function(){this.$content=this.$node.find(".js-content"),this.$scroller=this.$node.find(".js-scroller")},onShow:function(){this.updateDisplayedTimeInterval(),this.offsetCorrectionOnce()},onHide:function(){this.onResizeDebounce.cancel(),this.toLoadMoreDebounce.cancel(),this.onChangedStartOffsetDebounce.cancel()},onTouch:function(){this.offsetCorrectionOnce()},onResize:function(){this.updateDisplayedTimeInterval()},onRemoveTimelineList:function(e,t){this.keepValid();var i=this.getModel("timeline-state").get(".startDate"),n=_.some(t,function(e){return e.checkDateGtRange(i)
});n&&(this.offsetCorrectionOnce=_.once(this.offsetCorrection))},onChangedStartOffset:function(e,t,i,n,s){this.scrollOffset(!0,null,s).then(this.toLoadMore,this)},scrollOffset:function(e,t,i){t=t||this.getModel("timeline-state").get(".startOffset");var n=this.$content,s=this.getContentOffset(t.get());return i&&(i=this.getContentOffset(i.get()),n.stop(!0,!0).css({textIndent:-i,transform:"translate(-"+i+"em, 0)"})),new vow.Promise(function(t,i){e?n.stop(!0,!0).animate({textIndent:-s},{step:function(e){$(this).css("transform","translate("+e+"em, 0)")
},complete:t,fail:i}):(n.stop(!0,!1).css({textIndent:-s,transform:"translate(-"+s+"em, 0)"}),t())})},offsetCorrection:function(){this.scrollOffset().then(this.toLoadMore,this)},getContentOffset:function(e){var t=this.getModel("timeline-state"),i=this.$scroller.offset().left,n=parseFloat(this.$content.css("text-indent")||0);return Math.floor((e-i)/t.TIMELINE_HOUR_PIXEL_STEP-n)},updateDisplayedTimeInterval:function(){var e=this.$scroller.width();this.getModel("timeline-state").recalcShowedHours(e)},checkToLoadMore:function(){if(this._lockLoadMore||!this.isVisible())return!1;
var e=this.$content[0].getBoundingClientRect(),t=this.$scroller[0].getBoundingClientRect();if(!e||!t)return!1;var i=t.right+t.width*this.getModel("timeline-list").PRELOADED_VISIBLE_RANGES;return e.right<i?!0:!1},toLoadMore:function(){this.checkToLoadMore()&&(this._lockLoadMore=!0,this.getModel("timeline-list").loadMore().always(function(){this._lockLoadMore=!1},this))}}}),ns.View.define("timeline-list-item",{models:{"timeline-list-item":!1,"timeline-state":{"ns-model-changed":!1,"ns-model-changed.startDate":"onChangedStartDate","ns-model-changed.currentDate":"onChangedCurrentDate"}},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","ns-view-show":"onShow","click@show .js-item-hour":"onClickItemHour"},yateModule:"mail",ctor:function(){this.mapHourIterate=this.mapHourIterate.bind(this)
},methods:{patchTree:function(){var e=this.super_.patchTree.call(this);return e.startDay=Jane.Date.format("%F",this.getModel("timeline-list-item").get(".dateFrom")),e},onHtmlInit:function(){this.$hours=this.$node.find(".js-item-hour"),this.$current=this.$node.find(".js-current")},onHtmlDestroy:function(){delete this.$hours,delete this.$current},onShow:function(){this.updateStartOffset(),this.updateShowCurrentDate()},onClickItemHour:function(){this.getModel("timeline-state").metrika("Действия","клик на слот")
},onChangedStartDate:function(){this.isVisible()&&this.updateStartOffset()},onChangedCurrentDate:function(){this.isVisible()&&this.updateShowCurrentDate()},updateStartOffset:function(){var e=this.getModel("timeline-state"),t=this.getModel("timeline-list-item"),i=e.get(".startDate");t.checkDateInRange(i)&&e.setStartOffset(this.getOffset.bind(this,i.getHours()))},updateShowCurrentDate:function(){var e=this.getModel("timeline-state"),t=this.getModel("timeline-list-item"),i=e.getCurrentDate();if(this.$hours.removeClass("is-current"),this.$current.css("display","none"),t.checkDateInRange(i)){var n=i.getHours(),s=i.getMinutes();
this.$hours.eq(n).addClass("is-current"),this.$current.css({display:"block",left:n+s/60+"em"})}},getOffset:function(e){return this.$hours?this.$hours.eq(e).offset().left:0},getHours:function(){return _.range(24).map(this.mapHourIterate)},mapHourIterate:function(e){var t="";return t=0===e?Jane.Date.format("%Date_dm__dot",this.getModel("timeline-list-item").get(".dateFrom")):_.padLeft(e,2,"0")+":00",{hour:e,label:t}}}}),function(){var e=null,t=_.debounce(function(){e&&e.close()},500),i=_.debounce(function(){var e,t=function(e){return Boolean(e%2)
},i=function(e){return!t(e)},n=0;$(".js-timeline-event").each(function(s){var a=$(this);a.hasClass("is-notstarted")&&n++,e=n%2?i:t,a.toggleClass("is-grey",e(s))})},50);ns.View.define("timeline-events",{models:{"timeline-state":!1,"timeline-list-item":!1,"get-user-events":"forceUpdate"},events:{"ns-view-show":"onShow","mouseenter@show .js-timeline-event":"showTooltip","mouseleave@show .js-timeline-event":"hideTooltip","click@show .js-timeline-event":"onClickEvent"},yateModule:"mail",paramsRewrite:function(e){return{from:e.df.split("T")[0],to:e.dt.split("T")[0]}
},ctor:function(){this.onDestroyedTooltip=this.onDestroyedTooltip.bind(this),this.onClosedTooltip=this.onClosedTooltip.bind(this),this.onOpenedTooltip=this.onOpenedTooltip.bind(this),this.onClickEventEdit=this.onClickEventEdit.bind(this),this.onScroll=this.onScroll.bind(this)},methods:{onShow:function(){i()},showTooltip:function(i){t.cancel(),e&&(e.destroy(),e=null);var n=$(i.currentTarget),s=Number(n.attr("data-event-index")),a=this.getModel("get-user-events").select(".ranges["+s+"]")[0];if(a){e=nb.block(ns.renderNode(a,"js-timeline-events-tooltip","mail")),e.on("nb-destroyed",this.onDestroyedTooltip),e.on("nb-opened",this.onOpenedTooltip),e.on("nb-closed",this.onClosedTooltip),e.$node.on("mouseenter",t.cancel).on("mouseleave",t).on("click",".js-timeline-event-edit",this.onClickEventEdit);
var o=n.offset().top-i.pageY;o=String(o>=0?"+"+o:o),e.open({withoutTail:!1,autofocus:!1,how:{my:"center bottom"+o,at:"center top",collision:"fit none"},where:i})}},hideTooltip:function(){t()},onClickEvent:function(){this.getModel("timeline-state").metrika("Действия","клик на слот")},onDestroyedTooltip:function(){ns.events.off("daria:vScrollerMessages:scroll",this.onScroll),ns.events.off("daria:layout-changed",this.onScroll),e=null},onOpenedTooltip:function(){ns.events.on("daria:vScrollerMessages:scroll",this.onScroll),ns.events.on("daria:layout-changed",this.onScroll),this.getModel("timeline-state").metrika("Показ","превьюшка встречи")
},onClickEventEdit:function(){this.getModel("timeline-state").metrika("Действия",'клик на "редактировать" в попапе')},onClosedTooltip:function(e,t){t.destroy()},onScroll:function(){if(e){var t=_.get(e,"node.widget");t&&t._position()}}}})}(),ns.View.define("themes-selector",{models:{themes:"keepValid",settings:{"ns-model-changed":"keepValid","ns-model-changed.color_scheme":"invalidate","daria:vWelcomeWizardThemeStep:setTheme":"onSetTheme"}},params:function(e){return e},events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","click .js-close":"onCloseClick","click .js-themes-overlay":"onThemesOverlayClick","Daria:vThemesSelector:close":"closePopup","mouseenter .js-theme":"onThemeThumbFocus","mousedown .js-theme":"onThemeThumbClick","wheel .js-themes-list":"onMouseWheel","click .js-themes-content":"stopPropagation","scroll .js-themes-list":"notifyListScroll","daria:vThemeColorfulSelector:scope-changed@show":"_metrikaCountThemeChange","daria:vThemeWeatherSettings:weather-city-changed@show":"_metrikaCountThemeChange","daria:vThemeSeasonsSelector:scope-changed@show":"_metrikaCountThemeChange"},yateModule:"mail",methods:{CONTENT_TRANSITION_SAFE_DELAY:350,SETTINGS_TRANSITION_SAFE_DELAY:250,_wasHidden:!0,onHtmlInit:function(){this.$list=this.$node.find(".js-themes-list"),this.setListScrollTop()
},onShow:function(){return this._closeInProgress?void 0:(this.isInWelcomeWizard()||$.Shortcuts.modalListOn("themes-selector"),this._wasHidden&&this._metrikaCount(["открытие"]),this._wasHidden?(this._wasHidden=!1,vow.Promise.resolve().then(this._scrollIntoView.bind(this,!0)).then(this._showContent,this)):vow.Promise.resolve().then(this._showContent,this).then(this._scrollIntoView,this))},onCloseClick:function(){this.closePopup(),this._metrikaCount(["крестик"])},onThemesOverlayClick:function(){this.closePopup(),this._metrikaCount(["закрытие по клику вне попапа"])
},isInWelcomeWizard:function(){return Boolean(this.params.wizard)},setListScrollTop:function(){this.$list.scrollTop(this._listScrollTop||this._howToScrollIntoView())},_howToScrollIntoView:function(){if(this.$node){var e=this.$node.find(".is-active");if(e.length){var t=16,i=this.$list.scrollTop(),n=e.position().top,s=n+e.height(),a=this.$list.outerHeight(),o=i;return s>a?o+=s-a+t:0>n&&(o+=n-t),o}}},_showContent:function(){return new vow.Promise(function(e){if(this.isInWelcomeWizard())return e();var t=this.$node.find(".js-themes-content");
t.one("transitionend",e),_.delay(e,this.CONTENT_TRANSITION_SAFE_DELAY),_.delay(function(){$("html").addClass("with-ThemeOverlay")},50)}.bind(this))},_scrollIntoView:function(e){return new vow.Promise(function(t){if(this._listWasScrolled)return t();var i=this._howToScrollIntoView();this._saveListScrollTop(i),e?(this.$list.scrollTop(i),t()):this.$list.animate({scrollTop:i},i,t)}.bind(this))},_saveListScrollTop:function(e){this._listWasScrolled=!1,this._listScrollTop=e||this.$list.scrollTop()},onSetTheme:function(e,t){return this._setThemeById(t)
},onThemeThumbClick:function(e){var t=$(e.currentTarget);if(!t.hasClass("is-active")){this._metrikaCountThemeChange();var i=t.data("id");return this._setThemeById(i)}},_setThemeById:function(e){return this._saveListScrollTop(),this._lastLoadingThemeId=e,this._currentLoadingTheme=this._currentLoadingTheme||vow.Promise.resolve(),this._currentLoadingTheme.then(function(){return vow.Promise.all([this._setTheme(e),this._runTheme(e),this._hideSettings(Daria.themeId).then(function(){return this._isActualTheme(e)?(Daria.themeId=e,this.$node&&(this.$node.find(".is-active").removeClass("is-active"),this.$node.find('[data-id="'+e+'"]').addClass("is-active")),this._showSettings(e)):void 0
},this)])},this).then(function(){return this._isActualTheme(e)?(ns.events.trigger("daria:vThemesSelector:new-schema"),ns.page.go().then(function(){this._scrollIntoView(),this._lastLoadingThemeId=null,this._currentLoadingTheme=null},this)):void 0},this)},_setTheme:function(e){return ns.Model.get("settings").setSettings({color_scheme:e})},_runTheme:function(e){return new vow.Promise(function(t){Jane.Services.runModules(["theme-"+e+".css"],t)})},_loadTheme:function(e){return new vow.Promise(function(t){Jane.Services.loadModules(["theme-"+e+".css"],t)
})},_hideSettings:function(e){return new vow.Promise(function(t){if(!this.$node)return t();var i=this.$node.find(".is-active"),n=i.data("id"),s=ns.Model.get("themes").hasSettings(e);return n===e&&s?(_.delay(t,this.SETTINGS_TRANSITION_SAFE_DELAY),this._trySwitchSettings(),i.one("transitionend",t),void i.removeClass("has-settings")):t()}.bind(this))},_trySwitchSettings:function(){var e=this.$node.find(".is-active"),t=this.$node.find('[data-id="'+this._lastLoadingThemeId+'"]'),i=ns.Model.get("themes").hasSettings(this._lastLoadingThemeId),n=e.offset().top===t.offset().top,s=i&&n,a=t.data("index")-e.data("index");
s&&e.addClass("switch-settings switch-settings-"+a)},_showSettings:function(e){return new vow.Promise(function(t){if(!this.$node)return t();var i=this.$node.find(".is-active"),n=i.data("id");return n===e&&ns.Model.get("themes").hasSettings(e)?(_.delay(t,this.SETTINGS_TRANSITION_SAFE_DELAY),i.one("transitionend",t),void i.addClass("has-settings")):t()}.bind(this))},_isActualTheme:function(e){return!this._lastLoadingThemeId||this._lastLoadingThemeId===e},onMouseWheel:function(){this._listWasScrolled=!0,this._listScrollTop=this.$list.scrollTop()
},closePopup:function(){return this._closeInProgress=!0,$.Shortcuts.modalListOff("themes-selector"),vow.Promise.resolve().then(this._hideContent,this).then(function(){return ns.Model.get("themes-selector").close(),this._closeInProgress=!1,ns.page.go()},this)},_hideContent:function(){return new vow.Promise(function(e){if(this.isInWelcomeWizard())return e();this._saveListScrollTop(),this._wasHidden=!0;var t=this.$node.find(".js-themes-content");t.one("transitionend",e),_.delay(e,this.CONTENT_TRANSITION_SAFE_DELAY),$("html").removeClass("with-ThemeOverlay")
}.bind(this))},onThemeThumbFocus:function(e){var t=$(e.currentTarget),i=t.data("id");return this._loadTheme(i)},getThumbName:function(e){if(e=yr.nodeset2scalar(e),"seasons"===e){var t=ns.Model.get("theme-seasons").getSeason();return"@theme-thumb-"+e+"-"+t}return"@theme-thumb-"+e},stopPropagation:function(e){e.stopPropagation()},notifyListScroll:function(){ns.events.trigger("daria:vThemesSelector:themes-list-scroll")},_metrikaCount:function(e){if(!this.isInWelcomeWizard()){var t=["Выпадушка тем"];
Jane.c(t.concat(e))}},_metrikaCountThemeChange:function(){this._metrikaCount(["выбор темы"])}}}),ns.View.define("user-dropdown",{models:{"user-dropdown-data":!0,settings:!1},events:{"ns-view-show":"onShow","click a":"onLinkClick","click .js-user-dropdown-promo-click":"onPromoClick","click .js-user-dropdown-promo-close":"onPromoClose"},yateModule:"mail",methods:{open:function(e){this.updateByLayout("user-dropdown",{execFlag:ns.U.EXEC.PARALLEL}).then(function(){this.nbPopup=nb.block(this.node),this.nbPopup.open(e),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.destroy()})},onShow:function(){ns.Model.get("head-user-state").setNewLettersInMA(!1),ns.forcedRequest("do-mail-reset-recent-counter"),this._metriks();var e=this.$node.find(".js-user-dropdown-promo");e.length&&!e.children().length&&(e.html(Jane.tt("mail:js-user-dropdown-promo")),this._metriks("Показы промо"));var t=this.getModel("user-dropdown-data").getSumOfFresh();
t&&(11>t?this._metriks("Количество писем",String(t)):51>t?this._metriks("Количество писем","11-50"):101>t?this._metriks("Количество писем","51-100"):this._metriks("Количество писем","более 100"))},onLinkClick:function(e){var t=$(e.currentTarget),i=(t.data("metric")||"").trim().split(":");return i.length&&this._metriks.apply(this,i),!0},onPromoClick:function(e){e.preventDefault(),e.stopPropagation(),this.getModel("settings").setSettingOn("user_dropdown_promo",function(){var t=$(e.currentTarget).attr("href");
window.location.replace(t)})},onPromoClose:function(){return this.getModel("settings").setSettingOn("user_dropdown_promo"),this.$node.find(".js-user-dropdown-promo").addClass("g-hidden"),this.$node.find(".js-dropdown-users-list").removeClass("g-hidden"),this.$node.find(".js-mail-dropdown__item-user-add").removeClass("g-hidden"),!1},_metriks:function(){var e=["Залогиновая шапка. Правая часть","Меню за логином","Клик"];if(arguments.length){var t=this.getModel("user-dropdown-data").getSumOfFresh();e.push(t?"Есть новые письма":"Нет новых писем"),Array.prototype.push.apply(e,Array.prototype.slice.call(arguments,0))
}Jane.c(e)}}}),function(){function e(){console&&_.isFunction(console.error)&&console.error("Это абстрактный метод. Он должен быть перегружен в производном классе.")}ns.View.define("message-actions",{methods:{_replyHelper:function(e,t){t=t?_.clone(t):{},t.mMessagesChecked||(t.mMessagesChecked=this.getMessagesCheckedInstance(!0));var i=_.last(e.split(":"));ns.action.run(i,t)},_onDrop:function(e,t){var i;switch(t.operation){case"label":case"unlabel":case"mark":case"unmark":case"move":case"remove":case"tospam":case"notspam":case"reply":case"reply-all":case"forward":var n=t.operation.split("-").map(function(e){return Daria.capitalize(e)
}).join("");i="_on"+n+"ToolbarButton";break;case"messages.deselect":i="_onDeselect";break;default:return console.error("Метку бросили, но непонятно что с ней делать. Не определено поле params.operation"),!1}i&&_.isFunction(this[i])&&(t.params=t.params||{},t.params._source="dnd",this[i](e,t.params))},_onLabelToolbarButton:e,_onUnlabelToolbarButton:e,_onMarkToolbarButton:e,_onUnmarkToolbarButton:e,_onMoveToolbarButton:e,_onRemoveToolbarButton:e,_onTospamToolbarButton:e,_onNotspamToolbarButton:e,_onDeselect:e,_onReplyToolbarButton:function(e,t){this._replyHelper("reply",t)
},_onReplyAllToolbarButton:function(e,t){this._replyHelper("reply-all",t)},_onForwardToolbarButton:function(e,t){Jane.ToolbarMetric.messageToolbar("переслать"),this._replyHelper("forward",t)},getMessagesCheckedInstance:function(){return ns.Model.get("messages-checked")},showQuickReply:function(e){ns.page.go(ns.router.generateUrl("compose2",{ids:this.params.ids,oper:e?"reply-all":"reply"}))}}})}(),ns.View.define("messages-direct",{events:{"ns-page-after-load@show":"showDirect","yabs:loaded@init":"showDirect","daria:vThemesSelector:new-schema@init":"showDirect"},yateModule:"mail",methods:{_getDirectNode:function(){return this._directNode||(this._directNode=$("#js-messages-direct")),this._directNode
},showDirect:function(){if(!Jane.Config.HAS_DIRECT)return void $(this.node.firstChild).addClass("is-hidden");if(Daria.yabs){var e=this._getDirectNode();$(this.node.firstChild).removeClass("is-hidden").prepend(e),Daria.yabs.showDirect("js-messages-direct","inbox")}this.addPaddingForSetup()},addPaddingForSetup:function(){var e=/^setup/.test(ns.page.current.page)&&ns.Model.get("settings").isCompactMode();this.$node.toggleClass("mail-DirectLine_setup",e)}}}),ns.View.define("setup-avatar",{models:{settings:!1,"account-information":!1},ctor:function(){this.SRC=Daria.Config["user-pic-domain"]+Daria.uid+"/normal/mail/"
},events:{"daria:vSetupAvatar:remove@show":"_remove","ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},yateModule:"mail",methods:{onHtmlInit:function(){this.$node.find(".js-avatar-remove").on("click",this._onClickAvatarRemove.bind(this)),this.$node.find('input[name="file"]').on("click",this._onClickAvatarUpload.bind(this)),this.$node.find('input[name="file"]').on("change",this._onChangeAvatarUpload.bind(this))},onHtmlDestroy:function(){this.$node.find(".js-avatar-remove").off("click",this._onClickAvatarRemove),this.$node.find('input[name="file"]').off("click",this._onClickAvatarUpload),this.$node.find('input[name="file"]').off("change",this._onChangeAvatarUpload)
},_onChangeAvatarUpload:function(e){var t=this;Daria.upicUploader.upload(e.currentTarget,function(){t._change(),Daria.Dialog.close(),$(document).trigger("b-mail-dropdown-closeall")})},_onClickAvatarUpload:function(e){var t=$(e.currentTarget),i=t.closest(".js-avatar-load-file");this.sendMetrika(i)},_onClickAvatarRemove:function(e){e.preventDefault();var t=this,i=$(e.currentTarget);this.sendMetrika(i),Daria.Dialog.confirm({body:"<p>Вы действительно хотите удалить портрет? Портрет удалится и на всех уже отправленных письмах.</p>",width:350,okValue:"Удалить",okHandler:function(){Daria.upicUploader.upload(null,function(){t._remove()
})}})},sendMetrika:function(e){var t=e.attr("data-metrika");t&&Jane.c(t.trim().split(":"))},_remove:function(){var e=this,t=this.SRC+"404?"+Math.round(1e5*Math.random()),i=this.SRC+"?"+Math.round(1e5*Math.random()),n=new Image;n.onload=function(){e.$node.find(".js-avatar-img").attr("src",t),$(".js-user-picture").css("background-image","url("+t+")"),ns.events.trigger("setup-avatar-remove",t)},n.onerror=function(){e.$node.find(".js-avatar-img").parent().addClass("b-userpic-choose_no-photo_yes"),e.$node.find(".js-avatar-changer").addClass("g-hidden"),$(".js-user-picture").css("background-image","url("+i+")"),ns.events.trigger("setup-avatar-remove",i)
},n.src=t},_change:function(){var e=this.SRC+"?"+Math.round(1e5*Math.random());this.$node.find(".js-avatar-img").attr("src",e).parent().removeClass("b-userpic-choose_no-photo_yes"),this.$node.find(".js-avatar-changer").removeClass("g-hidden"),$(".js-user-picture").css("background-image","url("+e+")"),ns.events.trigger("setup-avatar-change",e)}}}),ns.View.define("contact-actions",{params:function(e){var t=ns.Model.get("message-body",{ids:e.ids}),i=t.get('.info.field[.email=="'+e.email+'"]')[0];return{ref:i.ref,ids:e.ids,email:e.email,emails:e.email}
},models:{"message-body":!1,"account-information":!1,"abook-contacts":!1,"email-info":!1},events:{"ns-view-show":"_onNsViewShow","ns-view-hide":"_onNsViewHide","daria:ContactActions:write-letter@show":"_onWriteLetter","daria:ContactActions:add-contact@show":"_onAddContact","daria:ContactActions:add-blacklist@show":"_onAddBlacklist"},yateModule:"mail",methods:{patchTree:function(){var e=this.super_.patchTree.call(this);return e.menuItems=this._getMenuItems(),e},_getContact:function(){return this.getModel("message-body").get('.info.field[.email=="'+this.params.email+'"]')[0]||{}
},_getAbookContact:function(){return this.getModel("abook-contacts").getContactDataByEmail(this.params.email)||{}},_onNsViewShow:function(){var e=this.$node.find(".js-clipboard");if(e.length){var t=this.params.email;this._clip=new Daria.Clipboard(e,{hoverClass:"mail-ContactMenu-Item_hover"}),this._clip.on("ready",function(){this.setText(t)})}},_onNsViewHide:function(){this._clip&&(this._clip.destroy(),delete this._clip)},_getMenuItems:function(){var e=this.getModel("account-information").isMyEmail(this.params.email.toLowerCase()),t=[];
t.push({content:this.params.email,"class":["mail-ContactMenu-Item_selectonly"],attrs:{"data-noclose":"1"}},{separator:!0}),e||t.push({content:"Написать письмо",attrs:{href:ns.router.generateUrl("compose2",{to:this.params.email})}});var i=this.getModel("email-info").getData();return Daria.IS_CORP&&"staff"===i.type&&!i.staff._error&&t.push({content:"Перейти на Стафф",attrs:{href:_.result(_.find(i.staff.services,"type","staff"),"url"),target:"_blank",rel:"noopener noreferrer"}}),t.push({content:"Скопировать адрес","class":[Daria.Clipboard.canUse?"js-clipboard":"mail-ContactMenu-Item_disabled"]}),e||(this._getAbookContact().cid||t.push({content:"Добавить в контакты",attrs:{"data-action":"add-contact"}}),t.push({content:"В чёрный список",attrs:{"data-action":"add-blacklist"}})),t
},_onWriteLetter:function(){var e,t=this._getContact();e=t.name?t.name===this.params.email?this.params.email:'"'+t.name+'" <'+this.params.email+">":this.params.email,ns.action.run("compose.go",{to:e,counter:"71053"})},_onAddContact:function(){var e=this._getContact();ns.action.run("message.add-contact",{email:this.params.email,name:e.name,counter:"71054"})},_onAddBlacklist:function(){ns.action.run("message.lists-add-from-message",{listtype:"black",email:this.params.email,counter:"71055"})}}});var o=!1,r=!0;
ns.View.define("context-menu-mixin-base",{methods:{_cmBaseBindMenuableElements:function(e){var t=ns.Model.get("settings");r=!t.getSetting("contextmenu_disable"),o||(o=!0);var i=e.$node;this.__$bindedNode=i,this.__mMessagesChecked=e.mMessagesChecked,i.on("mousedown.context-menu",e.selector,this.__cmBaseOnMouseDown.bind(this)).on("contextmenu.context-menu",e.selector,this.__cmBaseOnContextMenu.bind(this))},_cmBaseUnbindMenuableElements:function(){this.__$bindedNode&&(this.__$bindedNode.off(".context-menu"),this.__$bindedNode=null)
},__cmBaseOnMouseDown:function(e){r&&2===e.button&&$(e.currentTarget).addClass("no-user-select")},__cmBaseOnContextMenu:function(e){r&&(e.stopPropagation(),e.preventDefault(),this.__showContextMenu(e))}}}),ns.View.edefine("context-menu-mixin-messages",{methods:{__showContextMenu:function(e){$(e.currentTarget).closest(".js-messages-item-checkbox-controller").hasClass("is-checked")||ns.events.trigger("daria:vMessages:deselect");var t=this.__cmMessagesPrepareToShowMenu(e);t.show({x:e.pageX,y:e.pageY,$scrollContainer:Daria.is3pane()?$(".b-layout__inner_type_messages:visible"):null}),$(".js-messages-scroll-area").one("scroll",function(){Daria.ContextMenu.close()
})},__cmMessagesPrepareToShowMenu:function(e){var t=this;Jane.watcher.set("messages-context-menu:opened",!0),clearTimeout(this.__deferredCloseTimeout),this.__preventDeselect=!1,this.__$onMessage=$(e.currentTarget);var i=this.__isThread=this.__$onMessage.hasClass("js-thread");this.__originalMid=this.__$onMessage.data("id");var n=this.__originalMid;/^t/.test(n)&&(n=n.substr(1)),this.__mid=n,Daria.is3pane()&&this.__toggleMessagesSelectionSuppression(!0);var s=!1,a=this.__mMessagesChecked.getIds();if(a.tids.length+a.ids.length>0?(!i&&!_.contains(a.ids,n)||i&&!_.contains(a.tids,n))&&(s=!0):s=!0,s){this.__isNeedDeselect=!0;
var o=ns.Model.get("messages-checked");o.check(ns.Model.get("message",{ids:this.__originalMid}),!0)}var r=new Daria.ContextMenu({items:this.__getContextMenuItems(),metrika:"Письма",onClose:function(){Jane.watcher.set("messages-context-menu:opened",!1),t.__toggleMessagesSelectionSuppression(!1),Daria.is3pane()&&s&&(t.__deferredCloseTimeout=_.defer(function(){t.__preventDeselect||(t.__preventDeselect=!1)}))}});return r},__toggleMessagesSelectionSuppression:function(e){Jane.watcher.set("Daria:vMessagesSelection.dontChangeViewToBatchOperation",e)
},__getContextMenuItems:function(){var e,t=this,i=this.__extractButtonsFromToolbar(),n=this.__getFolders(),s=[],a=ns.page.current.params.current_folder;a&&(e=ns.Model.get("folders").getFolderById(a).symbol);var o=this.__mMessagesChecked.getIds();if(!this.__mMessagesChecked.isFolderSelected()){s.push({type:"separator",index:8.9});var r=0,l=n.map(function(e){return{id:e.fid,text:e.name,alt:e.name,isActive:!e.isCurrent,addClass:e.isCurrent?"is-current":"",style:"padding-left:"+(e.level+2)+"em",index:r++,metrika:"Переложить в папку",onClick:function(){ns.action.run("move",{fid:e.fid})
}}});if(l.push({type:"separator",index:998.9}),l.push({text:"Новая папка…",index:999,metrika:"Новая папка",onClick:function(){t.__preventDeselect=!0,ns.action.run("folders.add",{contextMenu:!0,isNeedDeselect:t.__isNeedDeselect})}}),s.push({text:"Переложить в папку",icon:"move",index:9,metrika:"Переложить в папку",items:l}),!_.contains(["trash","spam"],e)){var c=this.__getLabels(),d=this.__processLabels(c.label,"label",0),u=this.__processLabels(c.unLabel,"unlabel",500);d.push({type:"separator",index:998.9}),d.push({text:"Новая метка…",index:999,metrika:"Создать метку",onClick:function(){t.__preventDeselect=!0,ns.action.run("labels.add",{contextMenu:!0,isNeedDeselect:t.__isNeedDeselect})
}});var h=d;u.length&&(h.push({type:"separator",index:489},{text:"Снять метку:",index:490,isActive:!1}),h.push.apply(h,u)),s.push({text:"Поставить метку",icon:"label",index:10,items:h})}s.push({type:"separator",index:10.1});var m=o.ids.length+o.tids.length;if((1===m||0===o.ids.length&&1===o.tids.length&&this.__isThread)&&(s.push({text:"Открыть в новой вкладке",index:1,metrika:"Открыть в новом окне",onClick:function(){var e,i=t.__$onMessage;e=i.find(t.__isThread?".b-messages__thread-count":".js-message-snippet"),window.open(e.attr("href"))
}}),s.push({type:"separator",index:1.1})),0===o.tids.length&&1===o.ids.length){var g=this.__$onMessage.find('A[href*="print.jsx"]');g.length&&s.push({text:"Печать",index:100,metrika:"Печать",onClick:function(){window.open(g.attr("href"))}})}}var p=ns.Model.get("message",{ids:this.__originalMid});if(1===o.tids.length&&0===o.ids.length||0===o.tids.length&&1===o.ids.length){var f=p.get(".fid"),v=ns.Model.get("folders").getFolderById(f).symbol;_.contains(["outbox","template","draft"],v)||s.push({text:"Настроить фильтр",index:14,metrika:"Настроить фильтр",onClick:function(){ns.page.go(ns.router.generateUrl("setup",{tab:"filters-create",message:t.__$onMessage.attr("data-id")}))
}})}return s.push.apply(s,i),s},__processLabels:function(e,t,i){var n=ns.Model.get("labels"),s=n.getImportantLID(),a=i,o=this;return e.map(function(e){var r,l=n.getLabelById(e),c=e===s;r=c?{type:"important"}:{color:l.color};var d="label"===t?"Поставить метку":"Снять метку";return{id:e,text:l.name,alt:l.name,index:c?a-1:++i,customIcon:yr.run("mail",r,"context-menu-label-custom-icon"),metrika:d,onClick:function(){o._onToolbarButton(t,{lid:e})}}})},__extractButtonsFromToolbar:function(){function e(){this._triggerAction&&(t._onToolbarButton(this._triggerAction,{},{refreshImmediately:!0}),ns.events.trigger("daria:vMessages:deselect"))
}var t=this,i={"delete":{text:"Удалить",icon:"delete",index:2,metrika:"Удалить",onClick:e,_triggerAction:"remove"},reply:{text:"Ответить",icon:"reply",index:3,metrika:"Ответить всем",onClick:this.__onReplyClick.bind(this)},"draft-finish":{text:"Дописать",icon:"draft-finish",index:3,metrika:"Дописать",onClick:function(){var e=t.__$onMessage.attr("data-id");ns.page.go(ns.router.generateUrl("compose2",{ids:e}))}},forward:{text:"Переслать",icon:"forward",index:4,metrika:"Переслать",onClick:function(){var e={};
e.mMessagesChecked=ns.Model.get("messages-checked"),ns.action.run("forward",e)}},"mark-as-read":{text:"Прочитано",icon:"mark-as-read",index:5,metrika:"Прочитано",onClick:e,_triggerAction:"mark"},"mark-as-unread":{text:"Не прочитано",icon:"mark-as-unread",index:5,metrika:"Не прочитано",onClick:e,_triggerAction:"unmark"},spam:{text:"Спам",icon:"spam",index:6,metrika:"Спам",onClick:e,_triggerAction:"tospam"},notspam:{text:"Не спам!",icon:"unspam",index:6,metrika:"Не спам",onClick:e,_triggerAction:"notspam"},archive:{text:"Архив",icon:"archive",index:7,metrika:"Архив",onClick:function(){Daria.MOPS.archive(t.__mMessagesChecked).then(function(){t.__mMessagesChecked.resetChecked()
})}}},n=[];return this.__getButtonsIds().forEach(function(e){e in i&&n.push(i[e])}),n},__getButtonsIds:function(){var e=ns.Model.get("folders"),t=null;ns.page.current.params.current_folder&&(t=e.getFolderById(ns.page.current.params.current_folder).symbol);var i=this.__mMessagesChecked.isFolderSelected(),n=["delete"];i||"template"===t||n.push("forward");var s=this.__mMessagesChecked.getIds(),a=!i&&s.ids.concat(s.tids).some(function(t){var i=ns.Model.get("message",{ids:t});if(!i.hasRealData())return!1;
var n=e.getFolderById(i.get(".fid")).symbol;return!_.contains(["spam","template","draft","outbox","sent"],n)});a?n.push("spam"):"spam"===t&&n.push("notspam"),"archive"!==t&&n.push("archive"),i?e.getFolderById(ns.page.current.params.current_folder)["new"]>0&&n.push("mark-as-read"):"template"!==t&&n.push(this.__hasUnreadMessages()?"mark-as-read":"mark-as-unread");var o=!1;if(1===s.ids.length){var r=ns.Model.get("message",{ids:s.ids[0]});if(!r.hasRealData())return!1;var l=e.getFolderById(r.get(".fid")).symbol;
o=_.contains(["draft"],l)}return(1===s.ids.length&&0===s.tids.length||0===s.ids.length&&1===s.tids.length)&&!o&&n.push("reply"),o&&n.push("draft-finish"),n},__getFolders:function(){var e,t,i=ns.Model.get("folders"),n=this.__mMessagesChecked.getIds(),s=n.ids.concat(n.tids).some(function(t){var i=ns.Model.get("message",{ids:t});if(i.isThread())return!0;if(i){var n=i.get(".fid");if(e&&e!==n)return!0;e=n}});s||(t=e);var a=i.getHierarchyStructure(function(e){return!_.contains(["outbox"],e.symbol)&&"1000"!==e.fid
});return this.__processItems(a,t)},__processItems:function(e,t,i,n){var s=this;return n=n||[],i=i||0,e.forEach(function(e){n.push({name:e.name,fid:e.fid,isSystem:Boolean(!e.user||e.symbol),isCurrent:e.fid===t,level:i}),e.items&&s.__processItems(e.items,t,i+1,n)}),n},__getLabels:function(){var e=this.__getUserLabelHash(),t=[],i=[];return e.labels.forEach(function(n){n.count!==e.count&&t.push(n.lid),n.count&&i.push(n.lid)}),{label:t,unLabel:i}},__getUserLabelHash:function(){var e=[],t={},i=ns.Model.get("labels"),n=i.getImportantLID(),s=ns.Model.get("settings").getSetting("label_sort");
i.data.label.forEach(function(i){if(i.user||i.lid===n){var s={name:i.name,lid:i.lid,count:0,allCount:i.count};t[i.lid]=s,e.push(s)}}),e="by_count"===s?e.sort(function(e,t){return t.allCount-e.allCount}):_.sortBy(e,"name");var a=this.__mMessagesChecked.getCount(),o=this.__mMessagesChecked.getLabels();return _.forEach(o,function(e,i){t[i]&&(t[i].count=e)}),{count:a,labels:e}},__hasUnreadMessages:function(){var e=this.__mMessagesChecked.getIds(),t=e.ids.concat(e.tids.map(function(e){return e}));return t.some(function(e){var t=ns.Model.get("message",{ids:e});
return t&&t.get(".new")})},__replyClickDataPreparation:function(e){return new vow.Promise(function(t,i){var n=ns.Model.get("message",{ids:e});n.isThread()?ns.request("messages",{thread_id:e}).then(function(e){var n=e[0].getLastReplyMessageQR();n?t(n.get(".mid")):i()}):t(e)})},__onReplyClick:function(){var e=this.__$onMessage.attr("data-id");if(e){var t=this.__replyClickDataPreparation(e);t.always(function(){ns.events.trigger("daria:vMessages:deselect")}),t.then(function(e){var t=ns.router.generateUrl("compose2",{oper:"reply-all",ids:e});
ns.page.go(t)})}}}},"context-menu-mixin-base",ns.View),ns.View.edefine("context-menu-mixin-left-panel",{methods:{__showContextMenu:function(e){var t=this;e.preventDefault();var i=$(e.currentTarget);i.removeClass("no-user-select");var n=new Daria.ContextMenu({items:this.__getContextMenuItems({$item:i,url:this.__leftPanelExtractUrl(e),id:this.__extractId(i)}),onClose:function(){t.__toggleHoverClass(i,!1)},metrika:this.__metrika});this.__toggleHoverClass(i,!0),n.show({x:e.pageX,y:e.pageY,$scrollContainer:null}),$(".js-layout-left").one("scroll.context-menu-close",function(){Daria.ContextMenu.close()
})},__toggleHoverClass:no.nop,__leftPanelExtractUrl:function(e){return $(e.target).closest("A[href]").attr("href")},__cmLeftPanelGetContextMenuItems:function(e){return[{text:"Открыть в новой вкладке",index:1,metrika:"Открыть в новом окне",onClick:function(){window.open(e.url)}},{type:"separator",index:2},{text:"Создать новую папку",icon:"move",index:3,metrika:"Создать новую папку",onClick:function(){var t=Daria.parseQuery(e.$item.attr("data-params")).fid,i=ns.Model.get("folders"),n=i.getFolderById(t);
n&&(n.symbol||n.shared)&&(t=i.getFidBySymbol("inbox")),ns.action.run("folders.add",{"only-create":!0,parent_id:t})}},{text:"Создать новую метку",icon:"label",index:4,metrika:"Создать новую метку",onClick:function(){ns.action.run("labels.add",{"only-create":!0})}},{type:"separator",index:5},{text:"Настройки папок и меток",index:6,metrika:"Настройки папок и меток",onClick:function(){var e=ns.router.generateUrl("setup",{tab:"folders"});ns.page.go(e)}}]}}},"context-menu-mixin-base",ns.View),ns.View.edefine("context-menu-mixin-labels",{methods:{__metrika:"Метки",__extractId:function(e){return Daria.parseQuery(e.attr("data-params")).lid
},__toggleHoverClass:function(e,t){e.toggleClass("is-checked",t)},__getContextMenuItems:function(e){var t=this.__cmLeftPanelGetContextMenuItems.call(this,e);if(e.id){var i=ns.Model.get("labels"),n=i.getLabelById(e.id);n.user&&t.push({text:"Переименовать метку",icon:"edit",index:2.4,metrika:"Переименовать метку",onClick:function(){ns.action.run("label.edit",{id:e.id,"only-edit":!0})}}),t.push({text:"Удалить метку",icon:"delete",index:2.5,metrika:"Удалить метку",onClick:function(){ns.action.run("label.remove",{id:e.id})
}}),t.push({type:"separator",index:2.9})}return t}}},"context-menu-mixin-left-panel",ns.View),ns.View.edefine("context-menu-mixin-folders",{methods:{__metrika:"Папки",__extractId:function(e){return Daria.parseQuery(e.attr("data-params")).fid},__toggleHoverClass:function(e,t){e.toggleClass("mail-NestedList-Item_hover",t)},__getContextMenuItems:function(e){var t=this.__cmLeftPanelGetContextMenuItems.call(this,e);if(e.id){var i=ns.Model.get("folders"),n=i.getFolderById(e.id);n.user&&!n.symbol&&"1000"!==n.fid&&"1000"!==n.parent_id&&t.push({text:"Переименовать папку",icon:"edit",index:2.4,metrika:"Переименовать папку",onClick:function(){ns.action.run("folder.edit",{id:e.id,"only-edit":!0})
}}),(!n.default&&"1000"!==n.fid&&"1000"!==n.parent_id||Daria.Folder.REMOVABLE_SYMBOLS[n.symbol])&&t.push({text:"Удалить папку",icon:"delete",index:2.5,metrika:"Удалить папку",onClick:function(){ns.action.run("folder.remove",{id:e.id})}}),n["new"]>0&&t.push({text:"Пометить все письма как прочитанные",icon:"mark-as-read",index:2.3,metrika:"Пометить все письма прочитанными",onClick:function(){Daria.Folder.markRead(e.id)}}),_.contains(["trash","spam"],n.symbol)&&n.count>0&&t.push({text:"Очистить папку",icon:"clean",index:2.6,metrika:"Очистить папку",onClick:function(){ns.action.run("folder.clear",{fid:e.id})
}}),_.contains(["template"],n.symbol)&&t.push({text:"Создать шаблон",icon:"create_template",index:2.7,metrika:"создать шаблон",onClick:function(){ns.page.go(ns.router.generateUrl("compose2",{save_symbol:"template"}))}}),t.push({type:"separator",index:2.9})}return t}}},"context-menu-mixin-left-panel",ns.View),ns.View.edefine("context-menu-mixin-collectors",{methods:{__metrika:"Коллектор",__extractId:function(e){return{popid:e.attr("data-popid"),email:e.attr("data-email")}},__toggleHoverClass:no.nop,__getContextMenuItems:function(e){return[{text:"Открыть в новой вкладке",index:1,metrika:"Открыть в новом окне",onClick:function(){window.open(e.url)
}},{type:"separator",index:1.1},{text:"Редактировать настройки",icon:"setup",index:2,metrika:"Редактировать",onClick:function(){var t=ns.router.generateUrl("setup",{tab:"collector",popid:e.id.popid,email:e.id.email});ns.page.go(t)}},{type:"separator",index:9.9},{text:"Создать новый сборщик",index:10,metrika:"Создать новый сборщик",onClick:function(){var e=ns.router.generateUrl("setup",{tab:"collectors"});ns.page.go(e)}}]}}},"context-menu-mixin-left-panel",ns.View),ns.View.define("footer-help-link",{models:{"help-link":{"ns-model-changed":"keepValid","ns-model-changed.href":"invalidate"}},yateModule:"mail"}),ns.View.define("user-dropdown-help-link",{models:{"help-link":{"ns-model-changed":"keepValid","ns-model-changed.href":"invalidate"}},yateModule:"mail"}),ns.View.define("messages-time-updater",{models:{"current-day":{"ns-model-changed":!1,"ns-model-changed.date":"updateTime"}},yateModule:"mail",methods:{updateTime:function(){ns.Model.traverse("message",this.updateMessageRelativeTime),ns.Model.traverse("message-body",this.updateMessageRelativeTime),ns.Model.traverse("messages-from-item",this.updateMessageRelativeTime)
},updateMessageRelativeTime:function(e){e.isValid()&&e.hasRelativeTime()&&e.updateTime()}}}),ns.View.define("mail-icons",{yateModule:"mail-icons"}),ns.View.define("boot-icons",{yateModule:"boot-icons"}),ns.View.define("compose-sidebar-popup",{events:{"ns-view-destroyed":"_onDestroyed"},models:{"compose-sidebar-state":!1,"compose-sidebar-fsm":!1},ctor:function(){_.bindAll(this,["_destroyContent","_onOpenedPopup","_onClosedPopup","_onDestroyedPopup","_onContentSetPopup"]),this.OFFSET_TOP=60,this._options={withoutTail:!0,autofocus:!1,autoclose:!1,animation:!1,width:580,"class":"ui-dialog-fixed mail-ComposeSidebar-Popup",how:{fixed:!0,my:"right top"}},this._nbPopup=null,this._vContent=null,this._contentNode=null
},yateModule:"mail",methods:{open:function(){this._destroyContent();var e=this.getPopup();e.isOpen()?this._resetContentPopup():this._openPopup()},close:function(){this.getPopup().close()},getPopup:function(){return this._nbPopup?this._nbPopup:(this._nbPopup=nb.find("compose-sidebar-popup"),this._nbPopup||(this._nbPopup=nb.block(ns.renderNode({},"js-compose-sidebar-popup","mail"))),this._nbPopup.on("nb-opened",this._onOpenedPopup),this._nbPopup.on("nb-closed",this._onClosedPopup),this._nbPopup.on("nb-destroyed",this._onDestroyedPopup),this._nbPopup.on("nb-content-set",this._onContentSetPopup),this._nbPopup)
},_resetContentPopup:function(){this._contentNode=ns.renderNode({},"js-compose-sidebar-popup-loader","mail"),this.getPopup().setContent(this._contentNode)},_destroyContent:function(){this._vContent&&(this._vContent.destroy(),this._vContent=null),this._contentNode=null},_destroyPopup:function(){this._nbPopup&&(this._nbPopup.destroy(),this._nbPopup=null)},_openPopup:function(){this._options.where=window,this._options.height=document.body.clientHeight-this.OFFSET_TOP,this._options.how.at="right top+"+this.OFFSET_TOP,this.getPopup().open(this._options)
},_onContentSetPopup:function(){var e=this.getModel("compose-sidebar-state");e.set(".popupRect",this.getPopup().node.getBoundingClientRect());var t,i,n,s=this.getModel("compose-sidebar-fsm").getState();if("edit"===s){var a=ns.page.current.params._cuid;Daria.composeHasParams(a)||(a=_.uniqueId("compose")),t={_cuid:a,_yateModule:"compose2"},i="layout-compose-sidebar",n="compose-sidebar"}else"done"===s&&(t={_yateModule:"done"},i="layout-compose-sidebar-done",n="compose-sidebar-done");this._vContent=ns.View.create(n,t),this._vContent._setNode(this._contentNode),this._vContent.invalidate(),this._vContent.updateByLayout(i,t,{execFlag:ns.U.EXEC.PARALLEL})
},_onOpenedPopup:function(){this._resetContentPopup();var e=this.getPopup().node.widget;e.option("beforeClose",this._destroyContent),e.option("closeOnEscape",!1)},_onClosedPopup:function(){this.trigger("closed")},_onDestroyedPopup:function(){this._destroyContent()},_onDestroyed:function(){this._destroyPopup()}}}),ns.View.define("compose-sidebar-wrap",{events:{"ns-view-init":"onInit","ns-view-destroyed":"onDestroyed","ns-view-htmlinit":"onHtmlinit"},models:{"compose-sidebar-fsm":{"ns-model-changed":!1,"cancel > edit":"onTransitionCancelToEdit","edit > done":"onTransitionEditToDone","# edit":"onStateEdit","# cancel":"onStateCancel","# done":"onStateDone"}},ctor:function(){this.onClosedPopup=this.onClosedPopup.bind(this)
},yateModule:"mail",methods:{onInit:function(){this.vComposeSidebarPopup=ns.View.create("compose-sidebar-popup"),this.vComposeSidebarPopup.on("closed",this.onClosedPopup)},onDestroyed:function(){this.vComposeSidebarPopup.off("closed"),this.vComposeSidebarPopup.destroy()},onHtmlinit:function(){this.vComposeSidebarPopup.appendToNode=this.node},onTransitionCancelToEdit:function(){return Jane.Services.load("#compose")},onTransitionEditToDone:function(){return Jane.Services.load("#done")},onStateEdit:function(){this.vComposeSidebarPopup.open()
},onStateDone:function(){this.vComposeSidebarPopup.open()},onStateCancel:function(){this.vComposeSidebarPopup.close();var e=_.omit(ns.page.current.params,"_cuid");ns.page.replacePage(ns.page.current.page,e)},onClosedPopup:function(){this.getModel("compose-sidebar-fsm").setInitialState("cancel")}}}),ns.View.define("message-dimensions-mixin",{methods:{getDimensions:function(e){return Daria.is2pane()?this.getDimensions2Pane(e):this.getDimensions3Pane(e)},getDimensions2Pane:function(e){var t,i,n={bottom:0,height:0,top:0};
if(e){if(t=this.$node.find(".js-message-body"),0===t.length)return n;i=t.outerHeight()}else t=this.$node,i=t.height();return n.top=t.offset().top,n.height=i,n.bottom=n.top+n.height,n},getDimensions3Pane:function(e){var t,i,n={bottom:0,height:0,top:0};if(!this.node)return n;if(e){if(t=this.node.getElementsByClassName("js-message-body")[0],!t)return n;i=this.node.offsetTop+t.offsetTop}else t=this.node,i=t.offsetTop;return n.height=t.offsetHeight,n.top=i,n.bottom=n.top+n.height,n},isVisibleInScroller:function(e,t){if(t){var i=ns.Model.get("message-body",this.params);
if(!i.isValid())return!1}var n=this.getDimensions(t),s=n.height,a=n.top,o=n.bottom,r=e.top,l=e.bottom;return s>0&&(a>=r&&l>=a||o>=r&&l>=o||r>=a&&o>=l)}}}),function(){ns.View.define("fixed-element-in-message-mixin",{events:{"daria:vApp:changeRightColumSize@show":"recalculateHeaderFixedState","daria:vFixedElementInMessageMixin:resize@show":"_fixedElementChangeHeight","daria:vScrollerMessage:scroll@show":"_fixedElementOnWindowScroll","daria:layout-changed@show":"_fixedElementOnWindowScroll","resize@show window":"recalculateHeaderFixedState","scroll@show window":"recalculateHeaderFixedState"},methods:{_fixedElementHeader:!1,fixedElementStart:function(){this.getModel("scroller-message").init(),this._fixedElementSetFixed3PaneHeader()
},lazyFixedRecalc:function(){_.defer(this.fixedElementStart.bind(this))},fixedElementStop:function(){this._fixedElementReset3PaneHeader(),this._fixedElementHeader=!1},_fixedElementOnWindowScroll:function(){Daria.is3pane()?this._checkFixedState():Daria.isMessagePage()||this._fixedElementRecalcStickyHeader()},_checkFixedState:function(){var e=this.$node.find(".js-thread-toolbar"),t=this.getModel("scroller-message").getScrollTop(),i=t>0;this._fixedElementHeader!==i&&(this._fixedElementHeader=i,e.toggleClass("is-fixed",i))
},_fixedElementRecalcStickyHeader:function(){var e=this.getModel("scroller-message").getScrollTop(),t=this.$node.offset(),i=e>t.top;if(i){var n=this.$node.closest(".js-cbt-item").height();n||(n=this.$node.height()),t.top+n<e+60&&(i=!1)}this._fixedElementToggleFixedHeader(i,t)},_fixedElementSetFixed3PaneHeader:function(){if(!Daria.is2pane()){var e=this.$node.find(".js-thread-toolbar");e.css("position","absolute");var t=this.$node.offset(),i=this.$node.outerWidth();e.css({position:"fixed",left:this._$window.scrollLeft()>0?this.node.getBoundingClientRect().left:t.left,top:this.getModel("scroller-message").getScroller().offset().top,width:i,"z-index":10});
var n=this.$node.find(".js-mail-Message-Toolbar-Content").outerHeight();this.$node.css({paddingTop:n}),this._fixedElementChangeHeight()}},_fixedElementReset3PaneHeader:function(){var e=this.$node.find(".js-thread-toolbar"),t=this.$node.find(".js-mail-Message-Toolbar-Content");e.length&&(e[0].style.cssText="",e.removeClass("is-fixed")),t.length&&(t[0].style.cssText=""),this.$node.length&&(this.$node[0].style.cssText="")},_fixedElementToggleFixedHeader:function(e,t){this._fixedElementHeader=e;var i=this.$node.find(".js-thread-toolbar"),n=i.find(".js-mail-Message-Toolbar-Content"),s=i.width()-16;
n.css({left:e?this._$window.scrollLeft()>0?this.node.getBoundingClientRect().left:t.left:"",width:e?s:""}),i.toggleClass("is-fixed",e)},_fixedElementChangeHeight:function(){var e=this.$node,t=e.find(".js-mail-Message-Toolbar-Content").outerHeight();e.find(".js-thread-toolbar").css({height:t}),Daria.is3pane()&&e.css({paddingTop:t})},recalculateHeaderFixedState:function(){Daria.is2pane()?this._fixedElementOnWindowScroll():this._fixedElementSetFixed3PaneHeader()}}})}(),ns.View.define("fixed-message-toolbar-mixin",{events:{"daria:vScrollerMessage:scroll@show":"_fixedToolbar","daria:layout-changed@show":"_fixedToolbar","daria:vMessageToolbar:toolbar-didRendered":"_fixedToolbar","ns-view-htmlinit":"onInit","resize@show window":"_fixedToolbar","scroll@show window":"_fixedToolbar"},methods:{onInit:function(){var e=Daria.is2pane()?".js-cbt-item":".js-message-scroll-area";
this.$header=this.$node.closest(e).find(".js-thread-toolbar"),0===this.$header.length&&Daria.isMessagePage()&&(this.$header=this.$node.find(".js-thread-toolbar")),this.$headerHeight=this.$header.height()||0,this.$messageHead=this.$node.find(".js-message-head"),this.getMessageToolbar()},getMessageToolbar:function(){this.$toolbar=this.$node.find(".js-message-toolbar-content")},_fixedToolbar:function(){this.getMessageToolbar();var e=this.getModel("scroller-message"),t=e.getScrollTop(),i=this.isVisibleInScroller(e.getVDimensions(),!1);
if(this.isOpen()&&i){var n,s=this.getDimensions(!1),a=60,o=16,r=s.top+o,l=s.bottom-this.$toolbar.height()-a;Daria.isMessagePage()?r+=this.$headerHeight:(r-=this.$headerHeight,r+=this.$messageHead.height()),n=t>r,n&&t>l&&(n=!1),this._toggleFixed(n)}else this._toggleFixed(!1)},_toggleFixed:function(e){if(e){var t=this.$node.offset(),i=parseInt(this.$toolbar.css("padding-left"))+parseInt(this.$toolbar.css("padding-right")),n=this.$node.width()-i,s=this.$headerHeight;Daria.is3pane()&&(s+=this.getModel("scroller-message").getScroller().offset().top),this.$toolbar.css({left:this._$window.scrollLeft()>0?this.node.getBoundingClientRect().left:t.left,top:s,width:n})
}else this.$toolbar&&this.$toolbar[0]&&(this.$toolbar[0].style.cssText="");this.$toolbar.toggleClass("is-fixed",e)}}}),ns.View.define("fixed-quick-reply-mixin",{events:{"daria:vScrollerMessage:scroll@show":"toggleStickyMode","message-body-full-load@show":"fixedInit","resize@show window":"onResize","scroll@show window":"onResize"},methods:{QR_OFFSET:20,fixedInit:function(){this.$qr=this.$node.find(".mail-QuickReply"),this.$message=this.$node.closest(".js-message-wrap"),this.getModel("scroller-message").init();
var e=ns.Model.get("timeline-state");this.toggleFixedAfterTimeline=this.toggleFixedAfterTimeline.bind(this),e.on("ns-model-changed.height",this.toggleFixedAfterTimeline),this.toggleStickyMode()},fixedDestroy:function(){var e=ns.Model.get("timeline-state");e.off("ns-model-changed.height",this.toggleFixedAfterTimeline)},toggleFixedAfterTimeline:function(){this.getModel("quick-reply-state").get(".fixed")&&this.stickyModeOn()},isQRInvisibleInScrollArea:function(){var e=this.getModel("scroller-message"),t=ns.Model.get("timeline-state").get(".height"),i=this.$qr.offset().top+this.$qr.innerHeight()+t,n=e.getVDimensions().bottom-e.getScrollOffset();
return i>=n},setFixed:function(e){this.getModel("quick-reply-state").setIfChanged(".fixed",e)},isFixed:function(){return this.getModel("quick-reply-state").get(".fixed")},stickyModeOn:function(){this.isFixed()||(this.setFixed(!0),this.handleResizeIfSticky())},stickyModeOff:function(){this.isFixed()&&(this.setFixed(!1),this.$node[0].style.cssText="",this.$qr.removeClass("is-fixed"),this.$qr[0].style.cssText="")},onResize:function(){this.handleResizeIfSticky(),this.toggleStickyMode()},handleResizeIfSticky:function(){this.isFixed()&&(this.$node.css({height:this.$node.innerHeight()}),this.$qr.addClass("is-fixed"),this.$qr.css({width:this.$node.innerWidth(),left:this._$window.scrollLeft()>0?this.$message[0].getBoundingClientRect().left:this.$message.offset().left,bottom:ns.Model.get("timeline-state").get(".height")}))
},toggleStickyMode:function(){this.getModel("message").isHuman()&&(Math.floor(this.$qr.offset().top)>=Math.floor(this.$node.offset().top)+this.QR_OFFSET?(this.stickyModeOff(),this.isQRInvisibleInScrollArea()&&this.stickyModeOn()):this.stickyModeOn())}}}),ns.View.edefine("infoline",{events:{"ns-view-htmlinit":"onHtmlinit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-deselect-all":"onDeselectAllClick","daria:vApp:changeAppWidth@show":"onResize","daria:vApp:changeLeftColumWidth@show":"onResize","daria:vScrollerMessages:scroll@show":"onScroll","daria:layout-changed@show":"onScroll","daria:vMessagesItemWrap:message-closed":"onToggleOpenMessage","daria:vToolbar:message-opened":"onToggleOpenMessage"},yateModule:"mail",ctor:function(){this._isFixed=!1,this._isMessageOpened=!1,this._isVisible=!1,this.recalculateValues=function(){_.defer(this._recalculateValues.bind(this))
},this.onCompactModeChanged=function(){_.defer(this._onCompactModeChanged.bind(this))},this.onMessagesCheckedChanged=function(){_.defer(this._onMessagesCheckedChanged.bind(this))},this.onScroll=_.throttle(this.onScroll.bind(this),100)},models:{settings:{"ns-model-changed":!1,"ns-model-changed.liza_minified":"onCompactModeChanged","ns-model-changed.liza_minified_header":"onCompactModeChanged","ns-model-changed.size-layout-left":"onLayoutLeftSizeChanged"},"scroller-messages":!1,"messages-checked":{"ns-model-changed":"onMessagesCheckedChanged"},dimensions:{resize:"onResize"}},params:function(e){var t=["thread_id","showDatePager","ids","important"];
for(var i in e)_.include(t,i)&&delete e[i];var n={};return Object.keys(e).sort().forEach(function(t){n[t]=e[t]}),n},methods:{MIN_LAYOUT_WIDTH:990,leftPanelWidth:null,offset:null,getToolbarHeight:function(){return ns.Model.get("settings").getSetting("hide_daria_left")?43:58},onHtmlinit:function(){this.$counter=this.$node.find(".js-messages-count"),_.defer(function(){this.onLayoutLeftSizeChanged(),this.toggleVisibility(),this.updateCounter()}.bind(this))},onShow:function(){Daria.is2pane()&&this.getModel("scroller-messages").init()
},onHide:function(){this.togglePositionFixed(!1),this.resetValues()},onResize:function(){this._isVisible&&this.togglePositionFixed(this._isFixed)},onLayoutLeftSizeChanged:function(){this.leftPanelWidth=parseFloat(this.getModel("settings").getSetting("size-layout-left")),this.onResize()},onDeselectAllClick:function(){var e=this.getModel("messages-checked");e.resetChecked()},_onCompactModeChanged:function(){return this._isVisible?void(Daria.is2pane()&&(this.recalculateValues(),this.togglePositionFixed(this._isFixed),this.onScroll())):!1
},togglePositionFixed:function(e){this._isFixed=e,this._isFixed?this.toFixed():this.toInitial()},toFixed:function(){this.$node.addClass("is-fixed"),this.$node.css({left:this.getPositionFixedLeft(),top:this.getToolbarHeight()})},toInitial:function(){this.$node.removeClass("is-fixed"),this.resetValues(),this.$node.css({left:"50%",top:"auto"})},getPositionFixedLeft:function(){var e=this.getModel("dimensions"),t=Math.max(this.MIN_LAYOUT_WIDTH,e.getWindowWidth()),i=this.leftPanelWidth;return t/2+i/2},resetValues:function(){this.offset=null
},_recalculateValues:function(){this.offset=this.getOffset()},getOffset:function(){return this.$node.offset()},toggleVisibility:function(){var e=this.getModel("messages-checked");this._isVisible=e.canShowInfoline(),this._isVisible&&(this._isVisible=!(this._isVisible&&this._isMessageOpened)),this._isVisible&&(e.atrigger("ns-model-reset-checked"),this.updateCounter()),this.$node.toggleClass("is-hidden",!this._isVisible),this.togglePositionFixed(this._isFixed)},_onMessagesCheckedChanged:function(){this.toggleVisibility(),this._isVisible&&this.updateCounter(),Daria.is2pane()&&this.onScroll()
},updateCounter:function(){var e=this.getModel("messages-checked"),t=e.getCount();this.$counter.html("Выбрано "+Jane.i18n.convert(["одно письмо",t+" письмо",t+" письма",t+" писем"],t))},onScroll:function(){if(Daria.is3pane())return!1;if(!this._isVisible)return!1;_.isNull(this.offset)&&(this.offset=this.getOffset());var e=this.getModel("scroller-messages"),t=e.getScrollTop();t>this.offset.top-this.getToolbarHeight()?this._isFixed||this.togglePositionFixed(!0):this._isFixed&&this.togglePositionFixed(!1)
},onToggleOpenMessage:function(e){switch(e){case"daria:vMessagesItemWrap:message-closed":this._isMessageOpened=!1;break;case"daria:vToolbar:message-opened":this._isMessageOpened=!0}Daria.is2pane()&&this.toggleVisibility()}}}),ns.ViewCollection.edefine("notifications",{events:{"wheel .js-notifications-scroll":"onMouseWheel","mouseleave .js-notifications-scroll":"onMouseLeave","mouseenter .js-notifications-fake":"loadMore"},models:{notifications:{"ns-model-changed":"keepValid","ns-model-changed.queue":"onQueueUpdate","ns-model-insert":"forceUpdate","ns-model-remove":"onItemRemove"},"notifications-state":{"ns-model-changed":"keepValid","ns-model-changed.expanded":"onExpandedChange"}},split:{byModel:"notifications",intoViews:"notifications-item"},yateModule:"mail",methods:{DELAY_BEFORE_HIDE_FAKE:150,getScrollContent:function(e){return $(e.target).closest(".js-notifications-scroll")[0]
},onExpandedChange:function(){var e=this.getModel("notifications-state").isExpanded();this.$node.toggleClass("is-expanded",e),e||this.getModel("notifications").insertFromQueue()},onMouseLeave:function(){this.$node.find(".js-notifications-scroll").scrollTop(0),this.getModel("notifications-state").collapse()},onMouseWheel:function(e){e.originalEvent.deltaY<0&&this.loadMore(),this.onWheel(e)},onItemRemove:function(){var e=this.getModel("notifications"),t=this.getModel("notifications-state");!e.hasNotifications()&&t.isExpanded()&&t.collapse(),this.forceUpdate()
},loadMore:function(){this.getModel("notifications").insertFromQueue()},onQueueUpdate:function(){var e=this.$node.find(".js-notifications-fake");this.getModel("notifications").hasNotificationsInQueue()?e.addClass("is-show"):_.delay(function(){e.removeClass("is-show")},this.DELAY_BEFORE_HIDE_FAKE)}}},"prevent-scroll-propagation-mixin",ns.ViewCollection),ns.View.define("notifications-item",{events:{"ns-view-show":"onShow",click:"onClick","click .js-remove":"onRemoveClick",mouseenter:"onMouseEnter"},models:{"notifications-item":"keepValid","notifications-state":{"ns-model-changed":"keepValid","ns-model-changed.expanded":"recalculateShowTimer"}},params:{id:null},ctor:function(){this.startTimerTime=0,this.stopTimerTime=0,this.timerId=null
},yateModule:"mail",methods:{MIN_TIME_TO_SHOW:1e3,TIME_TO_SHOW:3e3,TIME_TO_SHOW_VIP:6e3,DELAY_BEFORE_REMOVE:300,DELAY_BEFORE_VIP_ANIMATION:400,onShow:function(){var e=this,t=this.getModel("notifications-item").isVIP(),i=this.getModel("notifications-state").isExpanded();_.defer(function(){e.$node.addClass("is-showed")}),t&&!i&&_.delay(function(){e.$node.addClass("is-vip")},this.DELAY_BEFORE_VIP_ANIMATION),i||(this.startTimerTime=Date.now(),this.startShowTimer(t?this.TIME_TO_SHOW_VIP:this.TIME_TO_SHOW)),this.sendMetric("Показ")
},startShowTimer:function(e){this.timerId=setTimeout(this.remove.bind(this),e)},clearShowTimer:function(){this.timerId&&(this.stopTimerTime=Date.now(),clearTimeout(this.timerId))},onClick:function(){this.getModel("notifications-item").isCalendarEvent()||(this.remove(),this.getModel("notifications-state").collapse()),this.sendMetric("Клик на нотификацию")},onRemoveClick:function(e){e.preventDefault(),e.stopPropagation(),this.clearShowTimer(),this.remove()},remove:function(){if(this.isValid()){this.$node.addClass("is-removed");
var e=this;_.delay(function(){ns.Model.get("notifications").remove(e.getModel("notifications-item"))},this.DELAY_BEFORE_REMOVE)}},onMouseEnter:function(){var e=this.getModel("notifications-state");e.isExpanded()||this.getModel("notifications-state").expand()},recalculateShowTimer:function(){if(this.getModel("notifications-state").isExpanded())this.clearShowTimer();else{var e=this.stopTimerTime-this.startTimerTime,t=Math.max(this.TIME_TO_SHOW-e,this.MIN_TIME_TO_SHOW);this.startTimerTime||(this.startTimerTime=Date.now()),this.startShowTimer(t)
}},sendMetric:function(e){Jane.c("Нотификации","Нотификации-оповещения",e)}}}),ns.View.define("translate-select-lang",{events:{"click@show .js-lang":"_onClick","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll","daria:layout-changed@show":"_onScroll"},models:{"translate-langs":!1},params:function(e){return{currentLang:e.currentLang}},ctor:function(){this._defaultOptions={withoutTail:"compose2"===ns.page.current.page,autofocus:!0,autoclose:!0,how:{my:"left top",at:"left-100 bottom"}},this._options={},this._popup=null
},yateModule:"mail",methods:{open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},close:function(){_.method("close")(this._popup)},_onClick:function(e){var t=$(e.currentTarget).data("lang");this.getModel("translate-langs").setRecent(t),this.trigger("selected",t),Jane.c("Просмотр письма",Daria.is2pane()?"2pane":"3pane","Переводчик","Выбор языка",t)},_onScroll:function(){var e=_.get(this._popup,"node.widget");
_.method("_position")(e)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-translate-select-lang","mail")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){this.trigger("opened")},_onClosed:function(e,t){t.destroy(),this.trigger("closed")},_onDestroyed:function(){delete this._popup,this._options={},this.destroy()
}}}),ns.View.define("bug-report",{events:{click:"onClick"},yateModule:"mail",methods:{onClick:function(){ns.action.run("user-feedback.show",{onlyReport:!0})}}}),function(){var e=null,t=function(){if(e)return e;var t=new Vow.Promise;return Daria.Libs("DiskWidgetSaveApi",function(){t.fulfill()}),e=t};ns.View.define("disk-widget-save-popup",{yateModule:"mail",methods:{_deferred:null,open:function(e){return this._deferred?null:(this._deferred=new vow.Deferred,this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then(function(){$(e.popup.where).closest(":focusable").focus(),this.nbPopup=nb.block(this.node),this.nbPopup.open(e.popup),Vow.all([ns.request([ns.Model.get("disk-secret-key")]),t()]).then(function(t){var i=t[0][0],n=this._getSaveToDiskWidgetParams(e,i.get(".key"),this.$node.find(".js-container")[0]);
return n?(this.$node.toggleClass("mail-DiskWidgetSavePopup-Content_Loaded",!0),void(this.widget=window.WidgetSaveApi.saveAndMove(n,{onClose:this.close.bind(this),onError:function(t){Jane.c(["Вложения","Ошибка сохранения на Диск",e.countLocationName||"Не задано"]),t&&Jane.ErrorLog.send({errorType:"disk-widget-save-popup_save-failed",error:JSON.stringify(t)})}}))):void this.destroySelf()},function(){this.close(),Jane.ErrorLog.send({errorType:"disk-widget-save-popup_open-failed"})},this),this.nbPopup.on("nb-closed",this.destroySelf.bind(this))
},this),this._deferred)},close:function(){this.nbPopup&&this.nbPopup.close()},destroySelf:function(){var e=this;_.defer(function(){e.nbPopup&&(e.nbPopup.destroy(),e.nbPopup=null),e.widget&&(e.widget.destroy(),e.widget=null),e._deferred&&(e._deferred.resolve(),e._deferred=null),e.destroy()})},_getSaveToDiskWidgetParams:function(e,t,i){var n=e.mid,s=e.hid,a=e.diskDownloadUrl,o=a?"disk-public":"mail",r=a?a:this._getMailAttachmentSrc(n,s);return r?{source:"copy-widget-yamail",type:o,sourceId:r,uid:ns.Model.get("account-information").get(".uid"),sk:t,container:i}:(Jane.ErrorLog.send({errorType:"disk-widget-save-popup_could-not-generate-source-id",mid:n,hid:s,diskDownloadUrl:a}),null)
},_getMailAttachmentSrc:function(e,t){return e&&t?"/mail/file:"+e+":"+t:null}}})}(),yr.externals["is-my-email"]=function(e){return ns.Model.get("account-information").isMyEmail(e)},yr.externals["has-experiment"]=Daria.hasExperiment,yr.externals["has-feature"]=Daria.hasFeature,yr.externals["show-doublesized-contacts"]=Daria.showDoubleSizedContacts,function(){function e(e){return t(),n.getFolderById(e)||n.getFolderBySymbol(e)}function t(){n||(n=ns.Model.get("folders"),s=ns.Model.get("labels"))}function i(e){var t=e.url,i=e["preview-supported"]||e["preview-src"],n="image"===e.class,s=[],a=_.includes(s,e.class);
return(!t||i)&&(n&&i||a)}var n,s;!function(){function e(){var e=ns.page.current.params,t=[];return t.push("only_atta"===e.extra_cond?"#attachments?":"only_new"===e.extra_cond?"#unread?":yr.externals["url-content-folder"](yr.externals["get-folder-by-fid-or-symbol"](e.current_folder),!0)),t.push(yr.externals["url-params"](e,["current_folder","sort_type","page_number","extra_cond","goto","currentDateId","nextDateId","prevDateId","showDatePager"])),t.join("")}function t(){var e=ns.page.current.params,t=[];
return t.push(e.current_folder?yr.externals["url-content-folder"](yr.externals["get-folder-by-fid-or-symbol"](e.current_folder),!0):e.current_label?yr.externals["url-content-label"](yr.externals["get-label-by-lid"](e.current_label),!0):e.thread_id?"#thread/"+e.thread_id+"?":"search"===e.search?"#search?request="+encodeURIComponent(e.request)+"&":"only_new"===e.extra_cond?"#unread?":"only_atta"===e.extra_cond?"#attachments?":"all"===e["goto"]?"#all?":"#messages?"),t.join("")}function i(){var e=ns.page.current.params,t=[];
return e.current_folder?(t=["ids","thread_id","page_number","current_folder","datePager","mrange","pager_top","currentDateId","prevDateId","nextDateId","showDatePager"],Daria.is2pane()&&t.push("extra_cond")):t=e.current_label?["ids","thread_id","page_number","current_label"]:e.thread_id?["ids","thread_id","page_number"]:"search"===e.search?["ids","thread_id","page_number","search","request"]:"only_new"===e.extra_cond||"only_atta"===e.extra_cond||"all"===e["goto"]?["ids","thread_id","page_number","extra_cond","goto"]:["ids","thread_id","page_number","pager_top"],yr.externals["url-params"](e,t)
}yr.externals["url-params"]=function(e,t,i){e||(e=ns.page.current.params),t=$.makeArray(t),i=$.makeArray(i),t.push("threaded");var n=[];for(var s in e)!e.hasOwnProperty(s)||t.length&&-1!==t.indexOf(s)||i.length&&-1===i.indexOf(s)||n.push(encodeURIComponent(s)+"="+encodeURIComponent(e[s]));return n.length?n.join("&")+"&":""},yr.externals["url-content-folder"]=function(e,t){return e=yr.nodeset2data(e),t=t?"?":"",e.symbol?"#"+e.symbol+t:"#folder/"+e.fid+t},yr.externals["url-content-label"]=function(e,t){return e=yr.nodeset2data(e),t=t?e.lid?"?":"&":"",e.lid?"#label/"+e.lid+t:"#messages?goto=all&extra_cond="+e.symbol+t
},yr.externals["url-content-message"]=function(e,t){return e=yr.nodeset2data(e),Jane.Page.generateUrl.contentMessage(e,t)},yr.externals["url-content-sort"]=function(t,i){return Array.isArray(t)&&(t=yr.nodeset2scalar(t)),Array.isArray(i)&&(i=yr.nodeset2scalar(i)),e()+"sort_type="+t+("asc"===i?"1":"")+"&"},yr.externals["page-url-prefix"]=function(){return t()+i()}}(),yr.externals["daria-url-docviewer"]=function(){var e=Array.prototype.slice.call(arguments);return e[0]=yr.nodeset2data(e[0]),Daria.url.docviewer.apply(Daria.url,e)
},yr.externals["daria-url-attachment"]=function(){var e=Array.prototype.slice.call(arguments);return e[0]=yr.nodeset2data(e[0]),Daria.url.attachment.apply(Daria.url,e)},yr.externals["daria-url-attachment-archive"]=function(){var e=Array.prototype.slice.call(arguments);return e[0]=yr.nodeset2data(e[0]),Daria.url.archive.apply(Daria.url,e)},yr.externals["get-folder-by-fid-or-symbol"]=function(t){return yr.object2nodeset(e(t)||{})},yr.externals["get-folders-by-fids-or-symbols"]=function(t){for(var i=[],n=0;n<t.length;++n){var s=t[n].data,a=e(s);
a&&i.push(a)}return yr.object2nodeset({folders:i})},yr.externals["get-human-size"]=Jane.getHumanSize,yr.externals["get-label-by-name"]=function(e){return t(),yr.object2nodeset(s.getLabelByName(e)||{})},yr.externals["get-label-by-lid"]=function(e){return t(),yr.object2nodeset(s.getLabelById(e)||{})},yr.externals["get-label-important"]=function(){return t(),yr.object2nodeset(s.getLabelBySymbolicName("important_label")||{})},yr.externals["get-shortcut-label-for"]=function(e,t,i){return Daria.Shortcuts.getShortcutLabelFor(e,t,i)
},yr.externals["get-current-page"]=function(){return ns.page.current.page},yr.externals["get-current-page-params"]=function(){return yr.object2nodeset(ns.page.current.params)},yr.externals["get-current-page-param"]=function(e){return ns.page.current.params[e]},yr.externals["is-2pane"]=Daria.is2pane,yr.externals["is-3pane"]=Daria.is3pane,yr.externals["is-message-page"]=Daria.isMessagePage,yr.externals["is-folder"]=function(e,i){return e&&i?(t(),n.isFolder(e,i)):!1},yr.externals["social-avatar"]=function(e){return Daria.SocialAvatars2.register(e)
},yr.externals["should-show-checkbox-inside-userpic"]=Daria.UISettings.shouldShowCheckboxInsideUserpic,yr.externals["get-unconfirmed-phone"]=function(){return ns.Model.get("userphones").getUnconfirmedPhone()},yr.externals["get-labels-by-lid"]=function(e){t();var i=yr.nodeset2data(e);"string"==typeof i&&(i=[i]);for(var n=[],a=0,o=i.length;o>a;a++){var r=s.getLabelById(i[a]);if(r){var l=yr.object2nodeset(r)[0];l.name="label",n.push(l)}}return n},yr.externals["can-use-pins-by-params"]=function(e){return Daria.messages.checkUsePinsByParams(yr.nodeset2data(e))
},yr.externals["can-show-pin-controls-by-params"]=Daria.messages.canShowPinControlsByParams,yr.externals["has-attachment-preview"]=function(e){return i(yr.nodeset2data(e))},yr.externals["get-count-attachments-to-show"]=function(e){var t=3,i=yr.nodeset2data(e);return i=_.isArray(i)?i:[i],i.length>t?t:i.length},yr.externals["get-message-presentation-by-fid"]=function(e,t){var i=yr.nodeset2data(e)||{},n={ids:i.mid,fid:t||ns.page.current.params.current_folder||i.fid},s=ns.Model.get("message-presentation",n);
return s&&s.isValid()&&s.getData()?yr.object2nodeset(s.getData()):null}}(),yr.externals["show-priority-label"]=function(){return Daria.showPriorityLabel()},yr.externals["from-user-emails"]=function(){return $.map(ns.Model.get("account-information").getFromEmails(),function(e){return{data:e}})},function(){Daria.SocialAvatars2={},Daria.SocialAvatars2.CACHE={};var e=Daria.SocialAvatars2.CACHE;Daria.SocialAvatars2._queue=[],function(){var e=[16,28,36,50,150],t=36,i={yandexru:"yagreeting",yandexcom:"yagreeting__eng",yandexcomtr:"yagreeting__eng"},n={"message-mid":function(){if(this.mid){var e=ns.Model.get("message",{ids:this.mid});
return e.getData()?{fid:e.get(".fid"),dlid:e.get(".dlid"),dtype:e.get(".dtype"),socialLid:e.getSocialLID()}:void 0}},"filter-search-mid":function(){if(this.mid){var e=ns.Model.get("filter-search",{mids:this.mid});return e.getData()?{fid:e.select(".envelopes.fid")[0],dlid:e.select(".envelopes.dlid")[0],dtype:e.select(".envelopes.dtype")[0],socialLid:e.getSocialLID()}:void 0}},"message-tid":function(){if(this.tid){var e=ns.Model.get("message",{ids:this.tid});return e.getData()?{dlid:e.get(".dlid"),dtype:e.get(".dtype"),socialLid:e.getSocialLID()}:void 0
}}},s=function(){var e=0;return function(){return e++}}();Daria.SocialAvatars2.Avatar=function(e){this.uid=(Math.round(1e4*Math.random())+Date.now()).toString(36)+"-"+s(),this.mid=e.mid||ns.page.current.params.ids,this.tid=e.tid,Array.isArray(this.mid)&&(this.mid=this.mid[0]),this.target=e.target||"_blank",this.title=e.title,this.name=e.name,this.monogram=e.monogram,this.single=e.single,this.showCustomAvatar=e.showCustomAvatar!==!1,this.className=String(e.className||""),e.size=Number(e.size||0),this.size=e.size,this.href=e.href,this.url=e.url,this.ico=e.ico,this.participantType=e.participantType,this.mode=e.mode,this.userUid=e.uid?Number(e.uid):void 0;
var t=_.compact($.makeArray(e.ref)),i=_.compact($.makeArray(e.email));if(e.email&&e.ref&&t.length!==i.length)throw new Error("Not according to the number of email");this.emails={};for(var n=0,a=i.length;a>n;n++){var o=i[n];Jane.FormValidation.checkEmail(o)&&(this.emails[o]={email:o,ref:t[n],login:o.split("@")[0],isCorp:Daria.email.isCorp(o)})}this.message=this._getMessageInfo(),e.unset&&Daria.SocialAvatars2.Cache.unset(this),this._createMonogram(),this._createDataDeepMessage(),this._checkShowAccess()
},Daria.SocialAvatars2.Avatar.prototype.loadDeep=function(){if(this.message||!this.mid)return Vow.fulfill();var e=this;return ns.request("message",{ids:this.mid}).then(function(){e.message=e._getMessageInfo(),e._createDataDeepMessage()})},Daria.SocialAvatars2.Avatar.prototype.icoRef=function(e){return this.mid&&!this._isCheckEmailRef&&(this._isCheckEmailRef=!0,Object.keys(this.emails).filter(function(e){return!Boolean(this.emails[e].ref)},this).forEach(function(e){var t;["message","message-body"].some(function(i){return t=ns.Model.get(i,{ids:this.mid}).getEmailRef(e),Boolean(t)
},this),this.emails[e].ref=t},this)),this.emails[e]&&this.emails[e].ref},Daria.SocialAvatars2.Avatar.prototype.icoURI=function(n,s){if("monogram"===n){if(!this.monogram)return;return Daria.supplant("{main}/{mode}/{monogram}.png",{main:Daria.Config["monograms-url"],mode:this.single?"single":"double",monogram:this.monogram})}if("corp"===n){var a;if(s?this.emails[s]&&this.emails[s].isCorp&&(a=this.emails[s]):a=_.find(this.emails,function(e){return e.isCorp}),!a)return;var o=t;return-1!==e.indexOf(this.size)&&(o=this.size),window.devicePixelRatio>1&&(o=_.last(e)),Daria.supplant("{protocol}//center.yandex-team.ru/api/v1/user/{login}/avatar/{size}.jpg",{protocol:location.protocol,login:a.login,size:o})
}if("service"===n){var r=this.ico;if(!r&&this.message&&this.message.serviceName&&(r=this.message.serviceName),!r)return;return Daria.supplant("{main}/{service}.png",{main:Daria.Config["socialavatars-url"],service:i[r]?i[r]:r})}if("user"===n){if(!this.userUid)return;return Daria.supplant("{protocol}{userPicDomain}{uid}/middle/mail?{rnd}",{userPicDomain:Daria.Config["user-pic-domain"],protocol:location.protocol,uid:this.userUid,rnd:Math.random()})}},Daria.SocialAvatars2.Avatar.prototype.isRecipient=function(){return"to"===this.participantType
},Daria.SocialAvatars2.Avatar.prototype.canShowCustomAvatar=function(){return this.showCustomAvatar},Daria.SocialAvatars2.Avatar.prototype._createMonogram=function(){if(this.name&&!this.monogram)if(this.single){var e=Daria.Monogram.extractMonogram(this.name);e&&e.length>0&&(this.monogram=Daria.Monogram.encodeMonogram(e[0]))}else this.monogram=Daria.Monogram.createMonogram(this.name)},Daria.SocialAvatars2.Avatar.prototype._createHref=function(){if(this.href!==!1&&this.message){var e,t,i=Object.keys(this.emails);
if(this.message.socialLabel)t=ns.router.generateUrl("messages",{current_label:this.message.socialLabel.lid}),e=this.message.socialLabel.title;else if(this.message.dtype&&this.message.dtype.sender&&24!=this.message.dtype.id)t=ns.router.generateUrl("messages",{search:"search",type:this.message.dtype.id});else if(this.participantType&&i.length&&this.message.fid){var n={search:"search",scope:this.isRecipient()?"hdr_to":"hdr_from",request:i[0]};ns.Model.get("folders").isFolder(this.message.fid,["sent","draft"])&&(n.scope="hdr_to"),"hdr_to"===n.scope?(n.fid=this.message.fid,e="все письма на этот адрес"):e="все письма с этого адреса",t=ns.router.generateUrl("messages",n)
}t&&(this.href=t),e&&!this.title&&this.title!==!1&&(this.title=e)}},Daria.SocialAvatars2.Avatar.prototype._checkShowAccess=function(){if(this.message&&this.message.fid&&ns.Model.get("folders").isFolder(this.message.fid,["trash"]))throw new Error("Smoking folder")},Daria.SocialAvatars2.Avatar.prototype.isDownloadRequired=function(){if(this.url)return!1;if(this.userUid)return!1;if(!this.isRecipient()&&this.icoURI("service"))return!1;var e=Object.keys(this.emails);if(!e.length)return!1;var t=e.some(function(e){return Boolean(this.emails[e].ref)
},this);return t||this.mid?!0:!1},Daria.SocialAvatars2.Avatar.prototype._createDataDeepMessage=function(){this.isRecipient()||this.message&&("yagreeting"===this.message.serviceName||this.message.socialLabel&&this.message.socialLabel.yaservice)&&(this.className+=" b-ico_yaservice"),this._createHref()},Daria.SocialAvatars2.Avatar.prototype._getMessageInfo=function(){var e=["message-mid","filter-search-mid","message-tid"];"from"===this.participantType&&this.tid&&!this.single&&(e=["message-tid","filter-search-mid","message-mid"]);
for(var t,i=0;i<e.length&&!(t=n[e[i]].call(this));i++);return t?{fid:t.fid,dlid:t.dlid,dtype:t.dtype,isService:Boolean(t.dlid||t.dtype),serviceName:t.dlid||t.dtype&&t.dtype.name,socialLabel:t.socialLid&&ns.Model.get("labels").getLabelById(t.socialLid)}:void 0}}(),function(){var e=Daria.SocialAvatars2.CACHE,t={"user-url":function(){return this.url?{url:this.url,type:"user"}:void 0},user:function(){var e=this.icoURI("user");return e?{url:e,type:"user"}:void 0},service:function(){var e=this.icoURI("service");
return e?{url:e,type:"service"}:void 0},social:function(){if(Daria.SocialAvatars2.Cache.isset(this)){var t;return Object.keys(this.emails).some(function(i){var n=this.emails[i];if(n.isCorp)e[n.login]&&(t={url:this.icoURI("corp",i),type:"corp"});else if(e[i]&&"noavatar"!==e[i].url){var s="face-contact";s=this.size>50?"large":this.size>36?"middle":"face-contact",t={url:e[i].url+"/"+s,type:"social"}}return Boolean(t)},this),t}},monogram:function(){var e=this.icoURI("monogram");return e?{url:e,type:this.single?"smonogram":"monogram"}:void 0
},noavatar:function(){return{url:void 0,type:"noavatar"}}},i=["user-url","user","service","social","monogram","noavatar"],n=["user-url","user","social","monogram","social","noavatar"],s=["service","monogram","noavatar"];Daria.SocialAvatars2.Cache={},Daria.SocialAvatars2.Cache.getData=function(){return e},Daria.SocialAvatars2.Cache.isset=function(t){return Object.keys(t.emails).some(function(t){var i=this.emails[t];return e.hasOwnProperty(i.isCorp?i.login:t)},t)},Daria.SocialAvatars2.Cache.unset=function(t){t.email&&(t.isCorp?delete e[t.login]:delete e[t.email])
},Daria.SocialAvatars2.Cache.get=function(e){var a,o;return o=e.canShowCustomAvatar()?e.isRecipient()?n:i:s,o.some(function(i){return a=t[i].call(e),Boolean(a)}),a}}(),function(){Daria.SocialAvatars2.Queue={},Daria.SocialAvatars2.Queue.add=function(e){return!e.isDownloadRequired()||Daria.SocialAvatars2.Cache.isset(e)?!1:(Daria.SocialAvatars2._queue.push(e),!0)}}(),function(){Daria.SocialAvatars2.View={},Daria.SocialAvatars2.View._toString=function(e,t){return ns.renderString({url:t.url,type:t.type,mid:e.mid,uid:e.uid,href:e.href,size:e.size,target:e.target,title:e.title,className:e.className,mode:e.mode},"js-social-avatars","mail")
},Daria.SocialAvatars2.View.toString=function(e){var t=Daria.SocialAvatars2.Cache.get(e);return this._toString(e,t)},Daria.SocialAvatars2.View._update=function(e){var t=Daria.SocialAvatars2.Cache.get(e);if("corp"===t.type||"social"===t.type){var i=".js-social-avatar_"+e.uid,n=$(i);if(n.length)return n.replaceWith(this._toString(e,t)),e._updated=!0,!0}return!1},Daria.SocialAvatars2.View.update=function(e,t){return e._updated?!0:t?(e.loadDeep().then(this._update.bind(this,e)),!0):this._update(e)}}(),Daria.SocialAvatars2.onerror=function(e){e.onerror=null,Jane.ErrorLog.sendException("socialavatars.error.noimg");
var t=$(e);t.closest(".js-social-avatar2").replaceWith(Jane.tt("mail:js-social-avatars",{href:t.data("href"),size:t.data("size"),type:"noavatar"}))},Daria.SocialAvatars2.register=function(e){try{var t=new Daria.SocialAvatars2.Avatar(e);return Daria.SocialAvatars2.Queue.add(t),Daria.SocialAvatars2.run(),Daria.SocialAvatars2.View.toString(t)}catch(i){return Jane.tt("mail:js-social-avatars",{uid:"undefined",href:"",size:e.size,mode:e.mode,type:"placeholder"}).outerHTML}},Daria.SocialAvatars2.run=_.debounce(function(){if(Daria.SocialAvatars2._queue.length){var e=$({});
e.queue(Daria.SocialAvatars2._runQueueBefore),e.queue(Daria.SocialAvatars2._runQueueGetUnload),e.queue(Daria.SocialAvatars2._runQueueCreateLoadLists),e.queue(Daria.SocialAvatars2._runQueueUploadCorp),e.queue(Daria.SocialAvatars2._runQueueUploadSocial)}},100),Daria.SocialAvatars2._runQueueBefore=function(e){ns.request("service-emails",{}).then(function(){e()})},Daria.SocialAvatars2._runQueueGetUnload=function(e){this.queue=Daria.SocialAvatars2._queue.filter(function(e){return!Daria.SocialAvatars2.View.update(e)
}),Daria.SocialAvatars2._queue=[],e()},Daria.SocialAvatars2._runQueueCreateLoadLists=function(e){var t=ns.Model.get("service-emails");this.corp={},this.social={},this.queue.forEach(function(e){Object.keys(e.emails).forEach(function(i){var n,s=e.emails[i],a=e.icoURI("corp",i);a?n=this.corp[a]?this.corp[a]:this.corp[a]=[]:t.is(i)||(a=e.icoRef(i),a&&(a=a+":"+i,n=this.social[a]?this.social[a]:this.social[a]=[])),n&&n.push([s,e])},this)},this),e()},Daria.SocialAvatars2._runQueueUploadCorp=function(t){$.each(this.corp,function(t,i){var n=new Image;
n.onload=function(){i.forEach(function(t){e[t[0].login]=!0,Daria.SocialAvatars2.View.update(t[1],!0)})},n.onerror=function(){i.forEach(function(t){e[t[0].login]=!1})},n.src=t}),t()},Daria.SocialAvatars2._runQueueUploadSocial=function(){if(!$.isEmptyObject(this.social)){var t=Object.keys(this.social).filter(function(e){return!Boolean(ns.Model.get("social-avatars",{refs:e}).getData())});t.length&&ns.forcedRequest("social-avatars",{refs:t}).always(function(){for(var t in this.social){var i=ns.Model.get("social-avatars",{refs:t}).getData();
if(!$.isEmptyObject(i)){e[i.email]={url:i.url};for(var n=this.social[t],s=n.length;s--;)Daria.SocialAvatars2.View.update(n[s][1],!0)}}},this)}}}(),function(){Daria.messageEventWidget={collectionOfWidgets:[],howShowWidgetByMid:{}}}(),function(e){var t=null,i=!1;ns.events.on("toolbar.fixed",function(e,t){i=t}),e.Statusline={_inited:!1,timeout:5e3,init:function(){this.$node=$(Jane.tt("mail:statusline",{})).hide().prependTo(".js-mail-App"),this.$remove=this.$node.find(".js-mail-Notification-Close"),this.$content=this.$node.find(".js-mail-Notification-Content"),this.$flag=this.$node.find(".js-mail-Notification-Flag");
var e=$(".js-mail-Logo"),i=e.position().left+e.width()+20;this.$node.css({left:i});var n=this;this.$node.hover(function(){clearTimeout(n.timeoutId)},function(){n.hideOnTimeout&&(n.timeoutId=setTimeout(function(){n.hide()},n.timeout))}),this.$remove.on("click.statuslineRemove",function(e){e.stopPropagation(),e.preventDefault(),n.hide(null,null,!0)}),this.$node.on("click.statuslineClick",function(e){$.isFunction(n.onclick)?n.onclick(e):n.hide()}),$(window).scroll(function(){n.top&&n.updatePosition()
}),this._inited=!0,t&&this[t.method].apply(this,t.params)},showMsg:function(i){if(!this._inited)return void(t={method:"showMsg",params:[i]});var n=i.data?e.supplant(i.body,i.data):i.body,s=this,a=i.blocker||!1;this.name=i.name||"unnamed",this.hideOnTimeout="undefined"!=typeof i.hideOnTimeout?i.hideOnTimeout:!0,this.blocker=a,this.onclose=i.onclose||null,this.onclick=i.onclick||null,this.blockerCanBeClosed=i.blockerCanBeClosed||!1,i.flag&&this.$flag.html(i.flag),i.href&&this.$node.attr({href:i.href}),this.$content.html(n),this.$node.addClass(i["class"]),this.$remove.toggleClass("g-hidden",a),this.$remove.toggleClass("g-hidden",a&&!this.blockerCanBeClosed),this.$node.show(),this.top||(this.top=parseInt(this.$node.css("top"),10),this.updatePosition()),clearTimeout(this.timeoutId),this.hideOnTimeout&&(this.timeoutId=setTimeout(function(){s.hide(s.name,i.speed)
},i.timeout||this.timeout))},hide:function(i,n,s){if(!this._inited)return void(t={method:"hide",params:[i,n]});if(!i&&!this.blocker||this.name===i||this.blockerCanBeClosed){clearTimeout(this.timeoutId),n?this.$node.fadeOut(n):this.$node.hide(),this.$node.removeClass("b-statusline_fixed"),this.top=null,s&&$.isFunction(this.onclose)&&this.onclose(),this.$flag.html("");var a=this;this.$node.attr("href")&&e.setZeroTimeout(function(){a.$node.removeAttr("href")})}},updatePosition:function(){this.top<$(document).scrollTop()?this.$node.addClass("b-statusline_fixed").toggleClass("b-statusline_with-toolbar",i):this.$node.removeClass("b-statusline_fixed b-statusline_with-toolbar")
}},ns.events.on("pageinit",function(){e.Statusline.init()}),ns.events.on("selected.change",function(){e.Statusline.hide("message-action-warning")}),ns.events.on("ns-page-before-changed",function(){e.Statusline.hideOnTimeout===!1&&e.Statusline.hide()})}(Daria),function(){var e=function(t,i){this.options=$.extend({},e.defaults,i),this.options.showDoubleSizedContacts&&(this.options.suggestClass+=" mail-Suggest_size_double"),this.cache={},this.currentContent=[],this.currentTerm="",this._janeEvents={},this.dontClose=!1,this.isInputFieldBlur=!1,this.$document=$(document),this.changeInputField(t,!0)
};no.extend(e.prototype,ns.Events),e.defaults={suggestClass:"nb-island _nb-fly-island _nb-suggest-container _nb-s-suggest mail-Suggest",handlers:{},cacheSize:50,multiple:!1,multipleSeparator:",",valuePrefix:"",minLength:0,delay:0,autoFocus:!0,getPositionNode:_.noop},e.extractLast=function(e,t){return e.split(t).pop()},e.mixPrivateMethodWithOption=function(e,t,i){return $.map(i,function(i){var n="_"+i,s=e[n],a=t[i];$.isFunction(e[n])&&($.isFunction(a)?a.isMixed||(t[i]=function(){a.apply(this,arguments),s.apply(e,arguments)
}):t[i]=function(){s.apply(e,arguments)},t[i].isMixed=!0)}),t},e.prototype.changeInputField=function(e,t){return t||this.destroy(),this.$inputField=$(e),this.inputField=this.$inputField[0],this.inputField&&"object"==typeof this.inputField&&1===this.inputField.nodeType&&this.init(),this},e.prototype.init=function(){return this.$inputField.addClass("_init"),this.$inputField.attr({"data-nb":"suggest","data-class-suggest":this.options.suggestClass}),this.nbSuggest=nb.block(this.inputField),this.setOptions(this.options).bindEvents(),this.nbSuggest.$jUI.suggest({open:function(){this._opened||(this._opened=!0,this.trigger("open"))
}.bind(this),close:function(){this._opened&&(this._opened=!1,this.trigger("close"))}.bind(this)}),this},e.prototype.isOpen=function(){return Boolean(this._opened)},e.prototype.setOptions=function(t){if(t=t||{},$.extend(this.options,t),e.mixPrivateMethodWithOption(this,this.options,["source","search","select","focus","response","open","close"]),this.nbSuggest){var i=this.options.getPositionNode();i&&$.extend(!0,this.options,{position:{of:i}}),this.nbSuggest.setOption(this.options)}return this.options.multiple&&(this.options.multipleSeparatorRegExp=new RegExp(this.options.multipleSeparator+"\\s*")),this
},e.prototype.show=function(e){return this.nbSuggest&&(e||(e=this.nbSuggest.getValue()),this.nbSuggest.search(e)),this},e.prototype.hide=function(){return this.dontClose=!1,this.abort(),this.nbSuggest&&this.nbSuggest.close(),$.isFunction(this.options.hide)&&this.options.hide.apply(this.inputField,arguments),this},e.prototype.bindJaneEvent=function(e,t){var i=this[t].bind(this);return this._janeEvents[e]=i,ns.events.on(e,i),this},e.prototype.unbindJaneEvent=function(e){return ns.events.off(e,this._janeEvents[e]),delete this._janeEvents[e],this
},e.prototype.bindEvents=function(){if(Modernizr.msie){var e=this,t=this.$inputField.data("uiSuggest"),i=t.close;t.close=function(){e.dontClose||i.apply(this,arguments)},this.$document.on("mousedown.daria-suggest",this._ieDocumentMousedown.bind(this)),this.$inputField.on("blur.daria-suggest",this._ieInputBlur.bind(this))}return this},e.prototype.focusedSelect=function(){var e=$.Event("keydown",{which:Jane.Common.keyCode.ENTER,keyCode:Jane.Common.keyCode.ENTER});this.currentContent.length?this.$inputField.trigger(e):this.options.select(e,{item:{email:this.currentTerm,value:this.currentTerm}})
},e.prototype._isSuggestDropDown=function(e){var t=this.nbSuggest.$suggest;return t[0]===e.target||$.contains(t[0],e.target)},e.prototype._ieDocumentMousedown=function(e){var t=this._isSuggestDropDown(e);this.dontClose=t,this.isInputFieldBlur&&!t&&this.hide()},e.prototype._ieInputBlur=function(){this.isInputFieldBlur=!0},e.prototype.getValueWithPrevious=function(){var e="";if(this.nbSuggest&&(e=this.nbSuggest.getValue(),this.options.multiple)){var t=[].concat(this.options.previousValues);t.push(e),e=t.join(this.options.multipleSeparator+" ")
}return e},e.prototype._convertHandlers=function(e){var t=this.options.extraParams;return $.map(this.options.handlers,function(i,n){return{name:n,params:$.extend({},t,i,e)}})},e.prototype._parseHandlersData=function(e,t){var i=this,n=[],s=e.length;return $.each(t,function(t,a){if(t>=s)return!1;var o;o=s>1?a[0].models:a.models,o||(o=[{}]),o[0].data||(o[0].data={});var r=i.parse(e[t].name,o[0].data);n=n.concat(r)}),n},e.prototype._getTerm=function(t){return this.options.multiple&&(t=e.extractLast(t,this.options.multipleSeparatorRegExp)),t
},e.prototype._source=function(e,t){var i=this,n=this._getTerm(e.term);if(i.currentTerm=n,!(n.length<this.options.minLength)){var s={q:n},a=this._convertHandlers(s);if(this.abort(),!a.length)return void t([]);this.requests=[];var o=[];$.map(a,function(e){var t={};$.each(e.params,function(e,i){t[e+".0"]=i}),e.params=t,o.push(e.params)});var r=JSON.stringify(o);o=[];var l=this.getCache(r);if(l)return void t(l);$.map(a,function(e){var t=$.url(Daria.modelsApiURl),n={"_model.0":e.name};ns.request.addRequestParams(n),t.addParams(n);
var s=$.ajax({type:"get",dataType:"json",jsonp:"jsonp",scriptCharset:"utf-8",cache:!1,url:t.toString(),data:e.params});i.requests.push(s)}),$.when.apply($,this.requests).then(function(){var e=i._parseHandlersData(a,arguments);i.setCache(r,e),t(e)})}},e.prototype._select=function(e,t){this.trigger("select",e,t);for(var i,n=e;n&&"click"!==n.type;)n=n.originalEvent;if(n&&(i=$(n.target).hasClass("nb-button")?$(n.target):$(n.target).parents(".nb-button"),i.length>0&&(t.button=i,this.trigger("button-click",n,t))),this.dontClose=!1,!e.isDefaultPrevented()){var s=this.nbSuggest.getValue(),a=t.item.value;
this.options.multiple&&(a=s.split(this.options.multipleSeparatorRegExp),a.pop(),a.push(t.item.value),a.push(""),a=a.join(this.options.multipleSeparator+" ")),this.nbSuggest.setValue(a),e.preventDefault(),this.trigger("value-set",e,t,a)}},e.prototype._focus=function(e){e.preventDefault()},e.prototype._response=function(e,t){this.currentContent=t.content.length?t.content:[];var i=this.getValueWithPrevious();if(this.options.multiple&&i.split(this.options.multipleSeparator).length>1){var n=$.grep(t.content,function(e){return-1===i.indexOf(e.value)
});t.content.length=0,t.content.push.apply(t.content,n)}},e.prototype._search=Daria.nop,e.prototype._open=Daria.nop,e.prototype._close=function(){this.dontClose=!1,this.isInputFieldBlur=!1,this.currentContent=[],this.currentTerm=""},e.prototype.abort=function(){return $.isArray(this.requests)&&$.map(this.requests,function(e){$.isFunction(e.abort)&&e.abort()}),delete this.requests,this},e.prototype.destroy=function(){var e=this;return this.abort(),this._close(),this.nbSuggest&&(this.nbSuggest.destroy(),this.nbSuggest=null),this.$inputField&&this.$inputField.off(".daria-suggest"),this.$document.off(".daria-suggest"),$.each(this._janeEvents,function(t){e.unbindJaneEvent(t)
}),this.off(),this},e.prototype.parse=function(e,t){return t},e.prototype.setCache=function(e,t){return Object.keys(this.cache).length>=this.options.cacheSize&&this.clearCache(),this.cache[e]=t,this},e.prototype.getCache=function(e){return this.cache[e]},e.prototype.clearCache=function(){return this.cache={},this},Daria.Suggest=e}(),function(){var e=function(e,t){t&&_.isFunction(t.exclude)&&(this._getContactsToExclude=t.exclude,delete t.exclude),t=$.extend({countMax:11,timeoutOfCopyToSms:!1,noSmsButton:!Daria.Config.MAY_HAVE_SMS_COPY,renderItem:this._renderItem.bind(this),showDoubleSizedContacts:Daria.showDoubleSizedContacts()},t),this.countOfClick=0,this.showAbookPopupButton=t.showAbookPopupButton,Daria.Suggest.call(this,e,t)
};Daria.extend(e,Daria.Suggest);var t=e.superClass;e.prototype.init=function(){var e=this.$inputField.closest(".js-compose-mail-input");return e.hasClass("js-compose-mail-message-input")&&(this.options.noSmsButton=!0),t.init.apply(this,arguments)},e.prototype.bindEvents=function(){return this.$inputField.on("keydown.daria-suggest keypress.daria-suggest",this._keydownEvent.bind(this)).on("click.daria-suggest",this._clickEvent.bind(this)),t.bindEvents.apply(this,arguments)},e.prototype._keydownEvent=function(e){var t=Jane.Common.keyCode;
if(e.which!==t.ENTER){var i=!1;if(","===$.trim(this.options.multipleSeparator))switch(e.which){case t.COMMA_CHAR:case t.SEMI_CHAR:i=!0;break;case t.SPACE_CHAR:i=this.currentContent.length<=1}i&&this.currentFocused&&(e.preventDefault(),this.focusedSelect(),this.currentFocused=null)}},e.prototype._clickEvent=function(){this.countOfClick||this.show(),this.countOfClick++},e.prototype._renderItem=function(e){var t=this,i=e.item,n=$.extend({noSmsButton:!1},this.options);if("label"!==i.type){var s=!0;$.each(["name","email","phone"],function(e,n){var a="highlighted-"+n;
s?(i[a]=t._highlight(i[n],t.currentTerm),-1!==i[a].indexOf("js-suggest-highlight")&&(s=!1)):i[a]=_.escape(i[n]),i[n]=_.escape(i[n])})}if(i.email){var a=ns.Model.get("account-information").getAllUserEmails();$.inArray(i.email,a)>-1&&(n.noSmsButton=!0)}return Daria.showDoubleSizedContacts()&&(n.doubleHeight=!0),i.options=n,yr.run("mail",e,"compose-email-suggest-item")},e.prototype._isTemplate=function(){var e=ns.page.current.params,t=!1;return("template"===jpath(Daria,".composeParams.save_symbol")[0]||"template"===e.save_symbol||e.ids&&ns.Model.get("message",{ids:e.ids}).inFolder(ns.Model.get("folders").getFidBySymbol("template")))&&(t=!0),t
},e.prototype._isInnerEvent=function(e){return!e.originalEvent},e.prototype._isKeydown=function(e){return Boolean(e.originalEvent&&"keydown"===e.originalEvent.type)},e.prototype._isDownOrUpKey=function(e){var t=Jane.Common.keyCode;return this._isKeydown(e)&&(e.originalEvent.which===t.DOWN||e.originalEvent.which===t.UP)},e.prototype._search=function(e){return this.searchEvent=e,t._search.apply(this,arguments)},e.prototype._source=function(e){var i,n=this.searchEvent,s=this._getTerm(e.term);this._getContactsToExclude&&(i=this._getContactsToExclude());
var a={"abook-suggest":_.extend({},i,{climit:35,glimit:5,useAbook:"on"})};return s||this._isTemplate()||(this._isInnerEvent(n)||this._isDownOrUpKey(n)?(a["abook-suggest"].popular=!0,a["abook-suggest"].climit=this.showAbookPopupButton&&!this._getTerm(e.term)?Daria.showDoubleSizedContacts()?4:5:10):a={}),this.options.handlers=a,t._source.apply(this,arguments)},e.prototype._select=function(e,i){var n=i.item;if("abook-popup-button"===n.type)return t._select.apply(this,arguments);var s=this.options.handlers["abook-suggest"];
s&&s.popular&&(Daria.composeParams=Daria.composeParams||{},Daria.composeParams["popular-suggest-general"]||(Daria.composeParams["popular-suggest-general"]=[]),Daria.composeParams["popular-suggest-general"].push(n.email),Jane.c(["popular_suggest","Клики в саджест популярных контактов"]));var a={q:this.currentTerm,section:"group"===n.type?"group":"email",id:n.id||n.mcid,title:n.title||n.email};return ns.forcedRequest("abook-suggest-report",a),t._select.apply(this,arguments)},e.prototype._focus=function(e,i){return this.currentFocused=i.item,t._focus.apply(this,arguments)
},e.prototype._response=function(e,i){t._response.apply(this,arguments),1===i.content.length&&"label"===i.content[0].type&&(i.content.length=0)},e.prototype._open=function(){jpath(this,".options.handlers.abook-suggest.popular")[0]&&Jane.c(["popular_suggest","Показы саджеста популярных контактов"]),t._open.apply(this,arguments),this._updateGroupView()},e.prototype._close=function(){this.countOfClick=0,t._close.apply(this,arguments)},e.prototype._updateGroupView=function(){$(this.nbSuggest.$suggest).find(".js-group-data").each(function(){if(this.clientWidth<this.scrollWidth){var e=$(".js-group-more",this.parentNode)[0];
e&&$(e).show().css("min-width",e.scrollWidth)}})},e.prototype._highlight=function(e,t){if(!e)return"";var i="/%strong-"+String($.now())+String(Math.round(1e3*Math.random())),n=Daria.regexpEscape(i);n=new RegExp(n+"(.*)"+n,"i"),t=Daria.regexpEscape(t);var s=new RegExp("("+t+")","i");return e=e.replace(s,i+"$1"+i),e=_.escape(e),e.replace(n,'<strong class="js-suggest-highlight">$1</strong>')},e.prototype.parse=function(e,t){switch(e){case"abook-suggest":return this.parseAbookSuggest(t)}return[]},e.prototype.parseAbookSuggest=function(e){var t=this;
if("object"!=typeof e||!e)return[];$.isArray(e.contacts)||(e.contacts=[]),$.isArray(e.groups)||(e.groups=[]);var i=!0,n=$.map(e.contacts,function(e){var n="contact";e.popdom?n="popdom":i=!1,!e.ya_directory||"group"!==e.ya_directory.type&&"department"!==e.ya_directory.type||(n="wsContainer");var s="";return Array.isArray(e.phones)?"object"==typeof e.phones[0]?e.phones[0].value&&(s=e.phones[0].value):e.phones[0]&&(s=e.phones[0]):"string"==typeof e.phones&&(s=e.phones),e=$.extend({},e,{type:n,phone:s}),e.value=t.parseValue(e),e
}),s=$.map(e.groups,function(e){return i=!1,e=$.extend({},e,{type:"group",name:e.title?e.title:""}),e.email=$.map(e.contacts,function(e){return e.email}).join(", "),e.value=t.parseValue(e),e}),a=[].concat(n,s);return this.showAbookPopupButton&&!this.currentTerm&&a.length&&a.push({type:"abook-popup-button"}),i&&a.length&&(a=[].concat({type:"label",name:"Возможно, вы имели в виду:"},a)),a},e.prototype.parseValue=function(e){var t,i=this;if("group"===e.type){var n=$.map(e.contacts,function(e){return i.formatContact(e)
});t=n.join(", ")}else t=this.formatContact(e);return t},e.prototype.formatContact=function(e){return Jane.FormValidation.obj2contact(e)},Daria.Suggest.Contacts=e}(),function(){var e=function(e,t){t=$.extend({noSmsButton:!0},t),Daria.Suggest.Contacts.call(this,e,t)};Daria.extend(e,Daria.Suggest.Contacts),e.prototype._source=function(){return this.options.handlers={"abook-suggest":{climit:35,glimit:5,phone:"must",useAbook:"on"}},Daria.Suggest.prototype._source.apply(this,arguments)},e.prototype.parse=function(e,t){return t&&$.isArray(t.groups)&&(t.groups=[]),Daria.Suggest.Contacts.prototype.parse.apply(this,arguments)
},e.prototype.formatContact=function(e){return e.phone},Daria.Suggest.Phones=e}(),Daria.Folder=function(e){e=e||{};var t="boolean"==typeof e.hotkey?e.hotkey:!0;return{validate:function(){if(!this.folderName)return ns.events.trigger("folder.error","Поле не заполнено."),!1;var t,i=this.parent_folder&&this.parent_folder.data("fid")||e.parent_id,n=ns.Model.get("folders");t=i===n.getFidBySymbol("inbox")?n.getFolderByName(this.folderName):n.getFolderByName(this.folderName,i);var s=n.getFolderById(e.id);
if(t&&t.fid!=i&&(!s||s.name!==this.folderName)){var a=t.symbol?"Невозможно создать папку «"+this.folderName+"», так как это имя является системным. Придумайте другое.":"Папка с таким именем уже существует. Придумайте другое.";return ns.events.trigger("folder.error",a),!1}return!0},setName:function(e){this.folderName=e},bindEvents:function(){var e=this,i=this.context.find(".b-teaser"),n=this.context.find(".b-form-layout_filters-simple");this.filter&&(this.filter.form=n.find("form"));var s={cls:"b-popup__field_error",active:!1,show:function(t){this.notification=e.context.find(".b-notification__text"),this.row=this.notification.closest(".b-table"),t&&(this.notification.text(t),this.row.addClass(this.cls),this.active=!0)
},hide:function(){this.row.removeClass(this.cls),this.active=!1,ns.events.trigger("folder.error.hide")}};ns.events.on("folder.error",function(t,i){s.show(i),e.input.focus()}),this.context.on("click",".js-filter-open",function(){Jane.c(["Поп-ап создания папки","клик на открыть фильтры"]),i.fadeOut(150,function(){n.fadeIn(200,function(){var e=n.find("input:visible").eq(0).focus(),t=Daria.Autocompleter.getContact();t.setOptions({multiple:!1,formatResult:function(e){if(e.contacts){for(var t=[],i=0,n=e.contacts.length;n>i;i++)t.push(e.contacts[i].email);
return t.join(", ")}return e.email}}),t.bindField({field:e,focus:1}),ns.events.trigger("folder.filter.toggle",!0)})})}),this.context.on("click",".js-filter-close",function(){Jane.c(["Поп-ап создания папки","клик на свернуть фильтры"]),n.fadeOut(150,function(){i.fadeIn(200,function(){e.input.focus(),ns.events.trigger("folder.filter.toggle",!0)})})}),this.context.on("click",".js-filter-link",function(){return e.filter=!1,e.success=function(e){ns.page.go("#setup/filters-create/folder="+e)},e.onCreate(),!1
}),this.context.on("keyup",".js-input-name",function(i){var n=$.trim(this.value).replace(/\u0020/g," ");n!=e.folderName&&s.active&&s.hide(),e.setName(n),13===i.which&&t&&e.onCreate()}),this.context.on("click",".js-dropdown-folder-labels",function(){var e=$(window).height()-$(this).rect().top-40;$(".js-folders-list").css("max-height",e).scrollTop(0)})},filter:Daria.FilterSimpleCreatePopup(),onCreate:function(){var e=this;this.setName($.trim(this.input[0].value).replace(/\u0020/g," ")),this.validate()&&(Daria.Dialog.close(),this.create(function(t){e.filter&&(e.filter.params.move_folder=t,e.filter.create())
},null,this.parent_folder.data("fid")))},init:function(){this.input=$("input[name=folder_name]",this.context),this.parent_folder=$(".js-selink__folder",this.context),e.name&&this.input.val(e.name),this.bindEvents(),this.open()}}},Daria.Folder.REMOVABLE_SYMBOLS={archive:!0},Daria.Folder.remove=function(e){var t,i=ns.Model.get("folders"),n=i.getFolderById(e),s=_.escape(n.name),a=Number(n.count),o=i.getSubfolders(e);o.length&&(t=function y(e){for(var t=i.getSubfolders(e),n=0,s=0;s<t.length;s++){var a=t[s];
n+=Number(a.count),i.getSubfolders([a.fid]).length&&(n+=y(a.fid))}return n}(e));var r=ns.Model.get("filters").getForFolder(e),l=[],c=[];$.each(r,function(e,t){jpath(t,'.condition[.div == "X-yandex-rpop-id"]').length?l.push(t):c.push(t)});var d,u=c.length,h=l.length,m=ns.page.current.params.current_folder,g=m===e||ns.Model.get("folders").hasChildByFid(e,m),p=function(t){var s=[{id:"do-folder-remove",params:{fid:e,force:t?"yes":""}},{id:"folders"}];Daria.Folder.REMOVABLE_SYMBOLS[n.symbol]&&s.unshift({id:"do-folder-set-symbol",params:{fid:e,symbol:""}}),ns.forcedRequest(s).then(function(){ns.events.trigger("daria:folder-remove-done",e),g&&ns.page.go(ns.router.generateUrl("messages",{current_folder:i.getFidBySymbol("inbox")}))
},function(){ns.events.trigger("daria:folder-remove-fail",e)})},f=function(){for(var e=[],t=0;u>t;t++){var i=c[t];e.push('— «<a href="#setup/filters-create/id='+i.filid+'">'+_.escape(i.name)+"</a>»<br/>")}return e.join("")},v=[],b="Удалить папку";a&&u?(v.push("<p>Папка «"+s+"» содержит "+Jane.i18n.convert(["одно письмо",a+" письмо",a+" письма",a+" писем"],a)+" и&#160;используется "+Jane.i18n.convert(["правилом","правилами","правилами"],u)+":</p>"),v.push(f()),v.push("<p>Удаление папки также приведет к&#160;удалению "+Jane.i18n.convert(["письма","писем","писем"],a)+" и&#160;"+Jane.i18n.convert(["правила","правил","правил"],u)+". Отредактировать "+Jane.i18n.convert(["правило","правила","правил"],u)+' можно <a href="#setup/filters">в&#160;настройках</a>.</p>'),b="Удалить папку с "+Jane.i18n.convert(["письмом","письмами","письмами"],a)+" и "+Jane.i18n.convert(["правилом","правилами","правилами"],u)):a&&t?(v.push("В папке «"+s+"» и вложенных в нее папках содержится "+Jane.i18n.convert(["одно письмо",a+t+" письмо",a+t+" письма",a+t+" писем"],a+t)+".<br/>Удаление этой папки приведет к удалению и вложенных папок вместе с письмами в них."),d=a+t>1?2:1,b="Удалить с "+Jane.i18n.convert(["письмом","письмами","письмами"],d)):a?(v.push("<p>В папке «"+s+"» "+Jane.i18n.convert(["одно письмо",a+" письмо",a+" письма",a+" писем"],a)+". "+Jane.i18n.plural(a,"Письма будут удалены","Письмо будет удалено")+" вместе с&#160;папкой.</p>"),d=a>1?2:1,b="Удалить с "+Jane.i18n.convert(["письмом","письмами","письмами"],d)):t?(v.push("<p>Во вложенных папках «"+s+"» "+Jane.i18n.convert(["одно письмо",t+" письмо",t+" письма",t+" писем"],t)+". "+Jane.i18n.plural(t,"Письма будут удалены","Письмо будет удалено")+" вместе с&#160;папкой.</p>"),d=t>1?2:1,b="Удалить с "+Jane.i18n.convert(["письмом","письмами","письмами"],d)):u&&(v.push("<p>Эта папка используется "+Jane.i18n.convert(["правилом","правилами","правилами"],u)+":</p>"),v.push(f()),v.push("<p>Удаление папки также приведет к&#160;удалению "+Jane.i18n.convert(["правила","правил","правил"],u)+". Назначить для "+Jane.i18n.convert(["правила","правил","правил"],u)+' другую папку можно <a href="#setup/filters">в&#160;настройках</a>.</p>'),b="Удалить папку и "+Jane.i18n.convert(["правило","правила","правила"],u)),h&&v.push("<p>"+Jane.i18n["if"](a||u,"Также папка","Папка")+" используется "+Jane.i18n.convert(["сборщиком","сборщиками","сборщиками"],h)+". После удаления папки все письма, собираемые "+Jane.i18n.convert(["сборщиком","сборщиками","сборщиками"],h)+', начнут приходить во&#160;«Входящие». Отредактировать сборщик можно <a href="#setup/collectors">в&#160;настройках</a>.</p>'),a||u||h||t?Daria.Dialog.confirm({title:"Удаление папки",width:450,body:v.join(""),okValue:b,okHandler:function(){if(p(!0),u||h){var t=ns.Model.get("filters").getForFolder(e);
t.forEach(function(e){Daria.Filter.removeById(e.filid)})}}}):p()},Daria.Folder.markRead=function(e){ns.Model.get("folders").getUnreadCount(e)&&(["message-nearest","message-thread-nearest"].forEach(function(e){ns.Model.invalidate(e)}),ns.forcedRequest([{id:"do-folder-mark-read",params:{fid:e}}]),Daria.MOPS.markByFid("mark",e))},Daria.Folder.createFilter=function(e){var t=$(Jane.tt("setup:js-setup-folders-dialog-folder-filter",{fid:e,single:null}));t.on("click",".js-filter-link",function(){Jane.c(["Новый поп-ап фильтров","папка","клик на подробные условия"])
});var i=Daria.FilterSimpleCreatePopupSingle({form:t.find("form")});Daria.Dialog.open({title:"Какие письма складывать в эту папку?",body:t,buttons:[{name:"submit",value:"Создать правило",onclick:function(){return Jane.c(["Новый поп-ап фильтров","папка","клик по создать"]),i.create()}},{name:"cancel"}],oncancel:function(){Jane.c(["Новый поп-ап фильтров","папка","клик по отменить"])},width:432,onopen:function(){Jane.c(["Новый поп-ап фильтров","папка","показ поп-апа для создания фильтра на папку"]),t.find("input[name=field3]:eq(0)").focus(),i.bindAutocompleter()
}})}});